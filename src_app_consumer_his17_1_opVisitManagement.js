!function(){"use strict";angular.module("napierContainerUi").constant("OPVISIT_MGMT_APIS",{patientAdvSservice:{URL:"HISServices/QueryService",METHOD:"POST"},updateService:{URL:"HISServices/HITService",METHOD:"POST"},GBDEPOSITSAVE:{URL:"HISServices/HITService",METHOD:"POST"},GBCONCESSIONDETAILS:{URL:"HISServices/HITService",METHOD:"POST"},GBBILLGENERATION:{URL:"HISServices/HITService",METHOD:"POST"},GBBILLREPORTGENERATION:{URL:"HISServices/HITService",METHOD:"POST"},GBPAYMENTREPORTGENERATION:{URL:"HISServices/HITService",METHOD:"POST"},GBBILLDEPOSITADJUST:{URL:"HISServices/HITService",METHOD:"POST"}})}(),function(){"use strict";function e(e,t,r,a){}e.$inject=["$logProvider","toastrConfig","$translateProvider","I18N"],angular.module("napierContainerUi").config(e)}(),function(){"use strict";function e(e,t){}e.$inject=["$stateProvider","$urlRouterProvider"],angular.module("napierContainerUi").config(e)}(),function(){"use strict";function e(e,t,r,a,i,o,s,n,c,l,p,d,m,u,v,S,y,D,g,A,I,P){var h=this;h.opvisitDir={},h.opvisitDir={opvisitDirFromDate:new Date,opvisitDirToDate:new Date},e.isChecked=!0,h.openCompleteVisitsBtn="Complete Visit",h.opvisitDir.openCompleted=1,h.opvisitDir.billCompleted=1,h.opvisitDir.billCompleted1=0,e.visitChange="",e.advPat={};v.PatientNameList=[],c.loadModule("opVisitManagement");var R=l.getLanguageToSet();c.changeLanguage(R),h.openVisitDefOptions=angular.copy(s),h.openVisitSubGridOptions=angular.copy(n),e.gridOptions=angular.copy(u),h.fromDateOptions={format:"DD-MM-YYYY"},y.getDynamicConfig("GET_HIS_CONFIG_VALUE","Site_Ref").then(function(t){e.hscSpecific=t[1][0].VALUE}),h.getTaskPermissions=function(){r(function(){g.getTaskPermissionDetails("T_OP_VISIT_DIRECTORY").then(function(e){h.roleValue=e,void 0!==h.roleValue&&void 0!==h.roleValue.T_OP_VISIT_DIRECTORY_CV?h.rolePermission=!0:h.rolePermission=!1})},500)},h.getTaskPermissions(),e.getPermissionsCheck=function(e){var t=e,r=sessionStorage.getItem("securityUtilityJson"),a={};if(r){var i,o,s=JSON.parse(r);try{i=window.top.NAPIER.lib.ServiceResponseJSONParser.getRoleTasks(s,"HITService|message|response|roleTasks|com.napier.core.service.vo.security.RoleTask","task|taskId",t,"roleTaskPermissions")}catch(e){}if(i){try{o=i.roleTaskPermissions[0]["com.napier.core.service.vo.security.RoleTaskPermission"]}catch(e){o=""}try{if(o)if(void 0===o.length)a[t+"_"+o.permission.permissionId]=o.permission.permissionId;else for(var n in o)a[t+"_"+o[n].permission.permissionId]=o[n].permission.permissionId}catch(e){}}return a}},e.OPVMDirectorysearchBypatientSearch=function(t){if(t&&t.length>2)return"HSC"===e.hscSpecific?p.searchRegisteredPatientForHsc(t).then(function(t){e.registeredPatientList=[],angular.isArray(t)?e.registeredPatientList=t:e.registeredPatientList.push(t);for(var r=0;r<e.registeredPatientList.length;r++)e.registeredPatientList[r].NAME=e.registeredPatientList[r].patientName,e.registeredPatientList[r].RGSEQID=e.registeredPatientList[r].rgSeqId,e.registeredPatientList[r].RG_NATIONAL_ID=e.registeredPatientList[r].nationalityId,e.registeredPatientList[r].NATIONAL_ID="NRIC No";return e.registeredPatientList},function(e){}):p.searchRegisteredPatientService(t).then(function(t){e.registeredPatientList=[],angular.isArray(t)?e.registeredPatientList=t:e.registeredPatientList.push(t);for(var r=0;r<e.registeredPatientList.length;r++)e.registeredPatientList[r].NAME=e.registeredPatientList[r].patientName,e.registeredPatientList[r].RGSEQID=e.registeredPatientList[r].rgSeqId,e.registeredPatientList[r].RG_NATIONAL_ID=e.registeredPatientList[r].nationalityId,e.registeredPatientList[r].NATIONAL_ID="National Id";return e.registeredPatientList},function(e){})},h.OpVisitRadioChange=function(t,r){e.completeVisit=t,e.openVisit=r,1==t&&4!=r?(h.openCompleteVisitsBtn="Complete Visit",h.rolePermission=!0,h.rolePermission1=!1):4==r&&1!=t?(h.openCompleteVisitsBtn1="Open Visit",h.rolePermission1=!0,h.rolePermission=!1):1==t&&4==r?(h.openCompleteVisitsBtn="Complete Visit",h.openCompleteVisitsBtn1="Open Visit",h.rolePermission=!0,h.rolePermission1=!0):(h.rolePermission=!1,h.rolePermission1=!1)},h.searchVisitDetails=function(e){if(h.OpVisitRadioChange(e.openCompleted,e.openCompleted1),0==h.opvisitDir.openCompleted&&!h.opvisitDir.openCompleted1)return a.warning("Warning!","Please Select Visit Staus"),h.openVisitDefOptions.data=[],!1;t.fillopVisistgrid(e).then(function(e){if(e){h.openVisitDefOptions.data=[],h.gridDirApi.grid.selection.selectAll=!1;var t=e.data.HITService.message[0]["com.napier.core.service.vo.visitmanagement.Encounter"];if(null!=t)if(angular.isArray(t)){if(0!=t.length)for(var r=0;r<t.length;r++)t[r].visitDate=null!=t[r].visitDate?t[r].visitDate.$:"",h.openVisitDefOptions.data.push(t[r])}else t.visitDate=null!=t.visitDate?t.visitDate.$:"",h.openVisitDefOptions.data.push(t)}})},h.searchVisitDetails(h.opvisitDir),h.dateCheck=function(){var e=!1;h.opvisitDir.opvisitDirFromDate>h.opvisitDir.opvisitDirToDate&&(e="From Date should be less than To date"),e&&(h.opvisitDir.opvisitDirFromDate=new Date,h.opvisitDir.opvisitDirToDate=new Date,a.warning("Warning!",e))},h.clearVisitDetails=function(){h.opvisitDir.opvisitDirFromDate=new Date,h.opvisitDir.opvisitDirToDate=new Date,h.opvisitDir.opvisitDirpatientName="",e.isChecked=!0,h.opvisitDir.opvisitDoctor="",h.openVisitDefOptions.data=[]},h.doctorSearchAdv=function(){e.OPVMSearchDoctor=[],e.OPVMDoctorComboDataList={1:e.OPVMSearchDoctor};var t=d.executeQueryURLReset();return e.OPVMDoctorNameList=new Array,d.prepareParamListWithParam("pSpecializationId","",e.OPVMDoctorNameList),d.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,e.OPVMDoctorNameList),d.prepareParamListWithParam("pDoctorId","",e.OPVMDoctorNameList),d.prepareParamListWithParam("pDoctorName","",e.OPVMDoctorNameList),d.executeQueryInput("OP_DOCTOR_ADVANCE_SEARCH",e.OPVMDoctorNameList,e.OPVMDoctorComboDataList,!0,!0,t,"popUp",{}).then(function(e){e&&(h.opvisitDir.opvisitDoctorList=e[1])})},h.doctorSearchAdv(),h.openVisitDefOptions.onRegisterApi=function(t){h.gridDirApi=t,h.gridDirApi.expandable.on.rowExpandedStateChanged(e,function(e){e.entity.norecords&&(e.isExpanded=!1),e.isExpanded&&(h.gridDirApi.expandable.collapseAllRows(),e.isExpanded=!0,h.LoadOpVisitDirectorySubGrid(e))}),t.selection.on.rowSelectionChanged(e,function(t){var i=t.entity;if(t.isSelected){var o=h.gridDirApi.selection.getSelectedRows(),s=!1,n=!1;if(angular.forEach(o,function(e){"Completed"!=e.enActionStatusDesc||s||(s=!0),"Completed"==e.enActionStatusDesc||n||(n=!0)}),s&&n)return a.warning("Warning!","Please select common visit status.",!1,!1,I.time),t.isSelected=!1,r(function(){h.gridDirApi.grid.selection.selectAll=!1},200),!1;"Completed"==i.enActionStatusDesc?e.visitStatus=1:e.visitStatus=4,1==e.completeVisit&&4==e.openVisit&&("Completed"==i.enActionStatusDesc?(h.rolePermission1=!0,h.rolePermission=!1):(h.rolePermission1=!1,h.rolePermission=!0))}else 1==e.completeVisit&&4==e.openVisit?(h.rolePermission1=!0,h.rolePermission=!0):1==e.completeVisit&&4!=e.openVisit?(h.rolePermission1=!1,h.rolePermission=!0):1!=e.completeVisit&&4==e.openVisit&&(h.rolePermission1=!0,h.rolePermission=!1)}),t.selection.on.rowSelectionChangedBatch(e,function(t){var i=!1,o=!1;if(angular.forEach(t,function(e){e.isSelected&&("Completed"!=e.entity.enActionStatusDesc||i||(i=!0),"Completed"==e.entity.enActionStatusDesc||o||(o=!0))}),i&&o)return a.warning("Warning!","Please select common visit status.",!1,!1,I.time),h.gridDirApi.selection.clearSelectedRows(),r(function(){h.gridDirApi.grid.selection.selectAll=!1},200),!1;o&&(h.rolePermission=!0,h.rolePermission1=!1,e.visitStatus=4),i&&(h.rolePermission=!1,h.rolePermission1=!0,e.visitStatus=1)})},h.linkregisterpatient=function(){window.location.origin;A.verifyPermission("T_PAT_REGSTN")?P.go("frontDesk.permanentRegistration"):a.warning("warning","Access not allowed",!1,!1,I.time)},h.LoadOpVisitDirectorySubGrid=function(e){var r=h.openVisitDefOptions.data.indexOf(e.entity);h.openVisitDefOptions.data[r].subgrid=angular.copy(n),h.openVisitDefOptions.data[r].subgrid.data=[];var a={subAccSeqId:e.entity.subAccSeqId,encountSeqId:e.entity.encountSeqId};t.fillopVisistSubgrid(a).then(function(e){if(e){var t=e.data.HITService.message[0]["com.napier.core.service.vo.visitmanagement.Encounter"];if(angular.isArray(t))for(var a="",i=0;i<t.length;i++){var o=!1;if(a!=t[i].billNo&&(o=!0,t[i].billDate=null!=t[i].billDate?t[i].billDate.$:"",h.openVisitDefOptions.data[r].subgrid.data.push(t[i]),a=t[i].billNo),0==o){var s={serviceName:t[i].serviceName,serviceRate:t[i].serviceRate,serviceStatus:t[i].serviceStatus};h.openVisitDefOptions.data[r].subgrid.data.push(s)}}else t.billDate=null!=t.billDate?t.billDate.$:"",h.openVisitDefOptions.data[r].subgrid.data.push(t)}})},e.advSearchRowClick=function(t){if(v.PatientNameList=[],t){e.updatePatientDisable=!1;var r={NAME:t.entity.patientName,RGSEQID:t.entity.patientId,age:t.entity.age,rgSeqId:t.entity.patientId,gender:t.entity.gender};v.PatientNameList.push(r)}e.updatePatientDisable=!1},e.advanceSearch=function(t,r){if(e.clearAdvFields(),e.gridOptions.data=[],$("#patientSearchModal").modal({backdrop:"static",keyboard:!1}),m.comboBoxFetch("MQ0002").then(function(t){e.genderComboObj=t}),m.comboBoxFetch("TRN003").then(function(t){e.regComboObj=t}),S.getPatientCategory().then(function(t){e.payerComboObj=t}),(null!==t.NAME&&void 0!==t.NAME&&""!==t.NAME||""!=t)&&""!=$("#opvm-search-by-patient").val()){if("string"==typeof t)var a=t;else a=t.NAME;e.isDisable=!1,/\d/.test(a)?e.advPat={MrNo:a}:e.advPat={patientName:a},$("#clear_advance").removeClass("PsearchClearBtn"),e.VisitAdvanceSrh(e.advPat),e.updatePatientDisable=!1}else e.isDisable=!0,$("#clear_advance").addClass("PsearchClearBtn"),e.updatePatientDisable=!0,e.gridOptions.data=[]},e.VisitAdvanceSrh=function(t){if(e.gridOptions.data=[],""!==t.patientName&&void 0!==t.patientName&&null!==t.patientName||""!==t.MrNo&&void 0!==t.MrNo&&null!==t.MrNo||""!==t.gender&&void 0!==t.gender&&null!==t.gender||""!==t.dateofbirth&&void 0!==t.dateofbirth&&null!==t.dateofbirth||""!==t.mno&&void 0!==t.mno&&null!==t.mno||""!==t.regType&&void 0!==t.regType&&null!==t.regType||""!==t.payer&&void 0!==t.payer&&null!==t.payer){if(""!==t.dateofbirth&&void 0!==t.dateofbirth&&null!==t.dateofbirth)var r=t.dateofbirth,a=D("date")(new Date(r),"yyyy/MM/dd").split("/"),i=a[0]+"-"+a[1]+"-"+a[2];e.errorVisible=!0}else{i="";e.errorVisible=!1}var o={dateofbirth:i,patientName:t.patientName,MrNo:t.MrNo,gender:t.gender,mno:t.mno,regType:t.regType,payer:t.payer};m.searchServices(o,e.gridOptions).then(function(t){t&&(e.gridOptions.data=t,t[0].patientName&&("No Records Found"==t[0].patientName?e.updatePatientDisable=!0:e.updatePatientDisable=!1))}),e.errorVisible=!1},e.clearAdvFields=function(){e.gridOptions.data=[],e.advPat.dateofbirth="",{},e.advPat.patientName="",e.advPat.MrNo="",e.advPat.gender="",e.advPat.mno="",e.advPat.regType="",e.advPat.payer="",e.getPatientVal(),e.updatePatientDisable=!0,$("#clear_advance").removeClass("PsearchClearBtn"),$("#clear_advance").addClass("PsearchClearBtn")},e.getPatientVal=function(t){null!=t&&""!==t?""!=t.patientName&&null!=t.patientName&&null!=t.patientName||""!=t.MrNo&&null!=t.MrNo&&null!=t.MrNo||null!=t.dateofbirth&&""!=t.dateofbirth&&null!=t.dateofbirth||""!=t.gender&&null!=t.gender&&null!=t.gender||""!=t.mno&&null!=t.mno&&null!=t.mno||""!=t.payer&&null!=t.payer&&null!=t.payer||""!=t.regType&&null!=t.regType&&null!=t.regType?(e.isDisable=!1,$("#clear_advance").removeClass("PsearchClearBtn")):(e.gridOptions.data=[],e.updatePatientDisable=!0,e.isDisable=!0,$("#clear_advance").addClass("PsearchClearBtn")):(e.gridOptions.data=[],e.isDisable=!0,e.updatePatientDisable=!0,e.gridOptions.data=[],$("#clear_advance").addClass("PsearchClearBtn"))},h.selectPatient=function(){$("#patientSearchModal").modal("hide"),$("#opvm-search-by-patient").focus(),$("#clear_advance").removeClass("PsearchClearBtn"),$("#clear_advance").addClass("PsearchClearBtn"),e.$emit("fillPatientName",v.PatientNameList)},e.$on("fillPatientName",function(e,t){h.opvisitDir.opvisitDirpatientName={NAME:t[0].NAME,RGSEQID:t[0].RGSEQID,age:t[0].age,rgSeqId:t[0].rgSeqId,gender:t[0].gender}}),h.saveOpenCompleteVisits=function(){var r=h.gridDirApi.selection.getSelectedRows();if(0!=r.length){for(var i="",o=[],s=0;s<r.length;s++)r[s].billNo&&""!=r[s].billNo?s!=r.length-1?i+=r[s].encountSeqId+",":i+=r[s].encountSeqId:o.push(r[s].visitNo);if(o.length>0)return a.warning("Warning!","Bill is not generated for the following visit(s) -<br>"+o.toString()),!1;var n={seqId:i,chkstatus:e.visitStatus};t.saveOpVisitConsolidatin(n).then(function(e){e.data.HITService.message.hasOwnProperty("enSeqId")&&(a.success("SUCCESS","Saved Successfully"),h.searchVisitDetails(h.opvisitDir))},function(e){a.warning("Warning!",e)})}else a.warning("Warning!","Please Select the Records")}}e.$inject=["$scope","opVisitDrService","$timeout","hisAlertService","hisModalService","hisCalDefConstant","openVisitDef","openVisitSubGrid","hisTranslationsService","hisTranslationsGlobalLang","bookAppointmentService","QueryService","opVisitMgtService","advancedPatientSearchGridDefinition","$rootScope","dropdownServicePermanent","hisConfigurationService","$filter","taskPermissionService","verifyPermissionService","hisAlertConstants","$state"],angular.module("napierContainerUi").controller("opVisitDirectoryCtrl",e)}(),function(){"use strict";function e(e,t,r,a,i,o,s,n,c,l,p){this.data={}}e.$inject=["$scope","CallManager","$anchorScroll","$controller","uiGridConstants","$uibModal","$http","$q","toastr","$state","$location"],angular.module("napierContainerUi").controller("opVistMgmtController",e)}(),function(){"use strict";function e(e,t,r,a,i,o,s,n,c,l,p,d,m,u,v,S,y,D,g,A,I,P,h,R,f,T,C,b,E,q,O,L,V,N,w,M,F,B,x,G,U,Q,k,H,j,Y,W,z,J,Z,K,X,ee,te,re,ae,ie,oe,se,ne,ce,le,pe,de,me,ue){i.minRate=null,i.maxRate=null,i.rateEditable=null,"HSC"==sessionStorage.productCustomization&&(i.agent={},i.agentComboInputs={pPracticeId:JSON.parse(sessionStorage.userContextObj).CLIENT_REF_ID,pFacilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID},r.loadCombos("REF_MAST_AGENT_COMBO",i.agentComboInputs).then(function(e){i.agentName=e[1]})),s.$on("changePerminateRegistartion",function(e,t){!function(e){ae.setPatientSelectedInEdit(e),s.$emit("editPatientDeatils",e)}(t)}),ee.getDynamicConfig("GET_HIS_CONFIG_VALUE","Site_Ref").then(function(e){i.hscSpecific=e[1][0].VALUE,"HSC"===i.hscSpecific?i.editPatient=!0:i.editPatient=!1}),ee.getDynamicConfig("GET_HIS_CONFIG_VALUE","IS_ALLOW_PARITIAL_PAY").then(function(e){i.isAllowPartialPay=e[1][0].VALUE,"YES"===i.isAllowPartialPay?i.partialPayauthShowMode=!0:i.partialPayauthShowMode=!1});var ve=sessionStorage.getItem("opQueueData");null!=ve&&null!=ve&&(A.entityObj=ve,sessionStorage.removeItem("opQueueData")),ee.getDynamicConfig("GET_HIS_CONFIG_VALUE","IS_ALLOW_MULTI_VISIT_PER_EPISODE").then(function(e){i.isAllowMultiVisitPerEpisode=e[1][0].VALUE}),O.loadModule("opVisitManagement");var Se=B.getLanguageToSet();O.changeLanguage(Se),s.latestVisitNo=null,i.OPVMsearchBypatient="",i.opVisitCountApplicableFlag=!1,i.opVisitCount=0,i.VM_Heading=u[0].visitInfo.headings,i.visitMgt=u[0].visitInfo.visitMgt,i.visitDetils=u[0].visitInfo.visitDetils,i.mlcDetails=u[0].visitInfo.mlcDetails,i.previousVisitNote=u[0].visitInfo.previousVisitNote,i.addPatientDetails=u[0].visitInfo.addPatientDetail,i.bannerdetails=u[0].visitInfo.patientBannerDetails,i.mlcpreviousVisitNote=u[0].visitInfo.mlcpreviousVisitNote,i.patientValues,i.concessionAplList=[],i.projSpecApplicable=!1,i.claimFormDetailsArray=[];"HSC"===sessionStorage.productCustomization?i.hscRelatedFlagActive=!0:i.hscRelatedFlagActive=!1,i.preAuthBtnShow=0,i.preAuthBillNav=!1;var ye=JSON.parse(sessionStorage.userContextObj).FACILITY_ID;i.episode=!1,i.bedClass="";var De;i.dctorpop={},i.errorVisible=!1,i.advPat={},i.isDisable=!0,i.updatePatientDisable=!0,i.patientBannerCollapsed=!1,s.permanentRegistrationDataFlag=!1,i.permanentregistration={},i.Mlc={},s.visitDlsDoc={},i.setDoctornameFlag=!1,i.doctorSearchValues,i.extDoctorSearchValues,i.patObjtDetail=[],i.visitNumber="",i.mlcDetailsId="",i.screenname="",i.saveCont=!0,i.tempMlcNum="",i.epRowNum="",i.updateCont=!1,i.OPVMsearchDoctorSpeciality={},i.updateVisitFlag=!1,i.addNewVisitFlag=!0,i.addNewEpisodeFlag=!0,i.patCatCode="",i.patCatSeqId="",i.defaultVisit=!0,i.dynmVisit=!1,i.dynamicVisitNum="",i.docSeqId="",i.loaderFlag=!1,s.orders={},i.serviceTypeModel={},i.payerTypeModel={},i.advserviceType={},s.AdvserviceGrid=angular.copy(w),i.priorityvis={},i.hidevisitTypeComboRef=!0,i.orderDetails={},i.payerdetailsarr={},i.orderData={},i.orderData.accountDetails={},i.gbcal={},i.accountSeqData=[],i.paym={},i.deposit={},i.deposit.Type=1,i.concession={},i.concession_status=!0,i.noResultsOfDoctor=!1,i.disablePayType=!1,i.addSelectServicepostArr=[],i.rows,i.counter=1,i.RowsArr=[],i.tableRowData,i.orderrowIndex,i.advServiceGridselection=[],i.accountres,i.isServiceSelectedCovered=!1,i.concessionViewMode=!1,i.colReqSeqId="",i.refundFlag=!0,i.paymentReciepts=!0,i.refund={},i.billNo="",i.gbBillNo={},i.totalpayableAmt=0;var ge={};i.claimFormDetailsArrayString="",i.enableClaimForm=!1,i.preAuth={},i.addNewPayerIns={},ee.getDynamicConfig("GET_HIS_CONFIG_VALUE","INTEGRATION_AAPLICABLE").then(function(e){e[1][0]&&(i.integrationApplicableFlag=e[1][0].VALUE)}),i.permissionList=z.rolePermission("T_OP_VISIT"),i.postBillStatus="";i.postBillStatus=function(){for(var e=angular.fromJson(JSON.parse(sessionStorage.getItem("securityUtilityJson"))).HITService.context.contextList[0]["com.napier.core.context.ContextElement"],t=e.length,r=0;r<t;r++)if("POST_BILL"==e[r].attrName)return e[r].attrValue}(),i.getPermissionsCheck=function(e){return z.rolePermission(e)},i.permissionListC1=i.getPermissionsCheck("T_OP_VISIT"),i.permissionListC2=i.getPermissionsCheck("T_OP_VISIT_DIRECTORY"),i.permissionListC4=i.getPermissionsCheck("T_PAT_REGSTN"),i.permissionListC6=i.getPermissionsCheck("T_PROCEDURE_APPOINTMENT"),i.permissionListC7=i.getPermissionsCheck("T_APPTMENT_SCHEDULING"),i.permissionListC8=i.getPermissionsCheck("T_DEFINE_CALENDER"),i.permissionListC9=i.getPermissionsCheck("T_SCHEDULAR_BULK_MANAGEMNET"),i.permissionListC10=i.getPermissionsCheck("T_SCHEDULAR_ENQUIRY"),T(function(){i.$apply(function(){i.permissionList1=0===Object.getOwnPropertyNames(i.permissionListC1).length,i.permissionList2=0===Object.getOwnPropertyNames(i.permissionListC2).length,i.permissionList4=0===Object.getOwnPropertyNames(i.permissionListC4).length,i.permissionList6=0===Object.getOwnPropertyNames(i.permissionListC6).length,i.permissionList7=0===Object.getOwnPropertyNames(i.permissionListC7).length,i.permissionList8=0===Object.getOwnPropertyNames(i.permissionListC8).length,i.permissionList9=0===Object.getOwnPropertyNames(i.permissionListC9).length,i.permissionList10=0===Object.getOwnPropertyNames(i.permissionListC10).length})},500),i.advSearch={advSearchPname:"Patient Name",advSearchMRno:"MR No.",advSearchGender:"Gender",advSearchSelectGender:"Select Gender",advSearchGenderMale:"male",advSearchGenderFemale:"Female",advSearchDateofBirth:"Date of Birth",advSearchMobileNo:"Mobile No.",advSearchRegistrationType:"Registration Type",advSearchSelectRegType:"Select Reg Type",advSearchRegTypeOne:"Registratin Type One",advSearchRegTypeTwo:"Registratin Type Two",advSearchPayer:"Payer",advSearchPayerType:"Select Type",advSearchpayerOne:"Payer One",advSearchPayerTwo:"Payer Two",advSearchSave:"Search",advSearchClear:"Clear"},i.loadOPCountApplicable=function(){i.countApplicableData=[],i.countApplicableDataList={1:i.countApplicableData};var e=I.executeQueryURLReset();return i.countApplicableDataDetails=new Array,I.prepareParamListWithParam("configCode",146,i.countApplicableDataDetails),I.executeQueryInput("NH_EMP_STAFF_DEPN_AGE_COVRG_VL",i.countApplicableDataDetails,i.countApplicableDataList,!0,!0,e,"popUp",i.advSearch).then(function(e){var t=e[1];t[0]&&(i.opVisitCountApplicableFlag=1==t[0].CONFIG_VALUE)})},i.loadOPCountApplicable(),i.loadDefaultOPBedClass=function(){i.defaultBedData=[],i.defaultBedDataList={1:i.defaultBedData};var e=I.executeQueryURLReset();return i.defaultBedDataDetails=new Array,I.executeQueryInput("GET_DEFAULT_OP_BED_CLASS",i.defaultBedDataDetails,i.defaultBedDataList,!0,!0,e,"popUp",i.advSearch).then(function(e){var t=e[1];t[0]&&(i.bedClass="BEDCLASS="+t[0].DESCRIPTION)})},i.loadDefaultOPBedClass(),"HSC"===sessionStorage.productCustomization?(i.hscOrdersPrint=!0,i.checkListServSeqId=[],i.checkListServSeqIdInner="",i.hscCheckListCount=[],i.checkOrderSaved=!1):i.hscOrdersPrint=!1,i.applicableForBillandService=function(e){i.concession_status=1==e},i.CD=angular.copy(V),i.fromDateOptions={format:i.CD.dateOnly.format,maxDate:moment()},i.episodeDateOptions={format:i.CD.dateOnly.format,minDate:moment()},i.forMinDateOptions={minDate:new Date},i.forMinDateOptions_episode={minDate:new Date,maxDate:new Date},s.visithistoryvistino=function(e){i.searchVisit(e.entity.VISIT_NO),E.dismissAll()},i.visitDetails=!1,i.activeFirst=1,i.updateDoctorDisable=!0,i.VisitHistoryGrid=angular.copy(l),s.opserviceGrid=angular.copy(w),i.oppayerserviceGrid=angular.copy(w),s.healthCheckUp=angular.copy(M),m.comboBoxFetch("SPECIALITY_LIST").then(function(e){i.serviceComboObj=e}),i.visitDls={},i.dispNowDate=new Date,i.dispNowDateFormat=new Date(i.dispNowDate.toDateString()),i.dispNowTime=i.dispNowDate.getHours()+":"+i.dispNowDate.getMinutes(),i.allowedFileSize=5e6,window.scope=i,$(".ng-patient-banner").toggleClass("ng-scope ng-hide"),i.activeBillTab=function(e){i.activeSecond=e},i.activeSecond=4,i.keyupevt=function(e){0==$(".search_name").val().length&&($("#no-result-found").hide(),i.visitDls={},i.visitDlsDoc={},i.Mlc={},i.visitDetails=!1,i.visitEdit=!1,$(".ng-patient-banner").attr("class","ng-patient-banner ng-scope ng-hide")),8==e.which&&($(".ng-patient-banner").attr("class","ng-patient-banner ng-scope ng-hide"),i.visitDls={},i.Mlc={},i.visitDlsDoc={},i.visitDetails=!1,i.visitEdit=!1,i.patientBannerVisible=!1,i.disableVisitInfo=!1)},i.visitNokeyupevt=function(e){0==$(".search_VisitNo").val().length&&($("#no-result-found_visit").hide(),i.visitDls={},i.Mlc={},i.visitDetails=!1,i.visitEdit=!1,$(".ng-patient-banner").attr("class","ng-patient-banner ng-scope ng-hide"))};var Ae="",Ie={};function Pe(){if(i.insurancePlanDedSeqId&&i.accountres&&1!=i.accountres.SUB_ACC_SEQ_ID){var e=[],t={1:i.deductibleList=[]},r=I.executeQueryURLReset(),a=i.accountres.SUB_ACC_SEQ_ID;I.prepareParamListWithParam("pSubAccSeqId",a,e),I.prepareParamListWithParam("pPlanSeqId",i.insurancePlanDedSeqId,e),I.executeQueryInput("BL_GET_DEDUCTABLE_AMOUNT",e,t,!0,!0,r,"popUp",{}).then(function(e){e[1][0]?(i.deductibleType=i.deductibleList[0]&&i.deductibleList[0].TYPE?i.deductibleList[0].TYPE:void 0,i.deductibleAmount=i.deductibleList[0]&&i.deductibleList[0].DEDUCTABLE_VALUE?i.deductibleList[0].DEDUCTABLE_VALUE:void 0):(i.deductibleAmount=0,i.noPayer=!0),i.calculateGBData()})}else i.deductibleAmount=0,i.noPayer=!0}s.addNewEpisode2={},i.addNewEpisode={},i.episodeRecords,i.disabled={selected:!0},i.checked={selected:!1},i.gridDoctorSearchoptions=angular.copy(h),i.advSearchRowClickDoc=function(e){e.visible?($("input[name=rdUserList]").attr("checked",!0),i.updateDoctorDisable=!1,i.doctorSearchValues=e.entity):($("input[name=rdUserList]").attr("checked",!1),i.updateDoctorDisable=!0)},i.advSearchRowClickExtDoc=function(e){e.visible?($("input[name=rdUserList]").attr("checked",!0),i.selectExtAdvDoctor=!1,i.extDoctorSearchValues=e.entity):($("input[name=rdUserList]").attr("checked",!1),i.selectExtAdvDoctor=!0)},i.gridOptions=angular.copy(f),i.keyupevtDoctor=function(e){0==$(".search_name").val().length&&($(".no-result-found").hide(),i.noResultsOfDoctor=!1)},i.selectMatchDoctor=function(e,t,r,a,i){var o={};o.docID=e.DOCTID;o.docID},i.OPVMDoctorSearchTypeAheadEp=function(e){i.setDoctornameFlag=!0;var t=e;i.OPVMDoctroSearch=[],i.multipleComboDataForList={1:i.OPVMDoctroSearch};var r=I.executeQueryURLReset();return i.OPVMDoctSearch=new Array,I.prepareParamListWithParam("pSpecializationId",i.addNewEpisode.department.CODE,i.OPVMDoctSearch),I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.OPVMDoctSearch),I.prepareParamListWithParam("pDoctorId","",i.OPVMDoctSearch),I.prepareParamListWithParam("pDoctorName",t,i.OPVMDoctSearch),I.executeQueryInput("OP_DOCTOR_ADVANCE_SEARCH",i.OPVMDoctSearch,i.multipleComboDataForList,!0,!0,r,"popUp",{}).then(function(e){if(0!==e)return(e[1]instanceof Array?e[1]:[e[1]]).map(function(e){return e});i.noResults=!0})},i.OPVMDoctorSearchTypeAhead=function(e,t,r){i.setDoctornameFlag=!0;var a="",o=e;i.OPVMDoctroSearch=[],i.multipleComboDataForList={1:i.OPVMDoctroSearch},t&&(a=t);var s=I.executeQueryURLReset();if(i.OPVMDoctSearch=new Array,I.prepareParamListWithParam("pSpecializationId",a,i.OPVMDoctSearch),I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.OPVMDoctSearch),I.prepareParamListWithParam("pDoctorId","",i.OPVMDoctSearch),I.prepareParamListWithParam("pDoctorName",o,i.OPVMDoctSearch),!r)return I.executeQueryInput("OP_DOCTOR_ADVANCE_SEARCH",i.OPVMDoctSearch,i.multipleComboDataForList,!0,!0,s,"popUp",{}).then(function(e){if(0!==e)return(e[1]instanceof Array?e[1]:[e[1]]).map(function(e){return e});i.noResults=!0});I.executeQueryInput("OP_DOCTOR_ADVANCE_SEARCH",i.OPVMDoctSearch,i.multipleComboDataForList,!0,!0,s,"popUp",{}).then(function(e){if(e){var t=e[1]instanceof Array?e[1]:[e[1]];i.orderDetails.OPVMselectDoctor=t[0]}})},i.updatePatient=function(){i.visitDls={},i.Mlc={},i.Mlc.OPVMmlcDetails=!1,$(".ng-patient-banner").attr("class","ng-patient-banner ng-scope"),$(".search_name").val("");var e={};s.patientGlobalDtlsNew=[],s.patientGlobalDtls={},i.patObjtDetail=[],e.regSeqId=i.patientValues.regSeqId,i.patObjtDetail.push({RGSEQID:parseInt(e.regSeqId)}),i.selectMatch(i.patObjtDetail[0]),$("#patientSearchModal").modal("hide"),$("#opvm-search-by-patient").focus(),$("#clear_advance").removeClass("PsearchClearBtn"),$("#clear_advance").addClass("PsearchClearBtn")},i.close=function(){$("#patientSearchModal").modal("hide"),$("#opvm-search-by-patient").focus(),$("#clear_advance").removeClass("PsearchClearBtn"),$("#clear_advance").addClass("PsearchClearBtn")},i.openVisitsInfo=function(e){e=e.toString();i.openVisits=[],i.openVisitList={1:i.openVisits};var t=I.executeQueryURLReset();return i.openVisitsList=new Array,I.prepareParamListWithParam("pRegSeqId",e,i.openVisitsList),I.prepareParamListWithParam("pFacilityId",ye,i.openVisitsList),I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.openVisitsList),I.executeQueryInput("VISITS_NO_REG_SEQ_ID",i.openVisitsList,i.openVisitList,!0,!0,t,"popUp",{}).then(function(e){var t=e[1];if(t.length>0&&"HSC"!=sessionStorage.productCustomization&&t.length>1){i.openVisitsListGrid=angular.copy(d),i.openVisitsListGrid.onRegisterApi=function(e){i.openVisitsListGrid=e},T(function(){i.openVisitsListGrid.data=[];for(var e=0;e<t.length;e++)i.openVisitsListGrid.data.push({EPISODENAME:t[e].EPISODENAME,VISIT_NO:t[e].VISIT_NO,DOCTDESC:t[e].DOCTDESC,SERVDESC:t[e].SERVDESC,EP_NO:t[e].EP_NO});o(function(){i.openVisitsListGrid.selection.selectRow(i.openVisitsListGrid.data[0])},0,1)},200)}})},i.latestEpisodeLoad=function(e,t){i.getPatAllPayers(s.patientSeqId),i.getAddedPreAuths(s.patientSeqId),i.reqFromOrder=!1,i.amountValid=!1,s.orderRowData=null,i.addRowStatus=!0,s.editRowRecord=null,i.packageServicesArrayObejct=[],s.selectedPreServices=[],s.cancelSerIndex=[],i.PA={},i.PA={fromDate:new Date,PAUnitDays:1},i.showErrors=!1,i.showPlanError=!1,$("#no-result-found_service").hide(),i.latestEpisode=[],i.latestEpisodeList={1:i.latestEpisode};var r=I.executeQueryURLReset();if(i.latestEpisodeLists=new Array,I.prepareParamListWithParam("pRegSeqId",e,i.latestEpisodeLists),I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.latestEpisodeLists),"HSC"===sessionStorage.productCustomization)var a="GET_LATEST_EPISODE_AND_VISITLOCATION_FORHSC";else a="GET_LATEST_EPISODE";return I.executeQueryInput(a,i.latestEpisodeLists,i.latestEpisodeList,!0,!0,r,"popUp",{}).then(function(r){var a=r[1][0];i.todaysAppoinmentsData=[],i.appointmentsData=[],i.appointmentsDataFull=[],i.fromAppoinemtView=!1;var o={"@class":"com.napier.his.appointment_management.vo.PatientSearchVO",rgSeqId:e,opAppmntStatus:89},n={url:"HISServices/AppointmentsManagementService"};n.requestData={operation:"getAppointmentsDetailsForOPPatient",destination:"com.napier.his.appointment_management.service.external.AppointmentsManagementService",message:o},P.sendRestRequest(n).then(function(r){var o=r.data.HITService.message[0]["com.napier.his.appointment_management.vo.OpAppointmentsEntityVO"];if(void 0!==o){var n=s.patientName;n=null!=n?n.toUpperCase():"";var c="APPOINTMENTS LIST";"HSC"==sessionStorage.productCustomization&&(c="UPCOMING APPOINTMENTS"),i.modalInstance=S.open(c,{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-up-coming-appointments.html",size:"lg",scope:i});i.apptFlag=0;let e=o instanceof Array?o:[o];var l=moment().format("YYYY-MM-DD");let t=[];for(var p=0;p<e.length;p++){e[p].value=p,e[p].calendarDateToDisplyFormat=new Date(e[p].calendarDateToDisply.split("T")[0].split("-")[2]+"/"+e[p].calendarDateToDisply.split("T")[0].split("-")[1]+"/"+e[p].calendarDateToDisply.split("T")[0].split("-")[0]),e[p].showHeader=!0;let r=moment(e[p].calendarDateToDisplyFormat).diff(l,"days");0===r?i.todaysAppoinmentsData.push(e[p]):(-1===t.indexOf(e[p].calendarDateToDisply)?t.push(e[p].calendarDateToDisply):e[p].showHeader=!1,r>0&&(e[p].isFuture=!0),i.appointmentsData.push(e[p])),i.appointmentsDataFull.push(e[p]),i.selectedapptment&&i.selectedapptment.opApmntSeqId==e[p].opApmntSeqId&&(i.apptFlag=i.selectedapptment.opApmntSeqId)}i.todaysAppoinmentsData.length>1&&i.todaysAppoinmentsData.sort(function(e,t){return e.slotStartTime>t.slotStartTime?1:e.slotStartTime<t.slotStartTime?-1:0}),i.appointmentsData.sort(function(e,t){return new Date(e.calendarDateToDisplyFormat)-new Date(t.calendarDateToDisplyFormat)})}else null==a?(i.appointmentsData=[],i.todaysAppoinmentsData=[],i.appointmentsDataFull=[],"HSC"!=sessionStorage.getItem("productCustomization")?("firstTimeHide"!=t&&i.episodePopUp("lg"),T(function(){i.addNewEpisodes()},300)):i.loadDefaultEpisodeData(),i.hideExternalRef=!1,i.hideInternalRef=!0,i.visitDls.internalorext="I",i.internalorextCk=!0,i.internalorextCkE=!1,i.visitDls.OPVMreferedBy={}):(i.patientOutstandingPop(e),"HSC"==i.hscSpecific&&i.loadDefaultEpisodeData())}),null!=a&&(i.visitDls.OPVMepisodeNo=a.EP_NO,i.visitDls.epSeqId=a.EP_SEQ_ID,i.visitDls.OPVMepisodeDescription=a.EP_DESCRIPTION,a.DOCT_SEQ_ID&&(i.visitDlsDoc.OPVMselectDoctor={},i.visitDlsDoc.OPVMselectDoctor.DOCTID=a.DOCT_SEQ_ID,i.visitDlsDoc.OPVMselectDoctor.DOCTNAME=a.DOCTDESC,i.visitDlsDoc.OPVMselectDoctor.SPECIALITY_CODE=a.EP_SPECIALITY,i.visitDlsDoc.OPVMselectDoctor.SPECIALITYDESC=a.DESCRIPTION,i.visitDlsDoc.OPVMselectDoctor.DOCTOR_SPECIALITY=a.DOCTDESC+", "+a.DESCRIPTION),i.hideExternalRef=!1,i.hideInternalRef=!0,i.visitDls.internalorext="I",i.internalorextCk=!0,i.internalorextCkE=!1,i.visitDls.OPVMreferedBy={},a.OPVLOCATION&&(i.admittingLocationData=a.OPVLOCATION,i.visitDls.admittingLocation=a.OPVLOCATION)),i.opVisitCountApplicableFlag&&i.getVisitCount()})},i.openVisitSelect=function(){var e=$('input[name="radio_continue"]:checked').val(),t=i.openVisitsListGrid.data[e].VISIT_NO;i.searchVisit(t),E.dismissAll()},i.newVisit=function(){i.visitDls.OPVMvisitType="",i.saveCont=!1,i.updateCont=!0,i.addNewVisitFlag=!1,E.dismissAll()},i.addNewEpisodeClick=function(){i.visitDls.epSeqId="",i.visitDls.OPVMepisodeNo="",i.visitDls.OPVMepisodeDescription="",i.visitDls.OPVMvisitType="",i.visitDlsDoc.OPVMselectDoctor="",i.internalorextCk=!0,i.visitDls.OPVMreferedBy1="",i.visitDls.OPVMreferedBy={},i.Mlc={},i.Mlc.OPVMmlcDetails=!1,i.updateVisitFlag=!1,i.saveCont=!0,i.tempMlcNum="",i.updateCont=!1,i.addNewVisitFlag=!1,i.addNewEpisodeFlag=!1,i.disableVisitInfo=!1},i.addNewVisit=function(){1==i.projSpecApplicable||(i.visitDls.OPVMvisitType="",i.visitDlsDoc.OPVMselectDoctor="",i.internalorextCk=!0,i.visitDls.OPVMreferedBy1="",i.visitDls.OPVMreferedBy={},i.Mlc={},i.Mlc.OPVMmlcDetails=!1,i.updateVisitFlag=!1,i.saveCont=!0,i.tempMlcNum="",i.updateCont=!1,i.addNewVisitFlag=!1,i.addNewEpisodeFlag=!0,i.disableVisitInfo=!1,"HSC"==sessionStorage.productCustomization&&(i.agent.hscAgent={},i.agent.hscAgent=_.find(i.agentName,{REFERRAL_AGENT_SEQ_ID:i.agentSeqId})))},i.patientTempRegt=function(e){s.patientGlobalDtlsNew=[],s.patientGlobalDtls={};var t={};t.regSeqId=e,g.getPatientBanner(t,"2").then(function(e){s.patientGlobalDtlsNew.push(e),s.patientGlobalDtls=s.patientGlobalDtlsNew[0]}),R.patientBannerDetail(t).then(function(e){if(s.patientGlobalDtlsNew.push(e),s.patientGlobalDtls=s.patientGlobalDtlsNew[0],null!=s.patientGlobalDtlsNew[0].visitNO){var t=s.patientGlobalDtlsNew[0].visitNO.split(" ")[0];i.searchVisit(t)}}),sessionStorage.setItem("episodeRegSeqid",null),s.patientSeqId=e,i.getPayerDetail(e,sessionStorage.getItem("orderencounterSeqId"));var r=e;i.latestEpisodeLoad(r),sessionStorage.setItem("episodeRegSeqid",r),i.visitDetails=!0},i.postRoomChargesforEmgPat=function(){i.regTypeData&&i.regTypeData.encounterType&&3==i.regTypeData.encounterType&&i.accountres.SUB_ACC_SEQ_ID?m.postRoomChargesforEmgPat(i.accountres.SUB_ACC_SEQ_ID).then(function(e){i.retriveRecords(),i.loadGBDepositeGrid(),i.loadRefundRecieptList(),i.loadBillNumbers(s.mrNo)},function(e){i.retriveRecords(),i.loadGBDepositeGrid(),i.loadRefundRecieptList(),i.loadBillNumbers(s.mrNo)}):(i.retriveRecords(),i.loadGBDepositeGrid(),i.loadRefundRecieptList(),i.loadBillNumbers(s.mrNo))},i.getAccountByEnID=function(){var e=3==i.regTypeData.encounterType?"OP_BL_M_COMMON_002_FOR_ER":"OP_BL_M_COMMON_002";i.accountSeqData=[],i.getcoountData={1:i.accountSeqData};var t=I.executeQueryURLReset();i.accountSeqList=new Array,I.prepareParamListWithParam("pEncounterSeqId",s.encounterSeqId,i.accountSeqList),I.executeQueryInput(e,i.accountSeqList,i.getcoountData,!0,!0,t,"popUp",i.gridgbOptions).then(function(e){i.accountres=e[1][0],i.noPayer=!0,i.accountres?(i.accountres.ACC_SEQ_ID&&sessionStorage.setItem("accountseqId",i.accountres.ACC_SEQ_ID),i.accountres.SUB_ACC_SEQ_ID&&sessionStorage.setItem("subaccountseqId",i.accountres.SUB_ACC_SEQ_ID),i.postRoomChargesforEmgPat(),!s.mrNo&&i.accountres.RG_INT_MR_NO&&(s.mrNo=i.accountres.RG_INT_MR_NO,i.loadBillNumbers(s.mrNo))):i.loadBillNumbers(s.mrNo)})},i.checkIfPatIsIP=function(){if(s.encounterSeqId){var e=[],t={1:e},r=I.executeQueryURLReset(),a=new Array;I.prepareParamListWithParam("pEnSeqId",s.encounterSeqId,a),I.executeQueryInput("GET_VISIT_IP_ENC_TYPE",a,t,!0,!0,r,"popUp",i.gridgbOptions).then(function(t){if(e[0]&&"TRUE"==e[0].OPTYPE){i.isIpPat=!0;v.hisAlertMulti("warning","Warning","Paitent is already Admitted. Hence not Allowed for OP Visit",{buttonText:"OK"},close)}})}},i.confirmTempOREmerPat=function(){if(i.regTypeData&&2==i.regTypeData.RG_TYPE){if(2==i.regTypeData.RG_TYPE)var e="Patient has a Temporary registration. Do you want to convert into Permanent registration ?";else e="Patient has a Emergency registration. This need to be converted into Permanent registration before Bill ?";var t={buttonCallBack1:function(){},buttonCallBack2:function(){sessionStorage.setItem("ErTrPatientDetails",JSON.stringify(i.regTypeData)),L.go("index.frontDesk.permanentRegistration")}};return v.hisAlertMulti("warning","Confirmation",e,{buttonText:"No",buttonText2:"Yes"},t,close),!1}return!0},i.checkVisitUnOrderdServices=function(){if(i.prescPendingOders=!1,i.regTypeData&&i.regTypeData.RG_SEQ_ID){var e=I.executeQueryURLReset(),t={1:new Array},r=new Array;return I.prepareParamListWithParam("pRG_SEQ_ID",i.regTypeData.RG_SEQ_ID,r),I.executeQueryInput("OPVM_SP_PENDING_VISIT_PRESC",r,t,!0,!0,e,"popUp",{}).then(function(e){e[1][0]&&e[1][0].IS_PRES_ORDERED&&"Y"==e[1][0].IS_PRES_ORDERED&&(i.prescPendingOders=!0)})}},i.selectMatch=function(e,t,r,a,o){i.opvisitPatientDetails=angular.copy(e),i.preAuthRcdList=[],i.preAuthHdrRcdList={},i.packageTitle="",i.clsvisitBtn=!1,i.saveCont=!0,i.tempMlcNum="",i.updateCont=!1,i.addNewVisitFlag=!1,i.addNewEpisodeFlag=!1,i.orderBtnDisable=!0,i.orderUpdate=!1,i.visitEdit=!0,i.payerDetails={},i.visitDlsDoc={},i.visitDls={},i.Mlc={},i.gbBillNo={},i.Mlc.OPVMmlcDetails=!1,i.upldphotoDoc=null,i.patientBannerDetails=null,i.RowsArr=[],i.isIpPat=!1,i.isEmgOrTempPat=!1,$(".ng-patient-banner").attr("class","ng-patient-banner ng-scope"),i.patientBannerVisible=!0,s.patientGlobalDtlsNew=[],s.patientGlobalDtls={};var n={};i.defaultVisit=!0,i.dynmVisit=!1,i.dynamicVisitNum="",n.regSeqId=e.RGSEQID,i.agentHideId=angular.copy(e.RGSEQID),i.deductibleType="",i.regTypeData={},i.isPatientDeceased=!1,g.getPatientBanner(n,"2").then(function(t){if(null!=t.encounterType&&0!=t.encounterType||(t.encounterType=1),s.patientGlobalDtlsNew.push(t),s.patientGlobalDtls=s.patientGlobalDtlsNew[0],t.typeOfReg&&(i.regTypeData={RG_SEQ_ID:n.regSeqId,RG_INT_MR_NO:t.mrNo,RG_TYPE:t.typeOfReg,encounterType:t.encounterType},(2==t.typeOfReg||3==t.typeOfReg)&&(i.isEmgOrTempPat=!0,!i.confirmTempOREmerPat()&&2==t.typeOfReg)))return!1;null!=t.encounterNo&&0!=t.encounterNo?s.encounterNo=t.encounterNo.split(" ")[0]:s.encounterNo="",s.encounterSeqId=t.encounterSeqId,s.mrNo=t.mrNo,i.checkIfPatIsIP(),i.latestEpisodeLoad(e.RGSEQID,"firstTimeHide"),i.gbcal={deductibleAmount:0,coPay:0},i.getPayerDetail(e.RGSEQID,s.encounterSeqId),R.patientBannerDetail(n.regSeqId).then(function(e){if(i.upldphotoDoc=e,i.patientBannerDetails=e,e.insurance){var t=e.insurance;(t=t instanceof Array?t:[t])[0].cmpSeqId&&t[0].cmpSeqId.inCompName&&(s.patientGlobalDtlsNew[0].insuranceComp=t[0].cmpSeqId.inCompName),t[0].insurancePlanMaster&&t[0].insurancePlanMaster.inPlanName&&(s.patientGlobalDtlsNew[0].insurancePlan=t[0].insurancePlanMaster.inPlanName),t[0].covrgStrtDate&&t[0].covrgStrtDate.$&&(s.patientGlobalDtlsNew[0].pEffectivedate=t[0].covrgStrtDate.$),t[0].covrgEndDate&&t[0].covrgEndDate.$&&(s.patientGlobalDtlsNew[0].pExpiredate=t[0].covrgEndDate.$),i.noPayer=!0}if(s.patientGlobalDtlsNew[0].userPermision=12,e.patientRecordsDetail&&e.patientRecordsDetail.deathInd&&"Y"==e.patientRecordsDetail.deathInd&&(i.isPatientDeceased=!0,v.warning("Warning!","The selected patient is deceased",!1,!1,me.time)),null!=s.patientGlobalDtlsNew[0].visitNO){var r=s.patientGlobalDtlsNew[0].visitNO.split(" ")[0];i.searchVisit(r,!0)}if(s.patientName=s.patientGlobalDtlsNew[0].patientName,""==s.tariffSeqId&&(s.tariffSeqId=s.patientGlobalDtlsNew[0].tariffSeqId),s.insuranceComp=s.patientGlobalDtlsNew[0].insuranceComp,s.patCatSeqId=s.patientGlobalDtlsNew[0].patCatSeqId,s.mrNo=s.patientGlobalDtlsNew[0].mrNo,null==s.patientGlobalDtlsNew[0].visitNO&&(i.visitDls.OPVMepisodeNo="",i.visitDls.epSeqId="",i.visitDls.OPVMepisodeDescription="",i.visitDlsDoc.OPVMselectDoctor=""),s.patientGlobalDtls=s.patientGlobalDtlsNew[0],"HSC"==sessionStorage.productCustomization){i.agentSeqDataId=[],i.agentSeqData={1:i.agentSeqDataId};var a=I.executeQueryURLReset();return i.agentListName=new Array,I.prepareParamListWithParam("pRG_SEQ_ID",i.agentHideId,i.agentListName),I.executeQueryInput("AGENT_WORK_FLOW_SEARCH_FOR_BILL",i.agentListName,i.agentSeqData,!0,!0,a,"popUp",{}).then(function(e){var t=angular.copy(e);t[1][0]&&"1"==t[1][0].GN_BILL_STATUS?i.agent.hscAgent="":(i.agent.hscAgent={},i.agentSeqId=t[1][0]?t[1][0].REFERRAL_AGENT_SEQ_ID:"",i.agent.hscAgent=_.find(i.agentName,{REFERRAL_AGENT_SEQ_ID:i.agentSeqId}))})}})}),sessionStorage.setItem("episodeRegSeqid",null),s.patientSeqId=e.RGSEQID,i.getPatientCatg(e.RGSEQID);var c=e.RGSEQID;sessionStorage.setItem("episodeRegSeqid",c),i.visitDetails=!0,i.disableVisitInfo=!1,i.patientBannerCollapsed=!1,i.internalorextCk=!0,i.visitDls.OPVMreferedBy1="",i.visitDls.OPVMreferedBy="",i.visitDls.internalorext="I"},i.OPVMsearchBypatientSearch=function(e){if(e&&e.length>2)return"HSC"===i.hscSpecific?Z.searchRegisteredPatientForHsc(e).then(function(e){i.registeredPatientList=[],angular.isArray(e)?i.registeredPatientList=e:i.registeredPatientList.push(e);for(var t=0;t<i.registeredPatientList.length;t++)i.registeredPatientList[t].NAME=i.registeredPatientList[t].patientName,i.registeredPatientList[t].RGSEQID=i.registeredPatientList[t].rgSeqId,i.registeredPatientList[t].RG_NATIONAL_ID=i.registeredPatientList[t].nationalityId,i.registeredPatientList[t].NATIONAL_ID="NRIC No";return i.registeredPatientList},function(e){}):Z.searchRegisteredPatientService(e).then(function(e){i.registeredPatientList=[],angular.isArray(e)?i.registeredPatientList=e:i.registeredPatientList.push(e);for(var t=0;t<i.registeredPatientList.length;t++)i.registeredPatientList[t].NAME=i.registeredPatientList[t].patientName,i.registeredPatientList[t].RGSEQID=i.registeredPatientList[t].rgSeqId,i.registeredPatientList[t].RG_NATIONAL_ID=i.registeredPatientList[t].nationalityId,i.registeredPatientList[t].NATIONAL_ID="National Id";return i.registeredPatientList},function(e){})},i.opvisitPatient=function(){L.go("permanent_registration_new_op",{navision:"op"}),s.$emit("changePerminateRegistartion",i.opvisitPatientDetails)},i.advanceSearch=function(e,t){if(i.clearAdvFields(),i.gridOptions.data=[],$("#patientSearchModal").modal({backdrop:"static",keyboard:!1}),(null!==e.NAME&&void 0!==e.NAME&&""!==e.NAME||""!=e)&&""!=$("#opvm-search-by-patient").val()){if("string"==typeof e)var r=e;else r=e.NAME;i.isDisable=!1,/\d/.test(r)?i.advPat={MrNo:r}:i.advPat={patientName:r},$("#clear_advance").removeClass("PsearchClearBtn"),i.VisitAdvanceSrh(i.advPat),i.updatePatientDisable=!1}else i.isDisable=!0,$("#clear_advance").addClass("PsearchClearBtn"),i.updatePatientDisable=!0,i.gridOptions.data=[];m.comboBoxFetch("MQ0002").then(function(e){i.genderComboObj=e}),m.comboBoxFetch("TRN003").then(function(e){i.regComboObj=e}),m.comboBoxFetch("GET_COPMANY_ACC_DTLS").then(function(e){i.payerComboObj=e})},$(".datePickerClass").datepicker({format:"dd/mm/yyyy",autoclose:!0,endDate:"today",maxDate:0}),$(".datePickerClass").on("change",function(e){var t=$(this).val().split("/");Ae=t[2]+"-"+t[1]+"-"+t[0],Ie.dobValue=Ae,$(this).datepicker("hide")}),i.getDOB=function(){$(".datePickerClass").datepicker("show")},i.getPatientVal=function(e){null!=e&&""!==e?""!=e.patientName&&null!=e.patientName&&null!=e.patientName||""!=e.MrNo&&null!=e.MrNo&&null!=e.MrNo||null!=e.dateofbirth&&""!=e.dateofbirth&&null!=e.dateofbirth||""!=e.gender&&null!=e.gender&&null!=e.gender||""!=e.mno&&null!=e.mno&&null!=e.mno||""!=e.payer&&null!=e.payer&&null!=e.payer||""!=e.regType&&null!=e.regType&&null!=e.regType?(i.isDisable=!1,$("#clear_advance").removeClass("PsearchClearBtn")):(i.gridOptions.data=[],i.updatePatientDisable=!0,i.isDisable=!0,$("#clear_advance").addClass("PsearchClearBtn")):(i.gridOptions.data=[],i.isDisable=!0,i.updatePatientDisable=!0,i.gridOptions.data=[],$("#clear_advance").addClass("PsearchClearBtn"))},i.advSearchRowClick=function(e){e.visible?($("input[name=rdUserList]").attr("checked",!0),i.updatePatientDisable=!1,i.patientValues={regSeqId:e.entity.patientId}):($("input[name=rdUserList]").attr("checked",!1),i.updatePatientDisable=!0)},i.VisitAdvanceSrh=function(e){if(""!==e.patientName&&void 0!==e.patientName&&null!==e.patientName||""!==e.MrNo&&void 0!==e.MrNo&&null!==e.MrNo||""!==e.gender&&void 0!==e.gender&&null!==e.gender||""!==e.dateofbirth&&void 0!==e.dateofbirth&&null!==e.dateofbirth||""!==e.mno&&void 0!==e.mno&&null!==e.mno||""!==e.regType&&void 0!==e.regType&&null!==e.regType||""!==e.payer&&void 0!==e.payer&&null!==e.payer){if(""!==e.dateofbirth&&void 0!==e.dateofbirth&&null!==e.dateofbirth){var t=e.dateofbirth,r=b("date")(new Date(t),"yyyy/MM/dd").split("/");a=Ae=r[0]+"-"+r[1]+"-"+r[2]}i.errorVisible=!0}else{var a="";i.errorVisible=!1}var o={dateofbirth:a,patientName:e.patientName,MrNo:e.MrNo,gender:e.gender,mno:e.mno,regType:e.regType,payer:e.payer};m.searchServices(o,i.gridOptions).then(function(e){i.gridOptions.data=e,0!=e.length&&"No Records Found"!=e[0].patientName?(i.updatePatientDisable=!1,i.releaseAction=!0,T(function(){i.gridOptions.selectRow(2,!0)}),$("input[name=rdUserList]").attr("checked","checked"),i.patientValues={regSeqId:i.gridOptions.data[0].patientId}):i.updatePatientDisable=!0}),i.errorVisible=!1},i.deleteInclusionService=function(e,t){i.packageServices[e].servicePostingSeqId&&(i.packageServices.length>1?(i.retrivePackageDeletedServObj.push(i.packageServices[e]),i.packageServices.splice(e,1),i.retrivePacServObj.splice(e,1)):i.inclusionServiceValid=!0)},i.changePkgRates=function(t,r){e.defer();var a=r[0],o=new Date,n=moment(o).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";N.updateService.URL;var c=a.visitTypeCode;i.addSelectServiceTypeArr=[],i.setCurrentTarrifId();var l=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:a.servSeqId,gnServDesign:a.gnServDesign,servCode:a.servCode,servName:a.servName,secServTypeCode:a.servSeqId,priServTypCode:a.servSeqId},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:a.servSeqId,tariffSeqId:s.tariffSeqId,datedOn:n,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:a.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:JSON.parse(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,isRateEditable:1,newRate:t,requestedByEmpType:4,requestedByEmpSeqID:a.requestedByEmpSeqID,payerId:a.payerTypeCode,fromOPVisit:"Y",priority:c}];i.addSelectServiceTypeArr.push(l);var p={};return p.url=N.updateService.URL,p.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectServiceTypeArr}]}},P.sendRestRequest(p).then(function(e){i.isPriceEditResponce=e.data.HITService.message;var t=i.isPriceEditResponce.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"],r=!0;return a.serviceRate!=t.serviceRate&&(r=!1),a.price=t.serviceRateVo.baseRate,a.patamount=t.originalPatientAmount,a.payeramount=t.originalPayerAmount,i.dummyPice=t.serviceRateVo.baseRate,i.dummyPatAmount=t.originalPatientAmount,i.dummyPyrAmount=t.originalPayerAmount,a.newRate=t.newRate,a.patientAmount=t.patientAmount,a.payerAmount=t.payerAmount,a.originalPatientAmount=t.originalPatientAmount,a.originalPayerAmount=t.originalPayerAmount,a.serviceRate=t.serviceRate,a.rcvSeqId=t.serviceRateVo.rcvSeqId,a.inflSeqId=t.serviceRateVo.inflSeqId,a.proposedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,a.billedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,a.grpMstCode=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,a.discountAmt=t.discountAmt,a.doctorAmount=t.doctorAmount,a.doctorShare=t.doctorShare,a.doctorSurcharge=t.doctorSurcharge,a.hospitalShare=t.hospitalShare,a.hospitalSurcharge=t.hospitalSurcharge,a.actualRate=t.actualRate,a.isPostBillApplicable=t.isPostBillApplicable?t.isPostBillApplicable:0,r})},i.clearAdvFields=function(){i.gridOptions.data=[],i.advPat.dateofbirth="",Ie={},$(".datePickerClass").val(""),i.advPat.patientName="",i.advPat.MrNo="",i.advPat.gender="",i.advPat.mno="",i.advPat.regType="",i.advPat.payer="",i.getPatientVal(),i.updatePatientDisable=!0,$("#clear_advance").removeClass("PsearchClearBtn"),$("#clear_advance").addClass("PsearchClearBtn")},i.loadDefaultEpisodeData=function(){i.addNewEpisode.fromDate=new Date;var e=sessionStorage.getItem("episodeRegSeqid"),t=moment(i.addNewEpisode.fromDate).format("YYYY-MM-DD")+"T"+moment().format("HH:mm:ss.SSS")+"Z",r={};r.url=N.updateService.URL,r.requestData={operation:"addNewEpisodeForHSC",messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.EpisodeVo",epStatus:"1",status:"1",EpisodeDate:t,registration:{"@class":"com.napier.core.service.vo.registration.Registration",rgSeqId:e},facilityMaster:{"@class":"com.napier.core.service.vo.masters.FacilityMaster",code:"1"}}},P.sendRestRequest(r).then(function(e){var t=e.data.HITService.message;T(function(){i.clearAddPatientForm(),i.visitDls.OPVMepisodeNo=t.episodeNo,i.visitDls.OPVMepisodeDescription=t.description,i.visitDls.epSeqId=t.episodeSeqId,i.visitDls.OPVMreferedBy="",i.visitDls.OPVMvisitType=t.description,i.addNewEpisode={},i.newEpisode=[],i.newEpisodeSubmit=!1,$("#DefaultEpisodeModal").modal("hide"),i.visitDls.OPVMvisitType=t.description,i.internalorextCk=!0,i.visitDls.OPVMreferedBy1="",i.visitDls.OPVMreferedBy={},i.Mlc={},i.Mlc.OPVMmlcDetails=!1,i.updateVisitFlag=!1;var e=t.isVisitExisits;s.isVisitExisits=e,s.latestVisitNo=t.visitNO,"N"==e?(i.saveCont=!0,i.updateCont=!1):(i.saveCont=!1,i.updateCont=!0),i.tempMlcNum="",i.disableVisitInfo=!1,T(function(){i.dynamicVisitNum=s.latestVisitNo},500)},500)})},i.episodePopUp=function(e){if("HSC"!=sessionStorage.getItem("productCustomization")){i.ckEpDoc=!0,i.epRowNum=i.visitDls.OPVMepisodeNo,i.newEpisodeSubmit=!1,i.checked={selected:!1},i.disabled={selected:!0},s.addNewEpisode2={},i.addNewEpisode={};S.open("EPISODE LIST",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups firstEpisodeList",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-episode-no-modal-popup.html",size:e,scope:i,backdrop:"static",keyboard:!1});i.gridOptionss.data=[];var t=sessionStorage.getItem("episodeRegSeqid");i.episodeList=[],i.episodeLists={1:i.episodeList};var r=I.executeQueryURLReset();return i.episodesList=new Array,I.prepareParamListWithParam("pRegSeqId",t,i.episodesList),I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.episodesList),I.executeQueryInput("GET_EPISODE_LIST",i.episodesList,i.episodeLists,!0,!0,r,"popUp",{}).then(function(e){var t=e[1];i.gridOptionss.data=[];for(var r=0;r<t.length;r++)i.gridOptionss.data.push({EP_DESCRIPTION:t[r].EP_DESCRIPTION,DESCRIPTION:t[r].DESCRIPTION,EP_STRAT_DATE:t[r].EP_STRAT_DATE,FIRSTNAME:t[r].FIRSTNAME,CNT:t[r].CNT,VISIT_LAST_CREATED_ON:t[r].VISIT_LAST_CREATED_ON,EP_STATUS:1==t[r].EP_STATUS?"Open":"Close",LAST_DOCTOR_NAME:t[r].LAST_DOCTOR_NAME,EP_SEQ_ID:t[r].EP_SEQ_ID,EP_NO:t[r].EP_NO,SPECIALITY:t[r].SPECIALITY,EPDOCTOR:t[r].EPDOCTOR,VISIT_NO:t[r].VISIT_NO,DOCT_SEQ_ID:t[r].DOCT_SEQ_ID});i.newEpisode=[];for(var a=[],o=0;o<i.gridOptionss.data.length;o++)a.push(i.gridOptionss.data[o].EP_NO);var s=a.indexOf(i.epRowNum);i.gridApi.grid.modifyRows(i.gridOptionss.data),i.gridApi.selection.selectRow(i.gridOptionss.data[s])})}},i.gridOptionss={enableExpandableRowHeader:!1,enableRowSelection:!0,multiSelect:!1,enableSelectAll:!1,expandableRowTemplate:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-episode-no-sub-grid.html",expandableRowScope:{visitDetails:function(e){var t=e.entity.VISIT_NO;i.searchVisit(t),E.dismissAll()}},onRegisterApi:function(e){i.gridApi=e,e.selection.on.rowSelectionChanged(i,function(e){e.isSelected&&"Open"===e.entity.EP_STATUS?(i.checked={selected:!1},i.disabled={selected:!1}):i.disabled={selected:!0}}),e.expandable.on.rowExpandedStateChanged(i,function(e){if(e.isExpanded){e.entity.subGridOptions={columnDefs:[{displayName:"opvm.VisitNotab",headerCellFilter:"translate",field:"VISIT_NO",cellTemplate:'<a style="cursor:pointer;text-decoration: underline;position:relative;top:4px;"  ng-click="grid.appScope.visitDetails(row)"> {{row.entity.VISIT_NO}}</a>',width:150},{displayName:"opvm.VisitDate",headerCellFilter:"translate",field:"LAST_UPDATED_ON",type:"date",cellFilter:"date:'dd-MM-yyyy'",width:150},{displayName:"opvm.Department",headerCellFilter:"translate",field:"SPECIALITY",width:150},{displayName:"opvm.VisitType",headerCellFilter:"translate",field:"VSITTPDESC",width:150},{displayName:"opvm.ConsultedDoctor",headerCellFilter:"translate",field:"DOCTDESC",width:150}]},i.episodevisitList=[],i.episodevisitLists={1:i.episodevisitList};var t=I.executeQueryURLReset();i.episodesvisitList=new Array;var r=e.entity.EP_SEQ_ID.toString();return I.prepareParamListWithParam("pEpisodeId",r,i.episodesvisitList),I.prepareParamListWithParam("pFacilityId",ye,i.episodesvisitList),I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.episodesvisitList),I.executeQueryInput("VISITS_NO_EP_SEQ_ID",i.episodesvisitList,i.episodevisitLists,!0,!0,t,"popUp",{}).then(function(t){var r=t[1];e.entity.subGridOptions.data=[];for(var a=0;a<r.length;a++)e.entity.subGridOptions.data.push({VISIT_NO:r[a].VISIT_NO,LAST_UPDATED_ON:r[a].LAST_UPDATED_ON,SPECIALITY:r[a].SPECIALITY,VSITTPDESC:r[a].VSITTPDESC,DOCTDESC:r[a].DOCTDESC})})}})}},i.gridOptionss.columnDefs=[{displayName:"opvm.episodeNotab",headerCellFilter:"translate",field:"EP_NO",minWidth:130},{displayName:"opvm.EpisodeDescription",headerCellFilter:"translate",field:"EP_DESCRIPTION",minWidth:150,headerCellTemplate:'<div class="ui-grid-cell-contents ui-grid-header-cell-primary-focus"><span class="ui-grid-header-cell-label req-field" >{{"opvm.EpisodeDescription" | translate}}</span></div>'},{displayName:"opvm.DateOfCreation",headerCellFilter:"translate",field:"EP_STRAT_DATE",type:"date",cellFilter:"date:'dd-MM-yyyy'",minWidth:130},{displayName:"opvm.Department",headerCellFilter:"translate",field:"SPECIALITY",minWidth:130,headerCellTemplate:'<div class="ui-grid-cell-contents ui-grid-header-cell-primary-focus"><span class="ui-grid-header-cell-label req-field" >{{"opvm.Department" | translate}}</span></div>'},{displayName:"opvm.Doctor",headerCellFilter:"translate",field:"EPDOCTOR",minWidth:130,headerCellTemplate:'<div class="ui-grid-cell-contents ui-grid-header-cell-primary-focus"><span class="ui-grid-header-cell-label req-field" >{{"opvm.Doctor" | translate}}</span></div>'},{displayName:"opvm.NoOfVisits",headerCellFilter:"translate",field:"CNT",minWidth:100,cellTemplate:"<div><span>{{row.entity.CNT}}</span> <span ng-click='grid.api.expandable.toggleRowExpansion(row.entity)'><i class='fa fa-angle-down grid-expandarrow'></i></span></div>"},{displayName:"opvm.LastVisitDate",headerCellFilter:"translate",field:"VISIT_LAST_CREATED_ON",type:"date",cellFilter:"date:'dd-MM-yyyy'",minWidth:130},{displayName:"opvm.LastVisitDoctor",headerCellFilter:"translate",field:"LAST_DOCTOR_NAME",minWidth:130},{displayName:"opvm.Status",headerCellFilter:"translate",field:"EP_STATUS",minWidth:60},{displayName:"opvm.empseqid",headerCellFilter:"translate",field:"EP_SEQ_ID",minWidth:100,visible:!1},{displayName:"",headerCellFilter:"translate",field:"VISIT_NO",minWidth:100,visible:!1},{displayName:"",headerCellFilter:"translate",field:"DOCT_SEQ_ID ",minWidth:100,visible:!1}],i.updateEpisode=function(e){i.saveCont=!0,i.tempMlcNum="",i.updateCont=!1,i.addNewVisitFlag=!1,i.addNewEpisodeFlag=!0;var t=i.gridApi.selection.getSelectedRows(),r=sessionStorage.getItem("episodeRegSeqid");if(sessionStorage.removeItem("trnsDoc"),i.setDoctornameFlag=!1,i.newEpisodeSubmit=!0,s.addNewEpisode2.doctor&&!s.addNewEpisode2.doctor.DOCTNAME&&!i.ckEpDoc)return s.addNewEpisode2.doctor=null,!1;if(t.length>0){if("Open"==t[0].EP_STATUS){i.visitDls.OPVMepisodeNo=t[0].EP_NO,i.visitDls.OPVMepisodeDescription=t[0].EP_DESCRIPTION,i.visitDlsDoc.OPVMselectDoctor={},i.visitDlsDoc.OPVMselectDoctor.DOCTID=t[0].DOCT_SEQ_ID,i.visitDlsDoc.OPVMselectDoctor.DOCTNAME=t[0].EPDOCTOR,i.visitDls.epSeqId=t[0].EP_SEQ_ID,i.reasonForVisit=[],i.reasonForVisits={1:i.reasonForVisit};var a=I.executeQueryURLReset();i.reasonForVisitList=new Array;var o=t[0].EP_SEQ_ID.toString();return I.prepareParamListWithParam("pRegSeqId",r,i.reasonForVisitList),I.prepareParamListWithParam("pEpisodeSeqId",o,i.reasonForVisitList),I.executeQueryInput("GET_REASON_DOCNAME_FOR_LATEST_VISIT",i.reasonForVisitList,i.reasonForVisits,!0,!0,a,"popUp",{}).then(function(e){var a=e[1][0];null!=a&&(""==a.EP_REASON_FOR_VISIT?i.visitDls.OPVMvisitType=t[0].EP_DESCRIPTION:i.visitDls.OPVMvisitType=a.EP_REASON_FOR_VISIT),i.saveCont=!1,i.updateCont=!0,E.dismissAll(),i.addNewEpisode={},i.newEpisode=[],i.getDoctorNotes(t[0].EP_SEQ_ID,r),$("#DefaultEpisodeModal").modal("hide"),i.addNewVisit()})}v.hisAlertMulti("warning","Warning","Please Select Open Episode!",{buttonText:"OK"},close)}else if(e.$valid){var n=moment(i.addNewEpisode.fromDate).format("YYYY-MM-DD")+"T"+moment().format("HH:mm:ss.SSS")+"Z",c={};c.url=N.updateService.URL,c.requestData={operation:"addNewEpisode",messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.EpisodeVo",episodeName:i.addNewEpisode.episodename,description:i.addNewEpisode.episodedescription,doctor:void 0===s.addNewEpisode2.doctor.DOCTNAME?s.addNewEpisode2.doctor:s.addNewEpisode2.doctor.DOCTNAME,epDocSeqId:void 0===s.addNewEpisode2.doctor.DOCTID?s.addNewEpisode2.doctorid:s.addNewEpisode2.doctor.DOCTID,epSpeciality:i.addNewEpisode.department.CODE,epStatus:"1",status:"1",EpisodeDate:n,registration:{"@class":"com.napier.core.service.vo.registration.Registration",rgSeqId:r},facilityMaster:{"@class":"com.napier.core.service.vo.masters.FacilityMaster",code:"1"}}},P.sendRestRequest(c).then(function(e){var t=e.data.HITService.message;T(function(){E.dismissAll(),i.clearAddPatientForm(),i.visitDls.OPVMepisodeNo=t.episodeNo,i.visitDls.OPVMepisodeDescription=t.description,i.visitDls.epSeqId=t.episodeSeqId,i.visitDlsDoc.OPVMselectDoctor={},i.visitDlsDoc.OPVMselectDoctor.DOCTID=t.epDocSeqId,i.visitDlsDoc.OPVMselectDoctor.DOCTNAME=t.doctor,i.visitDlsDoc.OPVMselectDoctor.SPECIALITY_CODE=i.addNewEpisode.department.CODE,i.visitDlsDoc.OPVMselectDoctor.SPECIALITYDESC=i.addNewEpisode.department.DESCRIPTION,i.visitDlsDoc.OPVMselectDoctor.DOCTOR_SPECIALITY=t.doctor+", "+i.addNewEpisode.department.DESCRIPTION,i.visitDls.OPVMreferedBy="",i.visitDls.OPVMvisitType=t.description,i.addNewEpisode={},i.newEpisode=[],i.getDoctorNotes(t.episodeSeqId,r),i.newEpisodeSubmit=!1,$("#DefaultEpisodeModal").modal("hide"),i.visitDls.OPVMvisitType=t.description,i.internalorextCk=!0,i.visitDls.OPVMreferedBy1="",i.visitDls.OPVMreferedBy={},i.Mlc={},i.Mlc.OPVMmlcDetails=!1,i.updateVisitFlag=!1,i.saveCont=!0,i.tempMlcNum="",i.updateCont=!1,i.disableVisitInfo=!1},500)})}},i.specialityChange=function(e){i.ckEpDoc=!1,i.addNewEpisode2.doctor="",s.OPVMsearchDoctorSpeciality="",s.OPVMsearchDoctorSpeciality=e},i.docSpecialityChange=function(e){i.ckEpDoc=!1,i.addNewEpisode.department=e,i.OPVMsearchDoctorSpeciality=e},i.addNewEpisodes=function(){i.newEpisodeSubmit=!1,i.addNewEpisode.fromDate=new Date,i.newEpisode=[],i.newEpisode.push({id:1}),i.checked={selected:!0},i.checkBoxChange(i.checked)},i.checkBoxChange=function(e){T(function(){i.gridApi.selection.clearSelectedRows(),!0===e.selected?i.disabled={selected:!1}:i.disabled={selected:!0}},500)},i.doctorSearch=function(e,t){i.dctorpop={},i.dctorpop.DoctorID="",i.dctorpop.DoctorName="",i.OPVMsearchDoctorSpeciality="",i.screenname=t,"EpisodePopUp"===t&&sessionStorage.setItem("episodeDoctor",t),s.modalInstance=S.open("DOCTOR SEARCH",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-doctor-search-modal-popup.html",size:e,scope:i}),T(function(){i.OPVMsearchDoctorSpeciality=i.addNewEpisode.department,i.doctorSearchAdv()},100)},i.extDoctor={},i.extDoctorSearchoptions=angular.copy(t),i.externalDoctorSearch=function(e){s.modalInstance=S.open("External Employee Search",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-externaldoctor-search-modal-popup.html",size:e,scope:i,backdrop:"static",keyboard:!1}),i.enableExternalDoctorAdvSearch=!0,i.selectExtAdvDoctor=!0,i.extDoctor.OPVMextdocSpCentre="",i.extDoctor.extDoctorName="",i.extDoctor.extDoctorName=i.visitDls.OPVMreferedBy1,""!=i.extDoctor.extDoctorName&&(i.enableExternalDoctorAdvSearch=!1),i.extDoctorSearchoptions.data=[],i.spCenterName=[],i.specialityCentreDept=[],i.specialitySubDept=[],i.spCenterNameList={1:i.spCenterName};var t=I.executeQueryURLReset();return i.spCenterNameLists=new Array,I.prepareParamListWithParam("pIsexternal",2,i.spCenterNameLists),I.executeQueryInput("GET_MASTER_REF_FACILITY",i.spCenterNameLists,i.spCenterNameList,!0,!0,t,"popUp",{}).then(function(e){i.specialityCentre=e[1]})},i.extDocSpCentreChange=function(e){i.extDoctor.OPVMExtDocDept="",i.extDoctor.OPVMExtDocSubDept="",i.specialityCentreDept=[],i.specialitySubDept=[],i.spCenterNameDept=[],i.spCenterNameDeptList={1:i.spCenterNameDept};var t=I.executeQueryURLReset();return i.spCenterNameDeptLists=new Array,I.prepareParamListWithParam("pRefSeqId",e.REF_SEQ_ID,i.spCenterNameDeptLists),I.executeQueryInput("GET_MASTER_REF_DEPT",i.spCenterNameDeptLists,i.spCenterNameDeptList,!0,!0,t,"popUp",{}).then(function(e){i.specialityCentreDept=e[1],i.enableExternalDoctorAdvSearch=!1})},i.extDocDeptChange=function(e){i.extDoctor.OPVMExtDocSubDept="",i.specialitySubDept=[],i.extDocDept=[],i.extDocDeptList={1:i.extDocDept};var t=I.executeQueryURLReset();return i.extDocDeptLists=new Array,I.prepareParamListWithParam("pRefdSeqId",e.REFD_SEQ_ID,i.extDocDeptLists),I.executeQueryInput("GET_MASTER_REF_EMPLOYEE_BY_SD",i.extDocDeptLists,i.extDocDeptList,!0,!0,t,"popUp",{}).then(function(e){i.specialitySubDept=e[1]})},i.employeeNameChange=function(){""!=i.extDoctor.OPVMextdocSpCentre&&0!=i.extDoctor.extDoctorName.length?i.enableExternalDoctorAdvSearch=!1:i.extDoctor.extDoctorName.length>0?i.enableExternalDoctorAdvSearch=!1:i.enableExternalDoctorAdvSearch=!0},i.OPVMExternalDoctorSearchTypeAhead=function(e){i.OPVMDoctroSearch=[],i.multipleComboDataForList={1:i.OPVMDoctroSearch};var t=I.executeQueryURLReset();return i.OPVMDoctSearch=new Array,I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.OPVMDoctSearch),I.prepareParamListWithParam("pRefEmpName",e,i.OPVMDoctSearch),I.executeQueryInput("EXTERNAL_OP_DOCTOR_SEARCH",i.OPVMDoctSearch,i.multipleComboDataForList,!0,!0,t,"popUp",{}).then(function(e){if(0!==e)return(e[1]instanceof Array?e[1]:[e[1]]).map(function(e){return e});i.noResults=!0})},i.externalDoctorAdvSearch=function(e){var t={};t.url=N.updateService.URL,t.requestData={operation:"retrieveReferralEmployeeMaster",messageId:"",destination:"com.napier.core.master.service.external.ReferralMasterService",message:{"@class":"com.napier.core.service.vo.emrmasters.ReferralEmployeeMaster",isExternal:2,refFacSeqId:e.OPVMextdocSpCentre.REF_SEQ_ID,deptDesc:e.OPVMExtDocDept.REFD_DESC,subDeptDesc:e.OPVMExtDocSubDept.REFSD_DESC,refdSeqId:e.OPVMExtDocSubDept.REFD_SEQ_ID,refsdSeqId:e.OPVMExtDocDept.REFSD_SEQ_ID,empName:e.extDoctorName}},P.sendRestRequest(t).then(function(e){var t=e.data.HITService.message[0]["com.napier.core.service.vo.emrmasters.ReferralEmployeeMaster"];if(i.extDoctorSearchoptions.data=[],null!=t.length)for(var r=0;r<t.length;r++)i.extDoctorSearchoptions.data.push({refFacDesc:t[r].refFacDesc,deptDesc:t[r].deptDesc,subDeptDesc:t[r].subDeptDesc,empName:t[r].empName});else i.extDoctorSearchoptions.data.push({refFacDesc:t.refFacDesc,deptDesc:t.deptDesc,subDeptDesc:t.subDeptDesc,empName:t.empName})})},i.selectExtAdvDoc=function(){s.modalInstance.close(),i.visitDls.OPVMreferedBy1=i.extDoctorSearchValues.empName},i.doctorSearchAdv=function(e){s.OPVMselectDoctor="";var t,r,a;a=void 0===i.OPVMsearchDoctorSpeciality||null===i.OPVMsearchDoctorSpeciality?"":i.OPVMsearchDoctorSpeciality.CODE,i.gridDoctorSearchoptions.data.length=0,i.OPVMsearchBypatientName=[],i.multipleComboDataForList={1:i.OPVMsearchBypatientName},t=angular.element(document.querySelector("#opvm-search-doctor-doctorID"))[0].value,r=i.dctorpop.OPVMsearchDoctorDoctorName;var o=I.executeQueryURLReset();return i.OPVMsearchBypatientNameList=new Array,I.prepareParamListWithParam("pSpecializationId",a,i.OPVMsearchBypatientNameList),I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.OPVMsearchBypatientNameList),I.prepareParamListWithParam("pDoctorId",t,i.OPVMsearchBypatientNameList),I.prepareParamListWithParam("pDoctorName",r,i.OPVMsearchBypatientNameList),I.executeQueryInput("OP_DOCTOR_ADVANCE_SEARCH",i.OPVMsearchBypatientNameList,i.multipleComboDataForList,!0,!0,o,"popUp",{}).then(function(e){for(var t=0;t<e[1].length;t++)i.gridDoctorSearchoptions.data.push({Doctorname:e[1][t].DOCTNAME,DoctorID:e[1][t].DOCTID,Speciality:e[1][t].SPECIALITYDESC,SpecialityCode:e[1][t].SPECIALITY_CODE,DoctorSpeciality:e[1][t].DOCTOR_SPECIALITY})})},q.getTitle().then(function(e){i.titles=e},function(e){}),q.getGender().then(function(e){i.genders=e},function(e){}),q.serviceTypes().then(function(e){i.serviceTypes=e},function(e){}),i.filterValue=function(e){46!=e.keyCode&&isNaN(String.fromCharCode(e.keyCode))&&e.preventDefault()},i.clearAddPatientForm=function(){i.patientSubmit=!1,i.permanentregistration={},i.permanentregistration.DOB=!0},i.addpatientdetailssave=function(e,t){i.patientSubmit=!0;var r=e.OPVMaddPatientDetailsAge;if(r.indexOf("y")>0)var a=r.split("y")[0];else a=0;if(t.$valid){var o={"@class":"com.napier.core.service.vo.registration.Registration",patient:{"@class":"com.napier.core.service.vo.registration.Patient",status:{"@class":"com.napier.core.service.vo.masters.GeneralMaster",type:"GN_STATUS",code:1,description:"Active"},title:{"@class":"com.napier.core.service.vo.masters.SalutationMaster",code:e.OPVMaddPatientdetailsTitle||""},firstName:e.OPVMaddPatientDetailsFirstName||"",middleName:e.OPVMaddPatientDetailsMiddleName||"",lastName:e.OPVMaddPatientDetailsLastName||"",age:a||"",mobileNo:e.OPVMaddPatientdetailsMobileNumber||"",emailId:e.OPVMaddPatientDetailsEmailId||"",date:moment().toISOString(),dateOfBirth:new Date(e.fromDate._d).toISOString(),tmpNationalId:e.OPVMaddPatientDetailsNationalId,serviceTypeCode:e.OPVMaddPatientDetailsService||"",sex:{"@class":"com.napier.core.service.vo.masters.GenderMaster",code:e.OPVMaddPatientdetailsGender||""},facilityId:{"@class":"com.napier.core.service.vo.masters.FacilityMaster",code:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,description:JSON.parse(sessionStorage.userContextObj).FACILITY},typeOfReg:{"@class":"com.napier.core.service.vo.masters.GeneralMaster",type:"Registration Type",code:2,description:"Temporary Registration"}}},s={url:"HISServices/HITService"};s.requestData={operation:"createRegistration",destination:"com.napier.core.registration.service.external.RegistrationService",messageid:"",message:o},P.sendRestRequest(s).then(function(t){i.patientBannerCollapsed=!1;var r=t.data.HITService.message;if(r.patient){var a="Patient Details Saved successful -Temp No: "+r.patient.tempNo,o={buttonClose:function(){i.patientTempRegt(r.tmpSeqId),i.clear(e),i.clearAddPatientForm(),$(".ng-patient-banner").attr("class","ng-patient-banner ng-scope"),i.patientBannerVisible=!0}};v.hisAlertMulti("success","Succes",a,"","",o)}else v.failure("FAILED"," "+r.errorMessage)},function(e){v.failure("Failed","Patient  Details has been failed.",!1,!1,me.time)})}},i.clear=function(e){e.OPVMaddPatientDetailsNationalId="",e.OPVMaddPatientdetailsTitle="",i.permanentregistration={},i.visitDls={}},i.loadReferedDocDtls=function(e){if(i.visitDls.OPVMreferedBy1="",i.visitDls.OPVMreferedBy={},"I"==e){i.hideExternalRef=!1,i.hideInternalRef=!0,i.rDocList=[],i.rDocComboList={1:i.rDocList};var t=I.executeQueryURLReset();i.refDocList=new Array,I.prepareParamListWithParam(1,angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.refDocList),I.executeQueryInput("DOCT_LIST_NEW",i.refDocList,i.rDocComboList,!0,!0,t,"popUp"),i.visitDls.OPVMreferedBy1=""}else i.hideInternalRef=!1,i.hideExternalRef=!0,i.visitDls.OPVMreferedBy1=""},i.loadReferedDocDtls("I"),Y.getList("HSC_VISITLOCATION_DROPDOWN_001",[]).then(function(e){i.admittingLocationComboList=[];var t=W.getQryComboList(e);angular.forEach(t,function(e,t){var r=e.columnList[0]["com.napier.core.service.vo.query.Column"],a={CODE:r[0].data,DESCRIPTION:r[1].data};i.admittingLocationComboList.push(a)})}),i.checkIfAppoinemntIsSelected=function(){try{if(i.todaysAppoinmentsData.length>0&&i.RowsArr.length>0)for(var e=0;e<i.RowsArr.length;e++)for(var t=0;t<i.todaysAppoinmentsData.length;t++)i.RowsArr[e][0].opApmntSeqId==i.todaysAppoinmentsData[t].opApmntSeqId&&(i.todaysAppoinmentsData[t].isSelected=!0,i.todaysAppoinmentsData[t].apptFlag=!0);if(i.appointmentsData.length>0&&i.RowsArr.length>0)for(e=0;e<i.RowsArr.length;e++)for(t=0;t<i.appointmentsData.length;t++)i.RowsArr[e][0].opApmntSeqId==i.appointmentsData[t].opApmntSeqId&&(i.appointmentsData[t].isSelected=!0,i.appointmentsData[t].apptFlag=!0)}catch(e){}},i.showComingAppt=function(){if(i.regTypeData&&i.regTypeData.RG_SEQ_ID){i.setCurrentTarrifId();i.todaysAppoinmentsData=[],i.appointmentsData=[],i.appointmentsDataFull=[],i.fromAppoinemtView=!0;var e={"@class":"com.napier.his.appointment_management.vo.PatientSearchVO",rgSeqId:i.regTypeData.RG_SEQ_ID},t={url:"HISServices/AppointmentsManagementService"};t.requestData={operation:"getAppointmentsDetailsForOPPatient",destination:"com.napier.his.appointment_management.service.external.AppointmentsManagementService",message:e},P.sendRestRequest(t).then(function(e){var t=e.data.HITService.message[0]["com.napier.his.appointment_management.vo.OpAppointmentsEntityVO"];if(void 0!==t){i.modalInstance=S.open("APPOINTMENTS LIST",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-up-coming-appointments.html",size:"lg",scope:i});i.apptFlag=0;let e=t instanceof Array?t:[t];var r=moment().format("YYYY-MM-DD");let o=[];for(var a=0;a<e.length;a++){e[a].value=a,e[a].calendarDateToDisplyFormat=new Date(e[a].calendarDateToDisply.split("T")[0].split("-")[2]+"/"+e[a].calendarDateToDisply.split("T")[0].split("-")[1]+"/"+e[a].calendarDateToDisply.split("T")[0].split("-")[0]),e[a].showHeader=!0;let t=moment(e[a].calendarDateToDisplyFormat).diff(r,"days");0===t?i.todaysAppoinmentsData.push(e[a]):(-1===o.indexOf(e[a].calendarDateToDisply)?o.push(e[a].calendarDateToDisply):e[a].showHeader=!1,t>0&&(e[a].isFuture=!0),i.appointmentsData.push(e[a])),i.appointmentsDataFull.push(e[a]),i.selectedapptment&&i.selectedapptment.opApmntSeqId==e[a].opApmntSeqId&&(i.apptFlag=i.selectedapptment.opApmntSeqId)}i.todaysAppoinmentsData.length>1&&i.todaysAppoinmentsData.sort(function(e,t){return e.slotStartTime>t.slotStartTime?1:e.slotStartTime<t.slotStartTime?-1:0}),i.appointmentsData.sort(function(e,t){return new Date(e.calendarDateToDisplyFormat)-new Date(t.calendarDateToDisplyFormat)}),i.checkIfAppoinemntIsSelected()}else i.appointmentsData=[],i.todaysAppoinmentsData=[],i.appointmentsDataFull=[]})}},i.getPayerDetail=function(e,t){if(null!=t)if(s.isVisitExisits&&"N"==s.isVisitExisits);else var r=t;var a={url:"HISServices/HISServices"};a.requestData={operation:"getPayerDetailsForOPPatient",messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.PayerDetailsVo",rgSeqId:e,enSeqId:r}},P.sendRestRequest(a).then(function(e){if(s.tariffSeqId="",e&&e.data&&e.data.HITService&&e.data.HITService.message&&e.data.HITService.message[0]&&e.data.HITService.message[0]["com.napier.core.service.vo.visitmanagement.PayerDetailsVo"])var t=e.data.HITService.message[0]["com.napier.core.service.vo.visitmanagement.PayerDetailsVo"];t?(i.payerDetails=t instanceof Array?t:[t],i.payerDetails[0].tariffSeqId&&(s.tariffSeqId=i.payerDetails[0].tariffSeqId)):v.failure("Failed"," "+t.errorMessage)},function(e){v.failure("Failed","Visit Search has been failed.",!1,!1,me.time)})},i.patientOutstandingPop=function(t){if(!i.isIpPat){var r;e.defer();r={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"OPVM_PATIENT_SEARCH_OUTSTDAMT",idxList:[{"com.napier.core.service.vo.query.Index":[{ident:1,value:t}]}]}]}]};var o={};o.url=a.HISCOMBOFILLING.URL,o.requestData={operation:"ExecuteQuery",destination:"QueryService",message:r},P.sendRestRequest(o).then(function(e){var r=e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0];if(""!=r){var a=r["com.napier.core.service.vo.query.Row"].columnList[0]["com.napier.core.service.vo.query.Column"];a.data&&parseFloat(a.data)>0&&(sessionStorage.getItem("pharmacyOPVM")||$("#patientOutstandingModal").modal({backdrop:"static",keyboard:!1}),i.OutStandingAmount=a.data)}else i.openVisitsInfo(t)})}},i.closeOutStandingModel=function(){$("#patientOutstandingModal").modal("hide"),i.openVisitsInfo(s.patientSeqId)},i.getAppoinmentDetailstoOrder=function(){if(i.selectedAppoinmentList&&i.selectedAppoinmentList.length>0){E.dismissAll(),i.addRowStatus=!1;var e=i.payerTypeModel.PayerType.PINS_SEQ_ID;H.getAppoinmentConsDetails(i.selectedAppoinmentList,i.regTypeData.RG_SEQ_ID,s.encounterSeqId,s.tariffSeqId,e).then(function(e){if(e&&e.length>0){for(let t=0;t<e.length;t++)e[t][0].payerType=i.payerTypeModel.PayerType.PAYER_NAME,e[t][0].payerTypeCode=i.payerTypeModel.PayerType.PINS_SEQ_ID,e[t][0].payerTarrifId=i.payerTypeModel.PayerType.TATRIFF_SEQ_ID?i.payerTypeModel.PayerType.TATRIFF_SEQ_ID:s.tariffSeqId,e[t][0].insurancePlanSeqId=null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,e[t][0].appointReason=i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID;i.RowsArr=i.RowsArr.concat(e),i.orderBtnDisable=!1}i.selectedAppoinmentList=[],i.addRowStatus=!0},function(e){i.addRowStatus=!0})}},i.checkVisitfromAppointment=function(){i.selectedAppoinmentList=[];var e=!1,t=!1;try{for(let e=0;e<i.todaysAppoinmentsData.length;e++)i.todaysAppoinmentsData[e].apptFlag&&!i.todaysAppoinmentsData[e].isSelected&&(i.selectedAppoinmentList.push(i.todaysAppoinmentsData[e]),t=!0);for(let t=0;t<i.appointmentsData.length;t++)i.appointmentsData[t].apptFlag&&!i.appointmentsData[t].isSelected&&(i.selectedAppoinmentList.push(i.appointmentsData[t]),e=!0)}catch(e){}return 0==i.selectedAppoinmentList.length?(v.warning("Warning!","Please select at least one Appointment for Visit creation.",!1,!1,me.time),!1):e&&t?(v.warning("Warning!","Visit can be created only against of same day Appointments.",!1,!1,me.time),!1):e?(v.warning("Warning!","Future day Appointments are not allowed for visit creation.",!1,!1,me.time),!1):void(i.fromAppoinemtView?i.getAppoinmentDetailstoOrder():i.createVisitfromAppointment())},i.createVisitfromAppointment=function(){E.dismissAll(),i.visitDls.OPVMvisitType="",i.addNewVisit();var e=i.selectedAppoinmentList[0].resourceName.slice(4);i.visitDls.OPVMvisitType=i.selectedAppoinmentList[0].resonForDoctorVisit,i.visitDlsDoc.OPVMselectDoctor={},i.visitDlsDoc.OPVMselectDoctor.DOCTID=i.selectedAppoinmentList[0].doctorId,i.visitDlsDoc.OPVMselectDoctor.DOCTNAME=e,i.visitDlsDoc.OPVMselectDoctor.SPECIALITY_CODE=i.selectedAppoinmentList[0].specalityId,i.visitDlsDoc.OPVMselectDoctor.SPECIALITYDESC=i.selectedAppoinmentList[0].specalityName,i.visitDlsDoc.OPVMselectDoctor.DOCTOR_SPECIALITY=e+", "+i.selectedAppoinmentList[0].specalityName,"HSC"!=sessionStorage.getItem("productCustomization")&&i.addNewEpisodes(),T(function(){i.addNewEpisodes(),"HSC"!=sessionStorage.getItem("productCustomization")?(i.addNewEpisodes(),i.addNewEpisode.episodedescription=i.selectedAppoinmentList[0].resonForDoctorVisit):i.loadDefaultEpisodeData(),i.addNewEpisode2.doctor=e,s.addNewEpisode2.doctor=e,s.addNewEpisode2.doctorid=i.selectedAppoinmentList[0].doctorId;for(var t=0;t<i.serviceComboObj.length;t++)i.serviceComboObj[t].CODE==i.selectedAppoinmentList[0].specalityId&&(i.addNewEpisode.department=i.serviceComboObj[t])},300)},m.comboBoxFetch("MLC_TYPES").then(function(e){i.mlctypeComboObj=e}),i.selectAdvDoc=function(){if("EpisodePopUp"===sessionStorage.getItem("episodeDoctor")){i.ckEpDoc=!1,sessionStorage.setItem("episodeDoctor",null),s.addNewEpisode2.doctor=i.doctorSearchValues.Doctorname;var e=i.OPVMsearchDoctorSpeciality;s.modalInstance.close(e),sessionStorage.setItem("epDoc",JSON.stringify(i.doctorSearchValues));JSON.parse(sessionStorage.getItem("epDoc"));s.addNewEpisode2.doctorid=i.doctorSearchValues.DoctorID}else if("ordersScreen"==i.screenname){i.orders.OPVMselectDoctor={},i.orderDetails.OPVMselectDoctor=i.doctorSearchValues.Doctorname,i.orders.OPVMselectDoctor.DOCTID=i.visitDlsDoc.OPVMselectDoctor.DOCTID,i.orders.OPVMselectDoctor.DOCTNAME=i.visitDlsDoc.OPVMselectDoctor.DOCTNAME,i.orders.OPVMselectDoctor.SPECIALITY_CODE=i.visitDlsDoc.OPVMselectDoctor.SPECIALITY_CODE,i.orders.OPVMselectDoctor.SPECIALITYDESC=i.visitDlsDoc.OPVMselectDoctor.SPECIALITYDESC,i.orders.OPVMselectDoctor.DOCTOR_SPECIALITY=i.visitDlsDoc.OPVMselectDoctor.DOCTOR_SPECIALITY,i.orderDoctDetails=i.orders.OPVMselectDoctor,i.orderData.requestedByEmpName=i.doctorSearchValues.Doctorname,i.orderData.requestedByEmpSeqID=i.doctorSearchValues.DoctorID,s.modalInstance.close();var t={};t.docID=i.doctorSearchValues.DoctorID,t.DOCTNAME=i.doctorSearchValues.Doctorname;var r=i.doctorSearchValues.SpecialityCode,a=i.doctorSearchValues.DoctorID,o=sessionStorage.getItem("orderregSeqId"),n=sessionStorage.getItem("orderencounterSeqId");i.setCurrentTarrifId();var c=s.tariffSeqId,l=i.payerTypeModel.PayerType.PINS_SEQ_ID,p=i.orderData.quantity,d="";d=void 0!==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID?i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID:i.orderData.appointReason;var m="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,m=i.priorityvis.priorityTypeModel.DT_CODE):(i.priorityvis.visitTypeModel,m=i.orderDetails.visitTypeCode);var u=m;if(1!=d){i.addSelectServicepostEditArr=[];var S=new Date,y=moment(S).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";N.updateService.URL;var D=1;3==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID&&(D=2);var g=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.orderDetails.servSeqId,gnServDesign:D,servCode:i.orderDetails.servCode,servName:i.orderDetails.servName,secServTypeCode:i.orderDetails.servSeqId,priServTypCode:i.orderDetails.servSeqId},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.orderDetails.servSeqId,tariffSeqId:s.tariffSeqId,datedOn:y,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:i.orderData.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:a,payerId:l,fromOPVisit:"Y",priority:u}];i.addSelectServicepostEditArr.push(g);var A={};A.url=N.updateService.URL,A.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectServicepostEditArr}]}},P.sendRestRequest(A).then(function(e){i.addselectEdiresponse=e.data.HITService.message,""==i.addselectEdiresponse.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time);var t=i.addselectEdiresponse.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];i.orderData.serviceTypeCODE=t.primaryServiceCode,i.orderData.serviceType=t.primaryServiceCode,i.orderData.servCode=t.serviceVo.servCode,i.orderData.servName=t.serviceVo.servName,i.orderData.servSeqId=t.serviceVo.servSeqId,i.orderData.gnServDesign=t.serviceVo.gnServDesign,i.orderData.servicePayerAuthorization=t.servicePayerAuthorization,i.orderData.requestedByEmpName=t.requestedByEmpName,i.orderData.requestedByEmpSeqID=t.requestedByEmpSeqID,i.orderData.requestedByEmpType=t.requestedByEmpType,i.orderData.payerType=i.payerTypeModel.PayerType.PAYER_NAME,i.orderData.payerTypeCode=i.payerTypeModel.PayerType.PINS_SEQ_ID,i.orderData.insurancePlanSeqId=null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,i.orderData.actualRate=t.actualRate,i.orderData.quantity=1,i.orderData.isPostBillApplicable=t.isPostBillApplicable?t.isPostBillApplicable:0,i.orderData.patientAmount=t.patientAmount,i.orderData.payerAmount=t.payerAmount,i.orderData.originalPatientAmount=t.originalPatientAmount,i.orderData.originalPayerAmount=t.originalPayerAmount,i.orderData.discountAmt=t.discountAmt,i.orderData.doctorAmount=t.doctorAmount,i.orderData.doctorShare=t.doctorShare,i.orderData.doctorSurcharge=t.doctorSurcharge,i.orderData.hospitalShare=t.hospitalShare,i.orderData.hospitalSurcharge=t.hospitalSurcharge,i.orderData.isRateEditable=t.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,1==i.orderData.isRateEditable&&(i.orderData.minValue=null!=t.minVal?t.minVal:t.serviceVo.scmMasterServBillingAttrVo.minValue,i.orderData.maxValue=null!=t.maxVal?t.maxVal:t.serviceVo.scmMasterServBillingAttrVo.maxValue,i.orderData.fromTariffRate="R"),i.orderData.newRate=t.newRate,i.orderData.proposedShareAfterDiscount=t.proposedShareAfterDiscount,i.orderData.serviceRate=t.serviceRate,i.orderData.serviceRateStatus=t.serviceRateStatus,i.orderData.standardDoctorShare=t.standardDoctorShare,i.orderData.technicianAmount=t.technicianAmount,i.orderData.baseRate=t.serviceRateVo.baseRate,i.orderData.gnFlow=t.gnFlow,i.orderData.facilityId=t.facilityId,i.orderData.billStatus=0,i.orderData.payerCompSeqId=t.payerCompSeqId,i.orderData.payerCompPlanseqId=t.payerCompPlanseqId,i.orderDetails.price=t.serviceRate,i.dummyPice=t.serviceRate/i.orderDetails.quantity,i.dummyPatAmount=t.originalPatientAmount/i.orderDetails.quantity,i.dummyPyrAmount=t.originalPayerAmount/i.orderDetails.quantity,i.orderDetails.patamount=t.originalPatientAmount,i.orderDetails.payeramount=t.originalPayerAmount,i.dummyPyrAutherisation=t.servicePayerAuthorization,i.orderDetails.servCode=t.serviceVo.servCode,i.orderDetails.servName=t.serviceVo.servName,i.orderDetails.servSeqId=t.serviceVo.servSeqId,i.orderData.rcvSeqId=t.serviceRateVo.rcvSeqId,i.orderData.inflSeqId=t.serviceRateVo.inflSeqId,i.orderData.proposedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,i.orderData.billedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,i.orderData.grpMstCode=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,i.orderData.priServTypCode=t.secServiceCode,null!=t.serviceVo&&null!=t.serviceVo.atomicDetailsVo&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&(null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&(i.orderData.deptCode=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code),null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&(i.orderData.specilityCode=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code))})}else i.getOrderDetails(a,o,n,c,void 0,l,p,r);i.OrderDoctorChange("Doctor",t)}else{sessionStorage.removeItem("epDoc"),i.setDoctornameFlag=!1,sessionStorage.setItem("trnsDoc",JSON.stringify(i.doctorSearchValues));var I=JSON.parse(sessionStorage.getItem("trnsDoc"));s.visitDlsDoc.OPVMselectDoctor=I.Doctorname,i.visitDlsDoc.OPVMselectDoctor={},i.visitDlsDoc.OPVMselectDoctor.DOCTID=I.DoctorID,i.visitDlsDoc.OPVMselectDoctor.DOCTNAME=I.Doctorname,i.visitDlsDoc.OPVMselectDoctor.SPECIALITY_CODE=I.SpecialityCode,i.visitDlsDoc.OPVMselectDoctor.SPECIALITYDESC=I.Speciality,i.visitDlsDoc.OPVMselectDoctor.DOCTOR_SPECIALITY=I.DoctorSpeciality,s.modalInstance.close()}},i.getPatientCatg=function(t){var r=e.defer(),o={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"NHIS_ADT_TR_072",idxList:[{"com.napier.core.service.vo.query.Index":[{ident:"1",value:t},{ident:"2",value:1},{ident:"3",value:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID}]}]}]}]},s={};return s.url=a.HISCOMBOFILLING.URL,s.requestData={operation:"ExecuteQuery",messageId:"",destination:"QueryService",message:o},P.sendRestRequest(s).then(function(e){var t,r=(t=void 0===e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"].columnList?e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"][0].columnList[0]["com.napier.core.service.vo.query.Column"]:e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"].columnList[0]["com.napier.core.service.vo.query.Column"]).filter(function(e){return"B.PCATG_SEQ_ID"==e.name}),a=t.filter(function(e){return"A.RG_PAT_CATG"==e.name});i.patCatCode=a[0].data,i.patCatSeqId=r[0].data}),r.promise},i.getVisitCount=function(){i.visitCountData=[],i.visitCountDataForListorder={1:i.visitCountData};var e=I.executeQueryURLReset();return i.visitCountDataListorder=new Array,I.prepareParamListWithParam("pRgSeqId",sessionStorage.getItem("episodeRegSeqid"),i.visitCountDataListorder),I.executeQueryInput("GET_VISIT_ADMISSION_COUNT_HSC",i.visitCountDataListorder,i.visitCountDataForListorder,!0,!0,e,"popUp",i.advSearch).then(function(e){var t=e[1];e[1][0]&&(i.opVisitCount=t[0].VISIT_COUNT)})},i.visitSaveUpdate=function(e,t,r,a,o){i.submit=!0,i.setPracticeId=void 0,i.setfacilityId=void 0;var n="";i.enSeqId=void 0;var c=void 0,l=void 0,p=typeof r.OPVMselectDoctor.DOCTID;if(o.$valid&&"undefined"!=p){JSON.parse(sessionStorage.getItem("trnsDoc")),JSON.parse(sessionStorage.getItem("epDoc"));var d,m,u,S,y,D,g=sessionStorage.getItem("episodeRegSeqid");""==t.OPVMreferedBy1||void 0===t.OPVMreferedBy1?(m=t.OPVMreferedBy.gQDataCode,u=t.OPVMreferedBy.gQDataName):S=t.OPVMreferedBy1,D=null!=s.convertedFile?s.convertedFile.split("base64")[1]:"";t.OPVMreferedBy1;if(i.updateCont){i.enSeqId=i.epSqNo,i.docSeqId&&(l=i.docSeqId),n="updateVisitInfoEncounter",c=i.mlcDetailsId,i.setPracticeId=angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.setfacilityId=angular.fromJson(sessionStorage.userContextObj).FACILITY_ID;for(var A={},I=[],h=0,R=1,f=1;f<$("#payersTable tr").length;f++)A={"@class":"com.napier.core.service.vo.visitmanagement.PayerDetailsVo",payPrioritySeqId:""==$("#payersTable tr td")[R].innerText?void 0:parseInt($("#payersTable tr td")[R].innerText),payerNameId:parseInt($("#payersTable tr td")[h].innerText),payPriority:f},I.push(A),h+=5,R+=5}else{n="createVisitInfoEncounter";for(A={},I=[],h=0,R=1,f=1;f<$("#payersTable tr").length;f++)A={"@class":"com.napier.core.service.vo.visitmanagement.PayerDetailsVo",payerNameId:parseInt($("#payersTable tr td")[h].innerText),payPriority:f},I.push(A),h+=5,R+=5}0==e.OPVMmlcDetails||void 0===e.OPVMmlcDetails?d="n":(d="y",y={"@class":"com.napier.core.service.vo.visitmanagement.MLCDetailsVo",mlcDetailsId:c,mlcNo:e.OPVMmlcNo,accidentReportNo:e.OPVMaccidentReportNo,policeStationName:e.OPVMinformedPoliceStation,policeName:e.OPVMpolicePersonnelName,remarks:e.OPCMremark,mlcTypeId:e.OPVMmlcType}),t.OPVMepisodeNo||(n="createEpisodeAndVisit",t.epSeqId=void 0);var C=moment().format("YYYY-MM-DD")+"T"+moment().format("HH:mm:ss.SSS")+"Z",b={url:"HISServices/HISServices"};"HSC"===sessionStorage.productCustomization?b.requestData={operation:n,messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",hscSpec:sessionStorage.getItem("productCustomization"),enSeqId:i.enSeqId,enSpeciality:r.OPVMselectDoctor.SPECIALITY_CODE,createdDate:C,refAgentSeqId:i.agent.hscAgent?i.agent.hscAgent.REFERRAL_AGENT_SEQ_ID:void 0,strReasonForVisit:t.OPVMvisitType,enIsInternalExternalDoc:t.internalorext,doctorMaster:{"@class":"com.napier.core.service.vo.masters.DoctorMaster",doctSeqId:r.OPVMselectDoctor.DOCTID,doctName:r.OPVMselectDoctor.DOCTNAME},refDoctorMaster:{"@class":"com.napier.core.service.vo.masters.DoctorMaster",doctSeqId:m,doctName:u},encounterGnStatusMaster:{"@class":"com.napier.core.service.vo.masters.GeneralMaster",code:1},machineIp:JSON.parse(sessionStorage.appConfig).login_WORKSTATION,facilityMaster:{"@class":"com.napier.core.service.vo.masters.FacilityMaster",code:JSON.parse(sessionStorage.userContextObj).FACILITY_ID},enPhysicianName:S,enIsMlc:d,mlcDetailsVo:y,napierDocument:{"@class":"com.napier.core.service.vo.uploadfile.NapierDocument",facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,docName:angular.element(document.querySelector("#opvm-mlc-upload-file"))[0].value,uploadDocumnt:D,status:"1",docSeqId:l,createdBy:JSON.parse(sessionStorage.userContextObj).USER_SEQ_ID,createdDate:C,context:15,docTypeSeqId:36,practiceId:i.setPracticeId,machineIp:JSON.parse(sessionStorage.userContextObj).WORKSTATION,referenceId:i.enSeqId,contextDetailMaster:{"@class":"com.napier.core.service.vo.uploadfile.ContextDetailMaster",code:24}},registraiion:{"@class":"com.napier.core.service.vo.registration.Registration",rgSeqId:g},patientCategory:{"@class":"com.napier.core.service.vo.masters.PatientCategory",code:i.patCatCode,patCatSeqId:i.patCatSeqId},enNo:t.OPVMepisodeNo,encounterTypeMaster:{"@class":"com.napier.core.service.vo.masters.GeneralMaster",code:1},episode:{"@class":"com.napier.core.service.vo.visitmanagement.Episode",epSeqId:t.epSeqId,epDescription:t.OPVMepisodeDescription},payerDetailsVoLst:[{"com.napier.core.service.vo.visitmanagement.PayerDetailsVo":I}],visitLocation:t.admittingLocation}}:b.requestData={operation:n,messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enSeqId:i.enSeqId,enSpeciality:r.OPVMselectDoctor.SPECIALITY_CODE,createdDate:C,strReasonForVisit:t.OPVMvisitType,enIsInternalExternalDoc:t.internalorext,doctorMaster:{"@class":"com.napier.core.service.vo.masters.DoctorMaster",doctSeqId:r.OPVMselectDoctor.DOCTID,doctName:r.OPVMselectDoctor.DOCTNAME},refDoctorMaster:{"@class":"com.napier.core.service.vo.masters.DoctorMaster",doctSeqId:m,doctName:u},encounterGnStatusMaster:{"@class":"com.napier.core.service.vo.masters.GeneralMaster",code:1},machineIp:JSON.parse(sessionStorage.appConfig).login_WORKSTATION,facilityMaster:{"@class":"com.napier.core.service.vo.masters.FacilityMaster",code:"1"},enPhysicianName:S,enIsMlc:d,mlcDetailsVo:y,napierDocument:{"@class":"com.napier.core.service.vo.uploadfile.NapierDocument",facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,docName:angular.element(document.querySelector("#opvm-mlc-upload-file"))[0].value,uploadDocumnt:D,status:"1",docSeqId:l,createdBy:JSON.parse(sessionStorage.userContextObj).USER_SEQ_ID,createdDate:C,context:15,docTypeSeqId:36,practiceId:i.setPracticeId,machineIp:JSON.parse(sessionStorage.userContextObj).WORKSTATION,referenceId:i.enSeqId,contextDetailMaster:{"@class":"com.napier.core.service.vo.uploadfile.ContextDetailMaster",code:24}},registraiion:{"@class":"com.napier.core.service.vo.registration.Registration",rgSeqId:g},patientCategory:{"@class":"com.napier.core.service.vo.masters.PatientCategory",code:i.patCatCode,patCatSeqId:i.patCatSeqId},enNo:t.OPVMepisodeNo,encounterTypeMaster:{"@class":"com.napier.core.service.vo.masters.GeneralMaster",code:1},episode:{"@class":"com.napier.core.service.vo.visitmanagement.Episode",epSeqId:t.epSeqId,epDescription:t.OPVMepisodeDescription},payerDetailsVoLst:[{"com.napier.core.service.vo.visitmanagement.PayerDetailsVo":I}]}},P.sendRestRequest(b).then(function(e){var t=e.data.HITService.message;if(t){i.opVisitCountApplicableFlag&&i.getVisitCount();var r=t.enSpeciality,a=t.doctorMaster.doctSeqId,o=sessionStorage.getItem("orderregSeqId"),n=sessionStorage.getItem("orderencounterSeqId"),c=s.tariffSeqId,l=i.payerDetails[0].payPrioritySeqId,p=i.orderDetails.quantity;if("y"==d&&i.savaForMLCService(t,a,o,n,c,void 0,l,p,r),i.defaultVisit=!1,i.dynmVisit=!0,angular.element(document.querySelector("#opvm-mlc-upload-file"))[0].value="",i.updateCont){var m="Visit Updated Succesfully!<br />Visit No: "+i.visitNumber;"Y"==i.integrationApplicableFlag&&re.createIntegrationRequest(g,"Admission","sendIntegrationRequest").then(function(e){}),i.showVSaveLoadingIcon=!1,i.dynamicVisitNum=i.visitNumber,T(function(){E.dismissAll(),i.searchVisit(i.visitNumber),i.getOrderDetails(a,o,n,c,void 0,l,p,r),T(function(){i.activeFirst=2},1e3)},3e3)}else{m="Visit Created Successfully!<br />Visit No: "+t.visitNo;i.showVSaveLoadingIcon=!1,i.dynamicVisitNum=t.visitNo,T(function(){E.dismissAll(),i.searchVisit(t.visitNo,!1,!0),i.getOrderDetails(a,o,n,c,void 0,l,p,r),T(function(){i.activeFirst=2},1e3)},3e3)}"Y"==i.integrationApplicableFlag&&re.createIntegrationRequest(g,"Admission","sendIntegrationRequest").then(function(e){}),v.hisAlertMulti("success","Success",m,"","",""),i.showVSaveLoadingIcon=!1}else v.failure("Failed"," ",!1,!1,me.time),i.showVSaveLoadingIcon=!1})}else i.showVSaveLoadingIcon=!1},i.visitSave=function(e,t,r,a,o,s){if(o.$valid)if("update"==s)i.showVSaveLoadingIcon=!0,i.visitSaveUpdate(e,t,r,a,o);else{if("NO"==i.isAllowMultiVisitPerEpisode&&t.epSeqId){i.showVSaveLoadingIcon=!0;i.visitExist=[],i.visitExists={1:i.visitExist};var n=I.executeQueryURLReset();return i.visitExistList=new Array,I.prepareParamListWithParam("pEpSeqId",t.epSeqId,i.visitExistList),I.executeQueryInput("ALLOW_MULTIPLE_VISIT_PER_EPISODE_QUERY",i.visitExistList,i.visitExists,!0,!0,n,"popUp",{}).then(function(s){if(s[1].length>0)return v.warning("Warning!","Visit Already Open for this Episode. You can not create new visit.",!1,!1,me.time),i.showVSaveLoadingIcon=!1,!1;i.visitSaveUpdate(e,t,r,a,o)})}i.showVSaveLoadingIcon=!0,i.visitSaveUpdate(e,t,r,a,o)}else i.submit=!0},i.checkPayerCRLimit=function(e,t,r,a,o){var s=0,n=angular.element(document.querySelector("#payersTable tbody tr td").innerText).selector;if(n&&""!=n&&a&&-1===(s=a.map(function(e){return e.payerNameId}).indexOf(parseInt(n)))&&(s=0),a&&a[s]&&(1==a[s].payerType||3==a[s].payerType)){var c={1:i.checkList=[]},l=I.executeQueryURLReset(),p=1==a[s].payerType?2:1,d=new Array;I.prepareParamListWithParam("PAYER_SEQ_ID",a[s].payerSeqId,d),I.prepareParamListWithParam("TYPE",p,d),I.prepareParamListWithParam("PAT_CATG",-999,d),I.prepareParamListWithParam("BED_CLASS",-999,d),I.prepareParamListWithParam("OPERATION","OPVISIT",d),I.executeQueryInput("SP_UPS_GET_PAYER_CREDIT_LIMIT",d,c,!0,!0,l,"popUp",{}).then(function(s){if(s[1])if(i.checkList[0]&&parseFloat(i.checkList[0].AVAIALBLE_BAL)<=0){var n={buttonCallBack1:function(){i.visitSave(e,t,r,a,o)},buttonCallBack2:function(){}};v.hisAlertMulti("warning","Confirmation","Credit limit is exceeding. Would you like to continue ?",{buttonText:"YES",buttonText2:"NO"},n,close)}else i.visitSave(e,t,r,a,o)})}else i.visitSave(e,t,r,a,o)},i.getPatAllPayers=function(e){i.patPayerData=[],i.patPayerComboDataList={1:i.patPayerData};var t=I.executeQueryURLReset();return i.patPayerDataList=new Array,I.prepareParamListWithParam("pRegSeqId",e,i.patPayerDataList),I.executeQueryInput("PATIENTS_PAYER_QUERY_001",i.patPayerDataList,i.patPayerComboDataList,!0,!0,t,"popUp",i.advSearch).then(function(e){i.AllPatPayerDetails=e[1]})},i.getAddedPreAuths=function(e){i.addPayerAuthrList=[];var t={};t.url=N.updateService.URL,t.requestData={operation:"getAuthorizationReqDtls",messageId:"",destination:"com.napier.core.billgeneration.service.external.ApproximateBillService",message:{"@class":"com.napier.core.billgeneration.vo.ApproxBillVo",regSeqId:e}},P.sendRestRequest(t).then(function(e){var t=e.data,r=t.HITService.message.approxBillsList?t.HITService.message.approxBillsList[0]["com.napier.core.billgeneration.vo.ApproxBillVo"]:"";if(r){var a=[];void 0!==r.length?a=r:a.push(r);for(var o=0;o<a.length;o++)i.addPayerAuthrList.push({reqDate:moment(a[o].approxBillDate.$).format("DD/MM/YYYY"),reqDateDummy:a[o].approxBillDate.$,plan:a[o].planName,autherNum:0==a[o].approvalRefNo?"":a[o].approvalRefNo,apprAmnt:0==a[o].approvedAmount?"":a[o].approvedAmount,payerType:a[o].payerType,status:a[o].approvalStatus,approxBillNo:a[o].approxBillNo,approxBillHdSeqId:a[o].approxBillHdSeqId,effectiveFrom:null!=a[o].effectiveFrom&&null!=a[o].effectiveFrom.$?moment(a[o].effectiveFrom.$).format("DD/MM/YYYY"):void 0,effectiveFromDummy:null!=a[o].effectiveFrom&&null!=a[o].effectiveFrom.$?a[o].effectiveFrom.$:void 0,effectiveTo:null!=a[o].effectiveTo&&null!=a[o].effectiveTo.$?moment(a[o].effectiveTo.$).format("DD/MM/YYYY"):void 0,effectiveToDummy:null!=a[o].effectiveTo&&null!=a[o].effectiveTo.$?a[o].effectiveTo.$:void 0,gnStatus:a[o].GN_STATUS,isBillOrServiceLevel:a[o].isBillOrServiceLevel,consumnedCnt:a[o].consumnedCnt,totalCnt:a[o].totalCnt,deleteFlag:null!=a[o].consumnedCnt&&1==a[o].consumnedCnt,editFlag:null!=a[o].consumnedCnt&&null!=a[o].totalCnt&&a[o].consumnedCnt==a[o].totalCnt})}})},i.searchVisit=function(e,t,r){m.checkVisitClosedorNot(e).then(function(e){4!=e.data?i.clsvisitBtn=!1:("HSC"!=i.hscSpecific&&v.warning("Warning!","Visit Already Closed.Please Create a New Visit",!1,!1,me.time),i.clsvisitBtn=!0,i.dynmVisit=!0,i.defaultVisit=!1,i.dynamicVisitNum="")}),i.getPatAllPayers(s.patientSeqId),i.getAddedPreAuths(s.patientSeqId),i.showVSaveLoadingIcon=!1,i.showRefundLoadingIcon=!1,i.showConcessionLoadingIcon=!1,i.showPaymentLoadingIcon=!1,i.showGBillLoadingIcon=!1,i.showGBillCanLoadingIcon=!1,i.showOrderCanLoadingIcon=!1,i.showOrderLoadingIcon=!1,i.reqFromOrder=!1,i.cancelButtonEna=0,i.amountValid=!1,s.orderRowData=null,i.addRowStatus=!0,i.orderUpdate=!1,i.orderBtnDisable=!0,s.editRowRecord=null,i.packageServicesArrayObejct=[],s.selectedPreServices=[],s.cancelSerIndex=[],i.PA={},i.PA={fromDate:new Date,PAUnitDays:1},i.showErrors=!1,i.showPlanError=!1,i.visitDls={},i.Mlc={},i.visitDlsDoc={},i.payerDetails={};var a={url:"HISServices/HISServices"};a.requestData={operation:"getVisitInfoEncounter",messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",visitNo:e}},P.sendRestRequest(a).then(function(a){try{var o=a.data.HITService.message;if(i.docSeqId=o.napierDocument.docSeqId,void 0!==o.enNo){"HSC"==sessionStorage.productCustomization&&(i.agent.hscAgent={},i.agent.hscAgent=_.find(i.agentName,{REFERRAL_AGENT_SEQ_ID:o.refAgentSeqId})),i.getPayerDetail(o.registraiion.rgSeqId,o.enSeqId),i.updateVisitFlag=!0,t&&(i.activeFirst=1),sessionStorage.getItem("pharmacyOPVM")&&(i.activeFirst=2,sessionStorage.removeItem("pharmacyOPVM")),i.saveCont=!1,i.updateCont=!0,i.addNewVisitFlag=!0,i.addNewEpisodeFlag=!0,i.visitDetails=!0,i.visitEdit=!0,i.patientBannerCollapsed=!1,i.noVisitRecords=!1,$("#no-result-found_visit").hide(),i.visitNumber=o.visitNo,i.clsvisitBtn,i.defaultVisit=!1,i.dynmVisit=!0,i.dynamicVisitNum=o.visitNo,i.mlcDetailsId=o.mlcDetailsVo.mlcDetailsId,$(".ng-patient-banner").attr("class","ng-patient-banner ng-scope"),i.patientBannerVisible=!0;var n={};i.payerDetails={},n.regSeqId=o.registraiion.rgSeqId,sessionStorage.setItem("episodeRegSeqid",o.registraiion.rgSeqId),i.opVisitCountApplicableFlag&&i.getVisitCount(),s.encounterSeqId=o.enSeqId,i.PatientDetailsData=o,i.epSqNo=o.enSeqId,sessionStorage.setItem("orderdoctSeqId",o.doctorMaster.doctSeqId),sessionStorage.setItem("orderregSeqId",o.registraiion.rgSeqId),sessionStorage.setItem("orderencounterSeqId",o.enSeqId),sessionStorage.setItem("orderEncounterNo",o.enNo),sessionStorage.setItem("ordervisitId",e),"HSC"==sessionStorage.productCustomization&&o.visitLocation&&(i.admittingLocationData=o.visitLocation),t?(i.getPrescptionCount(),i.getAccountByEnID()):(s.patientGlobalDtlsNew=[],s.patientGlobalDtls={},g.getPatientBanner(n,"2").then(function(e){e.visitNO&&i.visitNumber&&(e.visitNO=i.visitNumber),s.patientGlobalDtlsNew.push(e),s.patientGlobalDtls=s.patientGlobalDtlsNew[0],e.typeOfReg&&(i.regTypeData={RG_SEQ_ID:o.registraiion.rgSeqId,RG_INT_MR_NO:e.mrNo,RG_TYPE:e.typeOfReg,isDischargeIntimated:e.isDischargeIntimated?e.isDischargeIntimated:void 0,encounterType:e.encounterType}),R.patientBannerDetail(n.regSeqId).then(function(e){if(i.upldphotoDoc=e,i.patientBannerDetails=e,e.insurance){var t=e.insurance;(t=t instanceof Array?t:[t])[0].cmpSeqId&&t[0].cmpSeqId.inCompName&&(s.patientGlobalDtlsNew[0].insuranceComp=t[0].cmpSeqId.inCompName),t[0].insurancePlanMaster&&t[0].insurancePlanMaster.inPlanName&&(s.patientGlobalDtlsNew[0].insurancePlan=t[0].insurancePlanMaster.inPlanName),t[0].covrgStrtDate&&t[0].covrgStrtDate.$&&(s.patientGlobalDtlsNew[0].pEffectivedate=t[0].covrgStrtDate.$),t[0].covrgEndDate&&t[0].covrgEndDate.$&&(s.patientGlobalDtlsNew[0].pExpiredate=t[0].covrgEndDate.$),i.noPayer=!0}s.patientGlobalDtlsNew[0].userPermision=12});try{null!==A.entityObj&&void 0!==A.entityObj&&null==s.mrNo&&(s.mrNo=e.mrNo,i.loadBillNumbers(e.mrNo))}catch(e){}i.getPrescptionCount(),i.getAccountByEnID(),i.PatientDetailsDataObj=s.patientGlobalDtlsNew[0],s.patientGlobalDtls=s.patientGlobalDtlsNew[0],i.PatientDetailsDataObj.patientId=i.PatientDetailsDataObj.mrNo,""==s.tariffSeqId&&(s.tariffSeqId=s.patientGlobalDtlsNew[0].tariffSeqId);var t=angular.copy(e.mrNo);Z.searchRegisteredPatientService(t).then(function(e){i.opvisitPatientDetails=angular.copy(e)}),i.getOrderPayerDetails(o.enSeqId,o.registraiion.rgSeqId,o.doctorMaster.doctSeqId),i.getOrderDetails(o.doctorMaster.doctSeqId,o.registraiion.rgSeqId,o.enSeqId,s.tariffSeqId,void 0,l,void 0,o.enSpeciality),r&&i.selectedAppoinmentList&&i.selectedAppoinmentList.length>0&&(i.addRowStatus=!1,H.getAppoinmentConsDetails(i.selectedAppoinmentList,o.registraiion.rgSeqId,o.enSeqId,s.tariffSeqId,l).then(function(e){if(e&&e.length>0){for(let t=0;t<e.length;t++)e[t][0].payerType=i.payerTypeModel.PayerType.PAYER_NAME,e[t][0].payerTypeCode=i.payerTypeModel.PayerType.PINS_SEQ_ID,e[t][0].payerTarrifId=i.payerTypeModel.PayerType.TATRIFF_SEQ_ID?i.payerTypeModel.PayerType.TATRIFF_SEQ_ID:s.tariffSeqId,e[t][0].insurancePlanSeqId=null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,e[t][0].appointReason=i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID;i.RowsArr=i.RowsArr.concat(e),i.orderBtnDisable=!1}i.selectedAppoinmentList=[],i.addRowStatus=!0},function(e){i.addRowStatus=!0}))}));var c=o.payerDetailsVoLst[0]["com.napier.core.service.vo.visitmanagement.PayerDetailsVo"];if(void 0!==c[0])var l=c[0].payPrioritySeqId;else l=c.payPrioritySeqId;if(i.getDoctorNotes(o.episode.epSeqId,o.registraiion.rgSeqId),i.getOrderPayerDetails(o.enSeqId,o.registraiion.rgSeqId,o.doctorMaster.doctSeqId),i.getOrderDetails(o.doctorMaster.doctSeqId,o.registraiion.rgSeqId,o.enSeqId,s.tariffSeqId,void 0,l,void 0,o.enSpeciality),i.getPatientCatg(o.registraiion.rgSeqId),"E"!=o.enIsInternalExternalDoc&&"e"!=o.enIsInternalExternalDoc||(i.hideExternalRef=!0,i.hideInternalRef=!1,i.visitDls.internalorext="E",i.internalorextCkE=!0,i.internalorextCk=!1,i.visitDls.OPVMreferedBy1=o.enPhysicianName),"I"!=o.enIsInternalExternalDoc&&"i"!=o.enIsInternalExternalDoc||(i.hideExternalRef=!1,i.hideInternalRef=!0,i.visitDls.internalorext="I",i.internalorextCk=!0,i.internalorextCkE=!1,i.visitDls.OPVMreferedBy={},i.visitDls.OPVMreferedBy.gQDataCode=o.refDoctorMaster.doctSeqId,i.visitDls.OPVMreferedBy.gQDataName=o.refDoctorMaster.doctName),i.visitDls.epSeqId=o.episode.epSeqId,i.visitDls.OPVMepisodeNo=o.episode.epNo,i.visitDls.OPVMepisodeDescription=o.episode.epDescription,i.visitDls.OPVMvisitType=o.strReasonForVisit,i.visitDlsDoc.OPVMselectDoctor={},i.visitDlsDoc.OPVMselectDoctor.DOCTID=o.doctorMaster.doctSeqId,i.visitDlsDoc.OPVMselectDoctor.DOCTNAME=o.doctorMaster.doctName,i.visitDlsDoc.OPVMselectDoctor.SPECIALITY_CODE=o.enSpeciality,i.visitDlsDoc.OPVMselectDoctor.SPECIALITYDESC=o.speciality,o.doctorMaster.doctSeqId>0&&o.speciality?i.visitDlsDoc.OPVMselectDoctor.DOCTOR_SPECIALITY=o.doctorMaster.doctName+", "+o.speciality:i.visitDlsDoc.OPVMselectDoctor.DOCTOR_SPECIALITY="",""!=o.mlcDetailsVo.mlcTypeId||"0"!=o.mlcDetailsVo.mlcTypeId){if(i.Mlc.OPVMmlcDetails=!0,i.Mlc.OPVMmlcType=o.mlcDetailsVo.mlcTypeId,i.Mlc.OPVMmlcNo=o.mlcDetailsVo.mlcNo,i.Mlc.OPVMaccidentReportNo=o.mlcDetailsVo.accidentReportNo,i.Mlc.OPVMinformedPoliceStation=o.mlcDetailsVo.policeStationName,i.Mlc.OPVMpolicePersonnelName=o.mlcDetailsVo.policeName,i.Mlc.OPCMremark=o.mlcDetailsVo.remarks,o.napierDocument.docName){i.Mlc.docName=o.napierDocument.docName;var p=o.napierDocument.docName;i.dotFormat2=p.split(".")[1];var d=o.napierDocument.uploadDocumnt[0].replace(/ +/g,""),m="data:application/"+i.dotFormat2+";base64,";i.Mlc.docFileLink=m+d}}else i.Mlc={},i.Mlc.OPVMmlcDetails=!1;c?i.payerDetails=c instanceof Array?c:[c]:v.failure("Failed"," "+c.errorMessage),sessionStorage.setItem("episodeRegSeqid",o.registraiion.rgSeqId),i.patientBannerCollapsed=!1,null!=o.napierDocument.uploadDocumnt&&(s.convertedFile=o.napierDocument.uploadDocumnt[0]),"HSC"===sessionStorage.productCustomization&&i.admittingLocationData&&(i.visitDls.admittingLocation=i.admittingLocationData)}else i.noVisitRecords=!0,$("#no-result-found_visit").show(),i.visitDetails=!1,i.patientBannerVisible=!1,i.patientBannerCollapsed=!1}catch(e){}null!==A.entityObj&&void 0!==A.entityObj&&T(function(){i.activeFirst=2},300)},function(e){v.failure("Failed","Visit Search has been failed.",!1,!1,me.time)})},i.registerpatient=function(){sessionStorage.setItem("currentHashTag","OpVisitManagement"),sessionStorage.setItem("napier_active_tab","Front Desk"),sessionStorage.setItem("moduleHref","index.frontDesk.permanentRegistration"),i.$emit("hdr.showAfterDashboard",{message:!0}),L.go("index.frontDesk.permanentRegistration",void 0,{reload:!1})},i.checkPatRegSession=function(){var e=sessionStorage.getItem("permanentRegistrationData");if(null!=e){i.patObjtDetail.push({RGSEQID:parseInt(e)});var t={};i.activeFirst=1,t.regSeqId=e,g.getPatientBanner(t,"2").then(function(e){null!=e.encounterType&&0!=e.encounterType||(e.encounterType=1),s.patientGlobalDtlsNew.push(e),s.patientGlobalDtls=s.patientGlobalDtlsNew[0];var t=angular.copy(e.mrNo);Z.searchRegisteredPatientService(t).then(function(e){i.opvisitPatientDetails=angular.copy(e)})}),i.selectMatch(i.patObjtDetail[0]),sessionStorage.removeItem("permanentRegistrationData"),i.activeFirst&&1==i.activeFirst&&T(function(){i.activeFirst=1},200)}},i.getDoctorNotes=function(t,r){e.defer();i.mlcpreviousVisitNote={};var o={};o="HSC"==i.hscSpecific?{"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"GET_PREVIOUS_VISIT_DETAILS_HSC",idxList:[{"com.napier.core.service.vo.query.Index":[{paramName:"pEpisodeSeqId",value:t},{paramName:"pRegSeqId",value:r},{paramName:"pPracticeId",value:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID}]}]}]}]}:{"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"GET_PREVIOUS_VISIT_DETAILS",idxList:[{"com.napier.core.service.vo.query.Index":[{paramName:"pEpisodeSeqId",value:t},{paramName:"pRegSeqId",value:r},{paramName:"pPracticeId",value:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID}]}]}]}]};var s={};s.url=a.HISCOMBOFILLING.URL,s.requestData={operation:"ExecuteQuery",destination:"QueryService",message:o},P.sendRestRequest(s).then(function(e){var t=e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"],r="",a=[];if(t){void 0!==t.length?r=t:(a.push(t),r=a);for(var o=[],s=0;s<r.length;s++){for(var n=r[s].columnList[0]["com.napier.core.service.vo.query.Column"],c={},l=0;l<n.length;l++){c[n[l].name.split(".")[1]]=n[l].data}o.push(c)}i.prevVisitNotes=o}else i.prevVisitNotes=[]})},i.dateToDuration=function(e,t){if(""==e&&(permanentregistration.regForm.age=""),Math.floor(moment(new Date).diff(moment(e,"DD/MM/YYYY"),"years",!0))<=150&&t&&moment(e,"DD/MM/YYYY",!0).isValid()){}},i.durationToDate=function(e){i.years=0,i.mon=0,i.days=0;var t=e.split("/");if(t[0].indexOf("y")>0){var r,a,o;!(t[0].indexOf("y ")>0)||(r=t[0].split("y ")[0]+"y "),!(t[0].indexOf("y ")[1].split("m ")>0)||(a=t[0].split("y ")[1].split("m ")[0]+"m "),!(t[0].indexOf("y ")[1].split("m ")[1].split("d")>0)||(o=t[0].split("y ")[1].split("m ")[1].split("d")[0]+"d"),i.permanentregistration.age=r+a+o}else{var s={};t[0]&&""!==t[0]&&(t[0]>150||isNaN(parseInt(t[0]))||parseInt(t[0])<0||/[a-zA-Z\s\r\n@!#\$\^%&\_*()+=\-\[\]\\\';,\.\/\{\}\|\:<>\?]/.test(t[0])?(i.age1=!0,i.permanentregistration.fromDate="",i.years=0,i.mon=0,i.days=0):(s.years=parseInt(t[0]),i.years=t[0],i.age1=!1)),t[1]&&""!==t[1]&&(t[1]>12||isNaN(parseInt(t[1]))||parseInt(t[1])<0||/[a-zA-Z\s\r\n@!#\$\^%&\_*()+=\-\[\]\\\';,\.\/\{\}\|\:<>\?]/.test(t[1])?(i.age1=!0,i.permanentregistration.fromDate="",i.years=0,i.mon=0,i.days=0):(s.months=parseInt(t[1]),i.mon=t[1])),t[2]&&""!==t[2]&&(t[2]>31||isNaN(parseInt(t[2]))||parseInt(t[2])<0||/[a-zA-Z\s\r\n@!#\$\^%&\_*()+=\-\[\]\\\';,\.\/\{\}\|\:<>\?]/.test(t[2])?(i.age1=!0,i.permanentregistration.fromDate="",i.years=0,i.mon=0,i.days=0):(s.days=parseInt(t[2]),i.days=t[2]));var n=moment.duration(s),c=moment();c.subtract(n),i.permanentregistration.age=i.years+"y "+i.mon+"m "+i.days+"d",i.permanentregistration.fromDate=moment(moment(c),"DD/MM/YYYY"),moment(i.permanentregistration.fromDate).format("DD/MM/YYYY")==moment().format("DD/MM/YYYY")&&(i.permanentregistration.fromDate=null)}},i.openCameraWindow=function(){i.modalInstance=S.open("Capture Photo",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/common/permanent-registration/templates/permanentregistration.capturephoto.html",size:"md",scope:i})};var he=JSON.parse(sessionStorage.getItem("permanentRegistrationSessionStorageData"));sessionStorage.removeItem("permanentRegistrationSessionStorageData"),null!=he&&(i.patObjtDetail.push({RGSEQID:parseInt(he.rgSeqId)}),i.selectedapptment={},i.selectedapptment.opApmntSeqId=he.apptSeqId,i.selectMatch(i.patObjtDetail[0]),i.visitDetails=!0),i.advserviceTypeModel=[],i.addselectresponse={},i.loadServiceTypeCombo=function(){i.serviceTypeorder=[],i.serviceTypeOrderList={1:i.serviceTypeorder};var e=I.executeQueryURLReset();return i.serviceTypeListorder=new Array,I.executeQueryInput("OP_ORDERS_SERVICE_TYPE_QUERY_001",i.serviceTypeListorder,i.serviceTypeOrderList,!0,!0,e,"popUp",i.advSearch).then(function(e){var t=e[1];i.servicetypeComboObj=t})}(),i.loadAccountDetails=function(){i.accountorder=[],i.accountOrderList={1:i.accountorder};var e=I.executeQueryURLReset();return i.AccountDataListorder=new Array,I.prepareParamListWithParam("pEncounterSeqId",sessionStorage.getItem("orderencounterSeqId"),i.AccountDataListorder),I.executeQueryInput("OP_BL_M_COMMON_002",i.AccountDataListorder,i.accountOrderList,!0,!0,e,"popUp",i.advSearch).then(function(e){i.accountres=e[1][0],i.accountres&&(sessionStorage.setItem("accountseqId",i.accountres.ACC_SEQ_ID),sessionStorage.setItem("subaccountseqId",i.accountres.SUB_ACC_SEQ_ID),sessionStorage.setItem("patcatg",i.accountres.EN_PAT_CATG))})},i.getOrderPayerDetails=function(e,t,r){i.serviceDataorder=[],i.singleComboDataForListorder={1:i.serviceDataorder};var a=I.executeQueryURLReset();return i.serviceDataListorder=new Array,I.prepareParamListWithParam("pRegSeqId",t,i.serviceDataListorder),I.prepareParamListWithParam("pEnSeqId",e,i.serviceDataListorder),I.executeQueryInput("OP_V0013",i.serviceDataListorder,i.singleComboDataForListorder,!0,!0,a,"popUp",i.advSearch).then(function(e){i.AllorderPayerDetails=e[1],i.payerTypeModel={PayerType:e[1][0]}})},i.getOrderDetails=function(e,t,r,a,o,s,n,c,l,p){i.loadAccountDetails(),a&&(i.orderDetails={},i.priorityvis.visitTypeModel="New",H.getOrderDetails(e,t,r,a,o,s,n,c,l,p).then(function(e){var t;32==e.visistType?t="New":33==e.visistType?t="Free Follow Up":37==e.visistType&&(t="Follow Up");var r=1;void 0!==e.quantity&&(r=e.quantity),i.hidepriorityTypeComboRef=!1,i.hidevisitTypeComboRef=!0,i.serviceTypeModel.serviceType=e.serviceTypeCode,i.orderDetails.OPVMorderService=e.servName,i.orderDetails.OPVMselectDoctor=e.requestedByEmpName,i.orderData.serviceTypeCode=e.serviceTypeCode,i.orderData.requestedByEmpSeqID=e.requestedByEmpSeqID,i.orderData.visitTypeCode=e.visistType,i.orderData.rcvSeqId=e.rcvSeqId,i.orderData.inflSeqId=e.inflSeqId,i.orderData.proposedShare=e.proposedShare,i.orderData.billedShare=e.billedShare,i.orderData.grpMstCode=e.grpMstCode?e.grpMstCode:void 0,i.orderDetails.visitTypeCode=e.visistType,i.priorityvis.visitTypeModel=t,i.orderDetails.price=e.baseRate,i.orderDetails.quantity=r,i.orderDetails.patamount=e.originalPatientAmount,i.orderDetails.payeramount=e.originalPayerAmount,i.orderDetails.servSeqId=e.servSeqId,i.orderDetails.servName=e.servName,i.orderDetails.servCode=e.servCode,i.orderData.transType=1,i.dummyPyrAutherisation=e.servicePayerAuthorization,i.dummyPice=e.baseRate,i.dummyPatAmount=e.originalPatientAmount,i.dummyPyrAmount=e.originalPayerAmount,i.orderData=e;for(var a=0;a<i.servicetypeComboObj.length;a++)i.servicetypeComboObj[a].CODE&&i.servicetypeComboObj[a].CODE==e.serviceTypeCode&&(i.serviceTypeModel.serviceType=i.servicetypeComboObj[a]);le.opPreAuthGetData(i)}))},i.checkMinMaxForRateEditable=function(){var e=null;if(1==i.orderData.isRateEditable&&i.orderData.fromTariffRate&&"R"==i.orderData.fromTariffRate.trim()){if(null==i.orderData.minValue||null==i.orderData.minValue||""===i.orderData.minValue||"null"==i.orderData.minValue||null==i.orderData.maxValue||null==i.orderData.maxValue||""===i.orderData.maxValue||"null"==i.orderData.maxValue)return v.information("information","Minimum and Maximum Rates Are Not Defined For Rate Editable Service -  "+i.orderDetails.servName),e=!1,i.orderData.docShareData=void 0,e;if(i.orderDetails.price>i.orderData.maxValue)return v.information("information","Service Rate Can't Be More Than Maximum Value For Rate",!1,!1,me.time),e=!1,i.orderDetails.price=i.orderData.originalBaseRate,i.orderData.docShareData=void 0,i.changeRatesBasedonPriceEdit(i.orderDetails.price),e;if(i.orderDetails.price<i.orderData.minValue)return v.information("information","Service Rate Can't Be Less Than Minimun Value For Rate",!1,!1,me.time),e=!1,i.orderDetails.price=i.orderData.originalBaseRate,i.orderData.docShareData=void 0,i.changeRatesBasedonPriceEdit(i.orderDetails.price),e}},i.addOrdersRow=function(e){if(i.showOrderErrors=!0,e.$valid){for(var t=[],r=0;r<i.RowsArr.length;r++)i.RowsArr[r][0].servSeqId==i.orderData.servSeqId&&3!=i.RowsArr[r][0].servicePostingType&&t.push(i.RowsArr[r][0].servName);if(0==t.length){if(i.orderData.baseRate!=i.orderDetails.price)if(0==i.checkMinMaxForRateEditable())return;for(var a=[],o=(i.orderData.servSeqId,0);o<i.RowsArr.length;o++)a.push(i.RowsArr[o][0].servSeqId);var n="",c="";if(void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel&&null!=i.priorityvis.priorityTypeModel?(n=i.priorityvis.priorityTypeModel.DETAIL_DESC,c=i.priorityvis.priorityTypeModel.DT_CODE):(n=i.priorityvis.visitTypeModel,c=i.orderDetails.visitTypeCode),void 0!==i.RowsArr)var l=Number(i.RowsArr.length);else l=0;i.orderData.servicePayerAuthorization&&"N"==i.orderData.servicePayerAuthorization&&"self"!=i.payerTypeModel.PayerType.PAYER_NAME.toLocaleLowerCase()?i.isServiceSelectedCovered=!0:i.isServiceSelectedCovered=!1,i.rows=[{serviceTypeCODE:i.orderData.serviceTypeCode,serviceType:i.serviceTypeModel.serviceType.DESCRIPTION,servCode:i.orderData.servCode,servDesign:i.orderData.servDesign,servName:i.orderData.servName,servSeqId:i.orderData.servSeqId,servicePayerAuthorization:i.orderData.servicePayerAuthorization,visistType:n,requestedByEmpName:i.orderData.requestedByEmpName,requestedByEmpSeqID:i.orderData.requestedByEmpSeqID,requestedByEmpType:i.orderData.requestedByEmpType,payerType:i.payerTypeModel.PayerType.PAYER_NAME,payerTypeCode:i.payerTypeModel.PayerType.PINS_SEQ_ID,payerTarrifId:i.payerTypeModel.PayerType.TATRIFF_SEQ_ID?i.payerTypeModel.PayerType.TATRIFF_SEQ_ID:s.tariffSeqId,insurancePlanSeqId:null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,actualRate:i.orderData.actualRate,quantity:i.orderDetails.quantity,patientAmount:i.orderData.patientAmount,payerAmount:i.orderData.payerAmount,originalPatientAmount:i.orderData.originalPatientAmount,originalPayerAmount:i.orderData.originalPayerAmount,discountAmt:i.orderData.discountAmt,doctorAmount:i.orderData.doctorAmount,doctorShare:i.orderData.doctorShare,doctorSurcharge:i.orderData.doctorSurcharge,doctorModifiedAmount:i.orderData.doctorModifiedAmount,hospitalShare:i.orderData.hospitalShare,hospitalSurcharge:i.orderData.hospitalSurcharge,isRateEditable:i.orderData.isRateEditable,minValue:i.orderData.minValue,maxValue:i.orderData.maxValue,fromTariffRate:i.orderData.fromTariffRate,newRate:i.orderData.newRate,proposedShareAfterDiscount:i.orderData.proposedShareAfterDiscount,serviceRate:i.orderData.serviceRate,serviceRateStatus:i.orderData.serviceRateStatus,standardDoctorShare:i.orderData.standardDoctorShare,technicianAmount:i.orderData.technicianAmount,baseRate:i.orderData.baseRate,gnFlow:i.orderData.gnFlow,facilityId:i.orderData.facilityId,billStatus:0,gnServDesign:i.orderData.gnServDesign,payerCompSeqId:i.orderData.payerCompSeqId,payerCompPlanseqId:i.orderData.payerCompPlanseqId,appointReason:i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID,visitTypeCode:c,rowIndex:l,transType:i.orderData.transType,proposedShare:i.orderData.proposedShare,billedShare:i.orderData.billedShare,grpMstCode:i.orderData.grpMstCode?i.orderData.grpMstCode:void 0,deptCode:i.orderData.deptCode,specilityCode:i.orderData.specilityCode,priServTypCode:i.orderData.priServTypCode,isPostBillApplicable:i.orderData.isPostBillApplicable?scope.orderData.isPostBillApplicable:0}],i.RowsArr.unshift(i.rows),i.counter++;i.orderData.requestedByEmpName,sessionStorage.getItem("orderregSeqId"),sessionStorage.getItem("orderencounterSeqId");i.orderDetails.OPVMorderService="",i.orderDetails.price="",i.orderDetails.quantity=1,i.orderDetails.patamount="",i.orderDetails.payeramount="",i.priorityvis.priorityTypeModel="",i.priorityvis.visitTypeModel="",i.serviceTypeModel.serviceType="",2==i.orderData.gnServDesign&&i.showpackageServices(i.rows,i.rows.length-1),i.orderData.isRateEditable=2,T(function(){i.isServiceSelectedCovered=!1},2e3),i.showOrderErrors=!1,i.orderBtnDisable=!1,i.checkOrderSaved=!0}else{var p={buttonCallBack1:function(){if(i.orderData.baseRate!=i.orderDetails.price&&0==i.checkMinMaxForRateEditable())return;for(var e=[],t=(i.orderData.servSeqId,0);t<i.RowsArr.length;t++)e.push(i.RowsArr[t][0].servSeqId);var r="",a="";if(void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel&&null!=i.priorityvis.priorityTypeModel?(r=i.priorityvis.priorityTypeModel.DETAIL_DESC,a=i.priorityvis.priorityTypeModel.DT_CODE):(r=i.priorityvis.visitTypeModel,a=i.orderDetails.visitTypeCode),void 0!==i.RowsArr)var o=Number(i.RowsArr.length);else o=0;i.orderData.servicePayerAuthorization&&"N"==i.orderData.servicePayerAuthorization&&"self"!=i.payerTypeModel.PayerType.PAYER_NAME.toLocaleLowerCase()?i.isServiceSelectedCovered=!0:i.isServiceSelectedCovered=!1,i.rows=[{serviceTypeCODE:i.orderData.serviceTypeCode,serviceType:i.serviceTypeModel.serviceType.DESCRIPTION,servCode:i.orderData.servCode,servDesign:i.orderData.servDesign,servName:i.orderData.servName,servSeqId:i.orderData.servSeqId,servicePayerAuthorization:i.orderData.servicePayerAuthorization,visistType:r,requestedByEmpName:i.orderData.requestedByEmpName,requestedByEmpSeqID:i.orderData.requestedByEmpSeqID,requestedByEmpType:i.orderData.requestedByEmpType,payerType:i.payerTypeModel.PayerType.PAYER_NAME,payerTypeCode:i.payerTypeModel.PayerType.PINS_SEQ_ID,payerTarrifId:i.payerTypeModel.PayerType.TATRIFF_SEQ_ID?i.payerTypeModel.PayerType.TATRIFF_SEQ_ID:s.tariffSeqId,insurancePlanSeqId:null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,actualRate:i.orderData.actualRate,quantity:i.orderDetails.quantity,patientAmount:i.orderData.patientAmount,payerAmount:i.orderData.payerAmount,originalPatientAmount:i.orderData.originalPatientAmount,originalPayerAmount:i.orderData.originalPayerAmount,discountAmt:i.orderData.discountAmt,doctorAmount:i.orderData.doctorAmount,doctorShare:i.orderData.doctorShare,doctorModifiedAmount:i.orderData.doctorModifiedAmount,doctorSurcharge:i.orderData.doctorSurcharge,hospitalShare:i.orderData.hospitalShare,hospitalSurcharge:i.orderData.hospitalSurcharge,isRateEditable:i.orderData.isRateEditable,minValue:i.orderData.minValue,maxValue:i.orderData.maxValue,fromTariffRate:i.orderData.fromTariffRate,newRate:i.orderData.newRate,proposedShareAfterDiscount:i.orderData.proposedShareAfterDiscount,serviceRate:i.orderData.serviceRate,serviceRateStatus:i.orderData.serviceRateStatus,standardDoctorShare:i.orderData.standardDoctorShare,technicianAmount:i.orderData.technicianAmount,baseRate:i.orderData.baseRate,gnFlow:i.orderData.gnFlow,facilityId:i.orderData.facilityId,billStatus:0,gnServDesign:i.orderData.gnServDesign,payerCompSeqId:i.orderData.payerCompSeqId,payerCompPlanseqId:i.orderData.payerCompPlanseqId,appointReason:i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID,visitTypeCode:a,rowIndex:o,transType:i.orderData.transType,proposedShare:i.orderData.proposedShare,billedShare:i.orderData.billedShare,grpMstCode:i.orderData.grpMstCode?i.orderData.grpMstCode:void 0,deptCode:i.orderData.deptCode,specilityCode:i.orderData.specilityCode,priServTypCode:i.orderData.priServTypCode,isPostBillApplicable:i.orderData.isPostBillApplicable?scope.orderData.isPostBillApplicable:0}],i.RowsArr.unshift(i.rows),i.counter++;i.orderData.requestedByEmpName,sessionStorage.getItem("orderregSeqId"),sessionStorage.getItem("orderencounterSeqId");i.orderDetails.OPVMorderService="",i.orderDetails.price="",i.orderDetails.quantity=1,i.orderDetails.patamount="",i.orderDetails.payeramount="",i.priorityvis.priorityTypeModel="",i.priorityvis.visitTypeModel="",i.serviceTypeModel.serviceType="",2==i.orderData.gnServDesign&&i.showpackageServices(i.rows,i.rows.length-1),i.orderData.isRateEditable=2,T(function(){i.isServiceSelectedCovered=!1},2e3),i.showOrderErrors=!1,i.orderBtnDisable=!1,i.checkOrderSaved=!0},buttonCallBack2:function(){}};v.hisAlertMulti("warning","Confirmation","Service Already added.Do you really want to add the service ?",{buttonText:"YES",buttonText2:"NO"},p,close)}}},i.serviceTypeChange=function(e){if(!i.serviceTypeModel.serviceType){i.orderDetails.OPVMorderService="",i.orderDetails.price="",i.orderDetails.quantity=1,i.orderDetails.patamount="",i.orderDetails.payeramount="",i.priorityvis.priorityTypeModel="",i.priorityvis.visitTypeModel="",i.PriorityCombo=[],i.PriorityComboList={1:i.PriorityCombo};t=I.executeQueryURLReset();return i.priorityCombosList=new Array,I.prepareParamList(1,850,i.priorityCombosList),I.executeQueryInput("TRN003",i.priorityCombosList,i.PriorityComboList,!0,!0,t,"popUp",{}).then(function(e){i.PriorityComboList=e[1],i.priorityvis.priorityTypeModel=i.PriorityComboList[0],i.hidepriorityTypeComboRef=!0,i.hidevisitTypeComboRef=!1})}if(i.advserviceType=i.serviceTypeModel.serviceType,i.orderDetails.OPVMorderService="",i.orderDetails.price="",i.orderDetails.quantity=1,i.orderDetails.patamount="",i.orderDetails.payeramount="",i.loadAccountDetails(),1!=i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID){i.PriorityCombo=[],i.PriorityComboList={1:i.PriorityCombo};var t=I.executeQueryURLReset();return i.priorityCombosList=new Array,I.prepareParamList(1,850,i.priorityCombosList),I.executeQueryInput("TRN003",i.priorityCombosList,i.PriorityComboList,!0,!0,t,"popUp",{}).then(function(e){i.PriorityComboList=e[1],i.priorityvis.priorityTypeModel=i.PriorityComboList[0],i.hidepriorityTypeComboRef=!0,i.hidevisitTypeComboRef=!1})}sessionStorage.getItem("orderdoctSeqId"),sessionStorage.getItem("orderregSeqId");i.payerId,i.priorityvis.priorityTypeModel="",i.hidepriorityTypeComboRef=!1,i.hidevisitTypeComboRef=!0,i.priorityvis.visitTypeModel="New"},i.activeTab=function(e){return i.patientGlobalDtlsNew[0].visitNO||i.dynamicVisitNum||2!=e&&3!=e&&4!=e?i.isEmgOrTempPat&&5==e?(v.warning("Warning!","Patient has a Emergency registration, please convert into Permanent registration to proceed.",!1,!1,me.time),!1):(i.activeFirst=e,i.showOrderErrors=!1,5==e&&(le.opPreAuthClear(i),i.getAllPayerDetail(s.patientSeqId),i.getPatAllPayers(s.patientSeqId),i.reqFromOrder=!1,i.PA={},i.PA={fromDate:new Date,PAUnitDays:1},s.orderRowData=null),void(i.preAuthBillNav=!1)):(v.warning("Warning!","Please create or select a visit to proceed.",!1,!1,me.time),!1)},i.collectPayment=function(){$("#patientOutstandingModal").modal("hide"),i.activeFirst=3},i.openFileUpload=function(e){angular.element(document.querySelector("#"+e)).click()},i.saveUploadedFile=function(){if(s.convertedFile&&s.fileobj){var e=s.fileobj.name.split("."),t=s.convertedFile.split(",")[1],r=JSON.parse(sessionStorage.userContextObj),a=b("date")(new Date,"yyyy-MM-dd'T'HH:mm:ss'.000Z'");ae.uploadFileFun(s.fileobj,e[1],r,a,t,"",1).then(function(e){if(e.data.HITService.message.napierDocumentList[0]["com.napier.core.service.vo.uploadfile.NapierDocument"]){var t=e.data.HITService.message.napierDocumentList[0]["com.napier.core.service.vo.uploadfile.NapierDocument"];v.success("Success","Document added successfully",!1,!1,me.time),i.uplodedDocDetails={name:t.docName,docSeqId:t.docSeqId}}else v.warning("Warning","Failed to add Documnet",!1,!1,me.time)})}},i.captureUploadedImage=function(e,t){s.fileobj=e.files[0];var r=e.files[0],a=r.name.split("."),o=a[a.length-1],n=r.size;if(["jpg","JPG","png","PNG","jpeg","JPEG"].indexOf(o)>=0){if(n>i.allowedFileSize)return void v.warning("Warning!","File size can not be more than 5MB",!1,!1,me.time);angular.element(document.querySelector("#"+t))[0].defaultValue=s.fileobj.name,angular.element(document.querySelector("#"+t))[0].value=s.fileobj.name;var c=new FileReader;c.readAsDataURL(r),c.onload=function(){c.result&&(s.convertedFile=c.result,i.saveUploadedFile())}}else v.warning("Warning","The Document Type Isn't Supported",!1,!1,me.time)},i.OrderselectMatchDoctor=function(e,t,r,a,o){var s={};s.docID=e.DOCTID,s.DOCTNAME=e.DOCTNAME,s.SPECIALITY_CODE=e.SPECIALITY_CODE?e.SPECIALITY_CODE:void 0,i.orderData.requestedByEmpName=e.DOCTNAME,i.orderData.requestedByEmpSeqID=e.DOCTID,i.orderData.SPECIALITY_CODE=e.SPECIALITY_CODE?e.SPECIALITY_CODE:void 0,i.OrderDoctorChange(o,s)},i.OrderDoctorChange=function(e,t){var r=t.docID,a=t.SPECIALITY_CODE,o=sessionStorage.getItem("orderregSeqId"),n=sessionStorage.getItem("orderencounterSeqId");i.setCurrentTarrifId();var c=s.tariffSeqId,l=i.payerTypeModel.PayerType.PINS_SEQ_ID,p=i.orderData.quantity,d="";d=void 0!==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID?i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID:i.orderData.appointReason;var m="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,m=i.priorityvis.priorityTypeModel.DT_CODE):(i.priorityvis.visitTypeModel,m=i.orderDetails.visitTypeCode);var u=m;if(1!=d){i.addSelectServicepostEditArr=[];var S=new Date,y=moment(S).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";N.updateService.URL;var D=1;3==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID&&(D=2);var g=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.orderData.servSeqId,gnServDesign:D,servCode:i.orderData.servCode,servName:i.orderData.servName,secServTypeCode:i.orderData.servSeqId,priServTypCode:i.orderData.servSeqId},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.orderData.servSeqId,tariffSeqId:s.tariffSeqId,datedOn:y,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:i.orderData.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:JSON.parse(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:r,payerId:i.payerTypeModel.PayerType.PINS_SEQ_ID,fromOPVisit:"Y",priority:u}];i.addSelectServicepostEditArr.push(g);var A={};A.url=N.updateService.URL,A.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectServicepostEditArr}]}},P.sendRestRequest(A).then(function(e){i.addselectEdiresponse=e.data.HITService.message,""==i.addselectEdiresponse.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time);var t=i.addselectEdiresponse.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];i.orderData.serviceTypeCODE=t.primaryServiceCode,i.orderData.serviceType=t.primaryServiceCode,i.orderData.servCode=t.serviceVo.servCode,i.orderData.servName=t.serviceVo.servName,i.orderData.servSeqId=t.serviceVo.servSeqId,i.orderData.gnServDesign=t.serviceVo.gnServDesign,i.orderData.servicePayerAuthorization=t.servicePayerAuthorization,i.orderData.requestedByEmpName=t.requestedByEmpName,i.orderData.requestedByEmpSeqID=t.requestedByEmpSeqID,i.orderData.requestedByEmpType=t.requestedByEmpType,i.orderData.payerType=i.payerTypeModel.PayerType.PAYER_NAME,i.orderData.payerTypeCode=i.payerTypeModel.PayerType.PINS_SEQ_ID,i.orderData.insurancePlanSeqId=null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,i.orderData.actualRate=t.actualRate,i.orderData.quantity=t.quantity,i.orderData.isPostBillApplicable=t.isPostBillApplicable?t.isPostBillApplicable:0,i.orderData.patientAmount=t.patientAmount,i.orderData.payerAmount=t.payerAmount,i.orderData.originalPatientAmount=t.originalPatientAmount,i.orderData.originalPayerAmount=t.originalPayerAmount,i.orderData.discountAmt=t.discountAmt,i.orderData.doctorAmount=t.doctorAmount,i.orderData.doctorShare=t.doctorShare,i.orderData.doctorSurcharge=t.doctorSurcharge,i.orderData.hospitalShare=t.hospitalShare,i.orderData.hospitalSurcharge=t.hospitalSurcharge,i.orderData.isRateEditable=t.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,1==i.orderData.isRateEditable&&(i.orderData.minValue=null!=t.minVal?t.minVal:t.serviceVo.scmMasterServBillingAttrVo.minValue,i.orderData.maxValue=null!=t.maxVal?t.maxVal:t.serviceVo.scmMasterServBillingAttrVo.maxValue,i.orderData.fromTariffRate="R"),i.orderData.newRate=t.newRate,i.orderData.proposedShareAfterDiscount=t.proposedShareAfterDiscount,i.orderData.serviceRate=t.serviceRate,i.orderData.serviceRateStatus=t.serviceRateStatus,i.orderData.standardDoctorShare=t.standardDoctorShare,i.orderData.technicianAmount=t.technicianAmount,i.orderData.baseRate=t.serviceRateVo.baseRate,i.orderData.originalBaseRate=t.serviceRateVo.originalBaseRate?t.serviceRateVo.originalBaseRate:t.serviceRateVo.baseRate,i.orderData.gnFlow=t.gnFlow,i.orderData.facilityId=t.facilityId,i.orderData.billStatus=0,i.orderData.rcvSeqId=t.serviceRateVo.rcvSeqId,i.orderData.inflSeqId=t.serviceRateVo.inflSeqId,i.orderData.proposedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,i.orderData.billedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,i.orderData.grpMstCode=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,i.orderData.priServTypCode=t.secServiceCode,null!=t.serviceVo&&null!=t.serviceVo.atomicDetailsVo&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&(null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&(i.orderData.deptCode=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code),null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&(i.orderData.specilityCode=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code))})}else i.getOrderDetails(r,o,n,c,e,l,p,a)},i.AdvServiceselectRec=function(e){i.AdvServiceaddSelected(e)},i.setCurrentTarrifId=function(){i.payerTypeModel.PayerType&&(s.tariffSeqId=i.payerTypeModel.PayerType.TATRIFF_SEQ_ID?i.payerTypeModel.PayerType.TATRIFF_SEQ_ID:s.tariffSeqId)},i.OrderPayerChange=function(e,t){var r=i.orderData.requestedByEmpSeqID,a=sessionStorage.getItem("orderregSeqId"),o=sessionStorage.getItem("orderencounterSeqId");i.setCurrentTarrifId();var n=s.tariffSeqId,c=t.PayerType.PINS_SEQ_ID,l=i.orderDetails.quantity,p="";p=void 0!==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID?i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID:i.orderData.appointReason;var d="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,d=i.priorityvis.priorityTypeModel.DT_CODE):(i.priorityvis.visitTypeModel,d=i.orderDetails.visitTypeCode);var m=d;if(1!=p){i.addSelectServicepostEditArr=[];var u=new Date,S=moment(u).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";N.updateService.URL;var y=1;3==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID&&(y=2);var D=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.orderDetails.servSeqId,gnServDesign:y,servCode:i.orderDetails.servCode,servName:i.orderDetails.servName,secServTypeCode:i.orderDetails.servSeqId,priServTypCode:i.orderDetails.servSeqId},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.orderDetails.servSeqId,tariffSeqId:n,datedOn:S,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:i.orderDetails.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:r,payerId:c,fromOPVisit:"Y",priority:m,actualRate:i.orderDetails.price,serviceRate:i.orderDetails.price}];i.addSelectServicepostEditArr.push(D);var g={};g.url=N.updateService.URL,g.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectServicepostEditArr}]}},P.sendRestRequest(g).then(function(e){i.addselectEdiresponse=e.data.HITService.message,""==i.addselectEdiresponse.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time);var t=i.addselectEdiresponse.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];i.orderData.serviceTypeCODE=t.primaryServiceCode,i.orderData.serviceType=t.primaryServiceCode,i.orderData.servCode=t.serviceVo.servCode,i.orderData.servName=t.serviceVo.servName,i.orderData.servSeqId=t.serviceVo.servSeqId,i.orderData.gnServDesign=t.serviceVo.gnServDesign,i.orderData.servicePayerAuthorization=t.servicePayerAuthorization,i.orderData.requestedByEmpName=t.requestedByEmpName,i.orderData.requestedByEmpSeqID=t.requestedByEmpSeqID,i.orderData.requestedByEmpType=t.requestedByEmpType,i.orderData.payerType=i.payerTypeModel.PayerType.PAYER_NAME,i.orderData.payerTypeCode=i.payerTypeModel.PayerType.PINS_SEQ_ID,i.orderData.insurancePlanSeqId=null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,i.orderData.actualRate=i.orderData.isComingFromOPPharmacy?i.orderData.actualRate:t.actualRate,i.orderData.quantity=1,i.orderData.isPostBillApplicable=t.isPostBillApplicable?t.isPostBillApplicable:0,i.orderData.patientAmount=i.orderData.isComingFromOPPharmacy?i.orderData.patientAmount:t.patientAmount,i.orderData.payerAmount=i.orderData.isComingFromOPPharmacy?i.orderData.payerAmount:t.payerAmount,i.orderData.originalPatientAmount=i.orderData.isComingFromOPPharmacy?"Y"==t.servicePayerAuthorization?parseFloat(0):parseFloat(i.orderData.originalPatientAmount)>0&&parseFloat(i.orderData.originalPayerAmount)>0?i.orderData.originalPatientAmount:i.orderDetails.price:t.originalPatientAmount,i.orderData.originalPayerAmount=i.orderData.isComingFromOPPharmacy?"Y"==t.servicePayerAuthorization?parseFloat(i.orderData.originalPatientAmount)>0&&parseFloat(i.orderData.originalPayerAmount)>0?i.orderData.originalPayerAmount:i.orderDetails.price:parseFloat(0):t.originalPayerAmount,i.orderData.discountAmt=i.orderData.isComingFromOPPharmacy?i.orderData.discountAmt:t.discountAmt,i.orderData.doctorAmount=t.doctorAmount,i.orderData.doctorShare=t.doctorShare,i.orderData.doctorSurcharge=t.doctorSurcharge,i.orderData.hospitalShare=t.hospitalShare,i.orderData.hospitalSurcharge=t.hospitalSurcharge,i.orderData.isRateEditable=i.orderData.isComingFromOPPharmacy?3:t.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,1==i.orderData.isRateEditable&&(i.orderData.minValue=t.serviceVo.scmMasterServBillingAttrVo.minValue,i.orderData.maxValue=t.serviceVo.scmMasterServBillingAttrVo.maxValue,i.orderData.fromTariffRate="R"),i.orderData.newRate=i.orderData.isComingFromOPPharmacy?i.orderData.newRate:t.newRate,i.orderData.proposedShareAfterDiscount=t.proposedShareAfterDiscount,i.orderData.serviceRate=i.orderData.isComingFromOPPharmacy?i.orderData.serviceRate:t.serviceRate,i.orderData.serviceRateStatus=t.serviceRateStatus,i.orderData.standardDoctorShare=t.standardDoctorShare,i.orderData.technicianAmount=t.technicianAmount,i.orderData.baseRate=i.orderData.isComingFromOPPharmacy?i.orderData.baseRate:t.serviceRateVo.baseRate,i.orderData.originalBaseRate=i.orderData.isComingFromOPPharmacy?i.orderData.originalBaseRate:t.serviceRateVo.originalBaseRate,i.orderData.gnFlow=t.gnFlow,i.orderData.facilityId=t.facilityId,i.orderData.billStatus=0,i.orderData.payerCompSeqId=t.payerCompSeqId,i.orderData.payerCompPlanseqId=t.payerCompPlanseqId,i.orderDetails.price=i.orderData.isComingFromOPPharmacy?i.orderDetails.price:t.serviceRate,i.dummyPice=(i.orderData.isComingFromOPPharmacy?i.orderDetails.price:t.serviceRate)/i.orderDetails.quantity,i.dummyPatAmount=t.originalPatientAmount/i.orderDetails.quantity,i.dummyPyrAmount=t.originalPayerAmount/i.orderDetails.quantity,i.orderDetails.patamount=i.orderData.isComingFromOPPharmacy?"Y"==t.servicePayerAuthorization?parseFloat(0):i.orderDetails.price:t.originalPatientAmount,i.orderDetails.payeramount=i.orderData.isComingFromOPPharmacy?"Y"==t.servicePayerAuthorization?i.orderDetails.price:parseFloat(0):t.originalPayerAmount,i.dummyPyrAutherisation=t.servicePayerAuthorization,i.orderDetails.servCode=t.serviceVo.servCode,i.orderDetails.servName=t.serviceVo.servName,i.orderDetails.servSeqId=t.serviceVo.servSeqId,i.orderData.rcvSeqId=t.serviceRateVo.rcvSeqId,i.orderData.inflSeqId=t.serviceRateVo.inflSeqId,null!=t.multiEmployeeShareList&&""!==t.multiEmployeeShareList&&null!=t.multiEmployeeShareList.employeeShareList&&null!=t.multiEmployeeShareList.employeeShareList[0]&&(i.orderData.proposedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,i.orderData.billedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,i.orderData.grpMstCode=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0),i.orderData.priServTypCode=t.secServiceCode,null!=t.serviceVo&&null!=t.serviceVo.atomicDetailsVo&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&(null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&(i.orderData.deptCode=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code),null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&(i.orderData.specilityCode=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code))})}else i.getOrderDetails(r,a,o,n,e,c,l,null,i.orderData.servSeqId,i.orderData.servicePostingSeqId)},i.orderService=function(e){S.open("SEARCH SERVICE",{animation:!0,templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-order-service-popup.html",size:e,scope:i});i.AdvserviceGrid.data=[],i.advserviceTypeModel.serviceType=i.serviceTypeModel.serviceType,null!=i.advserviceTypeModel.serviceType&&null!=i.advserviceTypeModel.serviceType.CODE&&i.loadSecondaryServiceTypeCombo()},i.AdvserviceGrid.onRegisterApi=function(e){i.AdvserviceGridSearch=e},i.AdvServiceaddSelected=function(e,t){var r=new Date,a=moment(r).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";(C={}).url=N.updateService.URL;var o="";o=void 0!==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID?i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID:i.orderData.appointReason,i.advServiceGridselection=i.AdvserviceGridSearch.selection.getSelectedRows();var n="",c="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(n=i.priorityvis.priorityTypeModel.DETAIL_DESC,c=i.priorityvis.priorityTypeModel.DT_CODE):(n=i.priorityvis.visitTypeModel,c=i.orderDetails.visitTypeCode);var l=c;if(1!=o){var p=1;if(3==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID&&(p=2),i.addSelectServicepostArr=[],i.addSelectServicepostEditArr=[],i.setCurrentTarrifId(),"Service"==e){i.advServiceGridselection=i.AdvserviceGridSearch.selection.getSelectedRows();var d=0;if(!i.addRowStatus){d=1;var m=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.advServiceGridselection[0].SERV_SEQ_ID,gnServDesign:p,servCode:i.advServiceGridselection[0].SERV_CODE,servName:i.advServiceGridselection[0].SERV_NAME,secServTypeCode:i.advServiceGridselection[0].SSTCODE,priServTypCode:i.advServiceGridselection[0].CODE},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.advServiceGridselection[0].SERV_SEQ_ID,tariffSeqId:s.tariffSeqId,datedOn:a,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:i.orderDetails.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:i.visitDlsDoc.OPVMselectDoctor.DOCTID,payerId:i.payerTypeModel.PayerType.PINS_SEQ_ID,fromOPVisit:"Y",priority:l}];i.addSelectServicepostEditArr.push(m);var u={};u.url=N.updateService.URL,u.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectServicepostEditArr}]}},P.sendRestRequest(u).then(function(e){i.addselectEdiresponse=e.data.HITService.message,""==i.addselectEdiresponse.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time);var t=i.addselectEdiresponse.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];De=[];var r="",a="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(r=i.priorityvis.priorityTypeModel.DETAIL_DESC,a=i.priorityvis.priorityTypeModel.DT_CODE):(r=i.priorityvis.visitTypeModel,a=i.orderDetails.visitTypeCode);for(var o=[],n=(t.serviceVo.servSeqId,0);n<i.RowsArr.length;n++)o.push(i.RowsArr[n][0].servSeqId);s.editRowRecord[0].serviceTypeCODE=t.primaryServiceCode,s.editRowRecord[0].serviceType=t.primaryService,s.editRowRecord[0].servCode=t.serviceVo.servCode,s.editRowRecord[0].servName=t.serviceVo.servName,s.editRowRecord[0].servSeqId=t.serviceVo.servSeqId,s.editRowRecord[0].gnServDesign=t.serviceVo.gnServDesign,s.editRowRecord[0].servicePayerAuthorization=t.servicePayerAuthorization,s.editRowRecord[0].visistType=r,s.editRowRecord[0].visitTypeCode=a,s.editRowRecord[0].requestedByEmpName=t.requestedByEmpName,s.editRowRecord[0].requestedByEmpSeqID=t.requestedByEmpSeqID,s.editRowRecord[0].requestedByEmpType=t.requestedByEmpType,s.editRowRecord[0].payerType=i.payerTypeModel.PayerType.PAYER_NAME,s.editRowRecord[0].payerTypeCode=i.payerTypeModel.PayerType.PINS_SEQ_ID,s.editRowRecord[0].insurancePlanSeqId=null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,s.editRowRecord[0].actualRate=t.actualRate,s.editRowRecord[0].quantity=1,s.editRowRecord[0].isPostBillApplicable=t.isPostBillApplicable?t.isPostBillApplicable:0,s.editRowRecord[0].patientAmount=t.patientAmount,s.editRowRecord[0].payerAmount=t.payerAmount,s.editRowRecord[0].originalPatientAmount=t.originalPatientAmount,s.editRowRecord[0].originalPayerAmount=t.originalPayerAmount,s.editRowRecord[0].discountAmt=t.discountAmt,s.editRowRecord[0].doctorAmount=t.doctorAmount,s.editRowRecord[0].doctorShare=t.doctorShare,s.editRowRecord[0].doctorSurcharge=t.doctorSurcharge,s.editRowRecord[0].hospitalShare=t.hospitalShare,s.editRowRecord[0].hospitalSurcharge=t.hospitalSurcharge,s.editRowRecord[0].isRateEditable=t.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,1==s.editRowRecord[0].isRateEditable&&(s.editRowRecord[0].minValue=t.minVal?t.minVal:t.serviceRateVo.minValue,s.editRowRecord[0].maxValue=t.maxVal?t.maxVal:t.serviceRateVo.maxValue,s.editRowRecord[0].fromTariffRate="R"),s.editRowRecord[0].newRate=t.newRate,s.editRowRecord[0].proposedShareAfterDiscount=t.proposedShareAfterDiscount,s.editRowRecord[0].serviceRate=t.serviceRate,s.editRowRecord[0].serviceRateStatus=t.serviceRateStatus,s.editRowRecord[0].standardDoctorShare=t.standardDoctorShare,s.editRowRecord[0].technicianAmount=t.technicianAmount,s.editRowRecord[0].baseRate=t.baseRate,s.editRowRecord[0].gnFlow=t.gnFlow,s.editRowRecord[0].facilityId=t.facilityId,s.editRowRecord[0].payerCompSeqId=t.payerCompSeqId,s.editRowRecord[0].payerCompPlanseqId=t.payerCompPlanseqId,s.editRowRecord[0].appointReason=i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID,s.editRowRecord[0].rcvSeqId=t.serviceRateVo.rcvSeqId,s.editRowRecord[0].inflSeqId=t.serviceRateVo.inflSeqId,s.editRowRecord[0].proposedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,s.editRowRecord[0].billedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,s.editRowRecord[0].grpMstCode=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,s.editRowRecord[0].priServTypCode=t.secServiceCode,null!=t.serviceVo&&null!=t.serviceVo.atomicDetailsVo&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&(null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&(s.editRowRecord[0].deptCode=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code),null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&(s.editRowRecord[0].specilityCode=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code)),i.serviceTypeModel.serviceType="",i.orderDetails.OPVMorderService="",i.orderDetails.price="",i.orderDetails.quantity=1,i.orderDetails.patamount="",i.orderDetails.payeramount="",i.orderDetails.OPVMselectDoctor="",i.addRowStatus=!0})}for(var S=d;S<i.advServiceGridselection.length;S++){var y=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.advServiceGridselection[S].SERV_SEQ_ID,gnServDesign:p,servCode:i.advServiceGridselection[S].SERV_CODE,servName:i.advServiceGridselection[S].SERV_NAME,secServTypeCode:i.advServiceGridselection[S].SSTCODE,priServTypCode:i.advServiceGridselection[S].CODE},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.advServiceGridselection[S].SERV_SEQ_ID,tariffSeqId:s.tariffSeqId,datedOn:a,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:i.orderDetails.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:i.visitDlsDoc.OPVMselectDoctor.DOCTID,payerId:i.payerTypeModel.PayerType.PINS_SEQ_ID,fromOPVisit:"Y",priority:l}];i.addSelectServicepostArr.push(y)}}else if("Doctor"==e){y=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.tableRowData[0].serviceSeqId,gnServDesign:p,servCode:i.tableRowData[0].serviceCode,servName:i.tableRowData[0].serviceName,secServTypeCode:i.tableRowData[0].secServTypeCode,priServTypCode:i.tableRowData[0].serviceTypeCODE},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.tableRowData[0].serviceSeqId,tariffSeqId:s.tariffSeqId,datedOn:a,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:i.orderDetails.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:t.docID,payerId:i.payerTypeModel.PayerType.PINS_SEQ_ID,fromOPVisit:"Y",priority:l}];i.addSelectServicepostArr.push(y)}else{y=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.tableRowData[0].serviceSeqId,gnServDesign:p,servCode:i.tableRowData[0].serviceCode,servName:i.tableRowData[0].serviceName,secServTypeCode:i.tableRowData[0].secServTypeCode,priServTypCode:i.tableRowData[0].serviceTypeCODE},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.tableRowData[0].serviceSeqId,tariffSeqId:s.tariffSeqId,datedOn:a,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:i.orderDetails.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:i.visitDlsDoc.OPVMselectDoctor.DOCTID,payerId:t.PayerType.PINS_SEQ_ID,fromOPVisit:"Y",priority:l}];i.addSelectServicepostArr.push(y)}C.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectServicepostArr}]}},P.sendRestRequest(C).then(function(t){i.addselectresponse=t.data.HITService.message;var r=i.addselectresponse.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];i.addRowStatus&&""==i.addselectresponse.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time),De=[];var a="",o="";if(void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(a=i.priorityvis.priorityTypeModel.DETAIL_DESC,o=i.priorityvis.priorityTypeModel.DT_CODE):(a=i.priorityvis.visitTypeModel,o=i.orderDetails.visitTypeCode),r.length>0)for(var s=0;s<r.length;s++){if(r[s].serviceVo.servSeqId,i.RowsArr.length>0)for(var n=0;n<i.RowsArr.length;n++)De.push(i.RowsArr[n][0].servSeqId);i.rows=[{serviceTypeCODE:r[s].primaryServiceCode,serviceType:r[s].primaryService,servCode:r[s].serviceVo.servCode,servName:r[s].serviceVo.servName,servSeqId:r[s].serviceVo.servSeqId,gnServDesign:r[s].serviceVo.gnServDesign,servicePayerAuthorization:r[s].servicePayerAuthorization,visistType:a,visitTypeCode:o,requestedByEmpName:r[s].requestedByEmpName,requestedByEmpSeqID:r[s].requestedByEmpSeqID,requestedByEmpType:r[s].requestedByEmpType,payerType:i.payerTypeModel.PayerType.PAYER_NAME,insurancePlanSeqId:null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,payerTypeCode:i.payerTypeModel.PayerType.PINS_SEQ_ID,actualRate:r[s].actualRate,quantity:1,isPostBillApplicable:r[s].isPostBillApplicable?r[s].isPostBillApplicable:0,patientAmount:r[s].patientAmount,payerAmount:r[s].payerAmount,originalPatientAmount:r[s].originalPatientAmount,originalPayerAmount:r[s].originalPayerAmount,discountAmt:r[s].discountAmt,doctorAmount:r[s].doctorAmount,doctorShare:r[s].doctorShare,doctorSurcharge:r[s].doctorSurcharge,hospitalShare:r[s].hospitalShare,hospitalSurcharge:r[s].hospitalSurcharge,isRateEditable:r[s].serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,minValue:r[s].minVal?selectEditServices[s].minVal:r[s].serviceRateVo.minValue,maxValue:r[s].maxVal?selectEditServices[s].maxVal:r[s].serviceRateVo.maxValue,fromTariffRate:"R",newRate:r[s].newRate,proposedShareAfterDiscount:r[s].proposedShareAfterDiscount,serviceRate:r[s].serviceRate,serviceRateStatus:r[s].serviceRateStatus,standardDoctorShare:r[s].standardDoctorShare,technicianAmount:r[s].technicianAmount,baseRate:r[s].baseRate,gnFlow:r.gnFlow,facilityId:r[s].facilityId,billStatus:0,payerCompSeqId:r[s].payerCompSeqId,payerCompPlanseqId:r[s].payerCompPlanseqId,appointReason:i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID,rcvSeqId:r[s].serviceRateVo.rcvSeqId,inflSeqId:r[s].serviceRateVo.inflSeqId,transType:1,proposedShare:r[s].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,billedShare:r[s].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,grpMstCode:r[s].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?r[s].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,priServTypCode:r.secServiceCode,deptCode:null!=r.serviceVo&&null!=r.serviceVo.atomicDetailsVo&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code?r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code:void 0,specilityCode:null!=r.serviceVo&&null!=r.serviceVo.atomicDetailsVo&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code?r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code:void 0}],i.RowsArr.unshift(i.rows),i.orderBtnDisable=!1,i.counter++}else{if(r.serviceVo.servSeqId,i.RowsArr.length>0)for(n=0;n<i.RowsArr.length;n++)De.push(i.RowsArr[n][0].servSeqId);"Service"==e?(i.rows=[{serviceTypeCODE:r.primaryServiceCode,serviceType:r.primaryService,servCode:r.serviceVo.servCode,servName:r.serviceVo.servName,servSeqId:r.serviceVo.servSeqId,gnServDesign:r.serviceVo.gnServDesign,servicePayerAuthorization:r.servicePayerAuthorization,visistType:a,visitTypeCode:o,requestedByEmpName:r.requestedByEmpName,requestedByEmpSeqID:r.requestedByEmpSeqID,requestedByEmpType:r.requestedByEmpType,payerType:i.payerTypeModel.PayerType.PAYER_NAME,payerTypeCode:i.payerTypeModel.PayerType.PINS_SEQ_ID,insurancePlanSeqId:null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,actualRate:r.actualRate,quantity:1,patientAmount:r.patientAmount,payerAmount:r.payerAmount,originalPatientAmount:r.originalPatientAmount,originalPayerAmount:r.originalPayerAmount,discountAmt:r.discountAmt,doctorAmount:r.doctorAmount,doctorShare:r.doctorShare,doctorSurcharge:r.doctorSurcharge,hospitalShare:r.hospitalShare,hospitalSurcharge:r.hospitalSurcharge,isRateEditable:r.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,minValue:r.minVal?r.minVal:r.serviceRateVo.minValue,maxValue:r.maxVal?r.maxVal:r.serviceRateVo.maxValue,fromTariffRate:"R",newRate:r.newRate,proposedShareAfterDiscount:r.proposedShareAfterDiscount,serviceRate:r.serviceRate,serviceRateStatus:r.serviceRateStatus,standardDoctorShare:r.standardDoctorShare,technicianAmount:r.technicianAmount,baseRate:r.baseRate,gnFlow:r.gnFlow,facilityId:r.facilityId,billStatus:0,payerCompSeqId:r.payerCompSeqId,payerCompPlanseqId:r.payerCompPlanseqId,appointReason:i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID,rcvSeqId:r.serviceRateVo.rcvSeqId,inflSeqId:r.serviceRateVo.inflSeqId,transType:1,proposedShare:r.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,billedShare:r.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,grpMstCode:r.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?r.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,priServTypCode:r.secServiceCode,deptCode:null!=r.serviceVo&&null!=r.serviceVo.atomicDetailsVo&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code?r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code:void 0,specilityCode:null!=r.serviceVo&&null!=r.serviceVo.atomicDetailsVo&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code?r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code:void 0}],i.RowsArr.unshift(i.rows),i.orderBtnDisable=!1,i.counter++,3==i.advserviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID&&i.showpackageServices(i.rows,i.rows.length-1)):((r.serviceVo.servSeqId=i.tableRowData[0].servSeqId)&&i.RowsArr.splice(i.orderrowIndex,1),i.rows=[{serviceTypeCODE:r.primaryServiceCode,serviceType:r.primaryService,servCode:r.serviceVo.servCode,servName:r.serviceVo.servName,servSeqId:r.serviceVo.servSeqId,gnServDesign:r.serviceVo.gnServDesign,servicePayerAuthorization:r.servicePayerAuthorization,visistType:a,visitTypeCode:o,requestedByEmpName:r.requestedByEmpName,requestedByEmpSeqID:r.requestedByEmpSeqID,requestedByEmpType:r.requestedByEmpType,payerType:i.payerTypeModel.PayerType.PAYER_NAME,payerTypeCode:i.payerTypeModel.PayerType.PINS_SEQ_ID,insurancePlanSeqId:null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,actualRate:r.actualRate,quantity:1,patientAmount:r.patientAmount,payerAmount:r.payerAmount,originalPatientAmount:r.originalPatientAmount,originalPayerAmount:r.originalPayerAmount,discountAmt:r.discountAmt,doctorAmount:r.doctorAmount,doctorShare:r.doctorShare,doctorSurcharge:r.doctorSurcharge,hospitalShare:r.hospitalShare,hospitalSurcharge:r.hospitalSurcharge,isRateEditable:r.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,minValue:r.minVal?r.minVal:r.serviceRateVo.minValue,maxValue:r.maxVal?r.maxVal:r.serviceRateVo.maxValue,fromTariffRate:"R",newRate:r.newRate,proposedShareAfterDiscount:r.proposedShareAfterDiscount,serviceRate:r.serviceRate,serviceRateStatus:r.serviceRateStatus,standardDoctorShare:r.standardDoctorShare,technicianAmount:r.technicianAmount,baseRate:r.serviceRateVo.baseRate,gnFlow:r.gnFlow,facilityId:r.facilityId,billStatus:0,payerCompSeqId:r.payerCompSeqId,payerCompPlanseqId:r.payerCompPlanseqId,appointReason:i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID,rcvSeqId:r.serviceRateVo.rcvSeqId,inflSeqId:r.serviceRateVo.inflSeqId,transType:1,proposedShare:r.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,billedShare:r.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,grpMstCode:r.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?r.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,priServTypCode:r.secServiceCode,deptCode:null!=r.serviceVo&&null!=r.serviceVo.atomicDetailsVo&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code?r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code:void 0,specilityCode:null!=r.serviceVo&&null!=r.serviceVo.atomicDetailsVo&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code?r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code:void 0}],i.RowsArr.unshift(i.rows),i.orderBtnDisable=!1,i.counter++)}$.grep(i.RowsArr,function(e){return"N"==e[0].servicePayerAuthorization&&"self"!=e[0].payerType.toLocaleLowerCase()}).length>0?i.isServiceSelectedCovered=!0:i.isServiceSelectedCovered=!1,T(function(){i.isServiceSelectedCovered=!1},2e3)}),i.orderDetails.OPVMorderService="",i.orderDetails.price="",i.orderDetails.quantity=1,i.orderDetails.patamount="",i.orderDetails.payeramount=""}else{var D=i.orderData.requestedByEmpSeqID;if(i.visitDlsDoc&&i.visitDlsDoc.OPVMselectDoctor){D||(D=i.visitDlsDoc.OPVMselectDoctor.DOCTID);var g=i.visitDlsDoc.OPVMselectDoctor.SPECIALITY_CODE}var A=sessionStorage.getItem("orderregSeqId"),I=sessionStorage.getItem("orderencounterSeqId"),h=s.tariffSeqId,R=i.payerTypeModel.PayerType.PINS_SEQ_ID,f=i.orderDetails.quantity;n="",c="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(n=i.priorityvis.priorityTypeModel.DETAIL_DESC,c=i.priorityvis.priorityTypeModel.DT_CODE):(n=i.priorityvis.visitTypeModel,c=i.orderDetails.visitTypeCode);for(S=0;S<i.advServiceGridselection.length;S++){var C,b={"@class":"com.napier.core.service.vo.visitmanagement.VisitConfigurationDetails",doctorSeqId:D,tariffSeqId:h,regSeqId:A,enSeqId:I,payerId:R,quantity:f,serviceSeqId:i.advServiceGridselection[S].SERV_SEQ_ID,specialityCode:g||void 0};(C={}).url=N.updateService.URL,C.requestData={operation:"getConsultationServiceRate",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:b},P.sendRestRequest(C).then(function(e){i.serResponce=e.data.HITService.message,""==i.serResponce.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time);var t=i.serResponce.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];i.addRowStatus?(i.rows=[{serviceTypeCODE:t.primaryServiceCode,serviceType:t.primaryService,servCode:t.serviceVo.servCode,servName:t.serviceVo.servName,servSeqId:t.serviceVo.servSeqId,gnServDesign:1,servicePayerAuthorization:t.servicePayerAuthorization,visistType:n,visitTypeCode:c,requestedByEmpName:t.requestedByEmpName,requestedByEmpSeqID:t.requestedByEmpSeqID,requestedByEmpType:t.requestedByEmpType,payerType:i.payerTypeModel.PayerType.PAYER_NAME,payerTypeCode:i.payerTypeModel.PayerType.PINS_SEQ_ID,insurancePlanSeqId:null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,actualRate:t.actualRate,quantity:i.orderDetails.quantity,isPostBillApplicable:t.isPostBillApplicable?t.isPostBillApplicable:0,patientAmount:t.patientAmount,payerAmount:t.payerAmount,originalPatientAmount:t.originalPatientAmount,originalPayerAmount:t.originalPayerAmount,discountAmt:t.discountAmt,doctorAmount:t.doctorAmount,doctorShare:t.doctorShare,doctorSurcharge:t.doctorSurcharge,hospitalShare:t.hospitalShare,hospitalSurcharge:t.hospitalSurcharge,isRateEditable:t.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,minValue:t.minVal?t.minVal:t.serviceRateVo.minValue,maxValue:t.maxVal?t.maxVal:t.serviceRateVo.maxValue,fromTariffRate:"R",newRate:t.newRate,proposedShareAfterDiscount:t.proposedShareAfterDiscount,serviceRate:t.serviceRate,serviceRateStatus:t.serviceRateStatus,standardDoctorShare:t.standardDoctorShare,technicianAmount:t.technicianAmount,baseRate:t.baseRate,gnFlow:t.gnFlow,facilityId:t.facilityId,billStatus:0,payerCompSeqId:t.payerCompSeqId,payerCompPlanseqId:t.payerCompPlanseqId,appointReason:i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID,rcvSeqId:t.serviceRateVo.rcvSeqId,inflSeqId:t.serviceRateVo.inflSeqId,transType:1,proposedShare:t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,billedShare:t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,grpMstCode:t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,priServTypCode:t.serviceVo.secServTypeCode,deptCode:null!=t.serviceVo&&null!=t.serviceVo.atomicDetailsVo&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code?t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code:void 0,specilityCode:null!=t.serviceVo&&null!=t.serviceVo.atomicDetailsVo&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code?t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code:void 0}],i.RowsArr.unshift(i.rows),i.orderBtnDisable=!1):(s.editRowRecord[0].serviceTypeCODE=t.primaryServiceCode,s.editRowRecord[0].serviceType=t.primaryService,s.editRowRecord[0].servCode=t.serviceVo.servCode,s.editRowRecord[0].servName=t.serviceVo.servName,s.editRowRecord[0].servSeqId=t.serviceVo.servSeqId,s.editRowRecord[0].gnServDesign=1,s.editRowRecord[0].servicePayerAuthorization=t.servicePayerAuthorization,s.editRowRecord[0].visistType=n,s.editRowRecord[0].visitTypeCode=c,s.editRowRecord[0].requestedByEmpName=t.requestedByEmpName,s.editRowRecord[0].requestedByEmpSeqID=t.requestedByEmpSeqID,s.editRowRecord[0].requestedByEmpType=t.requestedByEmpType,s.editRowRecord[0].payerType=i.payerTypeModel.PayerType.PAYER_NAME,s.editRowRecord[0].payerTypeCode=i.payerTypeModel.PayerType.PINS_SEQ_ID,s.editRowRecord[0].insurancePlanSeqId=null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,s.editRowRecord[0].actualRate=t.actualRate,s.editRowRecord[0].quantity=i.orderDetails.quantity,s.editRowRecord[0].isPostBillApplicable=t.isPostBillApplicable?t.isPostBillApplicable:0,s.editRowRecord[0].patientAmount=t.patientAmount,s.editRowRecord[0].payerAmount=t.payerAmount,s.editRowRecord[0].originalPatientAmount=t.originalPatientAmount,s.editRowRecord[0].originalPayerAmount=t.originalPayerAmount,s.editRowRecord[0].discountAmt=t.discountAmt,s.editRowRecord[0].doctorAmount=t.doctorAmount,s.editRowRecord[0].doctorShare=t.doctorShare,s.editRowRecord[0].doctorSurcharge=t.doctorSurcharge,s.editRowRecord[0].hospitalShare=t.hospitalShare,s.editRowRecord[0].hospitalSurcharge=t.hospitalSurcharge,s.editRowRecord[0].isRateEditable=t.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,1==s.editRowRecord[0].isRateEditable&&(s.editRowRecord[0].minValue=t.serviceRateVo.minValue,s.editRowRecord[0].maxValue=t.serviceRateVo.maxValue,s.editRowRecord[0].fromTariffRate="R"),s.editRowRecord[0].newRate=t.newRate,s.editRowRecord[0].proposedShareAfterDiscount=t.proposedShareAfterDiscount,s.editRowRecord[0].serviceRate=t.serviceRate,s.editRowRecord[0].serviceRateStatus=t.serviceRateStatus,s.editRowRecord[0].standardDoctorShare=t.standardDoctorShare,s.editRowRecord[0].technicianAmount=t.technicianAmount,s.editRowRecord[0].baseRate=t.baseRate,s.editRowRecord[0].gnFlow=t.gnFlow,s.editRowRecord[0].facilityId=t.facilityId,s.editRowRecord[0].payerCompSeqId=t.payerCompSeqId,s.editRowRecord[0].payerCompPlanseqId=t.payerCompPlanseqId,s.editRowRecord[0].appointReason=i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID,s.editRowRecord[0].rcvSeqId=t.serviceRateVo.rcvSeqId,s.editRowRecord[0].inflSeqId=t.serviceRateVo.inflSeqId,s.editRowRecord[0].proposedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,s.editRowRecord[0].billedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,s.editRowRecord[0].grpMstCode=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0),i.serviceTypeModel.serviceType="",i.orderDetails.OPVMorderService="",i.orderDetails.price="",i.orderDetails.quantity=1,i.orderDetails.patamount="",i.orderDetails.payeramount="","HSC"===sessionStorage.productCustomization&&(i.checkOrderSaved=!0),le.opPreAuthGetData(i)})}}E.dismissAll()},i.editOrderRecords=function(e,t,r){var a={},o={},n={},c={};i.orderrowIndex=e,i.payerTypeModel.PayerType="";for(var l=0;l<i.RowsArr.length;l++)l==e&&(i.tableRowData=i.RowsArr[e]);var p={};p.url=N.updateService.URL,p.requestData={operation:"checkOrderCancel",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.master.vo.ServiceListVo",serviceList:[{"com.napier.core.scm.master.vo.ServiceVo":[{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:r[0].servicePostingSeqId,servDesc:r[0].servName,gnServDesign:null!=i.tableRowData[0].appointReason?i.tableRowData[0].appointReason:2}]}]}},P.sendRestRequest(p).then(function(e){if(""==e.data.HITService.message.serviceList[0]||r[0].isComingFromOPPharmacy){if(a.CODE=i.tableRowData[0].serviceTypeCODE,a.DESCRIPTION=i.tableRowData[0].serviceType,o.DT_CODE=i.tableRowData[0].addvisitCode,o.DETAIL_DESC=i.tableRowData[0].visistType,n.PINS_SEQ_ID=i.tableRowData[0].payerTypeCode,n.PAYER_NAME=i.tableRowData[0].payerType,n.TATRIFF_SEQ_ID=i.tableRowData[0].payerTarrifId?i.tableRowData[0].payerTarrifId:void 0,n.PLAN_SEQ_ID=i.tableRowData[0].insurancePlanSeqId,c.DOCTNAME=i.tableRowData[0].requestedByEmpName,c.DOCTID=i.tableRowData[0].requestedByEmpSeqID,i.OPVMDoctorSearchTypeAhead(c.DOCTNAME,!1,!0),i.serviceTypeModel.serviceType=a,i.orderDetails.OPVMorderService=i.tableRowData[0].servName,i.payerTypeModel={PayerType:n},i.orderData.doctorAmount=i.tableRowData[0].doctorAmount,i.orderData.doctorShare=i.tableRowData[0].doctorShare,i.orderData.doctorSurcharge=i.tableRowData[0].doctorSurcharge,i.orderData.hospitalShare=i.tableRowData[0].hospitalShare,i.orderData.hospitalSurcharge=i.tableRowData[0].hospitalSurcharge,i.orderData.transType=i.tableRowData[0].transType,i.orderDetails.price=i.tableRowData[0].serviceRate,i.orderDetails.isPharmacyService=i.tableRowData[0].isPharmacyService,i.dummyPice=i.tableRowData[0].serviceRate,i.dummyPatAmount=i.tableRowData[0].originalPatientAmount,i.dummyPyrAmount=i.tableRowData[0].originalPayerAmount,i.orderDetails.quantity=i.tableRowData[0].quantity,i.orderDetails.patamount=i.tableRowData[0].originalPatientAmount,i.orderDetails.payeramount=i.tableRowData[0].originalPayerAmount,i.dummyPyrAutherisation=i.tableRowData[0].servicePayerAuthorization,i.orderDetails.servCode=i.tableRowData[0].servCode,i.orderDetails.servName=i.tableRowData[0].servName,i.orderDetails.servSeqId=i.tableRowData[0].servSeqId,i.orderData.servCode=i.tableRowData[0].servCode,i.orderData.servName=i.tableRowData[0].servName,i.orderData.servSeqId=i.tableRowData[0].servSeqId,i.orderData.patientAmount=i.tableRowData[0].originalPatientAmount,i.orderData.payerAmount=i.tableRowData[0].originalPayerAmount,i.orderData.originalPatientAmount=i.tableRowData[0].originalPatientAmount,i.orderData.originalPayerAmount=i.tableRowData[0].originalPayerAmount,i.orderData.serviceRate=i.tableRowData[0].serviceRate,i.orderData.baseRate=i.tableRowData[0].baseRate,i.orderData.actualRate=i.tableRowData[0].actualRate,i.orderData.discountAmt=i.tableRowData[0].discountAmt,i.orderData.doctorAmount=i.tableRowData[0].doctorAmount,i.orderData.doctorShare=i.tableRowData[0].doctorShare,i.orderData.appointReason=i.tableRowData[0].appointReason,i.orderData.gnServDesign=i.tableRowData[0].gnServDesign,i.orderData.servicePostingSeqId=i.tableRowData[0].servicePostingSeqId?i.tableRowData[0].servicePostingSeqId:void 0,i.addRowStatus=!1,s.editRowRecord=r,i.orderData.isRateEditable=r[0].isComingFromOPPharmacy?3:i.tableRowData[0].isRateEditable,i.orderData.isComingFromOPPharmacy=r[0].isComingFromOPPharmacy,1==i.tableRowData[0].isRateEditable&&(i.orderData.minValue=i.tableRowData[0].minValue,i.orderData.maxValue=i.tableRowData[0].maxValue,i.orderData.fromTariffRate=i.tableRowData[0].fromTariffRate),1!=i.tableRowData[0].appointReason){i.hidepriorityTypeComboRef=!0,i.hidevisitTypeComboRef=!1,i.PriorityCombo=[],i.PriorityComboList={1:i.PriorityCombo};var t=I.executeQueryURLReset();return i.priorityCombosList=new Array,I.prepareParamList(1,850,i.priorityCombosList),I.executeQueryInput("TRN003",i.priorityCombosList,i.PriorityComboList,!0,!0,t,"popUp",{}).then(function(e){i.PriorityComboList=e[1];for(var t=0;t<i.PriorityComboList.length;t++)i.PriorityComboList[t].DT_CODE==i.tableRowData[0].visitTypeCode&&(i.priorityvis.priorityTypeModel=i.PriorityComboList[t])})}i.hidepriorityTypeComboRef=!1,i.hidevisitTypeComboRef=!0,i.priorityvis.visitTypeModel=i.tableRowData[0].visistType}else v.warning("Warning!","We Can't Edit this Service",!1,!1,me.time)})},i.getMinAndMaxRates=function(e,t,r){i.rateData=[],i.rateDataList={1:i.rateData};var a="SERVICE="+r,o=I.executeQueryURLReset();return i.rateDataDetails=new Array,I.prepareParamListWithParam("pTariffCode",t,i.rateDataDetails),I.prepareParamListWithParam("pServSeqId",e,i.rateDataDetails),I.prepareParamListWithParam("pRuleWithDesc",a,i.rateDataDetails),I.executeQueryInput("MMACODE_INFL_RATES",i.rateDataDetails,i.rateDataList,!0,!0,o,"popUp",i.advSearch).then(function(e){var t=e[1];t[0]&&(i.orderData.minValue=t[0].MIN_VALUE,i.orderData.maxValue=t[0].MAX_VALUE)})},i.setReceivedFrom=function(e){switch(e){case 1:i.paym.Amt=i.gbcal.patientPendAmnt,i.paym.ReceiveFrom="Self",i.calRoundOffs();break;case 2:i.paym.Amt=i.gbcal.payerPendAmnt,i.paym.ReceiveFrom=i.payerDetails[0].payerName,i.calRoundOffs();break;case 3:i.gbBillNo&&"Unbilled"==i.gbBillNo.billno?i.paym.Amt=i.gbcal.patientPendAmnt:i.paym.Amt="",i.paym.ReceiveFrom="Self";break;default:i.paym.Amt="",i.paym.ReceiveFrom="Self"}},i.addRowStatus=!0,i.packageServicesArrayObejct=[],s.selectedPreServices=[],i.pSevDocList=[],i.pSevDocComboList={1:i.pSevDocList};var Re=I.executeQueryURLReset();i.refpSevDocList=new Array,I.prepareParamListWithParam("pSpecializationId","",i.refpSevDocList),I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.refpSevDocList),I.prepareParamListWithParam("pDoctorId","",i.refpSevDocList),I.prepareParamListWithParam("pDoctorName","",i.refpSevDocList),I.executeQueryInput("OP_DOCTOR_ADVANCE_SEARCH",i.refpSevDocList,i.pSevDocComboList,!0,!0,Re,"popUp"),i.changeRatesBasedonPriceEdit=function(e,t){var r=new Date,a=moment(r).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";N.updateService.URL;var o=1;3==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID&&(o=2);var n="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,n=i.priorityvis.priorityTypeModel.DT_CODE):(i.priorityvis.visitTypeModel,n=i.orderDetails.visitTypeCode);var c=n;i.setCurrentTarrifId(),i.addSelectServiceTypeArr=[];var l=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.orderDetails.servSeqId,gnServDesign:o,servCode:i.orderDetails.servCode,servName:i.orderDetails.servName,secServTypeCode:i.orderDetails.servSeqId,priServTypCode:i.orderDetails.servSeqId},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.orderDetails.servSeqId,tariffSeqId:s.tariffSeqId,datedOn:a,fromOPVisit:"Y",doctSeqId:i.orderData.requestedByEmpSeqID,specSeqId:i.orderData.SPECIALITY_CODE?i.orderData.SPECIALITY_CODE:i.visitDlsDoc.OPVMselectDoctor.SPECIALITY_CODE},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:i.orderData.transType,quantity:i.orderDetails.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,isRateEditable:1,newRate:e,doctorModifiedAmount:2==i.orderData.transType?i.orderData.doctorModifiedAmount:0,updateServicePostingFlag:!1,requestedByEmpType:4,requestedByEmpSeqID:i.visitDlsDoc.OPVMselectDoctor.DOCTID,payerId:i.payerTypeModel.PayerType.PINS_SEQ_ID,fromOPVisit:"Y",priority:c}];i.addSelectServiceTypeArr.push(l);var p={};p.url=N.updateService.URL,p.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectServiceTypeArr}]}},P.sendRestRequest(p).then(function(e){i.isPriceEditResponce=e.data.HITService.message;var r=i.isPriceEditResponce.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];i.orderDetails.price=r.serviceRateVo.baseRate,null!=i.orderDetails.payeramount&&i.orderDetails.payeramount>0&&(i.orderDetails.price>i.orderDetails.payeramount?(r.originalPatientAmount=parseFloat(i.orderDetails.price)-i.orderDetails.payeramount,r.originalPayerAmount=i.orderDetails.payeramount):(r.originalPatientAmount=0,r.originalPayerAmount=parseFloat(i.orderDetails.price))),i.orderDetails.patamount=r.originalPatientAmount,i.orderDetails.payeramount=r.originalPayerAmount,i.dummyPice=r.serviceRateVo.baseRate,i.dummyPatAmount=r.originalPatientAmount,i.dummyPyrAmount=r.originalPayerAmount,i.orderData.newRate=r.newRate,i.orderData.patientAmount=r.patientAmount,i.orderData.payerAmount=r.payerAmount,i.orderData.originalPatientAmount=r.originalPatientAmount,i.orderData.originalPayerAmount=r.originalPayerAmount,i.orderData.serviceRate=r.serviceRate,i.orderData.rcvSeqId=r.serviceRateVo.rcvSeqId,i.orderData.inflSeqId=r.serviceRateVo.inflSeqId,t||(i.orderData.proposedShare=r.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,i.orderData.billedShare=r.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,i.orderData.hospitalShare=r.hospitalShare),i.orderData.grpMstCode=r.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?r.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,i.orderData.isPostBillApplicable=r.isPostBillApplicable,i.orderData.discountAmt=r.discountAmt,i.orderData.doctorAmount=r.doctorAmount,i.orderData.doctorShare=r.doctorShare,i.orderData.doctorSurcharge=r.doctorSurcharge,i.orderData.hospitalSurcharge=r.hospitalSurcharge,i.orderData.minValue=r.minVal,i.orderData.maxValue=r.maxVal,i.orderData.isRateEditable=r.isRateEditable,i.orderData.fromTariffRate="R",i.orderData.actualRate=r.actualRate,i.orderData.baseRate=r.baseRate,i.orderData.priServTypCode=r.secServiceCode,null!=r.serviceVo&&null!=r.serviceVo.atomicDetailsVo&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&(null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&(i.orderData.deptCode=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code),null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&(i.orderData.specilityCode=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code))})},i.checkAllRows=function(e){for(var t=0;t<i.RowsArr.length;t++)1==e?1!=i.RowsArr[t][0].billStatus&&(i.RowsArr[t][0].isComingFromOPPharmacy||3==i.RowsArr[t][0].servicePostingType||(i.RowsArr[t][0].checkrowforCancel=!0,i.cancelButtonEna=1)):(i.RowsArr[t][0].checkrowforCancel=!1,i.cancelButtonEna=2)},s.cancelSerIndex=[],i.cancelRecords=function(e,t){if("Pharmacy Retruns"!=e.isPharmacyService){i.cancelButtonEna=0;for(var r=0;r<i.RowsArr.length;r++)1==i.RowsArr[r][0].checkrowforCancel&&(i.cancelButtonEna=1)}else e.checkrowforCancel=!1},i.confirmCancelOrder=function(e,t){var r={};r.url=N.updateService.URL,r.requestData={operation:"cancelServicePosting",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":e}]}},P.sendRestRequest(r).then(function(e){if(s.cancelSerIndex=null,i.cancelButtonEna=0,i.loadBillNumbers(s.mrNo),"Y"==i.integrationApplicableFlag){var t=e.data.HITService.message.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"],r="";if(Array.isArray(t))for(var a=0;a<t.length;a++)r=0==a?t[a].servicePostingSeqId:r+","+t[a].servicePostingSeqId;else r=t.servicePostingSeqId;Array.isArray(t)||(t[0]=t);var o=sessionStorage.getItem("orderregSeqId");re.prepareOrderObject(r,t,o,"Admission","sendOrderFinalizedReportForRis","com.napier.his.integration.service.external.RisService",re).then(function(e){})}});for(var a=0,o=0;o<i.RowsArr.length;o++)if(1==i.RowsArr[o][0].checkrowforCancel)if(i.RowsArr[o][0].servicePostingSeqId)i.RowsArr[o][0].servicePostingType=3,i.RowsArr[o][0].servicePostingCacelReason=t,i.RowsArr[o][0].checkrowforCancel=!1,1!=i.RowsArr[o][0].billStatus&&(a=1);else{i.RowsArr.splice(o,1);o=-1}for(var n=0;n<i.RowsArr.length;n++)1!=i.RowsArr[n][0].billStatus&&(a=1);i.orderBtnDisable=0==a,i.showOrderCanLoadingIcon=!1},i.cancelMultipleOrder=function(e){for(var t=0,r=0;r<i.RowsArr.length;r++)1==i.RowsArr[r][0].checkrowforCancel&&(t=1);if(1==t){var a="Do you really want to delete the service ?",o={buttonText:"YES",buttonText2:"NO"},s={buttonCallBack1:function(e){i.showOrderCanLoadingIcon=!0;for(var t=[],r=[],a=0;a<i.RowsArr.length;a++)""!=i.RowsArr[a][0].servicePostingSeqId&&1==i.RowsArr[a][0].checkrowforCancel&&(t.push({"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",servicePostingSeqId:i.RowsArr[a][0].servicePostingSeqId,encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},servicePostingCacelReason:i.projSpecApplicable?e:"",cancelRequestedBy:i.projSpecApplicable?JSON.parse(sessionStorage.userContextObj).USER_SEQ_ID:void 0}),r.push({"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.RowsArr[a][0].servicePostingSeqId,servDesc:i.RowsArr[a][0].servName,gnServDesign:null!=i.RowsArr[a][0].appointReason?i.RowsArr[a][0].appointReason:2}));var o={};o.url=N.updateService.URL,o.requestData={operation:"checkOrderCancel",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.master.vo.ServiceListVo",serviceList:[{"com.napier.core.scm.master.vo.ServiceVo":r}]}},P.sendRestRequest(o).then(function(r){if(""==r.data.HITService.message.serviceList[0])i.confirmCancelOrder(t,e);else{var a=r.data.HITService.message.serviceList[0]["com.napier.core.scm.master.vo.ServiceVo"],o=[],s="";void 0!==a.length?s=a:(o.push(a),s=o);for(var n="",c=0;c<s.length;c++)n=s[c].servDesc+","+n;v.warning("Warning!","We Can't Delete the Following Services "+n),i.showOrderCanLoadingIcon=!1}})},buttonCallBack2:function(){}};1==i.projSpecApplicable?v.captureInfromation("capture","Confirmation",a,o,s,close):v.hisAlertMulti("warning","Confirmation",a,o,s,close)}},i.getPrescptionCount=function(){var e={};e.url=N.updateService.URL,e.requestData={operation:"getTotalOPPrescriptionList",messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.OPPrescriptionVo",regSeqId:sessionStorage.getItem("orderregSeqId"),enSeqId:sessionStorage.getItem("orderencounterSeqId")}},P.sendRestRequest(e).then(function(e){i.prescriptionCount=e.data.HITService.message,i.checkVisitUnOrderdServices()})},i.prescriptionCount=0,i.priarityChangeType=function(e,t,r,a,o){if(i.serviceTypeModel.serviceType=e,1!=i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID){i.PriorityCombo=[],i.PriorityComboList={1:i.PriorityCombo};var s=I.executeQueryURLReset();return i.priorityCombosList=new Array,I.prepareParamList(1,850,i.priorityCombosList),I.executeQueryInput("TRN003",i.priorityCombosList,i.PriorityComboList,!0,!0,s,"popUp",{}).then(function(s){i.PriorityComboList=s[1],i.priorityvis.priorityTypeModel=i.PriorityComboList[0],i.hidepriorityTypeComboRef=!0,i.hidevisitTypeComboRef=!1,i.loadRatesForService(e,t,r,a,o)})}sessionStorage.getItem("orderdoctSeqId"),sessionStorage.getItem("orderregSeqId");i.payerId,i.priorityvis.priorityTypeModel="",i.hidepriorityTypeComboRef=!1,i.hidevisitTypeComboRef=!0,i.priorityvis.visitTypeModel="New",i.loadRatesForService(e,t,r,a,o)},i.selectOrderMatchDoctor=function(e,t,r,a,o){i.serviceTypeModel.serviceType?i.loadRatesForService(e,t,r,a,o):(i.serviceTypeModel.serviceType={CODE:e.CODE,DESCRIPTION:e.DESCRIPTION,NH_OP_REASON_SEQ_ID:e.NH_OP_REASON_SEQ_ID},i.priarityChangeType(e,t,r,a,o))},i.preAuthRcdList=[],i.preAuthHdrRcdList={},i.loadRatesForService=function(e,t,r,a,o){var n=new Date,c=moment(n).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";(f={}).url=N.updateService.URL;var l=1;3==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID&&(l=2),i.addSelectServiceTypeArr=[];var p="";p=void 0!==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID?i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID:i.orderData.appointReason;var d="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,d=i.priorityvis.priorityTypeModel.DT_CODE):(i.priorityvis.visitTypeModel,d=i.orderDetails.visitTypeCode);var m=d;if(i.setCurrentTarrifId(),1!=p){var u=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:e.SERV_SEQ_ID,gnServDesign:l,servCode:e.SERV_CODE,servName:e.SERV_NAME,secServTypeCode:e.CODE,priServTypCode:e.CODE},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:e.SERV_SEQ_ID,tariffSeqId:s.tariffSeqId,datedOn:c,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},isEmergency:2,transType:1,quantity:i.orderDetails.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:i.visitDlsDoc.OPVMselectDoctor.DOCTID,payerId:i.payerTypeModel.PayerType.PINS_SEQ_ID,fromOPVisit:"Y",priority:m}];i.addSelectServiceTypeArr.push(u);var S={};S.url=N.updateService.URL,S.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectServiceTypeArr}]}},P.sendRestRequest(S).then(function(t){i.addselectTyperesponse=t.data.HITService.message,""==i.addselectTyperesponse.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time);var r,a=i.addselectTyperesponse.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel&&null!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DT_CODE,r=i.priorityvis.priorityTypeModel.DETAIL_DESC):r=i.priorityvis.visitTypeModel;for(var o=[],s=(e.SERV_SEQ_ID,0);s<i.RowsArr.length;s++)o.push(i.RowsArr[s][0].servSeqId);i.orderDetails.OPVMorderService=a.serviceVo.servName,i.orderDetails.OPVMselectDoctor=a.requestedByEmpName,i.priorityvis.visitTypeModel=r,i.orderDetails.price=a.serviceRateVo.baseRate,i.orderDetails.quantity=a.quantity,i.orderDetails.patamount=a.originalPatientAmount,i.orderDetails.payeramount=a.originalPayerAmount,i.dummyPice=a.serviceRateVo.baseRate,i.dummyPatAmount=a.originalPatientAmount,i.dummyPyrAmount=a.originalPayerAmount;var n={accSeqId:a.accSeqId,actualRate:a.actualRate,discountAmt:a.discountAmt,doctorAmount:a.doctorAmount,doctorShare:a.doctorShare,doctorSurcharge:a.doctorSurcharge,facilityId:a.facilityId,gnFlow:a.gnFlow,hospitalShare:a.hospitalShare,hospitalSurcharge:a.hospitalSurcharge,isDeleteBill:a.isDeleteBill,isDepositRequired:a.isDepositRequired,isEmergencyAllowedCheck:a.isEmergencyAllowedCheck,isMLCFlag:a.isMLCFlag,isRateEditable:a.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,minValue:a.minVal?a.minVal:a.serviceRateVo.minValue,maxValue:a.maxVal?a.maxVal:a.serviceRateVo.maxValue,fromTariffRate:"R",newRate:a.newRate,patientAmount:a.patientAmount,payerAmount:a.payerAmount,originalPatientAmount:a.originalPatientAmount,originalPayerAmount:a.originalPayerAmount,servicePayerAuthorization:a.servicePayerAuthorization,practiceId:a.practiceId,proposedShareAfterDiscount:a.proposedShareAfterDiscount,requestedByEmpName:a.requestedByEmpName,requestedByEmpSeqID:a.requestedByEmpSeqID,requestedByEmpType:a.requestedByEmpType,servicePostingType:a.servicePostingType,serviceRate:a.serviceRate,serviceRateStatus:a.serviceRateStatus,serviceType:a.serviceType,standardDoctorShare:a.standardDoctorShare,subAccSeqId:a.subAccSeqId,technicianAmount:a.technicianAmount,transType:a.transType,servCode:a.serviceVo.servCode,servDesign:a.serviceVo.servDesign,servName:a.serviceVo.servName,servSeqId:a.serviceVo.servSeqId,visistType:a.serviceRateVo.visistType,baseRate:a.serviceRateVo.baseRate,originalBaseRate:a.serviceRateVo.originalBaseRate?a.serviceRateVo.originalBaseRate:a.serviceRateVo.baseRate,gnServDesign:a.serviceVo.gnServDesign,payerCompSeqId:a.payerCompSeqId,payerCompPlanseqId:a.payerCompPlanseqId,serviceTypeCode:a.primaryServiceCode,isPostBillApplicable:a.isPostBillApplicable?a.isPostBillApplicable:0};i.orderData=n,i.orderData.servCode=a.serviceVo.servCode,i.orderData.servName=a.serviceVo.servName,i.orderData.servSeqId=a.serviceVo.servSeqId,i.orderDetails.servCode=a.serviceVo.servCode,i.orderDetails.servName=a.serviceVo.servName,i.orderDetails.servSeqId=a.serviceVo.servSeqId,i.orderData.rcvSeqId=a.serviceRateVo.rcvSeqId,i.orderData.inflSeqId=a.serviceRateVo.inflSeqId,i.orderData.proposedShare=a.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,i.orderData.billedShare=a.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,i.orderData.grpMstCode=a.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?a.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,i.orderData.priServTypCode=a.secServiceCode,null!=a.serviceVo&&null!=a.serviceVo.atomicDetailsVo&&null!=a.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=a.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=a.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&(null!=a.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&(i.orderData.deptCode=a.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code),null!=a.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=a.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=a.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&(i.orderData.specilityCode=a.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code))})}else{var y=i.orderData.requestedByEmpSeqID;if(i.visitDlsDoc&&i.visitDlsDoc.OPVMselectDoctor){y||(y=i.visitDlsDoc.OPVMselectDoctor.DOCTID);var D=i.visitDlsDoc.OPVMselectDoctor.SPECIALITY_CODE}var g=sessionStorage.getItem("orderregSeqId"),A=sessionStorage.getItem("orderencounterSeqId"),I=s.tariffSeqId,h=i.payerTypeModel.PayerType.PINS_SEQ_ID,R=i.orderDetails.quantity;d="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,d=i.priorityvis.priorityTypeModel.DT_CODE):(i.priorityvis.visitTypeModel,d=i.orderDetails.visitTypeCode);var f,T={"@class":"com.napier.core.service.vo.visitmanagement.VisitConfigurationDetails",doctorSeqId:y,tariffSeqId:I,regSeqId:g,enSeqId:A,payerId:h,quantity:R,serviceSeqId:e.SERV_SEQ_ID,specialityCode:D||void 0};(f={}).url=N.updateService.URL,f.requestData={operation:"getConsultationServiceRate",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:T},P.sendRestRequest(f).then(function(e){if(i.serResponce=e.data.HITService.message,"HSC"==sessionStorage.productCustomization){var t=e.data.HITService.message.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"].serviceRateVo;i.orderData.isRateEditable=t.isRateEditable,i.orderData.minValue=t.minValue,i.orderData.maxValue=t.maxValue,i.orderData.fromTariffRate="R",i.serviceName=e.data.HITService.message.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"].serviceVo.servName}""==i.serResponce.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time);var r,a=i.serResponce.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];i.orderDetails.OPVMorderService=a.serviceVo.servName,i.orderDetails.OPVMselectDoctor=a.requestedByEmpName,32==a.serviceRateVo.visistType?r="New":33==a.serviceRateVo.visistType?r="Free Follow Up":37==a.serviceRateVo.visistType&&(r="Follow Up"),i.priorityvis.visitTypeModel=r,i.orderDetails.visitTypeCode=a.serviceRateVo.visistType,i.orderDetails.price=a.serviceRateVo.baseRate,i.orderDetails.quantity=void 0===a.quantity?1:a.quantity,i.orderDetails.patamount=a.originalPatientAmount,i.orderDetails.payeramount=a.originalPayerAmount,i.dummyPice=a.serviceRateVo.baseRate,i.dummyPatAmount=a.originalPatientAmount,i.dummyPyrAmount=a.originalPayerAmount;var o={accSeqId:a.accSeqId,actualRate:a.actualRate,discountAmt:a.discountAmt,doctorAmount:a.doctorAmount,doctorShare:a.doctorShare,doctorSurcharge:a.doctorSurcharge,facilityId:a.facilityId,gnFlow:a.gnFlow,hospitalShare:a.hospitalShare,hospitalSurcharge:a.hospitalSurcharge,isDeleteBill:a.isDeleteBill,isDepositRequired:a.isDepositRequired,isEmergencyAllowedCheck:a.isEmergencyAllowedCheck,isMLCFlag:a.isMLCFlag,isRateEditable:a.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,minValue:i.orderData.minValue,maxValue:i.orderData.maxValue,fromTariffRate:i.orderData.fromTariffRate,newRate:a.newRate,patientAmount:a.patientAmount,payerAmount:a.payerAmount,originalPatientAmount:a.originalPatientAmount,originalPayerAmount:a.originalPayerAmount,servicePayerAuthorization:a.servicePayerAuthorization,practiceId:a.practiceId,proposedShareAfterDiscount:a.proposedShareAfterDiscount,requestedByEmpName:a.requestedByEmpName,requestedByEmpSeqID:a.requestedByEmpSeqID,requestedByEmpType:a.requestedByEmpType,servicePostingType:a.servicePostingType,serviceRate:a.serviceRate,serviceRateStatus:a.serviceRateStatus,serviceType:a.serviceType,standardDoctorShare:a.standardDoctorShare,subAccSeqId:a.subAccSeqId,technicianAmount:a.technicianAmount,transType:a.transType,servCode:a.serviceVo.servCode,servDesign:a.serviceVo.servDesign,servName:a.serviceVo.servName,servSeqId:a.serviceVo.servSeqId,visistType:a.serviceRateVo.visistType,baseRate:a.serviceRateVo.baseRate,gnServDesign:l,payerCompSeqId:a.payerCompSeqId,payerCompPlanseqId:a.payerCompPlanseqId,serviceTypeCode:a.primaryServiceCode,isPostBillApplicable:a.isPostBillApplicable?a.isPostBillApplicable:0};i.orderData=o,i.orderData.servCode=a.serviceVo.servCode,i.orderData.servName=a.serviceVo.servName,i.orderData.servSeqId=a.serviceVo.servSeqId,i.orderDetails.servCode=a.serviceVo.servCode,i.orderDetails.servName=a.serviceVo.servName,i.orderDetails.servSeqId=a.serviceVo.servSeqId,a.multiEmployeeShareList&&a.multiEmployeeShareList.employeeShareList&&(i.orderData.proposedShare=a.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,i.orderData.billedShare=a.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,i.orderData.grpMstCode=a.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?a.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0),le.opPreAuthGetData(i)})}},i.orderPrescription=function(e){s.selectedPreServices=[],i.modalInstance=S.open("PRESCRIPTIONS",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-order-prescription-popup.html",size:"md",scope:i});var t={};t.url=N.updateService.URL,t.requestData={operation:"getOPPrescriptionList",messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.OPPrescriptionVo",regSeqId:sessionStorage.getItem("orderregSeqId"),enSeqId:sessionStorage.getItem("orderencounterSeqId")}},P.sendRestRequest(t).then(function(e){var t=e.data.HITService.message[0]["com.napier.core.service.vo.visitmanagement.OPPrescriptionVo"],r="",a=[];void 0!==t.length?r=t:(a.push(t),r=a),i.mainPresArray=[];for(var o=!1,s=0;s<r.length;s++){o=!0;var n=r[s].opLaboratoryList[0]["com.napier.core.service.vo.visitmanagement.OPLaboratoryVo"],c=r[s].opRadiologyList[0]["com.napier.core.service.vo.visitmanagement.OPRadiologyVo"],l=r[s].opProcedureList[0]["com.napier.core.service.vo.visitmanagement.OPProcedureVo"],p=[];if(i.maindoctorName=r[s].doctorName,i.maindoctorSeqId=r[s].doctorSeqId,i.mainreqDate=moment(r[s].requestDate.$).format("YYYY-MM-DD"),p.push({maindoctorName:i.maindoctorName,maindoctorSeqId:i.maindoctorSeqId,mainreqDate:i.mainreqDate,healhCheckUpExpanded:o}),""!=r[s].opLaboratoryList[0]){var d="";if(void 0!==n.length)d=n;else{var m=[];m.push(n),d=m}}else d=[];if(""!=r[s].opRadiologyList[0]){var u="";if(void 0!==c.length)u=c;else{var v=[];v.push(c),u=v}}else u=[];if(""!=r[s].opProcedureList[0]){var S="";if(void 0!==l.length)S=l;else{var y=[];y.push(l),S=y}}else S=[];i.labtests=d,i.radtests=u,i.procedures=S;for(var D=0;D<i.RowsArr.length;D++){for(var g=0;g<i.labtests.length;g++)i.RowsArr[D][0].servSeqId!=i.labtests[g].servSeqId||3==i.RowsArr[D][0].servicePostingType||i.labtests[g].refSeqId||(i.labtests[g].selectlabtests=!0,i.labtests[g].checkOrder1=!0),i.labtests[g].refSeqId&&(i.labtests[g].selectlabtests=!0);for(g=0;g<i.radtests.length;g++)i.RowsArr[D][0].servSeqId!=i.radtests[g].servSeqId||3==i.RowsArr[D][0].servicePostingType||i.radtests[g].refSeqId||(i.radtests[g].selectradtests=!0,i.radtests[g].checkOrder2=!0),i.radtests[g].refSeqId&&(i.radtests[g].selectradtests=!0);for(g=0;g<i.procedures.length;g++)i.RowsArr[D][0].servSeqId!=i.procedures[g].servSeqId||3==i.RowsArr[D][0].servicePostingType||i.procedures[g].refSeqId||(i.procedures[g].selectproctests=!0,i.procedures[g].checkOrder3=!0),i.procedures[g].refSeqId&&(i.procedures[g].selectproctests=!0)}i.mainPresArray.push({docArray:p,labtests:i.labtests,radtests:i.radtests,procedureTests:i.procedures})}})},i.findIndexInData=function(e,t,r){var a=-1;return e.some(function(e,i){if(e[t]===r)return a=i,!0}),a},i.getSelectedPrescriptions=function(e,t){var r=i.findIndexInData(s.selectedPreServices,"servSeqId",e.servSeqId);-1!=r&&s.selectedPreServices.splice(r,1),1!=e.selectlabtests&&1!=e.selectradtests&&1!=e.selectproctests||s.selectedPreServices.push({servCode:e.servCode,servSeqId:e.servSeqId,servName:e.testName,prServCode:e.priServTypCode,secServCode:e.secServTypeCode,rqSeqId:e.rqSeqId,docSeqId:t.docArray[0].maindoctorSeqId,priority:e.priority,rqDtSeqId:e.rqDtSeqId})},i.loadPriority=function(){i.PriorityCombo=[],i.PriorityComboList={1:i.PriorityCombo};var e=I.executeQueryURLReset();return i.priorityCombosList=new Array,I.prepareParamList(1,850,i.priorityCombosList),I.executeQueryInput("TRN003",i.priorityCombosList,i.PriorityComboList,!0,!0,e,"popUp",{}).then(function(e){i.PriorityList=e[1],i.visitType="",i.visitCode="",i.visitType=i.PriorityList[0].DETAIL_DESC,i.visitCode=i.PriorityList[0].DT_CODE})},i.addServicesFromPrescription=function(){for(var e=[],t=0;t<i.RowsArr.length;t++)i.RowsArr[t][0].servSeqId==s.selectedPreServices[0].servSeqId&&3!=i.RowsArr[t][0].servicePostingType&&e.push(i.RowsArr[t][0].servName);if(0==e.length){i.addselectedPreServicesArr=[],i.addSelectPreServiceArr=[];void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,i.priorityvis.priorityTypeModel.DT_CODE):(i.priorityvis.visitTypeModel,i.orderDetails.visitTypeCode);for(var r=0;r<s.selectedPreServices.length;r++){var a=new Date,o=moment(a).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z",n=s.selectedPreServices[r].priority;N.updateService.URL,i.setCurrentTarrifId(),i.addselectedPreServicesArr=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),lbSeqId:s.selectedPreServices[r].rqDtSeqId?s.selectedPreServices[r].rqDtSeqId:void 0,servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:s.selectedPreServices[r].servSeqId,gnServDesign:1,servCode:s.selectedPreServices[r].servCode,servName:s.selectedPreServices[r].servName,secServTypeCode:s.selectedPreServices[r].secServCode,priServTypCode:s.selectedPreServices[r].prServCode},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:s.selectedPreServices[r].servSeqId,tariffSeqId:s.tariffSeqId,datedOn:o,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:i.orderDetails.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:s.selectedPreServices[r].docSeqId,fromOPVisit:"Y",payerId:i.payerTypeModel.PayerType.PINS_SEQ_ID,priority:n}],i.addSelectPreServiceArr.push(i.addselectedPreServicesArr)}var c={};c.url=N.updateService.URL,c.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectPreServiceArr}]}},P.sendRestRequest(c).then(function(e){i.addSelectedPreResponce=e.data.HITService.message,""==i.addSelectedPreResponce.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time);var t=i.addSelectedPreResponce.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"],r=[],a="";if(void 0!==t.length)a=t;else{var o=[];o.push(t),a=o}for(var n=0;n<i.RowsArr.length;n++)r.push(i.RowsArr[n][0].servSeqId);i.loadPriority(),T(function(){for(var e=0;e<a.length;e++){var t=i.visitType,r=i.visitCode;if(i.PriorityCombo.length>1&&a[e].priority){var o=i.PriorityCombo.map(function(e){return e.DT_CODE}).indexOf(a[e].priority);-1!=o&&(t=i.PriorityCombo[o].DETAIL_DESC,r=i.PriorityCombo[o].DT_CODE)}a[e].serviceVo.servSeqId;i.rows=[{serviceTypeCODE:a[e].primaryServiceCode,serviceType:a[e].primaryService,servCode:a[e].serviceVo.servCode,servName:a[e].serviceVo.servName,servSeqId:a[e].serviceVo.servSeqId,gnServDesign:a[e].serviceVo.gnServDesign,servicePayerAuthorization:a[e].servicePayerAuthorization,visistType:t,visitTypeCode:r,requestedByEmpName:a[e].requestedByEmpName,requestedByEmpSeqID:a[e].requestedByEmpSeqID,requestedByEmpType:a[e].requestedByEmpType,payerType:i.payerTypeModel.PayerType.PAYER_NAME,payerTypeCode:i.payerTypeModel.PayerType.PINS_SEQ_ID,insurancePlanSeqId:null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,actualRate:a[e].actualRate,quantity:1,isPostBillApplicable:a[e].isPostBillApplicable?a[e].isPostBillApplicable:0,patientAmount:a[e].patientAmount,payerAmount:a[e].payerAmount,originalPatientAmount:a[e].originalPatientAmount,originalPayerAmount:a[e].originalPayerAmount,discountAmt:a[e].discountAmt,doctorAmount:a[e].doctorAmount,doctorShare:a[e].doctorShare,doctorSurcharge:a[e].doctorSurcharge,hospitalShare:a[e].hospitalShare,hospitalSurcharge:a[e].hospitalSurcharge,isRateEditable:a[e].isRateEditable,newRate:a[e].newRate,proposedShareAfterDiscount:a[e].proposedShareAfterDiscount,serviceRate:a[e].serviceRate,serviceRateStatus:a[e].serviceRateStatus,standardDoctorShare:a[e].standardDoctorShare,technicianAmount:a[e].technicianAmount,baseRate:a[e].baseRate,gnFlow:a[e].gnFlow,facilityId:a[e].facilityId,billStatus:0,refTranSeqID:a[e].lbSeqId?a[e].lbSeqId:s.selectedPreServices[e].rqSeqId,payerCompSeqId:a[e].payerCompSeqId,payerCompPlanseqId:a[e].payerCompPlanseqId,rcvSeqId:a[e].serviceRateVo.rcvSeqId,inflSeqId:a[e].serviceRateVo.inflSeqId,proposedShare:a[e].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,billedShare:a[e].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,grpMstCode:a[e].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?a[e].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,transType:1,priServTypCode:a[e].secServiceCode,deptCode:null!=a[e].serviceVo&&null!=a[e].serviceVo.atomicDetailsVo&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code?a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code:void 0,specilityCode:null!=a[e].serviceVo&&null!=a[e].serviceVo.atomicDetailsVo&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code?a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code:void 0,lbSeqId:a[e].lbSeqId?a[e].lbSeqId:void 0}],i.RowsArr.unshift(i.rows)}},300),E.dismissAll(),i.orderBtnDisable=!1})}else{var l={buttonCallBack1:function(){i.addselectedPreServicesArr=[],i.addSelectPreServiceArr=[];void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,i.priorityvis.priorityTypeModel.DT_CODE):(i.priorityvis.visitTypeModel,i.orderDetails.visitTypeCode);for(var e=0;e<s.selectedPreServices.length;e++){var t=new Date,r=moment(t).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z",a=s.selectedPreServices[e].priority;N.updateService.URL,i.setCurrentTarrifId(),i.addselectedPreServicesArr=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:s.selectedPreServices[e].servSeqId,gnServDesign:1,servCode:s.selectedPreServices[e].servCode,servName:s.selectedPreServices[e].servName,secServTypeCode:s.selectedPreServices[e].secServCode,priServTypCode:s.selectedPreServices[e].prServCode},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:s.selectedPreServices[e].servSeqId,tariffSeqId:s.tariffSeqId,datedOn:r,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:i.orderDetails.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:s.selectedPreServices[e].docSeqId,fromOPVisit:"Y",payerId:i.payerTypeModel.PayerType.PINS_SEQ_ID,priority:a}],i.addSelectPreServiceArr.push(i.addselectedPreServicesArr)}var o={};o.url=N.updateService.URL,o.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectPreServiceArr}]}},P.sendRestRequest(o).then(function(e){i.addSelectedPreResponce=e.data.HITService.message,""==i.addSelectedPreResponce.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time);var t=i.addSelectedPreResponce.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"],r=[],a="";if(void 0!==t.length)a=t;else{var o=[];o.push(t),a=o}for(var n=0;n<i.RowsArr.length;n++)r.push(i.RowsArr[n][0].servSeqId);i.loadPriority(),T(function(){for(var e=0;e<a.length;e++){var t=i.visitType,r=i.visitCode;if(i.PriorityCombo.length>1&&a[e].priority){var o=i.PriorityCombo.map(function(e){return e.DT_CODE}).indexOf(a[e].priority);-1!=o&&(t=i.PriorityCombo[o].DETAIL_DESC,r=i.PriorityCombo[o].DT_CODE)}a[e].serviceVo.servSeqId;i.rows=[{serviceTypeCODE:a[e].primaryServiceCode,serviceType:a[e].primaryService,servCode:a[e].serviceVo.servCode,servName:a[e].serviceVo.servName,servSeqId:a[e].serviceVo.servSeqId,gnServDesign:a[e].serviceVo.gnServDesign,servicePayerAuthorization:a[e].servicePayerAuthorization,visistType:t,visitTypeCode:r,requestedByEmpName:a[e].requestedByEmpName,requestedByEmpSeqID:a[e].requestedByEmpSeqID,requestedByEmpType:a[e].requestedByEmpType,payerType:i.payerTypeModel.PayerType.PAYER_NAME,payerTypeCode:i.payerTypeModel.PayerType.PINS_SEQ_ID,insurancePlanSeqId:null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,actualRate:a[e].actualRate,quantity:1,isPostBillApplicable:a[e].isPostBillApplicable?a[e].isPostBillApplicable:0,patientAmount:a[e].patientAmount,payerAmount:a[e].payerAmount,originalPatientAmount:a[e].originalPatientAmount,originalPayerAmount:a[e].originalPayerAmount,discountAmt:a[e].discountAmt,doctorAmount:a[e].doctorAmount,doctorShare:a[e].doctorShare,doctorSurcharge:a[e].doctorSurcharge,hospitalShare:a[e].hospitalShare,hospitalSurcharge:a[e].hospitalSurcharge,isRateEditable:a[e].isRateEditable,newRate:a[e].newRate,proposedShareAfterDiscount:a[e].proposedShareAfterDiscount,serviceRate:a[e].serviceRate,serviceRateStatus:a[e].serviceRateStatus,standardDoctorShare:a[e].standardDoctorShare,technicianAmount:a[e].technicianAmount,baseRate:a[e].baseRate,gnFlow:a[e].gnFlow,facilityId:a[e].facilityId,billStatus:0,refTranSeqID:s.selectedPreServices[e].rqSeqId,payerCompSeqId:a[e].payerCompSeqId,payerCompPlanseqId:a[e].payerCompPlanseqId,rcvSeqId:a[e].serviceRateVo.rcvSeqId,inflSeqId:a[e].serviceRateVo.inflSeqId,proposedShare:a[e].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,billedShare:a[e].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,grpMstCode:a[e].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?a[e].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,transType:1,priServTypCode:a[e].secServiceCode,deptCode:null!=a[e].serviceVo&&null!=a[e].serviceVo.atomicDetailsVo&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code?a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code:void 0,specilityCode:null!=a[e].serviceVo&&null!=a[e].serviceVo.atomicDetailsVo&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code?a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code:void 0}],i.RowsArr.unshift(i.rows)}},300),E.dismissAll(),i.orderBtnDisable=!1})},buttonCallBack2:function(){}};v.hisAlertMulti("warning","Confirmation","Service Already added.Do you really want to add the service ?",{buttonText:"YES",buttonText2:"NO"},l,close)}},i.mapDoctorTopackageServices=function(e){$("#packageServiceModal").modal("hide");var t=i.pkgSelectedRow,r=i.RowsArr[t],a=0;angular.forEach(i.packageServices,function(e,t){a+=parseFloat(e.INCL_AMOUNT)}),i.changePkgRates(a,r).then(function(a){a?i.preparePackageObject(e,r):(v.warning("Warning!","Package amount and Tariff Rates are not same. Kindly change either of one."),i.RowsArr.splice(t,1))})},i.preparePackageObject=function(e,t){i.showOrderLoadingIcon=!0,i.packageServicesArrayObejct=[];var r=new Date,a=moment(r).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";i.currentObjData.isPrintToBill=i.billcheck;var o="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,o=i.priorityvis.priorityTypeModel.DT_CODE):(i.priorityvis.visitTypeModel,o=i.orderDetails.visitTypeCode);var n=o;i.addSelectServicepostEditArr=[],i.setCurrentTarrifId();for(var c=0;c<e.length;c++){var l=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,parentSeqId:t[0].servSeqId,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:e[c].INCL_SERV_SEQ_ID,gnServDesign:1,servCode:e[c].SERV_CODE,servName:e[c].SERV_NAME,secServTypeCode:e[c].SEC_SERV_TYPE_CODE,priServTypCode:e[c].SEC_SERV_TYPE_CODE},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:e[c].INCL_SERV_SEQ_ID,tariffSeqId:s.tariffSeqId,datedOn:a,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:i.orderDetails.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:e[c].serviceDoc,fromOPVisit:"Y",priority:n,appointReason:e[c].NH_OP_REASON_SEQ_ID?e[c].NH_OP_REASON_SEQ_ID:e[c].appointReason?e[c].appointReason:void 0}];i.addSelectServicepostEditArr.push(l)}var p={};p.url=N.updateService.URL,p.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectServicepostEditArr}]}},P.sendRestRequest(p).then(function(r){i.addselectPackageresponse=r.data.HITService.message;var a=i.addselectPackageresponse.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];if(""!=a){if(a=a instanceof Array?a:[a],angular.isArray(a)){for(var o=0;o<a.length;o++){var s={};(s=e[o]).parentServSeqId=e[0].SERV_SEQ_ID,s.serviceTypeCODE=a[o].serviceVo.priServTypCode,s.serviceType=i.serviceTypeModel.serviceType.DESCRIPTION,s.servCode=a[o].serviceVo.servCode,s.servicePostingSeqId=e[o].servicePostingSeqId,s.servName=a[o].serviceVo.servName,s.servSeqId=a[o].serviceVo.servSeqId,s.gnServDesign=a[o].serviceVo.gnServDesign,s.servicePayerAuthorization=a[o].servicePayerAuthorization,s.visistType=void 0,s.requestedByEmpName=a[o].requestedByEmpName,s.requestedByEmpSeqID=a[o].requestedByEmpSeqID,s.requestedByEmpType=a[o].requestedByEmpType,s.payerType=i.payerTypeModel.PayerType.PAYER_NAME,s.payerTypeCode=i.payerTypeModel.PayerType.PINS_SEQ_ID,s.actualRate=a[o].actualRate,s.quantity=1,s.isPostBillApplicable=a[o].isPostBillApplicable?a[o].isPostBillApplicable:0,s.patientAmount=a[o].patientAmount,s.payerAmount=a[o].payerAmount,s.originalPatientAmount=a[o].originalPatientAmount,s.originalPayerAmount=a[o].originalPayerAmount,s.discountAmt=a[o].discountAmt,s.doctorAmount=a[o].doctorAmount,s.doctorShare=a[o].doctorShare,s.doctorSurcharge=a[o].doctorSurcharge,s.hospitalShare=a[o].hospitalShare,s.hospitalSurcharge=a[o].hospitalSurcharge,s.isRateEditable=a[o].serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,s.newRate=a[o].newRate,s.proposedShareAfterDiscount=a[o].proposedShareAfterDiscount,s.serviceRate=a[o].serviceRate,s.serviceRateStatus=a[o].serviceRateStatus,s.standardDoctorShare=a[o].standardDoctorShare,s.technicianAmount=a[o].technicianAmount,s.baseRate=a[o].baseRate,s.gnFlow=a[o].gnFlow,s.facilityId=a[o].facilityId,s.facilityId=a[o].facilityId,s.facilityId=a[o].facilityId,s.isPackage=2,s.packApplyType=2,s.appointReason=a[o].appointReason;var n=a[o].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"];s.billedShare=n.billedShare,s.proposedShare=n.proposedShare,s.docempSeqId=n.employee?n.employee.empSeqId:void 0,null!=a[o].serviceVo&&null!=a[o].serviceVo.atomicDetailsVo&&null!=a[o].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=a[o].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=a[o].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&(null!=a[o].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&(s.deptCode=a[o].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code),null!=a[o].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=a[o].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=a[o].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&(s.specilityCode=a[o].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code)),i.packageServicesArrayObejct.push(s)}t[0].packageServicesList=angular.copy(i.packageServicesArrayObejct),i.packageServicesArrayObejct=[]}i.showOrderLoadingIcon=!1}})},i.clickBillPrint=function(e){i.billcheck=e},i.packageServclose=function(){i.mapDoctorTopackageServices(i.packageServices)},i.showpackageServices=function(e,t){i.packageServices=[],i.inclusionServiceValid=!1,i.pkgSelectedRow=t;var r="Master "+e[0].servName,o=(r.toUpperCase(),e[0].servSeqId);if(i.currentObjData=e[0],i.billcheck="N",$("#packageServiceModal").modal({backdrop:"static",keyboard:!1}),i.packageTitle=r,void 0!==e[0].servicePostingSeqId){for(var s=e[0].servicePostingSeqId,n=[],c=0;c<i.retrivePacServObj.length;c++)i.retrivePacServObj[c].parentSeqId==s&&n.push(i.retrivePacServObj[c]);i.packageServices=n}else if(e[0].packageServicesList&&e[0].packageServicesList.length>0)i.packageServices=[],i.packageServices=e[0].packageServicesList;else{var l;l={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"GET_SERVICES_FOR_PACKAGE_001",idxList:[{"com.napier.core.service.vo.query.Index":[{paramName:"pPracticeId",value:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID},{paramName:"pFacilityId",value:angular.fromJson(sessionStorage.userContextObj).FACILITY_ID},{paramName:"pServSeqId",value:o}]}]}]}]};var p={};p.url=a.HISCOMBOFILLING.URL,p.requestData={operation:"ExecuteQuery",destination:"QueryService",message:l},P.sendRestRequest(p).then(function(t){var r=t.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"];if(void 0===i.packageServices||0==i.packageServices.length){i.packageServices=[];for(var a=0;a<r.length;a++){for(var o={},s=r[a].columnList[0]["com.napier.core.service.vo.query.Column"],n=0;n<s.length;n++){o[s[n].name.split(".")[1]]=s[n].data}o.serviceDoc=e[0].requestedByEmpName,o.serviceDoc=e[0].requestedByEmpSeqID,o.pacMainObj=e[0],i.packageServices.push(o)}}})}},i.changeRatesBasedonQty=function(e){var t=parseInt(e);t>=1||(v.warning("Warning!","Order Qty should not be Less than 1",!1,!1,me.time),i.orderDetails.quantity=1,e=1);var r=i.orderData.requestedByEmpSeqID,a=sessionStorage.getItem("orderregSeqId"),o=sessionStorage.getItem("orderencounterSeqId");i.setCurrentTarrifId();var n=s.tariffSeqId,c=i.payerTypeModel.PayerType.PINS_SEQ_ID,l="";l=void 0!==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID?i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID:i.orderData.appointReason;var p="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,p=i.priorityvis.priorityTypeModel.DT_CODE):(i.priorityvis.visitTypeModel,p=i.orderDetails.visitTypeCode);var d=p;if(1!=l){i.addSelectServicepostEditArr=[];var m=new Date,u=moment(m).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";N.updateService.URL;var S=1;3==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID&&(S=2);var y=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.orderDetails.servSeqId,gnServDesign:S,servCode:i.orderDetails.servCode,servName:i.orderDetails.servName,secServTypeCode:i.orderDetails.servSeqId,priServTypCode:i.orderDetails.servSeqId},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.orderDetails.servSeqId,tariffSeqId:s.tariffSeqId,datedOn:u,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},quantity:e,transType:1,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:r,payerId:c,fromOPVisit:"Y",priority:d}];i.addSelectServicepostEditArr.push(y);var D={};D.url=N.updateService.URL,D.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectServicepostEditArr}]}},P.sendRestRequest(D).then(function(e){i.addselectEdiresponse=e.data.HITService.message,""==i.addselectEdiresponse.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time);var t=i.addselectEdiresponse.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];i.orderData.actualRate=t.actualRate,i.orderData.quantity=t.quantity,i.orderData.isPostBillApplicable=t.isPostBillApplicable?t.isPostBillApplicable:0,i.orderData.patientAmount=t.patientAmount,i.orderData.payerAmount=t.payerAmount,i.orderData.originalPatientAmount=t.originalPatientAmount,i.orderData.originalPayerAmount=t.originalPayerAmount,i.orderData.discountAmt=t.discountAmt,i.orderData.doctorAmount=t.doctorAmount,i.orderData.doctorShare=t.doctorShare,i.orderData.doctorSurcharge=t.doctorSurcharge,i.orderData.hospitalShare=t.hospitalShare,i.orderData.hospitalSurcharge=t.hospitalSurcharge,i.orderData.isRateEditable=t.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,1==i.orderData.isRateEditable&&(i.orderData.minValue=null!=t.minVal?t.minVal:t.serviceVo.scmMasterServBillingAttrVo.minValue,i.orderData.maxValue=null!=t.maxVal?t.maxVal:t.serviceVo.scmMasterServBillingAttrVo.maxValue,i.orderData.fromTariffRate="R"),i.orderData.newRate=t.newRate,i.orderData.proposedShareAfterDiscount=t.proposedShareAfterDiscount,i.orderData.serviceRate=t.serviceRate,i.orderData.serviceRateStatus=t.serviceRateStatus,i.orderData.standardDoctorShare=t.standardDoctorShare,i.orderData.technicianAmount=t.technicianAmount,i.orderData.baseRate=t.serviceRateVo.baseRate,i.orderData.gnFlow=t.gnFlow,i.orderData.facilityId=t.facilityId,i.orderData.billStatus=0,i.orderData.payerCompSeqId=t.payerCompSeqId,i.orderData.payerCompPlanseqId=t.payerCompPlanseqId,i.orderDetails.price=t.serviceRate,i.dummyPice=t.serviceRate,i.dummyPatAmount=t.originalPatientAmount,i.dummyPyrAmount=t.originalPayerAmount,i.orderDetails.patamount=t.originalPatientAmount,i.orderDetails.payeramount=t.originalPayerAmount,i.orderData.rcvSeqId=t.serviceRateVo.rcvSeqId,i.orderData.inflSeqId=t.serviceRateVo.inflSeqId,i.orderData.proposedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,i.orderData.billedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,i.orderData.grpMstCode=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,i.orderData.priServTypCode=t.secServiceCode,null!=t.serviceVo&&null!=t.serviceVo.atomicDetailsVo&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&(null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&(i.orderData.deptCode=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code),null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&(i.orderData.specilityCode=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code))})}else"HSC"==sessionStorage.getItem("productCustomization")?t>1&&(i.orderDetails.quantity=1):i.getOrderDetails(r,a,o,n,void 0,c,e)},i.DeleteOrderRecords=function(e,t){var r={buttonCallBack1:function(r){if(void 0!==t[0].servicePostingSeqId){var a={};a.url=N.updateService.URL,a.requestData={operation:"checkOrderCancel",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.master.vo.ServiceListVo",serviceList:[{"com.napier.core.scm.master.vo.ServiceVo":[{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:t[0].servicePostingSeqId,servDesc:t[0].servName,gnServDesign:null!=t[0].appointReason?t[0].appointReason:2}]}]}},P.sendRestRequest(a).then(function(a){if(""==a.data.HITService.message.serviceList[0]){var o={};o.url=N.updateService.URL,o.requestData={operation:"cancelServicePosting",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",servicePostingSeqId:t[0].servicePostingSeqId,encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},servicePostingCacelReason:i.projSpecApplicable?r:"",cancelRequestedBy:i.projSpecApplicable?JSON.parse(sessionStorage.userContextObj).USER_SEQ_ID:void 0}]}]}},P.sendRestRequest(o).then(function(t){i.RowsArr[e][0].servicePostingSeqId?i.RowsArr[e][0].servicePostingType=3:(i.preAuthBillOrServiceCal(!0,i.RowsArr[e][0]),i.RowsArr.splice(e,1));try{"error"==t.data.HITService.message||t.data.HITService.message.errorCode||t.data.HITService.message.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"]&&(i.RowsArr[e][0].servicePostingCacelReason=t.data.HITService.message.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"].servicePostingCacelReason)}catch(e){}i.loadBillNumbers(s.mrNo)})}else v.warning("Warning!","We Can't Delete this Service",!1,!1,me.time);for(var n=0,c=0;c<i.RowsArr.length;c++)1!=i.RowsArr[c][0].billStatus&&(n=1);i.orderBtnDisable=0==n})}else{i.RowsArr[e][0].servicePostingSeqId?i.RowsArr[e][0].servicePostingType=3:(i.preAuthBillOrServiceCal(!0,i.RowsArr[e][0]),i.RowsArr.splice(e,1));for(var o=0,n=0;n<i.RowsArr.length;n++)1!=i.RowsArr[n][0].billStatus&&(o=1);i.orderBtnDisable=0==o}i.packageServices=[]},buttonCallBack2:function(){}};v.hisAlertMulti("warning","Confirmation","Do you really want to delete the service ?",{buttonText:"YES",buttonText2:"NO"},r,close)},i.updateOrdersRow=function(e){i.showOrderErrors=!0,e.$valid&&T(function(){if(s.editRowRecord[0].servSeqId==i.orderDetails.servSeqId)var e=[];else{e=[];for(var t=0;t<i.RowsArr.length;t++)i.RowsArr[t][0].servSeqId==i.orderDetails.servSeqId&&e.push(i.RowsArr[t][0].servName)}if(0==e.length){if(i.orderData.baseRate!=i.orderDetails.price)if(0==i.checkMinMaxForRateEditable())return;var r="";r=void 0!==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID?i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID:i.orderData.appointReason;var a="",o="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel&&null!=i.priorityvis.priorityTypeModel?(a=i.priorityvis.priorityTypeModel.DETAIL_DESC,o=i.priorityvis.priorityTypeModel.DT_CODE):(a=i.priorityvis.visitTypeModel,o=i.orderDetails.visitTypeCode),s.editRowRecord[0].doctorModifiedAmount=i.orderData.doctorModifiedAmount,s.editRowRecord[0].updateServiceFlag=i.orderData.updateDoctorShares,s.editRowRecord[0].serviceTypeCODE=i.serviceTypeModel.serviceType.CODE,s.editRowRecord[0].serviceType=i.serviceTypeModel.serviceType.DESCRIPTION,s.editRowRecord[0].servCode=i.orderDetails.servCode,s.editRowRecord[0].servDesign=i.orderData.servDesign,s.editRowRecord[0].servName=i.orderDetails.servName,s.editRowRecord[0].servSeqId=i.orderDetails.servSeqId,s.editRowRecord[0].servicePayerAuthorization=i.dummyPyrAutherisation,s.editRowRecord[0].visistType=a,s.editRowRecord[0].visitTypeCode=o,s.editRowRecord[0].requestedByEmpName=i.orderData.requestedByEmpName,s.editRowRecord[0].requestedByEmpSeqID=i.orderData.requestedByEmpSeqID,s.editRowRecord[0].requestedByEmpType=i.orderData.requestedByEmpType,s.editRowRecord[0].payerType=i.payerTypeModel.PayerType.PAYER_NAME,s.editRowRecord[0].payerTypeCode=i.payerTypeModel.PayerType.PINS_SEQ_ID,s.editRowRecord[0].payerTarrifId=i.payerTypeModel.PayerType.TATRIFF_SEQ_ID?i.payerTypeModel.PayerType.TATRIFF_SEQ_ID:s.tariffSeqId,s.editRowRecord[0].insurancePlanSeqId=null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,s.editRowRecord[0].actualRate=i.orderData.actualRate,s.editRowRecord[0].quantity=i.orderDetails.quantity,s.editRowRecord[0].patientAmount=i.orderData.patientAmount,s.editRowRecord[0].payerAmount=i.orderData.payerAmount,s.editRowRecord[0].originalPatientAmount=i.orderData.originalPatientAmount,s.editRowRecord[0].originalPayerAmount=i.orderData.originalPayerAmount,s.editRowRecord[0].discountAmt=i.orderData.discountAmt,s.editRowRecord[0].doctorAmount=i.orderData.doctorAmount,s.editRowRecord[0].doctorShare=i.orderData.doctorShare,s.editRowRecord[0].doctorSurcharge=i.orderData.doctorSurcharge,s.editRowRecord[0].hospitalShare=i.orderData.hospitalShare,s.editRowRecord[0].hospitalSurcharge=i.orderData.hospitalSurcharge,s.editRowRecord[0].isRateEditable=i.orderData.isRateEditable,1==s.editRowRecord[0].isRateEditable&&(s.editRowRecord[0].minValue=i.orderData.minValue,s.editRowRecord[0].maxValue=i.orderData.maxValue,s.editRowRecord[0].fromTariffRate=i.orderData.fromTariffRate),s.editRowRecord[0].newRate=i.orderData.newRate,s.editRowRecord[0].proposedShareAfterDiscount=i.orderData.proposedShareAfterDiscount,s.editRowRecord[0].serviceRate=i.orderData.serviceRate,s.editRowRecord[0].serviceRateStatus=i.orderData.serviceRateStatus,s.editRowRecord[0].standardDoctorShare=i.orderData.standardDoctorShare,s.editRowRecord[0].technicianAmount=i.orderData.technicianAmount,s.editRowRecord[0].baseRate=i.orderData.baseRate,s.editRowRecord[0].gnFlow=i.orderData.gnFlow,s.editRowRecord[0].facilityId=i.orderData.facilityId,s.editRowRecord[0].gnServDesign=i.orderData.gnServDesign,s.editRowRecord[0].payerCompSeqId=i.orderData.payerCompSeqId,s.editRowRecord[0].payerCompPlanseqId=i.orderData.payerCompPlanseqId,s.editRowRecord[0].appointReason=r,s.editRowRecord[0].transType=i.orderData.transType,s.editRowRecord[0].proposedShare=i.orderData.proposedShare,s.editRowRecord[0].billedShare=i.orderData.billedShare,s.editRowRecord[0].grpMstCode=i.orderData.grpMstCode?i.orderData.grpMstCode:void 0;i.orderData.requestedByEmpName,sessionStorage.getItem("orderregSeqId"),sessionStorage.getItem("orderencounterSeqId");i.orderDetails.OPVMorderService="",i.orderDetails.price="",i.orderDetails.quantity=1,i.orderDetails.patamount="",i.orderDetails.payeramount="",i.priorityvis.priorityTypeModel="",i.priorityvis.visitTypeModel="",i.serviceTypeModel.serviceType="",i.addRowStatus=!0,i.orderData.isRateEditable=2,"N"==s.editRowRecord[0].servicePayerAuthorization&&"self"!=s.editRowRecord[0].payerType.toLocaleLowerCase()?i.isServiceSelectedCovered=!0:i.isServiceSelectedCovered=!1,T(function(){i.isServiceSelectedCovered=!1},2e3),i.showOrderErrors=!1}else{var n={buttonCallBack1:function(){if(i.orderData.baseRate!=i.orderDetails.price&&0==i.checkMinMaxForRateEditable())return;var e="";e=void 0!==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID?i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID:i.orderData.appointReason;var t="",r="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel&&null!=i.priorityvis.priorityTypeModel?(t=i.priorityvis.priorityTypeModel.DETAIL_DESC,r=i.priorityvis.priorityTypeModel.DT_CODE):(t=i.priorityvis.visitTypeModel,r=i.orderDetails.visitTypeCode),s.editRowRecord[0].serviceTypeCODE=i.serviceTypeModel.serviceType.CODE,s.editRowRecord[0].serviceType=i.serviceTypeModel.serviceType.DESCRIPTION,s.editRowRecord[0].servCode=i.orderDetails.servCode,s.editRowRecord[0].servDesign=i.orderData.servDesign,s.editRowRecord[0].servName=i.orderDetails.servName,s.editRowRecord[0].servSeqId=i.orderDetails.servSeqId,s.editRowRecord[0].servicePayerAuthorization=i.dummyPyrAutherisation,s.editRowRecord[0].visistType=t,s.editRowRecord[0].visitTypeCode=r,s.editRowRecord[0].requestedByEmpName=i.orderData.requestedByEmpName,s.editRowRecord[0].requestedByEmpSeqID=i.orderData.requestedByEmpSeqID,s.editRowRecord[0].requestedByEmpType=i.orderData.requestedByEmpType,s.editRowRecord[0].payerType=i.payerTypeModel.PayerType.PAYER_NAME,s.editRowRecord[0].payerTypeCode=i.payerTypeModel.PayerType.PINS_SEQ_ID,s.editRowRecord[0].payerTarrifId=i.payerTypeModel.PayerType.TATRIFF_SEQ_ID?i.payerTypeModel.PayerType.TATRIFF_SEQ_ID:s.tariffSeqId,s.editRowRecord[0].insurancePlanSeqId=null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,s.editRowRecord[0].actualRate=i.orderData.actualRate,s.editRowRecord[0].quantity=i.orderDetails.quantity,s.editRowRecord[0].patientAmount=i.orderData.patientAmount,s.editRowRecord[0].payerAmount=i.orderData.payerAmount,s.editRowRecord[0].originalPatientAmount=i.orderData.originalPatientAmount,s.editRowRecord[0].originalPayerAmount=i.orderData.originalPayerAmount,s.editRowRecord[0].discountAmt=i.orderData.discountAmt,s.editRowRecord[0].doctorAmount=i.orderData.doctorAmount,s.editRowRecord[0].doctorShare=i.orderData.doctorShare,s.editRowRecord[0].doctorSurcharge=i.orderData.doctorSurcharge,s.editRowRecord[0].hospitalShare=i.orderData.hospitalShare,s.editRowRecord[0].hospitalSurcharge=i.orderData.hospitalSurcharge,s.editRowRecord[0].isRateEditable=i.orderData.isRateEditable,1==s.editRowRecord[0].isRateEditable&&(s.editRowRecord[0].minValue=i.orderData.minValue,s.editRowRecord[0].maxValue=i.orderData.maxValue,s.editRowRecord[0].fromTariffRate=i.orderData.fromTariffRate),s.editRowRecord[0].newRate=i.orderData.newRate,s.editRowRecord[0].proposedShareAfterDiscount=i.orderData.proposedShareAfterDiscount,s.editRowRecord[0].serviceRate=i.orderData.serviceRate,s.editRowRecord[0].serviceRateStatus=i.orderData.serviceRateStatus,s.editRowRecord[0].standardDoctorShare=i.orderData.standardDoctorShare,s.editRowRecord[0].technicianAmount=i.orderData.technicianAmount,s.editRowRecord[0].baseRate=i.orderData.baseRate,s.editRowRecord[0].gnFlow=i.orderData.gnFlow,s.editRowRecord[0].facilityId=i.orderData.facilityId,s.editRowRecord[0].gnServDesign=i.orderData.gnServDesign,s.editRowRecord[0].payerCompSeqId=i.orderData.payerCompSeqId,s.editRowRecord[0].payerCompPlanseqId=i.orderData.payerCompPlanseqId,s.editRowRecord[0].appointReason=e,s.editRowRecord[0].transType=i.orderData.transType,s.editRowRecord[0].proposedShare=i.orderData.proposedShare,s.editRowRecord[0].billedShare=i.orderData.billedShare,s.editRowRecord[0].grpMstCode=i.orderData.grpMstCode?i.orderData.grpMstCode:void 0;i.orderData.requestedByEmpName,sessionStorage.getItem("orderregSeqId"),sessionStorage.getItem("orderencounterSeqId");i.orderDetails.OPVMorderService="",i.orderDetails.price="",i.orderDetails.quantity=1,i.orderDetails.patamount="",i.orderDetails.payeramount="",i.priorityvis.priorityTypeModel="",i.priorityvis.visitTypeModel="",i.serviceTypeModel.serviceType="",i.addRowStatus=!0,i.orderData.isRateEditable=2,"N"==s.editRowRecord[0].servicePayerAuthorization&&"self"!=s.editRowRecord[0].payerType.toLocaleLowerCase()?i.isServiceSelectedCovered=!0:i.isServiceSelectedCovered=!1,T(function(){i.isServiceSelectedCovered=!1},2e3),i.showOrderErrors=!1},buttonCallBack2:function(){}};v.hisAlertMulti("warning","Confirmation","Service Already added.Do you really want to add the service ?",{buttonText:"YES",buttonText2:"NO"},n,close)}},1e3)},i.retriveRecords=function(){i.retrivePackageServObj=[],i.retrivePackageDeletedServObj=[];var e={};e.url=N.updateService.URL,e.requestData={operation:"getServicePostingList",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingFilterVo",patientId:s.mrNo,fromDate:"1800-01-01 00:00:00.000Z",toDate:"9999-01-01 23:59:59.000Z",practiseId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,enSeqId:sessionStorage.getItem("orderencounterSeqId"),specific:i.projSpecApplicable}},i.showOrderLoadingIcon=!0,P.sendRestRequest(e).then(function(e){i.RowsArr=[];var t=e.data.HITService.message;if(i.orderUpdate=!0,t.servicePostingDetailsList&&(i.servicepostingList=t.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"],i.servicepostingList=i.servicepostingList instanceof Array?i.servicepostingList:[i.servicepostingList],i.retrivePacServObj=[],i.servicepostingList.length>0&&!i.servicepostingList[0].isIpVisit)){i.orderUpdate=!0;for(var r=0;r<i.servicepostingList.length;r++){1!=i.servicepostingList[r].billStatus&&(i.orderBtnDisable=!1);let e=null!=i.servicepostingList[r].copayAmt?parseFloat(i.servicepostingList[r].copayAmt):parseFloat(0);if(2!=i.servicepostingList[r].packApplyType){if(i.rows=[{servicePostingSeqId:i.servicepostingList[r].servicePostingSeqId,serviceTypeCODE:i.servicepostingList[r].serviceVo.priServTypCode,serviceType:i.servicepostingList[r].priTypeDesc,servCode:i.servicepostingList[r].serviceVo.servCode,servName:i.servicepostingList[r].serviceVo.servName,servSeqId:i.servicepostingList[r].serviceVo.servSeqId,payerTarrifId:i.servicepostingList[r].serviceRateVo?i.servicepostingList[r].serviceRateVo.tariffSeqId:void 0,gnServDesign:i.servicepostingList[r].serviceVo.gnServDesign,visistType:i.servicepostingList[r].priorityDesc,visitTypeCode:i.servicepostingList[r].priority,requestedByEmpName:i.servicepostingList[r].requestedByEmpName,requestedByEmpSeqID:i.servicepostingList[r].requestedByEmpSeqID,requestedByEmpType:i.servicepostingList[r].requestedByEmpCode,servicePayerAuthorization:i.servicepostingList[r].servicePayerAuthorization,payerType:i.servicepostingList[r].payer,payerTypeCode:i.servicepostingList[r].payerId,payerCompSeqId:i.servicepostingList[r].payerCompSeqId,payerCompPlanseqId:i.servicepostingList[r].payerCompPlanseqId,insurancePlanSeqId:null!=i.servicepostingList[r].insurancePlanSeqId&&null!=i.servicepostingList[r].insurancePlanSeqId?i.servicepostingList[r].insurancePlanSeqId:void 0,actualRate:i.servicepostingList[r].actualRate,quantity:i.servicepostingList[r].quantity,isPostBillApplicable:i.servicepostingList[r].isPostBillApplicable?i.servicepostingList[r].isPostBillApplicable:0,patientAmount:i.servicepostingList[r].companyNonPayingAmt,payerAmount:i.servicepostingList[r].companyPayingAmt,originalPatientAmount:null==i.servicepostingList[r].companyPayingAmt||0==i.servicepostingList[r].companyPayingAmt?i.servicepostingList[r].serviceRate*i.servicepostingList[r].quantity:parseFloat(i.servicepostingList[r].companyPayingAmt)>i.servicepostingList[r].serviceRate?parseFloat(0):parseFloat(i.servicepostingList[r].companyPayingAmt)+e>=i.servicepostingList[r].actualRate?parseFloat(0):parseFloat((i.servicepostingList[r].actualRate-parseFloat(i.servicepostingList[r].companyPayingAmt)).toFixed(2))-e,originalPayerAmount:null==i.servicepostingList[r].companyPayingAmt||0==i.servicepostingList[r].companyPayingAmt?parseFloat(0):parseFloat(i.servicepostingList[r].companyPayingAmt)>i.servicepostingList[r].serviceRate?i.servicepostingList[r].serviceRate*i.servicepostingList[r].quantity:parseFloat(i.servicepostingList[r].companyPayingAmt)+e>=i.servicepostingList[r].actualRate?i.servicepostingList[r].serviceRate:i.servicepostingList[r].companyPayingAmt+e>i.servicepostingList[r].serviceRate?i.servicepostingList[r].serviceRate:i.servicepostingList[r].companyPayingAmt+e,discountAmt:i.servicepostingList[r].discountAmt,doctorAmount:i.servicepostingList[r].doctorAmount,doctorShare:i.servicepostingList[r].doctorShare,hospitalShare:i.servicepostingList[r].hospitalShare,isRateEditable:i.servicepostingList[r].serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,minValue:i.servicepostingList[r].serviceRateVo.minValue,maxValue:i.servicepostingList[r].serviceRateVo.maxValue,fromTariffRate:i.servicepostingList[r].visitConfigOrRateCard,serviceRate:i.servicepostingList[r].serviceRate,serviceRateStatus:i.servicepostingList[r].serviceRateStatus,standardDoctorShare:i.servicepostingList[r].standardDoctorShare,technicianAmount:i.servicepostingList[r].technicianAmount,baseRate:i.servicepostingList[r].baseRate,gnFlow:i.servicepostingList[r].gnFlow,billStatus:i.servicepostingList[r].billStatus,appointReason:i.servicepostingList[r].appointReason,transType:i.servicepostingList[r].transType,isComingFromOPPharmacy:i.servicepostingList[r].isComingFromOPPharmacy,servicePostingType:i.servicepostingList[r].servicePostingType,servicePostingCacelReason:i.servicepostingList[r].servicePostingCacelReason,priServTypCode:i.servicepostingList[r].serviceVo.secServTypeCode,deptCode:null!=i.servicepostingList[r].serviceVo&&null!=i.servicepostingList[r].serviceVo.atomicDetailsVo&&null!=i.servicepostingList[r].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=i.servicepostingList[r].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=i.servicepostingList[r].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=i.servicepostingList[r].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&null!=i.servicepostingList[r].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code?i.servicepostingList[r].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code:void 0,specilityCode:null!=i.servicepostingList[r].serviceVo&&null!=i.servicepostingList[r].serviceVo.atomicDetailsVo&&null!=i.servicepostingList[r].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=i.servicepostingList[r].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=i.servicepostingList[r].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=i.servicepostingList[r].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=i.servicepostingList[r].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=i.servicepostingList[r].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&null!=i.servicepostingList[r].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code?i.servicepostingList[r].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code:void 0,isPharmacyService:i.servicepostingList[r].isPharmacyService,refTranSeqID:i.servicepostingList[r].refTranSeqID,packageServiceCancelReason:i.servicepostingList[r].packageServiceCancelReason,pharamcyIssueServSeqId:i.servicepostingList[r].pharamcyIssueServSeqId}],i.servicepostingList[r].multiEmployeeShareList)if((c=i.servicepostingList[r].multiEmployeeShareList).employeeShareList&&c.employeeShareList[0])if((l=c.employeeShareList[0])["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"]){var a=l["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"];if(Array.isArray(a))for(var o=0;o<a.length;o++)2==a[o].entityType&&(i.rows[0].billedShare=a[o].billedShare,i.rows[0].proposedShare=a[o].proposedShare,i.rows[0].employeeShareSeqId=a[o].employeeShareSeqId);else i.rows[0].billedShare=a.billedShare,i.rows[0].proposedShare=a.proposedShare,i.rows[0].employeeShareSeqId=a.employeeShareSeqId}i.RowsArr.unshift(i.rows),i.counter++}else if(1==i.servicepostingList[r].gnTranStatus){var n={INCL_SERV_SEQ_ID:i.servicepostingList[r].serviceVo.servSeqId,SERV_CODE:i.servicepostingList[r].serviceVo.servCode,SERV_NAME:i.servicepostingList[r].serviceVo.servName,SERV_SEQ_ID:i.servicepostingList[r].serviceVo.servSeqId,serviceDoc:i.servicepostingList[r].requestedByEmpSeqID,parentSeqId:i.servicepostingList[r].parentSpSeqId,servicePostingSeqId:i.servicepostingList[r].servicePostingSeqId,servicePostingType:i.servicepostingList[r].servicePostingType,INCL_AMOUNT:i.servicepostingList[r].serviceRate};i.retrivePacServObj.push(n),s.parentSeqId=i.servicepostingList[r].parentSpSeqId;var c,l,p={};if(p.serviceTypeCODE=i.servicepostingList[r].serviceVo.priServTypCode,p.servicePostingSeqId=i.servicepostingList[r].servicePostingSeqId,p.serviceType=i.servicepostingList[r].priTypeDesc,p.servCode=i.servicepostingList[r].serviceVo.servCode,p.servName=i.servicepostingList[r].serviceVo.servName,p.servSeqId=i.servicepostingList[r].serviceVo.servSeqId,p.gnServDesign=i.servicepostingList[r].serviceVo.gnServDesign,p.servicePayerAuthorization=i.servicepostingList[r].servicePayerAuthorization,p.visistType=i.servicepostingList[r].priorityDesc,p.visitTypeCode=i.servicepostingList[r].priority,p.transType=i.servicepostingList[r].transType,p.parentSpSeqId=i.servicepostingList[r].parentSpSeqId,p.requestedByEmpName=i.servicepostingList[r].requestedByEmpName,p.requestedByEmpSeqID=i.servicepostingList[r].requestedByEmpSeqID,p.requestedByEmpType=i.servicepostingList[r].requestedByEmpCode,p.payerType=i.servicepostingList[r].payer,p.payerTypeCode=i.servicepostingList[r].payerId,p.actualRate=i.servicepostingList[r].actualRate,p.quantity=i.servicepostingList[r].quantity,p.insurancePlanSeqId=null!=i.servicepostingList[r].insurancePlanSeqId&&null!=i.servicepostingList[r].insurancePlanSeqId?i.servicepostingList[r].insurancePlanSeqId:void 0,p.patientAmount=i.servicepostingList[r].companyNonPayingAmt,p.payerAmount=i.servicepostingList[r].companyPayingAmt,p.originalPatientAmount=null==i.servicepostingList[r].companyPayingAmt||0==i.servicepostingList[r].companyPayingAmt?i.servicepostingList[r].serviceRate*i.servicepostingList[r].quantity:parseFloat(i.servicepostingList[r].companyPayingAmt)>i.servicepostingList[r].serviceRate?parseFloat(0):parseFloat(i.servicepostingList[r].companyPayingAmt)+e>=i.servicepostingList[r].actualRate?parseFloat(0):parseFloat((i.servicepostingList[r].serviceRate-parseFloat(i.servicepostingList[r].companyPayingAmt)).toFixed(2))-e,p.originalPayerAmount=null==i.servicepostingList[r].companyPayingAmt||0==i.servicepostingList[r].companyPayingAmt?parseFloat(0):parseFloat(i.servicepostingList[r].companyPayingAmt)>i.servicepostingList[r].serviceRate?i.servicepostingList[r].serviceRate:parseFloat(i.servicepostingList[r].companyPayingAmt)+e>=i.servicepostingList[r].actualRate?i.servicepostingList[r].serviceRate*i.servicepostingList[r].quantity:i.servicepostingList[r].companyPayingAmt+e>i.servicepostingList[r].serviceRate?i.servicepostingList[r].serviceRate:i.servicepostingList[r].companyPayingAmt+e,p.discountAmt=i.servicepostingList[r].discountAmt,p.doctorAmount=i.servicepostingList[r].doctorAmount,p.doctorShare=i.servicepostingList[r].doctorShare,p.hospitalShare=i.servicepostingList[r].hospitalShare,p.isRateEditable=i.servicepostingList[r].serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,p.serviceRate=i.servicepostingList[r].serviceRate,p.serviceRateStatus=i.servicepostingList[r].serviceRateStatus,p.standardDoctorShare=i.servicepostingList[r].standardDoctorShare,p.technicianAmount=i.servicepostingList[r].technicianAmount,p.baseRate=i.servicepostingList[r].baseRate,p.gnFlow=i.servicepostingList[r].gnFlow,p.pharamcyIssueServSeqId=i.servicepostingList[r].pharamcyIssueServSeqId,p.isPackage=2,p.packApplyType=2,i.servicepostingList[r].serviceRateVo&&i.servicepostingList[r].serviceRateVo.tariffSeqId&&(p.tariffSeqId=i.servicepostingList[r].serviceRateVo.tariffSeqId),i.servicepostingList[r].multiEmployeeShareList)if((c=i.servicepostingList[r].multiEmployeeShareList).employeeShareList&&c.employeeShareList[0])if((l=c.employeeShareList[0])["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"]){a=l["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"];if(Array.isArray(a))for(o=0;o<a.length;o++)2==a[o].entityType&&(p.billedShare=a[o].billedShare,p.proposedShare=a[o].proposedShare,p.employeeShareSeqId=a[o].employeeShareSeqId,p.docempSeqId=a[o].employee?a[o].employee.empSeqId:void 0);else p.billedShare=a.billedShare,p.proposedShare=a.proposedShare,p.employeeShareSeqId=a.employeeShareSeqId,p.docempSeqId=a.employee?a.employee.empSeqId:void 0}i.packageServicesArrayObejct.push(p)}}i.retrivePackageServObj[s.parentSeqId]=i.retrivePacServObj}i.showOrderLoadingIcon=!1})},i.changeDeductible=function(){if(i.gbcal.deductibleAmount=i.gbcal.deductibleAmount?i.gbcal.deductibleAmount:0,parseFloat(i.gbcal.Payr_Amt)<=parseFloat(i.gbcal.deductibleAmount))return i.gbcal.deductibleAmount=parseFloat(i.gbcal.Payr_Amt),i.gbcal.Payr_Amt=0,i.gbcal.Pat_Amt=angular.copy(parseFloat(i.Pat_Amt)+parseFloat(i.gbcal.deductibleAmount)).toFixed(2),i.gbcal.deductibleAmount=parseFloat(i.gbcal.deductibleAmount),i.gbcal.Payr_Amt=parseFloat(i.gbcal.Payr_Amt),void(i.gbcal.Pat_Amt=parseFloat(i.gbcal.Pat_Amt));parseFloat(i.gbcal.Total_Bill)>=parseFloat(i.gbcal.deductibleAmount)&&(i.gbcal.Payr_Amt=angular.copy(parseFloat(i.Payr_Amt)-parseFloat(i.gbcal.deductibleAmount)).toFixed(2),i.gbcal.Pat_Amt=angular.copy(parseFloat(i.Pat_Amt)+parseFloat(i.gbcal.deductibleAmount)).toFixed(2),i.gbcal.Pat_Amt=parseFloat(i.gbcal.Pat_Amt)),i.gbcal.deductibleAmount=parseFloat(i.gbcal.deductibleAmount),i.gbcal.Payr_Amt=parseFloat(i.gbcal.Payr_Amt),i.gbcal.Pat_Amt=parseFloat(i.gbcal.Pat_Amt)},i.orderSave=function(e){var t,r,a,o,n,c,l,p,d,m,u,S,y,D,g,A,h,R,f,C,b=[];i.showOrderLoadingIcon=!0;var q=new Date,O=moment(q).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z",L={};L.url=N.updateService.URL;sessionStorage.getItem("orderEncounterNo");var V,_=sessionStorage.getItem("orderregSeqId"),w=3,M=!1,F="",B=1,x=0,G=0,U=0,Q=!!i.projSpecApplicable&&i.projSpecApplicable,k=void 0,H=void 0,j=void 0;if(i.regTypeData&&i.regTypeData.encounterType&&3==i.regTypeData.encounterType)var Y=3;else Y=2;i.packageServicesArrayObejct=[];for(var W=0;W<i.RowsArr.length;W++){var $=2,z="",J=i.RowsArr[W][0].serviceTypeCODE;f=i.RowsArr[W][0].fromTariffRate,V=void 0;var Z=null==i.RowsArr[W][0].isPharmacyService||"Pharmacy Issues"!=i.RowsArr[W][0].isPharmacyService&&"Pharmacy Retruns"!=i.RowsArr[W][0].isPharmacyService?"N":"Y";1==J?(2==i.RowsArr[W][0].gnServDesign&&($=1,w=3,M=!0,z=i.RowsArr[W][0].isPrintToBill,angular.extend(i.packageServicesArrayObejct,i.RowsArr[W][0].packageServicesList)),a=i.RowsArr[W][0].servicePostingSeqId,o=i.RowsArr[W][0].servSeqId,n=i.RowsArr[W][0].requestedByEmpSeqID,c=i.RowsArr[W][0].requestedByEmpName,l=i.RowsArr[W][0].requestedByEmpType,p=i.RowsArr[W][0].quantity,d="Y"!=Z||null!=i.RowsArr[W][0].baseRate&&0!=i.RowsArr[W][0].baseRate?i.RowsArr[W][0].baseRate:i.RowsArr[W][0].serviceRate,i.RowsArr[W][0].gnFlow,m=i.RowsArr[W][0].facilityId,u=i.RowsArr[W][0].serviceRate,S="Y"!=Z||null!=i.RowsArr[W][0].actualRate&&0!=i.RowsArr[W][0].actualRate?i.RowsArr[W][0].actualRate:i.RowsArr[W][0].serviceRate,h=i.RowsArr[W][0].technicianAmount,y=i.RowsArr[W][0].doctorAmount,D=i.RowsArr[W][0].proposedShareAfterDiscount,null!=i.RowsArr[W][0].preAuthDone?i.RowsArr[W][0].patientAmount:null!=i.RowsArr[W][0].originalPayerAmount?parseFloat(i.RowsArr[W][0].originalPayerAmount)>i.RowsArr[W][0].actualRate?parseFloat(0):i.RowsArr[W][0].actualRate-parseFloat(i.RowsArr[W][0].originalPayerAmount):i.RowsArr[W][0].patientAmount,null!=i.RowsArr[W][0].preAuthDone?i.RowsArr[W][0].originalPayerAmount:null!=i.RowsArr[W][0].originalPayerAmount?parseFloat(i.RowsArr[W][0].originalPayerAmount)>i.RowsArr[W][0].actualRate?i.RowsArr[W][0].actualRate:i.RowsArr[W][0].originalPayerAmount:i.RowsArr[W][0].payerAmount,g=i.RowsArr[W][0].discountAmt,A=i.RowsArr[W][0].doctorShare,h=i.RowsArr[W][0].technicianAmount,R=i.RowsArr[W][0].payerTypeCode,F=i.RowsArr[W][0].appointReason,B=i.RowsArr[W][0].transType,x=i.RowsArr[W][0].proposedShare,G=i.RowsArr[W][0].billedShare,U=i.RowsArr[W][0].employeeShareSeqId,C=i.RowsArr[W][0].grpMstCode?i.RowsArr[W][0].grpMstCode:void 0,k=i.RowsArr[W][0].priServTypCode,H=i.RowsArr[W][0].deptCode,j=i.RowsArr[W][0].specilityCode,V=i.RowsArr[W][0].preAuthDone,t=i.RowsArr[W][0].updateServiceFlag,r=i.RowsArr[W][0].doctorModifiedAmount):null!=i.serviceTypeModel.serviceType&&108==i.serviceTypeModel.serviceType.CODE||(2==i.RowsArr[W][0].gnServDesign&&($=1,w=3,M=!0,z=i.RowsArr[W][0].isPrintToBill,angular.extend(i.packageServicesArrayObejct,i.RowsArr[W][0].packageServicesList)),a=i.RowsArr[W][0].servicePostingSeqId,o=i.RowsArr[W][0].servSeqId,n=i.RowsArr[W][0].requestedByEmpSeqID,c=i.RowsArr[W][0].requestedByEmpName,l=i.RowsArr[W][0].requestedByEmpType,p=i.RowsArr[W][0].quantity,d="Y"!=Z||null!=i.RowsArr[W][0].baseRate&&0!=i.RowsArr[W][0].baseRate?i.RowsArr[W][0].baseRate:i.RowsArr[W][0].serviceRate,i.RowsArr[W][0].gnFlow,m=i.RowsArr[W][0].facilityId,u=i.RowsArr[W][0].serviceRate,S=null==i.RowsArr[W][0].actualRate?i.RowsArr[W][0].serviceRate:"Y"!=Z||null!=i.RowsArr[W][0].actualRate&&0!=i.RowsArr[W][0].actualRate?i.RowsArr[W][0].actualRate:i.RowsArr[W][0].serviceRate,h=i.RowsArr[W][0].technicianAmount,y=i.RowsArr[W][0].doctorAmount,D=i.RowsArr[W][0].proposedShareAfterDiscount,null!=i.RowsArr[W][0].preAuthDone?parseFloat(i.RowsArr[W][0].originalPayerAmount)>S?parseFloat(0):S-parseFloat(i.RowsArr[W][0].originalPayerAmount):i.RowsArr[W][0].patientAmount,null!=i.RowsArr[W][0].preAuthDone?parseFloat(i.RowsArr[W][0].originalPayerAmount)>S?S:i.RowsArr[W][0].originalPayerAmount:i.RowsArr[W][0].payerAmount,g=i.RowsArr[W][0].discountAmt,A=i.RowsArr[W][0].doctorShare,h=i.RowsArr[W][0].technicianAmount,R=i.RowsArr[W][0].payerTypeCode,F=i.RowsArr[W][0].appointReason,B=i.RowsArr[W][0].transType,x=i.RowsArr[W][0].proposedShare,G=i.RowsArr[W][0].billedShare,U=i.RowsArr[W][0].employeeShareSeqId,C=i.RowsArr[W][0].grpMstCode?i.RowsArr[W][0].grpMstCode:void 0,k=i.RowsArr[W][0].priServTypCode,H=i.RowsArr[W][0].deptCode,j=i.RowsArr[W][0].specilityCode,V=i.RowsArr[W][0].preAuthDone,t=i.RowsArr[W][0].updateServiceFlag,r=i.RowsArr[W][0].doctorModifiedAmount);var K=i.RowsArr[W][0].servicePostingType?i.RowsArr[W][0].servicePostingType:1;if(null!=a){var X={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",updateServicePostingFlag:!t&&void 0,servicePostingSeqId:a,isPharmacyService:Z,accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:K,isPackage:$,packApplyType:w,specific:Q,parentServSeqId:1==$?o:void 0,lbSeqId:i.RowsArr[W][0].lbSeqId?i.RowsArr[W][0].lbSeqId:void 0,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:o},requestedByEmpSeqID:n,requestedByEmpName:c,requestedByEmpType:l,requestedDateTime:O,quantity:p,isPostBillApplicable:i.RowsArr[W][0].isPostBillApplicable?i.RowsArr[W][0].isPostBillApplicable:0,primaryServiceCode:k,specilityCode:j,deptCode:H,serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:o,baseRate:d,tariffSeqId:i.RowsArr[W][0].payerTarrifId?i.RowsArr[W][0].payerTarrifId:s.tariffSeqId?s.tariffSeqId:void 0,datedOn:O,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},enNo:sessionStorage.getItem("ordervisitId"),enSeqId:sessionStorage.getItem("orderencounterSeqId"),patientCategoryCode:sessionStorage.getItem("patcatg"),facilityId:m,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnTranStatus:3==K?2:1,gnFlow:Y,surcharge:0,serviceRate:u,baseRate:d,actualRate:S,currentChargableAmt:parseFloat(parseFloat(S/p).toFixed(2)),technicianAmount:h,doctorAmount:y,proposedShareAfterDiscount:D,doctorModifiedAmount:r||0,chargeableAmt:parseFloat(parseFloat(S/p).toFixed(2)),nonChargableAmt:void 0,companyNonPayingAmt:a?V?i.RowsArr[W][0].originalPatientAmount:i.RowsArr[W][0].patientAmount:void 0,companyPayingAmt:a?V?i.RowsArr[W][0].originalPayerAmount:i.RowsArr[W][0].payerAmount:void 0,discountAmt:g,doctorShare:A,isEmergency:2,renderFlagcheck:!0,payerId:R,insurancePlanSeqId:null!=i.RowsArr[W][0].insurancePlanSeqId&&null!=i.RowsArr[W][0].insurancePlanSeqId?i.RowsArr[W][0].insurancePlanSeqId:void 0,refTranSeqID:i.RowsArr[W][0].lbSeqId?i.RowsArr[W][0].lbSeqId:i.RowsArr[W][0].refTranSeqID,fromOPVisit:"Y",priority:i.RowsArr[W][0].visitTypeCode,isPrintToBill:z,visitConfigOrRateCard:f,opApmntSeqId:i.RowsArr[W][0].opApmntSeqId?i.RowsArr[W][0].opApmntSeqId:void 0,appointReason:F,transType:B,multiEmployeeShareList:{"@class":"com.napier.core.scm.serviceposting.vo.EmployeeShareListVo",employeeShareList:[{"com.napier.core.scm.serviceposting.vo.EmployeeShareVo":[{"@class":"com.napier.core.scm.serviceposting.vo.EmployeeShareVo",employee:{category:"001",code:c,empSeqId:n,facilityId:angular.fromJson(sessionStorage.userContextObj).FACILITY_ID,gnStatus:1},entityType:2,employeeShareSeqId:U,billedShare:G,proposedShare:x,gnTranStatus:1,grpMstCode:C||void 0}]}]}};b.push(X)}else{X={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",updateServicePostingFlag:!1,servicePostingSeqId:a,isPharmacyService:Z,accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,isPackage:$,packApplyType:w,specific:Q,parentServSeqId:1==$?o:void 0,lbSeqId:i.RowsArr[W][0].lbSeqId?i.RowsArr[W][0].lbSeqId:void 0,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:o},requestedByEmpSeqID:n,requestedByEmpName:c,requestedByEmpType:l,requestedDateTime:O,quantity:p,isPostBillApplicable:i.RowsArr[W][0].isPostBillApplicable?i.RowsArr[W][0].isPostBillApplicable:0,primaryServiceCode:k,specilityCode:j,deptCode:H,serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:o,baseRate:d,tariffSeqId:i.RowsArr[W][0].payerTarrifId?i.RowsArr[W][0].payerTarrifId:s.tariffSeqId?s.tariffSeqId:void 0,datedOn:O,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},enNo:sessionStorage.getItem("ordervisitId"),enSeqId:sessionStorage.getItem("orderencounterSeqId"),patientCategoryCode:sessionStorage.getItem("patcatg"),facilityId:m,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnTranStatus:1,gnFlow:Y,surcharge:0,serviceRate:u,baseRate:d,actualRate:S,currentChargableAmt:parseFloat(parseFloat(S/p).toFixed(2)),technicianAmount:h,doctorAmount:y,proposedShareAfterDiscount:D,doctorModifiedAmount:r||0,chargeableAmt:parseFloat(parseFloat(S/p).toFixed(2)),companyNonPayingAmt:a?V?i.RowsArr[W][0].originalPatientAmount:i.RowsArr[W][0].patientAmount:void 0,companyPayingAmt:a?V?i.RowsArr[W][0].originalPayerAmount:i.RowsArr[W][0].payerAmount:void 0,nonChargableAmt:void 0,discountAmt:g,doctorShare:A,isEmergency:2,renderFlagcheck:!0,payerId:R,insurancePlanSeqId:null!=i.RowsArr[W][0].insurancePlanSeqId&&null!=i.RowsArr[W][0].insurancePlanSeqId?i.RowsArr[W][0].insurancePlanSeqId:void 0,refTranSeqID:i.RowsArr[W][0].lbSeqId?i.RowsArr[W][0].lbSeqId:i.RowsArr[W][0].refTranSeqID,fromOPVisit:"Y",priority:i.RowsArr[W][0].visitTypeCode,isPrintToBill:z,visitConfigOrRateCard:f,opApmntSeqId:i.RowsArr[W][0].opApmntSeqId?i.RowsArr[W][0].opApmntSeqId:void 0,appointReason:F,transType:B,multiEmployeeShareList:{"@class":"com.napier.core.scm.serviceposting.vo.EmployeeShareListVo",employeeShareList:[{"com.napier.core.scm.serviceposting.vo.EmployeeShareVo":[{"@class":"com.napier.core.scm.serviceposting.vo.EmployeeShareVo",employee:{category:"001",code:c,empSeqId:n,facilityId:angular.fromJson(sessionStorage.userContextObj).FACILITY_ID,gnStatus:1},entityType:2,billedShare:G,proposedShare:x,gnTranStatus:1,grpMstCode:C||void 0}]}]}};b.push(X)}}if(M){for(var ee=0;ee<i.packageServicesArrayObejct.length;ee++){X={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",updateServicePostingFlag:!1,servicePostingSeqId:i.packageServicesArrayObejct[ee].servicePostingSeqId,isPharmacyService:Z,accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:i.packageServicesArrayObejct[ee].servicePostingType?i.packageServicesArrayObejct[ee].servicePostingType:1,specific:Q,isPackage:i.packageServicesArrayObejct[ee].isPackage,packApplyType:i.packageServicesArrayObejct[ee].packApplyType,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.packageServicesArrayObejct[ee].servSeqId},requestedByEmpSeqID:i.packageServicesArrayObejct[ee].requestedByEmpSeqID,requestedByEmpName:i.packageServicesArrayObejct[ee].requestedByEmpName,requestedByEmpType:i.packageServicesArrayObejct[ee].requestedByEmpType,requestedDateTime:O,quantity:p,isPostBillApplicable:i.packageServicesArrayObejct[ee].isPostBillApplicable?i.packageServicesArrayObejct[ee].isPostBillApplicable:0,primaryServiceCode:k,specilityCode:j,deptCode:H,serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.packageServicesArrayObejct[ee].servSeqId,baseRate:i.packageServicesArrayObejct[ee].baseRate,tariffSeqId:i.packageServicesArrayObejct[ee].tariffSeqId?i.packageServicesArrayObejct[ee].tariffSeqId:s.tariffSeqId?s.tariffSeqId:void 0,datedOn:O,fromOPVisit:"Y",doctSeqId:i.packageServicesArrayObejct[ee].requestedByEmpSeqID,specSeqId:i.packageServicesArrayObejct[ee].specilityCode?i.packageServicesArrayObejct[ee].specilityCode:void 0},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},enNo:sessionStorage.getItem("ordervisitId"),enSeqId:sessionStorage.getItem("orderencounterSeqId"),patientCategoryCode:sessionStorage.getItem("patcatg"),facilityId:i.packageServicesArrayObejct[ee].facilityId,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnTranStatus:1,gnFlow:Y,surcharge:0,serviceRate:i.packageServicesArrayObejct[ee].serviceRate,baseRate:i.packageServicesArrayObejct[ee].baseRate,actualRate:i.packageServicesArrayObejct[ee].actualRate,currentChargableAmt:parseFloat(parseFloat(i.packageServicesArrayObejct[ee].actualRate/p).toFixed(2)),technicianAmount:i.packageServicesArrayObejct[ee].technicianAmount,doctorAmount:i.packageServicesArrayObejct[ee].doctorAmount,proposedShareAfterDiscount:i.packageServicesArrayObejct[ee].proposedShareAfterDiscount,doctorModifiedAmount:r||0,chargeableAmt:i.packageServicesArrayObejct[ee].patientAmount,nonChargableAmt:i.packageServicesArrayObejct[ee].payerAmount,discountAmt:i.packageServicesArrayObejct[ee].discountAmt,doctorShare:i.packageServicesArrayObejct[ee].doctorShare,isEmergency:2,renderFlagcheck:!0,payerId:i.packageServicesArrayObejct[ee].payerTypeCode,insurancePlanSeqId:null!=i.packageServicesArrayObejct[ee].insurancePlanSeqId&&null!=i.packageServicesArrayObejct[ee].insurancePlanSeqId?i.packageServicesArrayObejct[ee].insurancePlanSeqId:void 0,fromOPVisit:"Y",priority:i.packageServicesArrayObejct[ee].visitTypeCode,isPrintToBill:"",visitConfigOrRateCard:f,appointReason:i.packageServicesArrayObejct[ee].appointReason,transType:i.packageServicesArrayObejct[ee].transType,parentServSeqId:i.packageServicesArrayObejct[ee].parentServSeqId,multiEmployeeShareList:{"@class":"com.napier.core.scm.serviceposting.vo.EmployeeShareListVo",employeeShareList:[{"com.napier.core.scm.serviceposting.vo.EmployeeShareVo":[{"@class":"com.napier.core.scm.serviceposting.vo.EmployeeShareVo",employee:{category:"001",empSeqId:i.packageServicesArrayObejct[ee].docempSeqId?i.packageServicesArrayObejct[ee].docempSeqId:i.packageServicesArrayObejct[ee].requestedByEmpSeqID},entityType:2,billedShare:i.packageServicesArrayObejct[ee].billedShare,proposedShare:i.packageServicesArrayObejct[ee].proposedShare,gnTranStatus:1,grpMstCode:i.packageServicesArrayObejct[ee].grpMstCode?i.packageServicesArrayObejct[ee].grpMstCode:void 0}]}]}};b.push(X)}for(var te=0;te<i.retrivePackageDeletedServObj.length;te++){X={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",updateServicePostingFlag:!1,servicePostingSeqId:i.retrivePackageDeletedServObj[te].servicePostingSeqId,isPharmacyService:Z,accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:i.retrivePackageDeletedServObj[0].servicePostingType?i.retrivePackageDeletedServObj[0].servicePostingType:1,specific:Q,isPackage:i.packageServicesArrayObejct[0].isPackage,packApplyType:i.packageServicesArrayObejct[0].packApplyType,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.retrivePackageDeletedServObj[te].INCL_SERV_SEQ_ID},requestedByEmpSeqID:i.retrivePackageDeletedServObj[te].serviceDoc,requestedByEmpType:4,requestedDateTime:O,quantity:p,isPostBillApplicable:i.retrivePackageDeletedServObj[te].isPostBillApplicable?i.retrivePackageDeletedServObj[te].isPostBillApplicable:0,primaryServiceCode:k,specilityCode:j,deptCode:H,serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.retrivePackageDeletedServObj[te].INCL_SERV_SEQ_ID,baseRate:i.retrivePackageDeletedServObj[te].INCL_AMOUNT,tariffSeqId:s.tariffSeqId?s.tariffSeqId:void 0,datedOn:O,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},enNo:sessionStorage.getItem("ordervisitId"),enSeqId:sessionStorage.getItem("orderencounterSeqId"),patientCategoryCode:sessionStorage.getItem("patcatg"),facilityId:i.retrivePackageDeletedServObj[te].facilityId,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnTranStatus:2,gnFlow:Y,surcharge:0,serviceRate:i.retrivePackageDeletedServObj[te].INCL_AMOUNT,baseRate:i.retrivePackageDeletedServObj[te].INCL_AMOUNT,actualRate:i.retrivePackageDeletedServObj[te].INCL_AMOUNT,chargeableAmt:i.retrivePackageDeletedServObj[te].INCL_AMOUNT,currentChargableAmt:parseFloat(parseFloat(i.retrivePackageDeletedServObj[te].INCL_AMOUNT).toFixed(2)),isEmergency:2,renderFlagcheck:!0,payerId:i.packageServicesArrayObejct[0].payerTypeCode,fromOPVisit:"Y",priority:i.packageServicesArrayObejct[0].visitTypeCode,isPrintToBill:"",visitConfigOrRateCard:f,parentServSeqId:i.retrivePackageDeletedServObj[te].parentSeqId};b.push(X)}}L.requestData={operation:"saveOrUpdateServicePosting",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":b}]}},P.sendRestRequest(L).then(function(t){if(i.showOrderLoadingIcon=!1,""==t.data.HITService.message||null==t.data.HITService.message.subAccSeqId)v.warning("Failure","Order Saving Failed",!1,!1,me.time);else if("HSC"===sessionStorage.productCustomization){I.executeQueryURLReset();i.accountSeqList=new Array,i.checkListServSeqId=[];var r="";try{if(null!=(p=t.data.HITService.message.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"]).length)for(var a=0;a<p.length;a++)i.checkListServSeqId.push(p[a].serviceVo.servSeqId);else r=p.serviceVo.servSeqId;i.checkListServSeqId.length>1&&(r=i.checkListServSeqId.join(","));var o={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"PKG_CHKLIST_MASTER_DTLS_COUNT",idxList:[{"com.napier.core.service.vo.query.Index":[{paramName:"pServiceSeqID",value:r}]}]}]}]},n={};n.url=N.patientAdvSservice.URL,n.requestData={operation:"ExecuteQuery",messageId:"",destination:"QueryService",message:o},P.sendRestRequest(n).then(function(e){var t=[],r=[];if(null!=e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"]){var a=e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"];if(null!=a.length){for(var o=0;o<a.length;o++)r.push(a[o].columnList[0]["com.napier.core.service.vo.query.Column"]);t=r}else t=a.columnList[0]["com.napier.core.service.vo.query.Column"]}for(o=0;o<t.length;o++)i.hscCheckListCount.push(t[o].data);i.checkListServSeqIdInner=null!=i.hscCheckListCount.length&&0!=i.hscCheckListCount.length?i.hscCheckListCount:t.data,Array.isArray(i.checkListServSeqIdInner)&&(i.checkListServSeqIdInner=i.checkListServSeqIdInner.join(","))})}catch(e){}var c={buttonClose:function(){i.packageServicesArrayObejct=new Array,i.activeFirst=3,T(function(){E.dismissAll(),i.getPrescptionCount()},3e3)}},l={buttonCallBack1:function(){E.dismissAll(),i.packageCheckListReprint()},buttonCallBack2:function(){i.generatePdfReport()}};if(v.hisAlertMulti("success","Success","Do you want to print orders?",{buttonText:"No",buttonText2:"Yes"},l,c),i.checkOrderSaved=!1,i.loadBillNumbers(s.mrNo),i.retriveRecords(),"Y"==i.integrationApplicableFlag){var p=t.data.HITService.message.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"],d="";if(Array.isArray(p))for(a=0;a<p.length;a++)d=0==a?p[a].servicePostingSeqId:d+","+p[a].servicePostingSeqId;else d=p.servicePostingSeqId;Array.isArray(p)||(p[0]=p),re.prepareOrderObject(d,p,_,"Admission","sendOrderFinalizedReportForRis","com.napier.his.integration.service.external.RisService",re).then(function(e){})}}else{if(null==e&&v.success("Success","Order Saved Successfully",!1,!1,me.time),i.preAuthBtnShow=0,i.preAuthBillNav=!1,i.packageServicesArrayObejct=new Array,"Y"==i.integrationApplicableFlag){p=t.data.HITService.message.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"],d="";if(Array.isArray(p))for(a=0;a<p.length;a++)d=0==a?p[a].servicePostingSeqId:d+","+p[a].servicePostingSeqId;else d=p.servicePostingSeqId;Array.isArray(p)||(p[0]=p),re.prepareOrderObject(d,p,_,"Admission","sendOrderFinalizedReportForRis","com.napier.his.integration.service.external.RisService",re).then(function(e){})}i.activeFirst=3,T(function(){E.dismissAll(),i.loadBillNumbers(s.mrNo),i.retriveRecords(),i.getPrescptionCount()},3e3)}})},i.loadServiceTypeCombo=function(){i.serviceTypeorder=[],i.serviceTypeOrderList={1:i.serviceTypeorder};var e=I.executeQueryURLReset();return i.serviceTypeListorder=new Array,I.executeQueryInput("OP_ORDERS_SERVICE_TYPE_QUERY_001",i.serviceTypeListorder,i.serviceTypeOrderList,!0,!0,e,"popUp",i.advSearch).then(function(e){var t=e[1];i.servicetypeComboObj=t})}(),i.popServiceChange=function(e){if(i.advserviceType=angular.copy(e),i.serviceTypeModel.serviceType=angular.copy(e),1!=i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID){i.PriorityCombo=[],i.PriorityComboList={1:i.PriorityCombo};var t=I.executeQueryURLReset();i.priorityCombosList=new Array,I.prepareParamList(1,850,i.priorityCombosList),I.executeQueryInput("TRN003",i.priorityCombosList,i.PriorityComboList,!0,!0,t,"popUp",{}).then(function(e){i.PriorityComboList=e[1],i.priorityvis.priorityTypeModel=i.PriorityComboList[0],i.hidepriorityTypeComboRef=!0,i.hidevisitTypeComboRef=!1})}else{sessionStorage.getItem("orderdoctSeqId"),sessionStorage.getItem("orderregSeqId");i.payerId,i.priorityvis.priorityTypeModel="",i.hidepriorityTypeComboRef=!1,i.hidevisitTypeComboRef=!0}i.priorityvis.visitTypeModel="New",i.loadSecondaryServiceTypeCombo()},i.loadSecondaryServiceTypeCombo=function(){i.secondayServiceTypeComboObj=[];var t=-999;if(null!=i.advserviceTypeModel.serviceType&&null!=i.advserviceTypeModel.serviceType.CODE){t=i.advserviceTypeModel.serviceType.CODE;var r=e.defer(),a={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"SCM_SERV_002",idxList:[{"com.napier.core.service.vo.query.Index":[{paramName:"pPracticeId",value:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID},{paramName:"pPriServTypeCode",value:t}]}]}]}]},o={};return o.url=N.patientAdvSservice.URL,o.requestData={operation:"ExecuteQuery",messageId:"",destination:"QueryService",message:a},P.sendRestRequest(o).then(function(e){var t=[],a=function(e){return e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"]}(e);if(Array.isArray(a))angular.forEach(a,function(e,r){var a=e.columnList[0]["com.napier.core.service.vo.query.Column"],i={CODE:a[0].data,DESCRIPTION:a[1].data};t.push(i)});else{var o=a.columnList[0]["com.napier.core.service.vo.query.Column"],s={CODE:o[0].data,DESCRIPTION:o[1].data};t.push(s)}r.resolve(t),i.secondayServiceTypeComboObj=t},function(e){}),r.promise}},i.orderServiceTypeAhead=function(e){var t="%"+e+"%";i.OPVMDoctroSearch=[],i.multipleComboDataForList={1:i.OPVMDoctroSearch};var r=I.executeQueryURLReset();i.OPVMDoctSearch=new Array;var a=2,o=1,n=1,c="-999",l=7,p=0;if(null!=i.serviceTypeModel.serviceType&&(p=i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID),i.serviceTypeModel.serviceType){var d="";return(d=null!=i.advserviceType?i.advserviceType.CODE:"")&&""!=d||null==i.serviceTypeModel.serviceType||(d=i.serviceTypeModel.serviceType.CODE),3==p&&(a=2,o=2,n="",c="",l=""),I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.OPVMDoctSearch),I.prepareParamListWithParam("pFacilityId",angular.fromJson(sessionStorage.userContextObj).FACILITY_ID,i.OPVMDoctSearch),I.prepareParamListWithParam("pServCode","%%",i.OPVMDoctSearch),I.prepareParamListWithParam("pServName",t,i.OPVMDoctSearch),I.prepareParamListWithParam("pPriServTypeCode",d,i.OPVMDoctSearch),I.prepareParamListWithParam("pSecServTypeCode","",i.OPVMDoctSearch),I.prepareParamListWithParam("pServTypeCode","",i.OPVMDoctSearch),I.prepareParamListWithParam("pServDesign",o,i.OPVMDoctSearch),I.prepareParamListWithParam("pFlowElement",a,i.OPVMDoctSearch),I.prepareParamListWithParam("pServStatus","",i.OPVMDoctSearch),I.prepareParamListWithParam("pServDefStatus",n,i.OPVMDoctSearch),I.prepareParamListWithParam("pDepartment","",i.OPVMDoctSearch),I.prepareParamListWithParam("pIsEmergency",c,i.OPVMDoctSearch),I.prepareParamListWithParam("pExcludePri",l,i.OPVMDoctSearch),3!=p&&I.prepareParamListWithParam("pTariffCode",s.tariffSeqId,i.OPVMDoctSearch),I.executeQueryInput("OP_SCM_SERVICE_LIST_WITH_OUT_RATES",i.OPVMDoctSearch,i.multipleComboDataForList,!0,!0,r,"popUp",{}).then(function(e){if(0!==e)return(e[1]instanceof Array?e[1]:[e[1]]).map(function(e){return e});i.noResults=!0})}i.OPVMDoctroSearchService=[],i.multipleComboDataForListService={1:i.OPVMDoctroSearchService};var m=[];return I.prepareParamListWithParam("pServName",t,m),I.executeQueryInput("OP_SCM_SERVICE_LIST_WITH_OUT_SERV_TYPE",m,i.multipleComboDataForListService,!0,!0,r,"popUp",{}).then(function(e){if(0!==e)return(Array.isArray(e[1])?e[1]:[e[1]]).map(function(e){return e});i.noResults=!0})},i.addSelectService=!0,i.AdvServiceSearch=function(e){if(!(i.advserviceTypeModel.serviceType||i.advserviceTypeModel.secondayServiceType||e.servicename||e.servicecode))return v.warning("Warning!","Please Select Atleast One Service Type",!1,!1,me.time),!1;i.addSelectService=!1;var t="%%",r="",a=-999,o=-999;e&&(e.servicename&&""!=e.servicename&&(t="%"+e.servicename+"%"),e.servicecode&&""!=e.servicecode&&(r="%"+e.servicecode+"%")),null!=i.advserviceTypeModel.serviceType&&(a=i.advserviceTypeModel.serviceType.CODE),null!=i.advserviceTypeModel.secondayServiceType&&(o=i.advserviceTypeModel.secondayServiceType.CODE),i.advServicename=[],i.advServicenamesList={1:i.advServicename};var n=0;i.serviceTypeModel.serviceType&&!i.serviceTypeModel.serviceType||(i.serviceTypeModel.serviceType=i.advserviceTypeModel.serviceType),null!=i.serviceTypeModel.serviceType&&(n=i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID);var c=I.executeQueryURLReset();return i.advServiceList=new Array,3==n?(I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.advServiceList),I.prepareParamListWithParam("pFacilityId",ye,i.advServiceList),I.prepareParamListWithParam("pServCode",r,i.advServiceList),I.prepareParamListWithParam("pServName",t,i.advServiceList),I.prepareParamListWithParam("pServTypeCode","",i.advServiceList),I.prepareParamListWithParam("pPriServTypeCode",a,i.advServiceList),I.prepareParamListWithParam("pSecServTypeCode",o,i.advServiceList),I.prepareParamListWithParam("pServTypeCode","",i.advServiceList),I.prepareParamListWithParam("pServDesign",2,i.advServiceList),I.prepareParamListWithParam("pFlowElement",2,i.advServiceList),I.prepareParamListWithParam("pServStatus","",i.advServiceList),I.prepareParamListWithParam("pServDefStatus","",i.advServiceList),I.prepareParamListWithParam("pDepartment","",i.advServiceList),I.prepareParamListWithParam("pIsEmergency","",i.advServiceList),I.prepareParamListWithParam("pExcludePri","",i.advServiceList),I.executeQueryInput("SCM_SERVICE_LIST_WITH_OUT_RATES_ALPHA",i.advServiceList,i.advServicenamesList,!0,!0,c,"popUp",{}).then(function(e){var t=e[1];i.AdvserviceGrid.data=[];for(var r=0;r<t.length;r++)i.AdvserviceGrid.data.push({CODE:t[r].CODE,DESCRIPTION:t[r].DESCRIPTION,SERV_CODE:t[r].SERV_CODE,SERV_NAME:t[r].SERV_NAME,SERV_SEQ_ID:t[r].SERV_SEQ_ID,VALUE:t[r].VALUE})})):(I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.advServiceList),I.prepareParamListWithParam("pFacilityId",ye,i.advServiceList),I.prepareParamListWithParam("pServCode",r,i.advServiceList),I.prepareParamListWithParam("pServName",t,i.advServiceList),I.prepareParamListWithParam("pPriServTypeCode",a,i.advServiceList),I.prepareParamListWithParam("pSecServTypeCode",o,i.advServiceList),I.prepareParamListWithParam("pServTypeCode","",i.advServiceList),I.prepareParamListWithParam("pServDesign","",i.advServiceList),I.prepareParamListWithParam("pFlowElement","2",i.advServiceList),I.prepareParamListWithParam("pServStatus","1",i.advServiceList),I.prepareParamListWithParam("pServDefStatus","1",i.advServiceList),I.prepareParamListWithParam("pDepartment","",i.advServiceList),I.prepareParamListWithParam("pIsEmergency","-999",i.advServiceList),I.prepareParamListWithParam("pExcludePri","7",i.advServiceList),I.prepareParamListWithParam("pTariffCode",s.tariffSeqId,i.advServiceList),I.executeQueryInput("SCM_SERVICE_LIST_NEW_OP_ALPHA",i.advServiceList,i.advServicenamesList,!0,!0,c,"popUp",{}).then(function(e){var t=e[1];i.AdvserviceGrid.data=[];for(var r=0;r<t.length;r++)i.AdvserviceGrid.data.push({SERV_SEQ_ID:t[r].SERV_SEQ_ID,SERV_CODE:t[r].SERV_CODE,SERV_NAME:t[r].SERV_NAME,VALUE:t[r].VALUE,EFFECTIVE_FROM:t[r].EFFECTIVE_FROM,EFFECTIVE_TO:t[r].EFFECTIVE_TO,FA_IS_BILLABLE:t[r].FA_IS_BILLABLE,CODE:t[r].CODE,DESCRIPTION:t[r].DESCRIPTION,SSTCODE:t[r].SSTCODE,SSTDESC:t[r].SSTDESC,FA_IS_RATE_EDITABLE:t[r].FA_IS_RATE_EDITABLE})}))},i.bookAppointment=function(){i.PatientAndDoctorData={orderDoctDetails:i.orderDoctDetails,PatientDetailsData:i.PatientDetailsData,PatientDetailsDataObj:i.PatientDetailsDataObj,redirectingFromOpVisit:"redirectingFromOpVisit"},sessionStorage.removeItem("PatientAndDoctorData"),sessionStorage.setItem("PatientAndDoctorData",JSON.stringify(i.PatientAndDoctorData)),i.PatientAndDoctorData={},i.modalInstance=S.open("Book Appointment",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popuervice-modals-popups",templateUrl:"app/consumer/his17_1/scheduler/screens/book-appointment/book.appointment.html",size:"xlg",controller:"bookAppointmentNewController",controllerAs:"bookAppointment",scope:i})},i.healhCheckUpExpanded=!1,i.healhCheckUpExpand=function(e){e.healhCheckUpExpanded=!e.healhCheckUpExpanded},i.healhCheckUpExpanded2=!1,i.healhCheckUpExpand2=function(){i.healhCheckUpExpanded2=!i.healhCheckUpExpanded2},i.mlcNumberGenerate=function(t,r){if(i.submit=!1,!0===t)if(""==i.tempMlcNum){var a=e.defer(),o={url:"HISServices/HISServices",requestData:{operation:"getMLCNo",messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.MLCDetailsVo"}}};P.sendRestRequest(o).then(function(e){var t=e.data.HITService.message;i.Mlc.OPVMmlcNo=t,i.tempMlcNum=t,a.resolve()})}else i.Mlc.OPVMmlcNo=i.tempMlcNum;else i.Mlc={OPVMmlcDetails:!1}},i.setRefundRounding=function(){if(1==i.refund.mode){var e=ue.roundoff(i.refund.RefdAmt),t=parseFloat(e)-parseFloat(i.refund.RefdAmt);i.refund.RefdAmt=e,i.refund.roundOff=t.toFixed(2)}else i.refund.roundOff=0},i.calculateGBData=function(){if(i.gbBillNo.billno&&"Unbilled"==i.gbBillNo.billno)var e=i.gridgbOptionsApi.selection.getSelectedRows();else 0==(e=i.getActivebillRecords()).length&&(e=i.gridgbOptions.data);var t=i.gridgbdepOptionsApi.selection.getSelectedRows(),r=0,a=0,o=0,s=0,n=0,c=0,l=0,p=0,d=0,m=0,u=0,v=0,S=0,y=0,D=0,g=0,A=0,I=0,P=0,h=0,R=0,f=0,T=0,C=0,b=0,E=0,q=0,O=0,L=0,V=0;angular.forEach(e,function(e,t){7!=e.gnTranStatus&&7!=e.billStatus&&(e.baseRate&&e.quantity>0&&(r=parseFloat(r)+parseFloat(e.baseRate)*parseFloat(e.quantity),""!=e.discountAmt&&(a=parseFloat(a)+parseFloat(e.discountAmt)),""!=e.taxAmount&&(m=parseFloat(m)+parseFloat(e.taxAmount))),g=e.detableAmount?e.detableAmount:0,e.copayAmt&&(A+=e.copayAmt),e.PatAmt&&(u=parseFloat(u)+parseFloat(e.PatAmt)),e.payerAmt&&(v=parseFloat(v)+parseFloat(e.payerAmt)),null!=e.dueAmt&&0!=e.dueAmt&&0==l&&(l=parseFloat(l)+parseFloat(e.dueAmt)),null!=e.PaidAmt&&e.PaidAmt>0&&0==c&&(c=parseFloat(c)+parseFloat(e.PaidAmt)),e.depAdjAmt&&e.depAdjAmt>0&&0==o&&(o=parseFloat(o)+parseFloat(e.depAdjAmt)),0!=e.PatAmt&&0==e.payerAmt&&(D=parseFloat(D)+parseFloat(e.PatAmt)),null!=e.patientPaidAmnt&&e.patientPaidAmnt>0&&0==I&&(I=parseFloat(I)+parseFloat(e.patientPaidAmnt)),null!=e.payerPaidAmnt&&e.payerPaidAmnt>0&&0==P&&(P=parseFloat(P)+parseFloat(e.payerPaidAmnt))),null!=e.crNoteAmount&&0!=e.crNoteAmount&&0==f&&(f=parseFloat(e.crNoteAmount)),null!=e.concessionAmt&&0!=e.concessionAmt&&0==V&&(V=parseFloat(e.concessionAmt))}),T=parseFloat(u),C=parseFloat(v),b=parseFloat(T)+parseFloat(C),n=parseFloat(r)-parseFloat(a)+parseFloat(m),0==c&&0==l&&0==o&&0==V&&(l=n);var N=i.deductibleAmount;i.insurancePlanDedSeqId&&i.accountres&&1!=i.accountres.SUB_ACC_SEQ_ID||g>0?(N="Unbilled"==i.gbBillNo.billno?N||0:g||0,parseFloat(v)<=parseFloat(N)?(N=parseFloat(v),v=0,u=parseFloat(u)+parseFloat(N)):parseFloat(r)>=parseFloat(N)&&(v=parseFloat(v)-parseFloat(N),u=parseFloat(u)+parseFloat(N))):N=0,!i.gbBillNo.billno||"Unbilled"==i.gbBillNo.billno||i.gbBillNo.billno.indexOf("OPCS"),y=parseFloat(u)-parseFloat(I)-parseFloat(o),l<y&&(y=l),i.gbBillNo.billno&&"Unbilled"==i.gbBillNo.billno&&(y=parseFloat(D)),i.gridConcReqOptions.data.length>0&&(angular.forEach(i.gridConcReqOptions.data,function(e,t){if(1==e.billService&&(1==e.billConcType&&(d=parseFloat(d)+parseFloat(e.billReqConcAmt)),2==e.billConcType&&(p=parseFloat(p)+parseFloat(e.billReqConcAmt))),2==e.billService&&e.serviceConcList&&e.serviceConcList.length>0)for(var r=e.serviceConcList,a=0;a<r.length;a++)parseFloat(r[a].concReqAmt)>0&&(p=parseFloat(p)+parseFloat(r[a].concReqAmt));e.concessionReqSeqId&&e.billReqAmt&&(S=parseFloat(S)+parseFloat(e.billReqAmt))}),d>0&&(p=parseFloat(p)+parseFloat(D)*(parseFloat(d)/100)),l=parseFloat(l)-parseFloat(p),p=parseFloat(p)+parseFloat(S),y>0&&(y=parseFloat(y)-parseFloat(p)+parseFloat(S)));var _=0,w=0;if(i.gridGbPaymentOptions.data.length>0&&angular.forEach(i.gridGbPaymentOptions.data,function(e,t){1==e.payerRadType&&(_=parseFloat(_)+parseFloat(e.amtPaid)),2==e.payerRadType&&(w=parseFloat(w)+parseFloat(e.amtPaid))}),i.deposit&&2==i.deposit.Type){var M=0;angular.forEach(t,function(e,t){e.appliedAmount=0,e.availableAmount=parseFloat(e.availableDefAmount),e.appliedAmount=e.availableAmount.toFixed(2),M=parseFloat(M)+parseFloat(e.appliedAmount),e.availableAmount=0}),i.refund.RefdAmt=M.toFixed(2),s=0,i.setRefundRounding()}else angular.forEach(t,function(e,t){e.appliedAmount=0,e.availableAmount=parseFloat(e.availableDefAmount),l>0&&e.availableAmount>0&&parseFloat(y)-parseFloat(_)>=0&&(parseFloat(y)-parseFloat(_)<=e.availableAmount?(e.appliedAmount=parseFloat(y)-parseFloat(_),l=parseFloat(l)-parseFloat(e.appliedAmount)):(e.appliedAmount=parseFloat(e.availableAmount),l=parseFloat(l)-parseFloat(e.appliedAmount))),e.appliedAmount=parseFloat(e.appliedAmount).toFixed(2),e.availableAmount=parseFloat(e.availableAmount)-parseFloat(e.appliedAmount),e.availableAmount=e.availableAmount.toFixed(2),y=parseFloat(y)-parseFloat(e.appliedAmount),s=parseFloat(s)+parseFloat(e.appliedAmount)}),i.refund.RefdAmt=0;i.gbBillNo.billno&&"Unbilled"==i.gbBillNo.billno&&(L=parseFloat(y)),o>0&&(s=parseFloat(s)+parseFloat(o)),(h=parseFloat(u)-parseFloat(s)-parseFloat(I)-parseFloat(p))<0&&(h=0),(R=parseFloat(v)-parseFloat(P))<0&&(R=0),l<=0&&(h=0,R=0),E=parseFloat(T)+parseFloat(N)-parseFloat(p),q=parseFloat(C)-parseFloat(N),O=parseFloat(E)+parseFloat(q);var F={Total_Bill:r.toFixed(2),Total_Discount:a.toFixed(2),Deposite_Adj:s.toFixed(2),Net_Amt:n.toFixed(2),Paid_Amt:c.toFixed(2),Due_Amt:l.toFixed(2),Concession_Amt:p.toFixed(2),Concession_per:d.toFixed(2),Tax_Amount:m.toFixed(2),Pat_Amt:u.toFixed(2),Payr_Amt:v.toFixed(2),Pat_Conc_Aplc_Amt:D.toFixed(2),deductibleType:i.deductibleType?i.deductibleType:void 0,deductibleAmount:parseFloat(N).toFixed(2),coPay:A.toFixed(2),patientPaidAmnt:I.toFixed(2),payerPaidAmnt:P.toFixed(2),patientDefPendAmnt:h.toFixed(2),payerDefPendAmnt:R.toFixed(2),patientPendAmnt:h.toFixed(2),payerPendAmnt:R.toFixed(2),crNoteAmount:f.toFixed(2),Net_Pat_Amt:T.toFixed(2),Net_Payer_Amt:C.toFixed(2),Net_Total:b.toFixed(2),Net_Pay_Pat:E.toFixed(2),Net_Pay_Payer:q.toFixed(2),Net_Pay_Total:O.toFixed(2),patPendAmtForCSBill:L.toFixed(2),patPendDefAmtForCSBill:D.toFixed(2)};if(i.gbcal=angular.copy(F),i.Pat_Amt=i.gbcal.Pat_Amt,i.Payr_Amt=i.gbcal.Payr_Amt,i.gbcal.deductibleAmount&&i.gbcal.deductibleAmount>0&&l>0){var B=parseFloat(i.gbcal.Pat_Amt)-parseFloat(s)-parseFloat(I)-parseFloat(p),x=parseFloat(i.gbcal.Payr_Amt)-parseFloat(P);B<0&&(B=0),x<0&&(x=0),i.gbcal.patientPendAmnt=B.toFixed(2),i.gbcal.patientDefPendAmnt=B.toFixed(2),i.gbcal.payerPendAmnt=x.toFixed(2),i.gbcal.payerDefPendAmnt=x.toFixed(2)}i.gbcal.patPendAmtForCSBill=i.gbcal.patientPendAmnt,1==i.paym.billAmountType?i.gbBillNo&&"Unbilled"==i.gbBillNo.billno?i.gbcal.patPendAmtForCSBill=L.toFixed(2):i.paym.Amt=i.gbcal.patientPendAmnt:2==i.paym.billAmountType?i.paym.Amt=i.gbcal.payerPendAmnt:3==i.paym.billAmountType&&(i.gbBillNo&&"Unbilled"==i.gbBillNo.billno?i.paym.Amt=i.gbcal.patientPendAmnt:i.paym.Amt="",i.paym.ReceiveFrom="Self"),i.calRoundOffs(),i.gridGbPaymentOptions&&i.gridGbPaymentOptions.data.length>0&&i.calulatePendAmts()},i.checkIfMultipayers=function(e){var t=i.gridgbOptionsApi.selection.getSelectedRows(),r=!1;if(t.length>1)for(let a=0;a<t.length;a++)4!=t[a].payerType&&t[a].payerName!=e.entity.payerName&&i.gbBillNo&&"Unbilled"==i.gbBillNo.billno&&(r=!0),4!=t[a].payerType&&t[a].planSeqId&&t[a].payerName==e.entity.payerName&&(i.insurancePlanDedSeqId=t[a].planSeqId);else 1==t.length&&4!=t[0].payerType&&t[0].planSeqId&&(i.insurancePlanDedSeqId=t[0].planSeqId);if(r)return v.warning("Warning!","More than one payer except self at a time not allowed",!1,!1,me.time),e.isSelected=!1,!1;i.insurancePlanDedSeqId?Pe():i.calculateGBData()},i.gridgbOptions=angular.copy(p),i.gridgbOptions.onRegisterApi=function(e){i.gridgbOptionsApi=e,e.selection.on.rowSelectionChanged(i,function(e){7==e.entity.billStatus&&(e.isSelected=!1),""!=e.entity.payerName||e.entity.planSeqId||(e.isSelected=!1,v.warning("Warning!","No payer details.",!1,!1,me.time)),4!=e.entity.payerType&&"Unbilled"===i.gbBillNo.billno?i.checkIfMultipayers(e):i.calculateGBData(),i.checkOrUncheckRow(e)}),e.selection.on.rowSelectionChangedBatch(i,function(e){var t=!1,r=!1,a=i.gridgbOptionsApi.selection.getSelectedRows(),o=!1;if(a.length>1&&a.length!=e.length){var s="";for(let t=0;t<e.length;t++)e[t].entity.planSeqId&&(s=s+","+e[t].entity.servicePostingSeqId);for(let e=0;e<a.length;e++){if(a[e].planSeqId)var n=s.indexOf(a[e].servicePostingSeqId);!t&&a[e].planSeqId&&-1===n&&(t=a[e].planSeqId)}}if(angular.forEach(e,function(e){7==e.entity.billStatus&&(e.isSelected=!1),""!=e.entity.payerName||e.entity.planSeqId||(e.isSelected=!1,r=!0,o=!0),e.entity.planSeqId&&!t&&e.isSelected&&(t=e.entity.planSeqId),e.entity.planSeqId&&e.entity.planSeqId!=t&&e.isSelected&&i.gbBillNo&&"Unbilled"==i.gbBillNo.billno&&(r=!0,e.isSelected=!1),i.checkOrUncheckRow(e)}),r){if(o)var c="No payer details.";else c="More than one payer except self at a time not allowed";v.warning("Warning!",c,!1,!1,me.time),T(function(){i.gridgbOptionsApi.grid.selection.selectAll=!1},200)}else i.insurancePlanDedSeqId=t;i.insurancePlanDedSeqId?Pe():i.calculateGBData()})},i.getActivebillRecords=function(){var e=[];return angular.forEach(i.gridgbOptions.data,function(t,r){7!=t.billStatus&&e.push(t)}),e},i.generatePaymentReport=function(e,t,r,a,o){e&&m.generatePaymentReport(e,t,r,a).then(function(e){var t="napier-his-web/NapierReportServlet?reportName="+(e.data.HITService.message.reportName+""),r=location.host;F.open(location.protocol+"//"+r+"/"+t),void 0===i.billsPayIds[1]||o||i.generatePaymentReportDup(i.billsPayIds[1].scrollSeqId,-999,-999,a)})},i.generatePaymentReportDup=function(e,t,r,a){e&&m.generatePaymentReport(e,t,r,a).then(function(e){var t="napier-his-web/NapierReportServlet?reportName="+(e.data.HITService.message.reportName+""),r=location.host;F.open(location.protocol+"//"+r+"/"+t)})},i.confrimCancelBillData=function(e,t){m.cancelBillData(e).then(function(e){if(v.success("Success","Cancel Successful",!1,!1,me.time),i.showGBillCanLoadingIcon=!1,i.gridgbOptions.data=[],i.gbcal={},i.loadBillNumbers(s.mrNo,t),i.loadGBDepositeGrid(),i.retriveRecords(),null!=e.context.contextList[0]["com.napier.core.context.ContextElement"][11]){var r=e.context.contextList[0]["com.napier.core.context.ContextElement"][11];i.loadGBDepositeGrid(),"BILL_CANCEL_REFUND"==r.attrName&&"Y"==r.attrValue?i.activeSecond=3:i.activeBillTab(2)}},function(e){i.showGBillCanLoadingIcon=!1,v.failure("Failure","Cancel failed",!1,!1,me.time)}),E.dismissAll()},i.cancelBillData=function(e){if(e){var t=i.gridgbOptionsApi.selection.getSelectedRows();if(i.showGBillCanLoadingIcon=!0,t.length<=0)return v.warning("Warning!","Please select atleast one service/ bill to cancel",!1,!1,me.time),i.showGBillCanLoadingIcon=!1,!1;if(t.length>0){for(var r=0,a=0,o=0,s=0;s<t.length;s++)t[s].isComingFromOPPharmacy?r++:a++,t[s].isPostBillApplicable||o++;if(0!=r&&o&&0==a)return v.warning("Warning!","We Can Not Cancel Issue/Return Services",!1,!1,me.time),!1}var n=[];for(s=0;s<t.length;s++)n.push({"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:t[s].servicePostingSeqId,servDesc:t[s].ItemName,gnServDesign:void 0!==t[s].appointReason?t[s].appointReason:2});var c=!1;if(angular.forEach(t,function(e){2!=e.renderType||c||(c=!0)}),c&&o)return v.warning("Warning!","Rendered pre-billed service(s) can not be canceled",!1,!1,me.time),i.showGBillCanLoadingIcon=!1,!1;var l={buttonCallBack1:function(){E.dismissAll(),i.showGBillCanLoadingIcon=!1},buttonCallBack2:function(){var r=new Array,a={1:r},s=I.executeQueryURLReset(),c=new Array;return I.prepareParamListWithParam("pBillNo",e,c),I.executeQueryInput("GET_CREDIT_DATA_FOR_CANCEL_001",c,a,!0,!0,s,"popUp",{}).then(function(a){if(r[0].SUB_ACC_SEQ_ID&&1==r[0].SUB_ACC_SEQ_ID)return v.warning("Warning!","Can't cancel the registration bill",!1,!1,me.time),i.showGBillCanLoadingIcon=!1,!1;if(null!=r[0].DUEAMNT&&0==r[0].DUEAMNT)return v.warning("Warning!","Can't cancel the credit bill, as the payment is settled",!1,!1,me.time),i.showGBillCanLoadingIcon=!1,!1;if(r[0].CL_HD_SEQ_ID)return v.warning("Warning!","Covering letter is generated, can't cancel the bill",!1,!1,me.time),i.showGBillCanLoadingIcon=!1,!1;if(r[0].INVC_HD_SEQ_ID)return v.warning("Warning!","Invoice is generated, can't cancel the bill",!1,!1,me.time),i.showGBillCanLoadingIcon=!1,!1;if(o){var s={};s.url=N.updateService.URL,s.requestData={operation:"checkOrderCancelForBill",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.master.vo.ServiceListVo",serviceList:[{"com.napier.core.scm.master.vo.ServiceVo":n}]}},P.sendRestRequest(s).then(function(r){if(""==r.data.HITService.message.serviceList[0])i.confrimCancelBillData(t,e);else{var a=r.data.HITService.message.serviceList[0]["com.napier.core.scm.master.vo.ServiceVo"],o=[],s="";void 0!==a.length?s=a:(o.push(a),s=o);for(var n="",c=0;c<s.length;c++)n=s[c].servDesc+","+n;v.warning("Warning!","We Can't Delete the Following Services "+n),i.showGBillCanLoadingIcon=!1}})}else i.confrimCancelBillData(t,e)})}};v.hisAlertMulti("information","Information","Are you sure to cancel?",{buttonText:"No",buttonText2:"Yes"},l,!1)}},i.generateBillReport=function(e,t){if("HSC"==sessionStorage.productCustomization)i.generateBillPrintReportOption(e,t);else{var r=null;if(""==e&&t)for(var a=0;a<i.gbBillNUmbers.length;a++)i.gbBillNUmbers[a].BILL_NO==t&&(e=i.gbBillNUmbers[a].BILL_SEQ_ID,r=i.gbBillNUmbers[a].BILL_REF_ID);else e&&t&&(r=t);var o=0;r&&(0==r.indexOf("OPCS")&&(o=1),0==r.indexOf("OPCR")&&(o=2)),null!=e&&""!=e&&m.generateBillReport(e,-999,-999,o).then(function(e){var t="napier-his-web/NapierReportServlet?reportName="+(e.data.HITService.message.reportName+""),r=location.host;F.open(location.protocol+"//"+r+"/"+t),void 0!==i.billsIds[1]&&i.generateBillReportDup(i.billsIds[1].scrollSeqId,"")})}},i.generateBillReportDup=function(e,t){if("HSC"==sessionStorage.productCustomization)i.generateBillPrintReportOption(e,t);else{if(""==e&&t)for(var r=0;r<i.gbBillNUmbers.length;r++)i.gbBillNUmbers[r].BILL_NO==t&&(e=i.gbBillNUmbers[r].BILL_SEQ_ID);null!=e&&""!=e&&m.generateBillReport(e,-999,-999).then(function(e){var t="napier-his-web/NapierReportServlet?reportName="+(e.data.HITService.message.reportName+""),r=location.host;F.open(location.protocol+"//"+r+"/"+t)})}},i.generateBillPrintReportOptionForMulti=function(e){i.BillData=[],i.BillDataList={1:i.BillData};var t=I.executeQueryURLReset();i.billDetailsValues=new Array,I.prepareParamListWithParam("pMasterSqId","700411",i.billDetailsValues),I.executeQueryInput("TRN003",i.billDetailsValues,i.BillDataList,!0,!0,t,"popUp",i.advSearch).then(function(e){var t=e[1];t&&(i.BillTypeData=t,i.billType=i.BillTypeData[0])});i.PrintTypeData=[{code:1,desc:"PDF"}],i.printType=i.PrintTypeData[0];var r=e;i.BillNumberData=r,i.billNumber=i.BillNumberData[0];var a="";angular.forEach(r,function(e,t){a=a+" & "+e}),a=a.substring(2,a.length),i.message="Bill Generation Successful "+a+". Do you want to print?",s.modalInstancePackage=S.open("Bill Generation",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"bill-print-model-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-multi-bill-print.html",size:"sm",scope:i})},i.generateBillPrintReportOption=function(e,t){i.colReqSeqId=e,i.billNoData=t;i.BillData=[],i.BillDataList={1:i.BillData};var r=I.executeQueryURLReset();i.billDetailsValues=new Array,I.prepareParamListWithParam("pMasterSqId","700411",i.billDetailsValues),I.executeQueryInput("TRN003",i.billDetailsValues,i.BillDataList,!0,!0,r,"popUp",i.advSearch).then(function(e){var t=e[1];t&&(i.BillTypeData=t,i.billType=i.BillTypeData[0])}),i.patCatData=[],i.patCatDataList={1:i.patCatData};r=I.executeQueryURLReset();i.patCatDetailsValues=new Array,I.prepareParamListWithParam("pBillNo",t,i.patCatDetailsValues),I.executeQueryInput("BILL_PRINT_FOR_PAT_CATEGORY",i.patCatDetailsValues,i.patCatDataList,!0,!0,r,"popUp",{}).then(function(e){var t=e[1];t&&(i.patCatCode=t[0].CODE,i.patCatPayer=t[0].PAYER_NAME)});i.PrintTypeData=[{code:1,desc:"PDF"}],i.printType=i.PrintTypeData[0],s.modalInstancePackage=S.open("Bill Print",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"bill-print-model-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-bill-print.html",size:"sm",scope:i})},i.generateBillPrintReportType=function(e,t,r){r&&(i.billNoData=r);var a=J.getPrintData(i.patCatCode,i.billNoData,t,e,i.patCatPayer);i.generateBillPrintReport(a)},i.exitPopUp=function(){E.dismissAll()},i.generateBillPrintReport=function(e){j.printReportModal("printBillCtrl","lg","PDF",e)},i.generateTaxInvoice=function(){var e={reportId:"TAX_INVOICE_GST_REPORT_ID",printType:"PDF",pBillSeqId:i.billSeqids};j.printReportModal("PrintTypeSelection","sm").then(function(t){j.printReportModal("printBillCtrl","lg","PDF",e)})},i.loadAppliedConc=function(e){i.gridConcReqOptions.data=[],m.loadAppliedConc(e).then(function(e){i.gridConcReqOptions.data=angular.copy(e),i.gbBillNo.billno&&"Unbilled"!=i.gbBillNo.billno&&i.calculateGBData()})},i.cancelConcView=function(){i.concessionViewMode=!1,i.concession={},i.gridConcOptions.data=[],i.concBillRadio=!1,i.concServRadio=!1},i.ViewBillConcesDetails=function(e){e.entity.concessionReqSeqId&&(i.gridConcOptions.data=[],i.concessionViewMode=!0,m.ViewBillConcesDetails(e.entity.concessionReqSeqId).then(function(e){i.concession.remarks=e.remarks,i.concession.cType=e.concessionSeqId;var t=e.concessionRequestDetailsList[0]["com.napier.core.service.vo.corebillingconcession.ConcessionRequestDetails"];1==e.concessionType?(i.concession.billService=1,i.concBillRadio=!0,i.concServRadio=!1,i.concession.billConcType=t.amountType.toString(),i.concession.billReqConcAmt=t.reqConession):2==e.concessionType&&(i.concession.billService=2,i.concBillRadio=!1,i.concServRadio=!0,t=t instanceof Array?t:[t],angular.forEach(t,function(e,t){var r=e;r.servName=e.serviceName,1==e.amountType&&(r.concReqPer=e.reqConession),2==e.amountType&&(r.concReqAmt=e.reqConession),i.gridConcOptions.data.push(r),r={}}))}))},i.removeConcesData=function(e){var t={buttonCallBack1:function(){E.dismissAll()},buttonCallBack2:function(){m.removeConcesData(e.entity.concessionReqSeqId,e.entity.concessionType).then(function(e){E.dismissAll(),i.loadGBPaymentGridData("",i.gbBillNo.billno),v.success("Success","Concession Removed",!1,!1,me.time);for(var t="",r=0;r<i.gbBillNUmbers.length;r++)i.gbBillNUmbers[r].BILL_NO==i.gbBillNo.billno&&(t=i.gbBillNUmbers[r]);""!=t&&i.loadAppliedConc(t)})}};e.entity.concessionReqSeqId&&v.hisAlertMulti("information","Information","Are you sure to remove applied concession?",{buttonText:"No",buttonText2:"Yes"},t,!1)},i.saveBillConcession=function(e){var t=[];i.showConcessionLoadingIcon=!0,angular.forEach(i.gridConcReqOptions.data,function(e,r){null==e.concessionReqSeqId&&t.push(e)});for(var r="",a=0;a<i.gbBillNUmbers.length;a++)i.gbBillNUmbers[a].BILL_NO==e&&(r=i.gbBillNUmbers[a]);if(i.gridConcReqOptions.data.length<=0||t<=0||""==r)return v.warning("Warning!","No Data to save",!1,!1,me.time),i.showConcessionLoadingIcon=!1,!1;m.saveBillConcession(t,r.BILL_SEQ_ID).then(function(e){v.success("Success","Concession Applied Successfully",!1,!1,me.time),i.loadGBPaymentGridData("",i.gbBillNo.billno),i.loadGBDepositeGrid(),i.showConcessionLoadingIcon=!1})},i.loadGBPaymentGridData=function(e,t){if(i.psd={},i.appliedDeductible=0,""==e&&t){i.activeSecond=4,i.concession&&i.concession.cType&&(i.concession={},i.concBillRadio=!1,i.concServRadio=!1);for(var r=0;r<i.gbBillNUmbers.length;r++)i.gbBillNUmbers[r].BILL_NO==t&&(e=i.gbBillNUmbers[r]),i.billSeqids=e.BILL_SEQ_ID}7==e.BILL_STATUS?i.disablePrintForCancel=!0:i.disablePrintForCancel=!1,2===e.SCROLL_STATUS&&2===e.CR_NOTE_STATUS?(i.refund.RefdAmt=e.CR_NOTE_AMT,i.refund.COL_REQ_SEQ_ID=e.COL_REQ_SEQ_ID,i.refund.TRAN_REQ_TYPE=e.TRAN_REQ_TYPE,i.refund.paidTo=s.patientGlobalDtlsNew[0].patientName):i.refund.RefdAmt=0,i.billNo=t,i.refundFlag=!0,i.paymentReciepts=!0,i.totalpayableAmt=0,i.gridgbOptions.data=[],i.gbcal={},i.gridGbPaymentOptions.data=[],i.disablePayType=!1,i.gridConcReqOptions.data=[],i.gridrefundOptions.data=[],i.setPaymenttodefault(),i.concessionViewMode=!1,i.reciepts=[],i.paymentReciepts=!0,m.loadGBPaymentGridData(e,s.encounterSeqId).then(function(r){i.enableClaimForm=!1,i.gridgbOptions.data=[],i.gbcal={};var a=0;i.taxInvoiceFlag=!1;var o=[];i.gridgbOptions.data=angular.copy(r);for(var s=0;s<i.gridgbOptions.data.length;s++)o.push(i.gridgbOptions.data[s].servicePostingSeqId),7==i.gridgbOptions.data[s].billStatus&&a++;a==i.gridgbOptions.data.length&&(i.taxInvoiceFlag=!0),i.colReqSeqId=r[0].colReqSeqId,i.colReqSeqId||(i.colReqSeqId=r[0].payerColSeqId?r[0].payerColSeqId:r[0].patColSeqId);var n={1:i.taxInVoiceList=[]},c=I.executeQueryURLReset(),l=new Array;if(I.prepareParamListWithParam("@SP_SEQ_ID",_.toString(o),l),I.prepareParamListWithParam("@PAT_TYPE","2",l),I.executeQueryInput("GENERATE_TAX_INVOICE_NO",l,n,!0,!0,c,"popUp",{}),r[0].billStatus&&7==r[0].billStatus&&null!=r[0].refundFlag){var p=r[0].refundFlag;"BILL_CANCEL_REFUND"==p.attrName&&"Y"==p.attrValue?i.activeSecond=3:i.activeSecond=2}var d=!0;t&&"Unbilled"!=t&&r[0]&&null!=r[0].dueAmt&&0==r[0].dueAmt&&(d=!1),r[0]&&d&&(1==r[0].partialStatusCode?(i.pPayAuthMode=!0,i.psd.partialPayStatusMode="Request for Due amount "+r[0].partialDueAmount+" is pending for approval.",i.psd.partialDueAmountArroval="",i.psd.partialDueAmountStatusCode=r[0].partialStatusCode,i.psd.partialRequestSeqId=r[0].partialRequestSeqId):2==r[0].partialStatusCode?(i.pPayAuthMode=!0,i.psd.partialPayStatusMode="Request for due amount "+r[0].partialDueAmount+" is approved",i.psd.partialDueAmountArroval=r[0].partialDueAmount,i.psd.partialDueAmountStatusCode=r[0].partialStatusCode,i.psd.partialRequestSeqId=r[0].partialRequestSeqId):3==r[0].partialStatusCode?(i.pPayAuthMode=!1,i.psd.partialPayStatusMode="Request for due amount "+r[0].partialDueAmount+" is rejected.",i.psd.partialDueAmountArroval="",i.psd.partialDueAmountStatusCode=r[0].partialStatusCode,i.psd.partialRequestSeqId=r[0].partialRequestSeqId):(i.pPayAuthMode=!1,i.psd.partialPayStatusMode="",i.psd.partialDueAmountArroval="",i.psd.partialDueAmountStatusCode="",i.psd.partialRequestSeqId="")),null!=i.colReqSeqId&&(r[0].payerColSeqId&&r[0].patColSeqId?i.paymentReciept(i.colReqSeqId,r[0].patColSeqId):i.paymentReciept(i.colReqSeqId)),r.length>0?"Unbilled"===i.gbBillNo.billno?i.gridgbOptionsApi.grid.selection.selectAll=!1:(i.gridgbOptionsApi.grid.selection.selectAll=!1,i.calculateGBData()):i.gridgbOptionsApi.grid.selection.selectAll=!1,e.BILL_NO&&"Unbilled"!=e.BILL_NO&&7!=e.BILL_STATUS&&i.loadAppliedConc(e);var m=e.BILL_NO.match(/OPCR/g);m&&m.length>0&&(i.enableClaimForm=!0)},function(e){i.gridgbOptions.data=[],i.gbcal={},i.gridgbOptionsApi.grid.selection.selectAll=!1})},i.loadServiceAliasCodes=function(e,t){if(e.entity.servSeqId&&e.entity.accPayerSeqId){e.entity.serviceCodesList=[];let t={1:e.entity.serviceCodesList},r=[],a=I.executeQueryURLReset();I.prepareParamListWithParam("pPayerSeqId",e.entity.accPayerSeqId,r),I.prepareParamListWithParam("pSerSeqId",e.entity.servSeqId,r),I.executeQueryInput("PHIL_HEALTH_CODE_AND_NAME",r,t,!0,!0,a,"popUp",{}).then(function(t){if(0==e.entity.serviceCodesList.length)v.warning("Warning!","There are no associated payer codes in the contract definition",!1,!1,me.time),e.entity.editService=!1;else{var r=e.entity.serviceCodesList.map(function(e){return e.DEFAULT_VALUE}).indexOf(1);e.entity.ItemCodeNew=e.entity.serviceCodesList[r]}})}},i.updateServiceAliasCodes=function(e,t){e.entity.ItemCodeNew&&m.updateServiceAliasCodes(e.entity).then(function(t){e.entity.ItemCode=angular.copy(e.entity.ItemCodeNew.PAYER_ALIAS_CODE),e.entity.ItemName=e.entity.ItemCodeNew.PAYER_ALIAS_NAME,e.entity.editService=!1},function(e){})},i.claimFormDetails=function(){ge={};var e=-999;if(i.gbBillNo&&"Unbilled"==i.gbBillNo.billno)var t=i.gridgbOptionsApi.selection.getSelectedRows();else t=i.gridgbOptions.data;for(var r=0;r<t.length;r++)ge={"SV.SERV_CODE":t[r].ItemCode,"SV.SERV_NAME":t[r].ItemName,"SP.QTY":t[r].quantity,"SEC.SERV_TYPE_DESC":t[r].primaryServiceDescription,"SP.SERVICE_RATE":t[r].baseRate},i.claimFormDetailsArray.push(ge),-999==e&&t[r].payerCompPlanseqId&&(e=t[r].payerCompPlanseqId);i.claimFormDetailsArrayString=JSON.stringify(i.claimFormDetailsArray);var a={regSeqId:s.patientSeqId,encSeqId:s.encounterSeqId,serviceListString:i.claimFormDetailsArrayString,pPayerSeqId:e,reportId:"CLAIM_FORM_TEMPLATE"};j.printReportModal("claimFormPrintCtrl","lg","PDF",a),i.claimFormDetailsArray=[]},i.loadRefundRecieptList=function(){if(null!=i.accountSeqData[0].ACC_SEQ_ID){i.refundRecieptsList=[];let e={1:i.refundRecieptsList},t=[],r=I.executeQueryURLReset();i.accountres.SUB_ACC_SEQ_ID;I.prepareParamListWithParam("pAccSeqId",i.accountSeqData[0].ACC_SEQ_ID,t),I.executeQueryInput("GET_OP_DEPOSIT_REFUND_001",t,e,!0,!0,r,"popUp",{})}},i.PaymentRecieptPrint=function(e){var t=e.billNo.substring(0,4);i.generatePaymentReport(e.colSeqId,e.receiptHdSeqId,e.receiptDtSeqId,t)},i.paymentReciept=function(e,t){i.reciepts=[],m.loadPaymentReciepts(e).then(function(r){null!=r&&(i.paymentReciepts=!1,null==r.length?i.reciepts.push(r):i.reciepts=r),t&&e!=t&&m.loadPaymentReciepts(t).then(function(e){if(null!=e){if(i.paymentReciepts=!1,null==e.length)(t=[]).push(e);else var t=e;i.reciepts.length>0?i.reciepts=i.reciepts.concat(t):i.reciepts=t}})})},i.refundPrint=function(){var e={pPaymentRefundReceiptId:i.colReqSeqId?i.colReqSeqId:i.gridgbOptions.data[0].patColSeqId};j.printReportModal("refundPrintCtrl","lg","PDF",e)},i.loadBillNumbers=function(e,t){i.gbBillNo.billno=void 0,i.setPaymenttodefault(),i.concession={},i.gridConcOptions.data=[],i.gridConcReqOptions.data=[],m.loadBillNumbers(e,i.accountSeqData.length>0?i.accountSeqData[0].SUB_ACC_SEQ_ID:1).then(function(r){r.unshift({BILL_NO:"Unbilled",BILL_STATUS:0,RG_INT_MR_NO:e,ACC_SEQ_ID:i.accountSeqData.length>0?i.accountSeqData[0].ACC_SEQ_ID:r[0].ACC_SEQ_ID,SUB_ACC_SEQ_ID:i.accountSeqData.length>0?i.accountSeqData[0].SUB_ACC_SEQ_ID:r[0].SUB_ACC_SEQ_ID}),i.gbBillNUmbers=angular.copy(r),t?(i.loadGBPaymentGridData("",t),i.gbBillNo.billno=t):(i.loadGBPaymentGridData(r[0]),i.gbBillNo.billno=i.gbBillNUmbers[0].BILL_NO)},function(t){i.gbBillNo.billno=void 0;var r=[];r.push({BILL_NO:"Unbilled",BILL_STATUS:0,RG_INT_MR_NO:e,ACC_SEQ_ID:i.accountSeqData.length>0&&i.accountSeqData[0].ACC_SEQ_ID?i.accountSeqData[0].ACC_SEQ_ID:void 0,SUB_ACC_SEQ_ID:i.accountSeqData.length>0&&i.accountSeqData[0].SUB_ACC_SEQ_ID?i.accountSeqData[0].SUB_ACC_SEQ_ID:void 0}),i.gbBillNUmbers=angular.copy(r),i.loadGBPaymentGridData(r[0]),i.gbBillNo.billno=i.gbBillNUmbers[0].BILL_NO})},i.setPaymenttodefault=function(e){i.paym={},i.paym.mode=1,i.refund.mode=1,i.paym.ReceiveFrom="Self",i.paym.payDate=new Date,i.refund.fromDate=new Date,i.paym.billAmountType=null!=e?e:"1"},i.paymentModeResult=function(){i.OPVMGenBillsPaymentModeCombo=[],i.bankNamesData=[],i.escPaymentTypeData=[],i.concessionTypeCombo=[],i.chequeTypeData=[],i.refundMode=[],i.cardTypeData=[],i.getSelectedPmtMode={1:i.OPVMGenBillsPaymentModeCombo,2:i.bankNamesData,3:i.escPaymentTypeData,4:i.concessionTypeCombo,5:i.chequeTypeData,6:i.refundMode,7:i.cardTypeData};var e=I.executeQueryURLReset();i.paymentModeDataList=new Array,I.prepareParamListWithParam("pMasterSqId","21008",i.paymentModeDataList),I.executeQueryInput("NH_GN_M_MASTER_DT_COMBO",i.paymentModeDataList,i.getSelectedPmtMode,!0,!1,e,"popUp",i.gridgbOptions),i.bankNamesDataList=new Array,I.prepareParamListWithParam("pMasterSqId","700179",i.bankNamesDataList),I.executeQueryInput("NH_GN_M_MASTER_DT_COMBO",i.bankNamesDataList,i.getSelectedPmtMode,!0,!1,e,"popUp",i.gridgbOptions),i.escPaymentTypeDataList=new Array,I.prepareParamListWithParam("pMasterSqId","700189",i.escPaymentTypeDataList),I.executeQueryInput("NH_GN_M_MASTER_DT_COMBO",i.escPaymentTypeDataList,i.getSelectedPmtMode,!0,!1,e,"popUp",i.gridgbOptions),i.concessionTypeList=new Array,I.prepareParamListWithParam("pRollId",JSON.parse(sessionStorage.userContextObj).USER_SEQ_ID,i.concessionTypeList),I.executeQueryInput("GET_CONCESSION_NEW_DROPDOWN_BY_USERID",i.concessionTypeList,i.getSelectedPmtMode,!0,!1,e,"popUp",i.gridgbOptions),i.chequeTypeDataList=new Array,I.prepareParamListWithParam("pMasterSqId","21009",i.chequeTypeDataList),I.executeQueryInput("NH_GN_M_MASTER_DT_COMBO",i.chequeTypeDataList,i.getSelectedPmtMode,!0,!0,e,"popUp",i.gridgbOptions),i.refundModeDataList=new Array,I.prepareParamListWithParam("pMasterSqId","700200",i.refundModeDataList),I.executeQueryInput("NH_GN_M_MASTER_DT_COMBO",i.refundModeDataList,i.getSelectedPmtMode,!0,!1,e,"popUp",i.gridgbOptions),i.cardTypeDataList=new Array,I.prepareParamListWithParam("pMasterSqId","969",i.cardTypeDataList),I.executeQueryInput("NH_GN_M_MASTER_DT_COMBO",i.cardTypeDataList,i.getSelectedPmtMode,!0,!1,e,"popUp",i.gridgbOptions)},T(function(){i.paymentModeResult()},500),i.getServiceConcessionDetails=function(e,t,r){if(i.gbBillNo.billno&&"Unbilled"==i.gbBillNo.billno)var a=i.gridgbOptionsApi.selection.getSelectedRows();else a=i.getActivebillRecords();if(a.length<=0)return v.warning("Warning!","Please select atleast one service",!1,!1,me.time),i.concession.cType="",!1;var o="";angular.forEach(a,function(e){7!=e.gnTranStatus&&e.PatAmt>0&&0==e.payerAmt&&(o=""==o?e.servicePostingSeqId:o+","+e.servicePostingSeqId)}),m.getServiceConcessionDetails(e,t,r,o).then(function(e){i.gridConcOptions.data=angular.copy(e)},function(e){i.gridConcOptions.data=[]})},i.applicableForBillandService=function(e){1==e?(i.concBillRadio=!0,i.concServRadio=!1):(i.concBillRadio=!1,i.concServRadio=!0)},i.applyConcessionRequest=function(){if(i.gbcal&&i.gbcal.Due_Amt<=0)return v.warning("Warning!","No Due Amount To give concession",!1,!1,me.time),!1;if(!i.gbcal.Pat_Amt||i.gbcal.Pat_Amt<=0)return v.warning("Warning!","Patient Amount should be more than Zero to apply concession",!1,!1,me.time),!1;if(i.gbcal.Pat_Amt>0&&0==i.gbcal.Pat_Conc_Aplc_Amt)return v.warning("Warning!","Concession can only be applied for a cash bill",!1,!1,me.time),!1;if(1==i.concession.billService){if(!i.concession.billReqConcAmt||i.concession.billReqConcAmt<=0)return v.warning("Warning!","Concession amount should be greater than zero",!1,!1,me.time),!1;1==i.concession.billService&&(1==i.concession.billConcType?(i.concession.billReqPer=i.concession.billReqConcAmt,i.concession.billReqAmt=(parseFloat(i.gbcal.Pat_Conc_Aplc_Amt)*(parseFloat(i.concession.billReqConcAmt)/100)).toFixed(2)):i.concession.billReqAmt=i.concession.billReqConcAmt)}else if(2==i.concession.billService){if(i.gridConcOptions.data.length<=0)return v.warning("Warning!","No service data to apply concession",!1,!1,me.time),!1;i.concession.serviceConcList=i.gridConcOptions.data;var e=0;for(let t=0;t<i.gridConcOptions.data.length;t++)e=parseFloat(e)+parseFloat(i.gridConcOptions.data[t].concReqAmt),e=parseFloat(e).toFixed(2);if(i.concession.dTotalServAmt=e,!i.concession.dTotalServAmt||i.concession.dTotalServAmt<=0)return v.warning("Warning!","Concession amount should be greater than zero",!1,!1,me.time),!1}if(i.gridConcReqOptions.data.length>0){if(-1!=i.gridConcReqOptions.data.map(function(e){return e.cType}).indexOf(i.concession.cType))return v.warning("Warning!","Concession already given",!1,!1,me.time),!1;i.gridConcReqOptions.data.push(i.concession),i.concession={},i.gridConcOptions.data=[],i.calculateGBData()}else i.gridConcReqOptions.data.push(i.concession),i.concession={},i.gridConcOptions.data=[],i.calculateGBData()},i.removeFromConcGrid=function(e,t){i.gridConcReqOptions.data.splice(t,1),i.calculateGBData()},i.checkBillConcessionReq=function(){0==i.concession.billConcAmt&&(i.concession.billReqConcAmt=""),i.concession.billReqConcAmt=i.concession.billReqConcAmt>0?parseFloat(i.concession.billReqConcAmt).toFixed(2):0,parseFloat(i.concession.billReqConcAmt)>parseFloat(i.concession.billConcAmt)&&(i.concession.billReqConcAmt=i.concession.billConcAmt)},i.concessionTypeChange=function(){""!=i.concession.cType?angular.forEach(i.concessionTypeCombo,function(e){if(e.CONC_SEQ_ID==i.concession.cType){if(i.applicableForBillandService(e.GN_CONC_TYPE),i.concession.billService=e.GN_CONC_TYPE,i.concession.cTypeDesc=e.CONC_NAME,2==e.GN_CONC_TYPE){if("Unbilled"==i.gbBillNo.billno)var t=-999;else{t="";for(var r=0;r<i.gbBillNUmbers.length;r++)i.gbBillNUmbers[r].BILL_NO==i.gbBillNo.billno&&(t=i.gbBillNUmbers[r].BILL_SEQ_ID);""==t&&(t=-999)}i.getServiceConcessionDetails(e.CONC_SEQ_ID,i.accountSeqData[0].SUB_ACC_SEQ_ID,t)}else{var a=e.CONC_AMOUNT;if(1==e.AMT_TYPE)i.concession.billConcType="1",e.CONC_AMOUNT>100&&(a=100);else if(i.concession.billConcType="2",i.gbcal&&i.gbcal.Pat_Conc_Aplc_Amt){var o=i.gbcal.Pat_Conc_Aplc_Amt;parseFloat(i.gbcal.Concession_Amt)>0&&(o=parseFloat(o)-parseFloat(i.gbcal.Concession_Amt)),o<=a&&(a=o),a=parseFloat(a)}i.concession.billConcAmt=a,i.concession.billReqConcAmt=a}return!1}}):(i.concession.billService=!1,i.concBillRadio=!1,i.concServRadio=!1)},i.gridConcReqOptions=angular.copy(G),i.gridConcOptions=angular.copy(x),i.gridfOptions=angular.copy(U),i.gridfOptions.onRegisterApi=function(e){i.gridgbdepOptionsApi=e,e.selection.on.rowSelectionChangedBatch(i,function(e){angular.forEach(e,function(e){if(!e.isSelected){if(e.entity.appliedAmount=0,void 0!==e.entity.adjustamtTotal)var t=e.entity.adjustamtTotal;else t=0;e.entity.availableAmount=parseFloat(e.entity.depositAmount)-parseFloat(t)}i.calculateGBData()})}),e.selection.on.rowSelectionChanged(i,function(e){if(!e.isSelected){if(e.entity.appliedAmount=0,void 0!==e.entity.adjustamtTotal)var t=e.entity.adjustamtTotal;else t=0;e.entity.availableAmount=parseFloat(e.entity.depositAmount)-parseFloat(t)}e.isSelected&&i.deposit&&2==i.deposit.Type&&i.gridrefundOptions&&i.gridrefundOptions.data.length>0&&(v.warning("Warning!","You can refund single Deposit/Credit Note at a time.",!1,!1,me.time),i.gridgbdepOptionsApi.selection.clearSelectedRows()),i.calculateGBData()})},i.loadGBDepositeGrid=function(){if(null!=i.accountSeqData[0].ACC_SEQ_ID){var e=[];i.gridfOptions.data=[],m.loadGBDepositeGrid(i.accountSeqData[0].ACC_SEQ_ID).then(function(t){for(var r=0;r<t.length;r++)e.push(t[r]);m.loadGBDepositeGridBillCancelRefund(i.accountSeqData[0].ACC_SEQ_ID).then(function(t){for(var r=0;r<t.length;r++)e.push(t[r])}),i.deposit&&2==i.deposit.Type?i.gridgbdepOptionsApi.selection.setMultiSelect(!1):i.gridgbdepOptionsApi.selection.setMultiSelect(!0),i.gridfOptions.data=e}),i.depositReciepts=[];var t={1:i.depositReciepts},r=[],a=I.executeQueryURLReset();i.accountres.SUB_ACC_SEQ_ID;I.prepareParamListWithParam("pAccSeqId",i.accountSeqData[0].ACC_SEQ_ID,r),I.executeQueryInput("GET_OP_DEPOSIT_RECEPT_001",r,t,!0,!0,a,"popUp",{})}},i.depositRecieptPrint=function(e){var t={pColrequestSeqId:e.COLREQSEQID};j.printReportModal("depositPrintCtrl","lg","PDF",t)},i.refundRecieptPrint=function(e){var t={pCrNtHdSeqId:e.CRN_HD_SEQ_ID,pIsCrNote:e.IS_CR_NOTE};j.printReportModal("refundReceiptPrintCtrl","lg","PDF",t)},i.gridrefundOptions=angular.copy(Q),i.concServComp=function(e,t){var r,a,i;2==t&&(parseFloat(e.concReqAmt)>parseFloat(e.concLimitAmt)&&(e.concReqAmt=e.concLimitAmt),e.concReqPer=function(e,t){if(t>=e)var r=100;else r=t/e*100;return r.toFixed(2)}(e.total,e.concReqAmt)),1==t&&(parseFloat(e.concReqPer)>parseFloat(e.concLimitPer)&&(v.warning("Warning!","Given concession is more than configured percentage",!1,!1,me.time),e.concReqPer=e.concLimitPer),e.concReqAmt=(r=e.total,a=e.concReqPer,null==(i=r*(a/100))||!angular.isNumber(i)||isNaN(i)?"":i.toFixed(2)))},i.gridGbPaymentOptions=angular.copy(k),i.gridGbPaymentOptions.onRegisterApi=function(e){i.gridGbPaymentOptions=e},i.gridrefundOptions.onRegisterApi=function(e){i.gridrefundOptions=e,i.gridrefundOptions.data=[]},i.addToRefundGrid=function(e){if(e.RefdAmt>0){var t="Please Fill All Mandatory Fileds.";if(i.gridrefundOptions.data.length>0)return v.warning("Warning!","Only one refund allowed at a time",!1,!1,me.time),!1;if(!(1!=e.mode||e.RefdAmt&&e.paidTo))return v.warning("Warning!",t,!1,!1,me.time),!1;if(!(2!=e.mode&&3!=e.mode||e.RefdAmt&&e.fromDate&&e.chqType&&e.CHQDDno&&e.ChqDDDate&&e.paidTo))return v.warning("Warning!",t,!1,!1,me.time),!1;if(!(4!=e.mode&&9!=e.mode||e.RefdAmt&&e.fromDate&&e.cardNumber&&e.cardTranId&&e.cardType&&e.exMonth&&e.exYear&&e.paidTo))return v.warning("Warning!",t,!1,!1,me.time),!1;if(!(5!=e.mode||e.RefdAmt&&e.fromDate&&e.paymentTranType&&e.paidTo))return v.warning("Warning!",t,!1,!1,me.time),!1;if(!(7!=e.mode||e.RefdAmt&&e.fromDate&&e.cardTranId&&e.mobileNumber&&e.paidTo))return v.warning("Warning!",t,!1,!1,me.time),!1;if(!(8!=e.mode||e.RefdAmt&&e.fromDate&&e.cardTranId&&e.bankName&&e.paidTo))return v.warning("Warning!",t,!1,!1,me.time),!1;if(e.RefdAmt<=0)return v.warning("Warning!","Amount Should be greater than zero",!1,!1,me.time),!1;if(7==e.mode&&e.mobileNumber.length<10)return v.warning("Warning!","Enter Valid Mobile Number",!1,!1,me.time),!1;if(4==e.mode||9==e.mode){var r=moment().month()+1,a=moment().year();if(parseFloat(e.exMonth.month)<parseFloat(r)&&parseFloat(e.exYear.year)<=parseFloat(a)||parseFloat(e.exYear.year)<parseFloat(a))return v.warning("Warning!","Card is expired",!1,!1,me.time),!1}var o,n="";angular.forEach(i.OPVMGenBillsPaymentModeCombo,function(e){e.DT_CODE==i.refund.mode&&(n=e.DETAIL_DESC)}),i.gridgbOptions&&i.gridgbOptions.data.length>0&&i.gridgbOptions.data[0].patColSeqId&&(o=i.gridgbOptions.data[0].patColSeqId);var c={date:e.fromDate,PayMode:n,PayModeCode:e.mode,amtPaid:e.RefdAmt,receivedfrom:e.paidTo,refNo:s.encounterNo,COL_REQ_SEQ_ID:o,TRAN_REQ_TYPE:2,roundOff:e.roundOff?e.roundOff:0,cardExpiryDate:e.exMonth&&e.exYear?e.exMonth.month_id+"/"+e.exYear.year_id:void 0,cardType:e.cardType,payerRadType:e.billAmountType,paymentDate:e.fromDate,cardNumber:e.cardNumber,cardTranId:e.cardTranId,bank:e.bankName,chequeType:e.chqType,chequeDDno:e.CHQDDno,chequeDDDate:e.ChqDDDate,paymentTranType:e.paymentTranType};if(i.gridrefundOptions.data.push(c),i.deposit&&2==i.deposit.Type)i.gridgbdepOptionsApi.selection.getSelectedGridRows()[0].setThisRowInvisible();i.refund={},i.refund.mode=1,i.refund.fromDate=new Date,T(function(){i.gridrefundOptions.selection.selectAllRows()},200)}else{t="Please Select Any Cancelled Bill / Deposit To Make Refund";v.hisAlertMulti("warning","Warning",t,{buttonText:"OK"},close)}},i.calulatePendAmts=function(){if(i.gridGbPaymentOptions&&i.gridGbPaymentOptions.data.length>0){var e=0;i.gbcal.patientPendAmnt=i.gbcal.patientDefPendAmnt,i.gbcal.payerPendAmnt=i.gbcal.payerDefPendAmnt;for(var t=0;t<i.gridGbPaymentOptions.data.length;t++)e=(parseFloat(e)+parseFloat(i.gridGbPaymentOptions.data[t].amtPaid)).toFixed(2);1==i.paym.billAmountType&&i.gbcal.patientPendAmnt>0&&(i.gbBillNo.billno&&"Unbilled"==i.gbBillNo.billno?(i.gbcal.patPendAmtForCSBill=(parseFloat(i.gbcal.patPendDefAmtForCSBill)-parseFloat(i.gbcal.Deposite_Adj)-parseFloat(e)-parseFloat(i.gbcal.Concession_Amt)).toFixed(2),i.gbcal.patPendAmtForCSBill<0&&(i.gbcal.patPendAmtForCSBill=0),i.paym.Amt=i.gbcal.patPendAmtForCSBill):(i.gbcal.patientPendAmnt=(parseFloat(i.gbcal.patientPendAmnt)-parseFloat(e)).toFixed(2),i.gbcal.patientPendAmnt<0&&(i.gbcal.patientPendAmnt=0),i.paym.Amt=i.gbcal.patientPendAmnt)),2==i.paym.billAmountType&&i.gbcal.payerPendAmnt>0&&(i.gbcal.payerPendAmnt=(parseFloat(i.gbcal.payerPendAmnt)-parseFloat(e)).toFixed(2),i.gbcal.payerPendAmnt<0&&(i.gbcal.payerPendAmnt=0),i.paym.Amt=i.gbcal.payerPendAmnt)}i.calRoundOffs()},i.calRoundOffs=function(){var e=0,t=0;1==i.paym.mode?1==i.paym.billAmountType?i.gbBillNo&&"Unbilled"==i.gbBillNo.billno?(e=ue.roundoff(i.gbcal.patPendAmtForCSBill),t=parseFloat(e)-parseFloat(i.gbcal.patPendAmtForCSBill)):(e=ue.roundoff(i.gbcal.patientPendAmnt),t=parseFloat(e)-parseFloat(i.gbcal.patientPendAmnt)):2==i.paym.billAmountType?(e=ue.roundoff(i.gbcal.payerPendAmnt),t=parseFloat(e)-parseFloat(i.gbcal.payerPendAmnt)):3==i.paym.billAmountType&&(i.gbBillNo&&"Unbilled"==i.gbBillNo.billno?(e=i.gbcal.patientPendAmnt,t=0):e=""):1==i.paym.billAmountType?e=i.gbBillNo&&"Unbilled"==i.gbBillNo.billno?i.gbcal.patPendAmtForCSBill:i.gbcal.patientPendAmnt:2==i.paym.billAmountType?e=i.gbcal.payerPendAmnt:3==i.paym.billAmountType&&(e=i.gbBillNo&&"Unbilled"==i.gbBillNo.billno?i.gbcal.patientPendAmnt:"",t=0),0==e&&(t=0),i.paym.Amt=e,i.paym.roundOff=t.toFixed(2)},i.getRoundoff=function(){1==i.paym.mode?(1!=i.paym.billAmountType||parseFloat(i.paym.Amt)-parseFloat(i.paym.roundOff)!=parseFloat(i.gbcal.patientPendAmnt)&&parseFloat(i.paym.Amt)!=parseFloat(i.gbcal.patientPendAmnt))&&(2!=i.paym.billAmountType||parseFloat(i.paym.Amt)-parseFloat(i.paym.roundOff)!=parseFloat(i.gbcal.payerPendAmnt)&&parseFloat(i.paym.Amt)!=parseFloat(i.gbcal.payerPendAmnt))?i.paym.roundOff=0:i.calRoundOffs():i.paym.roundOff=0},i.addToPaymentGrid=function(){var e="Please Fill All Mandatory Fileds.";if(!(1!=i.paym.mode||i.paym.Amt&&i.paym.ReceiveFrom))return v.warning("Warning!",e,!1,!1,me.time),!1;if(!(2!=i.paym.mode&&3!=i.paym.mode||i.paym.Amt&&i.paym.payDate&&i.paym.chqType&&i.paym.CHQDDno&&i.paym.ChqDDDate))return v.warning("Warning!",e,!1,!1,me.time),!1;if(!(4!=i.paym.mode&&9!=i.paym.mode||i.paym.Amt&&i.paym.payDate&&i.paym.cardNumber&&i.paym.cardTranId&&i.paym.cardType&&i.paym.exMonth&&i.paym.exYear))return v.warning("Warning!",e,!1,!1,me.time),!1;if(!(5!=i.paym.mode||i.paym.Amt&&i.paym.payDate&&i.paym.paymentTranType))return v.warning("Warning!",e,!1,!1,me.time),!1;if(!(7!=i.paym.mode||i.paym.Amt&&i.paym.payDate&&i.paym.cardTranId&&i.paym.mobileNumber))return v.warning("Warning!",e,!1,!1,me.time),!1;if(!(8!=i.paym.mode||i.paym.Amt&&i.paym.payDate&&i.paym.cardTranId&&i.paym.bankName))return v.warning("Warning!",e,!1,!1,me.time),!1;if(i.paym.Amt<=0)return v.warning("Warning!","Amount Should be greater than zero",!1,!1,me.time),!1;if(7==i.paym.mode&&i.paym.mobileNumber.length<10)return v.warning("Warning!","Enter Valid Mobile Number",!1,!1,me.time),!1;if(4==i.paym.mode||9==i.paym.mode){var t=moment().month()+1,r=moment().year();if(parseFloat(i.paym.exMonth.month)<parseFloat(t)&&parseFloat(i.paym.exYear.year)<=parseFloat(r)||parseFloat(i.paym.exYear.year)<parseFloat(r))return v.warning("Warning!","Card is expired",!1,!1,me.time),!1}var a="";angular.forEach(i.OPVMGenBillsPaymentModeCombo,function(e){e.DT_CODE==i.paym.mode&&(a=e.DETAIL_DESC)});var o=0;if(i.gridGbPaymentOptions.data.length>0){var s=!1;if(angular.forEach(i.gridGbPaymentOptions.data,function(e){e.amtPaid&&e.amtPaid>0&&(o=parseFloat(o)+parseFloat(e.amtPaid)),e.PayModeCode==i.paym.mode&&(s=!0)}),s)return v.warning("Warning!","Payment Mode "+a+" already exists."),!1}if(3!=i.paym.billAmountType&&i.gbcal){var n=!1;if(i.paym.roundOff||(i.paym.roundOff=0),1==i.paym.billAmountType){parseFloat(i.gbcal.patientPendAmnt)<=0&&(n="No Patient Due Amount To make payment");var c=parseFloat(parseFloat(i.paym.Amt)-parseFloat(i.paym.roundOff)).toFixed(2);parseFloat(c)>parseFloat(i.gbcal.patientPendAmnt)&&(n="Patient payment amount should not be more than patient due amount"),i.gbBillNo.billno&&"Unbilled"==i.gbBillNo.billno&&parseFloat(c)>parseFloat(i.gbcal.patPendAmtForCSBill)&&(n="Payment more then Cash bill amount is not allowed.")}if(2==i.paym.billAmountType){parseFloat(i.gbcal.payerPendAmnt)<=0&&(n="No Payer Due Amount To make payment");var l=parseFloat(parseFloat(i.paym.Amt)-parseFloat(i.paym.roundOff)).toFixed(2);parseFloat(l)>parseFloat(i.gbcal.payerPendAmnt)&&(n="Payer payment amount should not be more than payer due amount")}if(i.gbcal.Due_Amt<=0&&(n="No Due Amount To make payment"),n)return v.warning("Warning!",n,!1,!1,me.time),!1;if(i.gbBillNo.billno&&"Unbilled"==i.gbBillNo.billno)var p=i.gridgbOptionsApi.selection.getSelectedRows();else p=i.getActivebillRecords();if(p.length<=0)return v.warning("Warning!","Please select atleast one service/ bill to add payment",!1,!1,me.time),!1;var d=0,m=0,u=0,S=0;if(angular.forEach(p,function(e){e.PatAmt&&e.PatAmt>0&&(d=parseFloat(d)+parseFloat(e.PatAmt)),e.payerAmt&&e.payerAmt>0&&(m=parseFloat(m)+parseFloat(e.payerAmt)),e.dueAmt&&e.dueAmt>0&&(u=parseFloat(u)+parseFloat(e.dueAmt)),e.PaidAmt&&e.PaidAmt>0&&(S=parseFloat(S)+parseFloat(e.PaidAmt))}),i.gbcal.deductibleAmount&&i.gbcal.deductibleAmount>0&&(m=parseFloat(m)-parseFloat(i.gbcal.deductibleAmount),d=parseFloat(d)+parseFloat(i.gbcal.deductibleAmount)),0==u&&S>0)return v.warning("Warning!","No Due Amount to make payment",!1,!1,me.time),!1;if(i.deposit&&2==i.deposit.Type)var y=[];else y=i.gridgbdepOptionsApi.selection.getSelectedRows();var D=0;y.length>0&&angular.forEach(y,function(e,t){e.appliedAmount>0&&(D=parseFloat(D)+parseFloat(e.appliedAmount))}),d=parseFloat(d)+("Unbilled"==i.gbBillNo.billno?i.gbcal.deductibleAmount:i.gbcal.detableAmount),d=parseFloat(d).toFixed(2),m=parseFloat(m).toFixed(2);var g=parseFloat(parseFloat(o)+parseFloat(i.gbcal.Deposite_Adj)+parseFloat(i.paym.Amt)-parseFloat(i.paym.roundOff)).toFixed(2),A=parseFloat(parseFloat(o)+parseFloat(i.gbcal.Deposite_Adj)+parseFloat(i.paym.Amt)+parseFloat(i.gbcal.Concession_Amt)-parseFloat(i.paym.roundOff)).toFixed(2);if(1==i.paym.billAmountType&&(parseFloat(g)>parseFloat(d)||parseFloat(A)>parseFloat(d)))return v.warning("Warning!","Patient payment amount should not be more than patient amount",!1,!1,me.time),i.paym.Amt="",!1;var I=parseFloat(parseFloat(o)+parseFloat(i.paym.Amt)-parseFloat(i.paym.roundOff)).toFixed(2);if(2==i.paym.billAmountType&&parseFloat(I)>parseFloat(m))return v.warning("Warning!","Payer payment amount should not be more than payer amount",!1,!1,me.time),i.paym.Amt="",!1}var P="";2!=i.paym.mode&&3!=i.paym.mode||(P=i.paym.CHQDDno),4==i.paym.mode&&(P=i.paym.cardTranId);var h={payerRadType:i.paym.billAmountType,PayMode:a,PayModeCode:i.paym.mode,amtPaid:i.paym.Amt,Receivedfrom:i.paym.ReceiveFrom,paymentDate:i.paym.payDate,cardNumber:i.paym.cardNumber,cardTranId:i.paym.cardTranId,bank:i.paym.bankName,chequeType:i.paym.chqType,chequeDDno:i.paym.CHQDDno,chequeDDDate:i.paym.ChqDDDate,paymentTranType:i.paym.paymentTranType,refNo:P,cardExpiryDate:i.paym.exMonth&&i.paym.exYear?i.paym.exMonth.month_id+"/"+i.paym.exYear.year_id:void 0,cardType:i.paym.cardType,roundOff:i.paym.roundOff?i.paym.roundOff:0};i.gridGbPaymentOptions.data.push(h),i.totalpayableAmt=(Number(i.totalpayableAmt)+parseFloat(i.paym.Amt)).toFixed(2),T(function(){i.gridGbPaymentOptions.selection.selectRow(h),i.calulatePendAmts()},50),i.disablePayType=!0,i.setPaymenttodefault(i.paym.billAmountType)},i.issueRefund=function(e){var t=i.gridrefundOptions.selection.getSelectedRows()[0],r=angular.fromJson(sessionStorage.userContextObj),a={};if(t)if(i.deposit&&1==i.deposit.Type)i.showRefundLoadingIcon=!0,a.url="HISServices/HISServices",a.requestData={operation:"savePaymentRefund",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:{"@class":"com.napier.core.collections.vo.ReceiptHeader",colReqSeqId:t.COL_REQ_SEQ_ID,counterCode:"2",gnTranStatus:1,receiptAmount:t.amtPaid,receiptDetailsList:[{"com.napier.core.collections.vo.ReceiptDetails":[{"@class":"com.napier.core.collections.vo.ReceiptDetails",amount:t.amtPaid,gnTranStatus:1,payMode:t.PayModeCode}]}],depositVo:[{"com.napier.core.service.vo.deposits.DepositsVo":[]}],receiptTranType:t.TRAN_REQ_TYPE,receivedFrom:t.receivedfrom,recpSingleOrMultiple:0,remarks:"",requestAmount:t.amtPaid,scrollAdmin:r.USER_SEQ_ID,shiftCode:"3001",totalAmt:t.amtPaid}},P.sendRestRequest(a).then(function(e){if(null==e.data.HITService.message.errorCode){var r="Amount Refunded Successfully";i.showRefundLoadingIcon=!1,i.loadBillNumbers(s.mrNo,i.gbBillNo.billno),i.loadGBDepositeGrid(),i.loadRefundRecieptList();var a={buttonText:"OK"},o={buttonCallBack1:function(){if(2===t.PayModeCode){var r={url:"HISServices/HISServices"};r.requestData={operation:"generateDeposit",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:{"@class":"com.napier.core.collections.vo.ReceiptHeader",depositListVo:{"@class":"com.napier.core.service.vo.deposits.DepositsVo",accSeqId:i.accountSeqData[0].ACC_SEQ_ID,depositAmount:e.data.HITService.message[0]["com.napier.core.collections.vo.ReceiptHeader"].receiptAmount,depositTypeCode:644950312,gnTranStatus:1,gnDepositStatus:7,depositAgainst:3}}},P.sendRestRequest(r).then(function(e){i.gridrefundOptions.data=[],T(function(){i.loadBillNumbers(s.mrNo),i.loadGBDepositeGrid()},200)})}else i.gridrefundOptions.data=[]}};v.hisAlertMulti("success","Success",r,a,o,close),i.showRefundLoadingIcon=!1}else{r="Refund failed",a={buttonText:"OK"};v.failure("Failure",r,!1,!1,me.time),i.showRefundLoadingIcon=!1}});else{var o=i.gridgbdepOptionsApi.selection.getSelectedRows();1==o.length&&m.refundCreditNote(t,o[0]).then(function(e){i.gridrefundOptions.data=[],v.hisAlertMulti("success","Success","Amount Refunded Successfully",!1,!1,i.close,1200),i.loadGBPaymentGridData("",i.gbBillNo.billno),i.loadGBDepositeGrid(),i.loadRefundRecieptList(),i.deposit.Type=1},function(e){v.failure("Failure","Refund Failed",!1,!1,me.time)})}},i.checkDepositRadio=function(){i.gridgbdepOptionsApi.selection.clearSelectedRows(),i.deposit&&2==i.deposit.Type?i.gridgbdepOptionsApi.selection.setMultiSelect(!1):i.gridgbdepOptionsApi.selection.setMultiSelect(!0)},i.checkDepRefAmt=function(){var e=i.gridgbdepOptionsApi.selection.getSelectedRows();0==e.length?(i.refund.RefdAmt=0,i.refund.roundOff=0):((e[0].appliedAmount<0||parseFloat(i.refund.RefdAmt)>parseFloat(e[0].appliedAmount))&&(i.refund.RefdAmt=parseFloat(e[0].appliedAmount),i.setRefundRounding()),1!=i.refund.mode||parseFloat(i.refund.RefdAmt)-parseFloat(i.refund.roundOff)!=parseFloat(e[0].appliedAmount)&&parseFloat(i.refund.RefdAmt)!=parseFloat(e[0].appliedAmount)?i.refund.roundOff=0:i.setRefundRounding())},i.removeFromPaymentGrid=function(e,t){i.gridGbPaymentOptions.data.splice(t,1),i.totalpayableAmt="0.00";for(var r=0;r<i.gridGbPaymentOptions.data.length;r++)i.totalpayableAmt=(parseFloat(i.totalpayableAmt)+parseFloat(i.gridGbPaymentOptions.data[r].amtPaid)).toFixed(2);0==i.gridGbPaymentOptions.data.length&&(i.disablePayType=!1,i.totalpayableAmt=0),i.calculateGBData()},i.removeFromRefundGrid=function(e,t){(i.gridrefundOptions.data.splice(t,1),i.deposit&&2==i.deposit.Type)&&(i.gridgbdepOptionsApi.selection.getSelectedGridRows()[0].clearThisRowInvisible(),i.calculateGBData())},i.savePaymentORDeposite=function(e){if(i.showPaymentLoadingIcon=!0,e)t=i.gridgbdepOptionsApi.selection.getSelectedRows();else var t=[];if(0==i.gridGbPaymentOptions.data.length&&!e||e&&0==t.length)return v.warning("Warning!","No data to save",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1;if("Unbilled"===i.gbBillNo.billno)i.paymOrdeposit(e);else{if(2==i.paym.billAmountType){var r=new Array,a={1:r},o=I.executeQueryURLReset(),s=new Array,n=i.gbBillNo.billno;return I.prepareParamListWithParam("pBillNo",n,s),I.executeQueryInput("GET_CREDIT_DATA_FOR_CANCEL_001",s,a,!0,!0,o,"popUp",{}).then(function(t){if(r[0].INVC_HD_SEQ_ID)return v.warning("Warning!","Invoice is generated, payment cannot be processed",!1,!1,me.time),i.showGBillCanLoadingIcon=!1,i.showPaymentLoadingIcon=!1,!1;i.paymOrdeposit(e)})}i.paymOrdeposit(e)}},i.paymOrdeposit=function(e){if(3!=i.paym.billAmountType||e){if(e)t=i.gridgbdepOptionsApi.selection.getSelectedRows();else var t=[];if(0==i.gridGbPaymentOptions.data.length&&0==t.length)return v.warning("Warning!","No data to save",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1;if(i.gbBillNo.billno&&"Unbilled"==i.gbBillNo.billno)var r=[];else r=i.getActivebillRecords();if(!i.gbBillNo.billno&&"Unbilled"==i.gbBillNo.billno||r.length<=0)return v.warning("Warning!","Please select atleast one bill to make payment",!1,!1,me.time),i.showPaymentLoadingIcon=!1,i.gridGbPaymentOptions.data=[],i.disablePayType=!1,!1;var a;if("YES"===i.isAllowPartialPay&&!e)if(1==i.paym.billAmountType)if(2==i.psd.partialDueAmountStatusCode){if(i.psd.partialDueAmountArroval)if((a=i.gbcal.patientDefPendAmnt)>0){if(0==i.gridGbPaymentOptions.data.length)return v.warning("Warning!","No data to save For Cash",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1;for(var o=0,n=0;n<i.gridGbPaymentOptions.data.length;n++)o=parseFloat(o)+parseFloat(i.gridGbPaymentOptions.data[n].amtPaid),i.gridGbPaymentOptions.data[n].roundOff&&(o=parseFloat(o)-parseFloat(i.gridGbPaymentOptions.data[n].roundOff)),o=parseFloat(o).toFixed(2);if(parseFloat(o)>parseFloat(a))return v.warning("Warning!","Patient payment amount should not be more than patient amount",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1;var c=parseFloat(i.psd.partialDueAmountArroval)+parseFloat(o);if(parseFloat(c)<parseFloat(a))return v.warning("Warning!","Patient Due Amount is more than Approved Due. Can Not Process The Request.",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1}}else if((a=i.gbcal.patientDefPendAmnt)>0){if(0==i.gridGbPaymentOptions.data.length)return v.warning("Warning!","No data to save For Cash",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1;for(o=0,n=0;n<i.gridGbPaymentOptions.data.length;n++)o=parseFloat(o)+parseFloat(i.gridGbPaymentOptions.data[n].amtPaid),i.gridGbPaymentOptions.data[n].roundOff&&(o=parseFloat(o)-parseFloat(i.gridGbPaymentOptions.data[n].roundOff)),o=parseFloat(o).toFixed(2);if(1==i.psd.partialDueAmountStatusCode&&parseFloat(o)<parseFloat(a))return v.warning("Warning!","Due amount Authorization is pending, cannot process the payment",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1;if((3==i.psd.partialDueAmountStatusCode||!i.psd.partialDueAmountStatusCode)&&parseFloat(o)<parseFloat(a))return v.warning("Warning!","Please collect complete patient due amount",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1}if(e){for(var l="",p=0;p<i.gbBillNUmbers.length;p++)i.gbBillNUmbers[p].BILL_NO==i.gbBillNo.billno&&(l=i.gbBillNUmbers[p]);if(""==l||!l.BILL_SEQ_ID)return v.warning("Warning!","No Bill Data to Adjust Depsoit",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1;if(i.gbcal&&0==t[0].appliedAmount&&(i.gbcal.Due_Amt<=0||i.gbcal.Pat_Amt<=0))return v.warning("Warning!","No Due Amount To Adjust Deposit.",!1,!1,me.time),i.loadGBDepositeGrid(),i.showPaymentLoadingIcon=!1,!1;m.depositBillAdjustment(t,l).then(function(e){v.success("Success","Deposit Adjusted Successfully",!1,!1,me.time),i.showPaymentLoadingIcon=!1,i.loadGBDepositeGrid(),i.loadGBPaymentGridData(l)})}else{var d="";if(t=[],angular.forEach(r,function(e){e.patColSeqId&&1==i.gridGbPaymentOptions.data[0].payerRadType&&(d=e.patColSeqId),e.payerColSeqId&&2==i.gridGbPaymentOptions.data[0].payerRadType&&(d=e.payerColSeqId)}),""==d)return v.warning("Warning!","No Collection Details to Make Payment",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1;if(i.gbcal&&i.gbcal.Due_Amt<=0)return v.warning("Warning!","No Due Amount To Make Payment",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1;var u=i.gbBillNo.billno;m.savePaymentData(i.gridGbPaymentOptions.data,i.gbBillNo.billno,d,i.gbcal.Due_Amt,t,i.billSeqids).then(function(e){var t={buttonCallBack1:function(){E.dismissAll()},buttonCallBack2:function(){i.totalpayableAmt=0;var t=u.substring(0,4);i.generatePaymentReport(e.colReqSeqId,e.receiptHdSeqId,-999,t),E.dismissAll()}};e.receiptNo&&v.hisAlertMulti("information","Information","Payment Successful "+e.receiptNo+" do you want to Print?",{buttonText:"No",buttonText2:"Yes"},t,!1),i.showPaymentLoadingIcon=!1,i.gridGbPaymentOptions.data=[],i.disablePayType=!1,i.gridgbOptions.data=[],i.gbcal={},i.loadBillNumbers(s.mrNo),i.loadGBDepositeGrid(),i.paymentReciept(e.colReqSeqId)},function(e){})}}else m.saveDepositeData(i.gridGbPaymentOptions.data,i.accountSeqData[0].ACC_SEQ_ID,i.accountSeqData[0].SUB_ACC_SEQ_ID).then(function(e){var t={buttonCallBack1:function(){var t={pColrequestSeqId:e.collectionReqseqId};j.printReportModal("depositPrintCtrl","lg","PDF",t)},buttonCallBack2:function(){}};v.hisAlertMulti("success","Success","Deposit Payment Successful <br/> Do you want to take print?",{buttonText:"Yes",buttonText2:"No"},t,close),i.showPaymentLoadingIcon=!1,i.gridGbPaymentOptions.data=[],i.totalpayableAmt=0,i.disablePayType=!1,i.paym.billAmountType="1",i.loadGBDepositeGrid()},function(e){})},i.gridpayerOptions={},i.gridpayerOptions.columnDefs=[{name:"PayerName",displayName:"Payer Name",width:100},{name:"planClassName",displayName:"Plan/class Name",width:100},{name:"policyNo",displayName:"Policy No.",width:100},{name:"startDate",displayName:"Start Date",width:100},{name:"endDate",displayName:"End Date",width:100},{name:"action",displayName:"Action",width:80,cellTemplate:'<i class="fa fa-umbrella" ng-click="function()"></i><i class="fa fa-trash"></i>'}],i.gridAuthorizationRequestOptions={},i.gridAuthorizationRequestOptions.columnDefs=[{name:"requestDate",displayName:"Request Date",width:100,enableCellEdit:!0},{name:"serviceType",displayName:"Service Type",width:100},{name:"serviceName",displayName:"Service Name",width:100},{name:"dateOfService",displayName:"Date of Service",width:100},{name:"qunty",displayName:"Quantity",width:80},{name:"rate",displayName:"Rate",width:80},{name:"payerOrPlan",displayName:"Payer/Plan",width:100},{name:"authorization",displayName:"Authorization",width:100},{name:"approvedAmt",displayName:"Approved Amt.",width:100},{name:"status",displayName:"Status",width:100},{name:"action",displayName:"Action",width:80,cellTemplate:'<i class="fa fa-pencil" ng-click="row.inlineEdit.enterEditMode($event)"></i><i class="fa fa-trash"></i>'}],i.billsIds=[],i.billsPayIds=[],i.finalErBillCheck=function(){if(i.regTypeData&&i.regTypeData.encounterType&&3==i.regTypeData.encounterType&&i.accountres.SUB_ACC_SEQ_ID){var e=[],t={1:e},r=I.executeQueryURLReset(),a=new Array;return I.prepareParamListWithParam("pEnSeqId",i.accountres.EN_SEQ_ID,a),I.executeQueryInput("ER_VISIT_FINAL_BILL_CHECK",a,t,!0,!0,r,"popUp",{}).then(function(t){e[0]&&e[0].BILL_SEQ_ID?(v.warning("Warning!","Final bill is already generated.",!1,!1,me.time),i.showGBillLoadingIcon=!1):i.generateBillForUnbilled()})}i.generateBillForUnbilled()},i.generateBillForUnbilled=function(){var e=i.gridgbOptionsApi.selection.getSelectedRows();if(i.deposit&&2==i.deposit.Type)var t=[];else t=i.gridgbdepOptionsApi.selection.getSelectedRows();if(i.showGBillLoadingIcon=!0,e.length<=0)return v.warning("Warning!","Please select atleast one service to generate Bill",!1,!1,me.time),i.showGBillLoadingIcon=!1,!1;if(i.gbcal&&i.gbcal.Due_Amt<0&&0==i.gbcal.Deposite_Adj)return v.warning("Warning!","No Due Amount To generate bill",!1,!1,me.time),i.showGBillLoadingIcon=!1,!1;if("YES"===i.isAllowPartialPay){if(0!=i.gridGbPaymentOptions.data.length){if(i.gbBillNo.billno&&"Unbilled"==i.gbBillNo.billno)var r=+(parseFloat(i.gbcal.patPendDefAmtForCSBill)-parseFloat(i.gbcal.Concession_Amt)-parseFloat(i.gbcal.Deposite_Adj)).toFixed(2);else r=+(parseFloat(i.gbcal.Pat_Amt)-parseFloat(i.gbcal.Concession_Amt)-parseFloat(i.gbcal.Deposite_Adj)).toFixed(2);for(var a=0,o=0;o<i.gridGbPaymentOptions.data.length;o++)a=parseFloat(a)+parseFloat(i.gridGbPaymentOptions.data[o].amtPaid),i.gridGbPaymentOptions.data[o].roundOff&&(a=parseFloat(a)-parseFloat(i.gridGbPaymentOptions.data[o].roundOff)),a=parseFloat(a).toFixed(2);if(1==i.psd.partialDueAmountStatusCode&&a<r)return v.warning("Warning!","Due amount Authorization is pending, Can't generate bill with partial payment.",!1,!1,me.time),i.showGBillLoadingIcon=!1,!1;if((3==i.psd.partialDueAmountStatusCode||!i.psd.partialDueAmountStatusCode)&&a<r)return v.warning("Warning!","Can't generate bill with partial payment.",!1,!1,me.time),i.showGBillLoadingIcon=!1,!1;if(2==i.psd.partialDueAmountStatusCode)if(parseFloat(i.psd.partialDueAmountArroval)+parseFloat(a)<r)return v.warning("Warning!","Patient Due Amount is more than Approved Due. Can Not Process The Request for generate bill.",!1,!1,me.time),i.showGBillLoadingIcon=!1,!1}if(i.psd&&i.psd.partialRequestSeqId)var n=i.psd.partialRequestSeqId}m.generateBillForUnbilled(e,i.accountSeqData[0].ACC_SEQ_ID,i.accountSeqData[0].SUB_ACC_SEQ_ID,i.gbcal,i.gridGbPaymentOptions.data,t,i.gridConcReqOptions.data,n).then(function(e){var t=e.data.HITService.message.bill[0]["com.napier.core.billgeneration.vo.Bill"],r=e.data.HITService.message.receiptDetailsList[0]["com.napier.core.collections.vo.ReceiptDetails"],a={buttonClose:function(){for(var e=0,t=0;t<i.RowsArr.length;t++)1!=i.RowsArr[t][0].billStatus&&(e=1);i.orderBtnDisable=0==e}},o={buttonCallBack1:function(){E.dismissAll();for(var e=0,t=0;t<i.RowsArr.length;t++)1!=i.RowsArr[t][0].billStatus&&(e=1);i.orderBtnDisable=0==e},buttonCallBack2:function(){"HSC"==sessionStorage.productCustomization?i.generateBillPrintReportOption("",t.billNo):null==r?angular.forEach(t,function(e,t){i.billsIds=[],i.billsIds=e,i.generateBillReport(e.billSeqId,e.billNo)}):(i.billsPayIds=[],i.billsPayIds=t,angular.forEach(t,function(e,t){var r=e.billNo?e.billNo.substring(0,4):"";i.generatePaymentReport(e.scrollSeqId,-999,-999,r,!0)})),E.dismissAll();for(var e=0,a=0;a<i.RowsArr.length;a++)1!=i.RowsArr[a][0].billStatus&&(e=1);i.orderBtnDisable=0==e}};t=t instanceof Array?t:[t];var n="",c=[];angular.forEach(t,function(e,t){n=n+" & "+e.billNo,c.push(e.billNo)}),n=n.substring(2,n.length),t[0].billNo&&t[0].billSeqId&&("HSC"==i.hscSpecific?i.generateBillPrintReportOptionForMulti(c):v.hisAlertMulti("information","Information","Bill Generation Successful "+n+" do you want to Print?",{buttonText:"No",buttonText2:"Yes"},o,a),i.showGBillLoadingIcon=!1,i.loadBillNumbers(s.mrNo),i.retriveRecords(),T(function(){i.loadGBDepositeGrid()},300))},function(e){i.showGBillLoadingIcon=!1})},i.checkIfPharmacyServiceIsPartial=function(){var e=[],t={1:e},r=I.executeQueryURLReset(),a=new Array;return I.prepareParamListWithParam("pEncId",s.encounterSeqId,a),I.executeQueryInput("CHECK_PHARMACY_ISSUED_OR_NOT",a,t,!0,!0,r,"popUp",{}).then(function(t){if(e.length>0&&"2"!=e[0].issue_status){if("0"==e[0].issue_status)var r="Pharmacy issue is not done. Do you want to continue ?";else r="Pharmacy service is partially taken, Do you want to continue ?";var a={buttonCallBack1:function(){i.finalErBillCheck()},buttonCallBack2:function(){return i.showGBillLoadingIcon=!1,!1}};v.hisAlertMulti("warning","Confirmation",r,{buttonText:"YES",buttonText2:"NO"},a,close)}else i.finalErBillCheck()})},i.checkIfDepositIsAdjForUnbilled=function(){if(i.confirmTempOREmerPat()&&!i.showGBillLoadingIcon){i.showGBillLoadingIcon=!0;var e=i.gridgbdepOptionsApi.selection.getSelectedRows();if(i.gridfOptions.data.length>0&&0==e.length){var t={buttonCallBack1:function(){i.activeBillTab(2),i.showGBillLoadingIcon=!1},buttonCallBack2:function(){i.checkIfPharmacyServiceIsPartial()}};v.hisAlertMulti("warning","Confirmation","Deposit amount is available. Do you want to adjust against bill ?",{buttonText:"YES",buttonText2:"NO"},t,close)}else i.checkIfPharmacyServiceIsPartial()}},i.partialPayAuthBilled=function(e){if(!(parseFloat(e.Pat_Amt)>0))return v.warning("Warning!","Patient Amount should be more than zero",!1,!1,me.time),!1;var t=parseFloat(e.Pat_Amt)-parseFloat(e.Concession_Amt)-parseFloat(e.Deposite_Adj);if(0==t)return v.warning("Warning!","Patient Due Amount should be more than zero",!1,!1,me.time),!1;i.partialPayDetails=e,S.open("PARTIAL PAYMENT AUTHORIZATION",{animation:!0,windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-partial-pay-auth.html",controller:"opVisitPartialPayAuthCtrl",controllerAs:"cas",keyboard:!1,resolve:{data:{payAuthTotalAmount:e.Net_Amt,payAuthPatientAmount:t,ordervisitId:sessionStorage.getItem("ordervisitId"),orderencounterSeqId:sessionStorage.getItem("orderencounterSeqId"),orderregSeqId:sessionStorage.getItem("orderregSeqId"),billNo:i.gbBillNo.billno}},backdrop:"static",size:"md"}).result.then(function(e){e&&i.loadGBPaymentGridData("",e)})},i.addNewPayer=function(e){i.modalInstance=S.open("ADD NEW PAYER",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-addNewPayerDetails.html",size:"lg",scope:i}),i.addSelectPayer="",i.insure1=!1,i.corp1=!1,i.spon1=!1},i.selPayer=function(e){"Insurance"!=e&&"Corporate"!=e&&"Sponsor"!=e&&""!=e||(i.addSelectPayer="",i.insure1=!1,i.corp1=!1,i.spon1=!1)},i.getAllPayerDetail=function(e){i.PA.fromDate=new Date,i.serviceData=[],i.singleComboDataForList={1:i.serviceData};var t=I.executeQueryURLReset();return i.serviceDataList=new Array,I.prepareParamListWithParam("pRegSeqId",e,i.serviceDataList),I.executeQueryInput("GET_PAYERS_V0012",i.serviceDataList,i.singleComboDataForList,!0,!0,t,"popUp",i.advSearch).then(function(e){i.AllPayerDetails=e[1]})},i.setNewPayerFormtoDef=function(){i.insure1=!1,i.uplodedDocDetails={},angular.element(document.querySelector("#addNewPayerInsdoc"))[0].value="",i.addNewPayerIns={isPrmry:0,covrgStrtDate:moment()}},i.editPayerDetails=function(e){i.payinsurer(e.INCSEQID),i.addNewPayerIns={crPyrId:e.INCSEQID?e.INCSEQID.toString():void 0,policyNo:e.POLICY_NO,regDocSeqId:e.DOC_SEQID?e.DOC_SEQID:void 0,rank:e.PIRANK?e.PIRANK:void 0,isPrmry:e.IS_PRIMARY?e.IS_PRIMARY:0,dependent:e.PI_DEPENDENT?e.PI_DEPENDENT:void 0,limit:e.LIMIT?e.LIMIT:void 0,CardNumber:e.CARD_NUMBER,covrgStrtDate:e.STARTDATE,covrgEndDate:e.ENDDATE,incPlanSeqId:e.INC_PLAN_SEQ_ID?e.INC_PLAN_SEQ_ID.toString():void 0,editMode:!0,PINS_SEQ_ID:e.PINS_SEQ_ID?e.PINS_SEQ_ID:void 0}},i.updatePrintInClaimForm=function(e){le.updatePrintInClaimForm(e).then(function(e){})},i.viewPayerDocument=function(e){ae.viewUploadedFileFun(e).then(function(e){if(!angular.isUndefined(e.data.HITService.message.uploadDocumnt[0])){var t=e.data.HITService.message.uploadDocumnt[0],r=e.data.HITService.message.docExtension,a=t.replace("dataimage/jpegbase64","").replace("dataapplication/pdfbase64","").replace("dataapplication/vndopenxmlformatsofficedocumentwordprocessingmldocumentbase6\n4","").replace("dataimage/pngbase64","").replace("\n",""),i=r.toLowerCase();if("pdf"==i||"jpg"==i||"png"==i||"gif"==i||"jpeg"==i||"tif"==i||"tiff"==i||"bmp"==i)fe(a,i);else if("xls"==i){var o="data:application/vnd.ms-excel,"+a;window.open(o,"_self")}else if("xlsx"==i){var s="data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"+";base64,"+a;window.open(s,"_self")}else{if("docx"==i||"doc"==i)Te("data:application/octet-stream;base64,"+a,"download.docx")}}})};var fe=function(e,t){S.open("",{animation:!0,templateUrl:"app/consumer/his17_2/ADT/screens/patientAdmission/sections/upload.image.view.modal.html",size:"lg",controller:"viewUploadsCtrl",controllerAs:"viewCtrl",resolve:{imgUrl:function(){return e},extF:function(){return t}}})},Te=function(e,t){var r=document.createElement("a");r.download=t,r.href=e,r.click()};i.nonCoveredSerice=function(e,t,r,a){i.modalInstance=S.open("NON-COVERED SERVICES",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups, noncoveredservices",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-payerNonCoveredServices-modal-popup.html",size:"md",scope:i}),T(function(){var e,o=I.executeQueryURLReset();return i.OPVMsearchBypatientNameList=new Array,i.multipleComboDataForList={1:i.OPVMsearchBypatientNameList},e="003"===a?-999:r,I.prepareParamListWithParam("pPlanSeqId",null!=e?e:-999,i.OPVMsearchBypatientNameList),I.prepareParamListWithParam("pCmpSeqId",t,i.OPVMsearchBypatientNameList),I.executeQueryInput("PAYAUTH_CMP_PLAN_EXCLSN_SERV_LIST",i.OPVMsearchBypatientNameList,i.multipleComboDataForList,!0,!0,o,"popUp",{}).then(function(e){if(i.nonCoveredGridData=[],2==e[1].length)i.nonCoveredGridData.push({SERV_CODE:"No Records Found"});else for(var t=2;t<e[1].length;t++)i.nonCoveredGridData.push({SERV_CODE:e[1][t].SERV_CODE,SERV_NAME:e[1][t].SERV_NAME})})},100)},i.getAllPayersData=function(){var e={1:[]},t=I.executeQueryURLReset(),r=new Array;return I.prepareParamListWithParam("practiceId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,r),I.executeQueryInput("GET_PAYER_DROPDOWN_001",r,e,!0,!0,t,"popUp",i.advSearch).then(function(e){i.AllPayersData=e[1]})},i.getAllPayersData(),i.getAllCorData=function(){i.CorData=[],i.CorDataForList={1:i.CorData};var e=I.executeQueryURLReset();return i.CorDataList=new Array,I.prepareParamListWithParam("practiceId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.CorDataList),I.executeQueryInput("CORP_DROPDOWN",i.CorDataList,i.CorDataForList,!0,!0,e,"popUp",i.advSearch).then(function(e){i.AllCorDetails=e[1]})},i.getAllCorData(),i.getAllInsCreData=function(){i.InsCreData=[],i.InsCreDataForList={1:i.InsCreData};var e=I.executeQueryURLReset();return i.InsCreDataList=new Array,I.prepareParamListWithParam("practiceId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.InsCreDataList),I.executeQueryInput("INSURER_DROPDOWN",i.InsCreDataList,i.InsCreDataForList,!0,!0,e,"popUp",i.advSearch).then(function(e){i.AllInsCreDetails=e[1]})},i.getAllInsCreData(),i.payinsurer=function(e){i.InsPalnData=[],i.InsPalnDataForList={1:i.InsPalnData};var t=I.executeQueryURLReset();return i.InsPalnDataList=new Array,I.prepareParamListWithParam("pPlan",e,i.InsPalnDataList),I.executeQueryInput("PLAN_DROPDOWN",i.InsPalnDataList,i.InsPalnDataForList,!0,!0,t,"popUp",i.advSearch).then(function(e){i.AllInsPalnDetails=e[1]})},i.getAllSpoData=function(){i.SpoData=[],i.SpoDataForList={1:i.SpoData};var e=I.executeQueryURLReset();return i.SpoDataList=new Array,I.prepareParamListWithParam("practiceId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.SpoDataList),I.executeQueryInput("SPONCER_DROPDOWN",i.SpoDataList,i.SpoDataForList,!0,!0,e,"popUp",i.advSearch).then(function(e){i.AllSpoDetails=e[1]})},i.getAllSpoData(),i.sponserChange=function(e){i.SpoPalnData=[],i.SpoPalnDataForList={1:i.SpoPalnData};var t=I.executeQueryURLReset();return i.SpoPalnDataList=new Array,I.prepareParamListWithParam("pSpoSeqId",e,i.SpoPalnDataList),I.executeQueryInput("SPO_PLAN_DROPDOWN",i.SpoPalnDataList,i.SpoPalnDataForList,!0,!0,t,"popUp",i.advSearch).then(function(e){i.AllSpoPalnDetails=e[1]})},i.InsupayerStartDateOptions={format:i.CD.dateOnly.format,maxDate:new Date},i.InsupayerEndDateOptions={format:i.CD.dateOnly.format},i.InsuchangeFromDate=function(e){i.InsupayerEndDateOptions.minDate=e},i.CorpayerStartDateOptions={format:i.CD.dateOnly.format,maxDate:new Date},i.CorpayerEndDateOptions={format:i.CD.dateOnly.format},i.CorchangeFromDate=function(e){i.CorpayerEndDateOptions.minDate=e},i.SpopayerStartDateOptions={format:i.CD.dateOnly.format,maxDate:new Date},i.SpopayerEndDateOptions={format:i.CD.dateOnly.format},i.SpochangeFromDate=function(e){i.SpopayerEndDateOptions.minDate=e},i.addNewInsuranceSave=function(e){if(i.insure1=!0,void 0!==e.crPyrId&&void 0!==e.incPlanSeqId&&void 0!==e.policyNo&&void 0!==e.covrgStrtDate&&void 0!==e.covrgEndDate&&void 0!==e.limit){if(0==e.isPrmry)var t="";else t=e.dependent;try{var r=i.uplodedDocDetails.docSeqId.toString()}catch(e){r=""}if(e.regDocSeqId&&e.editMode){var a="updateOrDeleteInsurance";e.crPyrId=parseInt(e.crPyrId),e.incPlanSeqId=parseInt(e.incPlanSeqId),""==r&&e.regDocSeqId&&(r=e.regDocSeqId.toString())}else a="savePayerInsDetails";var o={url:"HISServices/HISServices"};o.requestData={operation:a,messageId:"",destination:"com.napier.core.billing.service.external.PayerDetailsService",message:{"@class":"com.napier.core.service.vo.billing.InsurenceList",insurenceList:[{"com.napier.core.service.vo.billing.Insurance":[{insuranceSeqId:e.PINS_SEQ_ID&&e.editMode?e.PINS_SEQ_ID:void 0,rgSeqId:s.patientSeqId,crPyrId:e.crPyrId,subscribId:e.policyNo,regDocSeqId:r,rank:e.rank,remarks:e.remarks,isPrmry:e.isPrmry,dependent:t,limit:e.limit,cardNumber:e.CardNumber,covrgStrtDate:moment(e.covrgStrtDate).format("YYYY-MM-DD[T]00:00:00.000Z").split("+")[0]+"Z",covrgEndDate:moment(e.covrgEndDate).format("YYYY-MM-DD[T]00:00:00.000Z").split("+")[0]+"Z",delete:e.PINS_SEQ_ID&&e.editMode?2:void 0,cmpSeqId:{incSeqId:e.crPyrId},insurancePlanMaster:{incPlanSeqId:e.incPlanSeqId},inusranceType:{inTypeSeqCd:e.crPyrId}}]}]}},P.sendRestRequest(o).then(function(t){i.result=t.data;var r={buttonClose:function(){E.dismissAll(),i.getAllPayerDetail(s.patientSeqId),i.activeFirst=5}};if(-100==i.result.HITService.message.errorCode){var a=i.result.HITService.message.errorMessage;v.hisAlertMulti("failure","Failure",a,"","",r)}else if(2036==i.result.HITService.message.errorCode){a=i.result.HITService.message.errorMessage;v.hisAlertMulti("warning","Warning!",a,"","",r)}else{if(e.editMode)a="Record Updated Successfully ";else a="Record Saved Successfully ";v.hisAlertMulti("success","Success",a,"","",r),i.getPatAllPayers(s.patientSeqId),i.setNewPayerFormtoDef(),R.patientBannerDetail(s.patientSeqId).then(function(e){if(i.upldphotoDoc=e,i.patientBannerDetails=e,e.insurance){var t=e.insurance;(t=t instanceof Array?t:[t])[0].cmpSeqId&&t[0].cmpSeqId.inCompName&&(s.patientGlobalDtlsNew[0].insuranceComp=t[0].cmpSeqId.inCompName),t[0].insurancePlanMaster&&t[0].insurancePlanMaster.inPlanName&&(s.patientGlobalDtlsNew[0].insurancePlan=t[0].insurancePlanMaster.inPlanName),t[0].covrgStrtDate&&t[0].covrgStrtDate.$&&(s.patientGlobalDtlsNew[0].pEffectivedate=t[0].covrgStrtDate.$),t[0].covrgEndDate&&t[0].covrgEndDate.$&&(s.patientGlobalDtlsNew[0].pExpiredate=t[0].covrgEndDate.$),i.noPayer=!0}s.patientGlobalDtlsNew[0].userPermision=12,s.patientName=s.patientGlobalDtlsNew[0].patientName,""==s.tariffSeqId&&(s.tariffSeqId=s.patientGlobalDtlsNew[0].tariffSeqId),s.insuranceComp=s.patientGlobalDtlsNew[0].insuranceComp,s.patCatSeqId=s.patientGlobalDtlsNew[0].patCatSeqId,s.mrNo=s.patientGlobalDtlsNew[0].mrNo}),T(function(){E.dismissAll(),i.getAllPayerDetail(s.patientSeqId),i.getPayerDetail(s.patientSeqId,sessionStorage.getItem("orderencounterSeqId")),i.activeFirst=5},600)}},function(e){v.failure("Failed",e,!1,!1,me.time)})}},i.planRequired=!1,i.addPayerAuthrList=[],i.disablePlan=!0,i.showErrors=!1,i.showPlanError=!1,i.disablePlan=!0,i.statusReq=!1,$("#removeReqStatusNo").removeClass("req-field"),$("#removeReqStatusAmnt").removeClass("req-field"),$("#removeReqValid").removeClass("req-field"),i.reqFromOrder=!1,i.gotoPreAutherisation=function(e,t){var r={buttonClose:function(){E.dismissAll()}};if("self"!=t[0].payerType.toLocaleLowerCase()){if(t[0].payerAmount==t[0].serviceRate)return v.warning("Warning!","Service is already covered by the Payer, authorization is not allowed",!1,!1,me.time),!1;var a={};a.url=N.updateService.URL,a.requestData={operation:"checkOrderCancel",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.master.vo.ServiceListVo",serviceList:[{"com.napier.core.scm.master.vo.ServiceVo":[{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:t[0].servicePostingSeqId,servDesc:t[0].servName,gnServDesign:null!=t[0].appointReason?t[0].appointReason:2}]}]}},P.sendRestRequest(a).then(function(e){if(""==e.data.HITService.message.serviceList[0]){i.activeFirst=5,i.reqFromOrder=!0;var r=t[0].payerType.split("/");i.OrderPayerName=r[0],i.OrderPlanName=r[1],i.PA.PAServiceType=t[0].serviceTypeCODE,i.PA.PAServiceRequest=t[0].servName,i.PA.serCode=t[0].servCode,i.PA.serSeqId=t[0].servSeqId,i.PA.PAUnitDays=t[0].quantity,i.payerCompPlanseqId=t[0].payerCompPlanseqId,i.payerCompSeqId=t[0].payerCompSeqId,s.orderRowData=t,i.getAllPayerDetail(s.patientSeqId),i.getPatAllPayers(s.patientSeqId)}else v.warning("Warning!","We Can't go for Authorization for this Service",!1,!1,me.time)})}else v.hisAlertMulti("warning","Warning!","Not Authorized for Self","","",r)},i.approvePayerAuthentication=function(e,t){if(null==e.ApprovedAmt||""==e.ApprovedAmt||parseInt(e.ApprovedAmt)<=0)v.warning("Warning!","Please enter valid Appr.Amt",!1,!1,me.time);else{var r="Not Approved";void 0!==e.status&&(r=e.status);var a,o=0;void 0!==s.tariffSeqId&&(o=s.tariffSeqId),a=null!=s.convertedFile?s.convertedFile.split("base64")[1]:"";var n=0;void 0!==s.patCatSeqId&&(n=s.patCatSeqId);var c=0,l=0;void 0!==e.ApprovedAmt&&(c=e.ApprovedAmt),void 0!==e.AuthNumber&&(l=e.AuthNumber);var p=0;if(void 0!==i.payerCompPlanseqId&&(p=i.payerCompPlanseqId),t.$valid&&0==i.statusReq&&0==i.amountValid){var d=moment(e.fromDate).format("YYYY-MM-DD[T]00:00:00.000Z").split("+")[0]+"Z",m={};m.url=N.updateService.URL,m.requestData={operation:"saveNewAuthorization",messageId:"",destination:"com.napier.core.billgeneration.service.external.ApproximateBillService",message:{"@class":"com.napier.core.billgeneration.vo.ApproxBillList",approxBillVos:[{"com.napier.core.billgeneration.vo.ApproxBillVo":[{StrExpectedDays:e.PAUnitDays,tariffSeqId:o,icdCode:"",regSeqId:s.patientSeqId,patientcategorySeqId:n,approxBillDate:d,approvalRefNo:l,approvedAmount:c,payerType:p,subAccSeqId:sessionStorage.getItem("subaccountseqId"),approxBillServiceDtlsVoList:[{"com.napier.core.billgeneration.vo.ApproxBillServiceDtlsVo":[{serviceCode:e.serCode,serviceSeqId:e.serSeqId,serviceName:e.PAServiceRequest,serviceQty:e.PAUnitDays,serviceTax:0,serviceDiscountAmt:0,expcServDate:d,gnTranStatus:1,approvedDetails:r,actualRate:void 0!==s.orderRowData[0].serviceRate?s.orderRowData[0].serviceRate:0}]}],napierDocument:{"@class":"com.napier.core.service.vo.uploadfile.NapierDocument",facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,docName:angular.element(document.querySelector("#PA-payer-upload-file"))[0].value,uploadDocumnt:a,status:"1",createdBy:JSON.parse(sessionStorage.userContextObj).USER_SEQ_ID,createdDate:d,context:15,docTypeSeqId:36,machineIp:JSON.parse(sessionStorage.userContextObj).WORKSTATION,referenceId:0,contextDetailMaster:{"@class":"com.napier.core.service.vo.uploadfile.ContextDetailMaster",code:25}}}]}]}},P.sendRestRequest(m).then(function(e){var t={buttonClose:function(){E.dismissAll(),i.getAddedPreAuths(s.patientSeqId),i.reqFromOrder=!1,i.PA={},i.PA={fromDate:new Date,PAUnitDays:1},angular.element(document.querySelector("#PA-payer-upload-file"))[0].value="",s.convertedFile=null,i.disablePlan=!0,i.showErrors=!1,i.showPlanError=!1,i.statusReq=!1,$("#removeReqStatusNo").removeClass("req-field"),$("#removeReqStatusAmnt").removeClass("req-field"),i.activeFirst=2,i.getPatientPayerAmount()}};if(void 0!==e.data.HITService.message.errorCode){var r=e.data.HITService.message.errorMessage;v.hisAlertMulti("failure","Failure",r,"","",t)}else{r="Request Created Successfully";v.hisAlertMulti("success","Success",r,"","",t)}})}}},i.refreshPatientPayerAmount=function(e,t){i.serviceDataArr=[];var r=new Date,a=moment(r).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";(l={}).url=N.updateService.URL;var o="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,o=i.priorityvis.priorityTypeModel.DT_CODE):("Routine",o=1);var n=o;if(i.setCurrentTarrifId(),1!=e.appointReason){var c=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:e.servSeqId,gnServDesign:1,servCode:e.servCode,servName:e.servName,secServTypeCode:e.serviceTypeCODE,priServTypCode:e.serviceTypeCODE},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:e.servSeqId,tariffSeqId:s.tariffSeqId,datedOn:a,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},quantity:e.quantity,transType:1,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:e.requestedByEmpSeqID,payerId:i.payerTypeModel.PayerType.PINS_SEQ_ID,fromOPVisit:"Y",priority:n}];i.serviceDataArr.push(c),l.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.serviceDataArr}]}}}else{var l,p={"@class":"com.napier.core.service.vo.visitmanagement.VisitConfigurationDetails",doctorSeqId:e.requestedByEmpSeqID,tariffSeqId:s.tariffSeqId,regSeqId:sessionStorage.getItem("orderregSeqId"),enSeqId:sessionStorage.getItem("orderencounterSeqId"),payerId:e.payerTypeCode,quantity:e.quantity};(l={}).url=N.updateService.URL,l.requestData={operation:"getServiceRateByDoctorSpecialitywise",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:p}}P.sendRestRequest(l).then(function(e){i.serResponce=e.data.HITService.message;for(var r=i.serResponce.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"],a=0;a<i.RowsArr.length;a++)i.RowsArr[a][0].servSeqId==t.servSeq&&i.RowsArr[a][0].payerType==t.plan&&1!=i.RowsArr[a][0].billStatus&&(i.RowsArr[a][0].patientAmount=r.patientAmount,i.RowsArr[a][0].payerAmount=r.payerAmount,i.RowsArr[a][0].originalPatientAmount=r.originalPatientAmount,i.RowsArr[a][0].originalPayerAmount=r.originalPayerAmount,i.RowsArr[a][0].servicePayerAuthorization=r.servicePayerAuthorization)})},i.getPatientPayerAmount=function(){i.serviceDataArr=[];var e=new Date,t=moment(e).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";(n={}).url=N.updateService.URL;var r="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,r=i.priorityvis.priorityTypeModel.DT_CODE):("Routine",r=1);var a=r;if(i.setCurrentTarrifId(),1!=s.orderRowData[0].appointReason){var o=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:s.orderRowData[0].servSeqId,gnServDesign:1,servCode:s.orderRowData[0].servCode,servName:s.orderRowData[0].servName,secServTypeCode:s.orderRowData[0].serviceTypeCODE,priServTypCode:s.orderRowData[0].serviceTypeCODE},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:s.orderRowData[0].servSeqId,tariffSeqId:s.tariffSeqId,datedOn:t,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},quantity:s.orderRowData[0].quantity,transType:1,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:s.orderRowData[0].requestedByEmpSeqID,payerId:i.payerTypeModel.PayerType.PINS_SEQ_ID,fromOPVisit:"Y",priority:a}];i.serviceDataArr.push(o),n.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.serviceDataArr}]}}}else{var n,c={"@class":"com.napier.core.service.vo.visitmanagement.VisitConfigurationDetails",doctorSeqId:s.orderRowData[0].requestedByEmpSeqID,tariffSeqId:s.tariffSeqId,regSeqId:sessionStorage.getItem("orderregSeqId"),enSeqId:sessionStorage.getItem("orderencounterSeqId"),payerId:s.orderRowData[0].payerTypeCode,quantity:s.orderRowData[0].quantity};(n={}).url=N.updateService.URL,n.requestData={operation:"getServiceRateByDoctorSpecialitywise",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:c}}P.sendRestRequest(n).then(function(e){i.serResponce=e.data.HITService.message;var t=i.serResponce.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];s.orderRowData[0].patientAmount=t.patientAmount,s.orderRowData[0].payerAmount=t.payerAmount;let r=null!=t.copayAmt?parseFloat(t.copayAmt):parseFloat(0);s.orderRowData[0].originalPatientAmount=null==t.companyPayingAmt||0==t.companyPayingAmt?t.serviceRate:parseFloat(t.companyPayingAmt)>t.serviceRate?parseFloat(0):null!=t.actualRate&&parseFloat(t.companyPayingAmt)+r>=t.actualRate?parseFloat(0):parseFloat((t.serviceRate-parseFloat(t.companyPayingAmt)).toFixed(2))-r,s.orderRowData[0].originalPayerAmount=null==t.companyPayingAmt||0==t.companyPayingAmt?parseFloat(0):parseFloat(t.companyPayingAmt)>t.serviceRate?t.serviceRate:null!=t.actualRate&&parseFloat(t.companyPayingAmt)+r>=t.actualRate?t.serviceRate:t.companyPayingAmt+r>t.serviceRate?t.serviceRate:t.companyPayingAmt+r,s.orderRowData[0].servicePayerAuthorization=t.servicePayerAuthorization,i.preAuthRcdList=[],i.preAuthHdrRcdList={},le.opPreAuthGetData(i,i.RowsArr)})},i.amountValid=!1,s.orderRowData=null,i.amountValidation=function(e){if(void 0!==s.orderRowData){var t=s.orderRowData[0].serviceRate*s.orderRowData[0].quantity;i.amountValid=e>t}},i.setPlanValidation=function(e){i.showPlanError=!1},i.addPayerAuthentication=function(e,t){i.showErrors=!0,"004"!=e.PAPayer.INS_TYPE?void 0!==e.PApayerSelectPlan&&null!=e.PApayerSelectPlan?i.showPlanError=!1:i.showPlanError=!0:i.showPlanError=!1,"Approved"==e.status||"Partially Approved"==e.status?(void 0!==e.AuthNumber?i.statusReq=!1:i.statusReq=!0,void 0!==e.ApprovedAmt?i.statusReq=!1:i.statusReq=!0):i.statusReq=!1;var r=0,a=0,o=0,n="Not Approved",c=0;if(t.$valid&&0==i.statusReq){var l;i.showPlanError=!1,void 0!==e.ApprovedAmt&&(r=e.ApprovedAmt),void 0!==e.AuthNumber&&(a=e.AuthNumber),o=void 0!==e.PApayerSelectPlan?e.PApayerSelectPlan.PINS_SEQ_ID:i.AllPatPlanDetails[0].PINS_SEQ_ID,void 0!==e.status&&(n=e.status),void 0!==s.tariffSeqId&&(c=s.tariffSeqId),l=null!=s.convertedFile?s.convertedFile.split("base64")[1]:"";var p=0;void 0!==s.patCatSeqId&&(p=s.patCatSeqId);var d=moment(e.fromDate).format("YYYY-MM-DD[T]00:00:00.000Z").split("+")[0]+"Z",m={};m.url=N.updateService.URL,m.requestData={operation:"saveNewAuthorization",messageId:"",destination:"com.napier.core.billgeneration.service.external.ApproximateBillService",message:{"@class":"com.napier.core.billgeneration.vo.ApproxBillList",approxBillVos:[{"com.napier.core.billgeneration.vo.ApproxBillVo":[{StrExpectedDays:e.PAUnitDays,tariffSeqId:c,icdCode:"",regSeqId:s.patientSeqId,patientcategorySeqId:p,approxBillDate:d,approvalRefNo:a,approvedAmount:r,payerType:o,approxBillServiceDtlsVoList:[{"com.napier.core.billgeneration.vo.ApproxBillServiceDtlsVo":[{serviceCode:e.serCode,serviceSeqId:e.serSeqId,serviceName:e.PAServiceRequest,serviceQty:1,serviceTax:0,serviceDiscountAmt:0,expcServDate:d,gnTranStatus:1,approvedDetails:n}]}],napierDocument:{"@class":"com.napier.core.service.vo.uploadfile.NapierDocument",facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,docName:angular.element(document.querySelector("#PA-payer-upload-file"))[0].value,uploadDocumnt:l,status:"1",createdBy:JSON.parse(sessionStorage.userContextObj).USER_SEQ_ID,createdDate:d,context:15,docTypeSeqId:36,machineIp:JSON.parse(sessionStorage.userContextObj).WORKSTATION,referenceId:0,contextDetailMaster:{"@class":"com.napier.core.service.vo.uploadfile.ContextDetailMaster",code:25}}}]}]}},P.sendRestRequest(m).then(function(e){var t={buttonClose:function(){E.dismissAll();var e=r.HITService.message.approxBillVos[0]["com.napier.core.billgeneration.vo.ApproxBillVo"][0];r.HITService.message.approxBillVos[0]["com.napier.core.billgeneration.vo.ApproxBillVo"][1],e.approxBillServiceDtlsVoList[0]["com.napier.core.billgeneration.vo.ApproxBillServiceDtlsVo"];i.PA={},i.PA={fromDate:new Date,PAUnitDays:1},angular.element(document.querySelector("#PA-payer-upload-file"))[0].value="",s.convertedFile=null,i.disablePlan=!0,i.showErrors=!1,i.showPlanError=!1,i.statusReq=!1}},r=e.data;if(-100==r.HITService.message.errorCode){var a=r.HITService.message.errorMessage;v.hisAlertMulti("failure","Failure",a,"","",t)}else if(2044==r.HITService.message.errorCode){a=r.HITService.message.errorMessage;v.hisAlertMulti("warning","Warning!",a,"","",t)}else{a="Request Created Successfully";v.hisAlertMulti("success","Success",a,"","",t),$("#removeReqStatusNo").removeClass("req-field"),$("#removeReqStatusAmnt").removeClass("req-field"),i.getAddedPreAuths(s.patientSeqId),T(function(){E.dismissAll();var e=r.HITService.message.approxBillVos[0]["com.napier.core.billgeneration.vo.ApproxBillVo"][0];r.HITService.message.approxBillVos[0]["com.napier.core.billgeneration.vo.ApproxBillVo"][1],e.approxBillServiceDtlsVoList[0]["com.napier.core.billgeneration.vo.ApproxBillServiceDtlsVo"];i.PA={},i.PA={fromDate:new Date,PAUnitDays:1},angular.element(document.querySelector("#PA-payer-upload-file"))[0].value="",s.convertedFile=null,i.disablePlan=!0,i.showErrors=!1,i.showPlanError=!1,i.statusReq=!1},3e3)}})}},i.getProvisionalBill=function(){0!=i.gridgbOptionsApi.selection.getSelectedRows().length?c.open({animation:!0,templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/sections/provisional.bill.modal.html",size:"sm",backdrop:"static",controller:"PrintTypeSelection",resolve:{selectedPrintType:function(){return!1}}}).result.then(function(e){for(var t=[],r=0;r<i.gridgbOptionsApi.selection.getSelectedRows().length;r++){var a=i.gridgbOptionsApi.selection.getSelectedRows()[r];if(4!=a.payerType&&"PDF"!=e){var o=a.accPayerSeqId,n=a.planSeqId;t.push(a.servicePostingSeqId)}else 4==a.payerType&&"PDF"==e&&t.push(a.servicePostingSeqId)}if(o||"PDF"==e)if(0!=t.length||"PDF"!=e){var c={reportId:"PDF"==e?"OPProvisionalCashBillReportID":"OPProvisionalBillCreditReportID",pSubSeqId:i.accountres.SUB_ACC_SEQ_ID,pEnNo:s.encounterSeqId,pBillStatus:0,pServSeqId:_.toString(t),pPayerSeqId:"PDF"!=e?o:-999,pPlanSeqId:"PDF"!=e?n:-999,coPayAmount:parseFloat(i.gbcal.coPay).toFixed(2),deductableAmount:parseFloat(i.gbcal.deductibleAmount).toFixed(2),totalNetPatientAmount:parseFloat(i.gbcal.Pat_Amt).toFixed(2),totalNetPayerAmount:parseFloat(i.gbcal.Payr_Amt).toFixed(2),ConcessonAmount:parseFloat(i.gbcal.Concession_Amt).toFixed(2),AdjustmentAmount:parseFloat(i.gbcal.Deposite_Adj).toFixed(2),PaidAmount:parseFloat(i.gbcal.Paid_Amt).toFixed(2),DueAmount:parseFloat(i.gbcal.Due_Amt).toFixed(2),totalBillNetAmount:parseFloat(i.gbcal.Net_Amt).toFixed(2),isCash:"PDF"==e};j.printReportModal("labelPrintController","lg","PDF",c)}else v.warning("Warning!","No services for Provisional Cash bill",!1,!1,me.time);else v.warning("Warning!","No services for Provisional Credit bill",!1,!1,me.time)}):v.warning("Warning!","Please select atleast one service to Provisional Bill",!1,!1,me.time)},i.changePayerName=function(e){if(void 0!==e){if("004"==e.INS_TYPE||4==e.INS_TYPE){i.disablePlan=!0,$("#removeReqValid").removeClass("req-field"),i.showPlanError=!1,i.planRequired=!1,i.patPlanData=[],i.patPlanComboDataList={1:i.patPlanData};var t=I.executeQueryURLReset();return i.patPlanDataList=new Array,I.prepareParamListWithParam("pRegSeqId",s.patientSeqId,i.patPlanDataList),I.prepareParamListWithParam("pCompId",e.PINS_SEQ_ID,i.patPlanDataList),I.executeQueryInput("GET_PAYERS_INSURANCE_PLAN",i.patPlanDataList,i.patPlanComboDataList,!0,!0,t,"popUp",i.advSearch).then(function(e){i.AllPatPlanDetails=e[1]})}i.disablePlan=!1,i.planRequired=!0,$("#removeReqValid").addClass("req-field"),i.patPlanData=[],i.patPlanComboDataList={1:i.patPlanData};t=I.executeQueryURLReset();return i.patPlanDataList=new Array,I.prepareParamListWithParam("pRegSeqId",s.patientSeqId,i.patPlanDataList),I.prepareParamListWithParam("pCompId",e.PINS_SEQ_ID,i.patPlanDataList),I.executeQueryInput("GET_PAYERS_INSURANCE_PLAN",i.patPlanDataList,i.patPlanComboDataList,!0,!0,t,"popUp",i.advSearch).then(function(e){i.AllPatPlanDetails=e[1]})}i.planRequired=!1,i.disablePlan=!0,i.showPlanError=!1,$("#removeReqValid").removeClass("req-field")},i.openPayerServices=function(e){var t="",r="",a="";null!=e&&(t=void 0!==e.PAServiceRequest?void 0!==e.PAServiceRequest.SERV_NAME?null!=e.PAServiceRequest.length?e.PAServiceRequest:e.PAServiceRequest.SERV_NAME:e.PAServiceRequest:"",void 0!==e.PAServiceType&&(r=e.PAServiceType),a=void 0!==e.PAServiceRequest&&void 0!==e.PAServiceRequest.SERV_CODE?null!=e.PAServiceRequest.length?"":e.PAServiceRequest.SERV_CODE:""),i.PAService={PAServiceName:t,PAServiceType:r},i.modalInstance=S.open("SEARCH SERVICE",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popuervice-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-order-service-PayerAuthentication-popup.html",size:"lg",scope:i});var o;o={PAServiceName:t,PAServiceId:a,PAServiceType:r},T(function(){i.getPayerServices(o)},100)},i.PAService={},i.PA={},i.getPayerServices=function(e){var t=e.PAServiceName,r=e.PAServiceId;if(void 0!==t)var a=t+"%";else a="%%";if(void 0!==r)var o=r+"%";else o="%%";i.advServicename=[],i.advServicenamesList={1:i.advServicename};var n=I.executeQueryURLReset();return i.advServiceList=new Array,I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.advServiceList),I.prepareParamListWithParam("pFacilityId",ye,i.advServiceList),I.prepareParamListWithParam("pServCode",o,i.advServiceList),I.prepareParamListWithParam("pServName",a,i.advServiceList),I.prepareParamListWithParam("pPriServTypeCode",e.PAServiceType,i.advServiceList),I.prepareParamListWithParam("pSecServTypeCode","",i.advServiceList),I.prepareParamListWithParam("pServTypeCode","",i.advServiceList),I.prepareParamListWithParam("pServDesign","",i.advServiceList),I.prepareParamListWithParam("pFlowElement",2,i.advServiceList),I.prepareParamListWithParam("pServStatus",1,i.advServiceList),I.prepareParamListWithParam("pServDefStatus",1,i.advServiceList),I.prepareParamListWithParam("pDepartment","",i.advServiceList),I.prepareParamListWithParam("pIsEmergency",-999,i.advServiceList),I.prepareParamListWithParam("pExcludePri",7,i.advServiceList),I.prepareParamListWithParam("pTariffCode",s.tariffSeqId,i.advServiceList),I.executeQueryInput("SCM_SERVICE_LIST_NEW_OP",i.advServiceList,i.advServicenamesList,!0,!0,n,"popUp",{}).then(function(e){var t=e[1];i.oppayerserviceGrid.data=[];for(var r=0;r<t.length;r++)i.oppayerserviceGrid.data.push({INFL_SEQ_ID:t[r].INFL_SEQ_ID,RCV_SEQ_ID:t[r].RCV_SEQ_ID,SERV_CODE:t[r].SERV_CODE,SERV_NAME:t[r].SERV_NAME,SERV_SEQ_ID:t[r].SERV_SEQ_ID,DESCRIPTION:t[r].DESCRIPTION,CODE:t[r].CODE})})},i.ServiceTypeAhead=function(e,t){var r=e+"%";i.OPVMDoctroSearch=[],i.multipleComboDataForList={1:i.OPVMDoctroSearch};var a=I.executeQueryURLReset();return i.OPVMDoctSearch=new Array,I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.OPVMDoctSearch),I.prepareParamListWithParam("pFacilityId",ye,i.OPVMDoctSearch),I.prepareParamListWithParam("pServCode","%%",i.OPVMDoctSearch),I.prepareParamListWithParam("pServName",r,i.OPVMDoctSearch),I.prepareParamListWithParam("pPriServTypeCode",i.PAService.PAServiceType,i.OPVMDoctSearch),I.prepareParamListWithParam("pSecServTypeCode","",i.OPVMDoctSearch),I.prepareParamListWithParam("pServTypeCode","",i.OPVMDoctSearch),I.prepareParamListWithParam("pServDesign","",i.OPVMDoctSearch),I.prepareParamListWithParam("pFlowElement",2,i.OPVMDoctSearch),I.prepareParamListWithParam("pServStatus",1,i.OPVMDoctSearch),I.prepareParamListWithParam("pServDefStatus",1,i.OPVMDoctSearch),I.prepareParamListWithParam("pDepartment","",i.OPVMDoctSearch),I.prepareParamListWithParam("pIsEmergency",-999,i.OPVMDoctSearch),I.prepareParamListWithParam("pExcludePri",7,i.OPVMDoctSearch),I.prepareParamListWithParam("pTariffCode",s.tariffSeqId,i.OPVMDoctSearch),I.executeQueryInput("SCM_SERVICE_LIST_NEW_OP",i.OPVMDoctSearch,i.multipleComboDataForList,!0,!0,a,"popUp",{}).then(function(e){if(0!==e)return $("#no-result-found_service").hide(),(e[1]instanceof Array?e[1]:[e[1]]).map(function(e){return e});i.noResults=!0,$("#no-result-found_service").show()})},i.selectPayerService=function(e,t,r,a,o){i.PA.PAServiceRequest=e.SERV_NAME,i.PA.serCode=e.SERV_CODE,i.PA.serSeqId=e.SERV_SEQ_ID,i.PA.PAServiceType=e.CODE},i.setPayerServiceType=function(e){i.PAService={PAServiceType:e.PAServiceType}},i.getPAServiceData=function(){var e=i.gridoppayerser.selection.getSelectedRows();""!=e&&(E.dismissAll(),i.PA.PAServiceRequest=e[0].SERV_NAME,i.PA.serCode=e[0].SERV_CODE,i.PA.PAServiceType=e[0].CODE,i.PA.serSeqId=e[0].SERV_SEQ_ID,$("#no-result-found_service").hide())},i.oppayerserviceGrid.onRegisterApi=function(e){i.gridoppayerser=e},i.showGridErrors=!1,i.updatePayerAutherisation=function(e,t,r){i.showGridErrors=!0;var a=0,o=0,n=0;if(void 0!==s.tariffSeqId&&(a=s.tariffSeqId),void 0!==e.apprAmnt&&void 0!==e.autherNum){var c;i.showGridErrors=!1,void 0!==e.apprAmnt&&0!=e.apprAmnt.length&&(o=e.apprAmnt),void 0!==e.autherNum&&0!=e.autherNum.length&&(n=e.autherNum),c=null!=angular.element(document.querySelector("#addedImage"+r))[0].value&&""!=angular.element(document.querySelector("#addedImage"+r))[0].value?angular.element(document.querySelector("#addedImage"+r))[0].value.split("base64")[1]:"";var l=0;void 0!==s.patCatSeqId&&(l=s.patCatSeqId);var p={};p.url=N.updateService.URL,p.requestData={operation:"updateNewAuthorization",messageId:"",destination:"com.napier.core.billgeneration.service.external.ApproximateBillService",message:{"@class":"com.napier.core.billgeneration.vo.ApproxBillList",approxBillVos:[{"com.napier.core.billgeneration.vo.ApproxBillVo":[{StrExpectedDays:e.qty,tariffSeqId:a,icdCode:"",regSeqId:s.patientSeqId,patientcategorySeqId:l,approxBillDate:e.reqDateDummy,approvalRefNo:n,approvedAmount:o,payerType:e.payerType,approxBillHdSeqId:e.approxBillHdSeqId,approxBillServiceDtlsVoList:[{"com.napier.core.billgeneration.vo.ApproxBillServiceDtlsVo":[{serviceCode:"asdasd12",approxBillDtSeqId:e.serviceSeqId,serviceName:e.serName,serviceQty:e.qty,serviceTax:0,serviceDiscountAmt:0,expcServDate:e.serDateDummy,gnTranStatus:1,approvedDetails:e.status}]}],napierDocument:{"@class":"com.napier.core.service.vo.uploadfile.NapierDocument",facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,docName:angular.element(document.querySelector("#PA-payer-upload-file"+r))[0].value,uploadDocumnt:c,status:"1",createdBy:JSON.parse(sessionStorage.userContextObj).USER_SEQ_ID,createdDate:e.serDateDummy,context:15,docTypeSeqId:36,docSeqId:e.docSeqId,machineIp:JSON.parse(sessionStorage.userContextObj).WORKSTATION,referenceId:e.approxBillHdSeqId,contextDetailMaster:{"@class":"com.napier.core.service.vo.uploadfile.ContextDetailMaster",code:25}}}]}]}},P.sendRestRequest(p).then(function(t){var r={buttonClose:function(){E.dismissAll(),$("#removeReqStatusNo").removeClass("req-field"),$("#removeReqStatusAmnt").removeClass("req-field"),i.getAddedPreAuths(s.patientSeqId)}};if(void 0!==t.data.HITService.message.errorCode){var a=t.data.HITService.message.errorMessage;v.hisAlertMulti("failure","Failure",a,"","",r)}else if(void 0===t.data.HITService.message.approxBillVos){a=t.data.HITService.message.errorMessage;v.hisAlertMulti("failure","Failure",a,"","",r)}else{a="Request Created Successfully";v.hisAlertMulti("success","Success",a,"","",r),T(function(){E.dismissAll(),$("#removeReqStatusNo").removeClass("req-field"),$("#removeReqStatusAmnt").removeClass("req-field"),i.getAddedPreAuths(s.patientSeqId),i.editedPayRecord="";for(var t=0;t<i.RowsArr.length;t++)i.RowsArr[t][0].servSeqId==e.servSeq&&i.RowsArr[t][0].payerType==e.plan&&1!=i.RowsArr[t][0].billStatus&&(i.editedPayRecord=i.RowsArr[t][0]);""!=i.editedPayRecord&&i.refreshPatientPayerAmount(i.editedPayRecord,e)},600)}}),e.$edit=!1}},i.deleteAuthRequest=function(e){var t={buttonCallBack1:function(){i.deletePreAuthRcrd=!0,i.preAuth.viewPreAuth=!1,i.preAuthBillNav=!0,i.getPreAuthData(e,!0)},buttonCallBack2:function(){}};v.hisAlertMulti("warning","Confirmation","Do you really want to delete the record ?",{buttonText:"YES",buttonText2:"NO"},t,close)},i.storecurrentValues=function(e){e.dummyRefNo=e.autherNum,e.dummyApprAmnt=e.apprAmnt,e.dummyStatus=e.status;var t={};t.url=N.updateService.URL,t.requestData={operation:"getUploadedDocuments",messageId:"",destination:"com.napier.core.billgeneration.service.external.ApproximateBillService",message:{"@class":"com.napier.core.service.vo.uploadfile.NapierDocument",docSeqId:e.docSeqId}},P.sendRestRequest(t).then(function(t){var r=t.data.HITService.message.napierDocumentList[0]["com.napier.core.service.vo.uploadfile.NapierDocument"],a=e.docName;i.dotFormat2=a.split(".")[1];var o=r.uploadDocumnt[0].replace(/ +/g,""),s="data:application/"+i.dotFormat2+";base64,"+o;e.documentData=s})},i.displayPrevData=function(e){e.autherNum=e.dummyRefNo,e.apprAmnt=e.dummyApprAmnt,e.status=e.dummyStatus},i.viewRecordData=function(e,t){i.getPreAuthData(e),i.preAuth.viewPreAuth=!0,i.getEditActive(e,t)},i.openGridFileUpload=function(e,t){var r=e+t;angular.element(document.querySelector("#currentIndex"))[0].value=t,angular.element(document.querySelector("#"+r)).click()},i.captureGridUploadedImage=function(e,t){s.fileobj=e.files[0];var r=t+angular.element(document.querySelector("#currentIndex"))[0].value,a=angular.element(document.querySelector("#currentIndex"))[0].value,o=e.files[0];if(o.size>i.allowedFileSize)v.warning("Warning!","File size can not be more than 5MB",!1,!1,me.time);else{angular.element(document.querySelector("#"+r))[0].defaultValue=s.fileobj.name,angular.element(document.querySelector("#"+r))[0].value=s.fileobj.name;var n=new FileReader;n.readAsDataURL(o),n.onload=function(){n.result&&(angular.element(document.querySelector("#addedImage"+a))[0].value=n.result)}}},i.viewUploadedFile=function(){"png"==i.dotPAFormat2||"JPG"==i.dotPAFormat2||"jpeg"==i.dotPAFormat2||"jpg"==i.dotPAFormat2?i.modalInstance=S.open("View File",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-PreAuthFileShow.html",size:"md",scope:i}):F.open(i.PreauthFileLink,"windowName")},i.setValidationonStatus=function(e){"Approved"==e||"Partially Approved"==e?($("#removeReqStatusNo").addClass("req-field"),$("#removeReqStatusAmnt").addClass("req-field")):(i.statusReq=!1,$("#removeReqStatusNo").removeClass("req-field"),$("#removeReqStatusAmnt").removeClass("req-field"))},i.patientBannerCollapsedAction=function(){i.patientBannerCollapsed=!i.patientBannerCollapsed,i.patientBannerVisible=!1,i.visitDetails=!1,i.disableVisitInfo=!1,i.OPVMsearchBypatient=null,i.OPVMsearchByVisit=null},i.VisitHistoryGrid.onRegisterApi=function(e){i.gridVHApi=e,i.gridVHApi.expandable.on.rowExpandedStateChanged(i,function(e){e.entity.norecords&&(e.isExpanded=!1),e.isExpanded&&(i.gridVHApi.expandable.collapseAllRows(),e.isExpanded=!0,i.getVisitHistoryDetails(e))})},i.getVisitHistoryDetails=function(e){e.entity.subGridOptions.data=[];var t=I.executeQueryURLReset(),r=new Array,a={1:r},i=new Array;return I.prepareParamListWithParam("pVisit_seq_id",e.entity.VISIT_SEQ_ID,i),I.executeQueryInput("OPVM_SP_VISIT_HISTORY_SUB_GRID",i,a,!0,!0,t,"popUp",{}).then(function(t){var a=25;if(r.length>0){var i=[],o=!1;angular.forEach(r,function(e,t){let r={};if(r=e,e.PACKAGE_NAME&&""!=e.PACKAGE_NAME){if(o!=e.PARENT_SP_SEQ_ID){o=e.PARENT_SP_SEQ_ID;let t={SERV_NAME:e.PACKAGE_NAME,PACKAGE_MAIN:!0};i.push(t)}r.PACKAGE_SUB=!0}else o=!1;i.push(r)}),a=parseInt(e.entity.subGridOptions.rowHeight)*parseInt(i.length),e.entity.subGridOptions.data=angular.copy(i)}e.expandedRowHeight=parseInt(e.entity.subGridOptions.headerRowHeight+e.entity.subGridOptions.gridFooterHeight+a+5)})},i.getVisitHistoryData=function(){i.VisitHistoryGrid.data=[];var e=I.executeQueryURLReset(),t=new Array,r={1:t},a=new Array;return I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,a),I.prepareParamListWithParam("pRegSeqId",sessionStorage.getItem("episodeRegSeqid"),a),I.prepareParamListWithParam("pFacilityId",angular.fromJson(sessionStorage.userContextObj).FACILITY_ID,a),i.visitsearch.fromDate&&I.prepareParamListWithParam("Pfromdate",moment(i.visitsearch.fromDate).format("YYYY-MM-DD"),a),i.visitsearch.toDate&&I.prepareParamListWithParam("Ptodate",moment(i.visitsearch.toDate).format("YYYY-MM-DD"),a),i.visitsearch.speciality&&i.visitsearch.speciality.CODE&&I.prepareParamListWithParam("pSpecCode",i.visitsearch.speciality.CODE,a),i.visitsearch.Doctor&&i.visitsearch.Doctor.DOCTID&&I.prepareParamListWithParam("pDoctorId",i.visitsearch.Doctor.DOCTID,a),I.executeQueryInput("NEW_VISIT_HISTORY_WITH_DOC_DATA",a,r,!0,!0,e,"popUp",{}).then(function(e){t.length>0&&(angular.forEach(t,function(e,t){e.subGridOptions=angular.copy(de),e.CHARGES&&(e.CHARGES=parseFloat(e.CHARGES).toFixed(2)),e.BALANCE&&(e.BALANCE=parseFloat(e.BALANCE).toFixed(2))}),i.VisitHistoryGrid.data=angular.copy(t),T(function(){i.gridVHApi.grid.rows[0].isExpanded=!0,i.getVisitHistoryDetails(i.gridVHApi.grid.rows[0])},200))})},i.setVisitHistoryToDef=function(){i.visitsearch={},i.visitsearch.fromDateOptions={format:i.CD.dateOnly.format,maxDate:moment()},i.visitsearch.toDateOptions={format:i.CD.dateOnly.format,maxDate:moment()},i.getVisitHistoryData()},i.vhSearchCheckDate=function(e){(i.visitsearch.fromDate&&!moment(i.visitsearch.fromDate).isValid()||!i.visitsearch.fromDate)&&(i.visitsearch.fromDate=""),(i.visitsearch.toDate&&!moment(i.visitsearch.toDate).isValid()||!i.visitsearch.toDate)&&(i.visitsearch.toDate=""),i.visitsearch.fromDate&&i.visitsearch.toDate&&moment(i.visitsearch.fromDate).isAfter(moment(i.visitsearch.toDate))&&(1==e&&(i.visitsearch.fromDate=""),2==e&&(i.visitsearch.toDate=""))},i.visitHistory=function(e){i.visitsearch={},i.visitsearch.fromDateOptions={format:i.CD.dateOnly.format,maxDate:moment()},i.visitsearch.toDateOptions={format:i.CD.dateOnly.format,maxDate:moment()},i.modalInstance=S.open("VISIT HISTORY",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups1 his-op-visit-management min-height-modal",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-visitHistoryDetails-modal-popup.html",size:"lg",scope:i}),i.getVisitHistoryData()},i.disableVisitInfo=!1,i.loadVisitFromHistory=function(e){E.dismissAll(),i.searchVisit(e.VISIT_NO),2==e.EN_STATUS||5==e.EN_STATUS?i.disableVisitInfo=!0:i.disableVisitInfo=!1},i.patientPayerData=[],i.patientPayerDataList={1:i.patientPayerData};Re=I.executeQueryURLReset();i.patientPayer=new Array,I.prepareParamListWithParam("pMasterSqId","901",i.patientPayer),I.prepareParamListWithParam("pMasterDesc","",i.patientPayer),I.prepareParamListWithParam("pDetailCode","-999",i.patientPayer),I.prepareParamListWithParam("pDetailDesc","",i.patientPayer),I.executeQueryInput("TRN003",i.patientPayer,i.patientPayerDataList,!0,!0,Re,"popUp"),i.validateMobile=function(e){e.length<10?i.mobileMinLen=!0:i.mobileMinLen=!1},i.fileShow=function(){"png"==i.dotFormat2||"JPG"==i.dotFormat2||"jpeg"==i.dotFormat2||"jpg"==i.dotFormat2?i.modalInstance=S.open("View File",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-mlcFileShow.html",size:"lg",scope:i}):F.open(i.Mlc.docFileLink,"windowName")},i.generatePdfReport=function(){var e={mrNo:null!=s.mrNo?s.mrNo:s.patientGlobalDtlsNew?s.patientGlobalDtlsNew[0].mrNo:"",reportId:"HSC_Patient_Ordering_List",servSeqId:i.checkListServSeqIdInner,visitNo:i.visitNumber,checkListsCountAvailable:i.checkListServSeqIdInner};j.printReportModal("printOrdersCtrl","lg","PDF",e)},i.generateOrdersPdfReport=function(){var e={mrNo:null!=s.mrNo?s.mrNo:s.patientGlobalDtlsNew?s.patientGlobalDtlsNew[0].mrNo:"",visitNo:i.visitNumber,reportId:"HSC_Patient_Ordering_List"};j.printReportModal("printOrdersCtrl","lg","PDF",e)},i.generatePackageCheckListReport=function(e,t){if(1!=i.checkOrderSaved){try{var r={mrNo:s.mrNo,servSeqId:t[0].servSeqId,checkListsCountAvailable:i.checkListServSeqIdInner,reportId:"HSC_PCKG_CKL_REPORT"}}catch(e){}j.printReportModal("printCheckListsGridCtrl","lg","PDF",r)}},i.packageCheckListReprint=function(){if("0"!=i.checkListServSeqIdInner&&null!=i.checkListServSeqIdInner&&""!=i.checkListServSeqIdInner){var e=i.checkListServSeqIdInner;i.checkListServSeqIdInner="0";var t={buttonCallBack1:function(){E.dismissAll(),i.packageServicesArrayObejct=new Array,i.activeFirst=3},buttonCallBack2:function(){var t={mrNo:s.mrNo,reportId:"HSC_PCKG_CKL_SAVE_ORDER_REPORT",servSeqId:e,checkListsCountAvailable:e};j.printReportModal("printCheckListsCtrl","lg","PDF",t),i.packageServicesArrayObejct=new Array}};v.hisAlertMulti("information","Information","Do you want to print Checklists?",{buttonText:"No",buttonText2:"Yes"},t,close)}else i.packageServicesArrayObejct=new Array,i.activeFirst=3,T(function(){E.dismissAll(),i.loadBillNumbers(s.mrNo),i.retriveRecords(),i.getPrescptionCount()},3e3)},i.checkRowsArr=function(){if(0!=i.RowsArr.length)return!0},s.myCustomEvent=function(){i.packageServicesArrayObejct=new Array,i.activeFirst=3,T(function(){E.dismissAll(),i.loadBillNumbers(s.mrNo),i.retriveRecords(),i.getPrescptionCount()},3e3)},i.showDoctorsahareDetails=function(){if(i.DAUpdateBtn=!0,i.DCShareOptions=angular.copy(K),i.modalInstance=S.open("TRANSACTION UPDATE",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-DA-Transaction-popup.html",size:"lg",scope:i}),m.transTypeCombSearch("TRN003").then(function(e){i.transTypeObj=e}),void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel&&null!=i.priorityvis.priorityTypeModel)var e=i.priorityvis.priorityTypeModel.DT_CODE;else e=i.orderDetails.visitTypeCode;var t=angular.copy(i.orderDetails);if(t.visitTypeCode=e,i.setCurrentTarrifId(),i.addRowStatus||!i.orderData.docShareData)m.getDACharges(i.orderData,s.tariffSeqId,t).then(function(e){if(i.DCShareOptions.data=[],e.errorCode){e={doctorAmount:0,doctorShare:0,hospitalShare:0,surcharge:0,transType:1}}var t={docAmount:parseFloat(e.doctorAmount).toFixed(2),modAmount:void 0!==e.doctorModifiedAmount?parseFloat(e.doctorModifiedAmount).toFixed(2):"0.00",docShare:parseFloat(e.doctorShare).toFixed(2),hospShare:parseFloat(e.hospitalShare).toFixed(2),techShare:"0.00",surcharge:parseFloat(e.surcharge).toFixed(2),orderObject:e.orderObj,tariffId:e.tarrifSeq,detailObj:e.detailObj,tranType:e.transType,serviceRate:e.orderObj.serviceRate,discount:null!=e.totalDiscountAmount?parseFloat(e.totalDiscountAmount).toFixed(2):"0.00",taxAmt:null!=e.taxAmt?parseFloat(e.taxAmt).toFixed(2):"0.00"};i.DCShareOptions.data.push(t)});else if(i.DCShareOptions.data=[],i.orderData.docShareData)i.DCShareOptions.data.push(i.orderData.docShareData);else{var r={tranType:void 0!==i.orderData.transType?i.orderData.transType:0,docAmount:void 0!==i.orderData.doctorAmount?parseFloat(i.orderData.doctorAmount).toFixed(2):"0.00",modAmount:void 0!==i.orderData.doctorModifiedAmount?parseFloat(i.orderData.doctorModifiedAmount).toFixed(2):"0.00",docShare:void 0!==i.orderData.doctorShare?parseFloat(i.orderData.doctorShare).toFixed(2):"0.00",hospShare:void 0!==i.orderData.hospitalShare?parseFloat(i.orderData.hospitalShare).toFixed(2):"0.00",techShare:"0.00",surcharge:void 0!==i.orderData.surcharge?parseFloat(i.orderData.surcharge).toFixed(2):"0.00",orderObject:i.orderData,tariffId:s.tariffSeqId,detailObj:t,serviceRate:i.orderData.serviceRate,discount:null!=i.orderData.discountAmt?parseFloat(i.orderData.discountAmt).toFixed(2):"0.00",taxAmt:null!=i.orderData.taxAmt?parseFloat(i.orderData.taxAmt).toFixed(2):"0.00"};i.DCShareOptions.data.push(r)}},i.changeRatesByTranType=function(e,t){if(2==e.orderObject.transType&&e.orderObject.servicePostingSeqId&&t)v.warning("Warning","Multiple time negotiable not acceptable.");else{var r=!t;m.getDAChargesByType(e,r).then(function(t){e.docAmount=null!=t.doctorAmount?parseFloat(t.doctorAmount).toFixed(2):"0.00",e.modAmount=void 0!==t.doctorModifiedAmount?parseFloat(t.doctorModifiedAmount).toFixed(2):"0.00",e.docShare=null!=t.doctorShare?parseFloat(t.doctorShare).toFixed(2):"0.00",e.hospShare=null!=t.hospitalShare?parseFloat(t.hospitalShare).toFixed(2):"0.00",e.techShare="0.00",e.surcharge=null!=t.surcharge?parseFloat(t.surcharge).toFixed(2):"0.00",e.serviceRate=null!=t.serviceRate?parseFloat(t.serviceRate).toFixed(2):"0.00",e.discount=null!=t.totalDiscountAmount?parseFloat(t.totalDiscountAmount).toFixed(2):"0.00",e.taxAmt=null!=t.taxAmt?parseFloat(t.taxAmt).toFixed(2):"0.00"})}},i.updateDoctorShares=function(){if(2==i.DCShareOptions.data[0].tranType&&2==i.DCShareOptions.data[0].orderObject.transType&&i.DCShareOptions.data[0].orderObject.servicePostingSeqId)v.warning("Warning","Multiple time negotiable not acceptable.");else{var e=i.DCShareOptions.data;if(null!=e[0].orderObject.maxValue&&1==e[0].orderObject.isRateEditable&&e[0].serviceRate>e[0].orderObject.maxValue)return v.information("information","Rate is not in defined range",!1,!1,me.time),i.DCShareOptions.data[0].modAmount=i.DCShareOptions.data[0].docAmount,i.DCShareOptions.data[0].docShare=i.DCShareOptions.data[0].docAmount,!1;if(null!=e[0].orderObject.minValue&&1==e[0].orderObject.isRateEditable&&e[0].serviceRate<e[0].orderObject.minValue)return v.information("information","Rate is not in defined range",!1,!1,me.time),i.DCShareOptions.data[0].modAmount=i.DCShareOptions.data[0].docAmount,i.DCShareOptions.data[0].docShare=i.DCShareOptions.data[0].docAmount,!1;i.orderData.doctorAmount=e[0].docAmount,i.orderData.doctorShare=e[0].docShare,i.orderData.hospitalShare=e[0].hospShare,i.orderData.hospitalSurcharge=e[0].surcharge,i.orderData.transType=e[0].tranType,i.orderData.doctorModifiedAmount=e[0].modAmount,i.orderData.proposedShare=e[0].docShare,i.orderData.billedShare=e[0].docShare,i.orderData.grpMstCode=e[0].grpMstCode?e[0].grpMstCode:void 0,i.orderData.taxAmt=e[0].taxAmt?e[0].taxAmt:0,i.orderData.docShareData=e[0],e[0].serviceRate&&(i.orderData.serviceRate=e[0].serviceRate,i.changeRatesBasedonPriceEdit(i.orderData.serviceRate,!0)),E.dismissAll()}},i.showDASharesview=function(e,t){i.DAUpdateBtn=!1,i.DCShareOptions=angular.copy(X),i.modalInstance=S.open("TRANSACTION UPDATE VIEW",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-DA-Transaction-popup.html",size:"lg",scope:i}),i.DCShareOptions.data=[];for(var r="",a=0;a<i.transTypeObj.length;a++)i.transTypeObj[a].CODE==t[0].transType&&(r=i.transTypeObj[a].DESCRIPTION);var o={tranType:r,docAmount:void 0!==t[0].doctorAmount?t[0].doctorAmount:0,modAmount:void 0!==t[0].doctorModifiedAmount?t[0].doctorModifiedAmount:0,docShare:void 0!==t[0].doctorShare?t[0].doctorShare:0,hospShare:void 0!==t[0].hospitalShare?t[0].hospitalShare:0,techShare:0,surcharge:void 0!==t[0].surcharge?t[0].surcharge:0,orderObject:"",tariffId:"",detailObj:""};i.DCShareOptions.data.push(o)},i.orderPendingIssues=function(){i.modalInstance=S.open("Pending Drug Orders",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-pending-issues-popup.html",size:"md",scope:i}),i.pendingOrderIssuesGrid=angular.copy(te),i.pendingOrdersData=[],i.pendingOrderIssuesData={1:i.pendingOrdersData};var e=I.executeQueryURLReset();i.pendingOrdersList=new Array,I.prepareParamListWithParam("pRgSeqId",i.PatientDetailsData.registraiion.rgSeqId,i.pendingOrdersList),I.prepareParamListWithParam("pVisitNo",i.visitNumber,i.pendingOrdersList),I.executeQueryInput("GET_DRUGS_PENDING_STATUS",i.pendingOrdersList,i.pendingOrderIssuesData,!0,!0,e,"popUp",i.gridgbOptions).then(function(e){for(var t=0;t<e[1].length;t++)"ISSUED"!=e[1][t].STATUS&&i.pendingOrderIssuesGrid.data.push(e[1][t])})},i.showCancelReason=function(e,t){i.modalInstance=S.open("Cancel Reason",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-orders-cancel.html",size:"sm",scope:i}),i.cancelOrderRemarks=t[0].servicePostingCacelReason},i.retrieveDetails=function(e){"op"==e?(i.modalInstance=S.open("Out patient History",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/EMR/doctorPatient/template/patient/opbill.ipbill.history.html",size:"lg",scope:i}),i.trustSrc=function(e){var t=JSON.parse(sessionStorage.appConfig).interfaceURL+"outPatients?mrNo="+(null!=s.mrNo?s.mrNo:s.patientGlobalDtlsNew?s.patientGlobalDtlsNew[0].mrNo:"");return ie.trustAsResourceUrl(t)}):"pch"==e?(i.modalInstance=S.open("Past Clinical History",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/EMR/doctorPatient/template/patient/opbill.ipbill.history.html",size:"lg",scope:i}),i.trustSrc=function(e){var t=JSON.parse(sessionStorage.appConfig).interfaceURL+"reports?mrNo="+(null!=s.mrNo?s.mrNo:s.patientGlobalDtlsNew?s.patientGlobalDtlsNew[0].mrNo:"");return ie.trustAsResourceUrl(t)}):(i.modalInstance=S.open("In patient History",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/EMR/doctorPatient/template/patient/opbill.ipbill.history.html",size:"lg",scope:i}),i.trustSrc=function(e){var t=JSON.parse(sessionStorage.appConfig).interfaceURL+"inPatients?mrNo="+(null!=s.mrNo?s.mrNo:s.patientGlobalDtlsNew?s.patientGlobalDtlsNew[0].mrNo:"");return ie.trustAsResourceUrl(t)})},i.cardMonths=[{month:"01",month_id:"01"},{month:"02",month_id:"02"},{month:"03",month_id:"03"},{month:"04",month_id:"04"},{month:"05",month_id:"05"},{month:"06",month_id:"06"},{month:"07",month_id:"07"},{month:"08",month_id:"08"},{month:"09",month_id:"09"},{month:"10",month_id:"10"},{month:"11",month_id:"11"},{month:"12",month_id:"12"}];for(var Ce=(new Date).getFullYear(),be=[],Ee=0;Ee<41;Ee++)be.push({year:Ce+Ee,year_id:parseInt(String(Ce+Ee).slice(2,4))});i.expireYears=be,ee.getDynamicConfig("GET_HIS_CONFIG_VALUE","Site_Ref").then(function(e){"HSC"==e[1][0].VALUE&&(i.activeFirst=58,i.projSpecApplicable=!0)}),null!==A.entityObj&&void 0!==A.entityObj&&(i.searchVisit(A.entityObj),T(function(){i.activeFirst=2},300)),i.preAuth.preAuthHeaderObj={},i.preAuth.preAuthHeaderObj.PREAUTH_BIL_DATE=new Date,i.preAuth.isDedctibleAvl="3",i.preAuth.isCoPayAvl="3",i.preAuth.maxCap="3",i.deletePreAuthService=[],i.showAuthDtls=!0,i.showNewAuth=!1,i.preAuth.filesUploaded=[],i.preAuth.uploadedfileNames=[],i.preAuth.uploadingFile=!1,i.alertData={buttonText:"OK"},i.alertFunction={buttonCallBack1:function(){}},i.closeAlert={buttonClose:function(){}},i.$on("myFile",function(e,t){oe.fileUploadCheck(t,i.preAuth,i)}),i.preAuthfromDateOptions={format:i.CD.dateOnly.format,minDate:moment()},i.preAuthToDateOptions={format:i.CD.dateOnly.format,minDate:moment()},i.preAuth.preAuthFile=function(e){oe.removeUploadedFile(e,i.preAuth)},i.preAuth.isBillOrServiceFlag="2",se.serviceGridData(i.preAuth,"preAuth",!0),se.preAuthViewRecords(i.preAuth,"preAuth",!0),i.preAuth.changePriServ=function(e,t,r,a){ne.getDepartment(i.preAuth,e,t,r,a)},i.preAuth.changeDept=function(e,t,r,a){ne.getSpeciltyData(i.preAuth,e,t,r,a)},i.preAuth.serviceSearch=function(e,t){return ne.getServiceList(t,e)},i.preAuth.changeSpecialty=function(e,t){t.inActiveVal&&(t.service=void 0)},i.preAuth.addRowGrid=function(e){let t={};if(t.priServGroup=e.entity.priServGroup,t.department=e.entity.department,t.specialty=e.entity.specialty,t.service=e.entity.service,t.valueAmt=e.entity.valueAmt,t.isAmtNlPercFlag=e.entity.isAmtNlPercFlag,t.qty=e.entity.qty,t.approvedDetails=e.entity.approvedDetails,t.remarks=e.entity.remarks,t.approvedAmount=e.entity.approvedAmount,t.approvedQty=e.entity.approvedQty,null!=t.priServGroup||null!=t.department||null!=t.specialty||null!=t.service&&""!=t.service){let r=!0;if(3!=t.isAmtNlPercFlag?r=null!=t.valueAmt&&""!==t.valueAmt||null!=t.qty&&""!==t.qty:3==t.isAmtNlPercFlag&&(r=!0),r&&3!=t.isAmtNlPercFlag&&(null!=t.valueAmt&&""!=t.valueAmt&&parseFloat(t.valueAmt)>0||null==t.valueAmt||""===t.valueAmt)&&(null!=t.qty&&""!=t.qty&&parseFloat(t.qty)>0||null==t.qty||""===t.qty)||3==t.isAmtNlPercFlag)if(r&&!e.entity.editable){if(ne.validDuplicate(i.preAuth,t)){i.preAuth.preAuthDetailsGridOtions.data.push(t),i.preAuth.preAuthDetailsGridOtions.data[0]=[],i.preAuth.clearRecordFirst(e),i.preAuth.preAuthValue=ne.calPreAuthAmt(i.preAuth.preAuthDetailsGridOtions.data),i.preAuth.preAuthForServ=angular.copy(i.preAuth.preAuthValue),i.preAuth.preAuthHeaderObj.GROSS_AMT=angular.copy(i.preAuth.preAuthValue);let r=0;r=i.calTempAmt(i.preAuth.preAuthDetailsGridOtions,r),i.preAuth.initialAuthAmount=r,i.preAuth.preAuthCopyServAmt=angular.copy(r)}else v.hisAlertMulti("information","Information","Already Same Record Exist(s), Kindly Update The Value.",i.alertData,i.alertFunction,i.closeAlert)}else if(e.entity.editable){i.preAuth.preAuthDetailsGridOtions.data[e.entity.recordIndex]=t,i.preAuth.preAuthDetailsGridOtions.data[e.entity.recordIndex].deleteDisble=!1,i.toggleText="",i.preAuth.preAuthDetailsGridOtions.data[0]=[],i.preAuth.clearRecordFirst(e),i.preAuth.preAuthValue=ne.calPreAuthAmt(i.preAuth.preAuthDetailsGridOtions.data),i.preAuth.preAuthForServ=angular.copy(i.preAuth.preAuthValue),i.preAuth.preAuthHeaderObj.GROSS_AMT=angular.copy(i.preAuth.preAuthValue);let r=0;r=i.calTempAmt(i.preAuth.preAuthDetailsGridOtions,r),i.preAuth.initialAuthAmount=r,i.preAuth.preAuthCopyServAmt=angular.copy(r)}else v.hisAlertMulti("information","Information","Please Enter Amount or Qty.",i.alertData,i.alertFunction,i.closeAlert);else v.hisAlertMulti("information","Information","Amount or Qty Can't be zero value",i.alertData,i.alertFunction,i.closeAlert)}else v.hisAlertMulti("information","Information","PPlease Select Any Group or Service With Amount or Qty.",i.alertData,i.alertFunction,i.closeAlert)},i.preAuth.editGridData=function(e,t){null!=i.preAuth.prevoisIndex&&i.preAuth.prevoisIndex!=t&&null!=i.preAuth.preAuthDetailsGridOtions.data[i.preAuth.prevoisIndex]&&(i.preAuth.preAuthDetailsGridOtions.data[i.preAuth.prevoisIndex].deleteDisble=!1),e.entity.deleteDisble=!0,i.preAuth.prevoisIndex=t;let r={};r.priServGroup=null!=e.entity.priServGroup&&null!=e.entity.priServGroup.CODE?I.getObjectByAnyValue(i.preAuth.priServGroupList,e.entity.priServGroup.CODE,"CODE"):void 0,r.department=e.entity.department,r.specialty=e.entity.specialty,r.service=e.entity.service,r.valueAmt=e.entity.valueAmt,r.isAmtNlPercFlag=e.entity.isAmtNlPercFlag,r.qty=e.entity.qty,r.approvedDetails=e.entity.approvedDetails,r.remarks=e.entity.remarks,r.approvedAmount=e.entity.approvedAmount,r.approvedQty=e.entity.approvedQty,i.preAuth.preAuthDetailsGridOtions.data[0]=r,i.preAuth.preAuthDetailsGridOtions.data[0].editable=!0,i.preAuth.preAuthDetailsGridOtions.data[0].recordIndex=t,i.toggleText="UPDATE",i.preAuth.changePriServ(e.entity.priServGroup,i.preAuth.preAuthDetailsGridOtions.data[0],e.entity,!0)},i.preAuth.clearRecordFirst=function(e){null!=e&&e.entity.editable&&(i.preAuth.preAuthDetailsGridOtions.data[e.entity.recordIndex].deleteDisble=!1,e.entity.editable=!1,i.toggleText=""),i.preAuth.preAuthDetailsGridOtions.data[0]=[],i.preAuth.preAuthDetailsGridOtions.data[0].isAmtNlPercFlag="1",i.preAuth.preAuthDetailsGridOtions.data[0].valueAmt="",i.preAuth.preAuthDetailsGridOtions.data[0].qty="",i.preAuth.preAuthDetailsGridOtions.data[0].deleteDisble=!1,i.preAuth.speciltyList=[],i.preAuth.deptList=[]},i.preAuth.deleteRecord=function(e,t){let r={buttonCallBack1:function(){},buttonCallBack2:function(){null!=i.preAuth.preAuthDetailsGridOtions.data[t].approxBillDtSeqId&&(i.preAuth.preAuthDetailsGridOtions.data[t].GN_STATUS=2,i.deletePreAuthService.push(i.preAuth.preAuthDetailsGridOtions.data[t])),i.preAuth.preAuthDetailsGridOtions.data.splice(t,1),i.preAuth.preAuthValue=ne.calPreAuthAmt(i.preAuth.preAuthDetailsGridOtions.data),i.preAuth.preAuthForServ=angular.copy(i.preAuth.preAuthValue),i.preAuth.preAuthHeaderObj.GROSS_AMT=angular.copy(i.preAuth.preAuthValue);let e=0;e=i.calTempAmt(i.preAuth.preAuthDetailsGridOtions,e),i.preAuth.initialAuthAmount=e,i.preAuth.preAuthCopyServAmt=angular.copy(e)}};v.hisAlertMulti("information","Information","Do You Want To Delete The Record?",{buttonText:"No",buttonText2:"Yes"},r,{buttonClose:function(){}})},i.preAuth.getPreAuth=function(e){if(2==e){i.preAuth.preAuthValue=ne.calPreAuthAmt(i.preAuth.preAuthDetailsGridOtions.data),i.preAuth.preAuthForServ=angular.copy(i.preAuth.preAuthValue),i.preAuth.preAuthHeaderObj.GROSS_AMT=i.preAuth.preAuthForServ;let e=0;e=i.calTempAmt(i.preAuth.preAuthDetailsGridOtions,e),i.preAuth.initialAuthAmount=e,i.preAuth.preAuthCopyServAmt=angular.copy(e)}else i.preAuth.preAuthForServ=void 0,i.preAuth.preAuthValue=0,i.preAuth.preAuthHeaderObj.GROSS_AMT=i.preAuth.grossAmt,i.preAuth.initialAuthAmount=0},i.preAuth.onSelected=function(e,t){ne.getDropDownBasedService(e,t,i.preAuth)},i.preAuth.downloadFile=function(e){oe.downloadDocument(e)},i.preAuth.isChangedVal=function(e){null!=e&&""!=e&&"."!=e?null!=i.preAuth.preAuthForServ&&parseFloat(e)<parseFloat(i.preAuth.preAuthForServ)&&(i.preAuth.preAuthValue=angular.copy(i.preAuth.preAuthForServ)):i.preAuth.preAuthValue=0},i.preAuth.amountOrPercBlur=function(e){2==e.isAmtNlPercFlag&&null!=e.valueAmt&&null!=e.valueAmt&&""!=e.valueAmt&&parseFloat(e.valueAmt)>parseFloat(100)&&(e.valueAmt=100),"AP"==e.approvedDetails?e.approvedAmount=e.valueAmt:"PA"==e.approvedDetails?(null!=e.valueAmt&&null!=e.valueAmt&&""!=e.valueAmt&&null!=e.approvedAmount&&""!=e.approvedAmount&&(parseFloat(e.approvedAmount),parseFloat(e.valueAmt)),e.approvedAmount=e.valueAmt):"NA"==e.approvedDetails&&null!=e.valueAmt&&null!=e.valueAmt&&""!=e.valueAmt&&(e.approvedAmount=0)},i.valueCheck=function(e){var t;null!=e.entity.approvedDetails&&null!=e.entity.approvedDetails&&(null!=e.entity.valueAmt&&""!=e.entity.valueAmt&&(t=e.entity.valueAmt),"PA"==e.entity.approvedDetails&&(i.disableAmount=!1,e.entity.approvedAmount>t?e.entity.approvedAmount=t-1:e.entity.approvedAmount<=0?e.entity.approvedAmount=null:e.entity.approvedAmount=e.entity.approvedAmount))},i.preAuth.initialAuthAmount=0,i.preAuth.validAppAmt=function(e){2==i.preAuth.isBillOrServiceFlag&&(null!=e&&""!=e&&(parseFloat(e)<parseFloat(i.preAuth.preAuthCopyServAmt)||0==parseFloat(e))?i.preAuth.initialAuthAmount=i.preAuth.preAuthCopyServAmt:null!=e&&""!=e||(i.preAuth.initialAuthAmount=i.preAuth.preAuthCopyServAmt))},i.calTempAmt=function(e,t,r){t=0;for(var a=1;a<e.data.length;a++)null!=e.data[a].approvedAmount&&""!=e.data[a].approvedAmount&&1==e.data[a].isAmtNlPercFlag&&(t+=parseFloat(e.data[a].approvedAmount));return t},i.amountChange=function(e,t,r,a,o){let s=0,n=0;if(null!=e.entity.approvedDetails&&null!=e.entity.approvedDetails){null!=e.entity.valueAmt&&""!=e.entity.valueAmt&&(s=e.entity.valueAmt),null!=e.entity.qty&&""!=e.entity.qty&&(n=e.entity.qty),"AP"==e.entity.approvedDetails?(i.preAuth.pASave=!1,null!=e.entity.valueAmt&&""!=e.entity.valueAmt&&(e.entity.approvedAmount=parseFloat(s)),null!=e.entity.qty&&""!=e.entity.qty&&(e.entity.approvedQty=parseFloat(n)),3==e.entity.isAmtNlPercFlag&&(e.entity.approvedAmount=void 0,e.entity.approvedQty=void 0)):"PA"==e.entity.approvedDetails?(i.preAuth.pASave=!0,i.disableAmount=!1,null!=e.entity.valueAmt&&""!=e.entity.valueAmt&&(e.entity.approvedAmount=0),null!=e.entity.qty&&""!=e.entity.qty&&(e.entity.approvedQty=0)):"NA"==e.entity.approvedDetails&&(i.preAuth.pASave=!1,null!=e.entity.valueAmt&&""!=e.entity.valueAmt&&(e.entity.approvedAmount=0),null!=e.entity.qty&&""!=e.entity.qty&&(e.entity.approvedQty=0),3==e.entity.isAmtNlPercFlag&&(e.entity.approvedAmount=void 0,e.entity.approvedQty=0));let t=0;t=i.calTempAmt(i.preAuth.preAuthDetailsGridOtions,t),i.preAuth.initialAuthAmount=t,i.preAuth.preAuthCopyServAmt=angular.copy(t),i.prevAmt=e.entity.approvedAmount}},i.preAuth.preAuthValue=0,i.getPreAuthValue=function(e){var t=0;i.preAuth.pASave=!1,("PA"!=e.entity.approvedDetails||null==e.entity.valueAmt||""==e.entity.valueAmt||null==e.entity.qty||""==e.entity.qty||null!=e.entity.approvedAmount&&null!=e.entity.approvedAmount&&""!==e.entity.approvedAmount&&0!=parseFloat(e.entity.approvedAmount)&&null!=e.entity.approvedQty&&null!=e.entity.approvedQty&&""!==e.entity.approvedQty&&0!=parseFloat(e.entity.approvedQty))&&("PA"!=e.entity.approvedDetails||null==e.entity.valueAmt||""==e.entity.valueAmt||null!=e.entity.qty&&""!=e.entity.qty||null!=e.entity.approvedAmount&&null!=e.entity.approvedAmount&&""!==e.entity.approvedAmount&&0!=parseFloat(e.entity.approvedAmount))&&("PA"!=e.entity.approvedDetails||null!=e.entity.valueAmt&&""!=e.entity.valueAmt||null==e.entity.qty||""==e.entity.qty||null!=e.entity.approvedQty&&null!=e.entity.approvedQty&&""!=e.entity.approvedQty&&0!=parseFloat(e.entity.approvedQty))&&("PA"!=e.entity.approvedDetails||3!=e.entity.isAmtNlPercFlag||null!=e.entity.approvedQty&&null!=e.entity.approvedQty&&""!=e.entity.approvedQty&&0!=parseFloat(e.entity.approvedQty))?("PA"==e.entity.approvedDetails&&null!=e.entity.valueAmt&&""!=e.entity.valueAmt&&parseFloat(e.entity.approvedAmount)>parseFloat(e.entity.valueAmt)-parseFloat(.1)&&(e.entity.approvedAmount=parseFloat(e.entity.valueAmt)-parseFloat(.1)),"PA"==e.entity.approvedDetails&&null!=e.entity.qty&&""!=e.entity.qty&&parseFloat(e.entity.approvedQty)>parseFloat(e.entity.qty)-1&&(null!=e.entity.valueAmt&&1==e.entity.qty?e.entity.approvedQty=1:e.entity.approvedQty=parseFloat(e.entity.qty)-1),i.preAuth.pASave=!1,t=i.calTempAmt(i.preAuth.preAuthDetailsGridOtions,t,!0),i.preAuth.initialAuthAmount=t,i.preAuth.preAuthCopyServAmt=angular.copy(t)):i.preAuth.pASave=!0},i.preAuth.validCoPay=function(e){null!=e&&""!=e&&parseFloat(e)>parseFloat(100)&&(i.preAuth.coPayVal=100)},i.clearPreAuth=function(){le.opPreAuthClear(i)},i.clearPreAuthColse=function(){le.opPreAuthClear(i),i.preAuth.viewPreAuth=!1,i.showNewAuth=!1,i.showAuthDtls=!0,i.deletePreAuthRcrd=!1},i.preAuthRecord=function(e){i.clearPreAuthColse();var t=[];for(let r=0;r<e.length;r++)1==e[r][0].checkPreAuthRequest&&t.push(e[r]);if(t.length>1)for(let e=0;e<t.length;e++){if(null!=t[e+1]&&t[e][0].payerType!=t[e+1][0].payerType)return v.hisAlertMulti("information","Information","Please Select Same Payer And Plan.",i.alertData,i.alertFunction,i.closeAlert),!1;if("Self"==t[e][0].payerType)return v.hisAlertMulti("information","Information","For Self Authorization not allowed",i.alertData,i.alertFunction,i.closeAlert),!1}for(let e=0;e<t.length;e++)if("Self"==t[e][0].payerType)return v.hisAlertMulti("information","Information","For Self Authorization not allowed",i.alertData,i.alertFunction,i.closeAlert),!1;i.activeFirst=5,i.reqFromOrder=!0,i.showNewAuth=!0,i.showAuthDtls=!1;var r=t[0][0].payerName.split("/");i.OrderPayerName=r[0],i.OrderPlanName=r[1],i.payerCompPlanseqId=t[0][0].payerCompPlanseqId,i.payerCompSeqId=t[0][0].payerCompSeqId,s.orderRowData=t[0],i.getAllPayerDetail(s.patientSeqId),i.getPatAllPayers(s.patientSeqId),i.preAuth.preAuthDetailsGridOtions.data=[],i.preAuth.preAuthDetailsGridOtions.data[0]=[],i.preAuth.preAuthDetailsGridOtions.data[0].isAmtNlPercFlag="1",i.preAuth.preAuthDetailsGridOtions.data[0].valueAmt="",i.preAuth.preAuthDetailsGridOtions.data[0].qty="",i.preAuth.preAuthHeaderObj.PREAUTH_BIL_DATE=new Date;let a=[];for(let e=0;e<t.length;e++)a.push(t[e][0].servSeqId);a=_.toString(a),i.orderService=[];let o={1:i.orderService},n=I.executeQueryURLReset(),c=new Array;I.prepareParamListWithParam("pServSeqId",a,c),I.executeQueryInput("GET_ORDERS_SERVICE_FOR_PRE_AUTH_OP",c,o,!0,!0,n,"popUp",{}).then(function(e){for(let e=0;e<t.length;e++)for(let r=0;r<i.orderService.length;r++)if(t[e][0].servSeqId==i.orderService[r].SERV_SEQ_ID){i.preAuth.preAuthDetailsGridOtions.data.push({isAmtNlPercFlag:"1",valueAmt:null!=t[e][0].newRate&&""!=t[e][0].newRate?parseFloat(t[e][0].newRate):t[e][0].serviceRate,qty:1,priServGroup:{DESCRIPTION:i.orderService[r].PRI_SERV_DESC,CODE:i.orderService[r].PRI_SERV_CODE},department:{DESCRIPTION:i.orderService[r].DEPT_DESC,CODE:i.orderService[r].DEPT_CODE},specialty:{DESCRIPTION:i.orderService[r].SPL_DESC,CODE:i.orderService[r].SPL_CODE},service:{SERV_NAME:i.orderService[r].SERV_NAME,SERV_SEQ_ID:i.orderService[r].SERV_SEQ_ID},approvedDetails:i.orderService[r].APPROVD_DTLS,approvedAmount:i.orderService[r].APPROVED_AMNT,approvedQty:i.orderService[r].APPROVED_QTY,remarks:i.orderService[r].APPROVE_REMARKS});break}}),i.preAuth.preAuthValue=ne.calPreAuthAmt(i.preAuth.preAuthDetailsGridOtions.data),i.preAuth.preAuthForServ=angular.copy(i.preAuth.preAuthValue)},i.getEditActive=function(e,t){i.deletePreAuthRcrd=!1,i.preAuthBillNav=!0,null!=i.prevoisEditIndex&&i.prevoisEditIndex!=t&&1==i.addPayerAuthrList[i.prevoisEditIndex].$edit&&(i.addPayerAuthrList[i.prevoisEditIndex].$edit=!1),i.prevoisEditIndex=t},i.getPreAuthData=function(e,t){i.preAuth.patientDetails={approxBillHdSeqId:e.approxBillHdSeqId},t?(i.showNewAuth=!1,i.showAuthDtls=!0,i.updateFlag=!1):(i.deletePreAuthRcrd=!1,i.showNewAuth=!0,i.showAuthDtls=!1,i.updateFlag=!0),pe.getPreAuthDataHeader(i.preAuth.patientDetails,i.preAuth).then(function(r){if(i.preAuth.preAuthHeaderList.length>0){i.preAuth.isBillOrServiceFlag=_.toString(i.preAuth.preAuthHeaderList[0].IS_BILL_OR_SERVE_LEVEL),i.preAuth.isCoPayAvl=null!=i.preAuth.preAuthHeaderList[0].IS_COPAY_AVAILABLE?_.toString(i.preAuth.preAuthHeaderList[0].IS_COPAY_AVAILABLE):"3",i.preAuth.maxCap=i.preAuth.preAuthHeaderList[0].IS_MAX_COPAY_AVAILABLE?_.toString(i.preAuth.preAuthHeaderList[0].IS_MAX_COPAY_AVAILABLE):"3",i.preAuth.coPayVal=i.preAuth.preAuthHeaderList[0].COPAY_VALUE,i.preAuth.maxCapVal=i.preAuth.preAuthHeaderList[0].MAX_COPAY_VALUE,i.preAuth.isDedctibleAvl=null!=i.preAuth.preAuthHeaderList[0].IS_DEDUCTABLE_AVAILABLE?_.toString(i.preAuth.preAuthHeaderList[0].IS_DEDUCTABLE_AVAILABLE):"3",i.preAuth.deductbleValue=i.preAuth.preAuthHeaderList[0].DEDUCTABLE_VALUE,i.preAuth.initialAuthAmount=i.preAuth.preAuthHeaderList[0].APPROVED_AMNT,i.preAuth.grossAmt=i.preAuth.preAuthHeaderList[0].GROSS_AMT,i.preAuth.preAuthHeaderObj=i.preAuth.preAuthHeaderList[0],i.preAuth.fromDate=null!=e.effectiveFromDummy?new Date(e.effectiveFromDummy):void 0,i.preAuth.toDate=null!=e.effectiveToDummy?new Date(e.effectiveToDummy):void 0,i.preAuth.gnStatus=e.gnStatus,i.reqFromOrder=!0;var a=e.plan.split("/");i.OrderPayerName=a[0],i.OrderPlanName=a[1],i.planSeqIdForUpdate=e.payerType,i.getPatAllPayers(s.patientSeqId)}t?i.preAuthSave():(oe.getDocument(i.preAuth).then(function(e){for(var t=0;t<e.length;t++)i.preAuth.filesUploaded.push({"@class":"com.napier.core.service.vo.uploadfile.NapierDocument",docName:e[t].DOC_NAME,docSeqId:e[t].DOC_SEQ_ID,status:2,machineIp:angular.fromJson(sessionStorage.userContextObj).WORKSTATION,fileSize:e[t].FILE_SIZE,trimFileName:oe.trimFile(e[t].DOC_NAME),fSize:e[t].FILE_SIZE}),i.preAuth.uploadedfileNames.push(e[t].DOC_NAME)}),pe.getPreAuthData(i.preAuth.patientDetails,i.preAuth).then(function(e){if(i.preAuth.preAuthViewDetailsGridOtions.data=[],i.preAuth.preAuthDetailsGridOtions.data=[],i.preAuth.preAuthServiceList.length>0){for(let e=0;e<i.preAuth.preAuthServiceList.length;e++){i.preAuth.viewPreAuth||(i.preAuth.preAuthDetailsGridOtions.data[0]=[],i.preAuth.preAuthDetailsGridOtions.data[0].isAmtNlPercFlag="1",i.preAuth.preAuthDetailsGridOtions.data[0].valueAmt="",i.preAuth.preAuthDetailsGridOtions.data[0].qty="");let t={isAmtNlPercFlag:i.preAuth.preAuthServiceList[e].IS_AMT_PERC_NL_CODE+"",approxBillDtSeqId:i.preAuth.preAuthServiceList[e].PREAUTH_BILL_DT_SEQ_ID,valueAmt:i.preAuth.preAuthServiceList[e].CHARGEABLE_AMT,qty:i.preAuth.preAuthServiceList[e].SERV_QTY,priServGroup:{DESCRIPTION:i.preAuth.preAuthServiceList[e].PRI_SERV_DESC,CODE:i.preAuth.preAuthServiceList[e].PRI_SERV_CODE},department:{DESCRIPTION:i.preAuth.preAuthServiceList[e].DEPT_DESC,CODE:i.preAuth.preAuthServiceList[e].DEPT_CODE},specialty:{DESCRIPTION:i.preAuth.preAuthServiceList[e].SPL_DESC,CODE:i.preAuth.preAuthServiceList[e].SPL_CODE},service:{SERV_NAME:i.preAuth.preAuthServiceList[e].SERV_NAME,SERV_SEQ_ID:i.preAuth.preAuthServiceList[e].SERV_SEQ_ID},approvedDetails:i.preAuth.preAuthServiceList[e].APPROVD_DTLS,approvedAmount:i.preAuth.preAuthServiceList[e].APPROVED_AMNT,approvedQty:i.preAuth.preAuthServiceList[e].APPROVED_QTY,remarks:i.preAuth.preAuthServiceList[e].APPROVE_REMARKS,CONSUMABLE_AMOUNT:i.preAuth.preAuthServiceList[e].CONSUMABLE_AMOUNT,CONSUMABLE_QTY:i.preAuth.preAuthServiceList[e].CONSUMABLE_QTY,GN_STATUS:i.preAuth.preAuthServiceList[e].GN_STATUS,viewPreAuthFlag:i.preAuth.viewPreAuth};i.preAuth.preAuthDetailsGridOtions.data.push(t),i.preAuth.viewPreAuth&&i.preAuth.preAuthViewDetailsGridOtions.data.push(t)}i.preAuth.preAuthValue=ne.calPreAuthAmt(i.preAuth.preAuthDetailsGridOtions.data),i.preAuth.preAuthForServ=angular.copy(i.preAuth.preAuthValue)}}))})},i.preAuthBillOrServiceCal=function(e,t){let r=e?t:null!=t?t:i.orderData;if(2==i.preAuthHdrRcdList.IS_BILL_OR_SERVE_LEVEL){for(let a=0;a<i.preAuthRcdList.length;a++)if("N"==i.preAuthRcdList[a].IS_PRE_AUTH_HEADER)if("Pre Auth"==i.preAuthRcdList[a].TYPE&&(e||(null!=t?(t.patamount=r.serviceRate,t.payeramount=0):(i.orderDetails.patamount=r.serviceRate,i.orderDetails.payeramount=0))),4==i.preAuthRcdList[a].SERVICE_TYPE){if(r.priServTypCode==i.preAuthRcdList[a].SERV_SEQ_ID){null!=t&&null!=t.servicePostingSeqId&&le.opPreAuthCalBeforeOrder(i.preAuthRcdList[a],i,!0,null!=t?t:i.orderData),le.opPreAuthCalBeforeOrder(i.preAuthRcdList[a],i,e,null!=t?t:i.orderData);break}}else if(3==i.preAuthRcdList[a].SERVICE_TYPE){if(r.deptCode==i.preAuthRcdList[a].SERV_SEQ_ID){null!=t&&null!=t.servicePostingSeqId&&le.opPreAuthCalBeforeOrder(i.preAuthRcdList[a],i,!0,null!=t?t:i.orderData),le.opPreAuthCalBeforeOrder(i.preAuthRcdList[a],i,e,null!=t?t:i.orderData);break}}else if(2==i.preAuthRcdList[a].SERVICE_TYPE){if(r.specilityCode==i.preAuthRcdList[a].SERV_SEQ_ID){null!=t&&null!=t.servicePostingSeqId&&le.opPreAuthCalBeforeOrder(i.preAuthRcdList[a],i,!0,null!=t?t:i.orderData),le.opPreAuthCalBeforeOrder(i.preAuthRcdList[a],i,e,null!=t?t:i.orderData);break}}else if(1==i.preAuthRcdList[a].SERVICE_TYPE&&r.servSeqId==i.preAuthRcdList[a].SERV_SEQ_ID){null!=t&&null!=t.servicePostingSeqId&&le.opPreAuthCalBeforeOrder(i.preAuthRcdList[a],i,!0,null!=t?t:i.orderData),le.opPreAuthCalBeforeOrder(i.preAuthRcdList[a],i,e,null!=t?t:i.orderData);break}null!=t?(t.originalPatientAmount=t.patamount,t.originalPayerAmount=t.payeramount):(null!=i.orderData.patamount&&null!=i.orderData.payeramount&&(i.orderDetails.patamount=i.orderData.patamount,i.orderDetails.payeramount=i.orderData.payeramount),i.orderData.originalPatientAmount=i.orderDetails.patamount,i.orderData.originalPayerAmount=i.orderDetails.payeramount,i.orderDetails.patamount=i.orderData.originalPatientAmount,i.orderDetails.payeramount=i.orderData.originalPayerAmount)}else{var a=null!=t?t.newRate:null!=i.orderDetails.price&&""!=i.orderDetails.price?i.orderDetails.price:i.orderData.newRate;"Pre Auth"==i.preAuthHdrRcdList.TYPE&&(null!=t?(t.originalPatientAmount=a,t.originalPayerAmount=0):(i.orderData.originalPatientAmount=a,i.orderData.originalPayerAmount=0)),null!=i.preAuthHdrRcdList.APPROVED_AMNT&&parseFloat(i.preAuthHdrRcdList.APPROVED_AMNT)>0?(null!=i.preAuthHdrRcdList.CONSUMABLE_AMOUNT&&""!==i.preAuthHdrRcdList.CONSUMABLE_AMOUNT||(i.preAuthHdrRcdList.CONSUMABLE_AMOUNT=0),parseFloat(i.preAuthHdrRcdList.APPROVED_AMNT)>=parseFloat(a)?(r.patamount=0,r.payeramount=parseFloat(a),i.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(i.preAuthHdrRcdList.APPROVED_AMNT)-parseFloat(a),i.preAuthHdrRcdList.CONSUMABLE_AMOUNT=parseFloat(i.preAuthHdrRcdList.CONSUMABLE_AMOUNT)+parseFloat(a)):(r.patamount=parseFloat(a)-parseFloat(i.preAuthHdrRcdList.APPROVED_AMNT),r.payeramount=parseFloat(i.preAuthHdrRcdList.APPROVED_AMNT),i.preAuthHdrRcdList.APPROVED_AMNT=0,i.preAuthHdrRcdList.CONSUMABLE_AMOUNT=parseFloat(i.preAuthHdrRcdList.CONSUMABLE_AMOUNT)+r.payeramount)):null!=i.preAuthHdrRcdList.APPROVED_AMNT&&(r.patamount=parseFloat(a),r.payeramount=0),null!=r.patamount&&null!=r.payeramount&&(null!=t?(t.originalPatientAmount=r.patamount,t.originalPayerAmount=r.payeramount):(i.orderData.originalPatientAmount=r.patamount,i.orderData.originalPayerAmount=r.payeramount,i.orderDetails.patamount=i.orderData.originalPatientAmount,i.orderDetails.payeramount=i.orderData.originalPayerAmount))}if(null!=r)if(i.orderData.isComingFromOPPharmacy&&"Pharmacy Retruns"==i.orderData.isPharmacyService){for(let e=0;e<i.RowsArr.length;e++)i.RowsArr[e][0].isComingFromOPPharmacy&&"Pharmacy Issues"==i.RowsArr[e][0].isPharmacyService&&null!=i.orderData.pharamcyIssueServSeqId&&i.orderData.pharamcyIssueServSeqId==i.RowsArr[e][0].refTranSeqID&&(i.issueData=i.RowsArr[e][0]);for(let e=0;e<i.preAuthRcdList.length;e++)if("N"==i.preAuthRcdList[e].IS_PRE_AUTH_HEADER)if(i.preAuthRcdList[e].TYPE="Pre Auth",4==i.preAuthRcdList[e].SERVICE_TYPE){if(i.issueData.priServTypCode==i.preAuthRcdList[e].SERV_SEQ_ID){le.opPharmacyCalP(i,i.orderData,i.preAuthRcdList[e]);break}}else if(3==i.preAuthRcdList[e].SERVICE_TYPE){if(i.issueData.deptCode==i.preAuthRcdList[e].SERV_SEQ_ID){le.opPharmacyCalP(i,i.orderData,i.preAuthRcdList[e]);break}}else if(2==i.preAuthRcdList[e].SERVICE_TYPE){if(i.issueData.specilityCode==i.preAuthRcdList[e].SERV_SEQ_ID){le.opPharmacyCalP(i,i.orderData,i.preAuthRcdList[e]);break}}else if(1==i.preAuthRcdList[e].SERVICE_TYPE&&i.issueData.servSeqId==i.preAuthRcdList[e].SERV_SEQ_ID){le.opPharmacyCalP(i,i.orderData,i.preAuthRcdList[e]);break}}else i.orderData.isComingFromOPPharmacy&&"Pharmacy Issues"==i.orderData.isPharmacyService&&le.opPreAuthGetData(i,i.RowsArr)},i.preAuthSave=function(){i.saveDataInput=[],i.saveDataInput.push({bedClassSeqId:void 0,StrExpectedDays:void 0,regSeqId:s.patientSeqId,approxHdSeqId:void 0,icdCode:void 0,patientcategorySeqId:null==s.patCatSeqId?0:s.patCatSeqId,tariffSeqId:null==s.tariffSeqId?0:s.tariffSeqId,remarks:i.preAuth.preAuthHeaderObj.REMARKS,gnTranStatus:4,approxBillDate:null==i.expectedDate||null==i.expectedDate?b("date")(new Date,"yyyy-MM-dd hh:mm:ss.s"):b("date")(i.expectedDate,"yyyy-MM-dd hh:mm:ss.s"),grossAmt:null!=i.preAuth.preAuthHeaderObj&&null!=i.preAuth.preAuthHeaderObj.GROSS_AMT&&null!=i.preAuth.preAuthHeaderObj.GROSS_AMT&&""!=i.preAuth.preAuthHeaderObj.GROSS_AMT?parseFloat(i.preAuth.preAuthHeaderObj.GROSS_AMT):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId"),isBillOrServeLevel:parseFloat(i.preAuth.isBillOrServiceFlag),isCopayAvailable:parseFloat(i.preAuth.isCoPayAvl),copayValue:null!=i.preAuth.coPayVal&&""!=i.preAuth.coPayVal?parseFloat(i.preAuth.coPayVal):void 0,isMaxCopayAvailable:parseFloat(i.preAuth.maxCap),maxCopayValue:null!=i.preAuth.maxCapVal&&""!=i.preAuth.maxCapVal?parseFloat(i.preAuth.maxCapVal):void 0,isDeductableAvailable:parseFloat(i.preAuth.isDedctibleAvl),deductableValue:null!=i.preAuth.deductbleValue&&""!=i.preAuth.deductbleValue?parseFloat(i.preAuth.deductbleValue):void 0,approvalRefNo:null!=i.preAuth.preAuthHeaderObj&&null!=i.preAuth.preAuthHeaderObj.APPREFNO?i.preAuth.preAuthHeaderObj.APPREFNO:void 0,approvedAmount:parseFloat(i.preAuth.initialAuthAmount),approxBillHdSeqId:null!=i.preAuth.preAuthHeaderObj?i.preAuth.preAuthHeaderObj.PREAUTH_BILL_HD_SEQ_ID:void 0,effectiveFrom:null!=i.preAuth.fromDate?b("date")(i.preAuth.fromDate,"yyyy-MM-dd hh:mm:ss.s"):void 0,effectiveTo:null!=i.preAuth.toDate?b("date")(i.preAuth.toDate,"yyyy-MM-dd hh:mm:ss.s"):void 0,payerType:null!=i.planSeqIdForUpdate?i.planSeqIdForUpdate:null!=i.preAuth.planObj&&null!=i.preAuth.planObj.PINS_SEQ_ID?i.preAuth.planObj.PINS_SEQ_ID:i.payerCompPlanseqId,gnStatus:i.deletePreAuthRcrd?parseInt(2):null!=i.preAuth.gnStatus?i.preAuth.gnStatus:parseInt(1)}),i.saveDetails=[],i.allApprvdNot=void 0,2!=i.preAuth.isBillOrServiceFlag||i.deletePreAuthRcrd?le.preObjForPerAuthService(i,!0):i.allApprvdNot=le.preObjForPerAuthService(i),i.allApprvdNot?v.information("information","Please Approve All Record(s)",!1,!1,me.time):ce.savePreAuthForReg(i.saveDataInput[0],i.saveDetails,[],[],[],[],[]).then(function(e){if(null!=e.data.HITService.message&&null!=e.data.HITService.message.approxBillVos&&null!=e.data.HITService.message.approxBillVos[0]&&null!=e.data.HITService.message.approxBillVos[0]["com.napier.core.billgeneration.vo.ApproxBillVo"]&&null!=e.data.HITService.message.approxBillVos[0]["com.napier.core.billgeneration.vo.ApproxBillVo"].approxBillNo){if(null!=e.data.HITService.message.approxBillVos[0]["com.napier.core.billgeneration.vo.ApproxBillVo"].approxBillHdSeqId&&!i.deletePreAuthRcrd){for(let t=0;t<i.preAuth.filesUploaded.length;t++)i.preAuth.filesUploaded[t].referenceId=e.data.HITService.message.approxBillVos[0]["com.napier.core.billgeneration.vo.ApproxBillVo"].approxBillHdSeqId,i.preAuth.filesUploaded[t].prmryEntityId=e.data.HITService.message.approxBillVos[0]["com.napier.core.billgeneration.vo.ApproxBillVo"].approxBillHdSeqId;oe.saveDocument(i.preAuth)}i.orderSave();let t=i.deletePreAuthRcrd?"Authorization Deleted Successfully":"Authorization Saved Successfully";v.success("Success",t,!1,!1,me.time),i.getPatAllPayers(s.patientSeqId),i.getAddedPreAuths(s.patientSeqId),le.opPreAuthClear(i),i.showNewAuth=!1,i.showAuthDtls=!0,i.reqFromOrder=!1,i.PA={},i.disablePlan=!0,i.showErrors=!1,i.showPlanError=!1,i.statusReq=!1,$("#removeReqStatusNo").removeClass("req-field"),$("#removeReqStatusAmnt").removeClass("req-field"),i.preAuthRcdList=[],i.preAuthHdrRcdList={},le.opPreAuthGetData(i,i.RowsArr),i.preAuthRequested?T(function(){i.activeFirst=3},2e3):i.activeFirst=2}})},i.showOpPharmacyView=function(e,t){var r={1:[]},a=I.executeQueryURLReset(),o=new Array;i.patObj={},i.patObj.RG_SEQ_ID=s.patientSeqId,i.patObj.RETANABLE_QTY="",i.patObj.TYPE=2,i.patObj.STATUS_CODE=4,i.patObj.CRITERIA=1,i.patObj.WHERE_FROM="OPVM",i.patObj.viewIssue=!0,i.patObj.RG_INT_MR_NO=s.patientGlobalDtlsNew[0].mrNo,i.patObj.patientDetails=s.patientGlobalDtlsNew[0],angular.extend(i.patObj.patientDetails,{visitType:2}),"Pharmacy Issues"===t[0].isPharmacyService||"General Issue"===t[0].isPharmacyService?(I.prepareParamListWithParam("pIssueSequenceId",t[0].refTranSeqID,o),I.executeQueryInput("OP_ISSUES_STORE_CODE",o,r,!0,!0,a,"popUp",{}).then(function(e){i.patObj.INDT_HD_SEQ_ID=t[0].refTranSeqID,i.patObj.ENTITY_SEQ_ID=e[1][0].ISS_FROM,i.patObj.ENTITY_NAME=e[1][0].ISS_FROM,i.patObj.ISS_NO=e[1][0].ISS_NO,L.go("index.opPharmcyWorklist.issueView",{storeObj:angular.toJson(i.patObj),patObj:angular.toJson(i.patObj)}),i.$emit("opw.toggleStatus",{message:!0})})):"Pharmacy Retruns"!==t[0].isPharmacyService&&"General Returns"!==t[0].isPharmacyService||(I.prepareParamListWithParam("pReturnSequenceId",t[0].refTranSeqID,o),I.executeQueryInput("OP_RETURNS_STORE_CODE",o,r,!0,!0,a,"popUp").then(function(e){i.patObj.RET_HD_SEQ_ID=t[0].refTranSeqID,i.patObj.ENTITY_SEQ_ID=e[1][0].gQDataCode,i.patObj.ENTITY_NAME=e[1][0].gQDataCode,L.go("index.opPharmcyWorklist.returnsView",{storeObj:angular.toJson(i.patObj),patObj:angular.toJson(i.patObj)}),i.$emit("opw.toggleStatus",{message:!0})}))},i.savaForMLCService=function(e,t,r,a,o,n,c,l,p){var d={url:"HISServices/HISServices"};d.requestData={operation:"postMLCSerivceForOP",messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enSeqId:e.enSeqId}},P.sendRestRequest(d).then(function(e){null!=e.data.HITService.message.errorCode&&11345==e.data.HISServices.message.errorCode?v.information("information","Service Rate Not Defined For MLC Serivce",!1,!1,me.time):(i.getOrderDetails(t,r,a,o,n,c,l,p),i.loadBillNumbers(s.mrNo),i.retriveRecords(),i.getPrescptionCount())})},i.checkOrUncheckRow=function(e){if(Array.isArray(e))for(let t=0;t<e.length;t++)i.setAuthFlags(e[t]);else i.setAuthFlags(e);i.adjustPreAuthFlags()},i.setAuthFlags=function(e){if(e.entity.servicePostingSeqId)for(let t=0;t<i.gridgbOptions.data.length;t++)e.entity.servicePostingSeqId==i.gridgbOptions.data[t].servicePostingSeqId&&e.isSelected?i.gridgbOptions.data[t].checkPreAuthRequest=!0:e.entity.servicePostingSeqId!=i.gridgbOptions.data[t].servicePostingSeqId||e.isSelected||(i.gridgbOptions.data[t].checkPreAuthRequest=!1)},i.adjustPreAuthFlags=function(){i.preAuthBtnShow=0,i.preAuthRequested=!1;for(var e=0;e<i.gridgbOptions.data.length;e++)1==i.gridgbOptions.data[e].checkPreAuthRequest&&(i.preAuthBtnShow=1,i.preAuthRequested=!0)},i.preAuthRecordFromBills=function(){var e=i.gridgbOptions.data;i.clearPreAuthColse();var t=[];for(let r=0;r<e.length;r++)1==e[r].checkPreAuthRequest&&t.push(e[r]);if(t.length>1)for(let e=0;e<t.length;e++){if(null!=t[e+1]&&t[e].payerName!=t[e+1].payerName)return v.hisAlertMulti("information","Information","Please Select Same Payer And Plan.",i.alertData,i.alertFunction,i.closeAlert),!1;if("Self"==t[e].payerName)return v.hisAlertMulti("information","Information","For Self Authorization not allowed",i.alertData,i.alertFunction,i.closeAlert),!1}for(let e=0;e<t.length;e++)if("Self"==t[e].payerName)return v.hisAlertMulti("information","Information","For Self Authorization not allowed",i.alertData,i.alertFunction,i.closeAlert),!1;i.activeFirst=5,i.reqFromOrder=!0,i.showNewAuth=!0,i.showAuthDtls=!1,i.preAuthBillNav=!0;var r=t[0].payerName.split("/");i.OrderPayerName=r[0],i.OrderPlanName=r[1],i.payerCompPlanseqId=t[0].payerCompPlanseqId,i.payerCompSeqId=t[0].payerCompSeqId,s.orderRowData=t[0],i.getAllPayerDetail(s.patientSeqId),i.getPatAllPayers(s.patientSeqId),i.preAuth.preAuthDetailsGridOtions.data=[],i.preAuth.preAuthDetailsGridOtions.data[0]=[],i.preAuth.preAuthDetailsGridOtions.data[0].isAmtNlPercFlag="1",i.preAuth.preAuthDetailsGridOtions.data[0].valueAmt="",i.preAuth.preAuthDetailsGridOtions.data[0].qty="",i.preAuth.preAuthHeaderObj.PREAUTH_BIL_DATE=new Date;let a=[];for(let e=0;e<t.length;e++)a.push(t[e].servSeqId);a=_.toString(a),i.orderService=[];let o={1:i.orderService},n=I.executeQueryURLReset(),c=new Array;I.prepareParamListWithParam("pServSeqId",a,c),I.executeQueryInput("GET_ORDERS_SERVICE_FOR_PRE_AUTH_OP",c,o,!0,!0,n,"popUp",{}).then(function(e){for(let e=0;e<t.length;e++)for(let r=0;r<i.orderService.length;r++)if(t[e].servSeqId==i.orderService[r].SERV_SEQ_ID){i.preAuth.preAuthDetailsGridOtions.data.push({isAmtNlPercFlag:"1",valueAmt:null!=t[e].total&&""!=t[e].total?parseFloat(t[e].total):t[e].total,qty:1,priServGroup:{DESCRIPTION:i.orderService[r].PRI_SERV_DESC,CODE:i.orderService[r].PRI_SERV_CODE},department:{DESCRIPTION:i.orderService[r].DEPT_DESC,CODE:i.orderService[r].DEPT_CODE},specialty:{DESCRIPTION:i.orderService[r].SPL_DESC,CODE:i.orderService[r].SPL_CODE},service:{SERV_NAME:i.orderService[r].SERV_NAME,SERV_SEQ_ID:i.orderService[r].SERV_SEQ_ID},approvedDetails:i.orderService[r].APPROVD_DTLS,approvedAmount:i.orderService[r].APPROVED_AMNT,approvedQty:i.orderService[r].APPROVED_QTY,remarks:i.orderService[r].APPROVE_REMARKS});break}}),i.preAuth.preAuthValue=ne.calPreAuthAmt(i.preAuth.preAuthDetailsGridOtions.data),i.preAuth.preAuthForServ=angular.copy(i.preAuth.preAuthValue)}}function t(e,t,r,a,i,o,s,n,c,l,p,d){o.cancel=function(){e.dismiss("cancel")},o.printParameterList=new Array,r.prepareParamList("pColrequestSeqId",d.pColrequestSeqId,o.printParameterList),o.printObject={},"HSC"==sessionStorage.productCustomization?o.printObject.reportId="DepositTaxInvoiceReportForHSC":o.printObject.reportId="OP_DEPOSIT_RECEIPT_RPT",o.printObject.destination="reportingServiceImpl",o.printObject.reportType={id:"PDF"==t?4:5,desc:t},o.printObject.paramsList=o.printParameterList,a.printReportFunction(o.printObject,o)}function r(e,t,r,a,i,o,s,n,c,l,p,d){o.cancel=function(){e.dismiss("cancel")},o.printParameterList=new Array,r.prepareParamList("pCrNtHdSeqId",d.pCrNtHdSeqId,o.printParameterList),r.prepareParamList("pIsCrNote",d.pIsCrNote,o.printParameterList),o.printObject={},o.printObject.reportId="OP_DEPOSIT_REFUND_RECEIPT_RPT",o.printObject.destination="reportingServiceImpl",o.printObject.reportType={id:"PDF"==t?4:5,desc:t},o.printObject.paramsList=o.printParameterList,a.printReportFunction(o.printObject,o)}function a(e,t,r,a,i,o,s,n,c,l,p,d){o.cancel=function(){e.dismiss("cancel")},o.printParameterList=new Array,r.prepareParamList("pPaymentRefundReceiptId",d.pPaymentRefundReceiptId,o.printParameterList),o.printObject={},"HSC"===sessionStorage.productCustomization?o.printObject.reportId="HSC_Patient_PaymentRefundRequestDetailsReportId":o.printObject.reportId="OutPatient_BillingReports_PaymentRefundRequestDetailsReportId",o.printObject.destination="reportingServiceImpl",o.printObject.reportType={id:"PDF"==t?4:5,desc:t},o.printObject.paramsList=o.printParameterList,a.printReportFunction(o.printObject,o)}function i(e,t,r,a,i,o,s,n,c,l,p,d){o.cancel=function(){e.dismiss("cancel")},o.printParameterList=new Array,o.pageName="CLAIM FORM PRINT",r.prepareParamList("pRgSeqId",d.regSeqId,o.printParameterList),r.prepareParamList("pEnSeqId",d.encSeqId?d.encSeqId:-999,o.printParameterList),r.prepareParamList("serviceListString",d.serviceListString,o.printParameterList),d.pPayerSeqId&&-999!=d.pPayerSeqId&&r.prepareParamList("pPayerSeqId",d.pPayerSeqId,o.printParameterList),o.printObject={},o.printObject.reportId=d.reportId,o.printObject.destination="reportingServiceImpl",o.printObject.reportType={id:4,desc:"PDF"},o.printObject.paramsList=o.printParameterList,a.printReportFunction(o.printObject,o)}function o(e,t,r,a,i,o,s,n,c,l,p,d,m,u,v){n.pageName="Report",n.cancel=function(){if("0"!=e.checkListsCountAvailable&&null!=e.checkListsCountAvailable&&""!=e.checkListsCountAvailable){var r=e.checkListsCountAvailable;e.checkListsCountAvailable="0";var a=m.getTop();m.dismiss(a.key);var i={buttonCallBack1:function(){m.dismissAll(),s.myCustomEvent()},buttonCallBack2:function(){var t={mrNo:e.mrNo,reportId:"HSC_PCKG_CKL_SAVE_ORDER_REPORT",servSeqId:r};v.printReportModal("printCheckListsCtrl","lg","PDF",t),m.dismissAll(),n.packageServicesArrayObejct=new Array,n.activeFirst=3}};u.hisAlertMulti("information","Information","Do you want to print Checklists?",{buttonText:"No",buttonText2:"Yes"},i,close)}else m.dismiss("cancel"),t.dismiss("cancel"),s.myCustomEvent()},n.printParameterList=new Array,a.prepareParamList("pFacilityId",angular.fromJson(sessionStorage.userContextObj).FACILITY_ID,n.printParameterList),a.prepareParamList("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,n.printParameterList),a.prepareParamList("pPatMrNo",e.mrNo,n.printParameterList),a.prepareParamList("pVisitNumber",e.visitNo,n.printParameterList),n.printObject={},n.printObject.reportId=e.reportId,n.printObject.destination="reportingServiceImpl",n.printObject.reportType={id:4,desc:"PDF"},n.printObject.paramsList=n.printParameterList,i.printReportFunction(n.printObject,n)}function s(e,t,r,a,i,o,s,n,c,l,p,d,m,u,v){n.cancel=function(){t.dismiss("cancel")};var S=e.billno?e.billno:e.pBillSeqId;n.pageName=e.billno?"Bill Print for ":"Tax Invoice - "+S,n.printParameterListForBill=new Array,e.billno?a.prepareParamList("pBillNo",e.billno,n.printParameterListForBill):e.pBillSeqId&&a.prepareParamList("pBillSeqId",e.pBillSeqId,n.printParameterListForBill),n.printObject={},n.printObject.reportId=e.reportId,n.printObject.destination="reportingServiceImpl",n.printObject.reportType={id:4,desc:e.printType},n.printObject.paramsList=n.printParameterListForBill,i.printReportFunction(n.printObject,n)}function n(e,t,r,a,i,o,s,n,c,l,p,d,m,u,v){n.pageName="Report",n.cancel=function(){m.dismissAll(),s.myCustomEvent()},n.printParameterList=new Array,a.prepareParamList("pFacilityId",angular.fromJson(sessionStorage.userContextObj).FACILITY_ID,n.printParameterList),a.prepareParamList("pPracticeId",angular.fromJson(sessionStorage.userContextObj).FACILITY_ID_DESC,n.printParameterList),a.prepareParamList("pPatMrNo",e.mrNo,n.printParameterList),a.prepareParamList("pServiceSeqID",e.servSeqId,n.printParameterList),n.printObject={},n.printObject.reportId=e.reportId,n.printObject.destination="reportingServiceImpl",n.printObject.reportType={id:4,desc:"PDF"},n.printObject.paramsList=n.printParameterList,i.printReportFunction(n.printObject,n)}function c(e,t,r,a,i,o,s,n,c,l,p,d,m,u,v){n.pageName="Report",n.cancel=function(){m.dismissAll()},n.printParameterList=new Array,a.prepareParamList("pFacilityId",angular.fromJson(sessionStorage.userContextObj).FACILITY_ID,n.printParameterList),a.prepareParamList("pPracticeId",angular.fromJson(sessionStorage.userContextObj).FACILITY_ID_DESC,n.printParameterList),a.prepareParamList("pPatMrNo",e.mrNo,n.printParameterList),a.prepareParamList("pServiceSeqID",e.servSeqId,n.printParameterList),n.printObject={},n.printObject.reportId=e.reportId,n.printObject.destination="reportingServiceImpl",n.printObject.reportType={id:4,desc:"PDF"},n.printObject.paramsList=n.printParameterList,i.printReportFunction(n.printObject,n)}e.$inject=["$q","opVisitExternalDoctorSearchGrid","adtDailyReportComboQueryservice","BILLING_APIS","$scope","$interval","$rootScope","$http","$uibModal","OPVsitVisitHistory","generateBillGrid","opVisitManagementOpenVisitListGrid","opVisitMgtService","opVisitMgtLables","hisAlertService","hisModalService","uiGridConstants","PatientGlobal","PatientBannerGlobal","$stateParams","QueryService","CallManager","opVisitDoctorSearchGrid","PatientBannerBilling","advancedSearchGridDefinition","$timeout","$log","$filter","$uibModalStack","dropdownServiceEmergency","hisTranslationsService","$state","hisCalDefConstant","OPVISIT_MGMT_APIS","OPOrderAdvServiceGrid","OPVsithealthCheckUpGrid","$window","hisTranslationsGlobalLang","generateBillConcessionGrid","generateBillConcesReqGrid","generateBillDepositGrid","generateBillRefundGrid","generateBillPaymentGrid","opOrderService","PrintService","dropdownQueryService","otComService","RoleTaskService","opBillPrintService","bookAppointmentService","BATransactionGrid","BATransactionGridView","hisConfigurationService","opVisitManagementPendingOrdersGrid","integrationService","patPermanentRegistrationService","$sce","gridDefApproval","ServiceGet","CommonForServiceData","PreAuthSaveServices","OPPreAuthServices","PreAuthViewServices","OPVsitVisitHistorySubGrid","hisAlertConstants","HISROUNDOFFNEW"],t.$inject=["$uibModalInstance","selectedPrintType","QueryService","PrintService","$sce","$scope","$rootScope","CallManager","IPINDENTAPIS","APIS","$window","returnObj"],a.$inject=["$uibModalInstance","selectedPrintType","QueryService","PrintService","$sce","$scope","$rootScope","CallManager","IPINDENTAPIS","APIS","$window","returnObj"],i.$inject=["$uibModalInstance","selectedPrintType","QueryService","PrintService","$sce","$scope","$rootScope","CallManager","IPINDENTAPIS","APIS","$window","returnObj"],r.$inject=["$uibModalInstance","selectedPrintType","QueryService","PrintService","$sce","$scope","$rootScope","CallManager","IPINDENTAPIS","APIS","$window","returnObj"],o.$inject=["returnObj","$uibModalInstance","selectedPrintType","QueryService","PrintServiceCustome","$sce","$rootScope","$scope","CallManager","IPINDENTAPIS","APIS","$window","$uibModalStack","hisAlertService","PrintService"],s.$inject=["returnObj","$uibModalInstance","selectedPrintType","QueryService","PrintServiceCustome","$sce","$rootScope","$scope","CallManager","IPINDENTAPIS","APIS","$window","$uibModalStack","hisAlertService","PrintService"],n.$inject=["returnObj","$uibModalInstance","selectedPrintType","QueryService","PrintServiceCustome","$sce","$rootScope","$scope","CallManager","IPINDENTAPIS","APIS","$window","$uibModalStack","hisAlertService","PrintService"],c.$inject=["returnObj","$uibModalInstance","selectedPrintType","QueryService","PrintServiceCustome","$sce","$rootScope","$scope","CallManager","IPINDENTAPIS","APIS","$window","$uibModalStack","hisAlertService","PrintService"],angular.module("napierContainerUi").controller("opVisitMgtCrtl",e).controller("depositPrintCtrl",t).controller("refundPrintCtrl",a).controller("claimFormPrintCtrl",i).controller("refundReceiptPrintCtrl",r).controller("printOrdersCtrl",o).controller("printBillCtrl",s).controller("printCheckListsCtrl",n).controller("printCheckListsGridCtrl",c)}(),function(){"use strict";function e(e,t,r,a,i,o,s,n,c,l,p){this.data={}}e.$inject=["$scope","CallManager","$anchorScroll","$controller","uiGridConstants","$uibModal","$http","$q","toastr","$state","$location"],angular.module("napierContainerUi").controller("opVistMgmtControllerNew",e)}(),function(){"use strict";function e(e,t,r,a,i,o,s,n,c,l,p,d,m,u,v,S,y,D,g,A,I,P,h,R,f,T,C,b,E,q,O,L,V,N,w,M,F,B,x,G,U,Q,k,H,j,Y,W,z,J,Z,K,X,ee,te,re,ae,ie,oe,se,ne,ce,le,pe,de,me,ue){i.minRate=null,i.maxRate=null,i.rateEditable=null,i.opSearch={type:1},"HSC"==sessionStorage.productCustomization&&(i.agent={},i.agentComboInputs={pPracticeId:JSON.parse(sessionStorage.userContextObj).CLIENT_REF_ID,pFacilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID},r.loadCombos("REF_MAST_AGENT_COMBO",i.agentComboInputs).then(function(e){i.agentName=e[1]})),s.$on("changePerminateRegistartion",function(e,t){!function(e){ae.setPatientSelectedInEdit(e),s.$emit("editPatientDeatils",e)}(t)}),ee.getDynamicConfig("GET_HIS_CONFIG_VALUE","Site_Ref").then(function(e){i.hscSpecific=e[1][0].VALUE,"HSC"===i.hscSpecific?i.editPatient=!0:i.editPatient=!1}),ee.getDynamicConfig("GET_HIS_CONFIG_VALUE","IS_ALLOW_PARITIAL_PAY").then(function(e){i.isAllowPartialPay=e[1][0].VALUE,"YES"===i.isAllowPartialPay?i.partialPayauthShowMode=!0:i.partialPayauthShowMode=!1});var ve=sessionStorage.getItem("opQueueData");null!=ve&&null!=ve&&(A.entityObj=ve,sessionStorage.removeItem("opQueueData")),ee.getDynamicConfig("GET_HIS_CONFIG_VALUE","IS_ALLOW_MULTI_VISIT_PER_EPISODE").then(function(e){i.isAllowMultiVisitPerEpisode=e[1][0].VALUE}),O.loadModule("opVisitManagement");var Se=B.getLanguageToSet();O.changeLanguage(Se),s.latestVisitNo=null,i.opVisitCountApplicableFlag=!1,i.opVisitCount=0,i.VM_Heading=u[0].visitInfo.headings,i.visitMgt=u[0].visitInfo.visitMgt,i.visitDetils=u[0].visitInfo.visitDetils,i.mlcDetails=u[0].visitInfo.mlcDetails,i.previousVisitNote=u[0].visitInfo.previousVisitNote,i.addPatientDetails=u[0].visitInfo.addPatientDetail,i.bannerdetails=u[0].visitInfo.patientBannerDetails,i.mlcpreviousVisitNote=u[0].visitInfo.mlcpreviousVisitNote,i.patientValues,i.concessionAplList=[],i.projSpecApplicable=!1,i.claimFormDetailsArray=[];"HSC"===sessionStorage.productCustomization?i.hscRelatedFlagActive=!0:i.hscRelatedFlagActive=!1,i.preAuthBtnShow=0,i.preAuthBillNav=!1;var ye=JSON.parse(sessionStorage.userContextObj).FACILITY_ID;i.episode=!1,i.bedClass="";var De;i.dctorpop={},i.errorVisible=!1,i.advPat={},i.isDisable=!0,i.updatePatientDisable=!0,i.patientBannerCollapsed=!1,s.permanentRegistrationDataFlag=!1,i.permanentregistration={},i.Mlc={},s.visitDlsDoc={},i.setDoctornameFlag=!1,i.doctorSearchValues,i.extDoctorSearchValues,i.patObjtDetail=[],i.visitNumber="",i.mlcDetailsId="",i.screenname="",i.saveCont=!0,i.tempMlcNum="",i.epRowNum="",i.updateCont=!1,i.OPVMsearchDoctorSpeciality={},i.updateVisitFlag=!1,i.addNewVisitFlag=!0,i.addNewEpisodeFlag=!0,i.patCatCode="",i.patCatSeqId="",i.defaultVisit=!0,i.dynmVisit=!1,i.dynamicVisitNum="",i.docSeqId="",i.loaderFlag=!1,s.orders={},i.serviceTypeModel={},i.payerTypeModel={},i.advserviceType={},s.AdvserviceGrid=angular.copy(w),i.priorityvis={},i.hidevisitTypeComboRef=!0,i.orderDetails={},i.payerdetailsarr={},i.orderData={},i.orderData.accountDetails={},i.gbcal={},i.accountSeqData=[],i.paym={},i.deposit={},i.deposit.Type=1,i.concession={},i.concession_status=!0,i.noResultsOfDoctor=!1,i.disablePayType=!1,i.addSelectServicepostArr=[],i.rows,i.counter=1,i.RowsArr=[],i.tableRowData,i.orderrowIndex,i.advServiceGridselection=[],i.accountres,i.isServiceSelectedCovered=!1,i.concessionViewMode=!1,i.colReqSeqId="",i.refundFlag=!0,i.paymentReciepts=!0,i.refund={},i.billNo="",i.gbBillNo={},i.totalpayableAmt=0;var ge={};i.claimFormDetailsArrayString="",i.enableClaimForm=!1,i.preAuth={},i.addNewPayerIns={},i.regTempPat={tempPatDtlsForm:{}},i.defaultCountryCode=sessionStorage.defaultCountryCode,i.tempPatForm={},ee.getDynamicConfig("GET_HIS_CONFIG_VALUE","INTEGRATION_AAPLICABLE").then(function(e){e[1][0]&&(i.integrationApplicableFlag=e[1][0].VALUE)}),i.permissionList=z.rolePermission("T_OP_VISIT"),i.postBillStatus="";i.postBillStatus=function(){for(var e=angular.fromJson(JSON.parse(sessionStorage.getItem("securityUtilityJson"))).HITService.context.contextList[0]["com.napier.core.context.ContextElement"],t=e.length,r=0;r<t;r++)if("POST_BILL"==e[r].attrName)return e[r].attrValue}(),i.getPermissionsCheck=function(e){return z.rolePermission(e)},i.permissionListC1=i.getPermissionsCheck("T_OP_VISIT"),i.permissionListC2=i.getPermissionsCheck("T_OP_VISIT_DIRECTORY"),i.permissionListC4=i.getPermissionsCheck("T_PAT_REGSTN"),i.permissionListC6=i.getPermissionsCheck("T_PROCEDURE_APPOINTMENT"),i.permissionListC7=i.getPermissionsCheck("T_APPTMENT_SCHEDULING"),i.permissionListC8=i.getPermissionsCheck("T_DEFINE_CALENDER"),i.permissionListC9=i.getPermissionsCheck("T_SCHEDULAR_BULK_MANAGEMNET"),i.permissionListC10=i.getPermissionsCheck("T_SCHEDULAR_ENQUIRY"),T(function(){i.$apply(function(){i.permissionList1=0===Object.getOwnPropertyNames(i.permissionListC1).length,i.permissionList2=0===Object.getOwnPropertyNames(i.permissionListC2).length,i.permissionList4=0===Object.getOwnPropertyNames(i.permissionListC4).length,i.permissionList6=0===Object.getOwnPropertyNames(i.permissionListC6).length,i.permissionList7=0===Object.getOwnPropertyNames(i.permissionListC7).length,i.permissionList8=0===Object.getOwnPropertyNames(i.permissionListC8).length,i.permissionList9=0===Object.getOwnPropertyNames(i.permissionListC9).length,i.permissionList10=0===Object.getOwnPropertyNames(i.permissionListC10).length})},500),i.advSearch={advSearchPname:"Patient Name",advSearchMRno:"MR No.",advSearchGender:"Gender",advSearchSelectGender:"Select Gender",advSearchGenderMale:"male",advSearchGenderFemale:"Female",advSearchDateofBirth:"Date of Birth",advSearchMobileNo:"Mobile No.",advSearchRegistrationType:"Registration Type",advSearchSelectRegType:"Select Reg Type",advSearchRegTypeOne:"Registratin Type One",advSearchRegTypeTwo:"Registratin Type Two",advSearchPayer:"Payer",advSearchPayerType:"Select Type",advSearchpayerOne:"Payer One",advSearchPayerTwo:"Payer Two",advSearchSave:"Search",advSearchClear:"Clear"},i.clearSearch=function(e){e?(i.opSearch={type:2},i.tempPatForm={},i.RowsArr=[],i.orderDetails={},i.visitDls={},i.Mlc={},i.visitDlsDoc={},i.visitEdit=!1,i.patientBannerVisible=!1,i.visitDetails=!0,i.clsvisitBtn=!1,i.submit=!1,i.mlcSubmit=!1,i.saveCont=!0,i.updateCont=!1,i.AllorderPayerDetails=[],sessionStorage.removeItem("orderencounterSeqId"),sessionStorage.removeItem("subaccountseqId"),sessionStorage.removeItem("episodeRegSeqid"),i.addNewVisitFlag=!1,i.addNewEpisodeFlag=!1,i.disableVisitInfo=!1,i.patObjtDetail=[],i.dynamicVisitNum="",i.loadPayerForNonRegPat(),i.visitDls.internalorext="I"):(i.opSearch={type:1},i.patientBannerCollapsedAction()),s.patientGlobalDtlsNew=[],s.patientGlobalDtls={},i.setNewPayerFormtoDef()},i.confirmChangeSearch=function(e,t){i.opSearch.type="1"==t?"2":"1";let r=!0;if(2!=t||i.patientBannerVisible||(r=!1),r){var a={buttonCallBack1:function(){},buttonCallBack2:function(){i.activeFirst=1,i.opSearch.type=t.toString(),i.clearSearch(e)}};v.hisAlertMulti("warning","Confirmation","Are you sure to change the registration type?",{buttonText:"No",buttonText2:"Yes"},a,close)}else i.opSearch.type=t.toString(),i.clearSearch(e)},i.loadPayerForNonRegPat=function(){var e=[],t={1:e},r=I.executeQueryURLReset();return I.executeQueryInput("OPVM_TMP_PAT_TARIFF_001",[],t,!0,!0,r,"popUp",i.advSearch).then(function(t){i.AllorderPayerDetails.push({PAYER_NAME:"Self",PINS_SEQ_ID:-999,PayerType:"Self",TATRIFF_SEQ_ID:e[0].TARIFFCATG?e[0].TARIFFCATG:void 0}),s.tariffSeqId=e[0].TARIFFCATG?e[0].TARIFFCATG:"",i.visitDls.vistPayer=i.AllorderPayerDetails[0],i.payerTypeModel={PayerType:i.AllorderPayerDetails[0]}})},i.loadOPCountApplicable=function(){i.countApplicableData=[],i.countApplicableDataList={1:i.countApplicableData};var e=I.executeQueryURLReset();return i.countApplicableDataDetails=new Array,I.prepareParamListWithParam("configCode",146,i.countApplicableDataDetails),I.executeQueryInput("NH_EMP_STAFF_DEPN_AGE_COVRG_VL",i.countApplicableDataDetails,i.countApplicableDataList,!0,!0,e,"popUp",i.advSearch).then(function(e){var t=e[1];t[0]&&(i.opVisitCountApplicableFlag=1==t[0].CONFIG_VALUE)})},i.loadOPCountApplicable(),i.loadDefaultOPBedClass=function(){i.defaultBedData=[],i.defaultBedDataList={1:i.defaultBedData};var e=I.executeQueryURLReset();return i.defaultBedDataDetails=new Array,I.executeQueryInput("GET_DEFAULT_OP_BED_CLASS",i.defaultBedDataDetails,i.defaultBedDataList,!0,!0,e,"popUp",i.advSearch).then(function(e){var t=e[1];t[0]&&(i.bedClass="BEDCLASS="+t[0].DESCRIPTION)})},i.loadDefaultOPBedClass(),"HSC"===sessionStorage.productCustomization?(i.hscOrdersPrint=!0,i.checkListServSeqId=[],i.checkListServSeqIdInner="",i.hscCheckListCount=[],i.checkOrderSaved=!1):i.hscOrdersPrint=!1,i.applicableForBillandService=function(e){i.concession_status=1==e},i.CD=angular.copy(V),i.fromDateOptions={format:i.CD.dateOnly.format,maxDate:moment()},i.dobDateOptions={format:i.CD.dateOnly.format,minDate:moment().subtract(150,"years").calendar(),maxDate:moment(),useCurrent:!1},i.episodeDateOptions={format:i.CD.dateOnly.format,minDate:moment()},i.forMinDateOptions={minDate:new Date},i.forMinDateOptions_episode={minDate:new Date,maxDate:new Date},s.visithistoryvistino=function(e){i.searchVisit(e.entity.VISIT_NO),E.dismissAll()},i.visitDetails=!1,i.activeFirst=1,i.updateDoctorDisable=!0,i.VisitHistoryGrid=angular.copy(l),s.opserviceGrid=angular.copy(w),i.oppayerserviceGrid=angular.copy(w),s.healthCheckUp=angular.copy(M),m.comboBoxFetch("SPECIALITY_LIST").then(function(e){i.serviceComboObj=e}),i.visitDls={},i.dispNowDate=new Date,i.dispNowDateFormat=new Date(i.dispNowDate.toDateString()),i.dispNowTime=i.dispNowDate.getHours()+":"+i.dispNowDate.getMinutes(),i.allowedFileSize=5e6,window.scope=i,$(".ng-patient-banner").toggleClass("ng-scope ng-hide"),i.activeBillTab=function(e){i.activeSecond=e},i.activeSecond=4,i.keyupevt=function(e){0==$(".search_name").val().length&&($("#no-result-found").hide(),i.visitDls={},i.visitDlsDoc={},i.Mlc={},i.visitDetails=!1,i.visitEdit=!1,$(".ng-patient-banner").attr("class","ng-patient-banner ng-scope ng-hide")),8==e.which&&($(".ng-patient-banner").attr("class","ng-patient-banner ng-scope ng-hide"),i.visitDls={},i.Mlc={},i.visitDlsDoc={},i.visitDetails=!1,i.visitEdit=!1,i.patientBannerVisible=!1,i.disableVisitInfo=!1)},i.visitNokeyupevt=function(e){0==$(".search_VisitNo").val().length&&($("#no-result-found_visit").hide(),i.visitDls={},i.Mlc={},i.visitDetails=!1,i.visitEdit=!1,$(".ng-patient-banner").attr("class","ng-patient-banner ng-scope ng-hide"))};var Ae="",Ie={};function Pe(){if(i.insurancePlanDedSeqId&&i.accountres&&1!=i.accountres.SUB_ACC_SEQ_ID){var e=[],t={1:i.deductibleList=[]},r=I.executeQueryURLReset(),a=i.accountres.SUB_ACC_SEQ_ID;I.prepareParamListWithParam("pSubAccSeqId",a,e),I.prepareParamListWithParam("pPlanSeqId",i.insurancePlanDedSeqId,e),I.executeQueryInput("BL_GET_DEDUCTABLE_AMOUNT",e,t,!0,!0,r,"popUp",{}).then(function(e){e[1][0]?(i.deductibleType=i.deductibleList[0]&&i.deductibleList[0].TYPE?i.deductibleList[0].TYPE:void 0,i.deductibleAmount=i.deductibleList[0]&&i.deductibleList[0].DEDUCTABLE_VALUE?i.deductibleList[0].DEDUCTABLE_VALUE:void 0):(i.deductibleAmount=0,i.noPayer=!0),i.calculateGBData()})}else i.deductibleAmount=0,i.noPayer=!0}s.addNewEpisode2={},i.addNewEpisode={},i.episodeRecords,i.disabled={selected:!0},i.checked={selected:!1},i.gridDoctorSearchoptions=angular.copy(h),i.advSearchRowClickDoc=function(e){e.visible?($("input[name=rdUserList]").attr("checked",!0),i.updateDoctorDisable=!1,i.doctorSearchValues=e.entity):($("input[name=rdUserList]").attr("checked",!1),i.updateDoctorDisable=!0)},i.advSearchRowClickExtDoc=function(e){e.visible?($("input[name=rdUserList]").attr("checked",!0),i.selectExtAdvDoctor=!1,i.extDoctorSearchValues=e.entity):($("input[name=rdUserList]").attr("checked",!1),i.selectExtAdvDoctor=!0)},i.gridOptions=angular.copy(f),i.keyupevtDoctor=function(e){0==$(".search_name").val().length&&($(".no-result-found").hide(),i.noResultsOfDoctor=!1)},i.selectMatchDoctor=function(e,t,r,a,o,n){if(e.DOCTID,i.regTypeData&&i.regTypeData.RG_SEQ_ID){!i.payerTypeModel.PayerType&&i.visitDls.vistPayer&&(i.payerTypeModel.PayerType=i.visitDls.vistPayer);var c=i.payerTypeModel.PayerType.PINS_SEQ_ID;i.getOrderDetails(e.DOCTID,i.regTypeData.RG_SEQ_ID,i.enSeqId,s.tariffSeqId,"",c,1,e.SPECIALITY_CODE),i.retriveRecords(n)}else i.opSearch&&2==i.opSearch.type&&(i.orderDetails.OPVMselectDoctor||(i.orderDetails.OPVMselectDoctor=e))},i.OPVMDoctorSearchTypeAheadEp=function(e){i.setDoctornameFlag=!0;var t=e;i.OPVMDoctroSearch=[],i.multipleComboDataForList={1:i.OPVMDoctroSearch};var r=I.executeQueryURLReset();return i.OPVMDoctSearch=new Array,I.prepareParamListWithParam("pSpecializationId",i.addNewEpisode.department.CODE,i.OPVMDoctSearch),I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.OPVMDoctSearch),I.prepareParamListWithParam("pDoctorId","",i.OPVMDoctSearch),I.prepareParamListWithParam("pDoctorName",t,i.OPVMDoctSearch),I.executeQueryInput("OP_DOCTOR_ADVANCE_SEARCH",i.OPVMDoctSearch,i.multipleComboDataForList,!0,!0,r,"popUp",{}).then(function(e){if(0!==e)return(e[1]instanceof Array?e[1]:[e[1]]).map(function(e){return e});i.noResults=!0})},i.OPVMDoctorSearchTypeAhead=function(e,t,r){i.setDoctornameFlag=!0;var a="",o=e;i.OPVMDoctroSearch=[],i.multipleComboDataForList={1:i.OPVMDoctroSearch},t&&(a=t);var s=I.executeQueryURLReset();if(i.OPVMDoctSearch=new Array,I.prepareParamListWithParam("pSpecializationId",a,i.OPVMDoctSearch),I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.OPVMDoctSearch),I.prepareParamListWithParam("pDoctorId","",i.OPVMDoctSearch),I.prepareParamListWithParam("pDoctorName",o,i.OPVMDoctSearch),!r)return I.executeQueryInput("OP_DOCTOR_ADVANCE_SEARCH",i.OPVMDoctSearch,i.multipleComboDataForList,!0,!0,s,"popUp",{}).then(function(e){if(0!==e)return(e[1]instanceof Array?e[1]:[e[1]]).map(function(e){return e});i.noResults=!0});I.executeQueryInput("OP_DOCTOR_ADVANCE_SEARCH",i.OPVMDoctSearch,i.multipleComboDataForList,!0,!0,s,"popUp",{}).then(function(e){if(e){var t=e[1]instanceof Array?e[1]:[e[1]];i.orderDetails.OPVMselectDoctor=t[0]}})},i.updatePatient=function(){i.visitDls={},i.Mlc={},i.Mlc.OPVMmlcDetails=!1,$(".ng-patient-banner").attr("class","ng-patient-banner ng-scope"),$(".search_name").val("");var e={};s.patientGlobalDtlsNew=[],s.patientGlobalDtls={},i.patObjtDetail=[],e.regSeqId=i.patientValues.regSeqId,i.patObjtDetail.push({RGSEQID:parseInt(e.regSeqId)}),i.selectMatch(i.patObjtDetail[0]),$("#patientSearchModal").modal("hide"),$("#opvm-search-by-patient").focus(),$("#clear_advance").removeClass("PsearchClearBtn"),$("#clear_advance").addClass("PsearchClearBtn")},i.close=function(){$("#patientSearchModal").modal("hide"),$("#opvm-search-by-patient").focus(),$("#clear_advance").removeClass("PsearchClearBtn"),$("#clear_advance").addClass("PsearchClearBtn")},i.openVisitsInfo=function(e){e=e.toString();i.openVisits=[],i.openVisitList={1:i.openVisits};var t=I.executeQueryURLReset();return i.openVisitsList=new Array,I.prepareParamListWithParam("pRegSeqId",e,i.openVisitsList),I.prepareParamListWithParam("pFacilityId",ye,i.openVisitsList),I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.openVisitsList),I.executeQueryInput("VISITS_NO_REG_SEQ_ID",i.openVisitsList,i.openVisitList,!0,!0,t,"popUp",{}).then(function(e){var t=e[1];if(t.length>0&&"HSC"!=sessionStorage.productCustomization&&t.length>1){i.openVisitsListGrid=angular.copy(d),i.openVisitsListGrid.onRegisterApi=function(e){i.openVisitsListGrid=e},T(function(){i.openVisitsListGrid.data=[];for(var e=0;e<t.length;e++)i.openVisitsListGrid.data.push({EPISODENAME:t[e].EPISODENAME,VISIT_NO:t[e].VISIT_NO,DOCTDESC:t[e].DOCTDESC,SERVDESC:t[e].SERVDESC,EP_NO:t[e].EP_NO});o(function(){i.openVisitsListGrid.selection.selectRow(i.openVisitsListGrid.data[0])},0,1)},200)}})},i.latestEpisodeLoad=function(e,t){i.getPatAllPayers(s.patientSeqId),i.getAddedPreAuths(s.patientSeqId),i.reqFromOrder=!1,i.amountValid=!1,s.orderRowData=null,i.addRowStatus=!0,s.editRowRecord=null,i.packageServicesArrayObejct=[],s.selectedPreServices=[],s.cancelSerIndex=[],i.PA={},i.PA={fromDate:new Date,PAUnitDays:1},i.showErrors=!1,i.showPlanError=!1,$("#no-result-found_service").hide(),i.latestEpisode=[],i.latestEpisodeList={1:i.latestEpisode};var r=I.executeQueryURLReset();if(i.latestEpisodeLists=new Array,I.prepareParamListWithParam("pRegSeqId",e,i.latestEpisodeLists),I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.latestEpisodeLists),"HSC"===sessionStorage.productCustomization)var a="GET_LATEST_EPISODE_AND_VISITLOCATION_FORHSC";else a="GET_LATEST_EPISODE";return I.executeQueryInput(a,i.latestEpisodeLists,i.latestEpisodeList,!0,!0,r,"popUp",{}).then(function(r){var a=r[1][0];i.todaysAppoinmentsData=[],i.appointmentsData=[],i.appointmentsDataFull=[],i.fromAppoinemtView=!1;var o={"@class":"com.napier.his.appointment_management.vo.PatientSearchVO",rgSeqId:e,opAppmntStatus:89},n={url:"HISServices/AppointmentsManagementService"};n.requestData={operation:"getAppointmentsDetailsForOPPatient",destination:"com.napier.his.appointment_management.service.external.AppointmentsManagementService",message:o},P.sendRestRequest(n).then(function(r){try{var o=r.data.HITService.message[0]["com.napier.his.appointment_management.vo.OpAppointmentsEntityVO"]}catch(e){}if(o&&void 0!==o){var n=s.patientName;n=null!=n?n.toUpperCase():"";var c="APPOINTMENTS LIST";"HSC"==sessionStorage.productCustomization&&(c="UPCOMING APPOINTMENTS"),i.modalInstance=S.open(c,{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-up-coming-appointments.html",size:"lg",scope:i});i.apptFlag=0;let e=o instanceof Array?o:[o];var l=moment().format("YYYY-MM-DD");let t=[];for(var p=0;p<e.length;p++){e[p].value=p,e[p].calendarDateToDisplyFormat=new Date(e[p].calendarDateToDisply.split("T")[0].split("-")[2]+"/"+e[p].calendarDateToDisply.split("T")[0].split("-")[1]+"/"+e[p].calendarDateToDisply.split("T")[0].split("-")[0]),e[p].showHeader=!0;let r=moment(e[p].calendarDateToDisplyFormat).diff(l,"days");0===r?i.todaysAppoinmentsData.push(e[p]):(-1===t.indexOf(e[p].calendarDateToDisply)?t.push(e[p].calendarDateToDisply):e[p].showHeader=!1,r>0&&(e[p].isFuture=!0),i.appointmentsData.push(e[p])),i.appointmentsDataFull.push(e[p]),i.selectedapptment&&i.selectedapptment.opApmntSeqId==e[p].opApmntSeqId&&(i.apptFlag=i.selectedapptment.opApmntSeqId)}i.todaysAppoinmentsData.length>1&&i.todaysAppoinmentsData.sort(function(e,t){return e.slotStartTime>t.slotStartTime?1:e.slotStartTime<t.slotStartTime?-1:0}),i.appointmentsData.sort(function(e,t){return new Date(e.calendarDateToDisplyFormat)-new Date(t.calendarDateToDisplyFormat)})}else null==a?(i.appointmentsData=[],i.todaysAppoinmentsData=[],i.appointmentsDataFull=[],"HSC"!=sessionStorage.getItem("productCustomization")?("firstTimeHide"!=t&&i.episodePopUp("lg"),T(function(){i.addNewEpisodes()},300)):i.loadDefaultEpisodeData(),i.hideExternalRef=!1,i.hideInternalRef=!0,i.visitDls.internalorext="I",i.internalorextCk=!0,i.internalorextCkE=!1,i.visitDls.OPVMreferedBy={}):(i.patientOutstandingPop(e),"HSC"==i.hscSpecific&&i.loadDefaultEpisodeData())}),null!=a&&(i.visitDls.OPVMepisodeNo=a.EP_NO,i.visitDls.epSeqId=a.EP_SEQ_ID,i.visitDls.OPVMepisodeDescription=a.EP_DESCRIPTION,a.DOCT_SEQ_ID&&(i.visitDlsDoc.OPVMselectDoctor={},i.visitDlsDoc.OPVMselectDoctor.DOCTID=a.DOCT_SEQ_ID,i.visitDlsDoc.OPVMselectDoctor.DOCTNAME=a.DOCTDESC,i.visitDlsDoc.OPVMselectDoctor.SPECIALITY_CODE=a.EP_SPECIALITY,i.visitDlsDoc.OPVMselectDoctor.SPECIALITYDESC=a.DESCRIPTION,i.visitDlsDoc.OPVMselectDoctor.DOCTOR_SPECIALITY=a.DOCTDESC+", "+a.DESCRIPTION),i.hideExternalRef=!1,i.hideInternalRef=!0,i.visitDls.internalorext="I",i.internalorextCk=!0,i.internalorextCkE=!1,i.visitDls.OPVMreferedBy={},a.OPVLOCATION&&(i.admittingLocationData=a.OPVLOCATION,i.visitDls.admittingLocation=a.OPVLOCATION)),i.opVisitCountApplicableFlag&&i.getVisitCount()})},i.openVisitSelect=function(){var e=$('input[name="radio_continue"]:checked').val(),t=i.openVisitsListGrid.data[e].VISIT_NO;i.searchVisit(t),E.dismissAll()},i.newVisit=function(){i.visitDls.OPVMvisitType="",i.saveCont=!1,i.updateCont=!0,i.addNewVisitFlag=!1,E.dismissAll()},i.addNewEpisodeClick=function(){i.visitDls.epSeqId="",i.visitDls.OPVMepisodeNo="",i.visitDls.OPVMepisodeDescription="",i.visitDls.OPVMvisitType="",i.visitDlsDoc.OPVMselectDoctor="",i.internalorextCk=!0,i.visitDls.OPVMreferedBy1="",i.visitDls.OPVMreferedBy={},i.Mlc={},i.Mlc.OPVMmlcDetails=!1,i.updateVisitFlag=!1,i.saveCont=!0,i.tempMlcNum="",i.updateCont=!1,i.addNewVisitFlag=!1,i.addNewEpisodeFlag=!1,i.disableVisitInfo=!1,i.priorityvis.visitTypeModel="New",i.serviceTypeModel={},i.orderDetails={},i.RowsArr=[],sessionStorage.removeItem("orderencounterSeqId"),sessionStorage.removeItem("subaccountseqId"),i.clsvisitBtn=!1,i.submit=!1,i.mlcSubmit=!1},i.addNewVisit=function(){1==i.projSpecApplicable||(i.visitDls.OPVMvisitType="",i.visitDlsDoc.OPVMselectDoctor="",i.internalorextCk=!0,i.visitDls.OPVMreferedBy1="",i.visitDls.OPVMreferedBy={},i.Mlc={},i.Mlc.OPVMmlcDetails=!1,i.updateVisitFlag=!1,i.saveCont=!0,i.tempMlcNum="",i.updateCont=!1,i.addNewVisitFlag=!1,i.addNewEpisodeFlag=!0,i.disableVisitInfo=!1,i.serviceTypeModel={},i.orderDetails={},i.RowsArr=[],sessionStorage.removeItem("orderencounterSeqId"),sessionStorage.removeItem("subaccountseqId"),i.clsvisitBtn=!1,i.submit=!1,i.mlcSubmit=!1,"HSC"==sessionStorage.productCustomization&&(i.agent.hscAgent={},i.agent.hscAgent=_.find(i.agentName,{REFERRAL_AGENT_SEQ_ID:i.agentSeqId})))},i.patientTempRegt=function(e){s.patientGlobalDtlsNew=[],s.patientGlobalDtls={};var t={};t.regSeqId=e,g.getPatientBanner(t,"2").then(function(e){s.patientGlobalDtlsNew.push(e),s.patientGlobalDtls=s.patientGlobalDtlsNew[0]}),R.patientBannerDetail(t).then(function(e){if(s.patientGlobalDtlsNew.push(e),s.patientGlobalDtls=s.patientGlobalDtlsNew[0],null!=s.patientGlobalDtlsNew[0].visitNO){var t=s.patientGlobalDtlsNew[0].visitNO.split(" ")[0];i.searchVisit(t)}}),sessionStorage.setItem("episodeRegSeqid",null),s.patientSeqId=e,i.getPayerDetail(e,sessionStorage.getItem("orderencounterSeqId"));var r=e;i.latestEpisodeLoad(r),sessionStorage.setItem("episodeRegSeqid",r),i.visitDetails=!0},i.postRoomChargesforEmgPat=function(){i.regTypeData&&i.regTypeData.encounterType&&3==i.regTypeData.encounterType&&i.accountres.SUB_ACC_SEQ_ID?m.postRoomChargesforEmgPat(i.accountres.SUB_ACC_SEQ_ID).then(function(e){i.retriveRecords(),i.loadGBDepositeGrid(),i.loadRefundRecieptList(),i.loadBillNumbers(s.mrNo)},function(e){i.retriveRecords(),i.loadGBDepositeGrid(),i.loadRefundRecieptList(),i.loadBillNumbers(s.mrNo)}):(i.retriveRecords(),i.loadGBDepositeGrid(),i.loadRefundRecieptList(),i.loadBillNumbers(s.mrNo))},i.getAccountByEnID=function(){var e=3==i.regTypeData.encounterType?"OP_BL_M_COMMON_002_FOR_ER":"OP_BL_M_COMMON_002";i.accountSeqData=[],i.getcoountData={1:i.accountSeqData};var t=I.executeQueryURLReset();i.accountSeqList=new Array,I.prepareParamListWithParam("pEncounterSeqId",s.encounterSeqId,i.accountSeqList),I.executeQueryInput(e,i.accountSeqList,i.getcoountData,!0,!0,t,"popUp",i.gridgbOptions).then(function(e){i.accountres=e[1][0],i.noPayer=!0,i.accountres?(i.accountres.ACC_SEQ_ID&&sessionStorage.setItem("accountseqId",i.accountres.ACC_SEQ_ID),i.accountres.SUB_ACC_SEQ_ID&&sessionStorage.setItem("subaccountseqId",i.accountres.SUB_ACC_SEQ_ID),i.postRoomChargesforEmgPat(),!s.mrNo&&i.accountres.RG_INT_MR_NO&&(s.mrNo=i.accountres.RG_INT_MR_NO,i.loadBillNumbers(s.mrNo))):i.loadBillNumbers(s.mrNo)})},i.checkIfPatIsIP=function(){if(s.encounterSeqId){var e=[],t={1:e},r=I.executeQueryURLReset(),a=new Array;I.prepareParamListWithParam("pEnSeqId",s.encounterSeqId,a),I.executeQueryInput("GET_VISIT_IP_ENC_TYPE",a,t,!0,!0,r,"popUp",i.gridgbOptions).then(function(t){if(e[0]&&"TRUE"==e[0].OPTYPE){i.isIpPat=!0;v.hisAlertMulti("warning","Warning","Paitent is already Admitted. Hence not Allowed for OP Visit",{buttonText:"OK"},close)}})}},i.confirmTempOREmerPat=function(){if(i.regTypeData&&3==i.regTypeData.RG_TYPE){if(2==i.regTypeData.RG_TYPE)var e="Patient has a Temporary registration. Do you want to convert into Permanent registration ?";else e="Patient has a Emergency registration. This need to be converted into Permanent registration before Bill ?";var t={buttonCallBack1:function(){},buttonCallBack2:function(){sessionStorage.setItem("ErTrPatientDetails",JSON.stringify(i.regTypeData)),L.go("index.frontDesk.permanentRegistration")}};return v.hisAlertMulti("warning","Confirmation",e,{buttonText:"No",buttonText2:"Yes"},t,close),!1}return!0},i.checkVisitUnOrderdServices=function(){if(i.prescPendingOders=!1,i.regTypeData&&i.regTypeData.RG_SEQ_ID){var e=I.executeQueryURLReset(),t={1:new Array},r=new Array;return I.prepareParamListWithParam("pRG_SEQ_ID",i.regTypeData.RG_SEQ_ID,r),I.executeQueryInput("OPVM_SP_PENDING_VISIT_PRESC",r,t,!0,!0,e,"popUp",{}).then(function(e){e[1][0]&&e[1][0].IS_PRES_ORDERED&&"Y"==e[1][0].IS_PRES_ORDERED&&(i.prescPendingOders=!0)})}},i.loadPatDetails=function(e,t){e&&e.RG_SEQ_ID&&(e.RGSEQID=e.RG_SEQ_ID,i.selectMatch(e))},i.selectMatch=function(e,t,r,a,o){sessionStorage.removeItem("orderencounterSeqId"),sessionStorage.removeItem("subaccountseqId"),i.opvisitPatientDetails=angular.copy(e),i.preAuthRcdList=[],i.preAuthHdrRcdList={},i.packageTitle="",i.clsvisitBtn=!1,i.saveCont=!0,i.tempMlcNum="",i.updateCont=!1,i.addNewVisitFlag=!1,i.addNewEpisodeFlag=!1,i.orderBtnDisable=!0,i.orderUpdate=!1,i.visitEdit=!0,i.payerDetails={},i.visitDlsDoc={},i.visitDls={},i.Mlc={},i.gbBillNo={},i.Mlc.OPVMmlcDetails=!1,i.upldphotoDoc=null,i.patientBannerDetails=null,i.RowsArr=[],i.isIpPat=!1,i.isEmgOrTempPat=!1,$(".ng-patient-banner").attr("class","ng-patient-banner ng-scope"),i.patientBannerVisible=!0,s.patientGlobalDtlsNew=[],s.patientGlobalDtls={};var n={};i.defaultVisit=!0,i.dynmVisit=!1,i.dynamicVisitNum="",n.regSeqId=e.RGSEQID,i.agentHideId=angular.copy(e.RGSEQID),i.deductibleType="",i.regTypeData={},i.isPatientDeceased=!1,i.submit=!1,i.mlcSubmit=!1,g.getPatientBanner(n,"2").then(function(t){if(null!=t.encounterType&&0!=t.encounterType||(t.encounterType=1),s.patientGlobalDtlsNew.push(t),s.patientGlobalDtls=s.patientGlobalDtlsNew[0],t.typeOfReg&&(i.regTypeData={RG_SEQ_ID:n.regSeqId,RG_INT_MR_NO:t.mrNo,RG_TYPE:t.typeOfReg,encounterType:t.encounterType},sessionStorage.setItem("orderregSeqId",n.regSeqId),3==t.typeOfReg&&(i.isEmgOrTempPat=!0,!i.confirmTempOREmerPat()&&2==t.typeOfReg)))return!1;null!=t.encounterNo&&0!=t.encounterNo?s.encounterNo=t.encounterNo.split(" ")[0]:s.encounterNo="",s.encounterSeqId=t.encounterSeqId,s.mrNo=t.mrNo,i.checkIfPatIsIP(),i.latestEpisodeLoad(e.RGSEQID,"firstTimeHide"),i.gbcal={deductibleAmount:0,coPay:0},i.getVisitPayerDetails(e.RGSEQID),i.getPayerDetail(e.RGSEQID,s.encounterSeqId),R.patientBannerDetail(n.regSeqId).then(function(e){if(i.upldphotoDoc=e,i.patientBannerDetails=e,e.insurance){var t=e.insurance;(t=t instanceof Array?t:[t])[0].cmpSeqId&&t[0].cmpSeqId.inCompName&&(s.patientGlobalDtlsNew[0].insuranceComp=t[0].cmpSeqId.inCompName),t[0].insurancePlanMaster&&t[0].insurancePlanMaster.inPlanName&&(s.patientGlobalDtlsNew[0].insurancePlan=t[0].insurancePlanMaster.inPlanName),t[0].covrgStrtDate&&t[0].covrgStrtDate.$&&(s.patientGlobalDtlsNew[0].pEffectivedate=t[0].covrgStrtDate.$),t[0].covrgEndDate&&t[0].covrgEndDate.$&&(s.patientGlobalDtlsNew[0].pExpiredate=t[0].covrgEndDate.$),i.noPayer=!0}if(s.patientGlobalDtlsNew[0].userPermision=12,e.patientRecordsDetail&&e.patientRecordsDetail.deathInd&&"Y"==e.patientRecordsDetail.deathInd&&(i.isPatientDeceased=!0,v.warning("Warning!","The selected patient is deceased",!1,!1,me.time)),null!=s.patientGlobalDtlsNew[0].visitNO){var r=s.patientGlobalDtlsNew[0].visitNO.split(" ")[0];i.searchVisit(r,!0)}if(s.patientName=s.patientGlobalDtlsNew[0].patientName,""==s.tariffSeqId&&(s.tariffSeqId=s.patientGlobalDtlsNew[0].tariffSeqId),s.insuranceComp=s.patientGlobalDtlsNew[0].insuranceComp,s.patCatSeqId=s.patientGlobalDtlsNew[0].patCatSeqId,s.mrNo=s.patientGlobalDtlsNew[0].mrNo,null==s.patientGlobalDtlsNew[0].visitNO&&(i.visitDls.OPVMepisodeNo="",i.visitDls.epSeqId="",i.visitDls.OPVMepisodeDescription="",i.visitDlsDoc.OPVMselectDoctor=""),s.patientGlobalDtls=s.patientGlobalDtlsNew[0],"HSC"==sessionStorage.productCustomization){i.agentSeqDataId=[],i.agentSeqData={1:i.agentSeqDataId};var a=I.executeQueryURLReset();return i.agentListName=new Array,I.prepareParamListWithParam("pRG_SEQ_ID",i.agentHideId,i.agentListName),I.executeQueryInput("AGENT_WORK_FLOW_SEARCH_FOR_BILL",i.agentListName,i.agentSeqData,!0,!0,a,"popUp",{}).then(function(e){var t=angular.copy(e);t[1][0]&&"1"==t[1][0].GN_BILL_STATUS?i.agent.hscAgent="":(i.agent.hscAgent={},i.agentSeqId=t[1][0]?t[1][0].REFERRAL_AGENT_SEQ_ID:"",i.agent.hscAgent=_.find(i.agentName,{REFERRAL_AGENT_SEQ_ID:i.agentSeqId}))})}})}),sessionStorage.setItem("episodeRegSeqid",null),s.patientSeqId=e.RGSEQID,i.getPatientCatg(e.RGSEQID);var c=e.RGSEQID;sessionStorage.setItem("episodeRegSeqid",c),i.visitDetails=!0,i.disableVisitInfo=!1,i.patientBannerCollapsed=!1,i.internalorextCk=!0,i.visitDls.OPVMreferedBy1="",i.visitDls.OPVMreferedBy="",i.visitDls.internalorext="I"},i.OPVMsearchBypatientSearch=function(e){if(e&&e.length>2)return"HSC"===i.hscSpecific?Z.searchRegisteredPatientForHsc(e).then(function(e){i.registeredPatientList=[],angular.isArray(e)?i.registeredPatientList=e:i.registeredPatientList.push(e);for(var t=0;t<i.registeredPatientList.length;t++)i.registeredPatientList[t].NAME=i.registeredPatientList[t].patientName.trim(),i.registeredPatientList[t].RGSEQID=i.registeredPatientList[t].rgSeqId,i.registeredPatientList[t].RG_NATIONAL_ID=i.registeredPatientList[t].nationalityId,i.registeredPatientList[t].NATIONAL_ID="NRIC No";return i.registeredPatientList},function(e){}):Z.searchRegisteredPatientService(e).then(function(e){i.registeredPatientList=[],angular.isArray(e)?i.registeredPatientList=e:i.registeredPatientList.push(e);for(var t=0;t<i.registeredPatientList.length;t++)i.registeredPatientList[t].NAME=i.registeredPatientList[t].patientName.trim(),i.registeredPatientList[t].RGSEQID=i.registeredPatientList[t].rgSeqId,i.registeredPatientList[t].RG_NATIONAL_ID=i.registeredPatientList[t].nationalityId,i.registeredPatientList[t].NATIONAL_ID="National Id";return i.registeredPatientList},function(e){})},i.opvisitPatient=function(){L.go("permanent_registration_new_op",{navision:"op"}),s.$emit("changePerminateRegistartion",i.opvisitPatientDetails)},i.advanceSearch=function(e,t){if(i.clearAdvFields(),i.gridOptions.data=[],$("#patientSearchModal").modal({backdrop:"static",keyboard:!1}),(e&&null!==e.NAME&&void 0!==e.NAME&&""!==e.NAME||""!=e)&&""!=$("#opvm-search-by-patient").val()){if("string"==typeof e)var r=e;else r=e.NAME;i.isDisable=!1,/\d/.test(r)?i.advPat={MrNo:r}:i.advPat={patientName:r},$("#clear_advance").removeClass("PsearchClearBtn"),i.VisitAdvanceSrh(i.advPat),i.updatePatientDisable=!1}else i.isDisable=!0,$("#clear_advance").addClass("PsearchClearBtn"),i.updatePatientDisable=!0,i.gridOptions.data=[];m.comboBoxFetch("MQ0002").then(function(e){i.genderComboObj=e}),m.comboBoxFetch("TRN003").then(function(e){i.regComboObj=e}),m.comboBoxFetch("GET_COPMANY_ACC_DTLS").then(function(e){i.payerComboObj=e})},$(".datePickerClass").datepicker({format:"dd/mm/yyyy",autoclose:!0,endDate:"today",maxDate:0}),$(".datePickerClass").on("change",function(e){var t=$(this).val().split("/");Ae=t[2]+"-"+t[1]+"-"+t[0],Ie.dobValue=Ae,$(this).datepicker("hide")}),i.getDOB=function(){$(".datePickerClass").datepicker("show")},i.getPatientVal=function(e){null!=e&&""!==e?""!=e.patientName&&null!=e.patientName&&null!=e.patientName||""!=e.MrNo&&null!=e.MrNo&&null!=e.MrNo||null!=e.dateofbirth&&""!=e.dateofbirth&&null!=e.dateofbirth||""!=e.gender&&null!=e.gender&&null!=e.gender||""!=e.mno&&null!=e.mno&&null!=e.mno||""!=e.payer&&null!=e.payer&&null!=e.payer||""!=e.regType&&null!=e.regType&&null!=e.regType?(i.isDisable=!1,$("#clear_advance").removeClass("PsearchClearBtn")):(i.gridOptions.data=[],i.updatePatientDisable=!0,i.isDisable=!0,$("#clear_advance").addClass("PsearchClearBtn")):(i.gridOptions.data=[],i.isDisable=!0,i.updatePatientDisable=!0,i.gridOptions.data=[],$("#clear_advance").addClass("PsearchClearBtn"))},i.advSearchRowClick=function(e){e.visible?($("input[name=rdUserList]").attr("checked",!0),i.updatePatientDisable=!1,i.patientValues={regSeqId:e.entity.patientId}):($("input[name=rdUserList]").attr("checked",!1),i.updatePatientDisable=!0)},i.VisitAdvanceSrh=function(e){if(""!==e.patientName&&void 0!==e.patientName&&null!==e.patientName||""!==e.MrNo&&void 0!==e.MrNo&&null!==e.MrNo||""!==e.gender&&void 0!==e.gender&&null!==e.gender||""!==e.dateofbirth&&void 0!==e.dateofbirth&&null!==e.dateofbirth||""!==e.mno&&void 0!==e.mno&&null!==e.mno||""!==e.regType&&void 0!==e.regType&&null!==e.regType||""!==e.payer&&void 0!==e.payer&&null!==e.payer){if(""!==e.dateofbirth&&void 0!==e.dateofbirth&&null!==e.dateofbirth){var t=e.dateofbirth,r=b("date")(new Date(t),"yyyy/MM/dd").split("/");a=Ae=r[0]+"-"+r[1]+"-"+r[2]}i.errorVisible=!0}else{var a="";i.errorVisible=!1}var o={dateofbirth:a,patientName:e.patientName,MrNo:e.MrNo,gender:e.gender,mno:e.mno,regType:e.regType,payer:e.payer};m.searchServices(o,i.gridOptions).then(function(e){i.gridOptions.data=e,0!=e.length&&"No Records Found"!=e[0].patientName?(i.updatePatientDisable=!1,i.releaseAction=!0,T(function(){i.gridOptions.selectRow(2,!0)}),$("input[name=rdUserList]").attr("checked","checked"),i.patientValues={regSeqId:i.gridOptions.data[0].patientId}):i.updatePatientDisable=!0}),i.errorVisible=!1},i.deleteInclusionService=function(e,t){i.packageServices[e].servicePostingSeqId&&(i.packageServices.length>1?(i.retrivePackageDeletedServObj.push(i.packageServices[e]),i.packageServices.splice(e,1),i.retrivePacServObj.splice(e,1)):i.inclusionServiceValid=!0)},i.changePkgRates=function(t,r){e.defer();var a=r[0],o=new Date,n=moment(o).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";N.updateService.URL;var c=a.visitTypeCode;i.addSelectServiceTypeArr=[],i.setCurrentTarrifId();var l=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId")?sessionStorage.getItem("accountseqId"):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0,patientMRNo:!sessionStorage.getItem("subaccountseqId")&&i.regTypeData&&i.regTypeData.RG_INT_MR_NO?i.regTypeData.RG_INT_MR_NO:void 0,patientId:!sessionStorage.getItem("subaccountseqId")&&i.regTypeData&&i.regTypeData.RG_SEQ_ID?i.regTypeData.RG_SEQ_ID:void 0,servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:a.servSeqId,gnServDesign:a.gnServDesign,servCode:a.servCode,servName:a.servName,secServTypeCode:a.servSeqId,priServTypCode:a.servSeqId},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:a.servSeqId,tariffSeqId:s.tariffSeqId,datedOn:n,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:a.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:JSON.parse(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,isRateEditable:1,newRate:t,requestedByEmpType:4,requestedByEmpSeqID:a.requestedByEmpSeqID,payerId:a.payerTypeCode,fromOPVisit:"Y",priority:c}];i.addSelectServiceTypeArr.push(l);var p={};return p.url=N.updateService.URL,p.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId")?sessionStorage.getItem("accountseqId"):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectServiceTypeArr}]}},P.sendRestRequest(p).then(function(e){i.isPriceEditResponce=e.data.HITService.message;var t=i.isPriceEditResponce.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"],r=!0;return a.serviceRate!=t.serviceRate&&(r=!1),a.price=t.serviceRateVo.baseRate,a.patamount=t.originalPatientAmount,a.payeramount=t.originalPayerAmount,i.dummyPice=t.serviceRateVo.baseRate,i.dummyPatAmount=t.originalPatientAmount,i.dummyPyrAmount=t.originalPayerAmount,a.newRate=t.newRate,a.patientAmount=t.patientAmount,a.payerAmount=t.payerAmount,a.originalPatientAmount=t.originalPatientAmount,a.originalPayerAmount=t.originalPayerAmount,a.serviceRate=t.serviceRate,a.rcvSeqId=t.serviceRateVo.rcvSeqId,a.inflSeqId=t.serviceRateVo.inflSeqId,a.proposedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,a.billedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,a.grpMstCode=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,a.discountAmt=t.discountAmt,a.doctorAmount=t.doctorAmount,a.doctorShare=t.doctorShare,a.doctorSurcharge=t.doctorSurcharge,a.hospitalShare=t.hospitalShare,a.hospitalSurcharge=t.hospitalSurcharge,a.actualRate=t.actualRate,a.isPostBillApplicable=t.isPostBillApplicable?t.isPostBillApplicable:0,r})},i.clearAdvFields=function(){i.gridOptions.data=[],i.advPat.dateofbirth="",Ie={},$(".datePickerClass").val(""),i.advPat.patientName="",i.advPat.MrNo="",i.advPat.gender="",i.advPat.mno="",i.advPat.regType="",i.advPat.payer="",i.getPatientVal(),i.updatePatientDisable=!0,$("#clear_advance").removeClass("PsearchClearBtn"),$("#clear_advance").addClass("PsearchClearBtn")},i.loadDefaultEpisodeData=function(){i.addNewEpisode.fromDate=new Date;var e=sessionStorage.getItem("episodeRegSeqid"),t=moment(i.addNewEpisode.fromDate).format("YYYY-MM-DD")+"T"+moment().format("HH:mm:ss.SSS")+"Z",r={};r.url=N.updateService.URL,r.requestData={operation:"addNewEpisodeForHSC",messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.EpisodeVo",epStatus:"1",status:"1",EpisodeDate:t,registration:{"@class":"com.napier.core.service.vo.registration.Registration",rgSeqId:e},facilityMaster:{"@class":"com.napier.core.service.vo.masters.FacilityMaster",code:"1"}}},P.sendRestRequest(r).then(function(e){var t=e.data.HITService.message;T(function(){i.clearAddPatientForm(),i.visitDls.OPVMepisodeNo=t.episodeNo,i.visitDls.OPVMepisodeDescription=t.description,i.visitDls.epSeqId=t.episodeSeqId,i.visitDls.OPVMreferedBy="",i.visitDls.OPVMvisitType=t.description,i.addNewEpisode={},i.newEpisode=[],i.newEpisodeSubmit=!1,$("#DefaultEpisodeModal").modal("hide"),i.visitDls.OPVMvisitType=t.description,i.internalorextCk=!0,i.visitDls.OPVMreferedBy1="",i.visitDls.OPVMreferedBy={},i.Mlc={},i.Mlc.OPVMmlcDetails=!1,i.updateVisitFlag=!1;var e=t.isVisitExisits;s.isVisitExisits=e,s.latestVisitNo=t.visitNO,"N"==e?(i.saveCont=!0,i.updateCont=!1):(i.saveCont=!1,i.updateCont=!0),i.tempMlcNum="",i.disableVisitInfo=!1,T(function(){i.dynamicVisitNum=s.latestVisitNo},500)},500)})},i.episodePopUp=function(e){if("HSC"!=sessionStorage.getItem("productCustomization")){i.ckEpDoc=!0,i.epRowNum=i.visitDls.OPVMepisodeNo,i.newEpisodeSubmit=!1,i.checked={selected:!1},i.disabled={selected:!0},s.addNewEpisode2={},i.addNewEpisode={};S.open("EPISODE LIST",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups firstEpisodeList",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-episode-no-modal-popup.html",size:e,scope:i,backdrop:"static",keyboard:!1});i.gridOptionss.data=[];var t=sessionStorage.getItem("episodeRegSeqid");i.episodeList=[],i.episodeLists={1:i.episodeList};var r=I.executeQueryURLReset();return i.episodesList=new Array,I.prepareParamListWithParam("pRegSeqId",t,i.episodesList),I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.episodesList),I.executeQueryInput("GET_EPISODE_LIST",i.episodesList,i.episodeLists,!0,!0,r,"popUp",{}).then(function(e){var t=e[1];i.gridOptionss.data=[];for(var r=0;r<t.length;r++)i.gridOptionss.data.push({EP_DESCRIPTION:t[r].EP_DESCRIPTION,DESCRIPTION:t[r].DESCRIPTION,EP_STRAT_DATE:t[r].EP_STRAT_DATE,FIRSTNAME:t[r].FIRSTNAME,CNT:t[r].CNT,VISIT_LAST_CREATED_ON:t[r].VISIT_LAST_CREATED_ON,EP_STATUS:1==t[r].EP_STATUS?"Open":"Close",LAST_DOCTOR_NAME:t[r].LAST_DOCTOR_NAME,EP_SEQ_ID:t[r].EP_SEQ_ID,EP_NO:t[r].EP_NO,SPECIALITY:t[r].SPECIALITY,EPDOCTOR:t[r].EPDOCTOR,VISIT_NO:t[r].VISIT_NO,DOCT_SEQ_ID:t[r].DOCT_SEQ_ID});i.newEpisode=[];for(var a=[],o=0;o<i.gridOptionss.data.length;o++)a.push(i.gridOptionss.data[o].EP_NO);var s=a.indexOf(i.epRowNum);i.gridApi.grid.modifyRows(i.gridOptionss.data),i.gridApi.selection.selectRow(i.gridOptionss.data[s])})}},i.gridOptionss={enableExpandableRowHeader:!1,enableRowSelection:!0,multiSelect:!1,enableSelectAll:!1,expandableRowTemplate:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-episode-no-sub-grid.html",expandableRowScope:{visitDetails:function(e){var t=e.entity.VISIT_NO;i.searchVisit(t),E.dismissAll()}},onRegisterApi:function(e){i.gridApi=e,e.selection.on.rowSelectionChanged(i,function(e){e.isSelected&&"Open"===e.entity.EP_STATUS?(i.checked={selected:!1},i.disabled={selected:!1}):i.disabled={selected:!0}}),e.expandable.on.rowExpandedStateChanged(i,function(e){if(e.isExpanded){e.entity.subGridOptions={columnDefs:[{displayName:"opvm.VisitNotab",headerCellFilter:"translate",field:"VISIT_NO",cellTemplate:'<a style="cursor:pointer;text-decoration: underline;position:relative;top:4px;"  ng-click="grid.appScope.visitDetails(row)"> {{row.entity.VISIT_NO}}</a>',width:150},{displayName:"opvm.VisitDate",headerCellFilter:"translate",field:"LAST_UPDATED_ON",type:"date",cellFilter:"date:'dd-MM-yyyy'",width:150},{displayName:"opvm.Department",headerCellFilter:"translate",field:"SPECIALITY",width:150},{displayName:"opvm.VisitType",headerCellFilter:"translate",field:"VSITTPDESC",width:150},{displayName:"opvm.ConsultedDoctor",headerCellFilter:"translate",field:"DOCTDESC",width:150}]},i.episodevisitList=[],i.episodevisitLists={1:i.episodevisitList};var t=I.executeQueryURLReset();i.episodesvisitList=new Array;var r=e.entity.EP_SEQ_ID.toString();return I.prepareParamListWithParam("pEpisodeId",r,i.episodesvisitList),I.prepareParamListWithParam("pFacilityId",ye,i.episodesvisitList),I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.episodesvisitList),I.executeQueryInput("VISITS_NO_EP_SEQ_ID",i.episodesvisitList,i.episodevisitLists,!0,!0,t,"popUp",{}).then(function(t){var r=t[1];e.entity.subGridOptions.data=[];for(var a=0;a<r.length;a++)e.entity.subGridOptions.data.push({VISIT_NO:r[a].VISIT_NO,LAST_UPDATED_ON:r[a].LAST_UPDATED_ON,SPECIALITY:r[a].SPECIALITY,VSITTPDESC:r[a].VSITTPDESC,DOCTDESC:r[a].DOCTDESC})})}})}},i.gridOptionss.columnDefs=[{displayName:"opvm.episodeNotab",headerCellFilter:"translate",field:"EP_NO",minWidth:130},{displayName:"opvm.EpisodeDescription",headerCellFilter:"translate",field:"EP_DESCRIPTION",minWidth:150,headerCellTemplate:'<div class="ui-grid-cell-contents ui-grid-header-cell-primary-focus"><span class="ui-grid-header-cell-label req-field" >{{"opvm.EpisodeDescription" | translate}}</span></div>'},{displayName:"opvm.DateOfCreation",headerCellFilter:"translate",field:"EP_STRAT_DATE",type:"date",cellFilter:"date:'dd-MM-yyyy'",minWidth:130},{displayName:"opvm.Department",headerCellFilter:"translate",field:"SPECIALITY",minWidth:130,headerCellTemplate:'<div class="ui-grid-cell-contents ui-grid-header-cell-primary-focus"><span class="ui-grid-header-cell-label req-field" >{{"opvm.Department" | translate}}</span></div>'},{displayName:"opvm.Doctor",headerCellFilter:"translate",field:"EPDOCTOR",minWidth:130,headerCellTemplate:'<div class="ui-grid-cell-contents ui-grid-header-cell-primary-focus"><span class="ui-grid-header-cell-label req-field" >{{"opvm.Doctor" | translate}}</span></div>'},{displayName:"opvm.NoOfVisits",headerCellFilter:"translate",field:"CNT",minWidth:100,cellTemplate:"<div><span>{{row.entity.CNT}}</span> <span ng-click='grid.api.expandable.toggleRowExpansion(row.entity)'><i class='fa fa-angle-down grid-expandarrow'></i></span></div>"},{displayName:"opvm.LastVisitDate",headerCellFilter:"translate",field:"VISIT_LAST_CREATED_ON",type:"date",cellFilter:"date:'dd-MM-yyyy'",minWidth:130},{displayName:"opvm.LastVisitDoctor",headerCellFilter:"translate",field:"LAST_DOCTOR_NAME",minWidth:130},{displayName:"opvm.episodeStatus",headerCellFilter:"translate",field:"EP_STATUS",minWidth:120},{displayName:"opvm.empseqid",headerCellFilter:"translate",field:"EP_SEQ_ID",minWidth:100,visible:!1},{displayName:"",headerCellFilter:"translate",field:"VISIT_NO",minWidth:100,visible:!1},{displayName:"",headerCellFilter:"translate",field:"DOCT_SEQ_ID ",minWidth:100,visible:!1}],i.updateEpisode=function(e){i.saveCont=!0,i.tempMlcNum="",i.updateCont=!1,i.addNewVisitFlag=!1,i.addNewEpisodeFlag=!0;var t=i.gridApi.selection.getSelectedRows(),r=sessionStorage.getItem("episodeRegSeqid");if(sessionStorage.removeItem("trnsDoc"),i.setDoctornameFlag=!1,i.newEpisodeSubmit=!0,s.addNewEpisode2.doctor&&!s.addNewEpisode2.doctor.DOCTNAME&&!i.ckEpDoc)return s.addNewEpisode2.doctor=null,!1;if(t.length>0){if("Open"==t[0].EP_STATUS){i.visitDls.OPVMepisodeNo=t[0].EP_NO,i.visitDls.OPVMepisodeDescription=t[0].EP_DESCRIPTION,i.visitDlsDoc.OPVMselectDoctor={},i.visitDlsDoc.OPVMselectDoctor.DOCTID=t[0].DOCT_SEQ_ID,i.visitDlsDoc.OPVMselectDoctor.DOCTNAME=t[0].EPDOCTOR,i.visitDls.epSeqId=t[0].EP_SEQ_ID,i.reasonForVisit=[],i.reasonForVisits={1:i.reasonForVisit};var a=I.executeQueryURLReset();i.reasonForVisitList=new Array;var o=t[0].EP_SEQ_ID.toString();return I.prepareParamListWithParam("pRegSeqId",r,i.reasonForVisitList),I.prepareParamListWithParam("pEpisodeSeqId",o,i.reasonForVisitList),I.executeQueryInput("GET_REASON_DOCNAME_FOR_LATEST_VISIT",i.reasonForVisitList,i.reasonForVisits,!0,!0,a,"popUp",{}).then(function(e){var a=e[1][0];null!=a&&(""==a.EP_REASON_FOR_VISIT?i.visitDls.OPVMvisitType=t[0].EP_DESCRIPTION:i.visitDls.OPVMvisitType=a.EP_REASON_FOR_VISIT),i.saveCont=!1,i.updateCont=!0,E.dismissAll(),i.addNewEpisode={},i.newEpisode=[],i.getDoctorNotes(t[0].EP_SEQ_ID,r),$("#DefaultEpisodeModal").modal("hide"),i.addNewVisit()})}v.hisAlertMulti("warning","Warning","Please Select Open Episode!",{buttonText:"OK"},close)}else if(e.$valid){var n=moment(i.addNewEpisode.fromDate).format("YYYY-MM-DD")+"T"+moment().format("HH:mm:ss.SSS")+"Z",c={};c.url=N.updateService.URL,c.requestData={operation:"addNewEpisode",messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.EpisodeVo",episodeName:i.addNewEpisode.episodename,description:i.addNewEpisode.episodedescription,doctor:void 0===s.addNewEpisode2.doctor.DOCTNAME?s.addNewEpisode2.doctor:s.addNewEpisode2.doctor.DOCTNAME,epDocSeqId:void 0===s.addNewEpisode2.doctor.DOCTID?s.addNewEpisode2.doctorid:s.addNewEpisode2.doctor.DOCTID,epSpeciality:i.addNewEpisode.department.CODE,epStatus:"1",status:"1",EpisodeDate:n,registration:{"@class":"com.napier.core.service.vo.registration.Registration",rgSeqId:r},facilityMaster:{"@class":"com.napier.core.service.vo.masters.FacilityMaster",code:"1"}}},P.sendRestRequest(c).then(function(e){var t=e.data.HITService.message;T(function(){E.dismissAll(),i.clearAddPatientForm(),i.visitDls.OPVMepisodeNo=t.episodeNo,i.visitDls.OPVMepisodeDescription=t.description,i.visitDls.epSeqId=t.episodeSeqId,i.visitDlsDoc.OPVMselectDoctor={},i.visitDlsDoc.OPVMselectDoctor.DOCTID=t.epDocSeqId,i.visitDlsDoc.OPVMselectDoctor.DOCTNAME=t.doctor,i.visitDlsDoc.OPVMselectDoctor.SPECIALITY_CODE=i.addNewEpisode.department.CODE,i.visitDlsDoc.OPVMselectDoctor.SPECIALITYDESC=i.addNewEpisode.department.DESCRIPTION,i.visitDlsDoc.OPVMselectDoctor.DOCTOR_SPECIALITY=t.doctor+", "+i.addNewEpisode.department.DESCRIPTION,i.visitDls.OPVMreferedBy="",i.visitDls.OPVMvisitType=t.description,i.addNewEpisode={},i.newEpisode=[],i.getDoctorNotes(t.episodeSeqId,r),i.newEpisodeSubmit=!1,$("#DefaultEpisodeModal").modal("hide"),i.visitDls.OPVMvisitType=t.description,i.internalorextCk=!0,i.visitDls.OPVMreferedBy1="",i.visitDls.OPVMreferedBy={},i.Mlc={},i.Mlc.OPVMmlcDetails=!1,i.updateVisitFlag=!1,i.saveCont=!0,i.tempMlcNum="",i.updateCont=!1,i.disableVisitInfo=!1},500)})}},i.specialityChange=function(e){i.ckEpDoc=!1,i.addNewEpisode2.doctor="",s.OPVMsearchDoctorSpeciality="",s.OPVMsearchDoctorSpeciality=e},i.docSpecialityChange=function(e){i.ckEpDoc=!1,i.addNewEpisode.department=e,i.OPVMsearchDoctorSpeciality=e},i.addNewEpisodes=function(){i.newEpisodeSubmit=!1,i.addNewEpisode.fromDate=new Date,i.newEpisode=[],i.newEpisode.push({id:1}),i.checked={selected:!0},i.checkBoxChange(i.checked)},i.checkBoxChange=function(e){T(function(){i.gridApi.selection.clearSelectedRows(),!0===e.selected?i.disabled={selected:!1}:i.disabled={selected:!0}},500)},i.doctorSearch=function(e,t){i.dctorpop={},i.dctorpop.DoctorID="",i.dctorpop.DoctorName="",i.OPVMsearchDoctorSpeciality="",i.screenname=t,"EpisodePopUp"===t&&sessionStorage.setItem("episodeDoctor",t),s.modalInstance=S.open("DOCTOR SEARCH",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-doctor-search-modal-popup.html",size:e,scope:i}),T(function(){i.OPVMsearchDoctorSpeciality=i.addNewEpisode.department,i.doctorSearchAdv()},100)},i.extDoctor={},i.extDoctorSearchoptions=angular.copy(t),i.externalDoctorSearch=function(e){s.modalInstance=S.open("External Employee Search",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-externaldoctor-search-modal-popup.html",size:e,scope:i,backdrop:"static",keyboard:!1}),i.enableExternalDoctorAdvSearch=!0,i.selectExtAdvDoctor=!0,i.extDoctor.OPVMextdocSpCentre="",i.extDoctor.extDoctorName="",i.extDoctor.extDoctorName=i.visitDls.OPVMreferedBy1,""!=i.extDoctor.extDoctorName&&(i.enableExternalDoctorAdvSearch=!1),i.extDoctorSearchoptions.data=[],i.spCenterName=[],i.specialityCentreDept=[],i.specialitySubDept=[],i.spCenterNameList={1:i.spCenterName};var t=I.executeQueryURLReset();return i.spCenterNameLists=new Array,I.prepareParamListWithParam("pIsexternal",2,i.spCenterNameLists),I.executeQueryInput("GET_MASTER_REF_FACILITY",i.spCenterNameLists,i.spCenterNameList,!0,!0,t,"popUp",{}).then(function(e){i.specialityCentre=e[1]})},i.extDocSpCentreChange=function(e){i.extDoctor.OPVMExtDocDept="",i.extDoctor.OPVMExtDocSubDept="",i.specialityCentreDept=[],i.specialitySubDept=[],i.spCenterNameDept=[],i.spCenterNameDeptList={1:i.spCenterNameDept};var t=I.executeQueryURLReset();return i.spCenterNameDeptLists=new Array,I.prepareParamListWithParam("pRefSeqId",e.REF_SEQ_ID,i.spCenterNameDeptLists),I.executeQueryInput("GET_MASTER_REF_DEPT",i.spCenterNameDeptLists,i.spCenterNameDeptList,!0,!0,t,"popUp",{}).then(function(e){i.specialityCentreDept=e[1],i.enableExternalDoctorAdvSearch=!1})},i.extDocDeptChange=function(e){i.extDoctor.OPVMExtDocSubDept="",i.specialitySubDept=[],i.extDocDept=[],i.extDocDeptList={1:i.extDocDept};var t=I.executeQueryURLReset();return i.extDocDeptLists=new Array,I.prepareParamListWithParam("pRefdSeqId",e.REFD_SEQ_ID,i.extDocDeptLists),I.executeQueryInput("GET_MASTER_REF_EMPLOYEE_BY_SD",i.extDocDeptLists,i.extDocDeptList,!0,!0,t,"popUp",{}).then(function(e){i.specialitySubDept=e[1]})},i.employeeNameChange=function(){""!=i.extDoctor.OPVMextdocSpCentre&&0!=i.extDoctor.extDoctorName.length?i.enableExternalDoctorAdvSearch=!1:i.extDoctor.extDoctorName.length>0?i.enableExternalDoctorAdvSearch=!1:i.enableExternalDoctorAdvSearch=!0},i.OPVMExternalDoctorSearchTypeAhead=function(e){i.OPVMDoctroSearch=[],i.multipleComboDataForList={1:i.OPVMDoctroSearch};var t=I.executeQueryURLReset();return i.OPVMDoctSearch=new Array,I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.OPVMDoctSearch),I.prepareParamListWithParam("pRefEmpName",e,i.OPVMDoctSearch),I.executeQueryInput("EXTERNAL_OP_DOCTOR_SEARCH",i.OPVMDoctSearch,i.multipleComboDataForList,!0,!0,t,"popUp",{}).then(function(e){if(0!==e)return(e[1]instanceof Array?e[1]:[e[1]]).map(function(e){return e});i.noResults=!0})},i.externalDoctorAdvSearch=function(e){var t={};t.url=N.updateService.URL,t.requestData={operation:"retrieveReferralEmployeeMaster",messageId:"",destination:"com.napier.core.master.service.external.ReferralMasterService",message:{"@class":"com.napier.core.service.vo.emrmasters.ReferralEmployeeMaster",isExternal:2,refFacSeqId:e.OPVMextdocSpCentre.REF_SEQ_ID,deptDesc:e.OPVMExtDocDept.REFD_DESC,subDeptDesc:e.OPVMExtDocSubDept.REFSD_DESC,refdSeqId:e.OPVMExtDocSubDept.REFD_SEQ_ID,refsdSeqId:e.OPVMExtDocDept.REFSD_SEQ_ID,empName:e.extDoctorName}},P.sendRestRequest(t).then(function(e){var t=e.data.HITService.message[0]["com.napier.core.service.vo.emrmasters.ReferralEmployeeMaster"];if(i.extDoctorSearchoptions.data=[],null!=t.length)for(var r=0;r<t.length;r++)i.extDoctorSearchoptions.data.push({refFacDesc:t[r].refFacDesc,deptDesc:t[r].deptDesc,subDeptDesc:t[r].subDeptDesc,empName:t[r].empName});else i.extDoctorSearchoptions.data.push({refFacDesc:t.refFacDesc,deptDesc:t.deptDesc,subDeptDesc:t.subDeptDesc,empName:t.empName})})},i.selectExtAdvDoc=function(){s.modalInstance.close(),i.visitDls.OPVMreferedBy1=i.extDoctorSearchValues.empName},i.doctorSearchAdv=function(e){s.OPVMselectDoctor="";var t,r,a;a=void 0===i.OPVMsearchDoctorSpeciality||null===i.OPVMsearchDoctorSpeciality?"":i.OPVMsearchDoctorSpeciality.CODE,i.gridDoctorSearchoptions.data.length=0,i.OPVMsearchBypatientName=[],i.multipleComboDataForList={1:i.OPVMsearchBypatientName},t=angular.element(document.querySelector("#opvm-search-doctor-doctorID"))[0].value,r=i.dctorpop.OPVMsearchDoctorDoctorName;var o=I.executeQueryURLReset();return i.OPVMsearchBypatientNameList=new Array,I.prepareParamListWithParam("pSpecializationId",a,i.OPVMsearchBypatientNameList),I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.OPVMsearchBypatientNameList),I.prepareParamListWithParam("pDoctorId",t,i.OPVMsearchBypatientNameList),I.prepareParamListWithParam("pDoctorName",r,i.OPVMsearchBypatientNameList),I.executeQueryInput("OP_DOCTOR_ADVANCE_SEARCH",i.OPVMsearchBypatientNameList,i.multipleComboDataForList,!0,!0,o,"popUp",{}).then(function(e){for(var t=0;t<e[1].length;t++)i.gridDoctorSearchoptions.data.push({Doctorname:e[1][t].DOCTNAME,DoctorCode:e[1][t].DOCCODE,DoctorID:e[1][t].DOCTID,Speciality:e[1][t].SPECIALITYDESC,SpecialityCode:e[1][t].SPECIALITY_CODE,DoctorSpeciality:e[1][t].DOCTOR_SPECIALITY})})},q.getTitle().then(function(e){i.titles=e},function(e){}),q.getGender().then(function(e){i.genders=e},function(e){}),q.serviceTypes().then(function(e){i.serviceTypes=e},function(e){}),i.filterValue=function(e){46!=e.keyCode&&isNaN(String.fromCharCode(e.keyCode))&&e.preventDefault()},i.clearAddPatientForm=function(){i.patientSubmit=!1,i.permanentregistration={},i.permanentregistration.DOB=!0},i.addpatientdetailssave=function(e,t){i.patientSubmit=!0;var r=e.OPVMaddPatientDetailsAge;if(r.indexOf("y")>0)var a=r.split("y")[0];else a=0;if(t.$valid){var o={"@class":"com.napier.core.service.vo.registration.Registration",patient:{"@class":"com.napier.core.service.vo.registration.Patient",status:{"@class":"com.napier.core.service.vo.masters.GeneralMaster",type:"GN_STATUS",code:1,description:"Active"},title:{"@class":"com.napier.core.service.vo.masters.SalutationMaster",code:e.OPVMaddPatientdetailsTitle||""},firstName:e.OPVMaddPatientDetailsFirstName||"",middleName:e.OPVMaddPatientDetailsMiddleName||"",lastName:e.OPVMaddPatientDetailsLastName||"",age:a||"",mobileNo:e.OPVMaddPatientdetailsMobileNumber||"",emailId:e.OPVMaddPatientDetailsEmailId||"",date:moment().toISOString(),dateOfBirth:new Date(e.fromDate._d).toISOString(),tmpNationalId:e.OPVMaddPatientDetailsNationalId,serviceTypeCode:e.OPVMaddPatientDetailsService||"",sex:{"@class":"com.napier.core.service.vo.masters.GenderMaster",code:e.OPVMaddPatientdetailsGender||""},facilityId:{"@class":"com.napier.core.service.vo.masters.FacilityMaster",code:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,description:JSON.parse(sessionStorage.userContextObj).FACILITY},typeOfReg:{"@class":"com.napier.core.service.vo.masters.GeneralMaster",type:"Registration Type",code:2,description:"Temporary Registration"}}},s={url:"HISServices/HITService"};s.requestData={operation:"createRegistration",destination:"com.napier.core.registration.service.external.RegistrationService",messageid:"",message:o},P.sendRestRequest(s).then(function(t){i.patientBannerCollapsed=!1;var r=t.data.HITService.message;if(r.patient){var a="Patient Details Saved successful -Temp No: "+r.patient.tempNo,o={buttonClose:function(){i.patientTempRegt(r.tmpSeqId),i.clear(e),i.clearAddPatientForm(),$(".ng-patient-banner").attr("class","ng-patient-banner ng-scope"),i.patientBannerVisible=!0}};v.hisAlertMulti("success","Succes",a,"","",o)}else v.failure("FAILED"," "+r.errorMessage)},function(e){v.failure("Failed","Patient  Details has been failed.",!1,!1,me.time)})}},i.clear=function(e){e.OPVMaddPatientDetailsNationalId="",e.OPVMaddPatientdetailsTitle="",i.permanentregistration={},i.visitDls={}},i.loadReferedDocDtls=function(e){if(i.visitDls.OPVMreferedBy1="",i.visitDls.OPVMreferedBy={},"I"==e){i.hideExternalRef=!1,i.hideInternalRef=!0,i.rDocList=[],i.rDocComboList={1:i.rDocList};var t=I.executeQueryURLReset();i.refDocList=new Array,I.prepareParamListWithParam(1,angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.refDocList),I.executeQueryInput("DOCT_LIST_NEW",i.refDocList,i.rDocComboList,!0,!0,t,"popUp"),i.visitDls.OPVMreferedBy1=""}else i.hideInternalRef=!1,i.hideExternalRef=!0,i.visitDls.OPVMreferedBy1=""},i.loadReferedDocDtls("I"),Y.getList("HSC_VISITLOCATION_DROPDOWN_001",[]).then(function(e){i.admittingLocationComboList=[];var t=W.getQryComboList(e);angular.forEach(t,function(e,t){var r=e.columnList[0]["com.napier.core.service.vo.query.Column"],a={CODE:r[0].data,DESCRIPTION:r[1].data};i.admittingLocationComboList.push(a)})}),i.checkIfAppoinemntIsSelected=function(){try{if(i.todaysAppoinmentsData.length>0&&i.RowsArr.length>0)for(var e=0;e<i.RowsArr.length;e++)for(var t=0;t<i.todaysAppoinmentsData.length;t++)i.RowsArr[e][0].opApmntSeqId==i.todaysAppoinmentsData[t].opApmntSeqId&&(i.todaysAppoinmentsData[t].isSelected=!0,i.todaysAppoinmentsData[t].apptFlag=!0);if(i.appointmentsData.length>0&&i.RowsArr.length>0)for(e=0;e<i.RowsArr.length;e++)for(t=0;t<i.appointmentsData.length;t++)i.RowsArr[e][0].opApmntSeqId==i.appointmentsData[t].opApmntSeqId&&(i.appointmentsData[t].isSelected=!0,i.appointmentsData[t].apptFlag=!0)}catch(e){}},i.showComingAppt=function(){if(i.regTypeData&&i.regTypeData.RG_SEQ_ID){i.setCurrentTarrifId();i.todaysAppoinmentsData=[],i.appointmentsData=[],i.appointmentsDataFull=[],i.fromAppoinemtView=!0;var e={"@class":"com.napier.his.appointment_management.vo.PatientSearchVO",rgSeqId:i.regTypeData.RG_SEQ_ID},t={url:"HISServices/AppointmentsManagementService"};t.requestData={operation:"getAppointmentsDetailsForOPPatient",destination:"com.napier.his.appointment_management.service.external.AppointmentsManagementService",message:e},P.sendRestRequest(t).then(function(e){try{var t=e.data.HITService.message[0]["com.napier.his.appointment_management.vo.OpAppointmentsEntityVO"]}catch(e){}if(t&&void 0!==t){i.modalInstance=S.open("APPOINTMENTS LIST",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-up-coming-appointments.html",size:"lg",scope:i});i.apptFlag=0;let e=t instanceof Array?t:[t];var r=moment().format("YYYY-MM-DD");let o=[];for(var a=0;a<e.length;a++){e[a].value=a,e[a].calendarDateToDisplyFormat=new Date(e[a].calendarDateToDisply.split("T")[0].split("-")[2]+"/"+e[a].calendarDateToDisply.split("T")[0].split("-")[1]+"/"+e[a].calendarDateToDisply.split("T")[0].split("-")[0]),e[a].showHeader=!0;let t=moment(e[a].calendarDateToDisplyFormat).diff(r,"days");0===t?i.todaysAppoinmentsData.push(e[a]):(-1===o.indexOf(e[a].calendarDateToDisply)?o.push(e[a].calendarDateToDisply):e[a].showHeader=!1,t>0&&(e[a].isFuture=!0),i.appointmentsData.push(e[a])),i.appointmentsDataFull.push(e[a]),i.selectedapptment&&i.selectedapptment.opApmntSeqId==e[a].opApmntSeqId&&(i.apptFlag=i.selectedapptment.opApmntSeqId)}i.todaysAppoinmentsData.length>1&&i.todaysAppoinmentsData.sort(function(e,t){return e.slotStartTime>t.slotStartTime?1:e.slotStartTime<t.slotStartTime?-1:0}),i.appointmentsData.sort(function(e,t){return new Date(e.calendarDateToDisplyFormat)-new Date(t.calendarDateToDisplyFormat)}),i.checkIfAppoinemntIsSelected()}else i.appointmentsData=[],i.todaysAppoinmentsData=[],i.appointmentsDataFull=[]})}},i.getPayerDetail=function(e,t){if(null!=t)if(s.isVisitExisits&&"N"==s.isVisitExisits);else var r=t;var a={url:"HISServices/HISServices"};a.requestData={operation:"getPayerDetailsForOPPatient",messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.PayerDetailsVo",rgSeqId:e,enSeqId:r}},P.sendRestRequest(a).then(function(e){if(s.tariffSeqId="",e&&e.data&&e.data.HITService&&e.data.HITService.message&&e.data.HITService.message[0]&&e.data.HITService.message[0]["com.napier.core.service.vo.visitmanagement.PayerDetailsVo"])var t=e.data.HITService.message[0]["com.napier.core.service.vo.visitmanagement.PayerDetailsVo"];t?(i.payerDetails=t instanceof Array?t:[t],i.payerDetails[0].tariffSeqId?s.tariffSeqId=i.payerDetails[0].tariffSeqId:s.patientGlobalDtlsNew[0]&&s.patientGlobalDtlsNew[0].tariffSeqId&&(s.tariffSeqId=s.patientGlobalDtlsNew[0].tariffSeqId)):v.failure("Failed"," "+t.errorMessage)},function(e){v.failure("Failed","Visit Search has been failed.",!1,!1,me.time)})},i.patientOutstandingPop=function(t){if(!i.isIpPat){var r;e.defer();r={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"OPVM_PATIENT_SEARCH_OUTSTDAMT",idxList:[{"com.napier.core.service.vo.query.Index":[{ident:1,value:t}]}]}]}]};var o={};o.url=a.HISCOMBOFILLING.URL,o.requestData={operation:"ExecuteQuery",destination:"QueryService",message:r},P.sendRestRequest(o).then(function(e){var r=e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0];if(""!=r){var a=r["com.napier.core.service.vo.query.Row"].columnList[0]["com.napier.core.service.vo.query.Column"];a.data&&parseFloat(a.data)>0&&(sessionStorage.getItem("pharmacyOPVM")||$("#patientOutstandingModal").modal({backdrop:"static",keyboard:!1}),i.OutStandingAmount=a.data)}else i.openVisitsInfo(t)})}},i.closeOutStandingModel=function(){$("#patientOutstandingModal").modal("hide"),i.openVisitsInfo(s.patientSeqId)},i.getAppoinmentDetailstoOrder=function(){if(i.selectedAppoinmentList&&i.selectedAppoinmentList.length>0){E.dismissAll(),i.addRowStatus=!1;var e=i.payerTypeModel.PayerType.PINS_SEQ_ID;H.getAppoinmentConsDetails(i.selectedAppoinmentList,i.regTypeData.RG_SEQ_ID,s.encounterSeqId,s.tariffSeqId,e).then(function(e){if(e&&e.length>0){for(let t=0;t<e.length;t++)e[t][0].payerType=i.payerTypeModel.PayerType.PAYER_NAME,e[t][0].payerTypeCode=i.payerTypeModel.PayerType.PINS_SEQ_ID,e[t][0].payerTarrifId=i.payerTypeModel.PayerType.TATRIFF_SEQ_ID?i.payerTypeModel.PayerType.TATRIFF_SEQ_ID:s.tariffSeqId,e[t][0].insurancePlanSeqId=null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0;i.RowsArr=i.RowsArr.concat(e),i.orderBtnDisable=!1}i.selectedAppoinmentList=[],i.addRowStatus=!0},function(e){i.addRowStatus=!0})}},i.checkVisitfromAppointment=function(){i.selectedAppoinmentList=[];var e=!1,t=!1;try{for(let e=0;e<i.todaysAppoinmentsData.length;e++)i.todaysAppoinmentsData[e].apptFlag&&!i.todaysAppoinmentsData[e].isSelected&&(i.selectedAppoinmentList.push(i.todaysAppoinmentsData[e]),t=!0);for(let t=0;t<i.appointmentsData.length;t++)i.appointmentsData[t].apptFlag&&!i.appointmentsData[t].isSelected&&(i.selectedAppoinmentList.push(i.appointmentsData[t]),e=!0)}catch(e){}return 0==i.selectedAppoinmentList.length?(v.warning("Warning!","Please select at least one Appointment for Visit creation.",!1,!1,me.time),!1):e&&t?(v.warning("Warning!","Visit can be created only against of same day Appointments.",!1,!1,me.time),!1):e?(v.warning("Warning!","Future day Appointments are not allowed for visit creation.",!1,!1,me.time),!1):void(i.fromAppoinemtView?i.getAppoinmentDetailstoOrder():i.createVisitfromAppointment())},i.createVisitfromAppointment=function(){E.dismissAll(),i.visitDls.OPVMvisitType="",i.addNewVisit();var e=i.selectedAppoinmentList[0].resourceName.slice(4);i.visitDls.OPVMvisitType=i.selectedAppoinmentList[0].resonForDoctorVisit,i.visitDlsDoc.OPVMselectDoctor={},i.visitDlsDoc.OPVMselectDoctor.DOCTID=i.selectedAppoinmentList[0].doctorId,i.visitDlsDoc.OPVMselectDoctor.DOCTNAME=e,i.visitDlsDoc.OPVMselectDoctor.SPECIALITY_CODE=i.selectedAppoinmentList[0].specalityId,i.visitDlsDoc.OPVMselectDoctor.SPECIALITYDESC=i.selectedAppoinmentList[0].specalityName,i.visitDlsDoc.OPVMselectDoctor.DOCTOR_SPECIALITY=e+", "+i.selectedAppoinmentList[0].specalityName,sessionStorage.removeItem("subaccountseqId"),s.encounterSeqId=void 0,i.selectMatchDoctor(i.visitDlsDoc.OPVMselectDoctor,null,null,null,null,!0),"HSC"!=sessionStorage.getItem("productCustomization")&&i.addNewEpisodes(),T(function(){i.addNewEpisodes(),"HSC"!=sessionStorage.getItem("productCustomization")?(i.addNewEpisodes(),i.addNewEpisode.episodedescription=i.selectedAppoinmentList[0].resonForDoctorVisit):i.loadDefaultEpisodeData(),i.addNewEpisode2.doctor=e,s.addNewEpisode2.doctor=e,s.addNewEpisode2.doctorid=i.selectedAppoinmentList[0].doctorId;for(var t=0;t<i.serviceComboObj.length;t++)i.serviceComboObj[t].CODE==i.selectedAppoinmentList[0].specalityId&&(i.addNewEpisode.department=i.serviceComboObj[t])},300)},m.comboBoxFetch("MLC_TYPES").then(function(e){i.mlctypeComboObj=e}),i.selectAdvDoc=function(){if("EpisodePopUp"===sessionStorage.getItem("episodeDoctor")){i.ckEpDoc=!1,sessionStorage.setItem("episodeDoctor",null),s.addNewEpisode2.doctor=i.doctorSearchValues.Doctorname;var e=i.OPVMsearchDoctorSpeciality;s.modalInstance.close(e),sessionStorage.setItem("epDoc",JSON.stringify(i.doctorSearchValues));JSON.parse(sessionStorage.getItem("epDoc"));s.addNewEpisode2.doctorid=i.doctorSearchValues.DoctorID}else if("ordersScreen"==i.screenname){i.orders.OPVMselectDoctor={},i.orderDetails.OPVMselectDoctor=i.doctorSearchValues.Doctorname,i.orders.OPVMselectDoctor.DOCTID=i.visitDlsDoc.OPVMselectDoctor.DOCTID,i.orders.OPVMselectDoctor.DOCTNAME=i.visitDlsDoc.OPVMselectDoctor.DOCTNAME,i.orders.OPVMselectDoctor.SPECIALITY_CODE=i.visitDlsDoc.OPVMselectDoctor.SPECIALITY_CODE,i.orders.OPVMselectDoctor.SPECIALITYDESC=i.visitDlsDoc.OPVMselectDoctor.SPECIALITYDESC,i.orders.OPVMselectDoctor.DOCTOR_SPECIALITY=i.visitDlsDoc.OPVMselectDoctor.DOCTOR_SPECIALITY,i.orderDoctDetails=i.orders.OPVMselectDoctor,i.orderData.requestedByEmpName=i.doctorSearchValues.Doctorname,i.orderData.requestedByEmpSeqID=i.doctorSearchValues.DoctorID,s.modalInstance.close();var t={};t.docID=i.doctorSearchValues.DoctorID,t.DOCTNAME=i.doctorSearchValues.Doctorname;var r=i.doctorSearchValues.SpecialityCode,a=i.doctorSearchValues.DoctorID,o=sessionStorage.getItem("orderregSeqId"),n=sessionStorage.getItem("orderencounterSeqId");i.setCurrentTarrifId();var c=s.tariffSeqId,l=i.payerTypeModel.PayerType.PINS_SEQ_ID,p=i.orderData.quantity,d="";d=void 0!==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID?i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID:i.orderData.appointReason;var m="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,m=i.priorityvis.priorityTypeModel.DT_CODE):(i.priorityvis.visitTypeModel,m=i.orderDetails.visitTypeCode);var u=m;if(1!=d){i.addSelectServicepostEditArr=[];var S=new Date,y=moment(S).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";N.updateService.URL;var D=1;3==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID&&(D=2);var g=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.orderDetails.servSeqId,gnServDesign:D,servCode:i.orderDetails.servCode,servName:i.orderDetails.servName,secServTypeCode:i.orderDetails.servSeqId,priServTypCode:i.orderDetails.servSeqId},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.orderDetails.servSeqId,tariffSeqId:s.tariffSeqId,datedOn:y,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:i.orderData.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:a,payerId:l,fromOPVisit:"Y",priority:u}];i.addSelectServicepostEditArr.push(g);var A={};A.url=N.updateService.URL,A.requestData={operation:"getOPServicePostingList",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectServicepostEditArr}]}},P.sendRestRequest(A).then(function(e){i.addselectEdiresponse=e.data.HITService.message,""==i.addselectEdiresponse.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time);var t=i.addselectEdiresponse.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];i.orderData.serviceTypeCODE=t.primaryServiceCode,i.orderData.serviceType=t.primaryServiceCode,i.orderData.servCode=t.serviceVo.servCode,i.orderData.servName=t.serviceVo.servName,i.orderData.servSeqId=t.serviceVo.servSeqId,i.orderData.gnServDesign=t.serviceVo.gnServDesign,i.orderData.servicePayerAuthorization=t.servicePayerAuthorization,i.orderData.requestedByEmpName=t.requestedByEmpName,i.orderData.requestedByEmpSeqID=t.requestedByEmpSeqID,i.orderData.requestedByEmpType=t.requestedByEmpType,i.orderData.payerType=i.payerTypeModel.PayerType.PAYER_NAME,i.orderData.payerTypeCode=i.payerTypeModel.PayerType.PINS_SEQ_ID,i.orderData.insurancePlanSeqId=null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,i.orderData.actualRate=t.actualRate,i.orderData.quantity=1,i.orderData.isPostBillApplicable=t.isPostBillApplicable?t.isPostBillApplicable:0,i.orderData.patientAmount=t.patientAmount,i.orderData.payerAmount=t.payerAmount,i.orderData.originalPatientAmount=t.originalPatientAmount,i.orderData.originalPayerAmount=t.originalPayerAmount,i.orderData.discountAmt=t.discountAmt,i.orderData.doctorAmount=t.doctorAmount,i.orderData.doctorShare=t.doctorShare,i.orderData.doctorSurcharge=t.doctorSurcharge,i.orderData.hospitalShare=t.hospitalShare,i.orderData.hospitalSurcharge=t.hospitalSurcharge,i.orderData.isRateEditable=t.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,1==i.orderData.isRateEditable&&(i.orderData.minValue=null!=t.minVal?t.minVal:t.serviceVo.scmMasterServBillingAttrVo.minValue,i.orderData.maxValue=null!=t.maxVal?t.maxVal:t.serviceVo.scmMasterServBillingAttrVo.maxValue,i.orderData.fromTariffRate="R"),i.orderData.newRate=t.newRate,i.orderData.proposedShareAfterDiscount=t.proposedShareAfterDiscount,i.orderData.serviceRate=t.serviceRate,i.orderData.serviceRateStatus=t.serviceRateStatus,i.orderData.standardDoctorShare=t.standardDoctorShare,i.orderData.technicianAmount=t.technicianAmount,i.orderData.baseRate=t.serviceRateVo.baseRate,i.orderData.gnFlow=t.gnFlow,i.orderData.facilityId=t.facilityId,i.orderData.billStatus=0,i.orderData.payerCompSeqId=t.payerCompSeqId,i.orderData.payerCompPlanseqId=t.payerCompPlanseqId,i.orderDetails.price=t.serviceRate,i.dummyPice=t.serviceRate/i.orderDetails.quantity,i.dummyPatAmount=t.originalPatientAmount/i.orderDetails.quantity,i.dummyPyrAmount=t.originalPayerAmount/i.orderDetails.quantity,i.orderDetails.patamount=t.originalPatientAmount,i.orderDetails.payeramount=t.originalPayerAmount,i.dummyPyrAutherisation=t.servicePayerAuthorization,i.orderDetails.servCode=t.serviceVo.servCode,i.orderDetails.servName=t.serviceVo.servName,i.orderDetails.servSeqId=t.serviceVo.servSeqId,i.orderData.rcvSeqId=t.serviceRateVo.rcvSeqId,i.orderData.inflSeqId=t.serviceRateVo.inflSeqId,i.orderData.proposedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,i.orderData.billedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,i.orderData.grpMstCode=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,i.orderData.priServTypCode=t.secServiceCode,null!=t.serviceVo&&null!=t.serviceVo.atomicDetailsVo&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&(null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&(i.orderData.deptCode=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code),null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&(i.orderData.specilityCode=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code))})}else i.getOrderDetails(a,o,n,c,void 0,l,p,r);i.OrderDoctorChange("Doctor",t)}else{sessionStorage.removeItem("epDoc"),i.setDoctornameFlag=!1,sessionStorage.setItem("trnsDoc",JSON.stringify(i.doctorSearchValues));var I=JSON.parse(sessionStorage.getItem("trnsDoc"));s.visitDlsDoc.OPVMselectDoctor=I.Doctorname,i.visitDlsDoc.OPVMselectDoctor={},i.visitDlsDoc.OPVMselectDoctor.DOCTID=I.DoctorID,i.visitDlsDoc.OPVMselectDoctor.DOCTNAME=I.Doctorname,i.visitDlsDoc.OPVMselectDoctor.SPECIALITY_CODE=I.SpecialityCode,i.visitDlsDoc.OPVMselectDoctor.SPECIALITYDESC=I.Speciality,i.visitDlsDoc.OPVMselectDoctor.DOCTOR_SPECIALITY=I.DoctorSpeciality,s.modalInstance.close()}},i.getPatientCatg=function(t){var r=e.defer(),o={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"OP_NHIS_ADT_TR_072",idxList:[{"com.napier.core.service.vo.query.Index":[{ident:"1",value:t},{ident:"2",value:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID}]}]}]}]},s={};return s.url=a.HISCOMBOFILLING.URL,s.requestData={operation:"ExecuteQuery",messageId:"",destination:"QueryService",message:o},P.sendRestRequest(s).then(function(e){var t,r=(t=void 0===e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"].columnList?e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"][0].columnList[0]["com.napier.core.service.vo.query.Column"]:e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"].columnList[0]["com.napier.core.service.vo.query.Column"]).filter(function(e){return"B.PCATG_SEQ_ID"==e.name}),a=t.filter(function(e){return"A.RG_PAT_CATG"==e.name});i.patCatCode=a[0].data,i.patCatSeqId=r[0].data}),r.promise},i.getVisitCount=function(){i.visitCountData=[],i.visitCountDataForListorder={1:i.visitCountData};var e=I.executeQueryURLReset();return i.visitCountDataListorder=new Array,I.prepareParamListWithParam("pRgSeqId",sessionStorage.getItem("episodeRegSeqid"),i.visitCountDataListorder),I.executeQueryInput("GET_VISIT_ADMISSION_COUNT_HSC",i.visitCountDataListorder,i.visitCountDataForListorder,!0,!0,e,"popUp",i.advSearch).then(function(e){var t=e[1];e[1][0]&&(i.opVisitCount=t[0].VISIT_COUNT)})},i.visitSaveUpdate=function(e,t,r,a,o){i.submit=!0,i.setPracticeId=void 0,i.setfacilityId=void 0;i.enSeqId=void 0;var n,c=typeof r.OPVMselectDoctor.DOCTID;if(o.$valid&&"undefined"!=c){JSON.parse(sessionStorage.getItem("trnsDoc")),JSON.parse(sessionStorage.getItem("epDoc"));var l,p=sessionStorage.getItem("episodeRegSeqid");l=null!=s.convertedFile?s.convertedFile.split("base64")[1]:"",n=0==e.OPVMmlcDetails||void 0===e.OPVMmlcDetails?"n":"y";t.OPVMreferedBy1;i.updateCont&&(i.enSeqId=i.epSqNo,i.docSeqId&&i.docSeqId,i.mlcDetailsId,i.setPracticeId=angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.setfacilityId=angular.fromJson(sessionStorage.userContextObj).FACILITY_ID),m.createVisitAndOrders(e,t,r,a,i,l,p,s).then(function(e){var t,r,a=e.data.HITService.message;if(a){i.opVisitCountApplicableFlag&&i.getVisitCount();var o=a.encounter.enSpeciality,c=a.encounter.doctorMaster.doctSeqId,l=a.encounter.registraiion.rgSeqId,p=a.encounter.enSeqId,d=s.tariffSeqId;if(a.registration){try{i.opSearch={type:1},m=encounter.payerDetailsVoLst[0]["com.napier.core.service.vo.visitmanagement.PayerDetailsVo"].payerNameId}catch(e){}u=1,r=a.registration.mrNo,s.patientSeqId=l}else var m=i.payerDetails[0].payPrioritySeqId,u=i.orderDetails.quantity;"y"==n&&i.savaForMLCService(a.encounter,c,l,p,d,void 0,m,u,o),t=i.updateCont?"Visit Updated Succesfully!<br />Visit No: "+i.visitNumber:"Visit Created Successfully!<br />Visit No: "+a.encounter.visitNo,r&&(t="Visit "+a.encounter.visitNo+" successfully created for patient Registration "+r),i.showVSaveLoadingIcon=!1,i.dynamicVisitNum=a.visitNo,T(function(){E.dismissAll(),i.updateCont?i.searchVisit(i.visitNumber):i.searchVisit(a.encounter.visitNo,!1,!0),i.getOrderDetails(c,l,p,d,void 0,m,u,o)},3e3),v.hisAlertMulti("success","Success",t,"","",""),i.showVSaveLoadingIcon=!1}else v.failure("Failed"," ",!1,!1,me.time),i.showVSaveLoadingIcon=!1})}else i.showVSaveLoadingIcon=!1},i.visitSave=function(e,t,r,a,o,s){if(e=i.Mlc,i.opSearch&&2==i.opSearch.type&&(i.regTempPat.tempPatDtlsForm&&i.regTempPat.tempPatDtlsForm.$invalid||o.$invalid))return i.submit=!0,v.warning("Warning!","Please fill all the required fields",!1,!1,me.time),!1;if(o.$valid)if("update"==s||i.opSearch&&2==i.opSearch.type)i.showVSaveLoadingIcon=!0,i.visitSaveUpdate(e,t,r,a,o);else{if("NO"==i.isAllowMultiVisitPerEpisode&&t.epSeqId){i.showVSaveLoadingIcon=!0;i.visitExist=[],i.visitExists={1:i.visitExist};var n=I.executeQueryURLReset();return i.visitExistList=new Array,I.prepareParamListWithParam("pEpSeqId",t.epSeqId,i.visitExistList),I.executeQueryInput("ALLOW_MULTIPLE_VISIT_PER_EPISODE_QUERY",i.visitExistList,i.visitExists,!0,!0,n,"popUp",{}).then(function(s){if(s[1].length>0)return v.warning("Warning!","Visit Already Open for this Episode. You can not create new visit.",!1,!1,me.time),i.showVSaveLoadingIcon=!1,!1;i.visitSaveUpdate(e,t,r,a,o)})}i.showVSaveLoadingIcon=!0,i.visitSaveUpdate(e,t,r,a,o)}else i.submit=!0},i.checkPayerCRLimit=function(e,t,r,a,o,s){var n=0;if(t.vistPayer&&t.vistPayer.PINS_SEQ_ID)var c=t.vistPayer.PINS_SEQ_ID;if(c&&""!=c&&a&&-1===(n=a.map(function(e){return e.payerNameId}).indexOf(parseInt(c)))&&(n=0),a&&a[n]&&(1==a[n].payerType||3==a[n].payerType)){var l={1:i.checkList=[]},p=I.executeQueryURLReset(),d=1==a[n].payerType?2:1,m=new Array;I.prepareParamListWithParam("PAYER_SEQ_ID",a[n].payerSeqId,m),I.prepareParamListWithParam("TYPE",d,m),I.prepareParamListWithParam("PAT_CATG",-999,m),I.prepareParamListWithParam("BED_CLASS",-999,m),I.prepareParamListWithParam("OPERATION","OPVISIT",m),I.executeQueryInput("SP_UPS_GET_PAYER_CREDIT_LIMIT",m,l,!0,!0,p,"popUp",{}).then(function(s){if(s[1])if(i.checkList[0]&&parseFloat(i.checkList[0].AVAIALBLE_BAL)<=0){var n={buttonCallBack1:function(){i.visitSave(e,t,r,a,o)},buttonCallBack2:function(){}};v.hisAlertMulti("warning","Confirmation","Credit limit is exceeding. Would you like to continue ?",{buttonText:"YES",buttonText2:"NO"},n,close)}else i.visitSave(e,t,r,a,o)})}else i.visitSave(e,t,r,a,o)},i.getPatAllPayers=function(e){i.patPayerData=[],i.patPayerComboDataList={1:i.patPayerData};var t=I.executeQueryURLReset();return i.patPayerDataList=new Array,I.prepareParamListWithParam("pRegSeqId",e,i.patPayerDataList),I.executeQueryInput("PATIENTS_PAYER_QUERY_001",i.patPayerDataList,i.patPayerComboDataList,!0,!0,t,"popUp",i.advSearch).then(function(e){i.AllPatPayerDetails=e[1]})},i.getAddedPreAuths=function(e){i.addPayerAuthrList=[];var t={};t.url=N.updateService.URL,t.requestData={operation:"getAuthorizationReqDtls",messageId:"",destination:"com.napier.core.billgeneration.service.external.ApproximateBillService",message:{"@class":"com.napier.core.billgeneration.vo.ApproxBillVo",regSeqId:e}},P.sendRestRequest(t).then(function(e){var t=e.data,r=t.HITService.message.approxBillsList?t.HITService.message.approxBillsList[0]["com.napier.core.billgeneration.vo.ApproxBillVo"]:"";if(r){var a=[];void 0!==r.length?a=r:a.push(r);for(var o=0;o<a.length;o++)i.addPayerAuthrList.push({reqDate:moment(a[o].approxBillDate.$).format("DD/MM/YYYY"),reqDateDummy:a[o].approxBillDate.$,plan:a[o].planName,autherNum:0==a[o].approvalRefNo?"":a[o].approvalRefNo,apprAmnt:0==a[o].approvedAmount?"":a[o].approvedAmount,payerType:a[o].payerType,status:a[o].approvalStatus,approxBillNo:a[o].approxBillNo,approxBillHdSeqId:a[o].approxBillHdSeqId,effectiveFrom:null!=a[o].effectiveFrom&&null!=a[o].effectiveFrom.$?moment(a[o].effectiveFrom.$).format("DD/MM/YYYY"):void 0,effectiveFromDummy:null!=a[o].effectiveFrom&&null!=a[o].effectiveFrom.$?a[o].effectiveFrom.$:void 0,effectiveTo:null!=a[o].effectiveTo&&null!=a[o].effectiveTo.$?moment(a[o].effectiveTo.$).format("DD/MM/YYYY"):void 0,effectiveToDummy:null!=a[o].effectiveTo&&null!=a[o].effectiveTo.$?a[o].effectiveTo.$:void 0,gnStatus:a[o].GN_STATUS,isBillOrServiceLevel:a[o].isBillOrServiceLevel,consumnedCnt:a[o].consumnedCnt,totalCnt:a[o].totalCnt,deleteFlag:null!=a[o].consumnedCnt&&1==a[o].consumnedCnt,editFlag:null!=a[o].consumnedCnt&&null!=a[o].totalCnt&&a[o].consumnedCnt==a[o].totalCnt})}})},i.searchVisit=function(e,t,r){m.checkVisitClosedorNot(e).then(function(e){4!=e.data?i.clsvisitBtn=!1:("HSC"!=i.hscSpecific&&v.warning("Warning!","Visit Already Closed.Please Create a New Visit",!1,!1,me.time),i.clsvisitBtn=!0,i.dynmVisit=!0,i.defaultVisit=!1,i.dynamicVisitNum="")}),i.getPatAllPayers(s.patientSeqId),i.getAddedPreAuths(s.patientSeqId),i.showVSaveLoadingIcon=!1,i.showRefundLoadingIcon=!1,i.showConcessionLoadingIcon=!1,i.showPaymentLoadingIcon=!1,i.showGBillLoadingIcon=!1,i.showGBillCanLoadingIcon=!1,i.showOrderCanLoadingIcon=!1,i.showOrderLoadingIcon=!1,i.reqFromOrder=!1,i.cancelButtonEna=0,i.amountValid=!1,s.orderRowData=null,i.addRowStatus=!0,i.orderUpdate=!1,i.orderBtnDisable=!0,s.editRowRecord=null,i.packageServicesArrayObejct=[],s.selectedPreServices=[],s.cancelSerIndex=[],i.PA={},i.PA={fromDate:new Date,PAUnitDays:1},i.showErrors=!1,i.showPlanError=!1,i.visitDls={},i.Mlc={},i.visitDlsDoc={},i.payerDetails={};var a={url:"HISServices/HISServices"};a.requestData={operation:"getVisitInfoEncounter",messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",visitNo:e}},P.sendRestRequest(a).then(function(a){try{var o=a.data.HITService.message;if(i.docSeqId=o.napierDocument.docSeqId,void 0!==o.enNo){"HSC"==sessionStorage.productCustomization&&(i.agent.hscAgent={},i.agent.hscAgent=_.find(i.agentName,{REFERRAL_AGENT_SEQ_ID:o.refAgentSeqId})),i.getPayerDetail(o.registraiion.rgSeqId,o.enSeqId),i.updateVisitFlag=!0,t&&(i.activeFirst=1),sessionStorage.getItem("pharmacyOPVM")&&(i.activeFirst=2,sessionStorage.removeItem("pharmacyOPVM")),i.saveCont=!1,i.updateCont=!0,i.addNewVisitFlag=!0,i.addNewEpisodeFlag=!0,i.visitDetails=!0,i.visitEdit=!0,i.patientBannerCollapsed=!1,i.noVisitRecords=!1,$("#no-result-found_visit").hide(),i.visitNumber=o.visitNo,i.clsvisitBtn,i.defaultVisit=!1,i.dynmVisit=!0,i.dynamicVisitNum=o.visitNo,i.mlcDetailsId=o.mlcDetailsVo.mlcDetailsId,$(".ng-patient-banner").attr("class","ng-patient-banner ng-scope"),i.patientBannerVisible=!0;var n={};i.payerDetails={},n.regSeqId=o.registraiion.rgSeqId,sessionStorage.setItem("episodeRegSeqid",o.registraiion.rgSeqId),i.opVisitCountApplicableFlag&&i.getVisitCount(),s.encounterSeqId=o.enSeqId,i.PatientDetailsData=o,i.epSqNo=o.enSeqId,sessionStorage.setItem("orderdoctSeqId",o.doctorMaster.doctSeqId),sessionStorage.setItem("orderregSeqId",o.registraiion.rgSeqId),sessionStorage.setItem("orderencounterSeqId",o.enSeqId),sessionStorage.setItem("orderEncounterNo",o.enNo),sessionStorage.setItem("ordervisitId",e),"HSC"==sessionStorage.productCustomization&&o.visitLocation&&(i.admittingLocationData=o.visitLocation),t?(i.getPrescptionCount(),i.getAccountByEnID()):(s.patientGlobalDtlsNew=[],s.patientGlobalDtls={},g.getPatientBanner(n,"2").then(function(e){e.visitNO&&i.visitNumber&&(e.visitNO=i.visitNumber),s.patientGlobalDtlsNew.push(e),s.patientGlobalDtls=s.patientGlobalDtlsNew[0],e.typeOfReg&&(i.regTypeData={RG_SEQ_ID:o.registraiion.rgSeqId,RG_INT_MR_NO:e.mrNo,RG_TYPE:e.typeOfReg,isDischargeIntimated:e.isDischargeIntimated?e.isDischargeIntimated:void 0,encounterType:e.encounterType},s.mrNo&&e.mrNo!=s.mrNo&&(s.mrNo=e.mrNo)),R.patientBannerDetail(n.regSeqId).then(function(e){if(i.upldphotoDoc=e,i.patientBannerDetails=e,e.insurance){var t=e.insurance;(t=t instanceof Array?t:[t])[0].cmpSeqId&&t[0].cmpSeqId.inCompName&&(s.patientGlobalDtlsNew[0].insuranceComp=t[0].cmpSeqId.inCompName),t[0].insurancePlanMaster&&t[0].insurancePlanMaster.inPlanName&&(s.patientGlobalDtlsNew[0].insurancePlan=t[0].insurancePlanMaster.inPlanName),t[0].covrgStrtDate&&t[0].covrgStrtDate.$&&(s.patientGlobalDtlsNew[0].pEffectivedate=t[0].covrgStrtDate.$),t[0].covrgEndDate&&t[0].covrgEndDate.$&&(s.patientGlobalDtlsNew[0].pExpiredate=t[0].covrgEndDate.$),i.noPayer=!0}s.patientGlobalDtlsNew[0].userPermision=12});try{null!==A.entityObj&&void 0!==A.entityObj&&null==s.mrNo&&(s.mrNo=e.mrNo,i.loadBillNumbers(e.mrNo))}catch(e){}i.getPrescptionCount(),i.getAccountByEnID(),i.PatientDetailsDataObj=s.patientGlobalDtlsNew[0],s.patientGlobalDtls=s.patientGlobalDtlsNew[0],i.PatientDetailsDataObj.patientId=i.PatientDetailsDataObj.mrNo,""==s.tariffSeqId&&(s.tariffSeqId=s.patientGlobalDtlsNew[0].tariffSeqId);var t=angular.copy(e.mrNo);Z.searchRegisteredPatientService(t).then(function(e){i.opvisitPatientDetails=angular.copy(e)}),i.getOrderPayerDetails(o.enSeqId,o.registraiion.rgSeqId,o.doctorMaster.doctSeqId),i.getOrderDetails(o.doctorMaster.doctSeqId,o.registraiion.rgSeqId,o.enSeqId,s.tariffSeqId,void 0,l,void 0,o.enSpeciality),r&&i.selectedAppoinmentList&&i.selectedAppoinmentList.length>0&&(i.addRowStatus=!1,H.getAppoinmentConsDetails(i.selectedAppoinmentList,o.registraiion.rgSeqId,o.enSeqId,s.tariffSeqId,l).then(function(e){if(e&&e.length>0){for(let t=0;t<e.length;t++)e[t][0].payerType=i.payerTypeModel.PayerType.PAYER_NAME,e[t][0].payerTypeCode=i.payerTypeModel.PayerType.PINS_SEQ_ID,e[t][0].payerTarrifId=i.payerTypeModel.PayerType.TATRIFF_SEQ_ID?i.payerTypeModel.PayerType.TATRIFF_SEQ_ID:s.tariffSeqId,e[t][0].insurancePlanSeqId=null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,e[t][0].appointReason=i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID;i.RowsArr=i.RowsArr.concat(e),i.orderBtnDisable=!1}i.selectedAppoinmentList=[],i.addRowStatus=!0},function(e){i.addRowStatus=!0}))}));var c=o.payerDetailsVoLst[0]["com.napier.core.service.vo.visitmanagement.PayerDetailsVo"];if(void 0!==c[0])var l=c[0].payPrioritySeqId;else l=c.payPrioritySeqId;if(i.getDoctorNotes(o.episode.epSeqId,o.registraiion.rgSeqId),i.getOrderPayerDetails(o.enSeqId,o.registraiion.rgSeqId,o.doctorMaster.doctSeqId),i.getOrderDetails(o.doctorMaster.doctSeqId,o.registraiion.rgSeqId,o.enSeqId,s.tariffSeqId,void 0,l,void 0,o.enSpeciality),i.getPatientCatg(o.registraiion.rgSeqId),"E"!=o.enIsInternalExternalDoc&&"e"!=o.enIsInternalExternalDoc||(i.hideExternalRef=!0,i.hideInternalRef=!1,i.visitDls.internalorext="E",i.internalorextCkE=!0,i.internalorextCk=!1,i.visitDls.OPVMreferedBy1=o.enPhysicianName),"I"!=o.enIsInternalExternalDoc&&"i"!=o.enIsInternalExternalDoc||(i.hideExternalRef=!1,i.hideInternalRef=!0,i.visitDls.internalorext="I",i.internalorextCk=!0,i.internalorextCkE=!1,i.visitDls.OPVMreferedBy={},i.visitDls.OPVMreferedBy.gQDataCode=o.refDoctorMaster.doctSeqId,i.visitDls.OPVMreferedBy.gQDataName=o.refDoctorMaster.doctName),i.visitDls.epSeqId=o.episode.epSeqId,i.visitDls.OPVMepisodeNo=o.episode.epNo,i.visitDls.OPVMepisodeDescription=o.episode.epDescription,i.visitDls.OPVMvisitType=o.strReasonForVisit,i.visitDlsDoc.OPVMselectDoctor={},i.visitDlsDoc.OPVMselectDoctor.DOCTID=o.doctorMaster.doctSeqId,i.visitDlsDoc.OPVMselectDoctor.DOCTNAME=o.doctorMaster.doctName,i.visitDlsDoc.OPVMselectDoctor.SPECIALITY_CODE=o.enSpeciality,i.visitDlsDoc.OPVMselectDoctor.SPECIALITYDESC=o.speciality,o.doctorMaster.doctSeqId>0&&o.speciality?i.visitDlsDoc.OPVMselectDoctor.DOCTOR_SPECIALITY=o.doctorMaster.doctName+", "+o.speciality:i.visitDlsDoc.OPVMselectDoctor.DOCTOR_SPECIALITY="",""!=o.mlcDetailsVo.mlcTypeId||"0"!=o.mlcDetailsVo.mlcTypeId){if(i.Mlc.OPVMmlcDetails=!0,i.Mlc.OPVMmlcType=o.mlcDetailsVo.mlcTypeId,i.Mlc.OPVMmlcNo=o.mlcDetailsVo.mlcNo,i.Mlc.OPVMaccidentReportNo=o.mlcDetailsVo.accidentReportNo,i.Mlc.OPVMinformedPoliceStation=o.mlcDetailsVo.policeStationName,i.Mlc.OPVMpolicePersonnelName=o.mlcDetailsVo.policeName,i.Mlc.OPCMremark=o.mlcDetailsVo.remarks,o.napierDocument.docName){i.Mlc.docName=o.napierDocument.docName;var p=o.napierDocument.docName;i.dotFormat2=p.split(".")[1];var d=o.napierDocument.uploadDocumnt[0].replace(/ +/g,""),m="data:application/"+i.dotFormat2+";base64,";i.Mlc.docFileLink=m+d}}else i.Mlc={},i.Mlc.OPVMmlcDetails=!1;c?i.payerDetails=c instanceof Array?c:[c]:v.failure("Failed"," "+c.errorMessage),sessionStorage.setItem("episodeRegSeqid",o.registraiion.rgSeqId),i.patientBannerCollapsed=!1,null!=o.napierDocument.uploadDocumnt&&(s.convertedFile=o.napierDocument.uploadDocumnt[0]),"HSC"===sessionStorage.productCustomization&&i.admittingLocationData&&(i.visitDls.admittingLocation=i.admittingLocationData)}else i.noVisitRecords=!0,$("#no-result-found_visit").show(),i.visitDetails=!1,i.patientBannerVisible=!1,i.patientBannerCollapsed=!1}catch(e){}null!==A.entityObj&&void 0!==A.entityObj&&T(function(){i.activeFirst=2},300)},function(e){v.failure("Failed","Visit Search has been failed.",!1,!1,me.time)})},i.registerpatient=function(){sessionStorage.setItem("currentHashTag","OpVisitManagement"),sessionStorage.setItem("napier_active_tab","Front Desk"),sessionStorage.setItem("moduleHref","index.frontDesk.permanentRegistration"),i.$emit("hdr.showAfterDashboard",{message:!0}),L.go("index.frontDesk.permanentRegistration",void 0,{reload:!1})},i.checkPatRegSession=function(){var e=sessionStorage.getItem("permanentRegistrationData");if(null!=e){i.patObjtDetail.push({RGSEQID:parseInt(e)});var t={};i.activeFirst=1,t.regSeqId=e,g.getPatientBanner(t,"2").then(function(e){null!=e.encounterType&&0!=e.encounterType||(e.encounterType=1),s.patientGlobalDtlsNew.push(e),s.patientGlobalDtls=s.patientGlobalDtlsNew[0];var t=angular.copy(e.mrNo);Z.searchRegisteredPatientService(t).then(function(e){i.opvisitPatientDetails=angular.copy(e)})}),i.selectMatch(i.patObjtDetail[0]),sessionStorage.removeItem("permanentRegistrationData"),i.activeFirst&&1==i.activeFirst&&T(function(){i.activeFirst=1},200)}},i.getDoctorNotes=function(t,r){e.defer();i.mlcpreviousVisitNote={};var o={};o="HSC"==i.hscSpecific?{"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"GET_PREVIOUS_VISIT_DETAILS_HSC",idxList:[{"com.napier.core.service.vo.query.Index":[{paramName:"pEpisodeSeqId",value:t},{paramName:"pRegSeqId",value:r},{paramName:"pPracticeId",value:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID}]}]}]}]}:{"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"GET_PREVIOUS_VISIT_DETAILS",idxList:[{"com.napier.core.service.vo.query.Index":[{paramName:"pEpisodeSeqId",value:t},{paramName:"pRegSeqId",value:r},{paramName:"pPracticeId",value:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID}]}]}]}]};var s={};s.url=a.HISCOMBOFILLING.URL,s.requestData={operation:"ExecuteQuery",destination:"QueryService",message:o},P.sendRestRequest(s).then(function(e){var t=e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"],r="",a=[];if(t){void 0!==t.length?r=t:(a.push(t),r=a);for(var o=[],s=0;s<r.length;s++){for(var n=r[s].columnList[0]["com.napier.core.service.vo.query.Column"],c={},l=0;l<n.length;l++){c[n[l].name.split(".")[1]]=n[l].data}o.push(c)}i.prevVisitNotes=o}else i.prevVisitNotes=[]})},i.dateToDuration=function(e,t){if(""==e&&(i.tempPatForm.OPVMaddPatientDetailsAge=""),Math.floor(moment(new Date).diff(moment(e),"years",!0))<=150&&t&&e){(function(e){var t,r,a,o,s="",n=new Date(e.substring(6,10),e.substring(3,5)-1,e.substring(0,2)),c=new Date;if(n>c)return;t=c.getFullYear()-n.getFullYear(),r=c.getMonth()-n.getMonth(),(a=c.getDate()-n.getDate())<0&&(r-=1,a+=31);r<0&&(t-=1,r+=12);o="",t>0&&(o=o+t+"y ");r>0&&(t>0&&(a>0?o=o:0==a&&(o=o)),o=o+r+"m ");a>0&&((t>0||r>0)&&(o=o),o=o+a+"d");s=o,i.tempPatForm.OPVMaddPatientDetailsAge=s})(b("date")(new Date(moment(e)),"dd/MM/yyyy"))}},i.durationToDate=function(e){i.tempPatForm.years=0,i.tempPatForm.mon=0,i.tempPatForm.days=0;var t=e.split("/");if(t[0].indexOf("y")>0){var r,a,o;!(t[0].indexOf("y ")>0)||(r=t[0].split("y ")[0]+"y "),!(t[0].indexOf("y ")[1].split("m ")>0)||(a=t[0].split("y ")[1].split("m ")[0]+"m "),!(t[0].indexOf("y ")[1].split("m ")[1].split("d")>0)||(o=t[0].split("y ")[1].split("m ")[1].split("d")[0]+"d"),i.tempPatForm.new.age=r+a+o}else{var s={};t[0]&&""!==t[0]&&(t[0]>150||isNaN(parseInt(t[0]))||parseInt(t[0])<0||/[a-zA-Z\s\r\n@!#\$\^%&\_*()+=\-\[\]\\\';,\.\/\{\}\|\:<>\?]/.test(t[0])?(i.tempPatForm.age1=!0,i.tempPatForm.new.dob="",i.tempPatForm.years=0,i.tempPatForm.mon=0,i.tempPatForm.days=0,T(function(){bookAppointment.age1=!1},1e3)):(s.years=parseInt(t[0]),i.tempPatForm.years=t[0],i.tempPatForm.age1=!1)),t[1]&&""!==t[1]&&(t[1]>12||isNaN(parseInt(t[1]))||parseInt(t[1])<0||/[a-zA-Z\s\r\n@!#\$\^%&\_*()+=\-\[\]\\\';,\.\/\{\}\|\:<>\?]/.test(t[1])?(i.tempPatForm.age1=!0,i.tempPatForm.new.dob="",i.tempPatForm.years=0,i.tempPatForm.mon=0,i.tempPatForm.days=0,T(function(){i.tempPatForm.age1=!1},1e3)):(s.months=parseInt(t[1]),i.tempPatForm.mon=t[1])),t[2]&&""!==t[2]&&(t[2]>31||isNaN(parseInt(t[2]))||parseInt(t[2])<0||/[a-zA-Z\s\r\n@!#\$\^%&\_*()+=\-\[\]\\\';,\.\/\{\}\|\:<>\?]/.test(t[2])?(i.tempPatForm.age1=!0,i.tempPatForm.new.dob="",i.tempPatForm.years=0,i.tempPatForm.mon=0,i.tempPatForm.days=0,T(function(){i.tempPatForm.age1=!1},1e3)):(s.days=parseInt(t[2]),i.tempPatForm.days=t[2]));var n=moment.duration(s),c=moment();c.subtract(n),i.tempPatForm.new.age=i.tempPatForm.years+"y "+i.tempPatForm.mon+"m "+i.tempPatForm.days+"d",i.tempPatForm.new.dob=new Date(c),i.tempPatForm.agestatus=!1,moment(i.tempPatForm.new.dob).format("DD/MM/YYYY")==moment().format("DD/MM/YYYY")&&(i.tempPatForm.new.dob=null)}},i.openCameraWindow=function(){i.modalInstance=S.open("Capture Photo",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/common/permanent-registration/templates/permanentregistration.capturephoto.html",size:"md",scope:i})};var he=JSON.parse(sessionStorage.getItem("permanentRegistrationSessionStorageData"));sessionStorage.removeItem("permanentRegistrationSessionStorageData"),null!=he&&(i.patObjtDetail.push({RGSEQID:parseInt(he.rgSeqId)}),i.selectedapptment={},i.selectedapptment.opApmntSeqId=he.apptSeqId,i.selectMatch(i.patObjtDetail[0]),i.visitDetails=!0),i.advserviceTypeModel=[],i.addselectresponse={},i.loadServiceTypeCombo=function(){i.serviceTypeorder=[],i.serviceTypeOrderList={1:i.serviceTypeorder};var e=I.executeQueryURLReset();return i.serviceTypeListorder=new Array,I.executeQueryInput("OP_ORDERS_SERVICE_TYPE_QUERY_001",i.serviceTypeListorder,i.serviceTypeOrderList,!0,!0,e,"popUp",i.advSearch).then(function(e){var t=e[1];i.servicetypeComboObj=t})}(),i.loadAccountDetails=function(){i.accountorder=[],i.accountOrderList={1:i.accountorder};var e=I.executeQueryURLReset();if(i.AccountDataListorder=new Array,i.regTypeData&&i.regTypeData.RG_SEQ_ID||sessionStorage.getItem("orderencounterSeqId")){if(sessionStorage.getItem("orderencounterSeqId")){I.prepareParamListWithParam("pEncounterSeqId",sessionStorage.getItem("orderencounterSeqId"),i.AccountDataListorder);var t="OP_BL_M_COMMON_002"}else{I.prepareParamListWithParam("pRegSeqId",i.regTypeData.RG_SEQ_ID,i.AccountDataListorder);t="OPVM_BL_M_COMMON_002"}return I.executeQueryInput(t,i.AccountDataListorder,i.accountOrderList,!0,!0,e,"popUp",i.advSearch).then(function(e){i.accountres=e[1][0],i.accountres&&(sessionStorage.setItem("patcatg",i.accountres.EN_PAT_CATG),sessionStorage.setItem("accountseqId",i.accountres.ACC_SEQ_ID),i.accountres.SUB_ACC_SEQ_ID?sessionStorage.setItem("subaccountseqId",i.accountres.SUB_ACC_SEQ_ID):sessionStorage.removeItem("subaccountseqId"))})}},i.getVisitPayerDetails=function(e){i.serviceDataorder=[],i.AllorderPayerDetails=[],i.singleComboDataForListorder={1:i.serviceDataorder};var t=I.executeQueryURLReset();return i.serviceDataListorder=new Array,I.prepareParamListWithParam("pRegSeqId",e,i.serviceDataListorder),I.executeQueryInput("OPVM_V0013",i.serviceDataListorder,i.singleComboDataForListorder,!0,!0,t,"popUp",i.advSearch).then(function(e){i.AllorderPayerDetails=e[1],i.visitDls.vistPayer=e[1][0],i.payerTypeModel={PayerType:e[1][0]}})},i.getOrderPayerDetails=function(e,t,r){i.serviceDataorder=[],i.AllorderPayerDetails=[],i.singleComboDataForListorder={1:i.serviceDataorder};var a=I.executeQueryURLReset();return i.serviceDataListorder=new Array,I.prepareParamListWithParam("pRegSeqId",t,i.serviceDataListorder),I.prepareParamListWithParam("pEnSeqId",e,i.serviceDataListorder),I.executeQueryInput("NEW_OPVM_V0013",i.serviceDataListorder,i.singleComboDataForListorder,!0,!0,a,"popUp",i.advSearch).then(function(e){i.AllorderPayerDetails=e[1],i.visitDls.vistPayer=e[1][0],i.payerTypeModel={PayerType:e[1][0]}})},i.getOrderDetails=function(e,t,r,a,o,s,n,c,l,p){i.loadAccountDetails(),a&&(i.orderDetails={},i.priorityvis.visitTypeModel="New",H.getOrderDetails(e,t,r,a,o,s,n,c,l,p).then(function(e){var t;32==e.visistType?t="New":33==e.visistType?t="Free Follow Up":37==e.visistType&&(t="Follow Up");var r=1;void 0!==e.quantity&&(r=e.quantity),i.hidepriorityTypeComboRef=!1,i.hidevisitTypeComboRef=!0,i.serviceTypeModel.serviceType=e.serviceTypeCode,i.orderDetails.OPVMorderService=e.servName,i.orderDetails.OPVMselectDoctor=e.requestedByEmpName,i.orderData.serviceTypeCode=e.serviceTypeCode,i.orderData.requestedByEmpSeqID=e.requestedByEmpSeqID,i.orderData.visitTypeCode=e.visistType,i.orderData.rcvSeqId=e.rcvSeqId,i.orderData.inflSeqId=e.inflSeqId,i.orderData.specSeqId=e.specSeqId?e.specSeqId:void 0,i.orderData.proposedShare=e.proposedShare,i.orderData.billedShare=e.billedShare,i.orderData.grpMstCode=e.grpMstCode?e.grpMstCode:void 0,i.orderDetails.visitTypeCode=e.visistType,i.priorityvis.visitTypeModel=t,i.orderDetails.price=e.baseRate,i.orderDetails.quantity=r,i.orderDetails.patamount=e.originalPatientAmount,i.orderDetails.payeramount=e.originalPayerAmount,i.orderDetails.servSeqId=e.servSeqId,i.orderDetails.servName=e.servName,i.orderDetails.servCode=e.servCode,i.orderData.transType=1,i.dummyPyrAutherisation=e.servicePayerAuthorization,i.dummyPice=e.baseRate,i.dummyPatAmount=e.originalPatientAmount,i.dummyPyrAmount=e.originalPayerAmount,i.orderData=e;for(var a=0;a<i.servicetypeComboObj.length;a++)i.servicetypeComboObj[a].CODE&&i.servicetypeComboObj[a].CODE==e.serviceTypeCode&&(i.serviceTypeModel.serviceType=i.servicetypeComboObj[a]);le.opPreAuthGetData(i)}))},i.checkMinMaxForRateEditable=function(){var e=null;if(1==i.orderData.isRateEditable&&i.orderData.fromTariffRate&&"R"==i.orderData.fromTariffRate.trim()){if(null==i.orderData.minValue||null==i.orderData.minValue||""===i.orderData.minValue||"null"==i.orderData.minValue||null==i.orderData.maxValue||null==i.orderData.maxValue||""===i.orderData.maxValue||"null"==i.orderData.maxValue)return v.information("information","Minimum and Maximum Rates Are Not Defined For Rate Editable Service -  "+i.orderDetails.servName),e=!1,i.orderData.docShareData=void 0,e;if(i.orderDetails.price>i.orderData.maxValue)return v.information("information","Service Rate Can't Be More Than Maximum Value For Rate",!1,!1,me.time),e=!1,i.orderDetails.price=i.orderData.originalBaseRate,i.orderData.docShareData=void 0,i.changeRatesBasedonPriceEdit(i.orderDetails.price),e;if(i.orderDetails.price<i.orderData.minValue)return v.information("information","Service Rate Can't Be Less Than Minimun Value For Rate",!1,!1,me.time),e=!1,i.orderDetails.price=i.orderData.originalBaseRate,i.orderData.docShareData=void 0,i.changeRatesBasedonPriceEdit(i.orderDetails.price),e}},i.addOrdersRow=function(e){if(i.showOrderErrors=!0,e.$valid){for(var t=[],r=0;r<i.RowsArr.length;r++)i.RowsArr[r][0].servSeqId==i.orderData.servSeqId&&3!=i.RowsArr[r][0].servicePostingType&&t.push(i.RowsArr[r][0].servName);if(0==t.length){if(i.orderData.baseRate!=i.orderDetails.price)if(0==i.checkMinMaxForRateEditable())return;for(var a=[],o=(i.orderData.servSeqId,0);o<i.RowsArr.length;o++)a.push(i.RowsArr[o][0].servSeqId);var n="",c="";if(void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel&&null!=i.priorityvis.priorityTypeModel?(n=i.priorityvis.priorityTypeModel.DETAIL_DESC,c=i.priorityvis.priorityTypeModel.DT_CODE):(n=i.priorityvis.visitTypeModel,c=i.orderDetails.visitTypeCode),void 0!==i.RowsArr)var l=Number(i.RowsArr.length);else l=0;i.orderData.servicePayerAuthorization&&"N"==i.orderData.servicePayerAuthorization&&"self"!=i.payerTypeModel.PayerType.PAYER_NAME.toLocaleLowerCase()?i.isServiceSelectedCovered=!0:i.isServiceSelectedCovered=!1,i.rows=[{serviceTypeCODE:i.orderData.serviceTypeCode,serviceType:i.serviceTypeModel.serviceType.DESCRIPTION,servCode:i.orderData.servCode,servDesign:i.orderData.servDesign,servName:i.orderData.servName,servSeqId:i.orderData.servSeqId,servicePayerAuthorization:i.orderData.servicePayerAuthorization,visistType:n,requestedByEmpName:i.orderData.requestedByEmpName,requestedByEmpSeqID:i.orderData.requestedByEmpSeqID,requestedByEmpType:i.orderData.requestedByEmpType,payerType:i.payerTypeModel.PayerType.PAYER_NAME,payerTypeCode:i.payerTypeModel.PayerType.PINS_SEQ_ID,payerTarrifId:i.payerTypeModel.PayerType.TATRIFF_SEQ_ID?i.payerTypeModel.PayerType.TATRIFF_SEQ_ID:s.tariffSeqId,insurancePlanSeqId:null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,actualRate:i.orderData.actualRate,quantity:i.orderDetails.quantity,patientAmount:i.orderData.patientAmount,payerAmount:i.orderData.payerAmount,originalPatientAmount:i.orderData.originalPatientAmount,originalPayerAmount:i.orderData.originalPayerAmount,discountAmt:i.orderData.discountAmt,doctorAmount:i.orderData.doctorAmount,doctorShare:i.orderData.doctorShare,doctorSurcharge:i.orderData.doctorSurcharge,doctorModifiedAmount:i.orderData.doctorModifiedAmount,hospitalShare:i.orderData.hospitalShare,hospitalSurcharge:i.orderData.hospitalSurcharge,isRateEditable:i.orderData.isRateEditable,minValue:i.orderData.minValue,maxValue:i.orderData.maxValue,fromTariffRate:i.orderData.fromTariffRate,newRate:i.orderData.newRate,proposedShareAfterDiscount:i.orderData.proposedShareAfterDiscount,serviceRate:i.orderData.serviceRate,serviceRateStatus:i.orderData.serviceRateStatus,standardDoctorShare:i.orderData.standardDoctorShare,technicianAmount:i.orderData.technicianAmount,baseRate:i.orderData.baseRate,gnFlow:i.orderData.gnFlow,facilityId:i.orderData.facilityId,billStatus:0,gnServDesign:i.orderData.gnServDesign,payerCompSeqId:i.orderData.payerCompSeqId,payerCompPlanseqId:i.orderData.payerCompPlanseqId,appointReason:i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID,visitTypeCode:c,rowIndex:l,transType:i.orderData.transType,proposedShare:i.orderData.proposedShare,billedShare:i.orderData.billedShare,grpMstCode:i.orderData.grpMstCode?i.orderData.grpMstCode:void 0,deptCode:i.orderData.deptCode,specilityCode:i.orderData.specilityCode,priServTypCode:i.orderData.priServTypCode,isPostBillApplicable:i.orderData.isPostBillApplicable?scope.orderData.isPostBillApplicable:0}],i.RowsArr.unshift(i.rows),i.counter++;i.orderData.requestedByEmpName,sessionStorage.getItem("orderregSeqId"),sessionStorage.getItem("orderencounterSeqId");i.orderDetails.OPVMorderService="",i.orderDetails.price="",i.orderDetails.quantity=1,i.orderDetails.patamount="",i.orderDetails.payeramount="",i.priorityvis.priorityTypeModel="",i.priorityvis.visitTypeModel="",i.serviceTypeModel.serviceType="",2==i.orderData.gnServDesign&&i.showpackageServices(i.rows,i.rows.length-1),i.orderData.isRateEditable=2,T(function(){i.isServiceSelectedCovered=!1},2e3),i.showOrderErrors=!1,i.orderBtnDisable=!1,i.checkOrderSaved=!0}else{var p={buttonCallBack1:function(){if(i.orderData.baseRate!=i.orderDetails.price&&0==i.checkMinMaxForRateEditable())return;for(var e=[],t=(i.orderData.servSeqId,0);t<i.RowsArr.length;t++)e.push(i.RowsArr[t][0].servSeqId);var r="",a="";if(void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel&&null!=i.priorityvis.priorityTypeModel?(r=i.priorityvis.priorityTypeModel.DETAIL_DESC,a=i.priorityvis.priorityTypeModel.DT_CODE):(r=i.priorityvis.visitTypeModel,a=i.orderDetails.visitTypeCode),void 0!==i.RowsArr)var o=Number(i.RowsArr.length);else o=0;i.orderData.servicePayerAuthorization&&"N"==i.orderData.servicePayerAuthorization&&"self"!=i.payerTypeModel.PayerType.PAYER_NAME.toLocaleLowerCase()?i.isServiceSelectedCovered=!0:i.isServiceSelectedCovered=!1,i.rows=[{serviceTypeCODE:i.orderData.serviceTypeCode,serviceType:i.serviceTypeModel.serviceType.DESCRIPTION,servCode:i.orderData.servCode,servDesign:i.orderData.servDesign,servName:i.orderData.servName,servSeqId:i.orderData.servSeqId,servicePayerAuthorization:i.orderData.servicePayerAuthorization,visistType:r,requestedByEmpName:i.orderData.requestedByEmpName,requestedByEmpSeqID:i.orderData.requestedByEmpSeqID,requestedByEmpType:i.orderData.requestedByEmpType,payerType:i.payerTypeModel.PayerType.PAYER_NAME,payerTypeCode:i.payerTypeModel.PayerType.PINS_SEQ_ID,payerTarrifId:i.payerTypeModel.PayerType.TATRIFF_SEQ_ID?i.payerTypeModel.PayerType.TATRIFF_SEQ_ID:s.tariffSeqId,insurancePlanSeqId:null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,actualRate:i.orderData.actualRate,quantity:i.orderDetails.quantity,patientAmount:i.orderData.patientAmount,payerAmount:i.orderData.payerAmount,originalPatientAmount:i.orderData.originalPatientAmount,originalPayerAmount:i.orderData.originalPayerAmount,discountAmt:i.orderData.discountAmt,doctorAmount:i.orderData.doctorAmount,doctorShare:i.orderData.doctorShare,doctorModifiedAmount:i.orderData.doctorModifiedAmount,doctorSurcharge:i.orderData.doctorSurcharge,hospitalShare:i.orderData.hospitalShare,hospitalSurcharge:i.orderData.hospitalSurcharge,isRateEditable:i.orderData.isRateEditable,minValue:i.orderData.minValue,maxValue:i.orderData.maxValue,fromTariffRate:i.orderData.fromTariffRate,newRate:i.orderData.newRate,proposedShareAfterDiscount:i.orderData.proposedShareAfterDiscount,serviceRate:i.orderData.serviceRate,serviceRateStatus:i.orderData.serviceRateStatus,standardDoctorShare:i.orderData.standardDoctorShare,technicianAmount:i.orderData.technicianAmount,baseRate:i.orderData.baseRate,gnFlow:i.orderData.gnFlow,facilityId:i.orderData.facilityId,billStatus:0,gnServDesign:i.orderData.gnServDesign,payerCompSeqId:i.orderData.payerCompSeqId,payerCompPlanseqId:i.orderData.payerCompPlanseqId,appointReason:i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID,visitTypeCode:a,rowIndex:o,transType:i.orderData.transType,proposedShare:i.orderData.proposedShare,billedShare:i.orderData.billedShare,grpMstCode:i.orderData.grpMstCode?i.orderData.grpMstCode:void 0,deptCode:i.orderData.deptCode,specilityCode:i.orderData.specilityCode,priServTypCode:i.orderData.priServTypCode,isPostBillApplicable:i.orderData.isPostBillApplicable?scope.orderData.isPostBillApplicable:0}],i.RowsArr.unshift(i.rows),i.counter++;i.orderData.requestedByEmpName,sessionStorage.getItem("orderregSeqId"),sessionStorage.getItem("orderencounterSeqId");i.orderDetails.OPVMorderService="",i.orderDetails.price="",i.orderDetails.quantity=1,i.orderDetails.patamount="",i.orderDetails.payeramount="",i.priorityvis.priorityTypeModel="",i.priorityvis.visitTypeModel="",i.serviceTypeModel.serviceType="",2==i.orderData.gnServDesign&&i.showpackageServices(i.rows,i.rows.length-1),i.orderData.isRateEditable=2,T(function(){i.isServiceSelectedCovered=!1},2e3),i.showOrderErrors=!1,i.orderBtnDisable=!1,i.checkOrderSaved=!0},buttonCallBack2:function(){}};v.hisAlertMulti("warning","Confirmation","Service Already added.Do you really want to add the service ?",{buttonText:"YES",buttonText2:"NO"},p,close)}}},i.serviceTypeChange=function(e){if(!i.serviceTypeModel.serviceType){i.orderDetails.OPVMorderService="",i.orderDetails.price="",i.orderDetails.quantity=1,i.orderDetails.patamount="",i.orderDetails.payeramount="",i.priorityvis.priorityTypeModel="",i.priorityvis.visitTypeModel="",i.PriorityCombo=[],i.PriorityComboList={1:i.PriorityCombo};t=I.executeQueryURLReset();return i.priorityCombosList=new Array,I.prepareParamList(1,850,i.priorityCombosList),I.executeQueryInput("TRN003",i.priorityCombosList,i.PriorityComboList,!0,!0,t,"popUp",{}).then(function(e){i.PriorityComboList=e[1],i.priorityvis.priorityTypeModel=i.PriorityComboList[0],i.hidepriorityTypeComboRef=!0,i.hidevisitTypeComboRef=!1})}if(i.advserviceType=i.serviceTypeModel.serviceType,i.orderDetails.OPVMorderService="",i.orderDetails.price="",i.orderDetails.quantity=1,i.orderDetails.patamount="",i.orderDetails.payeramount="",i.loadAccountDetails(),1!=i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID){i.PriorityCombo=[],i.PriorityComboList={1:i.PriorityCombo};var t=I.executeQueryURLReset();return i.priorityCombosList=new Array,I.prepareParamList(1,850,i.priorityCombosList),I.executeQueryInput("TRN003",i.priorityCombosList,i.PriorityComboList,!0,!0,t,"popUp",{}).then(function(e){i.PriorityComboList=e[1],i.priorityvis.priorityTypeModel=i.PriorityComboList[0],i.hidepriorityTypeComboRef=!0,i.hidevisitTypeComboRef=!1})}sessionStorage.getItem("orderdoctSeqId"),sessionStorage.getItem("orderregSeqId");i.payerId,i.priorityvis.priorityTypeModel="",i.hidepriorityTypeComboRef=!1,i.hidevisitTypeComboRef=!0,i.priorityvis.visitTypeModel="New"},i.activeTab=function(e){return(i.patientGlobalDtlsNew[0].visitNO||i.dynamicVisitNum)&&i.patientGlobalDtlsNew[0]||2!=e&&3!=e&&4!=e?i.isEmgOrTempPat&&5==e?(v.warning("Warning!","Patient has a Emergency registration, please convert into Permanent registration to proceed.",!1,!1,me.time),!1):(i.activeFirst=e,i.showOrderErrors=!1,5==e&&(le.opPreAuthClear(i),i.getAllPayerDetail(s.patientSeqId),i.getPatAllPayers(s.patientSeqId),i.reqFromOrder=!1,i.PA={},i.PA={fromDate:new Date,PAUnitDays:1},s.orderRowData=null),void(i.preAuthBillNav=!1)):(v.warning("Warning!","Please create or select a visit to proceed.",!1,!1,me.time),!1)},i.collectPayment=function(){$("#patientOutstandingModal").modal("hide"),i.activeFirst=3},i.openFileUpload=function(e){angular.element(document.querySelector("#"+e)).click()},i.saveUploadedFile=function(){if(s.convertedFile&&s.fileobj){var e=s.fileobj.name.split("."),t=s.convertedFile.split(",")[1],r=JSON.parse(sessionStorage.userContextObj),a=b("date")(new Date,"yyyy-MM-dd'T'HH:mm:ss'.000Z'");ae.uploadFileFun(s.fileobj,e[1],r,a,t,"",1).then(function(e){if(e.data.HITService.message.napierDocumentList[0]["com.napier.core.service.vo.uploadfile.NapierDocument"]){var t=e.data.HITService.message.napierDocumentList[0]["com.napier.core.service.vo.uploadfile.NapierDocument"];v.success("Success","Document added successfully",!1,!1,me.time),i.uplodedDocDetails={name:t.docName,docSeqId:t.docSeqId}}else v.warning("Warning","Failed to add Documnet",!1,!1,me.time)})}},i.captureUploadedImage=function(e,t){s.fileobj=e.files[0];var r=e.files[0],a=r.name.split("."),o=a[a.length-1],n=r.size;if(["jpg","JPG","png","PNG","jpeg","JPEG"].indexOf(o)>=0){if(n>i.allowedFileSize)return void v.warning("Warning!","File size can not be more than 5MB",!1,!1,me.time);angular.element(document.querySelector("#"+t))[0].defaultValue=s.fileobj.name,angular.element(document.querySelector("#"+t))[0].value=s.fileobj.name;var c=new FileReader;c.readAsDataURL(r),c.onload=function(){c.result&&(s.convertedFile=c.result,i.saveUploadedFile())}}else v.warning("Warning","The Document Type Isn't Supported",!1,!1,me.time)},i.OrderselectMatchDoctor=function(e,t,r,a,o){var s={};s.docID=e.DOCTID,s.DOCTNAME=e.DOCTNAME,s.SPECIALITY_CODE=e.SPECIALITY_CODE?e.SPECIALITY_CODE:void 0,i.orderData.requestedByEmpName=e.DOCTNAME,i.orderData.requestedByEmpSeqID=e.DOCTID,i.orderData.SPECIALITY_CODE=e.SPECIALITY_CODE?e.SPECIALITY_CODE:void 0,i.OrderDoctorChange(o,s)},i.OrderDoctorChange=function(e,t){var r=t.docID,a=t.SPECIALITY_CODE,o=sessionStorage.getItem("orderregSeqId"),n=sessionStorage.getItem("orderencounterSeqId");i.setCurrentTarrifId();var c=s.tariffSeqId,l=i.payerTypeModel.PayerType.PINS_SEQ_ID,p=i.orderData.quantity,d="";d=void 0!==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID?i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID:i.orderData.appointReason;var m="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,m=i.priorityvis.priorityTypeModel.DT_CODE):(i.priorityvis.visitTypeModel,m=i.orderDetails.visitTypeCode);var u=m;if(1!=d){i.addSelectServicepostEditArr=[];var S=new Date,y=moment(S).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";N.updateService.URL;var D=1;3==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID&&(D=2);var g=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.orderData.servSeqId,gnServDesign:D,servCode:i.orderData.servCode,servName:i.orderData.servName,secServTypeCode:i.orderData.servSeqId,priServTypCode:i.orderData.servSeqId},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.orderData.servSeqId,tariffSeqId:s.tariffSeqId,datedOn:y,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:i.orderData.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:JSON.parse(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:r,payerId:i.payerTypeModel.PayerType.PINS_SEQ_ID,fromOPVisit:"Y",priority:u}];i.addSelectServicepostEditArr.push(g);var A={};A.url=N.updateService.URL,A.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectServicepostEditArr}]}},P.sendRestRequest(A).then(function(e){i.addselectEdiresponse=e.data.HITService.message,""==i.addselectEdiresponse.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time);var t=i.addselectEdiresponse.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];i.orderData.serviceTypeCODE=t.primaryServiceCode,i.orderData.serviceType=t.primaryServiceCode,i.orderData.servCode=t.serviceVo.servCode,i.orderData.servName=t.serviceVo.servName,i.orderData.servSeqId=t.serviceVo.servSeqId,i.orderData.gnServDesign=t.serviceVo.gnServDesign,i.orderData.servicePayerAuthorization=t.servicePayerAuthorization,i.orderData.requestedByEmpName=t.requestedByEmpName,i.orderData.requestedByEmpSeqID=t.requestedByEmpSeqID,i.orderData.requestedByEmpType=t.requestedByEmpType,i.orderData.payerType=i.payerTypeModel.PayerType.PAYER_NAME,i.orderData.payerTypeCode=i.payerTypeModel.PayerType.PINS_SEQ_ID,i.orderData.insurancePlanSeqId=null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,i.orderData.actualRate=t.actualRate,i.orderData.quantity=t.quantity,i.orderData.isPostBillApplicable=t.isPostBillApplicable?t.isPostBillApplicable:0,i.orderData.patientAmount=t.patientAmount,i.orderData.payerAmount=t.payerAmount,i.orderData.originalPatientAmount=t.originalPatientAmount,i.orderData.originalPayerAmount=t.originalPayerAmount,i.orderData.discountAmt=t.discountAmt,i.orderData.doctorAmount=t.doctorAmount,i.orderData.doctorShare=t.doctorShare,i.orderData.doctorSurcharge=t.doctorSurcharge,i.orderData.hospitalShare=t.hospitalShare,i.orderData.hospitalSurcharge=t.hospitalSurcharge,i.orderData.isRateEditable=t.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,1==i.orderData.isRateEditable&&(i.orderData.minValue=null!=t.minVal?t.minVal:t.serviceVo.scmMasterServBillingAttrVo.minValue,i.orderData.maxValue=null!=t.maxVal?t.maxVal:t.serviceVo.scmMasterServBillingAttrVo.maxValue,i.orderData.fromTariffRate="R"),i.orderData.newRate=t.newRate,i.orderData.proposedShareAfterDiscount=t.proposedShareAfterDiscount,i.orderData.serviceRate=t.serviceRate,i.orderData.serviceRateStatus=t.serviceRateStatus,i.orderData.standardDoctorShare=t.standardDoctorShare,i.orderData.technicianAmount=t.technicianAmount,i.orderData.baseRate=t.serviceRateVo.baseRate,i.orderData.originalBaseRate=t.serviceRateVo.originalBaseRate?t.serviceRateVo.originalBaseRate:t.serviceRateVo.baseRate,i.orderData.gnFlow=t.gnFlow,i.orderData.facilityId=t.facilityId,i.orderData.billStatus=0,i.orderData.rcvSeqId=t.serviceRateVo.rcvSeqId,i.orderData.inflSeqId=t.serviceRateVo.inflSeqId,i.orderData.proposedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,i.orderData.billedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,i.orderData.grpMstCode=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,i.orderData.priServTypCode=t.secServiceCode,null!=t.serviceVo&&null!=t.serviceVo.atomicDetailsVo&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&(null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&(i.orderData.deptCode=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code),null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&(i.orderData.specilityCode=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code))})}else i.getOrderDetails(r,o,n,c,e,l,p,a)},i.AdvServiceselectRec=function(e){i.AdvServiceaddSelected(e)},i.setCurrentTarrifId=function(){i.payerTypeModel.PayerType&&(s.tariffSeqId=i.payerTypeModel.PayerType.TATRIFF_SEQ_ID?i.payerTypeModel.PayerType.TATRIFF_SEQ_ID:s.tariffSeqId)},i.visitPayerChange=function(e){i.payerTypeModel.PayerType=e,i.OrderPayerChange("Payer",i.payerTypeModel)},i.OrderPayerChange=function(e,t){var r=i.orderData.requestedByEmpSeqID,a=sessionStorage.getItem("orderregSeqId"),o=sessionStorage.getItem("orderencounterSeqId");i.setCurrentTarrifId();var n=s.tariffSeqId,c=t.PayerType.PINS_SEQ_ID,l=i.orderDetails.quantity,p="";p=void 0!==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID?i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID:i.orderData.appointReason;var d="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,d=i.priorityvis.priorityTypeModel.DT_CODE):(i.priorityvis.visitTypeModel,d=i.orderDetails.visitTypeCode);var m=d;if(1!=p){i.addSelectServicepostEditArr=[];var u=new Date,S=moment(u).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";N.updateService.URL;var y=1;3==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID&&(y=2);var D=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId")?sessionStorage.getItem("accountseqId"):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0,patientMRNo:!sessionStorage.getItem("subaccountseqId")&&i.regTypeData&&i.regTypeData.RG_INT_MR_NO?i.regTypeData.RG_INT_MR_NO:void 0,patientId:!sessionStorage.getItem("subaccountseqId")&&i.regTypeData&&i.regTypeData.RG_SEQ_ID?i.regTypeData.RG_SEQ_ID:void 0,servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.orderDetails.servSeqId,gnServDesign:y,servCode:i.orderDetails.servCode,servName:i.orderDetails.servName,secServTypeCode:i.orderDetails.servSeqId,priServTypCode:i.orderDetails.servSeqId},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.orderDetails.servSeqId,tariffSeqId:n,datedOn:S,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:i.orderDetails.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:r,payerId:c,fromOPVisit:"Y",priority:m,actualRate:i.orderDetails.price,serviceRate:i.orderDetails.price}];i.addSelectServicepostEditArr.push(D);var g={};g.url=N.updateService.URL,g.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId")?sessionStorage.getItem("accountseqId"):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectServicepostEditArr}]}},P.sendRestRequest(g).then(function(e){i.addselectEdiresponse=e.data.HITService.message,""==i.addselectEdiresponse.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time);var t=i.addselectEdiresponse.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];i.orderData.serviceTypeCODE=t.primaryServiceCode,i.orderData.serviceType=t.primaryServiceCode,i.orderData.servCode=t.serviceVo.servCode,i.orderData.servName=t.serviceVo.servName,i.orderData.servSeqId=t.serviceVo.servSeqId,i.orderData.gnServDesign=t.serviceVo.gnServDesign,i.orderData.servicePayerAuthorization=t.servicePayerAuthorization,i.orderData.requestedByEmpName=t.requestedByEmpName,i.orderData.requestedByEmpSeqID=t.requestedByEmpSeqID,i.orderData.requestedByEmpType=t.requestedByEmpType,i.orderData.payerType=i.payerTypeModel.PayerType.PAYER_NAME,i.orderData.payerTypeCode=i.payerTypeModel.PayerType.PINS_SEQ_ID,i.orderData.insurancePlanSeqId=null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,i.orderData.actualRate=i.orderData.isComingFromOPPharmacy?i.orderData.actualRate:t.actualRate,i.orderData.quantity=1,i.orderData.isPostBillApplicable=t.isPostBillApplicable?t.isPostBillApplicable:0,i.orderData.patientAmount=i.orderData.isComingFromOPPharmacy?i.orderData.patientAmount:t.patientAmount,i.orderData.payerAmount=i.orderData.isComingFromOPPharmacy?i.orderData.payerAmount:t.payerAmount,i.orderData.originalPatientAmount=i.orderData.isComingFromOPPharmacy?"Y"==t.servicePayerAuthorization?parseFloat(0):parseFloat(i.orderData.originalPatientAmount)>0&&parseFloat(i.orderData.originalPayerAmount)>0?i.orderData.originalPatientAmount:i.orderDetails.price:t.originalPatientAmount,i.orderData.originalPayerAmount=i.orderData.isComingFromOPPharmacy?"Y"==t.servicePayerAuthorization?parseFloat(i.orderData.originalPatientAmount)>0&&parseFloat(i.orderData.originalPayerAmount)>0?i.orderData.originalPayerAmount:i.orderDetails.price:parseFloat(0):t.originalPayerAmount,i.orderData.discountAmt=i.orderData.isComingFromOPPharmacy?i.orderData.discountAmt:t.discountAmt,i.orderData.doctorAmount=t.doctorAmount,i.orderData.doctorShare=t.doctorShare,i.orderData.doctorSurcharge=t.doctorSurcharge,i.orderData.hospitalShare=t.hospitalShare,i.orderData.hospitalSurcharge=t.hospitalSurcharge,i.orderData.isRateEditable=i.orderData.isComingFromOPPharmacy?3:t.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,1==i.orderData.isRateEditable&&(i.orderData.minValue=t.serviceVo.scmMasterServBillingAttrVo.minValue,i.orderData.maxValue=t.serviceVo.scmMasterServBillingAttrVo.maxValue,i.orderData.fromTariffRate="R"),i.orderData.newRate=i.orderData.isComingFromOPPharmacy?i.orderData.newRate:t.newRate,i.orderData.proposedShareAfterDiscount=t.proposedShareAfterDiscount,i.orderData.serviceRate=i.orderData.isComingFromOPPharmacy?i.orderData.serviceRate:t.serviceRate,i.orderData.serviceRateStatus=t.serviceRateStatus,i.orderData.standardDoctorShare=t.standardDoctorShare,i.orderData.technicianAmount=t.technicianAmount,i.orderData.baseRate=i.orderData.isComingFromOPPharmacy?i.orderData.baseRate:t.serviceRateVo.baseRate,i.orderData.originalBaseRate=i.orderData.isComingFromOPPharmacy?i.orderData.originalBaseRate:t.serviceRateVo.originalBaseRate,i.orderData.gnFlow=t.gnFlow,i.orderData.facilityId=t.facilityId,i.orderData.billStatus=0,i.orderData.payerCompSeqId=t.payerCompSeqId,i.orderData.payerCompPlanseqId=t.payerCompPlanseqId,i.orderDetails.price=i.orderData.isComingFromOPPharmacy?i.orderDetails.price:t.serviceRate,i.dummyPice=(i.orderData.isComingFromOPPharmacy?i.orderDetails.price:t.serviceRate)/i.orderDetails.quantity,i.dummyPatAmount=t.originalPatientAmount/i.orderDetails.quantity,i.dummyPyrAmount=t.originalPayerAmount/i.orderDetails.quantity,i.orderDetails.patamount=i.orderData.isComingFromOPPharmacy?"Y"==t.servicePayerAuthorization?parseFloat(0):i.orderDetails.price:t.originalPatientAmount,i.orderDetails.payeramount=i.orderData.isComingFromOPPharmacy?"Y"==t.servicePayerAuthorization?i.orderDetails.price:parseFloat(0):t.originalPayerAmount,i.dummyPyrAutherisation=t.servicePayerAuthorization,i.orderDetails.servCode=t.serviceVo.servCode,i.orderDetails.servName=t.serviceVo.servName,i.orderDetails.servSeqId=t.serviceVo.servSeqId,i.orderData.rcvSeqId=t.serviceRateVo.rcvSeqId,i.orderData.inflSeqId=t.serviceRateVo.inflSeqId,null!=t.multiEmployeeShareList&&""!==t.multiEmployeeShareList&&null!=t.multiEmployeeShareList.employeeShareList&&null!=t.multiEmployeeShareList.employeeShareList[0]&&(i.orderData.proposedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,i.orderData.billedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,i.orderData.grpMstCode=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0),i.orderData.priServTypCode=t.secServiceCode,null!=t.serviceVo&&null!=t.serviceVo.atomicDetailsVo&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&(null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&(i.orderData.deptCode=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code),null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&(i.orderData.specilityCode=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code))})}else{var A;i.orderData.specSeqId&&i.orderData.specSeqId&&(A=i.orderData.specSeqId),i.getOrderDetails(r,a,o,n,e,c,l,A,i.orderData.servSeqId,i.orderData.servicePostingSeqId)}},i.orderService=function(e){S.open("SEARCH SERVICE",{animation:!0,templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-order-service-popup.html",size:e,scope:i});i.AdvserviceGrid.data=[],i.advserviceTypeModel.serviceType=i.serviceTypeModel.serviceType,null!=i.advserviceTypeModel.serviceType&&null!=i.advserviceTypeModel.serviceType.CODE&&i.loadSecondaryServiceTypeCombo()},i.AdvserviceGrid.onRegisterApi=function(e){i.AdvserviceGridSearch=e},i.AdvServiceaddSelected=function(e,t){var r=new Date,a=moment(r).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";(C={}).url=N.updateService.URL;var o="";o=void 0!==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID?i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID:i.orderData.appointReason,i.advServiceGridselection=i.AdvserviceGridSearch.selection.getSelectedRows();var n="",c="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(n=i.priorityvis.priorityTypeModel.DETAIL_DESC,c=i.priorityvis.priorityTypeModel.DT_CODE):(n=i.priorityvis.visitTypeModel,c=i.orderDetails.visitTypeCode);var l=c;if(1!=o){var p=1;if(3==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID&&(p=2),i.addSelectServicepostArr=[],i.addSelectServicepostEditArr=[],i.setCurrentTarrifId(),"Service"==e){i.advServiceGridselection=i.AdvserviceGridSearch.selection.getSelectedRows();var d=0;if(!i.addRowStatus){d=1;var m=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId")?sessionStorage.getItem("accountseqId"):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0,servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.advServiceGridselection[0].SERV_SEQ_ID,gnServDesign:p,servCode:i.advServiceGridselection[0].SERV_CODE,servName:i.advServiceGridselection[0].SERV_NAME,secServTypeCode:i.advServiceGridselection[0].SSTCODE,priServTypCode:i.advServiceGridselection[0].CODE},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.advServiceGridselection[0].SERV_SEQ_ID,tariffSeqId:s.tariffSeqId,datedOn:a,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:i.orderDetails.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:i.visitDlsDoc.OPVMselectDoctor.DOCTID,payerId:i.payerTypeModel.PayerType.PINS_SEQ_ID,fromOPVisit:"Y",priority:l}];i.addSelectServicepostEditArr.push(m);var u={};u.url=N.updateService.URL,u.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId")?sessionStorage.getItem("accountseqId"):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectServicepostEditArr}]}},P.sendRestRequest(u).then(function(e){i.addselectEdiresponse=e.data.HITService.message,""==i.addselectEdiresponse.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time);var t=i.addselectEdiresponse.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];De=[];var r="",a="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(r=i.priorityvis.priorityTypeModel.DETAIL_DESC,a=i.priorityvis.priorityTypeModel.DT_CODE):(r=i.priorityvis.visitTypeModel,a=i.orderDetails.visitTypeCode);for(var o=[],n=(t.serviceVo.servSeqId,0);n<i.RowsArr.length;n++)o.push(i.RowsArr[n][0].servSeqId);s.editRowRecord[0].serviceTypeCODE=t.primaryServiceCode,s.editRowRecord[0].serviceType=t.primaryService,s.editRowRecord[0].servCode=t.serviceVo.servCode,s.editRowRecord[0].servName=t.serviceVo.servName,s.editRowRecord[0].servSeqId=t.serviceVo.servSeqId,s.editRowRecord[0].gnServDesign=t.serviceVo.gnServDesign,s.editRowRecord[0].servicePayerAuthorization=t.servicePayerAuthorization,s.editRowRecord[0].visistType=r,s.editRowRecord[0].visitTypeCode=a,s.editRowRecord[0].requestedByEmpName=t.requestedByEmpName,s.editRowRecord[0].requestedByEmpSeqID=t.requestedByEmpSeqID,s.editRowRecord[0].requestedByEmpType=t.requestedByEmpType,s.editRowRecord[0].payerType=i.payerTypeModel.PayerType.PAYER_NAME,s.editRowRecord[0].payerTypeCode=i.payerTypeModel.PayerType.PINS_SEQ_ID,s.editRowRecord[0].insurancePlanSeqId=null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,s.editRowRecord[0].actualRate=t.actualRate,s.editRowRecord[0].quantity=1,s.editRowRecord[0].isPostBillApplicable=t.isPostBillApplicable?t.isPostBillApplicable:0,s.editRowRecord[0].patientAmount=t.patientAmount,s.editRowRecord[0].payerAmount=t.payerAmount,s.editRowRecord[0].originalPatientAmount=t.originalPatientAmount,s.editRowRecord[0].originalPayerAmount=t.originalPayerAmount,s.editRowRecord[0].discountAmt=t.discountAmt,s.editRowRecord[0].doctorAmount=t.doctorAmount,s.editRowRecord[0].doctorShare=t.doctorShare,s.editRowRecord[0].doctorSurcharge=t.doctorSurcharge,s.editRowRecord[0].hospitalShare=t.hospitalShare,s.editRowRecord[0].hospitalSurcharge=t.hospitalSurcharge,s.editRowRecord[0].isRateEditable=t.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,1==s.editRowRecord[0].isRateEditable&&(s.editRowRecord[0].minValue=t.minVal?t.minVal:t.serviceRateVo.minValue,s.editRowRecord[0].maxValue=t.maxVal?t.maxVal:t.serviceRateVo.maxValue,s.editRowRecord[0].fromTariffRate="R"),s.editRowRecord[0].newRate=t.newRate,s.editRowRecord[0].proposedShareAfterDiscount=t.proposedShareAfterDiscount,s.editRowRecord[0].serviceRate=t.serviceRate,s.editRowRecord[0].serviceRateStatus=t.serviceRateStatus,s.editRowRecord[0].standardDoctorShare=t.standardDoctorShare,s.editRowRecord[0].technicianAmount=t.technicianAmount,s.editRowRecord[0].baseRate=t.baseRate,s.editRowRecord[0].gnFlow=t.gnFlow,s.editRowRecord[0].facilityId=t.facilityId,s.editRowRecord[0].payerCompSeqId=t.payerCompSeqId,s.editRowRecord[0].payerCompPlanseqId=t.payerCompPlanseqId,s.editRowRecord[0].appointReason=i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID,s.editRowRecord[0].rcvSeqId=t.serviceRateVo.rcvSeqId,s.editRowRecord[0].inflSeqId=t.serviceRateVo.inflSeqId,s.editRowRecord[0].proposedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,s.editRowRecord[0].billedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,s.editRowRecord[0].grpMstCode=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,s.editRowRecord[0].priServTypCode=t.secServiceCode,null!=t.serviceVo&&null!=t.serviceVo.atomicDetailsVo&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&(null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&(s.editRowRecord[0].deptCode=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code),null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&(s.editRowRecord[0].specilityCode=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code)),i.serviceTypeModel.serviceType="",i.orderDetails.OPVMorderService="",i.orderDetails.price="",i.orderDetails.quantity=1,i.orderDetails.patamount="",i.orderDetails.payeramount="",i.orderDetails.OPVMselectDoctor="",i.addRowStatus=!0})}for(var S=d;S<i.advServiceGridselection.length;S++){var y=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId")?sessionStorage.getItem("accountseqId"):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0,servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.advServiceGridselection[S].SERV_SEQ_ID,gnServDesign:p,servCode:i.advServiceGridselection[S].SERV_CODE,servName:i.advServiceGridselection[S].SERV_NAME,secServTypeCode:i.advServiceGridselection[S].SSTCODE,priServTypCode:i.advServiceGridselection[S].CODE},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.advServiceGridselection[S].SERV_SEQ_ID,tariffSeqId:s.tariffSeqId,datedOn:a,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:i.orderDetails.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:i.visitDlsDoc.OPVMselectDoctor.DOCTID,payerId:i.payerTypeModel.PayerType.PINS_SEQ_ID,fromOPVisit:"Y",priority:l}];i.addSelectServicepostArr.push(y)}}else if("Doctor"==e){y=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId")?sessionStorage.getItem("accountseqId"):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0,servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.tableRowData[0].serviceSeqId,gnServDesign:p,servCode:i.tableRowData[0].serviceCode,servName:i.tableRowData[0].serviceName,secServTypeCode:i.tableRowData[0].secServTypeCode,priServTypCode:i.tableRowData[0].serviceTypeCODE},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.tableRowData[0].serviceSeqId,tariffSeqId:s.tariffSeqId,datedOn:a,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:i.orderDetails.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:t.docID,payerId:i.payerTypeModel.PayerType.PINS_SEQ_ID,fromOPVisit:"Y",priority:l}];i.addSelectServicepostArr.push(y)}else{y=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId")?sessionStorage.getItem("accountseqId"):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0,servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.tableRowData[0].serviceSeqId,gnServDesign:p,servCode:i.tableRowData[0].serviceCode,servName:i.tableRowData[0].serviceName,secServTypeCode:i.tableRowData[0].secServTypeCode,priServTypCode:i.tableRowData[0].serviceTypeCODE},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.tableRowData[0].serviceSeqId,tariffSeqId:s.tariffSeqId,datedOn:a,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:i.orderDetails.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:i.visitDlsDoc.OPVMselectDoctor.DOCTID,payerId:t.PayerType.PINS_SEQ_ID,fromOPVisit:"Y",priority:l}];i.addSelectServicepostArr.push(y)}C.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId")?sessionStorage.getItem("accountseqId"):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectServicepostArr}]}},P.sendRestRequest(C).then(function(e){i.addselectresponse=e.data.HITService.message;var t=i.addselectresponse.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];i.addRowStatus&&""==i.addselectresponse.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time),De=[];var r="",a="";if(void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(r=i.priorityvis.priorityTypeModel.DETAIL_DESC,a=i.priorityvis.priorityTypeModel.DT_CODE):(r=i.priorityvis.visitTypeModel,a=i.orderDetails.visitTypeCode),(t=t instanceof Array?t:[t]).length>0&&t[0].serviceVo)for(var o=0;o<t.length;o++){if(t[o].serviceVo.servSeqId,i.RowsArr.length>0)for(var s=0;s<i.RowsArr.length;s++)De.push(i.RowsArr[s][0].servSeqId);let e=!1;for(let r=0;r<i.RowsArr.length;r++)if(i.RowsArr[r][0].servSeqId==t[o].serviceVo.servSeqId&&3!=i.RowsArr[r][0].servicePostingType){e=t[o].serviceVo.servName;break}let l=[{serviceTypeCODE:t[o].primaryServiceCode,serviceType:t[o].primaryService,servCode:t[o].serviceVo.servCode,servName:t[o].serviceVo.servName,servSeqId:t[o].serviceVo.servSeqId,gnServDesign:t[o].serviceVo.gnServDesign,servicePayerAuthorization:t[o].servicePayerAuthorization,visistType:r,visitTypeCode:a,requestedByEmpName:t[o].requestedByEmpName,requestedByEmpSeqID:t[o].requestedByEmpSeqID,requestedByEmpType:t[o].requestedByEmpType,payerType:i.payerTypeModel.PayerType.PAYER_NAME,insurancePlanSeqId:null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,payerTypeCode:i.payerTypeModel.PayerType.PINS_SEQ_ID,actualRate:t[o].actualRate,quantity:1,isPostBillApplicable:t[o].isPostBillApplicable?t[o].isPostBillApplicable:0,patientAmount:t[o].patientAmount,payerAmount:t[o].payerAmount,originalPatientAmount:t[o].originalPatientAmount,originalPayerAmount:t[o].originalPayerAmount,discountAmt:t[o].discountAmt,doctorAmount:t[o].doctorAmount,doctorShare:t[o].doctorShare,doctorSurcharge:t[o].doctorSurcharge,hospitalShare:t[o].hospitalShare,hospitalSurcharge:t[o].hospitalSurcharge,isRateEditable:t[o].serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,minValue:t[o].minVal?t[o].minVal:t[o].serviceRateVo.minValue,maxValue:t[o].maxVal?t[o].maxVal:t[o].serviceRateVo.maxValue,fromTariffRate:"R",newRate:t[o].newRate,proposedShareAfterDiscount:t[o].proposedShareAfterDiscount,serviceRate:t[o].serviceRate,serviceRateStatus:t[o].serviceRateStatus,standardDoctorShare:t[o].standardDoctorShare,technicianAmount:t[o].technicianAmount,baseRate:t[o].baseRate,gnFlow:t.gnFlow,facilityId:t[o].facilityId,billStatus:0,payerCompSeqId:t[o].payerCompSeqId,payerCompPlanseqId:t[o].payerCompPlanseqId,appointReason:i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID,rcvSeqId:t[o].serviceRateVo.rcvSeqId,inflSeqId:t[o].serviceRateVo.inflSeqId,transType:1,proposedShare:t[o].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,billedShare:t[o].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,grpMstCode:t[o].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?t[o].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,priServTypCode:t.secServiceCode,deptCode:null!=t.serviceVo&&null!=t.serviceVo.atomicDetailsVo&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code?t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code:void 0,specilityCode:null!=t.serviceVo&&null!=t.serviceVo.atomicDetailsVo&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code?t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code:void 0}];if(e){var n=e+" service already added.Do you really want to add the service ?",c={buttonCallBack1:function(){i.RowsArr.unshift(l),i.orderBtnDisable=!1,i.counter++},buttonCallBack2:function(){}};v.hisAlertMulti("warning","Confirmation",n,{buttonText:"YES",buttonText2:"NO"},c,close)}else i.RowsArr.unshift(l),i.orderBtnDisable=!1,i.counter++}$.grep(i.RowsArr,function(e){return"N"==e[0].servicePayerAuthorization&&"self"!=e[0].payerType.toLocaleLowerCase()}).length>0?i.isServiceSelectedCovered=!0:i.isServiceSelectedCovered=!1,T(function(){i.isServiceSelectedCovered=!1},2e3)}),i.orderDetails.OPVMorderService="",i.orderDetails.price="",i.orderDetails.quantity=1,i.orderDetails.patamount="",i.orderDetails.payeramount=""}else{var D=i.orderData.requestedByEmpSeqID;if(i.visitDlsDoc&&i.visitDlsDoc.OPVMselectDoctor){D||(D=i.visitDlsDoc.OPVMselectDoctor.DOCTID);var g=i.visitDlsDoc.OPVMselectDoctor.SPECIALITY_CODE}var A=sessionStorage.getItem("orderregSeqId"),I=sessionStorage.getItem("orderencounterSeqId"),h=s.tariffSeqId,R=i.payerTypeModel.PayerType.PINS_SEQ_ID,f=i.orderDetails.quantity;n="",c="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(n=i.priorityvis.priorityTypeModel.DETAIL_DESC,c=i.priorityvis.priorityTypeModel.DT_CODE):(n=i.priorityvis.visitTypeModel,c=i.orderDetails.visitTypeCode);for(S=0;S<i.advServiceGridselection.length;S++){var C,b={"@class":"com.napier.core.service.vo.visitmanagement.VisitConfigurationDetails",doctorSeqId:D,tariffSeqId:h,regSeqId:A||void 0,enSeqId:I||void 0,payerId:R,quantity:f,serviceSeqId:i.advServiceGridselection[S].SERV_SEQ_ID,specialityCode:g||void 0};(C={}).url=N.updateService.URL,C.requestData={operation:"getConsultationServiceRate",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:b},P.sendRestRequest(C).then(function(e){i.serResponce=e.data.HITService.message,""==i.serResponce.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time);var t=i.serResponce.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];i.addRowStatus?(i.rows=[{serviceTypeCODE:t.primaryServiceCode,serviceType:t.primaryService,servCode:t.serviceVo.servCode,servName:t.serviceVo.servName,servSeqId:t.serviceVo.servSeqId,gnServDesign:1,servicePayerAuthorization:t.servicePayerAuthorization,visistType:n,visitTypeCode:c,requestedByEmpName:t.requestedByEmpName,requestedByEmpSeqID:t.requestedByEmpSeqID,requestedByEmpType:t.requestedByEmpType,payerType:i.payerTypeModel.PayerType.PAYER_NAME,payerTypeCode:i.payerTypeModel.PayerType.PINS_SEQ_ID,insurancePlanSeqId:null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,actualRate:t.actualRate,quantity:i.orderDetails.quantity,isPostBillApplicable:t.isPostBillApplicable?t.isPostBillApplicable:0,patientAmount:t.patientAmount,payerAmount:t.payerAmount,originalPatientAmount:t.originalPatientAmount,originalPayerAmount:t.originalPayerAmount,discountAmt:t.discountAmt,doctorAmount:t.doctorAmount,doctorShare:t.doctorShare,doctorSurcharge:t.doctorSurcharge,hospitalShare:t.hospitalShare,hospitalSurcharge:t.hospitalSurcharge,isRateEditable:t.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,minValue:t.minVal?t.minVal:t.serviceRateVo.minValue,maxValue:t.maxVal?t.maxVal:t.serviceRateVo.maxValue,fromTariffRate:"R",newRate:t.newRate,proposedShareAfterDiscount:t.proposedShareAfterDiscount,serviceRate:t.serviceRate,serviceRateStatus:t.serviceRateStatus,standardDoctorShare:t.standardDoctorShare,technicianAmount:t.technicianAmount,baseRate:t.baseRate,gnFlow:t.gnFlow,facilityId:t.facilityId,billStatus:0,payerCompSeqId:t.payerCompSeqId,payerCompPlanseqId:t.payerCompPlanseqId,appointReason:i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID,rcvSeqId:t.serviceRateVo.rcvSeqId,inflSeqId:t.serviceRateVo.inflSeqId,transType:1,proposedShare:t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,billedShare:t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,grpMstCode:t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,priServTypCode:t.serviceVo.secServTypeCode,deptCode:null!=t.serviceVo&&null!=t.serviceVo.atomicDetailsVo&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code?t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code:void 0,specilityCode:null!=t.serviceVo&&null!=t.serviceVo.atomicDetailsVo&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code?t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code:void 0}],i.RowsArr.unshift(i.rows),i.orderBtnDisable=!1):(s.editRowRecord[0].serviceTypeCODE=t.primaryServiceCode,s.editRowRecord[0].serviceType=t.primaryService,s.editRowRecord[0].servCode=t.serviceVo.servCode,s.editRowRecord[0].servName=t.serviceVo.servName,s.editRowRecord[0].servSeqId=t.serviceVo.servSeqId,s.editRowRecord[0].gnServDesign=1,s.editRowRecord[0].servicePayerAuthorization=t.servicePayerAuthorization,s.editRowRecord[0].visistType=n,s.editRowRecord[0].visitTypeCode=c,s.editRowRecord[0].requestedByEmpName=t.requestedByEmpName,s.editRowRecord[0].requestedByEmpSeqID=t.requestedByEmpSeqID,s.editRowRecord[0].requestedByEmpType=t.requestedByEmpType,s.editRowRecord[0].payerType=i.payerTypeModel.PayerType.PAYER_NAME,s.editRowRecord[0].payerTypeCode=i.payerTypeModel.PayerType.PINS_SEQ_ID,s.editRowRecord[0].insurancePlanSeqId=null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,s.editRowRecord[0].actualRate=t.actualRate,s.editRowRecord[0].quantity=i.orderDetails.quantity,s.editRowRecord[0].isPostBillApplicable=t.isPostBillApplicable?t.isPostBillApplicable:0,s.editRowRecord[0].patientAmount=t.patientAmount,s.editRowRecord[0].payerAmount=t.payerAmount,s.editRowRecord[0].originalPatientAmount=t.originalPatientAmount,s.editRowRecord[0].originalPayerAmount=t.originalPayerAmount,s.editRowRecord[0].discountAmt=t.discountAmt,s.editRowRecord[0].doctorAmount=t.doctorAmount,s.editRowRecord[0].doctorShare=t.doctorShare,s.editRowRecord[0].doctorSurcharge=t.doctorSurcharge,s.editRowRecord[0].hospitalShare=t.hospitalShare,s.editRowRecord[0].hospitalSurcharge=t.hospitalSurcharge,s.editRowRecord[0].isRateEditable=t.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,1==s.editRowRecord[0].isRateEditable&&(s.editRowRecord[0].minValue=t.serviceRateVo.minValue,s.editRowRecord[0].maxValue=t.serviceRateVo.maxValue,s.editRowRecord[0].fromTariffRate="R"),s.editRowRecord[0].newRate=t.newRate,s.editRowRecord[0].proposedShareAfterDiscount=t.proposedShareAfterDiscount,s.editRowRecord[0].serviceRate=t.serviceRate,s.editRowRecord[0].serviceRateStatus=t.serviceRateStatus,s.editRowRecord[0].standardDoctorShare=t.standardDoctorShare,s.editRowRecord[0].technicianAmount=t.technicianAmount,s.editRowRecord[0].baseRate=t.baseRate,s.editRowRecord[0].gnFlow=t.gnFlow,s.editRowRecord[0].facilityId=t.facilityId,s.editRowRecord[0].payerCompSeqId=t.payerCompSeqId,s.editRowRecord[0].payerCompPlanseqId=t.payerCompPlanseqId,s.editRowRecord[0].appointReason=i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID,s.editRowRecord[0].rcvSeqId=t.serviceRateVo.rcvSeqId,s.editRowRecord[0].inflSeqId=t.serviceRateVo.inflSeqId,s.editRowRecord[0].proposedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,s.editRowRecord[0].billedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,s.editRowRecord[0].grpMstCode=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0),i.serviceTypeModel.serviceType="",i.orderDetails.OPVMorderService="",i.orderDetails.price="",i.orderDetails.quantity=1,i.orderDetails.patamount="",i.orderDetails.payeramount="","HSC"===sessionStorage.productCustomization&&(i.checkOrderSaved=!0),le.opPreAuthGetData(i)})}}E.dismissAll()},i.editOrderRecords=function(e,t,r){var a={},o={},n={},c={};i.orderrowIndex=e,i.payerTypeModel.PayerType="";for(var l=0;l<i.RowsArr.length;l++)l==e&&(i.tableRowData=i.RowsArr[e]);var p={};p.url=N.updateService.URL,p.requestData={operation:"checkOrderCancel",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.master.vo.ServiceListVo",serviceList:[{"com.napier.core.scm.master.vo.ServiceVo":[{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:r[0].servicePostingSeqId,servDesc:r[0].servName,gnServDesign:null!=i.tableRowData[0].appointReason?i.tableRowData[0].appointReason:2}]}]}},P.sendRestRequest(p).then(function(e){if(""==e.data.HITService.message.serviceList[0]||r[0].isComingFromOPPharmacy){if(a.CODE=i.tableRowData[0].serviceTypeCODE,a.DESCRIPTION=i.tableRowData[0].serviceType,o.DT_CODE=i.tableRowData[0].addvisitCode,o.DETAIL_DESC=i.tableRowData[0].visistType,n.PINS_SEQ_ID=i.tableRowData[0].payerTypeCode,n.PAYER_NAME=i.tableRowData[0].payerType,n.TATRIFF_SEQ_ID=i.tableRowData[0].payerTarrifId?i.tableRowData[0].payerTarrifId:void 0,n.PLAN_SEQ_ID=i.tableRowData[0].insurancePlanSeqId,c.DOCTNAME=i.tableRowData[0].requestedByEmpName,c.DOCTID=i.tableRowData[0].requestedByEmpSeqID,i.OPVMDoctorSearchTypeAhead(c.DOCTNAME,!1,!0),i.serviceTypeModel.serviceType=a,i.orderDetails.OPVMorderService=i.tableRowData[0].servName,i.payerTypeModel={PayerType:n},i.orderData.doctorAmount=i.tableRowData[0].doctorAmount,i.orderData.doctorShare=i.tableRowData[0].doctorShare,i.orderData.doctorSurcharge=i.tableRowData[0].doctorSurcharge,i.orderData.hospitalShare=i.tableRowData[0].hospitalShare,i.orderData.hospitalSurcharge=i.tableRowData[0].hospitalSurcharge,i.orderData.transType=i.tableRowData[0].transType,i.orderDetails.price=i.tableRowData[0].serviceRate,i.orderDetails.isPharmacyService=i.tableRowData[0].isPharmacyService,i.dummyPice=i.tableRowData[0].serviceRate,i.dummyPatAmount=i.tableRowData[0].originalPatientAmount,i.dummyPyrAmount=i.tableRowData[0].originalPayerAmount,i.orderDetails.quantity=i.tableRowData[0].quantity,i.orderDetails.patamount=i.tableRowData[0].originalPatientAmount,i.orderDetails.payeramount=i.tableRowData[0].originalPayerAmount,i.dummyPyrAutherisation=i.tableRowData[0].servicePayerAuthorization,i.orderDetails.servCode=i.tableRowData[0].servCode,i.orderDetails.servName=i.tableRowData[0].servName,i.orderDetails.servSeqId=i.tableRowData[0].servSeqId,i.orderData.servCode=i.tableRowData[0].servCode,i.orderData.servName=i.tableRowData[0].servName,i.orderData.servSeqId=i.tableRowData[0].servSeqId,i.orderData.patientAmount=i.tableRowData[0].originalPatientAmount,i.orderData.payerAmount=i.tableRowData[0].originalPayerAmount,i.orderData.originalPatientAmount=i.tableRowData[0].originalPatientAmount,i.orderData.originalPayerAmount=i.tableRowData[0].originalPayerAmount,i.orderData.serviceRate=i.tableRowData[0].serviceRate,i.orderData.baseRate=i.tableRowData[0].baseRate,i.orderData.actualRate=i.tableRowData[0].actualRate,i.orderData.discountAmt=i.tableRowData[0].discountAmt,i.orderData.doctorAmount=i.tableRowData[0].doctorAmount,i.orderData.doctorShare=i.tableRowData[0].doctorShare,i.orderData.appointReason=i.tableRowData[0].appointReason,i.orderData.gnServDesign=i.tableRowData[0].gnServDesign,i.orderData.servicePostingSeqId=i.tableRowData[0].servicePostingSeqId?i.tableRowData[0].servicePostingSeqId:void 0,i.addRowStatus=!1,s.editRowRecord=r,i.orderData.isRateEditable=r[0].isComingFromOPPharmacy?3:i.tableRowData[0].isRateEditable,i.orderData.isComingFromOPPharmacy=r[0].isComingFromOPPharmacy,1==i.tableRowData[0].isRateEditable&&(i.orderData.minValue=i.tableRowData[0].minValue,i.orderData.maxValue=i.tableRowData[0].maxValue,i.orderData.fromTariffRate=i.tableRowData[0].fromTariffRate),1!=i.tableRowData[0].appointReason){i.hidepriorityTypeComboRef=!0,i.hidevisitTypeComboRef=!1,i.PriorityCombo=[],i.PriorityComboList={1:i.PriorityCombo};var t=I.executeQueryURLReset();return i.priorityCombosList=new Array,I.prepareParamList(1,850,i.priorityCombosList),I.executeQueryInput("TRN003",i.priorityCombosList,i.PriorityComboList,!0,!0,t,"popUp",{}).then(function(e){i.PriorityComboList=e[1];for(var t=0;t<i.PriorityComboList.length;t++)i.PriorityComboList[t].DT_CODE==i.tableRowData[0].visitTypeCode&&(i.priorityvis.priorityTypeModel=i.PriorityComboList[t])})}i.hidepriorityTypeComboRef=!1,i.hidevisitTypeComboRef=!0,i.priorityvis.visitTypeModel=i.tableRowData[0].visistType}else v.warning("Warning!","We Can't Edit this Service",!1,!1,me.time)})},i.getMinAndMaxRates=function(e,t,r){i.rateData=[],i.rateDataList={1:i.rateData};var a="SERVICE="+r,o=I.executeQueryURLReset();return i.rateDataDetails=new Array,I.prepareParamListWithParam("pTariffCode",t,i.rateDataDetails),I.prepareParamListWithParam("pServSeqId",e,i.rateDataDetails),I.prepareParamListWithParam("pRuleWithDesc",a,i.rateDataDetails),I.executeQueryInput("MMACODE_INFL_RATES",i.rateDataDetails,i.rateDataList,!0,!0,o,"popUp",i.advSearch).then(function(e){var t=e[1];t[0]&&(i.orderData.minValue=t[0].MIN_VALUE,i.orderData.maxValue=t[0].MAX_VALUE)})},i.setReceivedFrom=function(e){switch(e){case 1:i.paym.Amt=i.gbcal.patientPendAmnt,i.paym.ReceiveFrom="Self",i.calRoundOffs();break;case 2:i.paym.Amt=i.gbcal.payerPendAmnt,i.paym.ReceiveFrom=i.payerDetails[0].payerName,i.calRoundOffs();break;case 3:i.gbBillNo&&"Unbilled"==i.gbBillNo.billno?i.paym.Amt=i.gbcal.patientPendAmnt:i.paym.Amt="",i.paym.ReceiveFrom="Self";break;default:i.paym.Amt="",i.paym.ReceiveFrom="Self"}},i.addRowStatus=!0,i.packageServicesArrayObejct=[],s.selectedPreServices=[],i.pSevDocList=[],i.pSevDocComboList={1:i.pSevDocList};var Re=I.executeQueryURLReset();i.refpSevDocList=new Array,I.prepareParamListWithParam("pSpecializationId","",i.refpSevDocList),I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.refpSevDocList),I.prepareParamListWithParam("pDoctorId","",i.refpSevDocList),I.prepareParamListWithParam("pDoctorName","",i.refpSevDocList),I.executeQueryInput("OP_DOCTOR_ADVANCE_SEARCH",i.refpSevDocList,i.pSevDocComboList,!0,!0,Re,"popUp"),i.changeRatesBasedonPriceEdit=function(e,t){var r=new Date,a=moment(r).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";N.updateService.URL;var o=1;3==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID&&(o=2);var n="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,n=i.priorityvis.priorityTypeModel.DT_CODE):(i.priorityvis.visitTypeModel,n=i.orderDetails.visitTypeCode);var c=n;i.setCurrentTarrifId(),i.addSelectServiceTypeArr=[];var l=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId")?sessionStorage.getItem("accountseqId"):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0,patientMRNo:!sessionStorage.getItem("subaccountseqId")&&i.regTypeData&&i.regTypeData.RG_INT_MR_NO?i.regTypeData.RG_INT_MR_NO:void 0,patientId:!sessionStorage.getItem("subaccountseqId")&&i.regTypeData&&i.regTypeData.RG_SEQ_ID?i.regTypeData.RG_SEQ_ID:void 0,servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.orderDetails.servSeqId,gnServDesign:o,servCode:i.orderDetails.servCode,servName:i.orderDetails.servName,secServTypeCode:i.orderDetails.servSeqId,priServTypCode:i.orderDetails.servSeqId},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.orderDetails.servSeqId,tariffSeqId:s.tariffSeqId,datedOn:a,fromOPVisit:"Y",doctSeqId:i.orderData.requestedByEmpSeqID,specSeqId:i.orderData.SPECIALITY_CODE?i.orderData.SPECIALITY_CODE:i.visitDlsDoc.OPVMselectDoctor.SPECIALITY_CODE},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:i.orderData.transType,quantity:i.orderDetails.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,isRateEditable:1,newRate:e,doctorModifiedAmount:2==i.orderData.transType?i.orderData.doctorModifiedAmount:0,updateServicePostingFlag:!1,requestedByEmpType:4,requestedByEmpSeqID:i.visitDlsDoc.OPVMselectDoctor.DOCTID,payerId:i.payerTypeModel.PayerType.PINS_SEQ_ID,fromOPVisit:"Y",priority:c}];i.addSelectServiceTypeArr.push(l);var p={};p.url=N.updateService.URL,p.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId")?sessionStorage.getItem("accountseqId"):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectServiceTypeArr}]}},P.sendRestRequest(p).then(function(e){i.isPriceEditResponce=e.data.HITService.message;var r=i.isPriceEditResponce.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];i.orderDetails.price=r.serviceRateVo.baseRate,null!=i.orderDetails.payeramount&&i.orderDetails.payeramount>0&&(i.orderDetails.price>i.orderDetails.payeramount?(r.originalPatientAmount=parseFloat(i.orderDetails.price)-i.orderDetails.payeramount,r.originalPayerAmount=i.orderDetails.payeramount):(r.originalPatientAmount=0,r.originalPayerAmount=parseFloat(i.orderDetails.price))),i.orderDetails.patamount=r.originalPatientAmount,i.orderDetails.payeramount=r.originalPayerAmount,i.dummyPice=r.serviceRateVo.baseRate,i.dummyPatAmount=r.originalPatientAmount,i.dummyPyrAmount=r.originalPayerAmount,i.orderData.newRate=r.newRate,i.orderData.patientAmount=r.patientAmount,i.orderData.payerAmount=r.payerAmount,i.orderData.originalPatientAmount=r.originalPatientAmount,i.orderData.originalPayerAmount=r.originalPayerAmount,i.orderData.serviceRate=r.serviceRate,i.orderData.rcvSeqId=r.serviceRateVo.rcvSeqId,i.orderData.inflSeqId=r.serviceRateVo.inflSeqId,t||(i.orderData.proposedShare=r.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,i.orderData.billedShare=r.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,i.orderData.hospitalShare=r.hospitalShare),i.orderData.grpMstCode=r.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?r.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,i.orderData.isPostBillApplicable=r.isPostBillApplicable,i.orderData.discountAmt=r.discountAmt,i.orderData.doctorAmount=r.doctorAmount,i.orderData.doctorShare=r.doctorShare,i.orderData.doctorSurcharge=r.doctorSurcharge,i.orderData.hospitalSurcharge=r.hospitalSurcharge,i.orderData.minValue=r.minVal,i.orderData.maxValue=r.maxVal,i.orderData.isRateEditable=r.isRateEditable,i.orderData.fromTariffRate="R",i.orderData.actualRate=r.actualRate,i.orderData.baseRate=r.baseRate,i.orderData.priServTypCode=r.secServiceCode,null!=r.serviceVo&&null!=r.serviceVo.atomicDetailsVo&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&(null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&(i.orderData.deptCode=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code),null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&(i.orderData.specilityCode=r.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code))})},i.checkAllRows=function(e){for(var t=0;t<i.RowsArr.length;t++)1==e?1!=i.RowsArr[t][0].billStatus&&(i.RowsArr[t][0].isComingFromOPPharmacy||3==i.RowsArr[t][0].servicePostingType||(i.RowsArr[t][0].checkrowforCancel=!0,i.cancelButtonEna=1)):(i.RowsArr[t][0].checkrowforCancel=!1,i.cancelButtonEna=2)},s.cancelSerIndex=[],i.cancelRecords=function(e,t){if("Pharmacy Retruns"!=e.isPharmacyService){i.cancelButtonEna=0;for(var r=0;r<i.RowsArr.length;r++)1==i.RowsArr[r][0].checkrowforCancel&&(i.cancelButtonEna=1)}else e.checkrowforCancel=!1},i.confirmCancelOrder=function(e,t){var r={};r.url=N.updateService.URL,r.requestData={operation:"cancelServicePosting",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":e}]}},P.sendRestRequest(r).then(function(e){if(s.cancelSerIndex=null,i.cancelButtonEna=0,i.loadBillNumbers(s.mrNo),"Y"==i.integrationApplicableFlag){var t=e.data.HITService.message.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"],r="";if(Array.isArray(t))for(var a=0;a<t.length;a++)r=0==a?t[a].servicePostingSeqId:r+","+t[a].servicePostingSeqId;else r=t.servicePostingSeqId;Array.isArray(t)||(t[0]=t);var o=sessionStorage.getItem("orderregSeqId");re.prepareOrderObject(r,t,o,"Admission","sendOrderFinalizedReportForRis","com.napier.his.integration.service.external.RisService",re).then(function(e){})}});for(var a=0,o=0;o<i.RowsArr.length;o++)if(1==i.RowsArr[o][0].checkrowforCancel)if(i.RowsArr[o][0].servicePostingSeqId)i.RowsArr[o][0].servicePostingType=3,i.RowsArr[o][0].servicePostingCacelReason=t,i.RowsArr[o][0].checkrowforCancel=!1,1!=i.RowsArr[o][0].billStatus&&(a=1);else{i.RowsArr.splice(o,1);o=-1}for(var n=0;n<i.RowsArr.length;n++)1!=i.RowsArr[n][0].billStatus&&(a=1);i.orderBtnDisable=0==a,i.showOrderCanLoadingIcon=!1},i.cancelMultipleOrder=function(e){for(var t=0,r=0;r<i.RowsArr.length;r++)1==i.RowsArr[r][0].checkrowforCancel&&(t=1);if(1==t){var a="Do you really want to delete the service ?",o={buttonText:"YES",buttonText2:"NO"},s={buttonCallBack1:function(e){i.showOrderCanLoadingIcon=!0;for(var t=[],r=[],a=0;a<i.RowsArr.length;a++)""!=i.RowsArr[a][0].servicePostingSeqId&&1==i.RowsArr[a][0].checkrowforCancel&&(t.push({"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",servicePostingSeqId:i.RowsArr[a][0].servicePostingSeqId,encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},servicePostingCacelReason:i.projSpecApplicable?e:"",cancelRequestedBy:i.projSpecApplicable?JSON.parse(sessionStorage.userContextObj).USER_SEQ_ID:void 0}),r.push({"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.RowsArr[a][0].servicePostingSeqId,servDesc:i.RowsArr[a][0].servName,gnServDesign:null!=i.RowsArr[a][0].appointReason?i.RowsArr[a][0].appointReason:2}));var o={};o.url=N.updateService.URL,o.requestData={operation:"checkOrderCancel",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.master.vo.ServiceListVo",serviceList:[{"com.napier.core.scm.master.vo.ServiceVo":r}]}},P.sendRestRequest(o).then(function(r){if(""==r.data.HITService.message.serviceList[0])i.confirmCancelOrder(t,e);else{var a=r.data.HITService.message.serviceList[0]["com.napier.core.scm.master.vo.ServiceVo"],o=[],s="";void 0!==a.length?s=a:(o.push(a),s=o);for(var n="",c=0;c<s.length;c++)n=s[c].servDesc+","+n;v.warning("Warning!","We Can't Delete the Following Services "+n),i.showOrderCanLoadingIcon=!1}})},buttonCallBack2:function(){}};1==i.projSpecApplicable?v.captureInfromation("capture","Confirmation",a,o,s,close):v.hisAlertMulti("warning","Confirmation",a,o,s,close)}},i.getPrescptionCount=function(){var e={};e.url=N.updateService.URL,e.requestData={operation:"getTotalOPPrescriptionList",messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.OPPrescriptionVo",regSeqId:sessionStorage.getItem("orderregSeqId"),enSeqId:sessionStorage.getItem("orderencounterSeqId")}},P.sendRestRequest(e).then(function(e){i.prescriptionCount=e.data.HITService.message,i.checkVisitUnOrderdServices()})},i.prescriptionCount=0,i.priarityChangeType=function(e,t,r,a,o){if(i.serviceTypeModel.serviceType=e,1!=i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID){i.PriorityCombo=[],i.PriorityComboList={1:i.PriorityCombo};var s=I.executeQueryURLReset();return i.priorityCombosList=new Array,I.prepareParamList(1,850,i.priorityCombosList),I.executeQueryInput("TRN003",i.priorityCombosList,i.PriorityComboList,!0,!0,s,"popUp",{}).then(function(s){i.PriorityComboList=s[1],i.priorityvis.priorityTypeModel=i.PriorityComboList[0],i.hidepriorityTypeComboRef=!0,i.hidevisitTypeComboRef=!1,i.loadRatesForService(e,t,r,a,o)})}sessionStorage.getItem("orderdoctSeqId"),sessionStorage.getItem("orderregSeqId");i.payerId,i.priorityvis.priorityTypeModel="",i.hidepriorityTypeComboRef=!1,i.hidevisitTypeComboRef=!0,i.priorityvis.visitTypeModel="New",i.loadRatesForService(e,t,r,a,o)},i.selectOrderMatchDoctor=function(e,t,r,a,o){i.serviceTypeModel.serviceType?i.loadRatesForService(e,t,r,a,o):(i.serviceTypeModel.serviceType={CODE:e.CODE,DESCRIPTION:e.DESCRIPTION,NH_OP_REASON_SEQ_ID:e.NH_OP_REASON_SEQ_ID},i.priarityChangeType(e,t,r,a,o))},i.preAuthRcdList=[],i.preAuthHdrRcdList={},i.loadRatesForService=function(e,t,r,a,o){var n=new Date,c=moment(n).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";(f={}).url=N.updateService.URL;var l=1;3==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID&&(l=2),i.addSelectServiceTypeArr=[];var p="";p=void 0!==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID?i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID:i.orderData.appointReason;var d="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,d=i.priorityvis.priorityTypeModel.DT_CODE):(i.priorityvis.visitTypeModel,d=i.orderDetails.visitTypeCode);var m=d;if(i.setCurrentTarrifId(),1!=p){var u=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId")?sessionStorage.getItem("accountseqId"):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0,patientMRNo:!sessionStorage.getItem("subaccountseqId")&&i.regTypeData&&i.regTypeData.RG_INT_MR_NO?i.regTypeData.RG_INT_MR_NO:void 0,patientId:!sessionStorage.getItem("subaccountseqId")&&i.regTypeData&&i.regTypeData.RG_SEQ_ID?i.regTypeData.RG_SEQ_ID:void 0,servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:e.SERV_SEQ_ID,gnServDesign:l,servCode:e.SERV_CODE,servName:e.SERV_NAME,secServTypeCode:e.CODE,priServTypCode:e.CODE},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:e.SERV_SEQ_ID,tariffSeqId:s.tariffSeqId,datedOn:c,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},isEmergency:2,transType:1,quantity:i.orderDetails.quantity?i.orderDetails.quantity:1,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:i.visitDlsDoc.OPVMselectDoctor.DOCTID,payerId:i.payerTypeModel.PayerType.PINS_SEQ_ID,fromOPVisit:"Y",priority:m}];i.addSelectServiceTypeArr.push(u);var S={};S.url=N.updateService.URL,S.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId")?sessionStorage.getItem("accountseqId"):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectServiceTypeArr}]}},P.sendRestRequest(S).then(function(t){i.addselectTyperesponse=t.data.HITService.message,""==i.addselectTyperesponse.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time);var r,a=i.addselectTyperesponse.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel&&null!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DT_CODE,r=i.priorityvis.priorityTypeModel.DETAIL_DESC):r=i.priorityvis.visitTypeModel;for(var o=[],s=(e.SERV_SEQ_ID,0);s<i.RowsArr.length;s++)o.push(i.RowsArr[s][0].servSeqId);i.orderDetails.OPVMorderService=a.serviceVo.servName,i.orderDetails.OPVMselectDoctor=a.requestedByEmpName,i.priorityvis.visitTypeModel=r,i.orderDetails.price=a.serviceRateVo.baseRate,i.orderDetails.quantity=a.quantity,i.orderDetails.patamount=a.originalPatientAmount,i.orderDetails.payeramount=a.originalPayerAmount,i.dummyPice=a.serviceRateVo.baseRate,i.dummyPatAmount=a.originalPatientAmount,i.dummyPyrAmount=a.originalPayerAmount;var n={accSeqId:a.accSeqId,actualRate:a.actualRate,discountAmt:a.discountAmt,doctorAmount:a.doctorAmount,doctorShare:a.doctorShare,doctorSurcharge:a.doctorSurcharge,facilityId:a.facilityId,gnFlow:a.gnFlow,hospitalShare:a.hospitalShare,hospitalSurcharge:a.hospitalSurcharge,isDeleteBill:a.isDeleteBill,isDepositRequired:a.isDepositRequired,isEmergencyAllowedCheck:a.isEmergencyAllowedCheck,isMLCFlag:a.isMLCFlag,isRateEditable:a.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,minValue:a.minVal?a.minVal:a.serviceRateVo.minValue,maxValue:a.maxVal?a.maxVal:a.serviceRateVo.maxValue,fromTariffRate:"R",newRate:a.newRate,patientAmount:a.patientAmount,payerAmount:a.payerAmount,originalPatientAmount:a.originalPatientAmount,originalPayerAmount:a.originalPayerAmount,servicePayerAuthorization:a.servicePayerAuthorization,practiceId:a.practiceId,proposedShareAfterDiscount:a.proposedShareAfterDiscount,requestedByEmpName:a.requestedByEmpName,requestedByEmpSeqID:a.requestedByEmpSeqID,requestedByEmpType:a.requestedByEmpType,servicePostingType:a.servicePostingType,serviceRate:a.serviceRate,serviceRateStatus:a.serviceRateStatus,serviceType:a.serviceType,standardDoctorShare:a.standardDoctorShare,subAccSeqId:a.subAccSeqId,technicianAmount:a.technicianAmount,transType:a.transType,servCode:a.serviceVo.servCode,servDesign:a.serviceVo.servDesign,servName:a.serviceVo.servName,servSeqId:a.serviceVo.servSeqId,visistType:a.serviceRateVo.visistType,baseRate:a.serviceRateVo.baseRate,originalBaseRate:a.serviceRateVo.originalBaseRate?a.serviceRateVo.originalBaseRate:a.serviceRateVo.baseRate,gnServDesign:a.serviceVo.gnServDesign,payerCompSeqId:a.payerCompSeqId,payerCompPlanseqId:a.payerCompPlanseqId,serviceTypeCode:a.primaryServiceCode,isPostBillApplicable:a.isPostBillApplicable?a.isPostBillApplicable:0};i.orderData=n,i.orderData.servCode=a.serviceVo.servCode,i.orderData.servName=a.serviceVo.servName,i.orderData.servSeqId=a.serviceVo.servSeqId,i.orderDetails.servCode=a.serviceVo.servCode,i.orderDetails.servName=a.serviceVo.servName,i.orderDetails.servSeqId=a.serviceVo.servSeqId,i.orderData.rcvSeqId=a.serviceRateVo.rcvSeqId,i.orderData.inflSeqId=a.serviceRateVo.inflSeqId,i.orderData.proposedShare=a.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,i.orderData.billedShare=a.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,i.orderData.grpMstCode=a.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?a.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,i.orderData.priServTypCode=a.secServiceCode,null!=a.serviceVo&&null!=a.serviceVo.atomicDetailsVo&&null!=a.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=a.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=a.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&(null!=a.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&(i.orderData.deptCode=a.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code),null!=a.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=a.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=a.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&(i.orderData.specilityCode=a.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code))})}else{var y=i.orderData.requestedByEmpSeqID;if(i.visitDlsDoc&&i.visitDlsDoc.OPVMselectDoctor){y||(y=i.visitDlsDoc.OPVMselectDoctor.DOCTID);var D=i.visitDlsDoc.OPVMselectDoctor.SPECIALITY_CODE}var g=sessionStorage.getItem("orderregSeqId"),A=sessionStorage.getItem("orderencounterSeqId"),I=s.tariffSeqId,h=i.payerTypeModel.PayerType.PINS_SEQ_ID,R=i.orderDetails.quantity;d="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,d=i.priorityvis.priorityTypeModel.DT_CODE):(i.priorityvis.visitTypeModel,d=i.orderDetails.visitTypeCode);var f,T={"@class":"com.napier.core.service.vo.visitmanagement.VisitConfigurationDetails",doctorSeqId:y,tariffSeqId:I,regSeqId:g||void 0,enSeqId:A||void 0,payerId:h,quantity:R,serviceSeqId:e.SERV_SEQ_ID,specialityCode:D||void 0};(f={}).url=N.updateService.URL,f.requestData={operation:"getConsultationServiceRate",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:T},P.sendRestRequest(f).then(function(e){if(i.serResponce=e.data.HITService.message,"HSC"==sessionStorage.productCustomization){var t=e.data.HITService.message.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"].serviceRateVo;i.orderData.isRateEditable=t.isRateEditable,i.orderData.minValue=t.minValue,i.orderData.maxValue=t.maxValue,i.orderData.fromTariffRate="R",i.serviceName=e.data.HITService.message.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"].serviceVo.servName}""==i.serResponce.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time);var r,a=i.serResponce.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];i.orderDetails.OPVMorderService=a.serviceVo.servName,i.orderDetails.OPVMselectDoctor=a.requestedByEmpName,32==a.serviceRateVo.visistType?r="New":33==a.serviceRateVo.visistType?r="Free Follow Up":37==a.serviceRateVo.visistType&&(r="Follow Up"),i.priorityvis.visitTypeModel=r,i.orderDetails.visitTypeCode=a.serviceRateVo.visistType,i.orderDetails.price=a.serviceRateVo.baseRate,i.orderDetails.quantity=void 0===a.quantity?1:a.quantity,i.orderDetails.patamount=a.originalPatientAmount,i.orderDetails.payeramount=a.originalPayerAmount,i.dummyPice=a.serviceRateVo.baseRate,i.dummyPatAmount=a.originalPatientAmount,i.dummyPyrAmount=a.originalPayerAmount;var o={accSeqId:a.accSeqId,actualRate:a.actualRate,discountAmt:a.discountAmt,doctorAmount:a.doctorAmount,doctorShare:a.doctorShare,doctorSurcharge:a.doctorSurcharge,facilityId:a.facilityId,gnFlow:a.gnFlow,hospitalShare:a.hospitalShare,hospitalSurcharge:a.hospitalSurcharge,isDeleteBill:a.isDeleteBill,isDepositRequired:a.isDepositRequired,isEmergencyAllowedCheck:a.isEmergencyAllowedCheck,isMLCFlag:a.isMLCFlag,isRateEditable:a.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,minValue:i.orderData.minValue,maxValue:i.orderData.maxValue,fromTariffRate:i.orderData.fromTariffRate,newRate:a.newRate,patientAmount:a.patientAmount,payerAmount:a.payerAmount,originalPatientAmount:a.originalPatientAmount,originalPayerAmount:a.originalPayerAmount,servicePayerAuthorization:a.servicePayerAuthorization,practiceId:a.practiceId,proposedShareAfterDiscount:a.proposedShareAfterDiscount,requestedByEmpName:a.requestedByEmpName,requestedByEmpSeqID:a.requestedByEmpSeqID,requestedByEmpType:a.requestedByEmpType,servicePostingType:a.servicePostingType,serviceRate:a.serviceRate,serviceRateStatus:a.serviceRateStatus,serviceType:a.serviceType,standardDoctorShare:a.standardDoctorShare,subAccSeqId:a.subAccSeqId,technicianAmount:a.technicianAmount,transType:a.transType,servCode:a.serviceVo.servCode,servDesign:a.serviceVo.servDesign,servName:a.serviceVo.servName,servSeqId:a.serviceVo.servSeqId,visistType:a.serviceRateVo.visistType,baseRate:a.serviceRateVo.baseRate,gnServDesign:l,payerCompSeqId:a.payerCompSeqId,payerCompPlanseqId:a.payerCompPlanseqId,serviceTypeCode:a.primaryServiceCode,isPostBillApplicable:a.isPostBillApplicable?a.isPostBillApplicable:0};i.orderData=o,i.orderData.servCode=a.serviceVo.servCode,i.orderData.servName=a.serviceVo.servName,i.orderData.servSeqId=a.serviceVo.servSeqId,i.orderDetails.servCode=a.serviceVo.servCode,i.orderDetails.servName=a.serviceVo.servName,i.orderDetails.servSeqId=a.serviceVo.servSeqId,a.multiEmployeeShareList&&a.multiEmployeeShareList.employeeShareList&&(i.orderData.proposedShare=a.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,i.orderData.billedShare=a.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,i.orderData.grpMstCode=a.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?a.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0),le.opPreAuthGetData(i)})}},i.orderPrescription=function(e){s.selectedPreServices=[],i.modalInstance=S.open("PRESCRIPTIONS",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-order-prescription-popup.html",size:"md",scope:i});var t={};t.url=N.updateService.URL,t.requestData={operation:"getOPPrescriptionList",messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.OPPrescriptionVo",regSeqId:sessionStorage.getItem("orderregSeqId"),enSeqId:sessionStorage.getItem("orderencounterSeqId")}},P.sendRestRequest(t).then(function(e){var t=e.data.HITService.message[0]["com.napier.core.service.vo.visitmanagement.OPPrescriptionVo"],r="",a=[];void 0!==t.length?r=t:(a.push(t),r=a),i.mainPresArray=[];for(var o=!1,s=0;s<r.length;s++){o=!0;var n=r[s].opLaboratoryList[0]["com.napier.core.service.vo.visitmanagement.OPLaboratoryVo"],c=r[s].opRadiologyList[0]["com.napier.core.service.vo.visitmanagement.OPRadiologyVo"],l=r[s].opProcedureList[0]["com.napier.core.service.vo.visitmanagement.OPProcedureVo"],p=[];if(i.maindoctorName=r[s].doctorName,i.maindoctorSeqId=r[s].doctorSeqId,i.mainreqDate=moment(r[s].requestDate.$).format("YYYY-MM-DD"),p.push({maindoctorName:i.maindoctorName,maindoctorSeqId:i.maindoctorSeqId,mainreqDate:i.mainreqDate,healhCheckUpExpanded:o}),""!=r[s].opLaboratoryList[0]){var d="";if(void 0!==n.length)d=n;else{var m=[];m.push(n),d=m}}else d=[];if(""!=r[s].opRadiologyList[0]){var u="";if(void 0!==c.length)u=c;else{var v=[];v.push(c),u=v}}else u=[];if(""!=r[s].opProcedureList[0]){var S="";if(void 0!==l.length)S=l;else{var y=[];y.push(l),S=y}}else S=[];i.labtests=d,i.radtests=u,i.procedures=S;for(var D=0;D<i.RowsArr.length;D++){for(var g=0;g<i.labtests.length;g++)i.RowsArr[D][0].servSeqId!=i.labtests[g].servSeqId||3==i.RowsArr[D][0].servicePostingType||i.labtests[g].refSeqId||(i.labtests[g].selectlabtests=!0,i.labtests[g].checkOrder1=!0),i.labtests[g].refSeqId&&(i.labtests[g].selectlabtests=!0);for(g=0;g<i.radtests.length;g++)i.RowsArr[D][0].servSeqId!=i.radtests[g].servSeqId||3==i.RowsArr[D][0].servicePostingType||i.radtests[g].refSeqId||(i.radtests[g].selectradtests=!0,i.radtests[g].checkOrder2=!0),i.radtests[g].refSeqId&&(i.radtests[g].selectradtests=!0);for(g=0;g<i.procedures.length;g++)i.RowsArr[D][0].servSeqId!=i.procedures[g].servSeqId||3==i.RowsArr[D][0].servicePostingType||i.procedures[g].refSeqId||(i.procedures[g].selectproctests=!0,i.procedures[g].checkOrder3=!0),i.procedures[g].refSeqId&&(i.procedures[g].selectproctests=!0)}i.mainPresArray.push({docArray:p,labtests:i.labtests,radtests:i.radtests,procedureTests:i.procedures})}})},i.findIndexInData=function(e,t,r){var a=-1;return e.some(function(e,i){if(e[t]===r)return a=i,!0}),a},i.getSelectedPrescriptions=function(e,t){var r=i.findIndexInData(s.selectedPreServices,"servSeqId",e.servSeqId);-1!=r&&s.selectedPreServices.splice(r,1),1!=e.selectlabtests&&1!=e.selectradtests&&1!=e.selectproctests||s.selectedPreServices.push({servCode:e.servCode,servSeqId:e.servSeqId,servName:e.testName,prServCode:e.priServTypCode,secServCode:e.secServTypeCode,rqSeqId:e.rqSeqId,docSeqId:t.docArray[0].maindoctorSeqId,priority:e.priority,rqDtSeqId:e.rqDtSeqId})},i.loadPriority=function(){i.PriorityCombo=[],i.PriorityComboList={1:i.PriorityCombo};var e=I.executeQueryURLReset();return i.priorityCombosList=new Array,I.prepareParamList(1,850,i.priorityCombosList),I.executeQueryInput("TRN003",i.priorityCombosList,i.PriorityComboList,!0,!0,e,"popUp",{}).then(function(e){i.PriorityList=e[1],i.visitType="",i.visitCode="",i.visitType=i.PriorityList[0].DETAIL_DESC,i.visitCode=i.PriorityList[0].DT_CODE})},i.addServicesFromPrescription=function(){for(var e=[],t=0;t<i.RowsArr.length;t++)i.RowsArr[t][0].servSeqId==s.selectedPreServices[0].servSeqId&&3!=i.RowsArr[t][0].servicePostingType&&e.push(i.RowsArr[t][0].servName);if(0==e.length){i.addselectedPreServicesArr=[],i.addSelectPreServiceArr=[];void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,i.priorityvis.priorityTypeModel.DT_CODE):(i.priorityvis.visitTypeModel,i.orderDetails.visitTypeCode);for(var r=0;r<s.selectedPreServices.length;r++){var a=new Date,o=moment(a).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z",n=s.selectedPreServices[r].priority;N.updateService.URL,i.setCurrentTarrifId(),i.addselectedPreServicesArr=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),lbSeqId:s.selectedPreServices[r].rqDtSeqId?s.selectedPreServices[r].rqDtSeqId:void 0,servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:s.selectedPreServices[r].servSeqId,gnServDesign:1,servCode:s.selectedPreServices[r].servCode,servName:s.selectedPreServices[r].servName,secServTypeCode:s.selectedPreServices[r].secServCode,priServTypCode:s.selectedPreServices[r].prServCode},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:s.selectedPreServices[r].servSeqId,tariffSeqId:s.tariffSeqId,datedOn:o,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:i.orderDetails.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:s.selectedPreServices[r].docSeqId,fromOPVisit:"Y",payerId:i.payerTypeModel.PayerType.PINS_SEQ_ID,priority:n}],i.addSelectPreServiceArr.push(i.addselectedPreServicesArr)}var c={};c.url=N.updateService.URL,c.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectPreServiceArr}]}},P.sendRestRequest(c).then(function(e){i.addSelectedPreResponce=e.data.HITService.message,""==i.addSelectedPreResponce.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time);var t=i.addSelectedPreResponce.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"],r=[],a="";if(void 0!==t.length)a=t;else{var o=[];o.push(t),a=o}for(var n=0;n<i.RowsArr.length;n++)r.push(i.RowsArr[n][0].servSeqId);i.loadPriority(),T(function(){for(var e=0;e<a.length;e++){var t=i.visitType,r=i.visitCode;if(i.PriorityCombo.length>1&&a[e].priority){var o=i.PriorityCombo.map(function(e){return e.DT_CODE}).indexOf(a[e].priority);-1!=o&&(t=i.PriorityCombo[o].DETAIL_DESC,r=i.PriorityCombo[o].DT_CODE)}a[e].serviceVo.servSeqId;i.rows=[{serviceTypeCODE:a[e].primaryServiceCode,serviceType:a[e].primaryService,servCode:a[e].serviceVo.servCode,servName:a[e].serviceVo.servName,servSeqId:a[e].serviceVo.servSeqId,gnServDesign:a[e].serviceVo.gnServDesign,servicePayerAuthorization:a[e].servicePayerAuthorization,visistType:t,visitTypeCode:r,requestedByEmpName:a[e].requestedByEmpName,requestedByEmpSeqID:a[e].requestedByEmpSeqID,requestedByEmpType:a[e].requestedByEmpType,payerType:i.payerTypeModel.PayerType.PAYER_NAME,payerTypeCode:i.payerTypeModel.PayerType.PINS_SEQ_ID,insurancePlanSeqId:null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,actualRate:a[e].actualRate,quantity:1,isPostBillApplicable:a[e].isPostBillApplicable?a[e].isPostBillApplicable:0,patientAmount:a[e].patientAmount,payerAmount:a[e].payerAmount,originalPatientAmount:a[e].originalPatientAmount,originalPayerAmount:a[e].originalPayerAmount,discountAmt:a[e].discountAmt,doctorAmount:a[e].doctorAmount,doctorShare:a[e].doctorShare,doctorSurcharge:a[e].doctorSurcharge,hospitalShare:a[e].hospitalShare,hospitalSurcharge:a[e].hospitalSurcharge,isRateEditable:a[e].isRateEditable,newRate:a[e].newRate,proposedShareAfterDiscount:a[e].proposedShareAfterDiscount,serviceRate:a[e].serviceRate,serviceRateStatus:a[e].serviceRateStatus,standardDoctorShare:a[e].standardDoctorShare,technicianAmount:a[e].technicianAmount,baseRate:a[e].baseRate,gnFlow:a[e].gnFlow,facilityId:a[e].facilityId,billStatus:0,refTranSeqID:a[e].lbSeqId?a[e].lbSeqId:s.selectedPreServices[e].rqSeqId,payerCompSeqId:a[e].payerCompSeqId,payerCompPlanseqId:a[e].payerCompPlanseqId,rcvSeqId:a[e].serviceRateVo.rcvSeqId,inflSeqId:a[e].serviceRateVo.inflSeqId,proposedShare:a[e].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,billedShare:a[e].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,grpMstCode:a[e].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?a[e].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,transType:1,priServTypCode:a[e].secServiceCode,deptCode:null!=a[e].serviceVo&&null!=a[e].serviceVo.atomicDetailsVo&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code?a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code:void 0,specilityCode:null!=a[e].serviceVo&&null!=a[e].serviceVo.atomicDetailsVo&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code?a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code:void 0,lbSeqId:a[e].lbSeqId?a[e].lbSeqId:void 0}],i.RowsArr.unshift(i.rows)}},300),E.dismissAll(),i.orderBtnDisable=!1})}else{var l={buttonCallBack1:function(){i.addselectedPreServicesArr=[],i.addSelectPreServiceArr=[];void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,i.priorityvis.priorityTypeModel.DT_CODE):(i.priorityvis.visitTypeModel,i.orderDetails.visitTypeCode);for(var e=0;e<s.selectedPreServices.length;e++){var t=new Date,r=moment(t).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z",a=s.selectedPreServices[e].priority;N.updateService.URL,i.setCurrentTarrifId(),i.addselectedPreServicesArr=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:s.selectedPreServices[e].servSeqId,gnServDesign:1,servCode:s.selectedPreServices[e].servCode,servName:s.selectedPreServices[e].servName,secServTypeCode:s.selectedPreServices[e].secServCode,priServTypCode:s.selectedPreServices[e].prServCode},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:s.selectedPreServices[e].servSeqId,tariffSeqId:s.tariffSeqId,datedOn:r,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:i.orderDetails.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:s.selectedPreServices[e].docSeqId,fromOPVisit:"Y",payerId:i.payerTypeModel.PayerType.PINS_SEQ_ID,priority:a}],i.addSelectPreServiceArr.push(i.addselectedPreServicesArr)}var o={};o.url=N.updateService.URL,o.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectPreServiceArr}]}},P.sendRestRequest(o).then(function(e){i.addSelectedPreResponce=e.data.HITService.message,""==i.addSelectedPreResponce.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time);var t=i.addSelectedPreResponce.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"],r=[],a="";if(void 0!==t.length)a=t;else{var o=[];o.push(t),a=o}for(var n=0;n<i.RowsArr.length;n++)r.push(i.RowsArr[n][0].servSeqId);i.loadPriority(),T(function(){for(var e=0;e<a.length;e++){var t=i.visitType,r=i.visitCode;if(i.PriorityCombo.length>1&&a[e].priority){var o=i.PriorityCombo.map(function(e){return e.DT_CODE}).indexOf(a[e].priority);-1!=o&&(t=i.PriorityCombo[o].DETAIL_DESC,r=i.PriorityCombo[o].DT_CODE)}a[e].serviceVo.servSeqId;i.rows=[{serviceTypeCODE:a[e].primaryServiceCode,serviceType:a[e].primaryService,servCode:a[e].serviceVo.servCode,servName:a[e].serviceVo.servName,servSeqId:a[e].serviceVo.servSeqId,gnServDesign:a[e].serviceVo.gnServDesign,servicePayerAuthorization:a[e].servicePayerAuthorization,visistType:t,visitTypeCode:r,requestedByEmpName:a[e].requestedByEmpName,requestedByEmpSeqID:a[e].requestedByEmpSeqID,requestedByEmpType:a[e].requestedByEmpType,payerType:i.payerTypeModel.PayerType.PAYER_NAME,payerTypeCode:i.payerTypeModel.PayerType.PINS_SEQ_ID,insurancePlanSeqId:null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,actualRate:a[e].actualRate,quantity:1,isPostBillApplicable:a[e].isPostBillApplicable?a[e].isPostBillApplicable:0,patientAmount:a[e].patientAmount,payerAmount:a[e].payerAmount,originalPatientAmount:a[e].originalPatientAmount,originalPayerAmount:a[e].originalPayerAmount,discountAmt:a[e].discountAmt,doctorAmount:a[e].doctorAmount,doctorShare:a[e].doctorShare,doctorSurcharge:a[e].doctorSurcharge,hospitalShare:a[e].hospitalShare,hospitalSurcharge:a[e].hospitalSurcharge,isRateEditable:a[e].isRateEditable,newRate:a[e].newRate,proposedShareAfterDiscount:a[e].proposedShareAfterDiscount,serviceRate:a[e].serviceRate,serviceRateStatus:a[e].serviceRateStatus,standardDoctorShare:a[e].standardDoctorShare,technicianAmount:a[e].technicianAmount,baseRate:a[e].baseRate,gnFlow:a[e].gnFlow,facilityId:a[e].facilityId,billStatus:0,refTranSeqID:s.selectedPreServices[e].rqSeqId,payerCompSeqId:a[e].payerCompSeqId,payerCompPlanseqId:a[e].payerCompPlanseqId,rcvSeqId:a[e].serviceRateVo.rcvSeqId,inflSeqId:a[e].serviceRateVo.inflSeqId,proposedShare:a[e].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,billedShare:a[e].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,grpMstCode:a[e].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?a[e].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,transType:1,priServTypCode:a[e].secServiceCode,deptCode:null!=a[e].serviceVo&&null!=a[e].serviceVo.atomicDetailsVo&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code?a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code:void 0,specilityCode:null!=a[e].serviceVo&&null!=a[e].serviceVo.atomicDetailsVo&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&null!=a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code?a[e].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code:void 0}],i.RowsArr.unshift(i.rows)}},300),E.dismissAll(),i.orderBtnDisable=!1})},buttonCallBack2:function(){}};v.hisAlertMulti("warning","Confirmation","Service Already added.Do you really want to add the service ?",{buttonText:"YES",buttonText2:"NO"},l,close)}},i.mapDoctorTopackageServices=function(e){$("#packageServiceModal").modal("hide");var t=i.pkgSelectedRow,r=i.RowsArr[t],a=0;angular.forEach(i.packageServices,function(e,t){a+=parseFloat(e.INCL_AMOUNT)}),i.changePkgRates(a,r).then(function(a){a?i.preparePackageObject(e,r):(v.warning("Warning!","Package amount and Tariff Rates are not same. Kindly change either of one."),i.RowsArr.splice(t,1))})},i.preparePackageObject=function(e,t){i.showOrderLoadingIcon=!0,i.packageServicesArrayObejct=[];var r=new Date,a=moment(r).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";i.currentObjData.isPrintToBill=i.billcheck;var o="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,o=i.priorityvis.priorityTypeModel.DT_CODE):(i.priorityvis.visitTypeModel,o=i.orderDetails.visitTypeCode);var n=o;i.addSelectServicepostEditArr=[],i.setCurrentTarrifId();for(var c=0;c<e.length;c++){var l=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId")?sessionStorage.getItem("accountseqId"):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0,servicePostingType:1,parentSeqId:t[0].servSeqId,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:e[c].INCL_SERV_SEQ_ID,gnServDesign:1,servCode:e[c].SERV_CODE,servName:e[c].SERV_NAME,secServTypeCode:e[c].SEC_SERV_TYPE_CODE,priServTypCode:e[c].SEC_SERV_TYPE_CODE},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:e[c].INCL_SERV_SEQ_ID,tariffSeqId:s.tariffSeqId,datedOn:a,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:i.orderDetails.quantity,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:e[c].serviceDoc,fromOPVisit:"Y",priority:n,appointReason:e[c].NH_OP_REASON_SEQ_ID?e[c].NH_OP_REASON_SEQ_ID:e[c].appointReason?e[c].appointReason:void 0}];i.addSelectServicepostEditArr.push(l)}var p={};p.url=N.updateService.URL,p.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId")?sessionStorage.getItem("accountseqId"):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectServicepostEditArr}]}},P.sendRestRequest(p).then(function(r){i.addselectPackageresponse=r.data.HITService.message;var a=i.addselectPackageresponse.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];if(""!=a){if(a=a instanceof Array?a:[a],angular.isArray(a)){for(var o=0;o<a.length;o++){var s={};(s=e[o]).parentServSeqId=e[0].SERV_SEQ_ID,s.serviceTypeCODE=a[o].serviceVo.priServTypCode,s.serviceType=i.serviceTypeModel.serviceType&&i.serviceTypeModel.serviceType.DESCRIPTION?i.serviceTypeModel.serviceType.DESCRIPTION:"",s.servCode=a[o].serviceVo.servCode,s.servicePostingSeqId=e[o].servicePostingSeqId,s.servName=a[o].serviceVo.servName,s.servSeqId=a[o].serviceVo.servSeqId,s.gnServDesign=a[o].serviceVo.gnServDesign,s.servicePayerAuthorization=a[o].servicePayerAuthorization,s.visistType=void 0,s.requestedByEmpName=a[o].requestedByEmpName,s.requestedByEmpSeqID=a[o].requestedByEmpSeqID,s.requestedByEmpType=a[o].requestedByEmpType,s.payerType=i.payerTypeModel.PayerType.PAYER_NAME,s.payerTypeCode=i.payerTypeModel.PayerType.PINS_SEQ_ID,s.actualRate=a[o].actualRate,s.quantity=1,s.isPostBillApplicable=a[o].isPostBillApplicable?a[o].isPostBillApplicable:0,s.patientAmount=a[o].patientAmount,s.payerAmount=a[o].payerAmount,s.originalPatientAmount=a[o].originalPatientAmount,s.originalPayerAmount=a[o].originalPayerAmount,s.discountAmt=a[o].discountAmt,s.doctorAmount=a[o].doctorAmount,s.doctorShare=a[o].doctorShare,s.doctorSurcharge=a[o].doctorSurcharge,s.hospitalShare=a[o].hospitalShare,s.hospitalSurcharge=a[o].hospitalSurcharge;try{s.isRateEditable=a[o].serviceVo.scmMasterServBillingAttrVo.faIsRateEditable}catch(e){s.isRateEditable=0}s.newRate=a[o].newRate,s.proposedShareAfterDiscount=a[o].proposedShareAfterDiscount,s.serviceRate=a[o].serviceRate,s.serviceRateStatus=a[o].serviceRateStatus,s.standardDoctorShare=a[o].standardDoctorShare,s.technicianAmount=a[o].technicianAmount,s.baseRate=a[o].baseRate,s.gnFlow=a[o].gnFlow,s.facilityId=a[o].facilityId,s.facilityId=a[o].facilityId,s.facilityId=a[o].facilityId,s.isPackage=2,s.packApplyType=2,s.appointReason=a[o].appointReason;var n=a[o].multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"];s.billedShare=n.billedShare,s.proposedShare=n.proposedShare,s.docempSeqId=n.employee?n.employee.empSeqId:void 0,null!=a[o].serviceVo&&null!=a[o].serviceVo.atomicDetailsVo&&null!=a[o].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=a[o].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=a[o].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&(null!=a[o].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&(s.deptCode=a[o].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code),null!=a[o].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=a[o].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=a[o].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&(s.specilityCode=a[o].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code)),i.packageServicesArrayObejct.push(s)}t[0].packageServicesList=angular.copy(i.packageServicesArrayObejct),i.packageServicesArrayObejct=[]}i.showOrderLoadingIcon=!1}})},i.clickBillPrint=function(e){i.billcheck=e},i.packageServclose=function(){i.mapDoctorTopackageServices(i.packageServices)},i.showpackageServices=function(e,t){i.packageServices=[],i.inclusionServiceValid=!1,i.pkgSelectedRow=t;var r="Master "+e[0].servName,o=(r.toUpperCase(),e[0].servSeqId);if(i.currentObjData=e[0],i.billcheck="N",$("#packageServiceModal").modal({backdrop:"static",keyboard:!1}),i.packageTitle=r,void 0!==e[0].servicePostingSeqId){for(var s=e[0].servicePostingSeqId,n=[],c=0;c<i.retrivePacServObj.length;c++)i.retrivePacServObj[c].parentSeqId==s&&n.push(i.retrivePacServObj[c]);i.packageServices=n}else if(e[0].packageServicesList&&e[0].packageServicesList.length>0)i.packageServices=[],i.packageServices=e[0].packageServicesList;else{var l;l={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"GET_SERVICES_FOR_PACKAGE_001",idxList:[{"com.napier.core.service.vo.query.Index":[{paramName:"pPracticeId",value:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID},{paramName:"pFacilityId",value:angular.fromJson(sessionStorage.userContextObj).FACILITY_ID},{paramName:"pServSeqId",value:o}]}]}]}]};var p={};p.url=a.HISCOMBOFILLING.URL,p.requestData={operation:"ExecuteQuery",destination:"QueryService",message:l},P.sendRestRequest(p).then(function(t){var r=t.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"];if(void 0===i.packageServices||0==i.packageServices.length){i.packageServices=[];for(var a=0;a<r.length;a++){for(var o={},s=r[a].columnList[0]["com.napier.core.service.vo.query.Column"],n=0;n<s.length;n++){o[s[n].name.split(".")[1]]=s[n].data}o.serviceDoc=e[0].requestedByEmpName,o.serviceDoc=e[0].requestedByEmpSeqID,o.pacMainObj=e[0],i.packageServices.push(o)}}})}},i.changeRatesBasedonQty=function(e){var t=parseInt(e);t>=1||(v.warning("Warning!","Order Qty should not be Less than 1",!1,!1,me.time),i.orderDetails.quantity=1,e=1);var r=i.orderData.requestedByEmpSeqID,a=sessionStorage.getItem("orderregSeqId"),o=sessionStorage.getItem("orderencounterSeqId");i.setCurrentTarrifId();var n=s.tariffSeqId,c=i.payerTypeModel.PayerType.PINS_SEQ_ID,l="";l=void 0!==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID?i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID:i.orderData.appointReason;var p="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,p=i.priorityvis.priorityTypeModel.DT_CODE):(i.priorityvis.visitTypeModel,p=i.orderDetails.visitTypeCode);var d=p;if(1!=l){i.addSelectServicepostEditArr=[];var m=new Date,u=moment(m).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";N.updateService.URL;var S=1;3==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID&&(S=2);var y=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.orderDetails.servSeqId,gnServDesign:S,servCode:i.orderDetails.servCode,servName:i.orderDetails.servName,secServTypeCode:i.orderDetails.servSeqId,priServTypCode:i.orderDetails.servSeqId},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.orderDetails.servSeqId,tariffSeqId:s.tariffSeqId,datedOn:u,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},quantity:e,transType:1,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:r,payerId:c,fromOPVisit:"Y",priority:d}];i.addSelectServicepostEditArr.push(y);var D={};D.url=N.updateService.URL,D.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.addSelectServicepostEditArr}]}},P.sendRestRequest(D).then(function(e){i.addselectEdiresponse=e.data.HITService.message,""==i.addselectEdiresponse.servicePostingDetailsList[0]&&v.warning("Warning!","Service Rate Not Defined",!1,!1,me.time);var t=i.addselectEdiresponse.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];i.orderData.actualRate=t.actualRate,i.orderData.quantity=t.quantity,i.orderData.isPostBillApplicable=t.isPostBillApplicable?t.isPostBillApplicable:0,i.orderData.patientAmount=t.patientAmount,i.orderData.payerAmount=t.payerAmount,i.orderData.originalPatientAmount=t.originalPatientAmount,i.orderData.originalPayerAmount=t.originalPayerAmount,i.orderData.discountAmt=t.discountAmt,i.orderData.doctorAmount=t.doctorAmount,i.orderData.doctorShare=t.doctorShare,i.orderData.doctorSurcharge=t.doctorSurcharge,i.orderData.hospitalShare=t.hospitalShare,i.orderData.hospitalSurcharge=t.hospitalSurcharge,i.orderData.isRateEditable=t.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,1==i.orderData.isRateEditable&&(i.orderData.minValue=null!=t.minVal?t.minVal:t.serviceVo.scmMasterServBillingAttrVo.minValue,i.orderData.maxValue=null!=t.maxVal?t.maxVal:t.serviceVo.scmMasterServBillingAttrVo.maxValue,i.orderData.fromTariffRate="R"),i.orderData.newRate=t.newRate,i.orderData.proposedShareAfterDiscount=t.proposedShareAfterDiscount,i.orderData.serviceRate=t.serviceRate,i.orderData.serviceRateStatus=t.serviceRateStatus,i.orderData.standardDoctorShare=t.standardDoctorShare,i.orderData.technicianAmount=t.technicianAmount,i.orderData.baseRate=t.serviceRateVo.baseRate,i.orderData.gnFlow=t.gnFlow,i.orderData.facilityId=t.facilityId,i.orderData.billStatus=0,i.orderData.payerCompSeqId=t.payerCompSeqId,i.orderData.payerCompPlanseqId=t.payerCompPlanseqId,i.orderDetails.price=t.serviceRate,i.dummyPice=t.serviceRate,i.dummyPatAmount=t.originalPatientAmount,i.dummyPyrAmount=t.originalPayerAmount,i.orderDetails.patamount=t.originalPatientAmount,i.orderDetails.payeramount=t.originalPayerAmount,i.orderData.rcvSeqId=t.serviceRateVo.rcvSeqId,i.orderData.inflSeqId=t.serviceRateVo.inflSeqId,i.orderData.proposedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare,i.orderData.billedShare=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare,i.orderData.grpMstCode=t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,i.orderData.priServTypCode=t.secServiceCode,null!=t.serviceVo&&null!=t.serviceVo.atomicDetailsVo&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&(null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&(i.orderData.deptCode=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code),null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&(i.orderData.specilityCode=t.serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code))})}else"HSC"==sessionStorage.getItem("productCustomization")?t>1&&(i.orderDetails.quantity=1):i.getOrderDetails(r,a,o,n,void 0,c,e)},i.DeleteOrderRecords=function(e,t){var r={buttonCallBack1:function(r){if(void 0!==t[0].servicePostingSeqId){var a={};a.url=N.updateService.URL,a.requestData={operation:"checkOrderCancel",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.master.vo.ServiceListVo",serviceList:[{"com.napier.core.scm.master.vo.ServiceVo":[{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:t[0].servicePostingSeqId,servDesc:t[0].servName,gnServDesign:null!=t[0].appointReason?t[0].appointReason:2}]}]}},P.sendRestRequest(a).then(function(a){if(""==a.data.HITService.message.serviceList[0]){var o={};o.url=N.updateService.URL,o.requestData={operation:"cancelServicePosting",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",servicePostingSeqId:t[0].servicePostingSeqId,encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},servicePostingCacelReason:i.projSpecApplicable?r:"",cancelRequestedBy:i.projSpecApplicable?JSON.parse(sessionStorage.userContextObj).USER_SEQ_ID:void 0}]}]}},P.sendRestRequest(o).then(function(t){i.RowsArr[e][0].servicePostingSeqId?i.RowsArr[e][0].servicePostingType=3:(i.preAuthBillOrServiceCal(!0,i.RowsArr[e][0]),i.RowsArr.splice(e,1));try{"error"==t.data.HITService.message||t.data.HITService.message.errorCode||t.data.HITService.message.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"]&&(i.RowsArr[e][0].servicePostingCacelReason=t.data.HITService.message.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"].servicePostingCacelReason)}catch(e){}i.loadBillNumbers(s.mrNo)})}else v.warning("Warning!","We Can't Delete this Service",!1,!1,me.time);for(var n=0,c=0;c<i.RowsArr.length;c++)1!=i.RowsArr[c][0].billStatus&&(n=1);i.orderBtnDisable=0==n})}else{i.RowsArr[e][0].servicePostingSeqId?i.RowsArr[e][0].servicePostingType=3:(i.preAuthBillOrServiceCal(!0,i.RowsArr[e][0]),i.RowsArr.splice(e,1));for(var o=0,n=0;n<i.RowsArr.length;n++)1!=i.RowsArr[n][0].billStatus&&(o=1);i.orderBtnDisable=0==o}i.packageServices=[]},buttonCallBack2:function(){}};v.hisAlertMulti("warning","Confirmation","Do you really want to delete the service ?",{buttonText:"YES",buttonText2:"NO"},r,close)},i.updateOrdersRow=function(e){i.showOrderErrors=!0,e.$valid&&T(function(){if(s.editRowRecord[0].servSeqId==i.orderDetails.servSeqId)var e=[];else{e=[];for(var t=0;t<i.RowsArr.length;t++)i.RowsArr[t][0].servSeqId==i.orderDetails.servSeqId&&e.push(i.RowsArr[t][0].servName)}if(0==e.length){if(i.orderData.baseRate!=i.orderDetails.price)if(0==i.checkMinMaxForRateEditable())return;var r="";r=void 0!==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID?i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID:i.orderData.appointReason;var a="",o="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel&&null!=i.priorityvis.priorityTypeModel?(a=i.priorityvis.priorityTypeModel.DETAIL_DESC,o=i.priorityvis.priorityTypeModel.DT_CODE):(a=i.priorityvis.visitTypeModel,o=i.orderDetails.visitTypeCode),s.editRowRecord[0].doctorModifiedAmount=i.orderData.doctorModifiedAmount,s.editRowRecord[0].updateServiceFlag=i.orderData.updateDoctorShares,s.editRowRecord[0].serviceTypeCODE=i.serviceTypeModel.serviceType.CODE,s.editRowRecord[0].serviceType=i.serviceTypeModel.serviceType.DESCRIPTION,s.editRowRecord[0].servCode=i.orderDetails.servCode,s.editRowRecord[0].servDesign=i.orderData.servDesign,s.editRowRecord[0].servName=i.orderDetails.servName,s.editRowRecord[0].servSeqId=i.orderDetails.servSeqId,s.editRowRecord[0].servicePayerAuthorization=i.dummyPyrAutherisation,s.editRowRecord[0].visistType=a,s.editRowRecord[0].visitTypeCode=o,s.editRowRecord[0].requestedByEmpName=i.orderData.requestedByEmpName,s.editRowRecord[0].requestedByEmpSeqID=i.orderData.requestedByEmpSeqID,s.editRowRecord[0].requestedByEmpType=i.orderData.requestedByEmpType,s.editRowRecord[0].payerType=i.payerTypeModel.PayerType.PAYER_NAME,s.editRowRecord[0].payerTypeCode=i.payerTypeModel.PayerType.PINS_SEQ_ID,s.editRowRecord[0].payerTarrifId=i.payerTypeModel.PayerType.TATRIFF_SEQ_ID?i.payerTypeModel.PayerType.TATRIFF_SEQ_ID:s.tariffSeqId,s.editRowRecord[0].insurancePlanSeqId=null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,s.editRowRecord[0].actualRate=i.orderData.actualRate,s.editRowRecord[0].quantity=i.orderDetails.quantity,s.editRowRecord[0].patientAmount=i.orderData.patientAmount,s.editRowRecord[0].payerAmount=i.orderData.payerAmount,s.editRowRecord[0].originalPatientAmount=i.orderData.originalPatientAmount,s.editRowRecord[0].originalPayerAmount=i.orderData.originalPayerAmount,s.editRowRecord[0].discountAmt=i.orderData.discountAmt,s.editRowRecord[0].doctorAmount=i.orderData.doctorAmount,s.editRowRecord[0].doctorShare=i.orderData.doctorShare,s.editRowRecord[0].doctorSurcharge=i.orderData.doctorSurcharge,s.editRowRecord[0].hospitalShare=i.orderData.hospitalShare,s.editRowRecord[0].hospitalSurcharge=i.orderData.hospitalSurcharge,s.editRowRecord[0].isRateEditable=i.orderData.isRateEditable,1==s.editRowRecord[0].isRateEditable&&(s.editRowRecord[0].minValue=i.orderData.minValue,s.editRowRecord[0].maxValue=i.orderData.maxValue,s.editRowRecord[0].fromTariffRate=i.orderData.fromTariffRate),s.editRowRecord[0].newRate=i.orderData.newRate,s.editRowRecord[0].proposedShareAfterDiscount=i.orderData.proposedShareAfterDiscount,s.editRowRecord[0].serviceRate=i.orderData.serviceRate,s.editRowRecord[0].serviceRateStatus=i.orderData.serviceRateStatus,s.editRowRecord[0].standardDoctorShare=i.orderData.standardDoctorShare,s.editRowRecord[0].technicianAmount=i.orderData.technicianAmount,s.editRowRecord[0].baseRate=i.orderData.baseRate,s.editRowRecord[0].gnFlow=i.orderData.gnFlow,s.editRowRecord[0].facilityId=i.orderData.facilityId,s.editRowRecord[0].gnServDesign=i.orderData.gnServDesign,s.editRowRecord[0].payerCompSeqId=i.orderData.payerCompSeqId,s.editRowRecord[0].payerCompPlanseqId=i.orderData.payerCompPlanseqId,s.editRowRecord[0].appointReason=r,s.editRowRecord[0].transType=i.orderData.transType,s.editRowRecord[0].proposedShare=i.orderData.proposedShare,s.editRowRecord[0].billedShare=i.orderData.billedShare,s.editRowRecord[0].grpMstCode=i.orderData.grpMstCode?i.orderData.grpMstCode:void 0;i.orderData.requestedByEmpName,sessionStorage.getItem("orderregSeqId"),sessionStorage.getItem("orderencounterSeqId");i.orderDetails.OPVMorderService="",i.orderDetails.price="",i.orderDetails.quantity=1,i.orderDetails.patamount="",i.orderDetails.payeramount="",i.priorityvis.priorityTypeModel="",i.priorityvis.visitTypeModel="",i.serviceTypeModel.serviceType="",i.addRowStatus=!0,i.orderData.isRateEditable=2,"N"==s.editRowRecord[0].servicePayerAuthorization&&"self"!=s.editRowRecord[0].payerType.toLocaleLowerCase()?i.isServiceSelectedCovered=!0:i.isServiceSelectedCovered=!1,T(function(){i.isServiceSelectedCovered=!1},2e3),i.showOrderErrors=!1}else{var n={buttonCallBack1:function(){if(i.orderData.baseRate!=i.orderDetails.price&&0==i.checkMinMaxForRateEditable())return;var e="";e=void 0!==i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID?i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID:i.orderData.appointReason;var t="",r="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel&&null!=i.priorityvis.priorityTypeModel?(t=i.priorityvis.priorityTypeModel.DETAIL_DESC,r=i.priorityvis.priorityTypeModel.DT_CODE):(t=i.priorityvis.visitTypeModel,r=i.orderDetails.visitTypeCode),s.editRowRecord[0].serviceTypeCODE=i.serviceTypeModel.serviceType.CODE,s.editRowRecord[0].serviceType=i.serviceTypeModel.serviceType.DESCRIPTION,s.editRowRecord[0].servCode=i.orderDetails.servCode,s.editRowRecord[0].servDesign=i.orderData.servDesign,s.editRowRecord[0].servName=i.orderDetails.servName,s.editRowRecord[0].servSeqId=i.orderDetails.servSeqId,s.editRowRecord[0].servicePayerAuthorization=i.dummyPyrAutherisation,s.editRowRecord[0].visistType=t,s.editRowRecord[0].visitTypeCode=r,s.editRowRecord[0].requestedByEmpName=i.orderData.requestedByEmpName,s.editRowRecord[0].requestedByEmpSeqID=i.orderData.requestedByEmpSeqID,s.editRowRecord[0].requestedByEmpType=i.orderData.requestedByEmpType,s.editRowRecord[0].payerType=i.payerTypeModel.PayerType.PAYER_NAME,s.editRowRecord[0].payerTypeCode=i.payerTypeModel.PayerType.PINS_SEQ_ID,s.editRowRecord[0].payerTarrifId=i.payerTypeModel.PayerType.TATRIFF_SEQ_ID?i.payerTypeModel.PayerType.TATRIFF_SEQ_ID:s.tariffSeqId,s.editRowRecord[0].insurancePlanSeqId=null!=i.payerTypeModel.PayerType.PLAN_SEQ_ID?i.payerTypeModel.PayerType.PLAN_SEQ_ID:void 0,s.editRowRecord[0].actualRate=i.orderData.actualRate,s.editRowRecord[0].quantity=i.orderDetails.quantity,s.editRowRecord[0].patientAmount=i.orderData.patientAmount,s.editRowRecord[0].payerAmount=i.orderData.payerAmount,s.editRowRecord[0].originalPatientAmount=i.orderData.originalPatientAmount,s.editRowRecord[0].originalPayerAmount=i.orderData.originalPayerAmount,s.editRowRecord[0].discountAmt=i.orderData.discountAmt,s.editRowRecord[0].doctorAmount=i.orderData.doctorAmount,s.editRowRecord[0].doctorShare=i.orderData.doctorShare,s.editRowRecord[0].doctorSurcharge=i.orderData.doctorSurcharge,s.editRowRecord[0].hospitalShare=i.orderData.hospitalShare,s.editRowRecord[0].hospitalSurcharge=i.orderData.hospitalSurcharge,s.editRowRecord[0].isRateEditable=i.orderData.isRateEditable,1==s.editRowRecord[0].isRateEditable&&(s.editRowRecord[0].minValue=i.orderData.minValue,s.editRowRecord[0].maxValue=i.orderData.maxValue,s.editRowRecord[0].fromTariffRate=i.orderData.fromTariffRate),s.editRowRecord[0].newRate=i.orderData.newRate,s.editRowRecord[0].proposedShareAfterDiscount=i.orderData.proposedShareAfterDiscount,s.editRowRecord[0].serviceRate=i.orderData.serviceRate,s.editRowRecord[0].serviceRateStatus=i.orderData.serviceRateStatus,s.editRowRecord[0].standardDoctorShare=i.orderData.standardDoctorShare,s.editRowRecord[0].technicianAmount=i.orderData.technicianAmount,s.editRowRecord[0].baseRate=i.orderData.baseRate,s.editRowRecord[0].gnFlow=i.orderData.gnFlow,s.editRowRecord[0].facilityId=i.orderData.facilityId,s.editRowRecord[0].gnServDesign=i.orderData.gnServDesign,s.editRowRecord[0].payerCompSeqId=i.orderData.payerCompSeqId,s.editRowRecord[0].payerCompPlanseqId=i.orderData.payerCompPlanseqId,s.editRowRecord[0].appointReason=e,s.editRowRecord[0].transType=i.orderData.transType,s.editRowRecord[0].proposedShare=i.orderData.proposedShare,s.editRowRecord[0].billedShare=i.orderData.billedShare,s.editRowRecord[0].grpMstCode=i.orderData.grpMstCode?i.orderData.grpMstCode:void 0;i.orderData.requestedByEmpName,sessionStorage.getItem("orderregSeqId"),sessionStorage.getItem("orderencounterSeqId");i.orderDetails.OPVMorderService="",i.orderDetails.price="",i.orderDetails.quantity=1,i.orderDetails.patamount="",i.orderDetails.payeramount="",i.priorityvis.priorityTypeModel="",i.priorityvis.visitTypeModel="",i.serviceTypeModel.serviceType="",i.addRowStatus=!0,i.orderData.isRateEditable=2,"N"==s.editRowRecord[0].servicePayerAuthorization&&"self"!=s.editRowRecord[0].payerType.toLocaleLowerCase()?i.isServiceSelectedCovered=!0:i.isServiceSelectedCovered=!1,T(function(){i.isServiceSelectedCovered=!1},2e3),i.showOrderErrors=!1},buttonCallBack2:function(){}};v.hisAlertMulti("warning","Confirmation","Service Already added.Do you really want to add the service ?",{buttonText:"YES",buttonText2:"NO"},n,close)}},1e3)},i.retriveRecords=function(e){i.retrivePackageServObj=[],i.retrivePackageDeletedServObj=[];var t={};t.url=N.updateService.URL,t.requestData={operation:"getOPServicePostingList",messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingFilterVo",patientId:s.mrNo,fromDate:"1800-01-01 00:00:00.000Z",toDate:"9999-01-01 23:59:59.000Z",practiseId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,enSeqId:sessionStorage.getItem("orderencounterSeqId")?sessionStorage.getItem("orderencounterSeqId"):void 0,specific:i.projSpecApplicable}},i.showOrderLoadingIcon=!0,P.sendRestRequest(t).then(function(t){i.RowsArr=[];var r=t.data.HITService.message;if(i.orderUpdate=!0,r.servicePostingDetailsList&&(i.servicepostingList=r.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"],i.servicepostingList=i.servicepostingList instanceof Array?i.servicepostingList:[i.servicepostingList],i.retrivePacServObj=[],i.servicepostingList.length>0&&i.servicepostingList[0]&&!i.servicepostingList[0].isIpVisit)){i.orderUpdate=!0;for(var a=0;a<i.servicepostingList.length;a++){1!=i.servicepostingList[a].billStatus&&(i.orderBtnDisable=!1);let e=null!=i.servicepostingList[a].copayAmt?parseFloat(i.servicepostingList[a].copayAmt):parseFloat(0);if(2!=i.servicepostingList[a].packApplyType){if(i.rows=[{servicePostingSeqId:i.servicepostingList[a].servicePostingSeqId,serviceTypeCODE:i.servicepostingList[a].serviceVo.priServTypCode,serviceType:i.servicepostingList[a].priTypeDesc,servCode:i.servicepostingList[a].serviceVo.servCode,servName:i.servicepostingList[a].serviceVo.servName,servSeqId:i.servicepostingList[a].serviceVo.servSeqId,payerTarrifId:i.servicepostingList[a].serviceRateVo?i.servicepostingList[a].serviceRateVo.tariffSeqId:void 0,gnServDesign:i.servicepostingList[a].serviceVo.gnServDesign,visistType:i.servicepostingList[a].priorityDesc,visitTypeCode:i.servicepostingList[a].priority,requestedByEmpName:i.servicepostingList[a].requestedByEmpName,requestedByEmpSeqID:i.servicepostingList[a].requestedByEmpSeqID,requestedByEmpType:i.servicepostingList[a].requestedByEmpCode,servicePayerAuthorization:i.servicepostingList[a].servicePayerAuthorization,payerType:i.servicepostingList[a].payer,payerTypeCode:i.servicepostingList[a].payerId,payerCompSeqId:i.servicepostingList[a].payerCompSeqId,payerCompPlanseqId:i.servicepostingList[a].payerCompPlanseqId,insurancePlanSeqId:null!=i.servicepostingList[a].insurancePlanSeqId&&null!=i.servicepostingList[a].insurancePlanSeqId?i.servicepostingList[a].insurancePlanSeqId:void 0,actualRate:i.servicepostingList[a].actualRate,quantity:i.servicepostingList[a].quantity,isPostBillApplicable:i.servicepostingList[a].isPostBillApplicable?i.servicepostingList[a].isPostBillApplicable:0,patientAmount:i.servicepostingList[a].companyNonPayingAmt,payerAmount:i.servicepostingList[a].companyPayingAmt,originalPatientAmount:null==i.servicepostingList[a].companyPayingAmt||0==i.servicepostingList[a].companyPayingAmt?i.servicepostingList[a].serviceRate*i.servicepostingList[a].quantity:parseFloat(i.servicepostingList[a].companyPayingAmt)>i.servicepostingList[a].serviceRate?parseFloat(0):parseFloat(i.servicepostingList[a].companyPayingAmt)+e>=i.servicepostingList[a].actualRate?parseFloat(0):parseFloat((i.servicepostingList[a].actualRate-parseFloat(i.servicepostingList[a].companyPayingAmt)).toFixed(2))-e,originalPayerAmount:null==i.servicepostingList[a].companyPayingAmt||0==i.servicepostingList[a].companyPayingAmt?parseFloat(0):parseFloat(i.servicepostingList[a].companyPayingAmt)>i.servicepostingList[a].serviceRate?i.servicepostingList[a].serviceRate*i.servicepostingList[a].quantity:parseFloat(i.servicepostingList[a].companyPayingAmt)+e>=i.servicepostingList[a].actualRate?i.servicepostingList[a].serviceRate:i.servicepostingList[a].companyPayingAmt+e>i.servicepostingList[a].serviceRate?i.servicepostingList[a].serviceRate:i.servicepostingList[a].companyPayingAmt+e,discountAmt:i.servicepostingList[a].discountAmt,doctorAmount:i.servicepostingList[a].doctorAmount,doctorShare:i.servicepostingList[a].doctorShare,hospitalShare:i.servicepostingList[a].hospitalShare,isRateEditable:i.servicepostingList[a].serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,minValue:i.servicepostingList[a].serviceRateVo.minValue,maxValue:i.servicepostingList[a].serviceRateVo.maxValue,fromTariffRate:i.servicepostingList[a].visitConfigOrRateCard,serviceRate:i.servicepostingList[a].serviceRate,serviceRateStatus:i.servicepostingList[a].serviceRateStatus,standardDoctorShare:i.servicepostingList[a].standardDoctorShare,technicianAmount:i.servicepostingList[a].technicianAmount,baseRate:i.servicepostingList[a].baseRate,gnFlow:i.servicepostingList[a].gnFlow,billStatus:i.servicepostingList[a].billStatus,appointReason:i.servicepostingList[a].appointReason,transType:i.servicepostingList[a].transType,isComingFromOPPharmacy:i.servicepostingList[a].isComingFromOPPharmacy,servicePostingType:i.servicepostingList[a].servicePostingType,servicePostingCacelReason:i.servicepostingList[a].servicePostingCacelReason,priServTypCode:i.servicepostingList[a].serviceVo.secServTypeCode,deptCode:null!=i.servicepostingList[a].serviceVo&&null!=i.servicepostingList[a].serviceVo.atomicDetailsVo&&null!=i.servicepostingList[a].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=i.servicepostingList[a].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=i.servicepostingList[a].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=i.servicepostingList[a].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster&&null!=i.servicepostingList[a].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code?i.servicepostingList[a].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].departmentMaster.code:void 0,specilityCode:null!=i.servicepostingList[a].serviceVo&&null!=i.servicepostingList[a].serviceVo.atomicDetailsVo&&null!=i.servicepostingList[a].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList&&null!=i.servicepostingList[a].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]&&null!=i.servicepostingList[a].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"]&&null!=i.servicepostingList[a].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode&&null!=i.servicepostingList[a].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]&&null!=i.servicepostingList[a].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"]&&null!=i.servicepostingList[a].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code?i.servicepostingList[a].serviceVo.atomicDetailsVo.scmMasterServiceDeptSpeclVoList[0]["com.napier.core.scm.master.vo.ServiceDepartmentSpecailityLinkVo"].specialityCode[0]["com.napier.core.service.vo.masters.SpecialityMaster"].code:void 0,isPharmacyService:i.servicepostingList[a].isPharmacyService,refTranSeqID:i.servicepostingList[a].refTranSeqID,packageServiceCancelReason:i.servicepostingList[a].packageServiceCancelReason,pharamcyIssueServSeqId:i.servicepostingList[a].pharamcyIssueServSeqId}],i.servicepostingList[a].multiEmployeeShareList)if((l=i.servicepostingList[a].multiEmployeeShareList).employeeShareList&&l.employeeShareList[0])if((p=l.employeeShareList[0])["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"]){var o=p["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"];if(Array.isArray(o))for(var n=0;n<o.length;n++)2==o[n].entityType&&(i.rows[0].billedShare=o[n].billedShare,i.rows[0].proposedShare=o[n].proposedShare,i.rows[0].employeeShareSeqId=o[n].employeeShareSeqId);else i.rows[0].billedShare=o.billedShare,i.rows[0].proposedShare=o.proposedShare,i.rows[0].employeeShareSeqId=o.employeeShareSeqId}i.RowsArr.unshift(i.rows),i.counter++}else if(1==i.servicepostingList[a].gnTranStatus){var c={INCL_SERV_SEQ_ID:i.servicepostingList[a].serviceVo.servSeqId,SERV_CODE:i.servicepostingList[a].serviceVo.servCode,SERV_NAME:i.servicepostingList[a].serviceVo.servName,SERV_SEQ_ID:i.servicepostingList[a].serviceVo.servSeqId,serviceDoc:i.servicepostingList[a].requestedByEmpSeqID,parentSeqId:i.servicepostingList[a].parentSpSeqId,servicePostingSeqId:i.servicepostingList[a].servicePostingSeqId,servicePostingType:i.servicepostingList[a].servicePostingType,INCL_AMOUNT:i.servicepostingList[a].serviceRate};i.retrivePacServObj.push(c),s.parentSeqId=i.servicepostingList[a].parentSpSeqId;var l,p,d={};if(d.serviceTypeCODE=i.servicepostingList[a].serviceVo.priServTypCode,d.servicePostingSeqId=i.servicepostingList[a].servicePostingSeqId,d.serviceType=i.servicepostingList[a].priTypeDesc,d.servCode=i.servicepostingList[a].serviceVo.servCode,d.servName=i.servicepostingList[a].serviceVo.servName,d.servSeqId=i.servicepostingList[a].serviceVo.servSeqId,d.gnServDesign=i.servicepostingList[a].serviceVo.gnServDesign,d.servicePayerAuthorization=i.servicepostingList[a].servicePayerAuthorization,d.visistType=i.servicepostingList[a].priorityDesc,d.visitTypeCode=i.servicepostingList[a].priority,d.transType=i.servicepostingList[a].transType,d.parentSpSeqId=i.servicepostingList[a].parentSpSeqId,d.requestedByEmpName=i.servicepostingList[a].requestedByEmpName,d.requestedByEmpSeqID=i.servicepostingList[a].requestedByEmpSeqID,d.requestedByEmpType=i.servicepostingList[a].requestedByEmpCode,d.payerType=i.servicepostingList[a].payer,d.payerTypeCode=i.servicepostingList[a].payerId,d.actualRate=i.servicepostingList[a].actualRate,d.quantity=i.servicepostingList[a].quantity,d.insurancePlanSeqId=null!=i.servicepostingList[a].insurancePlanSeqId&&null!=i.servicepostingList[a].insurancePlanSeqId?i.servicepostingList[a].insurancePlanSeqId:void 0,d.patientAmount=i.servicepostingList[a].companyNonPayingAmt,d.payerAmount=i.servicepostingList[a].companyPayingAmt,d.originalPatientAmount=null==i.servicepostingList[a].companyPayingAmt||0==i.servicepostingList[a].companyPayingAmt?i.servicepostingList[a].serviceRate*i.servicepostingList[a].quantity:parseFloat(i.servicepostingList[a].companyPayingAmt)>i.servicepostingList[a].serviceRate?parseFloat(0):parseFloat(i.servicepostingList[a].companyPayingAmt)+e>=i.servicepostingList[a].actualRate?parseFloat(0):parseFloat((i.servicepostingList[a].serviceRate-parseFloat(i.servicepostingList[a].companyPayingAmt)).toFixed(2))-e,d.originalPayerAmount=null==i.servicepostingList[a].companyPayingAmt||0==i.servicepostingList[a].companyPayingAmt?parseFloat(0):parseFloat(i.servicepostingList[a].companyPayingAmt)>i.servicepostingList[a].serviceRate?i.servicepostingList[a].serviceRate:parseFloat(i.servicepostingList[a].companyPayingAmt)+e>=i.servicepostingList[a].actualRate?i.servicepostingList[a].serviceRate*i.servicepostingList[a].quantity:i.servicepostingList[a].companyPayingAmt+e>i.servicepostingList[a].serviceRate?i.servicepostingList[a].serviceRate:i.servicepostingList[a].companyPayingAmt+e,d.discountAmt=i.servicepostingList[a].discountAmt,d.doctorAmount=i.servicepostingList[a].doctorAmount,d.doctorShare=i.servicepostingList[a].doctorShare,d.hospitalShare=i.servicepostingList[a].hospitalShare,d.isRateEditable=i.servicepostingList[a].serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,d.serviceRate=i.servicepostingList[a].serviceRate,d.serviceRateStatus=i.servicepostingList[a].serviceRateStatus,d.standardDoctorShare=i.servicepostingList[a].standardDoctorShare,d.technicianAmount=i.servicepostingList[a].technicianAmount,d.baseRate=i.servicepostingList[a].baseRate,d.gnFlow=i.servicepostingList[a].gnFlow,d.pharamcyIssueServSeqId=i.servicepostingList[a].pharamcyIssueServSeqId,d.isPackage=2,d.packApplyType=2,i.servicepostingList[a].serviceRateVo&&i.servicepostingList[a].serviceRateVo.tariffSeqId&&(d.tariffSeqId=i.servicepostingList[a].serviceRateVo.tariffSeqId),i.servicepostingList[a].multiEmployeeShareList)if((l=i.servicepostingList[a].multiEmployeeShareList).employeeShareList&&l.employeeShareList[0])if((p=l.employeeShareList[0])["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"]){o=p["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"];if(Array.isArray(o))for(n=0;n<o.length;n++)2==o[n].entityType&&(d.billedShare=o[n].billedShare,d.proposedShare=o[n].proposedShare,d.employeeShareSeqId=o[n].employeeShareSeqId,d.docempSeqId=o[n].employee?o[n].employee.empSeqId:void 0);else d.billedShare=o.billedShare,d.proposedShare=o.proposedShare,d.employeeShareSeqId=o.employeeShareSeqId,d.docempSeqId=o.employee?o.employee.empSeqId:void 0}i.packageServicesArrayObejct.push(d)}}i.retrivePackageServObj[s.parentSeqId]=i.retrivePacServObj}e&&i.getAppoinmentDetailstoOrder(),i.showOrderLoadingIcon=!1})},i.changeDeductible=function(){if(i.gbcal.deductibleAmount=i.gbcal.deductibleAmount?i.gbcal.deductibleAmount:0,parseFloat(i.gbcal.Payr_Amt)<=parseFloat(i.gbcal.deductibleAmount))return i.gbcal.deductibleAmount=parseFloat(i.gbcal.Payr_Amt),i.gbcal.Payr_Amt=0,i.gbcal.Pat_Amt=angular.copy(parseFloat(i.Pat_Amt)+parseFloat(i.gbcal.deductibleAmount)).toFixed(2),i.gbcal.deductibleAmount=parseFloat(i.gbcal.deductibleAmount),i.gbcal.Payr_Amt=parseFloat(i.gbcal.Payr_Amt),void(i.gbcal.Pat_Amt=parseFloat(i.gbcal.Pat_Amt));parseFloat(i.gbcal.Total_Bill)>=parseFloat(i.gbcal.deductibleAmount)&&(i.gbcal.Payr_Amt=angular.copy(parseFloat(i.Payr_Amt)-parseFloat(i.gbcal.deductibleAmount)).toFixed(2),i.gbcal.Pat_Amt=angular.copy(parseFloat(i.Pat_Amt)+parseFloat(i.gbcal.deductibleAmount)).toFixed(2),i.gbcal.Pat_Amt=parseFloat(i.gbcal.Pat_Amt)),i.gbcal.deductibleAmount=parseFloat(i.gbcal.deductibleAmount),i.gbcal.Payr_Amt=parseFloat(i.gbcal.Payr_Amt),i.gbcal.Pat_Amt=parseFloat(i.gbcal.Pat_Amt)},i.orderSave=function(e){var t,r,a,o,n,c,l,p,d,m,u,S,y,D,g,A,h,R,f,C,b=[];i.showOrderLoadingIcon=!0;var q=new Date,O=moment(q).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z",L={};L.url=N.updateService.URL;sessionStorage.getItem("orderEncounterNo");var V,_=sessionStorage.getItem("orderregSeqId"),w=3,M=!1,F="",B=1,x=0,G=0,U=0,Q=!!i.projSpecApplicable&&i.projSpecApplicable,k=void 0,H=void 0,j=void 0;if(i.regTypeData&&i.regTypeData.encounterType&&3==i.regTypeData.encounterType)var Y=3;else Y=2;i.packageServicesArrayObejct=[];for(var W=0;W<i.RowsArr.length;W++){var $=2,z="",J=i.RowsArr[W][0].serviceTypeCODE;f=i.RowsArr[W][0].fromTariffRate,V=void 0;var Z=null==i.RowsArr[W][0].isPharmacyService||"Pharmacy Issues"!=i.RowsArr[W][0].isPharmacyService&&"Pharmacy Retruns"!=i.RowsArr[W][0].isPharmacyService?"N":"Y";1==J?(2==i.RowsArr[W][0].gnServDesign&&($=1,w=3,M=!0,z=i.RowsArr[W][0].isPrintToBill,angular.extend(i.packageServicesArrayObejct,i.RowsArr[W][0].packageServicesList)),a=i.RowsArr[W][0].servicePostingSeqId,o=i.RowsArr[W][0].servSeqId,n=i.RowsArr[W][0].requestedByEmpSeqID,c=i.RowsArr[W][0].requestedByEmpName,l=i.RowsArr[W][0].requestedByEmpType,p=i.RowsArr[W][0].quantity,d="Y"!=Z||null!=i.RowsArr[W][0].baseRate&&0!=i.RowsArr[W][0].baseRate?i.RowsArr[W][0].baseRate:i.RowsArr[W][0].serviceRate,i.RowsArr[W][0].gnFlow,m=i.RowsArr[W][0].facilityId,u=i.RowsArr[W][0].serviceRate,S="Y"!=Z||null!=i.RowsArr[W][0].actualRate&&0!=i.RowsArr[W][0].actualRate?i.RowsArr[W][0].actualRate:i.RowsArr[W][0].serviceRate,h=i.RowsArr[W][0].technicianAmount,y=i.RowsArr[W][0].doctorAmount,D=i.RowsArr[W][0].proposedShareAfterDiscount,null!=i.RowsArr[W][0].preAuthDone?i.RowsArr[W][0].patientAmount:null!=i.RowsArr[W][0].originalPayerAmount?parseFloat(i.RowsArr[W][0].originalPayerAmount)>i.RowsArr[W][0].actualRate?parseFloat(0):i.RowsArr[W][0].actualRate-parseFloat(i.RowsArr[W][0].originalPayerAmount):i.RowsArr[W][0].patientAmount,null!=i.RowsArr[W][0].preAuthDone?i.RowsArr[W][0].originalPayerAmount:null!=i.RowsArr[W][0].originalPayerAmount?parseFloat(i.RowsArr[W][0].originalPayerAmount)>i.RowsArr[W][0].actualRate?i.RowsArr[W][0].actualRate:i.RowsArr[W][0].originalPayerAmount:i.RowsArr[W][0].payerAmount,g=i.RowsArr[W][0].discountAmt,A=i.RowsArr[W][0].doctorShare,h=i.RowsArr[W][0].technicianAmount,R=i.RowsArr[W][0].payerTypeCode,F=i.RowsArr[W][0].appointReason,B=i.RowsArr[W][0].transType,x=i.RowsArr[W][0].proposedShare,G=i.RowsArr[W][0].billedShare,U=i.RowsArr[W][0].employeeShareSeqId,C=i.RowsArr[W][0].grpMstCode?i.RowsArr[W][0].grpMstCode:void 0,k=i.RowsArr[W][0].priServTypCode,H=i.RowsArr[W][0].deptCode,j=i.RowsArr[W][0].specilityCode,V=i.RowsArr[W][0].preAuthDone,t=i.RowsArr[W][0].updateServiceFlag,r=i.RowsArr[W][0].doctorModifiedAmount):null!=i.serviceTypeModel.serviceType&&108==i.serviceTypeModel.serviceType.CODE||(2==i.RowsArr[W][0].gnServDesign&&($=1,w=3,M=!0,z=i.RowsArr[W][0].isPrintToBill,angular.extend(i.packageServicesArrayObejct,i.RowsArr[W][0].packageServicesList)),a=i.RowsArr[W][0].servicePostingSeqId,o=i.RowsArr[W][0].servSeqId,n=i.RowsArr[W][0].requestedByEmpSeqID,c=i.RowsArr[W][0].requestedByEmpName,l=i.RowsArr[W][0].requestedByEmpType,p=i.RowsArr[W][0].quantity,d="Y"!=Z||null!=i.RowsArr[W][0].baseRate&&0!=i.RowsArr[W][0].baseRate?i.RowsArr[W][0].baseRate:i.RowsArr[W][0].serviceRate,i.RowsArr[W][0].gnFlow,m=i.RowsArr[W][0].facilityId,u=i.RowsArr[W][0].serviceRate,S=null==i.RowsArr[W][0].actualRate?i.RowsArr[W][0].serviceRate:"Y"!=Z||null!=i.RowsArr[W][0].actualRate&&0!=i.RowsArr[W][0].actualRate?i.RowsArr[W][0].actualRate:i.RowsArr[W][0].serviceRate,h=i.RowsArr[W][0].technicianAmount,y=i.RowsArr[W][0].doctorAmount,D=i.RowsArr[W][0].proposedShareAfterDiscount,null!=i.RowsArr[W][0].preAuthDone?parseFloat(i.RowsArr[W][0].originalPayerAmount)>S?parseFloat(0):S-parseFloat(i.RowsArr[W][0].originalPayerAmount):i.RowsArr[W][0].patientAmount,null!=i.RowsArr[W][0].preAuthDone?parseFloat(i.RowsArr[W][0].originalPayerAmount)>S?S:i.RowsArr[W][0].originalPayerAmount:i.RowsArr[W][0].payerAmount,g=i.RowsArr[W][0].discountAmt,A=i.RowsArr[W][0].doctorShare,h=i.RowsArr[W][0].technicianAmount,R=i.RowsArr[W][0].payerTypeCode,F=i.RowsArr[W][0].appointReason,B=i.RowsArr[W][0].transType,x=i.RowsArr[W][0].proposedShare,G=i.RowsArr[W][0].billedShare,U=i.RowsArr[W][0].employeeShareSeqId,C=i.RowsArr[W][0].grpMstCode?i.RowsArr[W][0].grpMstCode:void 0,k=i.RowsArr[W][0].priServTypCode,H=i.RowsArr[W][0].deptCode,j=i.RowsArr[W][0].specilityCode,V=i.RowsArr[W][0].preAuthDone,t=i.RowsArr[W][0].updateServiceFlag,r=i.RowsArr[W][0].doctorModifiedAmount);var K=i.RowsArr[W][0].servicePostingType?i.RowsArr[W][0].servicePostingType:1;if(null!=a){var X={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",updateServicePostingFlag:!t&&void 0,servicePostingSeqId:a,isPharmacyService:Z,accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:K,isPackage:$,packApplyType:w,specific:Q,parentServSeqId:1==$?o:void 0,lbSeqId:i.RowsArr[W][0].lbSeqId?i.RowsArr[W][0].lbSeqId:void 0,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:o},requestedByEmpSeqID:n,requestedByEmpName:c,requestedByEmpType:l,requestedDateTime:O,quantity:p,isPostBillApplicable:i.RowsArr[W][0].isPostBillApplicable?i.RowsArr[W][0].isPostBillApplicable:0,primaryServiceCode:k,specilityCode:j,deptCode:H,serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:o,baseRate:d,tariffSeqId:i.RowsArr[W][0].payerTarrifId?i.RowsArr[W][0].payerTarrifId:s.tariffSeqId,datedOn:O,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},enNo:sessionStorage.getItem("ordervisitId"),enSeqId:sessionStorage.getItem("orderencounterSeqId"),patientCategoryCode:sessionStorage.getItem("patcatg"),facilityId:m,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnTranStatus:3==K?2:1,gnFlow:Y,surcharge:0,serviceRate:u,baseRate:d,actualRate:S,currentChargableAmt:parseFloat(parseFloat(S/p).toFixed(2)),technicianAmount:h,doctorAmount:y,proposedShareAfterDiscount:D,doctorModifiedAmount:r||0,chargeableAmt:parseFloat(parseFloat(S/p).toFixed(2)),nonChargableAmt:void 0,companyNonPayingAmt:a?V?i.RowsArr[W][0].originalPatientAmount:i.RowsArr[W][0].patientAmount:void 0,companyPayingAmt:a?V?i.RowsArr[W][0].originalPayerAmount:i.RowsArr[W][0].payerAmount:void 0,discountAmt:g,doctorShare:A,isEmergency:2,renderFlagcheck:!0,payerId:R,insurancePlanSeqId:null!=i.RowsArr[W][0].insurancePlanSeqId&&null!=i.RowsArr[W][0].insurancePlanSeqId?i.RowsArr[W][0].insurancePlanSeqId:void 0,refTranSeqID:i.RowsArr[W][0].lbSeqId?i.RowsArr[W][0].lbSeqId:i.RowsArr[W][0].refTranSeqID,fromOPVisit:"Y",priority:i.RowsArr[W][0].visitTypeCode,isPrintToBill:z,visitConfigOrRateCard:f,opApmntSeqId:i.RowsArr[W][0].opApmntSeqId?i.RowsArr[W][0].opApmntSeqId:void 0,appointReason:F,transType:B,multiEmployeeShareList:{"@class":"com.napier.core.scm.serviceposting.vo.EmployeeShareListVo",employeeShareList:[{"com.napier.core.scm.serviceposting.vo.EmployeeShareVo":[{"@class":"com.napier.core.scm.serviceposting.vo.EmployeeShareVo",employee:{category:"001",code:c,empSeqId:n,facilityId:angular.fromJson(sessionStorage.userContextObj).FACILITY_ID,gnStatus:1},entityType:2,employeeShareSeqId:U,billedShare:G,proposedShare:x,gnTranStatus:1,grpMstCode:C||void 0}]}]}};b.push(X)}else{X={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",updateServicePostingFlag:!1,servicePostingSeqId:a,isPharmacyService:Z,accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,isPackage:$,packApplyType:w,specific:Q,parentServSeqId:1==$?o:void 0,lbSeqId:i.RowsArr[W][0].lbSeqId?i.RowsArr[W][0].lbSeqId:void 0,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:o},requestedByEmpSeqID:n,requestedByEmpName:c,requestedByEmpType:l,requestedDateTime:O,quantity:p,isPostBillApplicable:i.RowsArr[W][0].isPostBillApplicable?i.RowsArr[W][0].isPostBillApplicable:0,primaryServiceCode:k,specilityCode:j,deptCode:H,serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:o,baseRate:d,tariffSeqId:i.RowsArr[W][0].payerTarrifId?i.RowsArr[W][0].payerTarrifId:s.tariffSeqId,datedOn:O,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},enNo:sessionStorage.getItem("ordervisitId"),enSeqId:sessionStorage.getItem("orderencounterSeqId"),patientCategoryCode:sessionStorage.getItem("patcatg"),facilityId:m,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnTranStatus:1,gnFlow:Y,surcharge:0,serviceRate:u,baseRate:d,actualRate:S,currentChargableAmt:parseFloat(parseFloat(S/p).toFixed(2)),technicianAmount:h,doctorAmount:y,proposedShareAfterDiscount:D,doctorModifiedAmount:r||0,chargeableAmt:parseFloat(parseFloat(S/p).toFixed(2)),companyNonPayingAmt:a?V?i.RowsArr[W][0].originalPatientAmount:i.RowsArr[W][0].patientAmount:void 0,companyPayingAmt:a?V?i.RowsArr[W][0].originalPayerAmount:i.RowsArr[W][0].payerAmount:void 0,nonChargableAmt:void 0,discountAmt:g,doctorShare:A,isEmergency:2,renderFlagcheck:!0,payerId:R,insurancePlanSeqId:null!=i.RowsArr[W][0].insurancePlanSeqId&&null!=i.RowsArr[W][0].insurancePlanSeqId?i.RowsArr[W][0].insurancePlanSeqId:void 0,refTranSeqID:i.RowsArr[W][0].lbSeqId?i.RowsArr[W][0].lbSeqId:i.RowsArr[W][0].refTranSeqID,fromOPVisit:"Y",priority:i.RowsArr[W][0].visitTypeCode,isPrintToBill:z,visitConfigOrRateCard:f,opApmntSeqId:i.RowsArr[W][0].opApmntSeqId?i.RowsArr[W][0].opApmntSeqId:void 0,appointReason:F,transType:B,multiEmployeeShareList:{"@class":"com.napier.core.scm.serviceposting.vo.EmployeeShareListVo",employeeShareList:[{"com.napier.core.scm.serviceposting.vo.EmployeeShareVo":[{"@class":"com.napier.core.scm.serviceposting.vo.EmployeeShareVo",employee:{category:"001",code:c,empSeqId:n,facilityId:angular.fromJson(sessionStorage.userContextObj).FACILITY_ID,gnStatus:1},entityType:2,billedShare:G,proposedShare:x,gnTranStatus:1,grpMstCode:C||void 0}]}]}};b.push(X)}}if(M){for(var ee=0;ee<i.packageServicesArrayObejct.length;ee++){X={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",updateServicePostingFlag:!1,servicePostingSeqId:i.packageServicesArrayObejct[ee].servicePostingSeqId,isPharmacyService:Z,accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:i.packageServicesArrayObejct[ee].servicePostingType?i.packageServicesArrayObejct[ee].servicePostingType:1,specific:Q,isPackage:i.packageServicesArrayObejct[ee].isPackage,packApplyType:i.packageServicesArrayObejct[ee].packApplyType,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.packageServicesArrayObejct[ee].servSeqId},requestedByEmpSeqID:i.packageServicesArrayObejct[ee].requestedByEmpSeqID,requestedByEmpName:i.packageServicesArrayObejct[ee].requestedByEmpName,requestedByEmpType:i.packageServicesArrayObejct[ee].requestedByEmpType,requestedDateTime:O,quantity:p,isPostBillApplicable:i.packageServicesArrayObejct[ee].isPostBillApplicable?i.packageServicesArrayObejct[ee].isPostBillApplicable:0,primaryServiceCode:k,specilityCode:j,deptCode:H,serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.packageServicesArrayObejct[ee].servSeqId,baseRate:i.packageServicesArrayObejct[ee].baseRate,tariffSeqId:i.packageServicesArrayObejct[ee].tariffSeqId?i.packageServicesArrayObejct[ee].tariffSeqId:s.tariffSeqId,datedOn:O,fromOPVisit:"Y",doctSeqId:i.packageServicesArrayObejct[ee].requestedByEmpSeqID,specSeqId:i.packageServicesArrayObejct[ee].specilityCode?i.packageServicesArrayObejct[ee].specilityCode:void 0},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},enNo:sessionStorage.getItem("ordervisitId"),enSeqId:sessionStorage.getItem("orderencounterSeqId"),patientCategoryCode:sessionStorage.getItem("patcatg"),facilityId:i.packageServicesArrayObejct[ee].facilityId,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnTranStatus:1,gnFlow:Y,surcharge:0,serviceRate:i.packageServicesArrayObejct[ee].serviceRate,baseRate:i.packageServicesArrayObejct[ee].baseRate,actualRate:i.packageServicesArrayObejct[ee].actualRate,currentChargableAmt:parseFloat(parseFloat(i.packageServicesArrayObejct[ee].actualRate/p).toFixed(2)),technicianAmount:i.packageServicesArrayObejct[ee].technicianAmount,doctorAmount:i.packageServicesArrayObejct[ee].doctorAmount,proposedShareAfterDiscount:i.packageServicesArrayObejct[ee].proposedShareAfterDiscount,doctorModifiedAmount:r||0,chargeableAmt:i.packageServicesArrayObejct[ee].patientAmount,nonChargableAmt:i.packageServicesArrayObejct[ee].payerAmount,discountAmt:i.packageServicesArrayObejct[ee].discountAmt,doctorShare:i.packageServicesArrayObejct[ee].doctorShare,isEmergency:2,renderFlagcheck:!0,payerId:i.packageServicesArrayObejct[ee].payerTypeCode,insurancePlanSeqId:null!=i.packageServicesArrayObejct[ee].insurancePlanSeqId&&null!=i.packageServicesArrayObejct[ee].insurancePlanSeqId?i.packageServicesArrayObejct[ee].insurancePlanSeqId:void 0,fromOPVisit:"Y",priority:i.packageServicesArrayObejct[ee].visitTypeCode,isPrintToBill:"",visitConfigOrRateCard:f,appointReason:i.packageServicesArrayObejct[ee].appointReason,transType:i.packageServicesArrayObejct[ee].transType,parentServSeqId:i.packageServicesArrayObejct[ee].parentServSeqId,multiEmployeeShareList:{"@class":"com.napier.core.scm.serviceposting.vo.EmployeeShareListVo",employeeShareList:[{"com.napier.core.scm.serviceposting.vo.EmployeeShareVo":[{"@class":"com.napier.core.scm.serviceposting.vo.EmployeeShareVo",employee:{category:"001",empSeqId:i.packageServicesArrayObejct[ee].docempSeqId?i.packageServicesArrayObejct[ee].docempSeqId:i.packageServicesArrayObejct[ee].requestedByEmpSeqID},entityType:2,billedShare:i.packageServicesArrayObejct[ee].billedShare,proposedShare:i.packageServicesArrayObejct[ee].proposedShare,gnTranStatus:1,grpMstCode:i.packageServicesArrayObejct[ee].grpMstCode?i.packageServicesArrayObejct[ee].grpMstCode:void 0}]}]}};b.push(X)}for(var te=0;te<i.retrivePackageDeletedServObj.length;te++){X={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",updateServicePostingFlag:!1,servicePostingSeqId:i.retrivePackageDeletedServObj[te].servicePostingSeqId,isPharmacyService:Z,accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:i.retrivePackageDeletedServObj[0].servicePostingType?i.retrivePackageDeletedServObj[0].servicePostingType:1,specific:Q,isPackage:i.packageServicesArrayObejct[0].isPackage,packApplyType:i.packageServicesArrayObejct[0].packApplyType,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:i.retrivePackageDeletedServObj[te].INCL_SERV_SEQ_ID},requestedByEmpSeqID:i.retrivePackageDeletedServObj[te].serviceDoc,requestedByEmpType:4,requestedDateTime:O,quantity:p,isPostBillApplicable:i.retrivePackageDeletedServObj[te].isPostBillApplicable?i.retrivePackageDeletedServObj[te].isPostBillApplicable:0,primaryServiceCode:k,specilityCode:j,deptCode:H,serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:i.retrivePackageDeletedServObj[te].INCL_SERV_SEQ_ID,baseRate:i.retrivePackageDeletedServObj[te].INCL_AMOUNT,tariffSeqId:s.tariffSeqId,datedOn:O,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},enNo:sessionStorage.getItem("ordervisitId"),enSeqId:sessionStorage.getItem("orderencounterSeqId"),patientCategoryCode:sessionStorage.getItem("patcatg"),facilityId:i.retrivePackageDeletedServObj[te].facilityId,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnTranStatus:2,gnFlow:Y,surcharge:0,serviceRate:i.retrivePackageDeletedServObj[te].INCL_AMOUNT,baseRate:i.retrivePackageDeletedServObj[te].INCL_AMOUNT,actualRate:i.retrivePackageDeletedServObj[te].INCL_AMOUNT,chargeableAmt:i.retrivePackageDeletedServObj[te].INCL_AMOUNT,currentChargableAmt:parseFloat(parseFloat(i.retrivePackageDeletedServObj[te].INCL_AMOUNT).toFixed(2)),isEmergency:2,renderFlagcheck:!0,payerId:i.packageServicesArrayObejct[0].payerTypeCode,fromOPVisit:"Y",priority:i.packageServicesArrayObejct[0].visitTypeCode,isPrintToBill:"",visitConfigOrRateCard:f,parentServSeqId:i.retrivePackageDeletedServObj[te].parentSeqId};b.push(X)}}L.requestData={operation:"saveOrUpdateServicePosting",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":b}]}},P.sendRestRequest(L).then(function(t){if(i.showOrderLoadingIcon=!1,""==t.data.HITService.message||null==t.data.HITService.message.subAccSeqId)v.warning("Failure","Order Saving Failed",!1,!1,me.time);else if("HSC"===sessionStorage.productCustomization){I.executeQueryURLReset();i.accountSeqList=new Array,i.checkListServSeqId=[];var r="";try{if(null!=(p=t.data.HITService.message.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"]).length)for(var a=0;a<p.length;a++)i.checkListServSeqId.push(p[a].serviceVo.servSeqId);else r=p.serviceVo.servSeqId;i.checkListServSeqId.length>1&&(r=i.checkListServSeqId.join(","));var o={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"PKG_CHKLIST_MASTER_DTLS_COUNT",idxList:[{"com.napier.core.service.vo.query.Index":[{paramName:"pServiceSeqID",value:r}]}]}]}]},n={};n.url=N.patientAdvSservice.URL,n.requestData={operation:"ExecuteQuery",messageId:"",destination:"QueryService",message:o},P.sendRestRequest(n).then(function(e){var t=[],r=[];if(null!=e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"]){var a=e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"];if(null!=a.length){for(var o=0;o<a.length;o++)r.push(a[o].columnList[0]["com.napier.core.service.vo.query.Column"]);t=r}else t=a.columnList[0]["com.napier.core.service.vo.query.Column"]}for(o=0;o<t.length;o++)i.hscCheckListCount.push(t[o].data);i.checkListServSeqIdInner=null!=i.hscCheckListCount.length&&0!=i.hscCheckListCount.length?i.hscCheckListCount:t.data,Array.isArray(i.checkListServSeqIdInner)&&(i.checkListServSeqIdInner=i.checkListServSeqIdInner.join(","))})}catch(e){}var c={buttonClose:function(){i.packageServicesArrayObejct=new Array,i.activeFirst=3,T(function(){E.dismissAll(),i.getPrescptionCount()},3e3)}},l={buttonCallBack1:function(){E.dismissAll(),i.packageCheckListReprint()},buttonCallBack2:function(){i.generatePdfReport()}};if(v.hisAlertMulti("success","Success","Do you want to print orders?",{buttonText:"No",buttonText2:"Yes"},l,c),i.checkOrderSaved=!1,i.loadBillNumbers(s.mrNo),i.retriveRecords(),"Y"==i.integrationApplicableFlag){var p=t.data.HITService.message.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"],d="";if(Array.isArray(p))for(a=0;a<p.length;a++)d=0==a?p[a].servicePostingSeqId:d+","+p[a].servicePostingSeqId;else d=p.servicePostingSeqId;Array.isArray(p)||(p[0]=p),re.prepareOrderObject(d,p,_,"Admission","sendOrderFinalizedReportForRis","com.napier.his.integration.service.external.RisService",re).then(function(e){})}}else{if(null==e&&v.success("Success","Order Saved Successfully",!1,!1,me.time),i.preAuthBtnShow=0,i.preAuthBillNav=!1,i.packageServicesArrayObejct=new Array,"Y"==i.integrationApplicableFlag){p=t.data.HITService.message.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"],d="";if(Array.isArray(p))for(a=0;a<p.length;a++)d=0==a?p[a].servicePostingSeqId:d+","+p[a].servicePostingSeqId;else d=p.servicePostingSeqId;Array.isArray(p)||(p[0]=p),re.prepareOrderObject(d,p,_,"Admission","sendOrderFinalizedReportForRis","com.napier.his.integration.service.external.RisService",re).then(function(e){})}i.activeFirst=3,T(function(){E.dismissAll(),i.loadBillNumbers(s.mrNo),i.retriveRecords(),i.getPrescptionCount()},3e3)}})},i.loadServiceTypeCombo=function(){i.serviceTypeorder=[],i.serviceTypeOrderList={1:i.serviceTypeorder};var e=I.executeQueryURLReset();return i.serviceTypeListorder=new Array,I.executeQueryInput("OP_ORDERS_SERVICE_TYPE_QUERY_001",i.serviceTypeListorder,i.serviceTypeOrderList,!0,!0,e,"popUp",i.advSearch).then(function(e){var t=e[1];i.servicetypeComboObj=t})}(),i.popServiceChange=function(e){if(i.advserviceType=angular.copy(e),i.serviceTypeModel.serviceType=angular.copy(e),1!=i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID){i.PriorityCombo=[],i.PriorityComboList={1:i.PriorityCombo};var t=I.executeQueryURLReset();i.priorityCombosList=new Array,I.prepareParamList(1,850,i.priorityCombosList),I.executeQueryInput("TRN003",i.priorityCombosList,i.PriorityComboList,!0,!0,t,"popUp",{}).then(function(e){i.PriorityComboList=e[1],i.priorityvis.priorityTypeModel=i.PriorityComboList[0],i.hidepriorityTypeComboRef=!0,i.hidevisitTypeComboRef=!1})}else{sessionStorage.getItem("orderdoctSeqId"),sessionStorage.getItem("orderregSeqId");i.payerId,i.priorityvis.priorityTypeModel="",i.hidepriorityTypeComboRef=!1,i.hidevisitTypeComboRef=!0}i.priorityvis.visitTypeModel="New",i.loadSecondaryServiceTypeCombo()},i.loadSecondaryServiceTypeCombo=function(){i.secondayServiceTypeComboObj=[];var t=-999;if(null!=i.advserviceTypeModel.serviceType&&null!=i.advserviceTypeModel.serviceType.CODE){t=i.advserviceTypeModel.serviceType.CODE;var r=e.defer(),a={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"SCM_SERV_002",idxList:[{"com.napier.core.service.vo.query.Index":[{paramName:"pPracticeId",value:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID},{paramName:"pPriServTypeCode",value:t}]}]}]}]},o={};return o.url=N.patientAdvSservice.URL,o.requestData={operation:"ExecuteQuery",messageId:"",destination:"QueryService",message:a},P.sendRestRequest(o).then(function(e){var t=[],a=function(e){return e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"]}(e);if(Array.isArray(a))angular.forEach(a,function(e,r){var a=e.columnList[0]["com.napier.core.service.vo.query.Column"],i={CODE:a[0].data,DESCRIPTION:a[1].data};t.push(i)});else{var o=a.columnList[0]["com.napier.core.service.vo.query.Column"],s={CODE:o[0].data,DESCRIPTION:o[1].data};t.push(s)}r.resolve(t),i.secondayServiceTypeComboObj=t},function(e){}),r.promise}},i.orderServiceTypeAhead=function(e){var t="%"+e+"%";i.OPVMDoctroSearch=[],i.multipleComboDataForList={1:i.OPVMDoctroSearch};var r=I.executeQueryURLReset();i.OPVMDoctSearch=new Array;var a=2,o=1,n=1,c="-999",l=7,p=0;if(null!=i.serviceTypeModel.serviceType&&(p=i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID),i.serviceTypeModel.serviceType){var d="";(d=null!=i.advserviceType?i.advserviceType.CODE:"")&&""!=d||null==i.serviceTypeModel.serviceType||(d=i.serviceTypeModel.serviceType.CODE),3==p&&(a=2,o=2,n="",c="",l=""),I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.OPVMDoctSearch),I.prepareParamListWithParam("pFacilityId",angular.fromJson(sessionStorage.userContextObj).FACILITY_ID,i.OPVMDoctSearch),I.prepareParamListWithParam("pServCode","%%",i.OPVMDoctSearch),I.prepareParamListWithParam("pServName",t,i.OPVMDoctSearch),I.prepareParamListWithParam("pPriServTypeCode",d,i.OPVMDoctSearch),I.prepareParamListWithParam("pSecServTypeCode","",i.OPVMDoctSearch),I.prepareParamListWithParam("pServTypeCode","",i.OPVMDoctSearch),I.prepareParamListWithParam("pServDesign",o,i.OPVMDoctSearch),I.prepareParamListWithParam("pFlowElement",a,i.OPVMDoctSearch),I.prepareParamListWithParam("pServStatus","",i.OPVMDoctSearch),I.prepareParamListWithParam("pServDefStatus",n,i.OPVMDoctSearch),I.prepareParamListWithParam("pDepartment","",i.OPVMDoctSearch),I.prepareParamListWithParam("pIsEmergency",c,i.OPVMDoctSearch),I.prepareParamListWithParam("pExcludePri",l,i.OPVMDoctSearch),3!=p&&I.prepareParamListWithParam("pTariffCode",s.tariffSeqId,i.OPVMDoctSearch),(i.regTypeData&&2==i.regTypeData.RG_TYPE||i.opSearch&&2==i.opSearch.type)&&I.prepareParamListWithParam("pRgType",2,i.OPVMDoctSearch);try{let e;i.opSearch&&2==i.opSearch.type?e=i.tempPatForm.gender?i.tempPatForm.gender:void 0:s.patientGlobalDtlsNew&&s.patientGlobalDtlsNew[0].genderCode&&(e=s.patientGlobalDtlsNew[0].genderCode),I.prepareParamListWithParam("pGenderCode",e,i.OPVMDoctSearch)}catch(e){}return I.executeQueryInput("OP_SCM_SERVICE_LIST_WITH_OUT_RATES",i.OPVMDoctSearch,i.multipleComboDataForList,!0,!0,r,"popUp",{}).then(function(e){if(0!==e)return(e[1]instanceof Array?e[1]:[e[1]]).map(function(e){return e});i.noResults=!0})}i.OPVMDoctroSearchService=[],i.multipleComboDataForListService={1:i.OPVMDoctroSearchService};var m=[];I.prepareParamListWithParam("pServName",t,m),(i.regTypeData&&2==i.regTypeData.RG_TYPE||i.opSearch&&2==i.opSearch.type)&&I.prepareParamListWithParam("pRgType",2,m);try{let e;i.opSearch&&2==i.opSearch.type?e=i.tempPatForm.gender?i.tempPatForm.gender:void 0:s.patientGlobalDtlsNew&&s.patientGlobalDtlsNew[0].genderCode&&(e=s.patientGlobalDtlsNew[0].genderCode),I.prepareParamListWithParam("pGenderCode",e,m)}catch(e){}return I.executeQueryInput("OP_SCM_SERVICE_LIST_WITH_OUT_SERV_TYPE",m,i.multipleComboDataForListService,!0,!0,r,"popUp",{}).then(function(e){if(0!==e)return(Array.isArray(e[1])?e[1]:[e[1]]).map(function(e){return e});i.noResults=!0})},i.addSelectService=!0,i.AdvServiceSearch=function(e){if(!i.advserviceTypeModel.serviceType&&!i.advserviceTypeModel.secondayServiceType||!e&&!e.servicename&&!e.servicecode)return v.warning("Warning!","Please Select Atleast One Service Type",!1,!1,me.time),!1;i.addSelectService=!1;var t="%%",r="",a=-999,o=-999;e&&(e.servicename&&""!=e.servicename&&(t="%"+e.servicename+"%"),e.servicecode&&""!=e.servicecode&&(r="%"+e.servicecode+"%")),null!=i.advserviceTypeModel.serviceType&&(a=i.advserviceTypeModel.serviceType.CODE),null!=i.advserviceTypeModel.secondayServiceType&&(o=i.advserviceTypeModel.secondayServiceType.CODE),i.advServicename=[],i.advServicenamesList={1:i.advServicename};var n=0;i.serviceTypeModel.serviceType&&!i.serviceTypeModel.serviceType||(i.serviceTypeModel.serviceType=i.advserviceTypeModel.serviceType),null!=i.serviceTypeModel.serviceType&&(n=i.serviceTypeModel.serviceType.NH_OP_REASON_SEQ_ID);var c=I.executeQueryURLReset();if(i.advServiceList=new Array,3==n)return I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.advServiceList),I.prepareParamListWithParam("pFacilityId",ye,i.advServiceList),I.prepareParamListWithParam("pServCode",r,i.advServiceList),I.prepareParamListWithParam("pServName",t,i.advServiceList),I.prepareParamListWithParam("pServTypeCode","",i.advServiceList),I.prepareParamListWithParam("pPriServTypeCode",a,i.advServiceList),I.prepareParamListWithParam("pSecServTypeCode",o,i.advServiceList),I.prepareParamListWithParam("pServTypeCode","",i.advServiceList),I.prepareParamListWithParam("pServDesign",2,i.advServiceList),I.prepareParamListWithParam("pFlowElement",2,i.advServiceList),I.prepareParamListWithParam("pServStatus","",i.advServiceList),I.prepareParamListWithParam("pServDefStatus","",i.advServiceList),I.prepareParamListWithParam("pDepartment","",i.advServiceList),I.prepareParamListWithParam("pIsEmergency","",i.advServiceList),I.prepareParamListWithParam("pExcludePri","",i.advServiceList),(i.regTypeData&&2==i.regTypeData.RG_TYPE||i.opSearch&&2==i.opSearch.type)&&I.prepareParamListWithParam("pRgType",2,i.advServiceList),I.executeQueryInput("SCM_SERVICE_LIST_WITH_OUT_RATES_ALPHA",i.advServiceList,i.advServicenamesList,!0,!0,c,"popUp",{}).then(function(e){var t=e[1];i.AdvserviceGrid.data=[];for(var r=0;r<t.length;r++)i.AdvserviceGrid.data.push({CODE:t[r].CODE,DESCRIPTION:t[r].DESCRIPTION,SERV_CODE:t[r].SERV_CODE,SERV_NAME:t[r].SERV_NAME,SERV_SEQ_ID:t[r].SERV_SEQ_ID,VALUE:t[r].VALUE})});I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.advServiceList),I.prepareParamListWithParam("pFacilityId",ye,i.advServiceList),I.prepareParamListWithParam("pServCode",r,i.advServiceList),I.prepareParamListWithParam("pServName",t,i.advServiceList),I.prepareParamListWithParam("pPriServTypeCode",a,i.advServiceList),I.prepareParamListWithParam("pSecServTypeCode",o,i.advServiceList),I.prepareParamListWithParam("pServTypeCode","",i.advServiceList),I.prepareParamListWithParam("pServDesign","",i.advServiceList),I.prepareParamListWithParam("pFlowElement","2",i.advServiceList),I.prepareParamListWithParam("pServStatus","1",i.advServiceList),I.prepareParamListWithParam("pServDefStatus","1",i.advServiceList),I.prepareParamListWithParam("pDepartment","",i.advServiceList),I.prepareParamListWithParam("pIsEmergency","-999",i.advServiceList),I.prepareParamListWithParam("pExcludePri","7",i.advServiceList),I.prepareParamListWithParam("pTariffCode",s.tariffSeqId,i.advServiceList),(i.regTypeData&&2==i.regTypeData.RG_TYPE||i.opSearch&&2==i.opSearch.type)&&I.prepareParamListWithParam("pRgType",2,i.advServiceList);try{let e;i.opSearch&&2==i.opSearch.type?e=i.tempPatForm.gender?i.tempPatForm.gender:void 0:s.patientGlobalDtlsNew&&s.patientGlobalDtlsNew[0].genderCode&&(e=s.patientGlobalDtlsNew[0].genderCode),I.prepareParamListWithParam("pGenderCode",e,i.advServiceList)}catch(e){}return I.executeQueryInput("SCM_SERVICE_LIST_NEW_OP_ALPHA",i.advServiceList,i.advServicenamesList,!0,!0,c,"popUp",{}).then(function(e){var t=e[1];i.AdvserviceGrid.data=[];for(var r=0;r<t.length;r++)i.AdvserviceGrid.data.push({SERV_SEQ_ID:t[r].SERV_SEQ_ID,SERV_CODE:t[r].SERV_CODE,SERV_NAME:t[r].SERV_NAME,VALUE:t[r].VALUE,EFFECTIVE_FROM:t[r].EFFECTIVE_FROM,EFFECTIVE_TO:t[r].EFFECTIVE_TO,FA_IS_BILLABLE:t[r].FA_IS_BILLABLE,CODE:t[r].CODE,DESCRIPTION:t[r].DESCRIPTION,SSTCODE:t[r].SSTCODE,SSTDESC:t[r].SSTDESC,FA_IS_RATE_EDITABLE:t[r].FA_IS_RATE_EDITABLE})})},i.bookAppointment=function(){i.PatientAndDoctorData={orderDoctDetails:i.orderDoctDetails,PatientDetailsData:i.PatientDetailsData,PatientDetailsDataObj:i.PatientDetailsDataObj,redirectingFromOpVisit:"redirectingFromOpVisit"},sessionStorage.removeItem("PatientAndDoctorData"),sessionStorage.setItem("PatientAndDoctorData",JSON.stringify(i.PatientAndDoctorData)),i.PatientAndDoctorData={},i.modalInstance=S.open("Book Appointment",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popuervice-modals-popups",templateUrl:"app/consumer/his17_1/scheduler/screens/book-appointment/book.appointment.html",size:"xlg",controller:"bookAppointmentNewController",controllerAs:"bookAppointment",scope:i})},i.healhCheckUpExpanded=!1,i.healhCheckUpExpand=function(e){e.healhCheckUpExpanded=!e.healhCheckUpExpanded},i.healhCheckUpExpanded2=!1,i.healhCheckUpExpand2=function(){i.healhCheckUpExpanded2=!i.healhCheckUpExpanded2},i.mlcNumberGenerate=function(t){if(i.Mlc.OPVMmlcDetails=!0,i.submit=!1,""==i.tempMlcNum){var r=e.defer(),a={url:"HISServices/HISServices",requestData:{operation:"getMLCNo",messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.MLCDetailsVo"}}};P.sendRestRequest(a).then(function(e){var t=e.data.HITService.message;i.Mlc.OPVMmlcNo=t,i.tempMlcNum=t,i.mlcPopup(),r.resolve()})}else i.Mlc.OPVMmlcNo=i.tempMlcNum,i.mlcPopup()},i.setRefundRounding=function(){if(1==i.refund.mode){var e=ue.roundoff(i.refund.RefdAmt),t=parseFloat(e)-parseFloat(i.refund.RefdAmt);i.refund.RefdAmt=e,i.refund.roundOff=t.toFixed(2)}else i.refund.roundOff=0},i.calculateGBData=function(){if(i.gbBillNo.billno&&"Unbilled"==i.gbBillNo.billno)var e=i.gridgbOptionsApi.selection.getSelectedRows();else 0==(e=i.getActivebillRecords()).length&&(e=i.gridgbOptions.data);var t=i.gridgbdepOptionsApi.selection.getSelectedRows(),r=0,a=0,o=0,s=0,n=0,c=0,l=0,p=0,d=0,m=0,u=0,v=0,S=0,y=0,D=0,g=0,A=0,I=0,P=0,h=0,R=0,f=0,T=0,C=0,b=0,E=0,q=0,O=0,L=0,V=0;angular.forEach(e,function(e,t){7!=e.gnTranStatus&&7!=e.billStatus&&(e.baseRate&&e.quantity>0&&(r=parseFloat(r)+parseFloat(e.baseRate)*parseFloat(e.quantity),""!=e.discountAmt&&(a=parseFloat(a)+parseFloat(e.discountAmt)),""!=e.taxAmount&&(m=parseFloat(m)+parseFloat(e.taxAmount))),g=e.detableAmount?e.detableAmount:0,e.copayAmt&&(A+=e.copayAmt),e.PatAmt&&(u=parseFloat(u)+parseFloat(e.PatAmt)),e.payerAmt&&(v=parseFloat(v)+parseFloat(e.payerAmt)),null!=e.dueAmt&&0!=e.dueAmt&&0==l&&(l=parseFloat(l)+parseFloat(e.dueAmt)),null!=e.PaidAmt&&e.PaidAmt>0&&0==c&&(c=parseFloat(c)+parseFloat(e.PaidAmt)),e.depAdjAmt&&e.depAdjAmt>0&&0==o&&(o=parseFloat(o)+parseFloat(e.depAdjAmt)),0!=e.PatAmt&&0==e.payerAmt&&(D=parseFloat(D)+parseFloat(e.PatAmt)),null!=e.patientPaidAmnt&&e.patientPaidAmnt>0&&0==I&&(I=parseFloat(I)+parseFloat(e.patientPaidAmnt)),null!=e.payerPaidAmnt&&e.payerPaidAmnt>0&&0==P&&(P=parseFloat(P)+parseFloat(e.payerPaidAmnt))),null!=e.crNoteAmount&&0!=e.crNoteAmount&&0==f&&(f=parseFloat(e.crNoteAmount)),null!=e.concessionAmt&&0!=e.concessionAmt&&0==V&&(V=parseFloat(e.concessionAmt))}),T=parseFloat(u),C=parseFloat(v),b=parseFloat(T)+parseFloat(C),n=parseFloat(r)-parseFloat(a)+parseFloat(m),0==c&&0==l&&0==o&&0==V&&(l=n);var N=i.deductibleAmount;i.insurancePlanDedSeqId&&i.accountres&&1!=i.accountres.SUB_ACC_SEQ_ID||g>0?(N="Unbilled"==i.gbBillNo.billno?N||0:g||0,parseFloat(v)<=parseFloat(N)?(N=parseFloat(v),v=0,u=parseFloat(u)+parseFloat(N)):parseFloat(r)>=parseFloat(N)&&(v=parseFloat(v)-parseFloat(N),u=parseFloat(u)+parseFloat(N))):N=0,!i.gbBillNo.billno||"Unbilled"==i.gbBillNo.billno||i.gbBillNo.billno.indexOf("OPCS"),y=parseFloat(u)-parseFloat(I)-parseFloat(o),l<y&&(y=l),i.gbBillNo.billno&&"Unbilled"==i.gbBillNo.billno&&(y=parseFloat(D)),i.gridConcReqOptions.data.length>0&&(angular.forEach(i.gridConcReqOptions.data,function(e,t){if(1==e.billService&&(1==e.billConcType&&(d=parseFloat(d)+parseFloat(e.billReqConcAmt)),2==e.billConcType&&(p=parseFloat(p)+parseFloat(e.billReqConcAmt))),2==e.billService&&e.serviceConcList&&e.serviceConcList.length>0)for(var r=e.serviceConcList,a=0;a<r.length;a++)parseFloat(r[a].concReqAmt)>0&&(p=parseFloat(p)+parseFloat(r[a].concReqAmt));e.concessionReqSeqId&&e.billReqAmt&&(S=parseFloat(S)+parseFloat(e.billReqAmt))}),d>0&&(p=parseFloat(p)+parseFloat(D)*(parseFloat(d)/100)),l=parseFloat(l)-parseFloat(p),p=parseFloat(p)+parseFloat(S),y>0&&(y=parseFloat(y)-parseFloat(p)+parseFloat(S)));var _=0,w=0;if(i.gridGbPaymentOptions.data.length>0&&angular.forEach(i.gridGbPaymentOptions.data,function(e,t){1==e.payerRadType&&(_=parseFloat(_)+parseFloat(e.amtPaid)),2==e.payerRadType&&(w=parseFloat(w)+parseFloat(e.amtPaid))}),i.deposit&&2==i.deposit.Type){var M=0;angular.forEach(t,function(e,t){e.appliedAmount=0,e.availableAmount=parseFloat(e.availableDefAmount),e.appliedAmount=e.availableAmount.toFixed(2),M=parseFloat(M)+parseFloat(e.appliedAmount),e.availableAmount=0}),i.refund.RefdAmt=M.toFixed(2),s=0,i.setRefundRounding()}else angular.forEach(t,function(e,t){e.appliedAmount=0,e.availableAmount=parseFloat(e.availableDefAmount),l>0&&e.availableAmount>0&&parseFloat(y)-parseFloat(_)>=0&&(parseFloat(y)-parseFloat(_)<=e.availableAmount?(e.appliedAmount=parseFloat(y)-parseFloat(_),l=parseFloat(l)-parseFloat(e.appliedAmount)):(e.appliedAmount=parseFloat(e.availableAmount),l=parseFloat(l)-parseFloat(e.appliedAmount))),e.appliedAmount=parseFloat(e.appliedAmount).toFixed(2),e.availableAmount=parseFloat(e.availableAmount)-parseFloat(e.appliedAmount),e.availableAmount=e.availableAmount.toFixed(2),y=parseFloat(y)-parseFloat(e.appliedAmount),s=parseFloat(s)+parseFloat(e.appliedAmount)}),i.refund.RefdAmt=0;i.gbBillNo.billno&&"Unbilled"==i.gbBillNo.billno&&(L=parseFloat(y)),o>0&&(s=parseFloat(s)+parseFloat(o)),(h=parseFloat(u)-parseFloat(s)-parseFloat(I)-parseFloat(p))<0&&(h=0),(R=parseFloat(v)-parseFloat(P))<0&&(R=0),l<=0&&(h=0,R=0),E=parseFloat(T)+parseFloat(N)-parseFloat(p),q=parseFloat(C)-parseFloat(N),O=parseFloat(E)+parseFloat(q);var F={Total_Bill:r.toFixed(2),Total_Discount:a.toFixed(2),Deposite_Adj:s.toFixed(2),Net_Amt:n.toFixed(2),Paid_Amt:c.toFixed(2),Due_Amt:l.toFixed(2),Concession_Amt:p.toFixed(2),Concession_per:d.toFixed(2),Tax_Amount:m.toFixed(2),Pat_Amt:u.toFixed(2),Payr_Amt:v.toFixed(2),Pat_Conc_Aplc_Amt:D.toFixed(2),deductibleType:i.deductibleType?i.deductibleType:void 0,deductibleAmount:parseFloat(N).toFixed(2),coPay:A.toFixed(2),patientPaidAmnt:I.toFixed(2),payerPaidAmnt:P.toFixed(2),patientDefPendAmnt:h.toFixed(2),payerDefPendAmnt:R.toFixed(2),patientPendAmnt:h.toFixed(2),payerPendAmnt:R.toFixed(2),crNoteAmount:f.toFixed(2),Net_Pat_Amt:T.toFixed(2),Net_Payer_Amt:C.toFixed(2),Net_Total:b.toFixed(2),Net_Pay_Pat:E.toFixed(2),Net_Pay_Payer:q.toFixed(2),Net_Pay_Total:O.toFixed(2),patPendAmtForCSBill:L.toFixed(2),patPendDefAmtForCSBill:D.toFixed(2)};if(i.gbcal=angular.copy(F),i.Pat_Amt=i.gbcal.Pat_Amt,i.Payr_Amt=i.gbcal.Payr_Amt,i.gbcal.deductibleAmount&&i.gbcal.deductibleAmount>0&&l>0){var B=parseFloat(i.gbcal.Pat_Amt)-parseFloat(s)-parseFloat(I)-parseFloat(p),x=parseFloat(i.gbcal.Payr_Amt)-parseFloat(P);B<0&&(B=0),x<0&&(x=0),i.gbcal.patientPendAmnt=B.toFixed(2),i.gbcal.patientDefPendAmnt=B.toFixed(2),i.gbcal.payerPendAmnt=x.toFixed(2),i.gbcal.payerDefPendAmnt=x.toFixed(2)}i.gbcal.patPendAmtForCSBill=i.gbcal.patientPendAmnt,1==i.paym.billAmountType?i.gbBillNo&&"Unbilled"==i.gbBillNo.billno?i.gbcal.patPendAmtForCSBill=L.toFixed(2):i.paym.Amt=i.gbcal.patientPendAmnt:2==i.paym.billAmountType?i.paym.Amt=i.gbcal.payerPendAmnt:3==i.paym.billAmountType&&(i.gbBillNo&&"Unbilled"==i.gbBillNo.billno?i.paym.Amt=i.gbcal.patientPendAmnt:i.paym.Amt="",i.paym.ReceiveFrom="Self"),i.calRoundOffs(),i.gridGbPaymentOptions&&i.gridGbPaymentOptions.data.length>0&&i.calulatePendAmts()},i.checkIfMultipayers=function(e){var t=i.gridgbOptionsApi.selection.getSelectedRows(),r=!1;if(t.length>1)for(let a=0;a<t.length;a++)4!=t[a].payerType&&t[a].payerName!=e.entity.payerName&&i.gbBillNo&&"Unbilled"==i.gbBillNo.billno&&(r=!0),4!=t[a].payerType&&t[a].planSeqId&&t[a].payerName==e.entity.payerName&&(i.insurancePlanDedSeqId=t[a].planSeqId);else 1==t.length&&4!=t[0].payerType&&t[0].planSeqId&&(i.insurancePlanDedSeqId=t[0].planSeqId);if(r)return v.warning("Warning!","More than one payer except self at a time not allowed",!1,!1,me.time),e.isSelected=!1,!1;i.insurancePlanDedSeqId?Pe():i.calculateGBData()},i.gridgbOptions=angular.copy(p),i.gridgbOptions.onRegisterApi=function(e){i.gridgbOptionsApi=e,e.selection.on.rowSelectionChanged(i,function(e){7==e.entity.billStatus&&(e.isSelected=!1),""!=e.entity.payerName||e.entity.planSeqId||(e.isSelected=!1,v.warning("Warning!","No payer details.",!1,!1,me.time)),4!=e.entity.payerType&&"Unbilled"===i.gbBillNo.billno?i.checkIfMultipayers(e):i.calculateGBData(),i.checkOrUncheckRow(e)}),e.selection.on.rowSelectionChangedBatch(i,function(e){var t=!1,r=!1,a=i.gridgbOptionsApi.selection.getSelectedRows(),o=!1;if(a.length>1&&a.length!=e.length){var s="";for(let t=0;t<e.length;t++)e[t].entity.planSeqId&&(s=s+","+e[t].entity.servicePostingSeqId);for(let e=0;e<a.length;e++){if(a[e].planSeqId)var n=s.indexOf(a[e].servicePostingSeqId);!t&&a[e].planSeqId&&-1===n&&(t=a[e].planSeqId)}}if(angular.forEach(e,function(e){7==e.entity.billStatus&&(e.isSelected=!1),""!=e.entity.payerName||e.entity.planSeqId||(e.isSelected=!1,r=!0,o=!0),e.entity.planSeqId&&!t&&e.isSelected&&(t=e.entity.planSeqId),e.entity.planSeqId&&e.entity.planSeqId!=t&&e.isSelected&&i.gbBillNo&&"Unbilled"==i.gbBillNo.billno&&(r=!0,e.isSelected=!1),i.checkOrUncheckRow(e)}),r){if(o)var c="No payer details.";else c="More than one payer except self at a time not allowed";v.warning("Warning!",c,!1,!1,me.time),T(function(){i.gridgbOptionsApi.grid.selection.selectAll=!1},200)}else i.insurancePlanDedSeqId=t;i.insurancePlanDedSeqId?Pe():i.calculateGBData()})},i.getActivebillRecords=function(){var e=[];return angular.forEach(i.gridgbOptions.data,function(t,r){7!=t.billStatus&&e.push(t)}),e},i.generatePaymentReport=function(e,t,r,a,o){e&&m.generatePaymentReport(e,t,r,a).then(function(e){var t="napier-his-web/NapierReportServlet?reportName="+(e.data.HITService.message.reportName+""),r=location.host;F.open(location.protocol+"//"+r+"/"+t),void 0===i.billsPayIds[1]||o||i.generatePaymentReportDup(i.billsPayIds[1].scrollSeqId,-999,-999,a)})},i.generatePaymentReportDup=function(e,t,r,a){e&&m.generatePaymentReport(e,t,r,a).then(function(e){var t="napier-his-web/NapierReportServlet?reportName="+(e.data.HITService.message.reportName+""),r=location.host;F.open(location.protocol+"//"+r+"/"+t)})},i.confrimCancelBillData=function(e,t){m.cancelBillData(e).then(function(e){if(v.success("Success","Cancel Successful",!1,!1,me.time),i.showGBillCanLoadingIcon=!1,i.gridgbOptions.data=[],i.gbcal={},i.loadBillNumbers(s.mrNo,t),i.loadGBDepositeGrid(),i.retriveRecords(),null!=e.context.contextList[0]["com.napier.core.context.ContextElement"][11]){var r=e.context.contextList[0]["com.napier.core.context.ContextElement"][11];i.loadGBDepositeGrid(),"BILL_CANCEL_REFUND"==r.attrName&&"Y"==r.attrValue?i.activeSecond=3:i.activeBillTab(2)}},function(e){i.showGBillCanLoadingIcon=!1,v.failure("Failure","Cancel failed",!1,!1,me.time)}),E.dismissAll()},i.cancelBillData=function(e){if(e){var t=i.gridgbOptionsApi.selection.getSelectedRows();if(i.showGBillCanLoadingIcon=!0,t.length<=0)return v.warning("Warning!","Please select atleast one service/ bill to cancel",!1,!1,me.time),i.showGBillCanLoadingIcon=!1,!1;if(t.length>0){for(var r=0,a=0,o=0,s=0;s<t.length;s++)t[s].isComingFromOPPharmacy?r++:a++,t[s].isPostBillApplicable||o++;if(0!=r&&o&&0==a)return v.warning("Warning!","We Can Not Cancel Issue/Return Services",!1,!1,me.time),!1}var n=[];for(s=0;s<t.length;s++)n.push({"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:t[s].servicePostingSeqId,servDesc:t[s].ItemName,gnServDesign:void 0!==t[s].appointReason?t[s].appointReason:2});var c=!1;if(angular.forEach(t,function(e){2!=e.renderType||c||(c=!0)}),c&&o)return v.warning("Warning!","Rendered pre-billed service(s) can not be canceled",!1,!1,me.time),i.showGBillCanLoadingIcon=!1,!1;var l={buttonCallBack1:function(){E.dismissAll(),i.showGBillCanLoadingIcon=!1},buttonCallBack2:function(){var r=new Array,a={1:r},s=I.executeQueryURLReset(),c=new Array;return I.prepareParamListWithParam("pBillNo",e,c),I.executeQueryInput("GET_CREDIT_DATA_FOR_CANCEL_001",c,a,!0,!0,s,"popUp",{}).then(function(a){if(r[0].SUB_ACC_SEQ_ID&&1==r[0].SUB_ACC_SEQ_ID)return v.warning("Warning!","Can't cancel the registration bill",!1,!1,me.time),i.showGBillCanLoadingIcon=!1,!1;if(null!=r[0].DUEAMNT&&0==r[0].DUEAMNT)return v.warning("Warning!","Can't cancel the credit bill, as the payment is settled",!1,!1,me.time),i.showGBillCanLoadingIcon=!1,!1;if(r[0].CL_HD_SEQ_ID)return v.warning("Warning!","Covering letter is generated, can't cancel the bill",!1,!1,me.time),i.showGBillCanLoadingIcon=!1,!1;if(r[0].INVC_HD_SEQ_ID)return v.warning("Warning!","Invoice is generated, can't cancel the bill",!1,!1,me.time),i.showGBillCanLoadingIcon=!1,!1;if(o){var s={};s.url=N.updateService.URL,s.requestData={operation:"checkOrderCancelForBill",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.master.vo.ServiceListVo",serviceList:[{"com.napier.core.scm.master.vo.ServiceVo":n}]}},P.sendRestRequest(s).then(function(r){if(""==r.data.HITService.message.serviceList[0])i.confrimCancelBillData(t,e);else{var a=r.data.HITService.message.serviceList[0]["com.napier.core.scm.master.vo.ServiceVo"],o=[],s="";void 0!==a.length?s=a:(o.push(a),s=o);for(var n="",c=0;c<s.length;c++)n=s[c].servDesc+","+n;v.warning("Warning!","We Can't Delete the Following Services "+n),i.showGBillCanLoadingIcon=!1}})}else i.confrimCancelBillData(t,e)})}};v.hisAlertMulti("information","Information","Are you sure to cancel?",{buttonText:"No",buttonText2:"Yes"},l,!1)}},i.generateBillReport=function(e,t){if("HSC"==sessionStorage.productCustomization)i.generateBillPrintReportOption(e,t);else{var r=null;if(""==e&&t)for(var a=0;a<i.gbBillNUmbers.length;a++)i.gbBillNUmbers[a].BILL_NO==t&&(e=i.gbBillNUmbers[a].BILL_SEQ_ID,r=i.gbBillNUmbers[a].BILL_REF_ID);else e&&t&&(r=t);var o=0;r&&(0==r.indexOf("OPCS")&&(o=1),0==r.indexOf("OPCR")&&(o=2)),null!=e&&""!=e&&m.generateBillReport(e,-999,-999,o).then(function(e){var t="napier-his-web/NapierReportServlet?reportName="+(e.data.HITService.message.reportName+""),r=location.host;F.open(location.protocol+"//"+r+"/"+t),void 0!==i.billsIds[1]&&i.generateBillReportDup(i.billsIds[1].scrollSeqId,"")})}},i.generateBillReportDup=function(e,t){if("HSC"==sessionStorage.productCustomization)i.generateBillPrintReportOption(e,t);else{if(""==e&&t)for(var r=0;r<i.gbBillNUmbers.length;r++)i.gbBillNUmbers[r].BILL_NO==t&&(e=i.gbBillNUmbers[r].BILL_SEQ_ID);null!=e&&""!=e&&m.generateBillReport(e,-999,-999).then(function(e){var t="napier-his-web/NapierReportServlet?reportName="+(e.data.HITService.message.reportName+""),r=location.host;F.open(location.protocol+"//"+r+"/"+t)})}},i.generateBillPrintReportOptionForMulti=function(e){i.BillData=[],i.BillDataList={1:i.BillData};var t=I.executeQueryURLReset();i.billDetailsValues=new Array,I.prepareParamListWithParam("pMasterSqId","700411",i.billDetailsValues),I.executeQueryInput("TRN003",i.billDetailsValues,i.BillDataList,!0,!0,t,"popUp",i.advSearch).then(function(e){var t=e[1];t&&(i.BillTypeData=t,i.billType=i.BillTypeData[0])});i.PrintTypeData=[{code:1,desc:"PDF"}],i.printType=i.PrintTypeData[0];var r=e;i.BillNumberData=r,i.billNumber=i.BillNumberData[0];var a="";angular.forEach(r,function(e,t){a=a+" & "+e}),a=a.substring(2,a.length),i.message="Bill Generation Successful "+a+". Do you want to print?",s.modalInstancePackage=S.open("Bill Generation",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"bill-print-model-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-multi-bill-print.html",size:"sm",scope:i})},i.generateBillPrintReportOption=function(e,t){i.colReqSeqId=e,i.billNoData=t;i.BillData=[],i.BillDataList={1:i.BillData};var r=I.executeQueryURLReset();i.billDetailsValues=new Array,I.prepareParamListWithParam("pMasterSqId","700411",i.billDetailsValues),I.executeQueryInput("TRN003",i.billDetailsValues,i.BillDataList,!0,!0,r,"popUp",i.advSearch).then(function(e){var t=e[1];t&&(i.BillTypeData=t,i.billType=i.BillTypeData[0])}),i.patCatData=[],i.patCatDataList={1:i.patCatData};r=I.executeQueryURLReset();i.patCatDetailsValues=new Array,I.prepareParamListWithParam("pBillNo",t,i.patCatDetailsValues),I.executeQueryInput("BILL_PRINT_FOR_PAT_CATEGORY",i.patCatDetailsValues,i.patCatDataList,!0,!0,r,"popUp",{}).then(function(e){var t=e[1];t&&(i.patCatCode=t[0].CODE,i.patCatPayer=t[0].PAYER_NAME)});i.PrintTypeData=[{code:1,desc:"PDF"}],i.printType=i.PrintTypeData[0],s.modalInstancePackage=S.open("Bill Print",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"bill-print-model-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-bill-print.html",size:"sm",scope:i})},i.generateBillPrintReportType=function(e,t,r){r&&(i.billNoData=r);var a=J.getPrintData(i.patCatCode,i.billNoData,t,e,i.patCatPayer);i.generateBillPrintReport(a)},i.exitPopUp=function(){E.dismissAll()},i.generateBillPrintReport=function(e){j.printReportModal("printBillCtrlNew","lg","PDF",e)},i.generateTaxInvoice=function(){var e={reportId:"TAX_INVOICE_GST_REPORT_ID",printType:"PDF",pBillSeqId:i.billSeqids};j.printReportModal("PrintTypeSelection","sm").then(function(t){j.printReportModal("printBillCtrlNew","lg","PDF",e)})},i.loadAppliedConc=function(e){i.gridConcReqOptions.data=[],m.loadAppliedConc(e).then(function(e){i.gridConcReqOptions.data=angular.copy(e),i.gbBillNo.billno&&"Unbilled"!=i.gbBillNo.billno&&i.calculateGBData()})},i.cancelConcView=function(){i.concessionViewMode=!1,i.concession={},i.gridConcOptions.data=[],i.concBillRadio=!1,i.concServRadio=!1},i.ViewBillConcesDetails=function(e){e.entity.concessionReqSeqId&&(i.gridConcOptions.data=[],i.concessionViewMode=!0,m.ViewBillConcesDetails(e.entity.concessionReqSeqId).then(function(e){i.concession.remarks=e.remarks,i.concession.cType=e.concessionSeqId;var t=e.concessionRequestDetailsList[0]["com.napier.core.service.vo.corebillingconcession.ConcessionRequestDetails"];1==e.concessionType?(i.concession.billService=1,i.concBillRadio=!0,i.concServRadio=!1,i.concession.billConcType=t.amountType.toString(),i.concession.billReqConcAmt=t.reqConession):2==e.concessionType&&(i.concession.billService=2,i.concBillRadio=!1,i.concServRadio=!0,t=t instanceof Array?t:[t],angular.forEach(t,function(e,t){var r=e;r.servName=e.serviceName,1==e.amountType&&(r.concReqPer=e.reqConession),2==e.amountType&&(r.concReqAmt=e.reqConession),i.gridConcOptions.data.push(r),r={}}))}))},i.removeConcesData=function(e){var t={buttonCallBack1:function(){E.dismissAll()},buttonCallBack2:function(){m.removeConcesData(e.entity.concessionReqSeqId,e.entity.concessionType).then(function(e){E.dismissAll(),i.loadGBPaymentGridData("",i.gbBillNo.billno),v.success("Success","Concession Removed",!1,!1,me.time);for(var t="",r=0;r<i.gbBillNUmbers.length;r++)i.gbBillNUmbers[r].BILL_NO==i.gbBillNo.billno&&(t=i.gbBillNUmbers[r]);""!=t&&i.loadAppliedConc(t)})}};e.entity.concessionReqSeqId&&v.hisAlertMulti("information","Information","Are you sure to remove applied concession?",{buttonText:"No",buttonText2:"Yes"},t,!1)},i.saveBillConcession=function(e){var t=[];i.showConcessionLoadingIcon=!0,angular.forEach(i.gridConcReqOptions.data,function(e,r){null==e.concessionReqSeqId&&t.push(e)});for(var r="",a=0;a<i.gbBillNUmbers.length;a++)i.gbBillNUmbers[a].BILL_NO==e&&(r=i.gbBillNUmbers[a]);if(i.gridConcReqOptions.data.length<=0||t<=0||""==r)return v.warning("Warning!","No Data to save",!1,!1,me.time),i.showConcessionLoadingIcon=!1,!1;m.saveBillConcession(t,r.BILL_SEQ_ID).then(function(e){v.success("Success","Concession Applied Successfully",!1,!1,me.time),i.loadGBPaymentGridData("",i.gbBillNo.billno),i.loadGBDepositeGrid(),i.showConcessionLoadingIcon=!1})},i.loadGBPaymentGridData=function(e,t){if(i.psd={},i.appliedDeductible=0,""==e&&t){i.activeSecond=4,i.concession&&i.concession.cType&&(i.concession={},i.concBillRadio=!1,i.concServRadio=!1);for(var r=0;r<i.gbBillNUmbers.length;r++)i.gbBillNUmbers[r].BILL_NO==t&&(e=i.gbBillNUmbers[r]),i.billSeqids=e.BILL_SEQ_ID}7==e.BILL_STATUS?i.disablePrintForCancel=!0:i.disablePrintForCancel=!1,2===e.SCROLL_STATUS&&2===e.CR_NOTE_STATUS?(i.refund.RefdAmt=e.CR_NOTE_AMT,i.refund.COL_REQ_SEQ_ID=e.COL_REQ_SEQ_ID,i.refund.TRAN_REQ_TYPE=e.TRAN_REQ_TYPE,i.refund.paidTo=s.patientGlobalDtlsNew[0].patientName):i.refund.RefdAmt=0,i.billNo=t,i.refundFlag=!0,i.paymentReciepts=!0,i.totalpayableAmt=0,i.gridgbOptions.data=[],i.gbcal={},i.gridGbPaymentOptions.data=[],i.disablePayType=!1,i.gridConcReqOptions.data=[],i.gridrefundOptions.data=[],i.setPaymenttodefault(),i.concessionViewMode=!1,i.reciepts=[],i.paymentReciepts=!0,m.loadGBPaymentGridData(e,s.encounterSeqId).then(function(r){i.enableClaimForm=!1,i.gridgbOptions.data=[],i.gbcal={};var a=0;i.taxInvoiceFlag=!1;var o=[];i.gridgbOptions.data=angular.copy(r);for(var s=0;s<i.gridgbOptions.data.length;s++)o.push(i.gridgbOptions.data[s].servicePostingSeqId),7==i.gridgbOptions.data[s].billStatus&&a++;a==i.gridgbOptions.data.length&&(i.taxInvoiceFlag=!0),i.colReqSeqId=r[0].colReqSeqId,i.colReqSeqId||(i.colReqSeqId=r[0].payerColSeqId?r[0].payerColSeqId:r[0].patColSeqId);var n={1:i.taxInVoiceList=[]},c=I.executeQueryURLReset(),l=new Array;if(I.prepareParamListWithParam("@SP_SEQ_ID",_.toString(o),l),I.prepareParamListWithParam("@PAT_TYPE","2",l),I.executeQueryInput("GENERATE_TAX_INVOICE_NO",l,n,!0,!0,c,"popUp",{}),r[0].billStatus&&7==r[0].billStatus&&null!=r[0].refundFlag){var p=r[0].refundFlag;"BILL_CANCEL_REFUND"==p.attrName&&"Y"==p.attrValue?i.activeSecond=3:i.activeSecond=2}var d=!0;t&&"Unbilled"!=t&&r[0]&&null!=r[0].dueAmt&&0==r[0].dueAmt&&(d=!1),r[0]&&d&&(1==r[0].partialStatusCode?(i.pPayAuthMode=!0,i.psd.partialPayStatusMode="Request for Due amount "+r[0].partialDueAmount+" is pending for approval.",i.psd.partialDueAmountArroval="",i.psd.partialDueAmountStatusCode=r[0].partialStatusCode,i.psd.partialRequestSeqId=r[0].partialRequestSeqId):2==r[0].partialStatusCode?(i.pPayAuthMode=!0,i.psd.partialPayStatusMode="Request for due amount "+r[0].partialDueAmount+" is approved",i.psd.partialDueAmountArroval=r[0].partialDueAmount,i.psd.partialDueAmountStatusCode=r[0].partialStatusCode,i.psd.partialRequestSeqId=r[0].partialRequestSeqId):3==r[0].partialStatusCode?(i.pPayAuthMode=!1,i.psd.partialPayStatusMode="Request for due amount "+r[0].partialDueAmount+" is rejected.",i.psd.partialDueAmountArroval="",i.psd.partialDueAmountStatusCode=r[0].partialStatusCode,i.psd.partialRequestSeqId=r[0].partialRequestSeqId):(i.pPayAuthMode=!1,i.psd.partialPayStatusMode="",i.psd.partialDueAmountArroval="",i.psd.partialDueAmountStatusCode="",i.psd.partialRequestSeqId="")),null!=i.colReqSeqId&&(r[0].payerColSeqId&&r[0].patColSeqId?i.paymentReciept(i.colReqSeqId,r[0].patColSeqId):i.paymentReciept(i.colReqSeqId)),r.length>0?"Unbilled"===i.gbBillNo.billno?i.gridgbOptionsApi.grid.selection.selectAll=!1:(i.gridgbOptionsApi.grid.selection.selectAll=!1,i.calculateGBData()):i.gridgbOptionsApi.grid.selection.selectAll=!1,e.BILL_NO&&"Unbilled"!=e.BILL_NO&&7!=e.BILL_STATUS&&i.loadAppliedConc(e);var m=e.BILL_NO.match(/OPCR/g);m&&m.length>0&&(i.enableClaimForm=!0)},function(e){i.gridgbOptions.data=[],i.gbcal={},i.gridgbOptionsApi.grid.selection.selectAll=!1})},i.loadServiceAliasCodes=function(e,t){if(e.entity.servSeqId&&e.entity.accPayerSeqId){e.entity.serviceCodesList=[];let t={1:e.entity.serviceCodesList},r=[],a=I.executeQueryURLReset();I.prepareParamListWithParam("pPayerSeqId",e.entity.accPayerSeqId,r),I.prepareParamListWithParam("pSerSeqId",e.entity.servSeqId,r),I.executeQueryInput("PHIL_HEALTH_CODE_AND_NAME",r,t,!0,!0,a,"popUp",{}).then(function(t){if(0==e.entity.serviceCodesList.length)v.warning("Warning!","There are no associated payer codes in the contract definition",!1,!1,me.time),e.entity.editService=!1;else{var r=e.entity.serviceCodesList.map(function(e){return e.DEFAULT_VALUE}).indexOf(1);e.entity.ItemCodeNew=e.entity.serviceCodesList[r]}})}},i.updateServiceAliasCodes=function(e,t){e.entity.ItemCodeNew&&m.updateServiceAliasCodes(e.entity).then(function(t){e.entity.ItemCode=angular.copy(e.entity.ItemCodeNew.PAYER_ALIAS_CODE),e.entity.ItemName=e.entity.ItemCodeNew.PAYER_ALIAS_NAME,e.entity.editService=!1},function(e){})},i.claimFormDetails=function(){ge={};var e=-999;if(i.gbBillNo&&"Unbilled"==i.gbBillNo.billno)var t=i.gridgbOptionsApi.selection.getSelectedRows();else t=i.gridgbOptions.data;for(var r=0;r<t.length;r++)ge={"SV.SERV_CODE":t[r].ItemCode,"SV.SERV_NAME":t[r].ItemName,"SP.QTY":t[r].quantity,"SEC.SERV_TYPE_DESC":t[r].primaryServiceDescription,"SP.SERVICE_RATE":t[r].baseRate},i.claimFormDetailsArray.push(ge),-999==e&&t[r].payerCompPlanseqId&&(e=t[r].payerCompPlanseqId);i.claimFormDetailsArrayString=JSON.stringify(i.claimFormDetailsArray);var a={regSeqId:s.patientSeqId,encSeqId:s.encounterSeqId,serviceListString:i.claimFormDetailsArrayString,pPayerSeqId:e,reportId:"CLAIM_FORM_TEMPLATE"};j.printReportModal("claimFormPrintCtrlNew","lg","PDF",a),i.claimFormDetailsArray=[]},i.loadRefundRecieptList=function(){if(null!=i.accountSeqData[0].ACC_SEQ_ID){i.refundRecieptsList=[];let e={1:i.refundRecieptsList},t=[],r=I.executeQueryURLReset();i.accountres.SUB_ACC_SEQ_ID;I.prepareParamListWithParam("pAccSeqId",i.accountSeqData[0].ACC_SEQ_ID,t),I.executeQueryInput("GET_OP_DEPOSIT_REFUND_001",t,e,!0,!0,r,"popUp",{})}},i.PaymentRecieptPrint=function(e){var t=e.billNo.substring(0,4);i.generatePaymentReport(e.colSeqId,e.receiptHdSeqId,e.receiptDtSeqId,t)},i.paymentReciept=function(e,t){i.reciepts=[],m.loadPaymentReciepts(e).then(function(r){null!=r&&(i.paymentReciepts=!1,null==r.length?i.reciepts.push(r):i.reciepts=r),t&&e!=t&&m.loadPaymentReciepts(t).then(function(e){if(null!=e){if(i.paymentReciepts=!1,null==e.length)(t=[]).push(e);else var t=e;i.reciepts.length>0?i.reciepts=i.reciepts.concat(t):i.reciepts=t}})})},i.refundPrint=function(){var e={pPaymentRefundReceiptId:i.colReqSeqId?i.colReqSeqId:i.gridgbOptions.data[0].patColSeqId};j.printReportModal("refundPrintCtrlNew","lg","PDF",e)},i.loadBillNumbers=function(e,t){i.gbBillNo.billno=void 0,i.setPaymenttodefault(),i.concession={},i.gridConcOptions.data=[],i.gridConcReqOptions.data=[],m.loadBillNumbers(e,i.accountSeqData.length>0?i.accountSeqData[0].SUB_ACC_SEQ_ID:1).then(function(r){r.unshift({BILL_NO:"Unbilled",BILL_STATUS:0,RG_INT_MR_NO:e,ACC_SEQ_ID:i.accountSeqData.length>0?i.accountSeqData[0].ACC_SEQ_ID:r[0].ACC_SEQ_ID,SUB_ACC_SEQ_ID:i.accountSeqData.length>0?i.accountSeqData[0].SUB_ACC_SEQ_ID:r[0].SUB_ACC_SEQ_ID}),i.gbBillNUmbers=angular.copy(r),t?(i.loadGBPaymentGridData("",t),i.gbBillNo.billno=t):(i.loadGBPaymentGridData(r[0]),i.gbBillNo.billno=i.gbBillNUmbers[0].BILL_NO)},function(t){i.gbBillNo.billno=void 0;var r=[];r.push({BILL_NO:"Unbilled",BILL_STATUS:0,RG_INT_MR_NO:e,ACC_SEQ_ID:i.accountSeqData.length>0&&i.accountSeqData[0].ACC_SEQ_ID?i.accountSeqData[0].ACC_SEQ_ID:void 0,SUB_ACC_SEQ_ID:i.accountSeqData.length>0&&i.accountSeqData[0].SUB_ACC_SEQ_ID?i.accountSeqData[0].SUB_ACC_SEQ_ID:void 0}),i.gbBillNUmbers=angular.copy(r),i.loadGBPaymentGridData(r[0]),i.gbBillNo.billno=i.gbBillNUmbers[0].BILL_NO})},i.setPaymenttodefault=function(e){i.paym={},i.paym.mode=1,i.refund.mode=1,i.paym.ReceiveFrom="Self",i.paym.payDate=new Date,i.refund.fromDate=new Date,i.paym.billAmountType=null!=e?e:"1"},i.paymentModeResult=function(){i.OPVMGenBillsPaymentModeCombo=[],i.bankNamesData=[],i.escPaymentTypeData=[],i.concessionTypeCombo=[],i.chequeTypeData=[],i.refundMode=[],i.cardTypeData=[],i.getSelectedPmtMode={1:i.OPVMGenBillsPaymentModeCombo,2:i.bankNamesData,3:i.escPaymentTypeData,4:i.concessionTypeCombo,5:i.chequeTypeData,6:i.refundMode,7:i.cardTypeData};var e=I.executeQueryURLReset();i.paymentModeDataList=new Array,I.prepareParamListWithParam("pMasterSqId","21008",i.paymentModeDataList),I.executeQueryInput("NH_GN_M_MASTER_DT_COMBO",i.paymentModeDataList,i.getSelectedPmtMode,!0,!1,e,"popUp",i.gridgbOptions),i.bankNamesDataList=new Array,I.prepareParamListWithParam("pMasterSqId","700179",i.bankNamesDataList),I.executeQueryInput("NH_GN_M_MASTER_DT_COMBO",i.bankNamesDataList,i.getSelectedPmtMode,!0,!1,e,"popUp",i.gridgbOptions),i.escPaymentTypeDataList=new Array,I.prepareParamListWithParam("pMasterSqId","700189",i.escPaymentTypeDataList),I.executeQueryInput("NH_GN_M_MASTER_DT_COMBO",i.escPaymentTypeDataList,i.getSelectedPmtMode,!0,!1,e,"popUp",i.gridgbOptions),i.concessionTypeList=new Array,I.prepareParamListWithParam("pRollId",JSON.parse(sessionStorage.userContextObj).USER_SEQ_ID,i.concessionTypeList),I.executeQueryInput("GET_CONCESSION_NEW_DROPDOWN_BY_USERID",i.concessionTypeList,i.getSelectedPmtMode,!0,!1,e,"popUp",i.gridgbOptions),i.chequeTypeDataList=new Array,I.prepareParamListWithParam("pMasterSqId","21009",i.chequeTypeDataList),I.executeQueryInput("NH_GN_M_MASTER_DT_COMBO",i.chequeTypeDataList,i.getSelectedPmtMode,!0,!0,e,"popUp",i.gridgbOptions),i.refundModeDataList=new Array,I.prepareParamListWithParam("pMasterSqId","700200",i.refundModeDataList),I.executeQueryInput("NH_GN_M_MASTER_DT_COMBO",i.refundModeDataList,i.getSelectedPmtMode,!0,!1,e,"popUp",i.gridgbOptions),i.cardTypeDataList=new Array,I.prepareParamListWithParam("pMasterSqId","969",i.cardTypeDataList),I.executeQueryInput("NH_GN_M_MASTER_DT_COMBO",i.cardTypeDataList,i.getSelectedPmtMode,!0,!1,e,"popUp",i.gridgbOptions)},T(function(){i.paymentModeResult()},500),i.getServiceConcessionDetails=function(e,t,r){if(i.gbBillNo.billno&&"Unbilled"==i.gbBillNo.billno)var a=i.gridgbOptionsApi.selection.getSelectedRows();else a=i.getActivebillRecords();if(a.length<=0)return v.warning("Warning!","Please select atleast one service",!1,!1,me.time),i.concession.cType="",!1;var o="";angular.forEach(a,function(e){7!=e.gnTranStatus&&e.PatAmt>0&&0==e.payerAmt&&(o=""==o?e.servicePostingSeqId:o+","+e.servicePostingSeqId)}),m.getServiceConcessionDetails(e,t,r,o).then(function(e){i.gridConcOptions.data=angular.copy(e)},function(e){i.gridConcOptions.data=[]})},i.applicableForBillandService=function(e){1==e?(i.concBillRadio=!0,i.concServRadio=!1):(i.concBillRadio=!1,i.concServRadio=!0)},i.applyConcessionRequest=function(){if(i.gbcal&&i.gbcal.Due_Amt<=0)return v.warning("Warning!","No Due Amount To give concession",!1,!1,me.time),!1;if(!i.gbcal.Pat_Amt||i.gbcal.Pat_Amt<=0)return v.warning("Warning!","Patient Amount should be more than Zero to apply concession",!1,!1,me.time),!1;if(i.gbcal.Pat_Amt>0&&0==i.gbcal.Pat_Conc_Aplc_Amt)return v.warning("Warning!","Concession can only be applied for a cash bill",!1,!1,me.time),!1;if(1==i.concession.billService){if(!i.concession.billReqConcAmt||i.concession.billReqConcAmt<=0)return v.warning("Warning!","Concession amount should be greater than zero",!1,!1,me.time),!1;1==i.concession.billService&&(1==i.concession.billConcType?(i.concession.billReqPer=i.concession.billReqConcAmt,i.concession.billReqAmt=(parseFloat(i.gbcal.Pat_Conc_Aplc_Amt)*(parseFloat(i.concession.billReqConcAmt)/100)).toFixed(2)):i.concession.billReqAmt=i.concession.billReqConcAmt)}else if(2==i.concession.billService){if(i.gridConcOptions.data.length<=0)return v.warning("Warning!","No service data to apply concession",!1,!1,me.time),!1;i.concession.serviceConcList=i.gridConcOptions.data;var e=0;for(let t=0;t<i.gridConcOptions.data.length;t++)e=parseFloat(e)+parseFloat(i.gridConcOptions.data[t].concReqAmt),e=parseFloat(e).toFixed(2);if(i.concession.dTotalServAmt=e,!i.concession.dTotalServAmt||i.concession.dTotalServAmt<=0)return v.warning("Warning!","Concession amount should be greater than zero",!1,!1,me.time),!1}if(i.gridConcReqOptions.data.length>0){if(-1!=i.gridConcReqOptions.data.map(function(e){return e.cType}).indexOf(i.concession.cType))return v.warning("Warning!","Concession already given",!1,!1,me.time),!1;i.gridConcReqOptions.data.push(i.concession),i.concession={},i.gridConcOptions.data=[],i.calculateGBData()}else i.gridConcReqOptions.data.push(i.concession),i.concession={},i.gridConcOptions.data=[],i.calculateGBData()},i.removeFromConcGrid=function(e,t){i.gridConcReqOptions.data.splice(t,1),i.calculateGBData()},i.checkBillConcessionReq=function(){0==i.concession.billConcAmt&&(i.concession.billReqConcAmt=""),i.concession.billReqConcAmt=i.concession.billReqConcAmt>0?parseFloat(i.concession.billReqConcAmt).toFixed(2):0,parseFloat(i.concession.billReqConcAmt)>parseFloat(i.concession.billConcAmt)&&(i.concession.billReqConcAmt=i.concession.billConcAmt)},i.concessionTypeChange=function(){""!=i.concession.cType?angular.forEach(i.concessionTypeCombo,function(e){if(e.CONC_SEQ_ID==i.concession.cType){if(i.applicableForBillandService(e.GN_CONC_TYPE),i.concession.billService=e.GN_CONC_TYPE,i.concession.cTypeDesc=e.CONC_NAME,2==e.GN_CONC_TYPE){if("Unbilled"==i.gbBillNo.billno)var t=-999;else{t="";for(var r=0;r<i.gbBillNUmbers.length;r++)i.gbBillNUmbers[r].BILL_NO==i.gbBillNo.billno&&(t=i.gbBillNUmbers[r].BILL_SEQ_ID);""==t&&(t=-999)}i.getServiceConcessionDetails(e.CONC_SEQ_ID,i.accountSeqData[0].SUB_ACC_SEQ_ID,t)}else{var a=e.CONC_AMOUNT;if(1==e.AMT_TYPE)i.concession.billConcType="1",e.CONC_AMOUNT>100&&(a=100);else if(i.concession.billConcType="2",i.gbcal&&i.gbcal.Pat_Conc_Aplc_Amt){var o=i.gbcal.Pat_Conc_Aplc_Amt;parseFloat(i.gbcal.Concession_Amt)>0&&(o=parseFloat(o)-parseFloat(i.gbcal.Concession_Amt)),o<=a&&(a=o),a=parseFloat(a)}i.concession.billConcAmt=a,i.concession.billReqConcAmt=a}return!1}}):(i.concession.billService=!1,i.concBillRadio=!1,i.concServRadio=!1)},i.gridConcReqOptions=angular.copy(G),i.gridConcOptions=angular.copy(x),i.gridfOptions=angular.copy(U),i.gridfOptions.onRegisterApi=function(e){i.gridgbdepOptionsApi=e,e.selection.on.rowSelectionChangedBatch(i,function(e){angular.forEach(e,function(e){if(!e.isSelected){if(e.entity.appliedAmount=0,void 0!==e.entity.adjustamtTotal)var t=e.entity.adjustamtTotal;else t=0;e.entity.availableAmount=parseFloat(e.entity.depositAmount)-parseFloat(t)}i.calculateGBData()})}),e.selection.on.rowSelectionChanged(i,function(e){if(!e.isSelected){if(e.entity.appliedAmount=0,void 0!==e.entity.adjustamtTotal)var t=e.entity.adjustamtTotal;else t=0;e.entity.availableAmount=parseFloat(e.entity.depositAmount)-parseFloat(t)}e.isSelected&&i.deposit&&2==i.deposit.Type&&i.gridrefundOptions&&i.gridrefundOptions.data.length>0&&(v.warning("Warning!","You can refund single Deposit/Credit Note at a time.",!1,!1,me.time),i.gridgbdepOptionsApi.selection.clearSelectedRows()),i.calculateGBData()})},i.loadGBDepositeGrid=function(){if(null!=i.accountSeqData[0].ACC_SEQ_ID){var e=[];i.gridfOptions.data=[],m.loadGBDepositeGrid(i.accountSeqData[0].ACC_SEQ_ID).then(function(t){for(var r=0;r<t.length;r++)e.push(t[r]);m.loadGBDepositeGridBillCancelRefund(i.accountSeqData[0].ACC_SEQ_ID).then(function(t){for(var r=0;r<t.length;r++)e.push(t[r])}),i.deposit&&2==i.deposit.Type?i.gridgbdepOptionsApi.selection.setMultiSelect(!1):i.gridgbdepOptionsApi.selection.setMultiSelect(!0),i.gridfOptions.data=e}),i.depositReciepts=[];var t={1:i.depositReciepts},r=[],a=I.executeQueryURLReset();i.accountres.SUB_ACC_SEQ_ID;I.prepareParamListWithParam("pAccSeqId",i.accountSeqData[0].ACC_SEQ_ID,r),I.executeQueryInput("GET_OP_DEPOSIT_RECEPT_001",r,t,!0,!0,a,"popUp",{})}},i.depositRecieptPrint=function(e){var t={pColrequestSeqId:e.COLREQSEQID};j.printReportModal("depositPrintCtrlNew","lg","PDF",t)},i.refundRecieptPrint=function(e){var t={pCrNtHdSeqId:e.CRN_HD_SEQ_ID,pIsCrNote:e.IS_CR_NOTE};j.printReportModal("refundReceiptPrintCtrlNew","lg","PDF",t)},i.gridrefundOptions=angular.copy(Q),i.concServComp=function(e,t){var r,a,i;2==t&&(parseFloat(e.concReqAmt)>parseFloat(e.concLimitAmt)&&(e.concReqAmt=e.concLimitAmt),e.concReqPer=function(e,t){if(t>=e)var r=100;else r=t/e*100;return r.toFixed(2)}(e.total,e.concReqAmt)),1==t&&(parseFloat(e.concReqPer)>parseFloat(e.concLimitPer)&&(v.warning("Warning!","Given concession is more than configured percentage",!1,!1,me.time),e.concReqPer=e.concLimitPer),e.concReqAmt=(r=e.total,a=e.concReqPer,null==(i=r*(a/100))||!angular.isNumber(i)||isNaN(i)?"":i.toFixed(2)))},i.gridGbPaymentOptions=angular.copy(k),i.gridGbPaymentOptions.onRegisterApi=function(e){i.gridGbPaymentOptions=e},i.gridrefundOptions.onRegisterApi=function(e){i.gridrefundOptions=e,i.gridrefundOptions.data=[]},i.addToRefundGrid=function(e){if(e.RefdAmt>0){var t="Please Fill All Mandatory Fileds.";if(i.gridrefundOptions.data.length>0)return v.warning("Warning!","Only one refund allowed at a time",!1,!1,me.time),!1;if(!(1!=e.mode||e.RefdAmt&&e.paidTo))return v.warning("Warning!",t,!1,!1,me.time),!1;if(!(2!=e.mode&&3!=e.mode||e.RefdAmt&&e.fromDate&&e.chqType&&e.CHQDDno&&e.ChqDDDate&&e.paidTo))return v.warning("Warning!",t,!1,!1,me.time),!1;if(!(4!=e.mode&&9!=e.mode||e.RefdAmt&&e.fromDate&&e.cardNumber&&e.cardTranId&&e.cardType&&e.exMonth&&e.exYear&&e.paidTo))return v.warning("Warning!",t,!1,!1,me.time),!1;if(!(5!=e.mode||e.RefdAmt&&e.fromDate&&e.paymentTranType&&e.paidTo))return v.warning("Warning!",t,!1,!1,me.time),!1;if(!(7!=e.mode||e.RefdAmt&&e.fromDate&&e.cardTranId&&e.mobileNumber&&e.paidTo))return v.warning("Warning!",t,!1,!1,me.time),!1;if(!(8!=e.mode||e.RefdAmt&&e.fromDate&&e.cardTranId&&e.bankName&&e.paidTo))return v.warning("Warning!",t,!1,!1,me.time),!1;if(e.RefdAmt<=0)return v.warning("Warning!","Amount Should be greater than zero",!1,!1,me.time),!1;if(7==e.mode&&e.mobileNumber.length<10)return v.warning("Warning!","Enter Valid Mobile Number",!1,!1,me.time),!1;if(4==e.mode||9==e.mode){var r=moment().month()+1,a=moment().year();if(parseFloat(e.exMonth.month)<parseFloat(r)&&parseFloat(e.exYear.year)<=parseFloat(a)||parseFloat(e.exYear.year)<parseFloat(a))return v.warning("Warning!","Card is expired",!1,!1,me.time),!1}var o,n="";angular.forEach(i.OPVMGenBillsPaymentModeCombo,function(e){e.DT_CODE==i.refund.mode&&(n=e.DETAIL_DESC)}),i.gridgbOptions&&i.gridgbOptions.data.length>0&&i.gridgbOptions.data[0].patColSeqId&&(o=i.gridgbOptions.data[0].patColSeqId);var c={date:e.fromDate,PayMode:n,PayModeCode:e.mode,amtPaid:e.RefdAmt,receivedfrom:e.paidTo,refNo:s.encounterNo,COL_REQ_SEQ_ID:o,TRAN_REQ_TYPE:2,roundOff:e.roundOff?e.roundOff:0,cardExpiryDate:e.exMonth&&e.exYear?e.exMonth.month_id+"/"+e.exYear.year_id:void 0,cardType:e.cardType,payerRadType:e.billAmountType,paymentDate:e.fromDate,cardNumber:e.cardNumber,cardTranId:e.cardTranId,bank:e.bankName,chequeType:e.chqType,chequeDDno:e.CHQDDno,chequeDDDate:e.ChqDDDate,paymentTranType:e.paymentTranType};if(i.gridrefundOptions.data.push(c),i.deposit&&2==i.deposit.Type)i.gridgbdepOptionsApi.selection.getSelectedGridRows()[0].setThisRowInvisible();i.refund={},i.refund.mode=1,i.refund.fromDate=new Date,T(function(){i.gridrefundOptions.selection.selectAllRows()},200)}else{t="Please Select Any Cancelled Bill / Deposit To Make Refund";v.hisAlertMulti("warning","Warning",t,{buttonText:"OK"},close)}},i.calulatePendAmts=function(){if(i.gridGbPaymentOptions&&i.gridGbPaymentOptions.data.length>0){var e=0;i.gbcal.patientPendAmnt=i.gbcal.patientDefPendAmnt,i.gbcal.payerPendAmnt=i.gbcal.payerDefPendAmnt;for(var t=0;t<i.gridGbPaymentOptions.data.length;t++)e=(parseFloat(e)+parseFloat(i.gridGbPaymentOptions.data[t].amtPaid)).toFixed(2);1==i.paym.billAmountType&&i.gbcal.patientPendAmnt>0&&(i.gbBillNo.billno&&"Unbilled"==i.gbBillNo.billno?(i.gbcal.patPendAmtForCSBill=(parseFloat(i.gbcal.patPendDefAmtForCSBill)-parseFloat(i.gbcal.Deposite_Adj)-parseFloat(e)-parseFloat(i.gbcal.Concession_Amt)).toFixed(2),i.gbcal.patPendAmtForCSBill<0&&(i.gbcal.patPendAmtForCSBill=0),i.paym.Amt=i.gbcal.patPendAmtForCSBill):(i.gbcal.patientPendAmnt=(parseFloat(i.gbcal.patientPendAmnt)-parseFloat(e)).toFixed(2),i.gbcal.patientPendAmnt<0&&(i.gbcal.patientPendAmnt=0),i.paym.Amt=i.gbcal.patientPendAmnt)),2==i.paym.billAmountType&&i.gbcal.payerPendAmnt>0&&(i.gbcal.payerPendAmnt=(parseFloat(i.gbcal.payerPendAmnt)-parseFloat(e)).toFixed(2),i.gbcal.payerPendAmnt<0&&(i.gbcal.payerPendAmnt=0),i.paym.Amt=i.gbcal.payerPendAmnt)}i.calRoundOffs()},i.calRoundOffs=function(){var e=0,t=0;1==i.paym.mode?1==i.paym.billAmountType?i.gbBillNo&&"Unbilled"==i.gbBillNo.billno?(e=ue.roundoff(i.gbcal.patPendAmtForCSBill),t=parseFloat(e)-parseFloat(i.gbcal.patPendAmtForCSBill)):(e=ue.roundoff(i.gbcal.patientPendAmnt),t=parseFloat(e)-parseFloat(i.gbcal.patientPendAmnt)):2==i.paym.billAmountType?(e=ue.roundoff(i.gbcal.payerPendAmnt),t=parseFloat(e)-parseFloat(i.gbcal.payerPendAmnt)):3==i.paym.billAmountType&&(i.gbBillNo&&"Unbilled"==i.gbBillNo.billno?(e=i.gbcal.patientPendAmnt,t=0):e=""):1==i.paym.billAmountType?e=i.gbBillNo&&"Unbilled"==i.gbBillNo.billno?i.gbcal.patPendAmtForCSBill:i.gbcal.patientPendAmnt:2==i.paym.billAmountType?e=i.gbcal.payerPendAmnt:3==i.paym.billAmountType&&(e=i.gbBillNo&&"Unbilled"==i.gbBillNo.billno?i.gbcal.patientPendAmnt:"",t=0),0==e&&(t=0),i.paym.Amt=e,i.paym.roundOff=t.toFixed(2)},i.getRoundoff=function(){1==i.paym.mode?(1!=i.paym.billAmountType||parseFloat(i.paym.Amt)-parseFloat(i.paym.roundOff)!=parseFloat(i.gbcal.patientPendAmnt)&&parseFloat(i.paym.Amt)!=parseFloat(i.gbcal.patientPendAmnt))&&(2!=i.paym.billAmountType||parseFloat(i.paym.Amt)-parseFloat(i.paym.roundOff)!=parseFloat(i.gbcal.payerPendAmnt)&&parseFloat(i.paym.Amt)!=parseFloat(i.gbcal.payerPendAmnt))?i.paym.roundOff=0:i.calRoundOffs():i.paym.roundOff=0},i.addToPaymentGrid=function(){var e="Please Fill All Mandatory Fileds.";if(!(1!=i.paym.mode||i.paym.Amt&&i.paym.ReceiveFrom))return v.warning("Warning!",e,!1,!1,me.time),!1;if(!(2!=i.paym.mode&&3!=i.paym.mode||i.paym.Amt&&i.paym.payDate&&i.paym.chqType&&i.paym.CHQDDno&&i.paym.ChqDDDate))return v.warning("Warning!",e,!1,!1,me.time),!1;if(!(4!=i.paym.mode&&9!=i.paym.mode||i.paym.Amt&&i.paym.payDate&&i.paym.cardNumber&&i.paym.cardTranId&&i.paym.cardType&&i.paym.exMonth&&i.paym.exYear))return v.warning("Warning!",e,!1,!1,me.time),!1;if(!(5!=i.paym.mode||i.paym.Amt&&i.paym.payDate&&i.paym.paymentTranType))return v.warning("Warning!",e,!1,!1,me.time),!1;if(!(7!=i.paym.mode||i.paym.Amt&&i.paym.payDate&&i.paym.cardTranId&&i.paym.mobileNumber))return v.warning("Warning!",e,!1,!1,me.time),!1;if(!(8!=i.paym.mode||i.paym.Amt&&i.paym.payDate&&i.paym.cardTranId&&i.paym.bankName))return v.warning("Warning!",e,!1,!1,me.time),!1;if(i.paym.Amt<=0)return v.warning("Warning!","Amount Should be greater than zero",!1,!1,me.time),!1;if(7==i.paym.mode&&i.paym.mobileNumber.length<10)return v.warning("Warning!","Enter Valid Mobile Number",!1,!1,me.time),!1;if(4==i.paym.mode||9==i.paym.mode){var t=moment().month()+1,r=moment().year();if(parseFloat(i.paym.exMonth.month)<parseFloat(t)&&parseFloat(i.paym.exYear.year)<=parseFloat(r)||parseFloat(i.paym.exYear.year)<parseFloat(r))return v.warning("Warning!","Card is expired",!1,!1,me.time),!1}var a="";angular.forEach(i.OPVMGenBillsPaymentModeCombo,function(e){e.DT_CODE==i.paym.mode&&(a=e.DETAIL_DESC)});var o=0;if(i.gridGbPaymentOptions.data.length>0){var s=!1;if(angular.forEach(i.gridGbPaymentOptions.data,function(e){e.amtPaid&&e.amtPaid>0&&(o=parseFloat(o)+parseFloat(e.amtPaid)),e.PayModeCode==i.paym.mode&&(s=!0)}),s)return v.warning("Warning!","Payment Mode "+a+" already exists."),!1}if(3!=i.paym.billAmountType&&i.gbcal){var n=!1;if(i.paym.roundOff||(i.paym.roundOff=0),1==i.paym.billAmountType){parseFloat(i.gbcal.patientPendAmnt)<=0&&(n="No Patient Due Amount To make payment");var c=parseFloat(parseFloat(i.paym.Amt)-parseFloat(i.paym.roundOff)).toFixed(2);parseFloat(c)>parseFloat(i.gbcal.patientPendAmnt)&&(n="Patient payment amount should not be more than patient due amount"),i.gbBillNo.billno&&"Unbilled"==i.gbBillNo.billno&&parseFloat(c)>parseFloat(i.gbcal.patPendAmtForCSBill)&&(n="Payment more then Cash bill amount is not allowed.")}if(2==i.paym.billAmountType){parseFloat(i.gbcal.payerPendAmnt)<=0&&(n="No Payer Due Amount To make payment");var l=parseFloat(parseFloat(i.paym.Amt)-parseFloat(i.paym.roundOff)).toFixed(2);parseFloat(l)>parseFloat(i.gbcal.payerPendAmnt)&&(n="Payer payment amount should not be more than payer due amount")}if(i.gbcal.Due_Amt<=0&&(n="No Due Amount To make payment"),n)return v.warning("Warning!",n,!1,!1,me.time),!1;if(i.gbBillNo.billno&&"Unbilled"==i.gbBillNo.billno)var p=i.gridgbOptionsApi.selection.getSelectedRows();else p=i.getActivebillRecords();if(p.length<=0)return v.warning("Warning!","Please select atleast one service/ bill to add payment",!1,!1,me.time),!1;var d=0,m=0,u=0,S=0;if(angular.forEach(p,function(e){e.PatAmt&&e.PatAmt>0&&(d=parseFloat(d)+parseFloat(e.PatAmt)),e.payerAmt&&e.payerAmt>0&&(m=parseFloat(m)+parseFloat(e.payerAmt)),e.dueAmt&&e.dueAmt>0&&(u=parseFloat(u)+parseFloat(e.dueAmt)),e.PaidAmt&&e.PaidAmt>0&&(S=parseFloat(S)+parseFloat(e.PaidAmt))}),i.gbcal.deductibleAmount&&i.gbcal.deductibleAmount>0&&(m=parseFloat(m)-parseFloat(i.gbcal.deductibleAmount),d=parseFloat(d)+parseFloat(i.gbcal.deductibleAmount)),0==u&&S>0)return v.warning("Warning!","No Due Amount to make payment",!1,!1,me.time),!1;if(i.deposit&&2==i.deposit.Type)var y=[];else y=i.gridgbdepOptionsApi.selection.getSelectedRows();var D=0;y.length>0&&angular.forEach(y,function(e,t){e.appliedAmount>0&&(D=parseFloat(D)+parseFloat(e.appliedAmount))}),d=parseFloat(d)+("Unbilled"==i.gbBillNo.billno?i.gbcal.deductibleAmount:i.gbcal.detableAmount),d=parseFloat(d).toFixed(2),m=parseFloat(m).toFixed(2);var g=parseFloat(parseFloat(o)+parseFloat(i.gbcal.Deposite_Adj)+parseFloat(i.paym.Amt)-parseFloat(i.paym.roundOff)).toFixed(2),A=parseFloat(parseFloat(o)+parseFloat(i.gbcal.Deposite_Adj)+parseFloat(i.paym.Amt)+parseFloat(i.gbcal.Concession_Amt)-parseFloat(i.paym.roundOff)).toFixed(2);if(1==i.paym.billAmountType&&(parseFloat(g)>parseFloat(d)||parseFloat(A)>parseFloat(d)))return v.warning("Warning!","Patient payment amount should not be more than patient amount",!1,!1,me.time),i.paym.Amt="",!1;var I=parseFloat(parseFloat(o)+parseFloat(i.paym.Amt)-parseFloat(i.paym.roundOff)).toFixed(2);if(2==i.paym.billAmountType&&parseFloat(I)>parseFloat(m))return v.warning("Warning!","Payer payment amount should not be more than payer amount",!1,!1,me.time),i.paym.Amt="",!1}var P="";2!=i.paym.mode&&3!=i.paym.mode||(P=i.paym.CHQDDno),4==i.paym.mode&&(P=i.paym.cardTranId);var h={payerRadType:i.paym.billAmountType,PayMode:a,PayModeCode:i.paym.mode,amtPaid:i.paym.Amt,Receivedfrom:i.paym.ReceiveFrom,paymentDate:i.paym.payDate,cardNumber:i.paym.cardNumber,cardTranId:i.paym.cardTranId,bank:i.paym.bankName,chequeType:i.paym.chqType,chequeDDno:i.paym.CHQDDno,chequeDDDate:i.paym.ChqDDDate,paymentTranType:i.paym.paymentTranType,refNo:P,cardExpiryDate:i.paym.exMonth&&i.paym.exYear?i.paym.exMonth.month_id+"/"+i.paym.exYear.year_id:void 0,cardType:i.paym.cardType,roundOff:i.paym.roundOff?i.paym.roundOff:0};i.gridGbPaymentOptions.data.push(h),i.totalpayableAmt=(Number(i.totalpayableAmt)+parseFloat(i.paym.Amt)).toFixed(2),T(function(){i.gridGbPaymentOptions.selection.selectRow(h),i.calulatePendAmts()},50),i.disablePayType=!0,i.setPaymenttodefault(i.paym.billAmountType)},i.issueRefund=function(e){var t=i.gridrefundOptions.selection.getSelectedRows()[0],r=angular.fromJson(sessionStorage.userContextObj),a={};if(t)if(i.deposit&&1==i.deposit.Type)i.showRefundLoadingIcon=!0,a.url="HISServices/HISServices",a.requestData={operation:"savePaymentRefund",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:{"@class":"com.napier.core.collections.vo.ReceiptHeader",colReqSeqId:t.COL_REQ_SEQ_ID,counterCode:"2",gnTranStatus:1,receiptAmount:t.amtPaid,receiptDetailsList:[{"com.napier.core.collections.vo.ReceiptDetails":[{"@class":"com.napier.core.collections.vo.ReceiptDetails",amount:t.amtPaid,gnTranStatus:1,payMode:t.PayModeCode}]}],depositVo:[{"com.napier.core.service.vo.deposits.DepositsVo":[]}],receiptTranType:t.TRAN_REQ_TYPE,receivedFrom:t.receivedfrom,recpSingleOrMultiple:0,remarks:"",requestAmount:t.amtPaid,scrollAdmin:r.USER_SEQ_ID,shiftCode:"3001",totalAmt:t.amtPaid}},P.sendRestRequest(a).then(function(e){if(null==e.data.HITService.message.errorCode){var r="Amount Refunded Successfully";i.showRefundLoadingIcon=!1,i.loadBillNumbers(s.mrNo,i.gbBillNo.billno),i.loadGBDepositeGrid(),i.loadRefundRecieptList();var a={buttonText:"OK"},o={buttonCallBack1:function(){if(2===t.PayModeCode){var r={url:"HISServices/HISServices"};r.requestData={operation:"generateDeposit",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:{"@class":"com.napier.core.collections.vo.ReceiptHeader",depositListVo:{"@class":"com.napier.core.service.vo.deposits.DepositsVo",accSeqId:i.accountSeqData[0].ACC_SEQ_ID,depositAmount:e.data.HITService.message[0]["com.napier.core.collections.vo.ReceiptHeader"].receiptAmount,depositTypeCode:644950312,gnTranStatus:1,gnDepositStatus:7,depositAgainst:3}}},P.sendRestRequest(r).then(function(e){i.gridrefundOptions.data=[],T(function(){i.loadBillNumbers(s.mrNo),i.loadGBDepositeGrid()},200)})}else i.gridrefundOptions.data=[]}};v.hisAlertMulti("success","Success",r,a,o,close),i.showRefundLoadingIcon=!1}else{r="Refund failed",a={buttonText:"OK"};v.failure("Failure",r,!1,!1,me.time),i.showRefundLoadingIcon=!1}});else{var o=i.gridgbdepOptionsApi.selection.getSelectedRows();1==o.length&&m.refundCreditNote(t,o[0]).then(function(e){i.gridrefundOptions.data=[],v.hisAlertMulti("success","Success","Amount Refunded Successfully",!1,!1,i.close,1200),i.loadGBPaymentGridData("",i.gbBillNo.billno),i.loadGBDepositeGrid(),i.loadRefundRecieptList(),i.deposit.Type=1},function(e){v.failure("Failure",e,!1,!1,me.time)})}},i.checkDepositRadio=function(){i.gridgbdepOptionsApi.selection.clearSelectedRows(),i.deposit&&2==i.deposit.Type?i.gridgbdepOptionsApi.selection.setMultiSelect(!1):i.gridgbdepOptionsApi.selection.setMultiSelect(!0)},i.checkDepRefAmt=function(){var e=i.gridgbdepOptionsApi.selection.getSelectedRows();0==e.length?(i.refund.RefdAmt=0,i.refund.roundOff=0):((e[0].appliedAmount<0||parseFloat(i.refund.RefdAmt)>parseFloat(e[0].appliedAmount))&&(i.refund.RefdAmt=parseFloat(e[0].appliedAmount),i.setRefundRounding()),1!=i.refund.mode||parseFloat(i.refund.RefdAmt)-parseFloat(i.refund.roundOff)!=parseFloat(e[0].appliedAmount)&&parseFloat(i.refund.RefdAmt)!=parseFloat(e[0].appliedAmount)?i.refund.roundOff=0:i.setRefundRounding())},i.removeFromPaymentGrid=function(e,t){i.gridGbPaymentOptions.data.splice(t,1),i.totalpayableAmt="0.00";for(var r=0;r<i.gridGbPaymentOptions.data.length;r++)i.totalpayableAmt=(parseFloat(i.totalpayableAmt)+parseFloat(i.gridGbPaymentOptions.data[r].amtPaid)).toFixed(2);0==i.gridGbPaymentOptions.data.length&&(i.disablePayType=!1,i.totalpayableAmt=0),i.calculateGBData()},i.removeFromRefundGrid=function(e,t){(i.gridrefundOptions.data.splice(t,1),i.deposit&&2==i.deposit.Type)&&(i.gridgbdepOptionsApi.selection.getSelectedGridRows()[0].clearThisRowInvisible(),i.calculateGBData())},i.savePaymentORDeposite=function(e){if(i.showPaymentLoadingIcon=!0,e)t=i.gridgbdepOptionsApi.selection.getSelectedRows();else var t=[];if(0==i.gridGbPaymentOptions.data.length&&!e||e&&0==t.length)return v.warning("Warning!","No data to save",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1;if("Unbilled"===i.gbBillNo.billno)i.paymOrdeposit(e);else{if(2==i.paym.billAmountType){var r=new Array,a={1:r},o=I.executeQueryURLReset(),s=new Array,n=i.gbBillNo.billno;return I.prepareParamListWithParam("pBillNo",n,s),I.executeQueryInput("GET_CREDIT_DATA_FOR_CANCEL_001",s,a,!0,!0,o,"popUp",{}).then(function(t){if(r[0].INVC_HD_SEQ_ID)return v.warning("Warning!","Invoice is generated, payment cannot be processed",!1,!1,me.time),i.showGBillCanLoadingIcon=!1,i.showPaymentLoadingIcon=!1,!1;i.paymOrdeposit(e)})}i.paymOrdeposit(e)}},i.paymOrdeposit=function(e){if(3!=i.paym.billAmountType||e){if(e)t=i.gridgbdepOptionsApi.selection.getSelectedRows();else var t=[];if(0==i.gridGbPaymentOptions.data.length&&0==t.length)return v.warning("Warning!","No data to save",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1;if(i.gbBillNo.billno&&"Unbilled"==i.gbBillNo.billno)var r=[];else r=i.getActivebillRecords();if(!i.gbBillNo.billno&&"Unbilled"==i.gbBillNo.billno||r.length<=0)return v.warning("Warning!","Please select atleast one bill to make payment",!1,!1,me.time),i.showPaymentLoadingIcon=!1,i.gridGbPaymentOptions.data=[],i.disablePayType=!1,!1;var a;if("YES"===i.isAllowPartialPay&&!e)if(1==i.paym.billAmountType)if(2==i.psd.partialDueAmountStatusCode){if(i.psd.partialDueAmountArroval)if((a=i.gbcal.patientDefPendAmnt)>0){if(0==i.gridGbPaymentOptions.data.length)return v.warning("Warning!","No data to save For Cash",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1;for(var o=0,n=0;n<i.gridGbPaymentOptions.data.length;n++)o=parseFloat(o)+parseFloat(i.gridGbPaymentOptions.data[n].amtPaid),i.gridGbPaymentOptions.data[n].roundOff&&(o=parseFloat(o)-parseFloat(i.gridGbPaymentOptions.data[n].roundOff)),o=parseFloat(o).toFixed(2);if(parseFloat(o)>parseFloat(a))return v.warning("Warning!","Patient payment amount should not be more than patient amount",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1;var c=parseFloat(i.psd.partialDueAmountArroval)+parseFloat(o);if(parseFloat(c)<parseFloat(a))return v.warning("Warning!","Patient Due Amount is more than Approved Due. Can Not Process The Request.",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1}}else if((a=i.gbcal.patientDefPendAmnt)>0){if(0==i.gridGbPaymentOptions.data.length)return v.warning("Warning!","No data to save For Cash",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1;for(o=0,n=0;n<i.gridGbPaymentOptions.data.length;n++)o=parseFloat(o)+parseFloat(i.gridGbPaymentOptions.data[n].amtPaid),i.gridGbPaymentOptions.data[n].roundOff&&(o=parseFloat(o)-parseFloat(i.gridGbPaymentOptions.data[n].roundOff)),o=parseFloat(o).toFixed(2);if(1==i.psd.partialDueAmountStatusCode&&parseFloat(o)<parseFloat(a))return v.warning("Warning!","Due amount Authorization is pending, cannot process the payment",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1;if((3==i.psd.partialDueAmountStatusCode||!i.psd.partialDueAmountStatusCode)&&parseFloat(o)<parseFloat(a))return v.warning("Warning!","Please collect complete patient due amount",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1}if(e){for(var l="",p=0;p<i.gbBillNUmbers.length;p++)i.gbBillNUmbers[p].BILL_NO==i.gbBillNo.billno&&(l=i.gbBillNUmbers[p]);if(""==l||!l.BILL_SEQ_ID)return v.warning("Warning!","No Bill Data to Adjust Depsoit",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1;if(i.gbcal&&0==t[0].appliedAmount&&(i.gbcal.Due_Amt<=0||i.gbcal.Pat_Amt<=0))return v.warning("Warning!","No Due Amount To Adjust Deposit.",!1,!1,me.time),i.loadGBDepositeGrid(),i.showPaymentLoadingIcon=!1,!1;m.depositBillAdjustment(t,l).then(function(e){if(e.errorCode){var t="Deposit Adjustment Failed.";"DEPOST00001"==e.errorCode&&(t="Requested Deposit is Already Adjusted."),v.warning("Warning!",t,!1,!1,me.time)}else v.success("Success","Deposit Adjusted Successfully",!1,!1,me.time);i.showPaymentLoadingIcon=!1,i.loadGBDepositeGrid(),i.loadGBPaymentGridData(l)},function(e){i.showPaymentLoadingIcon=!1,v.warning("Warning!","Deposit Adjustment Failed.",!1,!1,me.time)})}else{var d="";if(t=[],angular.forEach(r,function(e){e.patColSeqId&&1==i.gridGbPaymentOptions.data[0].payerRadType&&(d=e.patColSeqId),e.payerColSeqId&&2==i.gridGbPaymentOptions.data[0].payerRadType&&(d=e.payerColSeqId)}),""==d)return v.warning("Warning!","No Collection Details to Make Payment",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1;if(i.gbcal&&i.gbcal.Due_Amt<=0)return v.warning("Warning!","No Due Amount To Make Payment",!1,!1,me.time),i.showPaymentLoadingIcon=!1,!1;var u=i.gbBillNo.billno;m.savePaymentData(i.gridGbPaymentOptions.data,i.gbBillNo.billno,d,i.gbcal.Due_Amt,t,i.billSeqids).then(function(e){var t={buttonCallBack1:function(){E.dismissAll()},buttonCallBack2:function(){i.totalpayableAmt=0;var t=u.substring(0,4);i.generatePaymentReport(e.colReqSeqId,e.receiptHdSeqId,-999,t),E.dismissAll()}};e.receiptNo&&v.hisAlertMulti("information","Information","Payment Successful "+e.receiptNo+" do you want to Print?",{buttonText:"No",buttonText2:"Yes"},t,!1),i.showPaymentLoadingIcon=!1,i.gridGbPaymentOptions.data=[],i.disablePayType=!1,i.gridgbOptions.data=[],i.gbcal={},i.loadBillNumbers(s.mrNo),i.loadGBDepositeGrid(),i.paymentReciept(e.colReqSeqId)},function(e){})}}else m.saveDepositeData(i.gridGbPaymentOptions.data,i.accountSeqData[0].ACC_SEQ_ID,i.accountSeqData[0].SUB_ACC_SEQ_ID).then(function(e){var t={buttonCallBack1:function(){var t={pColrequestSeqId:e.collectionReqseqId};j.printReportModal("depositPrintCtrlNew","lg","PDF",t)},buttonCallBack2:function(){}};v.hisAlertMulti("success","Success","Deposit Payment Successful <br/> Do you want to take print?",{buttonText:"Yes",buttonText2:"No"},t,close),i.showPaymentLoadingIcon=!1,i.gridGbPaymentOptions.data=[],i.totalpayableAmt=0,i.disablePayType=!1,i.paym.billAmountType="1",i.loadGBDepositeGrid()},function(e){})},i.gridpayerOptions={},i.gridpayerOptions.columnDefs=[{name:"PayerName",displayName:"Payer Name",width:100},{name:"planClassName",displayName:"Plan/class Name",width:100},{name:"policyNo",displayName:"Policy No.",width:100},{name:"startDate",displayName:"Start Date",width:100},{name:"endDate",displayName:"End Date",width:100},{name:"action",displayName:"Action",width:80,cellTemplate:'<i class="fa fa-umbrella" ng-click="function()"></i><i class="fa fa-trash"></i>'}],i.gridAuthorizationRequestOptions={},i.gridAuthorizationRequestOptions.columnDefs=[{name:"requestDate",displayName:"Request Date",width:100,enableCellEdit:!0},{name:"serviceType",displayName:"Service Type",width:100},{name:"serviceName",displayName:"Service Name",width:100},{name:"dateOfService",displayName:"Date of Service",width:100},{name:"qunty",displayName:"Quantity",width:80},{name:"rate",displayName:"Rate",width:80},{name:"payerOrPlan",displayName:"Payer/Plan",width:100},{name:"authorization",displayName:"Authorization",width:100},{name:"approvedAmt",displayName:"Approved Amt.",width:100},{name:"status",displayName:"Status",width:100},{name:"action",displayName:"Action",width:80,cellTemplate:'<i class="fa fa-pencil" ng-click="row.inlineEdit.enterEditMode($event)"></i><i class="fa fa-trash"></i>'}],i.billsIds=[],i.billsPayIds=[],i.finalErBillCheck=function(){if(i.regTypeData&&i.regTypeData.encounterType&&3==i.regTypeData.encounterType&&i.accountres.SUB_ACC_SEQ_ID){var e=[],t={1:e},r=I.executeQueryURLReset(),a=new Array;return I.prepareParamListWithParam("pEnSeqId",i.accountres.EN_SEQ_ID,a),I.executeQueryInput("ER_VISIT_FINAL_BILL_CHECK",a,t,!0,!0,r,"popUp",{}).then(function(t){e[0]&&e[0].BILL_SEQ_ID?(v.warning("Warning!","Final bill is already generated.",!1,!1,me.time),i.showGBillLoadingIcon=!1):i.generateBillForUnbilled()})}i.generateBillForUnbilled()},i.generateBillForUnbilled=function(){var e=i.gridgbOptionsApi.selection.getSelectedRows();if(i.deposit&&2==i.deposit.Type)var t=[];else t=i.gridgbdepOptionsApi.selection.getSelectedRows();if(i.showGBillLoadingIcon=!0,e.length<=0)return v.warning("Warning!","Please select atleast one service to generate Bill",!1,!1,me.time),i.showGBillLoadingIcon=!1,!1;if(i.gbcal&&i.gbcal.Due_Amt<0&&0==i.gbcal.Deposite_Adj)return v.warning("Warning!","No Due Amount To generate bill",!1,!1,me.time),i.showGBillLoadingIcon=!1,!1;if("YES"===i.isAllowPartialPay){if(0!=i.gridGbPaymentOptions.data.length){if(i.gbBillNo.billno&&"Unbilled"==i.gbBillNo.billno)var r=+(parseFloat(i.gbcal.patPendDefAmtForCSBill)-parseFloat(i.gbcal.Concession_Amt)-parseFloat(i.gbcal.Deposite_Adj)).toFixed(2);else r=+(parseFloat(i.gbcal.Pat_Amt)-parseFloat(i.gbcal.Concession_Amt)-parseFloat(i.gbcal.Deposite_Adj)).toFixed(2);for(var a=0,o=0;o<i.gridGbPaymentOptions.data.length;o++)a=parseFloat(a)+parseFloat(i.gridGbPaymentOptions.data[o].amtPaid),i.gridGbPaymentOptions.data[o].roundOff&&(a=parseFloat(a)-parseFloat(i.gridGbPaymentOptions.data[o].roundOff)),a=parseFloat(a).toFixed(2);if(1==i.psd.partialDueAmountStatusCode&&a<r)return v.warning("Warning!","Due amount Authorization is pending, Can't generate bill with partial payment.",!1,!1,me.time),i.showGBillLoadingIcon=!1,!1;if((3==i.psd.partialDueAmountStatusCode||!i.psd.partialDueAmountStatusCode)&&a<r)return v.warning("Warning!","Can't generate bill with partial payment.",!1,!1,me.time),i.showGBillLoadingIcon=!1,!1;if(2==i.psd.partialDueAmountStatusCode)if(parseFloat(i.psd.partialDueAmountArroval)+parseFloat(a)<r)return v.warning("Warning!","Patient Due Amount is more than Approved Due. Can Not Process The Request for generate bill.",!1,!1,me.time),i.showGBillLoadingIcon=!1,!1}if(i.psd&&i.psd.partialRequestSeqId)var n=i.psd.partialRequestSeqId}m.generateBillForUnbilled(e,i.accountSeqData[0].ACC_SEQ_ID,i.accountSeqData[0].SUB_ACC_SEQ_ID,i.gbcal,i.gridGbPaymentOptions.data,t,i.gridConcReqOptions.data,n).then(function(e){var t=e.data.HITService.message.bill[0]["com.napier.core.billgeneration.vo.Bill"],r=e.data.HITService.message.receiptDetailsList[0]["com.napier.core.collections.vo.ReceiptDetails"],a={buttonClose:function(){for(var e=0,t=0;t<i.RowsArr.length;t++)1!=i.RowsArr[t][0].billStatus&&(e=1);i.orderBtnDisable=0==e}},o={buttonCallBack1:function(){E.dismissAll();for(var e=0,t=0;t<i.RowsArr.length;t++)1!=i.RowsArr[t][0].billStatus&&(e=1);i.orderBtnDisable=0==e},buttonCallBack2:function(){"HSC"==sessionStorage.productCustomization?i.generateBillPrintReportOption("",t.billNo):null==r?angular.forEach(t,function(e,t){i.billsIds=[],i.billsIds=e,i.generateBillReport(e.billSeqId,e.billNo)}):(i.billsPayIds=[],i.billsPayIds=t,angular.forEach(t,function(e,t){var r=e.billNo?e.billNo.substring(0,4):"";i.generatePaymentReport(e.scrollSeqId,-999,-999,r,!0)})),E.dismissAll();for(var e=0,a=0;a<i.RowsArr.length;a++)1!=i.RowsArr[a][0].billStatus&&(e=1);i.orderBtnDisable=0==e}};t=t instanceof Array?t:[t];var n="",c=[];angular.forEach(t,function(e,t){n=n+" & "+e.billNo,c.push(e.billNo)}),n=n.substring(2,n.length),t[0].billNo&&t[0].billSeqId&&("HSC"==i.hscSpecific?i.generateBillPrintReportOptionForMulti(c):v.hisAlertMulti("information","Information","Bill Generation Successful "+n+" do you want to Print?",{buttonText:"No",buttonText2:"Yes"},o,a),i.showGBillLoadingIcon=!1,i.loadBillNumbers(s.mrNo),i.retriveRecords(),T(function(){i.loadGBDepositeGrid()},300))},function(e){v.failure("Failed",e,!1,!1,me.time),i.showGBillLoadingIcon=!1})},i.checkIfPharmacyServiceIsPartial=function(){var e=[],t={1:e},r=I.executeQueryURLReset(),a=new Array;return I.prepareParamListWithParam("pEncId",s.encounterSeqId,a),I.executeQueryInput("CHECK_PHARMACY_ISSUED_OR_NOT",a,t,!0,!0,r,"popUp",{}).then(function(t){if(e.length>0&&"2"!=e[0].issue_status){if("0"==e[0].issue_status)var r="Pharmacy issue is not done. Do you want to continue ?";else r="Pharmacy service is partially taken, Do you want to continue ?";var a={buttonCallBack1:function(){i.finalErBillCheck()},buttonCallBack2:function(){return i.showGBillLoadingIcon=!1,!1}};v.hisAlertMulti("warning","Confirmation",r,{buttonText:"YES",buttonText2:"NO"},a,close)}else i.finalErBillCheck()})},i.checkIfDepositIsAdjForUnbilled=function(){if(i.confirmTempOREmerPat()&&!i.showGBillLoadingIcon){i.showGBillLoadingIcon=!0;var e=i.gridgbdepOptionsApi.selection.getSelectedRows();if(i.gridfOptions.data.length>0&&0==e.length){var t={buttonCallBack1:function(){i.activeBillTab(2),i.showGBillLoadingIcon=!1},buttonCallBack2:function(){i.checkIfPharmacyServiceIsPartial()}};v.hisAlertMulti("warning","Confirmation","Deposit amount is available. Do you want to adjust against bill ?",{buttonText:"YES",buttonText2:"NO"},t,close)}else i.checkIfPharmacyServiceIsPartial()}},i.partialPayAuthBilled=function(e){if(!(parseFloat(e.Pat_Amt)>0))return v.warning("Warning!","Patient Amount should be more than zero",!1,!1,me.time),!1;var t=parseFloat(e.Pat_Amt)-parseFloat(e.Concession_Amt)-parseFloat(e.Deposite_Adj);if(0==t)return v.warning("Warning!","Patient Due Amount should be more than zero",!1,!1,me.time),!1;i.partialPayDetails=e,S.open("PARTIAL PAYMENT AUTHORIZATION",{animation:!0,windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-partial-pay-auth.html",controller:"opVisitPartialPayAuthCtrlNew",controllerAs:"cas",keyboard:!1,resolve:{data:{payAuthTotalAmount:e.Net_Amt,payAuthPatientAmount:t,ordervisitId:sessionStorage.getItem("ordervisitId"),orderencounterSeqId:sessionStorage.getItem("orderencounterSeqId"),orderregSeqId:sessionStorage.getItem("orderregSeqId"),billNo:i.gbBillNo.billno}},backdrop:"static",size:"md"}).result.then(function(e){e&&i.loadGBPaymentGridData("",e)})},i.addNewPayer=function(e){i.modalInstance=S.open("ADD NEW PAYER",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-addNewPayerDetails.html",size:"lg",scope:i}),i.addSelectPayer="",i.insure1=!1,i.corp1=!1,i.spon1=!1},i.selPayer=function(e){"Insurance"!=e&&"Corporate"!=e&&"Sponsor"!=e&&""!=e||(i.addSelectPayer="",i.insure1=!1,i.corp1=!1,i.spon1=!1)},i.getAllPayerDetail=function(e){i.PA.fromDate=new Date,i.serviceData=[],i.singleComboDataForList={1:i.serviceData};var t=I.executeQueryURLReset();return i.serviceDataList=new Array,I.prepareParamListWithParam("pRegSeqId",e,i.serviceDataList),I.executeQueryInput("GET_PAYERS_V0012",i.serviceDataList,i.singleComboDataForList,!0,!0,t,"popUp",i.advSearch).then(function(e){i.AllPayerDetails=e[1]})},i.setNewPayerFormtoDef=function(){i.insure1=!1,i.uplodedDocDetails={},angular.element(document.querySelector("#addNewPayerInsdoc"))[0].value="",i.addNewPayerIns={isPrmry:0,covrgStrtDate:moment()}},i.editPayerDetails=function(e){i.payinsurer(e.INCSEQID),i.addNewPayerIns={crPyrId:e.INCSEQID?e.INCSEQID.toString():void 0,policyNo:e.POLICY_NO,regDocSeqId:e.DOC_SEQID?e.DOC_SEQID:void 0,rank:e.PIRANK?e.PIRANK:void 0,isPrmry:e.IS_PRIMARY?e.IS_PRIMARY:0,dependent:e.PI_DEPENDENT?e.PI_DEPENDENT:void 0,limit:e.LIMIT?e.LIMIT:void 0,CardNumber:e.CARD_NUMBER,covrgStrtDate:e.STARTDATE,covrgEndDate:e.ENDDATE,incPlanSeqId:e.INC_PLAN_SEQ_ID?e.INC_PLAN_SEQ_ID.toString():void 0,editMode:!0,PINS_SEQ_ID:e.PINS_SEQ_ID?e.PINS_SEQ_ID:void 0}},i.updatePrintInClaimForm=function(e){le.updatePrintInClaimForm(e).then(function(e){})},i.viewPayerDocument=function(e){ae.viewUploadedFileFun(e).then(function(e){if(!angular.isUndefined(e.data.HITService.message.uploadDocumnt[0])){var t=e.data.HITService.message.uploadDocumnt[0],r=e.data.HITService.message.docExtension,a=t.replace("dataimage/jpegbase64","").replace("dataapplication/pdfbase64","").replace("dataapplication/vndopenxmlformatsofficedocumentwordprocessingmldocumentbase6\n4","").replace("dataimage/pngbase64","").replace("\n",""),i=r.toLowerCase();if("pdf"==i||"jpg"==i||"png"==i||"gif"==i||"jpeg"==i||"tif"==i||"tiff"==i||"bmp"==i)fe(a,i);else if("xls"==i){var o="data:application/vnd.ms-excel,"+a;window.open(o,"_self")}else if("xlsx"==i){var s="data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"+";base64,"+a;window.open(s,"_self")}else{if("docx"==i||"doc"==i)Te("data:application/octet-stream;base64,"+a,"download.docx")}}})};var fe=function(e,t){S.open("",{animation:!0,templateUrl:"app/consumer/his17_2/ADT/screens/patientAdmission/sections/upload.image.view.modal.html",size:"lg",controller:"viewUploadsCtrl",controllerAs:"viewCtrl",resolve:{imgUrl:function(){return e},extF:function(){return t}}})},Te=function(e,t){var r=document.createElement("a");r.download=t,r.href=e,r.click()};i.nonCoveredSerice=function(e,t,r,a){i.modalInstance=S.open("NON-COVERED SERVICES",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups, noncoveredservices",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-payerNonCoveredServices-modal-popup.html",size:"md",scope:i}),T(function(){var e,o=I.executeQueryURLReset();return i.OPVMsearchBypatientNameList=new Array,i.multipleComboDataForList={1:i.OPVMsearchBypatientNameList},e="003"===a?-999:r,I.prepareParamListWithParam("pPlanSeqId",null!=e?e:-999,i.OPVMsearchBypatientNameList),I.prepareParamListWithParam("pCmpSeqId",t,i.OPVMsearchBypatientNameList),I.executeQueryInput("PAYAUTH_CMP_PLAN_EXCLSN_SERV_LIST",i.OPVMsearchBypatientNameList,i.multipleComboDataForList,!0,!0,o,"popUp",{}).then(function(e){if(i.nonCoveredGridData=[],2==e[1].length)i.nonCoveredGridData.push({SERV_CODE:"No Records Found"});else for(var t=2;t<e[1].length;t++)i.nonCoveredGridData.push({SERV_CODE:e[1][t].SERV_CODE,SERV_NAME:e[1][t].SERV_NAME})})},100)},i.getAllPayersData=function(){var e={1:[]},t=I.executeQueryURLReset(),r=new Array;return I.prepareParamListWithParam("practiceId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,r),I.executeQueryInput("GET_PAYER_DROPDOWN_001",r,e,!0,!0,t,"popUp",i.advSearch).then(function(e){i.AllPayersData=e[1]})},i.getAllPayersData(),i.getAllCorData=function(){i.CorData=[],i.CorDataForList={1:i.CorData};var e=I.executeQueryURLReset();return i.CorDataList=new Array,I.prepareParamListWithParam("practiceId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.CorDataList),I.executeQueryInput("CORP_DROPDOWN",i.CorDataList,i.CorDataForList,!0,!0,e,"popUp",i.advSearch).then(function(e){i.AllCorDetails=e[1]})},i.getAllCorData(),i.getAllInsCreData=function(){i.InsCreData=[],i.InsCreDataForList={1:i.InsCreData};var e=I.executeQueryURLReset();return i.InsCreDataList=new Array,I.prepareParamListWithParam("practiceId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.InsCreDataList),I.executeQueryInput("INSURER_DROPDOWN",i.InsCreDataList,i.InsCreDataForList,!0,!0,e,"popUp",i.advSearch).then(function(e){i.AllInsCreDetails=e[1]})},i.getAllInsCreData(),i.payinsurer=function(e){i.InsPalnData=[],i.InsPalnDataForList={1:i.InsPalnData};var t=I.executeQueryURLReset();return i.InsPalnDataList=new Array,I.prepareParamListWithParam("pPlan",e,i.InsPalnDataList),I.executeQueryInput("PLAN_DROPDOWN",i.InsPalnDataList,i.InsPalnDataForList,!0,!0,t,"popUp",i.advSearch).then(function(e){i.AllInsPalnDetails=e[1]})},i.getAllSpoData=function(){i.SpoData=[],i.SpoDataForList={1:i.SpoData};var e=I.executeQueryURLReset();return i.SpoDataList=new Array,I.prepareParamListWithParam("practiceId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.SpoDataList),I.executeQueryInput("SPONCER_DROPDOWN",i.SpoDataList,i.SpoDataForList,!0,!0,e,"popUp",i.advSearch).then(function(e){i.AllSpoDetails=e[1]})},i.getAllSpoData(),i.sponserChange=function(e){i.SpoPalnData=[],i.SpoPalnDataForList={1:i.SpoPalnData};var t=I.executeQueryURLReset();return i.SpoPalnDataList=new Array,I.prepareParamListWithParam("pSpoSeqId",e,i.SpoPalnDataList),I.executeQueryInput("SPO_PLAN_DROPDOWN",i.SpoPalnDataList,i.SpoPalnDataForList,!0,!0,t,"popUp",i.advSearch).then(function(e){i.AllSpoPalnDetails=e[1]})},i.InsupayerStartDateOptions={format:i.CD.dateOnly.format,maxDate:new Date},i.InsupayerEndDateOptions={format:i.CD.dateOnly.format},i.InsuchangeFromDate=function(e){i.InsupayerEndDateOptions.minDate=e},i.CorpayerStartDateOptions={format:i.CD.dateOnly.format,maxDate:new Date},i.CorpayerEndDateOptions={format:i.CD.dateOnly.format},i.CorchangeFromDate=function(e){i.CorpayerEndDateOptions.minDate=e},i.SpopayerStartDateOptions={format:i.CD.dateOnly.format,maxDate:new Date},i.SpopayerEndDateOptions={format:i.CD.dateOnly.format},i.SpochangeFromDate=function(e){i.SpopayerEndDateOptions.minDate=e},i.addNewInsuranceSave=function(e){if(i.insure1=!0,void 0!==e.crPyrId&&void 0!==e.incPlanSeqId&&void 0!==e.policyNo&&void 0!==e.covrgStrtDate&&void 0!==e.covrgEndDate&&void 0!==e.limit){if(0==e.isPrmry)var t="";else t=e.dependent;try{var r=i.uplodedDocDetails.docSeqId.toString()}catch(e){r=""}if(e.regDocSeqId&&e.editMode){var a="updateOrDeleteInsurance";e.crPyrId=parseInt(e.crPyrId),e.incPlanSeqId=parseInt(e.incPlanSeqId),""==r&&e.regDocSeqId&&(r=e.regDocSeqId.toString())}else a="savePayerInsDetails";var o={url:"HISServices/HISServices"};o.requestData={operation:a,messageId:"",destination:"com.napier.core.billing.service.external.PayerDetailsService",message:{"@class":"com.napier.core.service.vo.billing.InsurenceList",insurenceList:[{"com.napier.core.service.vo.billing.Insurance":[{insuranceSeqId:e.PINS_SEQ_ID&&e.editMode?e.PINS_SEQ_ID:void 0,rgSeqId:s.patientSeqId,crPyrId:e.crPyrId,subscribId:e.policyNo,regDocSeqId:r,rank:e.rank,remarks:e.remarks,isPrmry:e.isPrmry,dependent:t,limit:e.limit,cardNumber:e.CardNumber,covrgStrtDate:moment(e.covrgStrtDate).format("YYYY-MM-DD[T]00:00:00.000Z").split("+")[0]+"Z",covrgEndDate:moment(e.covrgEndDate).format("YYYY-MM-DD[T]00:00:00.000Z").split("+")[0]+"Z",delete:e.PINS_SEQ_ID&&e.editMode?2:void 0,cmpSeqId:{incSeqId:e.crPyrId},insurancePlanMaster:{incPlanSeqId:e.incPlanSeqId},inusranceType:{inTypeSeqCd:e.crPyrId}}]}]}},P.sendRestRequest(o).then(function(t){i.result=t.data;var r={buttonClose:function(){E.dismissAll(),i.getAllPayerDetail(s.patientSeqId),sessionStorage.getItem("orderencounterSeqId")?i.getOrderPayerDetails(sessionStorage.getItem("orderencounterSeqId"),s.patientSeqId):i.getVisitPayerDetails(s.patientSeqId),i.activeFirst=5}};if(-100==i.result.HITService.message.errorCode){var a=i.result.HITService.message.errorMessage;v.hisAlertMulti("failure","Failure",a,"","",r)}else if(2036==i.result.HITService.message.errorCode){a=i.result.HITService.message.errorMessage;v.hisAlertMulti("warning","Warning!",a,"","",r)}else{if(e.editMode)a="Record Updated Successfully ";else a="Record Saved Successfully ";v.hisAlertMulti("success","Success",a,"","",r),i.getPatAllPayers(s.patientSeqId),i.setNewPayerFormtoDef(),R.patientBannerDetail(s.patientSeqId).then(function(e){if(i.upldphotoDoc=e,i.patientBannerDetails=e,e.insurance){var t=e.insurance;(t=t instanceof Array?t:[t])[0].cmpSeqId&&t[0].cmpSeqId.inCompName&&(s.patientGlobalDtlsNew[0].insuranceComp=t[0].cmpSeqId.inCompName),t[0].insurancePlanMaster&&t[0].insurancePlanMaster.inPlanName&&(s.patientGlobalDtlsNew[0].insurancePlan=t[0].insurancePlanMaster.inPlanName),t[0].covrgStrtDate&&t[0].covrgStrtDate.$&&(s.patientGlobalDtlsNew[0].pEffectivedate=t[0].covrgStrtDate.$),t[0].covrgEndDate&&t[0].covrgEndDate.$&&(s.patientGlobalDtlsNew[0].pExpiredate=t[0].covrgEndDate.$),i.noPayer=!0}s.patientGlobalDtlsNew[0].userPermision=12,s.patientName=s.patientGlobalDtlsNew[0].patientName,""==s.tariffSeqId&&(s.tariffSeqId=s.patientGlobalDtlsNew[0].tariffSeqId),s.insuranceComp=s.patientGlobalDtlsNew[0].insuranceComp,s.patCatSeqId=s.patientGlobalDtlsNew[0].patCatSeqId,s.mrNo=s.patientGlobalDtlsNew[0].mrNo}),T(function(){E.dismissAll(),i.getAllPayerDetail(s.patientSeqId),sessionStorage.getItem("orderencounterSeqId")?i.getOrderPayerDetails(sessionStorage.getItem("orderencounterSeqId"),s.patientSeqId):i.getVisitPayerDetails(s.patientSeqId),i.getPayerDetail(s.patientSeqId,sessionStorage.getItem("orderencounterSeqId")),i.activeFirst=5},600)}},function(e){v.failure("Failed",e,!1,!1,me.time)})}},i.planRequired=!1,i.addPayerAuthrList=[],i.disablePlan=!0,i.showErrors=!1,i.showPlanError=!1,i.disablePlan=!0,i.statusReq=!1,$("#removeReqStatusNo").removeClass("req-field"),$("#removeReqStatusAmnt").removeClass("req-field"),$("#removeReqValid").removeClass("req-field"),i.reqFromOrder=!1,i.gotoPreAutherisation=function(e,t){var r={buttonClose:function(){E.dismissAll()}};if("self"!=t[0].payerType.toLocaleLowerCase()){if(t[0].payerAmount==t[0].serviceRate)return v.warning("Warning!","Service is already covered by the Payer, authorization is not allowed",!1,!1,me.time),!1;var a={};a.url=N.updateService.URL,a.requestData={operation:"checkOrderCancel",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.master.vo.ServiceListVo",serviceList:[{"com.napier.core.scm.master.vo.ServiceVo":[{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:t[0].servicePostingSeqId,servDesc:t[0].servName,gnServDesign:null!=t[0].appointReason?t[0].appointReason:2}]}]}},P.sendRestRequest(a).then(function(e){if(""==e.data.HITService.message.serviceList[0]){i.activeFirst=5,i.reqFromOrder=!0;var r=t[0].payerType.split("/");i.OrderPayerName=r[0],i.OrderPlanName=r[1],i.PA.PAServiceType=t[0].serviceTypeCODE,i.PA.PAServiceRequest=t[0].servName,i.PA.serCode=t[0].servCode,i.PA.serSeqId=t[0].servSeqId,i.PA.PAUnitDays=t[0].quantity,i.payerCompPlanseqId=t[0].payerCompPlanseqId,i.payerCompSeqId=t[0].payerCompSeqId,s.orderRowData=t,i.getAllPayerDetail(s.patientSeqId),i.getPatAllPayers(s.patientSeqId)}else v.warning("Warning!","We Can't go for Authorization for this Service",!1,!1,me.time)})}else v.hisAlertMulti("warning","Warning!","Not Authorized for Self","","",r)},i.approvePayerAuthentication=function(e,t){if(null==e.ApprovedAmt||""==e.ApprovedAmt||parseInt(e.ApprovedAmt)<=0)v.warning("Warning!","Please enter valid Appr.Amt",!1,!1,me.time);else{var r="Not Approved";void 0!==e.status&&(r=e.status);var a,o=0;void 0!==s.tariffSeqId&&(o=s.tariffSeqId),a=null!=s.convertedFile?s.convertedFile.split("base64")[1]:"";var n=0;void 0!==s.patCatSeqId&&(n=s.patCatSeqId);var c=0,l=0;void 0!==e.ApprovedAmt&&(c=e.ApprovedAmt),void 0!==e.AuthNumber&&(l=e.AuthNumber);var p=0;if(void 0!==i.payerCompPlanseqId&&(p=i.payerCompPlanseqId),t.$valid&&0==i.statusReq&&0==i.amountValid){var d=moment(e.fromDate).format("YYYY-MM-DD[T]00:00:00.000Z").split("+")[0]+"Z",m={};m.url=N.updateService.URL,m.requestData={operation:"saveNewAuthorization",messageId:"",destination:"com.napier.core.billgeneration.service.external.ApproximateBillService",message:{"@class":"com.napier.core.billgeneration.vo.ApproxBillList",approxBillVos:[{"com.napier.core.billgeneration.vo.ApproxBillVo":[{StrExpectedDays:e.PAUnitDays,tariffSeqId:o,icdCode:"",regSeqId:s.patientSeqId,patientcategorySeqId:n,approxBillDate:d,approvalRefNo:l,approvedAmount:c,payerType:p,subAccSeqId:sessionStorage.getItem("subaccountseqId"),approxBillServiceDtlsVoList:[{"com.napier.core.billgeneration.vo.ApproxBillServiceDtlsVo":[{serviceCode:e.serCode,serviceSeqId:e.serSeqId,serviceName:e.PAServiceRequest,serviceQty:e.PAUnitDays,serviceTax:0,serviceDiscountAmt:0,expcServDate:d,gnTranStatus:1,approvedDetails:r,actualRate:void 0!==s.orderRowData[0].serviceRate?s.orderRowData[0].serviceRate:0}]}],napierDocument:{"@class":"com.napier.core.service.vo.uploadfile.NapierDocument",facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,docName:angular.element(document.querySelector("#PA-payer-upload-file"))[0].value,uploadDocumnt:a,status:"1",createdBy:JSON.parse(sessionStorage.userContextObj).USER_SEQ_ID,createdDate:d,context:15,docTypeSeqId:36,machineIp:JSON.parse(sessionStorage.userContextObj).WORKSTATION,referenceId:0,contextDetailMaster:{"@class":"com.napier.core.service.vo.uploadfile.ContextDetailMaster",code:25}}}]}]}},P.sendRestRequest(m).then(function(e){var t={buttonClose:function(){E.dismissAll(),i.getAddedPreAuths(s.patientSeqId),i.reqFromOrder=!1,i.PA={},i.PA={fromDate:new Date,PAUnitDays:1},angular.element(document.querySelector("#PA-payer-upload-file"))[0].value="",s.convertedFile=null,i.disablePlan=!0,i.showErrors=!1,i.showPlanError=!1,i.statusReq=!1,$("#removeReqStatusNo").removeClass("req-field"),$("#removeReqStatusAmnt").removeClass("req-field"),i.activeFirst=2,i.getPatientPayerAmount()}};if(void 0!==e.data.HITService.message.errorCode){var r=e.data.HITService.message.errorMessage;v.hisAlertMulti("failure","Failure",r,"","",t)}else{r="Request Created Successfully";v.hisAlertMulti("success","Success",r,"","",t)}})}}},i.refreshPatientPayerAmount=function(e,t){i.serviceDataArr=[];var r=new Date,a=moment(r).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";(l={}).url=N.updateService.URL;var o="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,o=i.priorityvis.priorityTypeModel.DT_CODE):("Routine",o=1);var n=o;if(i.setCurrentTarrifId(),1!=e.appointReason){var c=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:e.servSeqId,gnServDesign:1,servCode:e.servCode,servName:e.servName,secServTypeCode:e.serviceTypeCODE,priServTypCode:e.serviceTypeCODE},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:e.servSeqId,tariffSeqId:s.tariffSeqId,datedOn:a,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},quantity:e.quantity,transType:1,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:e.requestedByEmpSeqID,payerId:i.payerTypeModel.PayerType.PINS_SEQ_ID,fromOPVisit:"Y",priority:n}];i.serviceDataArr.push(c),l.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.serviceDataArr}]}}}else{var l,p={"@class":"com.napier.core.service.vo.visitmanagement.VisitConfigurationDetails",doctorSeqId:e.requestedByEmpSeqID,tariffSeqId:s.tariffSeqId,regSeqId:sessionStorage.getItem("orderregSeqId"),enSeqId:sessionStorage.getItem("orderencounterSeqId"),payerId:e.payerTypeCode,quantity:e.quantity};(l={}).url=N.updateService.URL,l.requestData={operation:"getServiceRateByDoctorSpecialitywise",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:p}}P.sendRestRequest(l).then(function(e){i.serResponce=e.data.HITService.message;for(var r=i.serResponce.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"],a=0;a<i.RowsArr.length;a++)i.RowsArr[a][0].servSeqId==t.servSeq&&i.RowsArr[a][0].payerType==t.plan&&1!=i.RowsArr[a][0].billStatus&&(i.RowsArr[a][0].patientAmount=r.patientAmount,i.RowsArr[a][0].payerAmount=r.payerAmount,i.RowsArr[a][0].originalPatientAmount=r.originalPatientAmount,i.RowsArr[a][0].originalPayerAmount=r.originalPayerAmount,i.RowsArr[a][0].servicePayerAuthorization=r.servicePayerAuthorization)})},i.getPatientPayerAmount=function(){i.serviceDataArr=[];var e=new Date,t=moment(e).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z";(n={}).url=N.updateService.URL;var r="";void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel?(i.priorityvis.priorityTypeModel.DETAIL_DESC,r=i.priorityvis.priorityTypeModel.DT_CODE):("Routine",r=1);var a=r;if(i.setCurrentTarrifId(),1!=s.orderRowData[0].appointReason){var o=[{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:s.orderRowData[0].servSeqId,gnServDesign:1,servCode:s.orderRowData[0].servCode,servName:s.orderRowData[0].servName,secServTypeCode:s.orderRowData[0].serviceTypeCODE,priServTypCode:s.orderRowData[0].serviceTypeCODE},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:s.orderRowData[0].servSeqId,tariffSeqId:s.tariffSeqId,datedOn:t,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},quantity:s.orderRowData[0].quantity,transType:1,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:s.orderRowData[0].requestedByEmpSeqID,payerId:i.payerTypeModel.PayerType.PINS_SEQ_ID,fromOPVisit:"Y",priority:a}];i.serviceDataArr.push(o),n.requestData={operation:"getServicesPostingDetails",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":i.serviceDataArr}]}}}else{var n,c={"@class":"com.napier.core.service.vo.visitmanagement.VisitConfigurationDetails",doctorSeqId:s.orderRowData[0].requestedByEmpSeqID,tariffSeqId:s.tariffSeqId,regSeqId:sessionStorage.getItem("orderregSeqId"),enSeqId:sessionStorage.getItem("orderencounterSeqId"),payerId:s.orderRowData[0].payerTypeCode,quantity:s.orderRowData[0].quantity};(n={}).url=N.updateService.URL,n.requestData={operation:"getServiceRateByDoctorSpecialitywise",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:c}}P.sendRestRequest(n).then(function(e){i.serResponce=e.data.HITService.message;var t=i.serResponce.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"];s.orderRowData[0].patientAmount=t.patientAmount,s.orderRowData[0].payerAmount=t.payerAmount;let r=null!=t.copayAmt?parseFloat(t.copayAmt):parseFloat(0);s.orderRowData[0].originalPatientAmount=null==t.companyPayingAmt||0==t.companyPayingAmt?t.serviceRate:parseFloat(t.companyPayingAmt)>t.serviceRate?parseFloat(0):null!=t.actualRate&&parseFloat(t.companyPayingAmt)+r>=t.actualRate?parseFloat(0):parseFloat((t.serviceRate-parseFloat(t.companyPayingAmt)).toFixed(2))-r,s.orderRowData[0].originalPayerAmount=null==t.companyPayingAmt||0==t.companyPayingAmt?parseFloat(0):parseFloat(t.companyPayingAmt)>t.serviceRate?t.serviceRate:null!=t.actualRate&&parseFloat(t.companyPayingAmt)+r>=t.actualRate?t.serviceRate:t.companyPayingAmt+r>t.serviceRate?t.serviceRate:t.companyPayingAmt+r,s.orderRowData[0].servicePayerAuthorization=t.servicePayerAuthorization,i.preAuthRcdList=[],i.preAuthHdrRcdList={},le.opPreAuthGetData(i,i.RowsArr)})},i.amountValid=!1,s.orderRowData=null,i.amountValidation=function(e){if(void 0!==s.orderRowData){var t=s.orderRowData[0].serviceRate*s.orderRowData[0].quantity;i.amountValid=e>t}},i.setPlanValidation=function(e){i.showPlanError=!1},i.addPayerAuthentication=function(e,t){i.showErrors=!0,"004"!=e.PAPayer.INS_TYPE?void 0!==e.PApayerSelectPlan&&null!=e.PApayerSelectPlan?i.showPlanError=!1:i.showPlanError=!0:i.showPlanError=!1,"Approved"==e.status||"Partially Approved"==e.status?(void 0!==e.AuthNumber?i.statusReq=!1:i.statusReq=!0,void 0!==e.ApprovedAmt?i.statusReq=!1:i.statusReq=!0):i.statusReq=!1;var r=0,a=0,o=0,n="Not Approved",c=0;if(t.$valid&&0==i.statusReq){var l;i.showPlanError=!1,void 0!==e.ApprovedAmt&&(r=e.ApprovedAmt),void 0!==e.AuthNumber&&(a=e.AuthNumber),o=void 0!==e.PApayerSelectPlan?e.PApayerSelectPlan.PINS_SEQ_ID:i.AllPatPlanDetails[0].PINS_SEQ_ID,void 0!==e.status&&(n=e.status),void 0!==s.tariffSeqId&&(c=s.tariffSeqId),l=null!=s.convertedFile?s.convertedFile.split("base64")[1]:"";var p=0;void 0!==s.patCatSeqId&&(p=s.patCatSeqId);var d=moment(e.fromDate).format("YYYY-MM-DD[T]00:00:00.000Z").split("+")[0]+"Z",m={};m.url=N.updateService.URL,m.requestData={operation:"saveNewAuthorization",messageId:"",destination:"com.napier.core.billgeneration.service.external.ApproximateBillService",message:{"@class":"com.napier.core.billgeneration.vo.ApproxBillList",approxBillVos:[{"com.napier.core.billgeneration.vo.ApproxBillVo":[{StrExpectedDays:e.PAUnitDays,tariffSeqId:c,icdCode:"",regSeqId:s.patientSeqId,patientcategorySeqId:p,approxBillDate:d,approvalRefNo:a,approvedAmount:r,payerType:o,approxBillServiceDtlsVoList:[{"com.napier.core.billgeneration.vo.ApproxBillServiceDtlsVo":[{serviceCode:e.serCode,serviceSeqId:e.serSeqId,serviceName:e.PAServiceRequest,serviceQty:1,serviceTax:0,serviceDiscountAmt:0,expcServDate:d,gnTranStatus:1,approvedDetails:n}]}],napierDocument:{"@class":"com.napier.core.service.vo.uploadfile.NapierDocument",facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,docName:angular.element(document.querySelector("#PA-payer-upload-file"))[0].value,uploadDocumnt:l,status:"1",createdBy:JSON.parse(sessionStorage.userContextObj).USER_SEQ_ID,createdDate:d,context:15,docTypeSeqId:36,machineIp:JSON.parse(sessionStorage.userContextObj).WORKSTATION,referenceId:0,contextDetailMaster:{"@class":"com.napier.core.service.vo.uploadfile.ContextDetailMaster",code:25}}}]}]}},P.sendRestRequest(m).then(function(e){var t={buttonClose:function(){E.dismissAll();var e=r.HITService.message.approxBillVos[0]["com.napier.core.billgeneration.vo.ApproxBillVo"][0];r.HITService.message.approxBillVos[0]["com.napier.core.billgeneration.vo.ApproxBillVo"][1],e.approxBillServiceDtlsVoList[0]["com.napier.core.billgeneration.vo.ApproxBillServiceDtlsVo"];i.PA={},i.PA={fromDate:new Date,PAUnitDays:1},angular.element(document.querySelector("#PA-payer-upload-file"))[0].value="",s.convertedFile=null,i.disablePlan=!0,i.showErrors=!1,i.showPlanError=!1,i.statusReq=!1}},r=e.data;if(-100==r.HITService.message.errorCode){var a=r.HITService.message.errorMessage;v.hisAlertMulti("failure","Failure",a,"","",t)}else if(2044==r.HITService.message.errorCode){a=r.HITService.message.errorMessage;v.hisAlertMulti("warning","Warning!",a,"","",t)}else{a="Request Created Successfully";v.hisAlertMulti("success","Success",a,"","",t),$("#removeReqStatusNo").removeClass("req-field"),$("#removeReqStatusAmnt").removeClass("req-field"),i.getAddedPreAuths(s.patientSeqId),T(function(){E.dismissAll();var e=r.HITService.message.approxBillVos[0]["com.napier.core.billgeneration.vo.ApproxBillVo"][0];r.HITService.message.approxBillVos[0]["com.napier.core.billgeneration.vo.ApproxBillVo"][1],e.approxBillServiceDtlsVoList[0]["com.napier.core.billgeneration.vo.ApproxBillServiceDtlsVo"];i.PA={},i.PA={fromDate:new Date,PAUnitDays:1},angular.element(document.querySelector("#PA-payer-upload-file"))[0].value="",s.convertedFile=null,i.disablePlan=!0,i.showErrors=!1,i.showPlanError=!1,i.statusReq=!1},3e3)}})}},i.getProvisionalBill=function(){0!=i.gridgbOptionsApi.selection.getSelectedRows().length?c.open({animation:!0,templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/sections/provisional.bill.modal.html",size:"sm",backdrop:"static",controller:"PrintTypeSelection",resolve:{selectedPrintType:function(){return!1}}}).result.then(function(e){for(var t=[],r=0;r<i.gridgbOptionsApi.selection.getSelectedRows().length;r++){var a=i.gridgbOptionsApi.selection.getSelectedRows()[r];if(4!=a.payerType&&"PDF"!=e){var o=a.accPayerSeqId,n=a.planSeqId;t.push(a.servicePostingSeqId)}else 4==a.payerType&&"PDF"==e&&t.push(a.servicePostingSeqId)}if(o||"PDF"==e)if(0!=t.length||"PDF"!=e){var c={reportId:"PDF"==e?"OPProvisionalCashBillReportID":"OPProvisionalBillCreditReportID",pSubSeqId:i.accountres.SUB_ACC_SEQ_ID,pEnNo:s.encounterSeqId,pBillStatus:0,pServSeqId:_.toString(t),pPayerSeqId:"PDF"!=e?o:-999,pPlanSeqId:"PDF"!=e?n:-999,coPayAmount:parseFloat(i.gbcal.coPay).toFixed(2),deductableAmount:parseFloat(i.gbcal.deductibleAmount).toFixed(2),totalNetPatientAmount:parseFloat(i.gbcal.Pat_Amt).toFixed(2),totalNetPayerAmount:parseFloat(i.gbcal.Payr_Amt).toFixed(2),ConcessonAmount:parseFloat(i.gbcal.Concession_Amt).toFixed(2),AdjustmentAmount:parseFloat(i.gbcal.Deposite_Adj).toFixed(2),PaidAmount:parseFloat(i.gbcal.Paid_Amt).toFixed(2),DueAmount:parseFloat(i.gbcal.Due_Amt).toFixed(2),totalBillNetAmount:parseFloat(i.gbcal.Net_Amt).toFixed(2),isCash:"PDF"==e};j.printReportModal("labelPrintController","lg","PDF",c)}else v.warning("Warning!","No services for Provisional Cash bill",!1,!1,me.time);else v.warning("Warning!","No services for Provisional Credit bill",!1,!1,me.time)}):v.warning("Warning!","Please select atleast one service to Provisional Bill",!1,!1,me.time)},i.changePayerName=function(e){if(void 0!==e){if("004"==e.INS_TYPE||4==e.INS_TYPE){i.disablePlan=!0,$("#removeReqValid").removeClass("req-field"),i.showPlanError=!1,i.planRequired=!1,i.patPlanData=[],i.patPlanComboDataList={1:i.patPlanData};var t=I.executeQueryURLReset();return i.patPlanDataList=new Array,I.prepareParamListWithParam("pRegSeqId",s.patientSeqId,i.patPlanDataList),I.prepareParamListWithParam("pCompId",e.PINS_SEQ_ID,i.patPlanDataList),I.executeQueryInput("GET_PAYERS_INSURANCE_PLAN",i.patPlanDataList,i.patPlanComboDataList,!0,!0,t,"popUp",i.advSearch).then(function(e){i.AllPatPlanDetails=e[1]})}i.disablePlan=!1,i.planRequired=!0,$("#removeReqValid").addClass("req-field"),i.patPlanData=[],i.patPlanComboDataList={1:i.patPlanData};t=I.executeQueryURLReset();return i.patPlanDataList=new Array,I.prepareParamListWithParam("pRegSeqId",s.patientSeqId,i.patPlanDataList),I.prepareParamListWithParam("pCompId",e.PINS_SEQ_ID,i.patPlanDataList),I.executeQueryInput("GET_PAYERS_INSURANCE_PLAN",i.patPlanDataList,i.patPlanComboDataList,!0,!0,t,"popUp",i.advSearch).then(function(e){i.AllPatPlanDetails=e[1]})}i.planRequired=!1,i.disablePlan=!0,i.showPlanError=!1,$("#removeReqValid").removeClass("req-field")},i.openPayerServices=function(e){var t="",r="",a="";null!=e&&(t=void 0!==e.PAServiceRequest?void 0!==e.PAServiceRequest.SERV_NAME?null!=e.PAServiceRequest.length?e.PAServiceRequest:e.PAServiceRequest.SERV_NAME:e.PAServiceRequest:"",void 0!==e.PAServiceType&&(r=e.PAServiceType),a=void 0!==e.PAServiceRequest&&void 0!==e.PAServiceRequest.SERV_CODE?null!=e.PAServiceRequest.length?"":e.PAServiceRequest.SERV_CODE:""),i.PAService={PAServiceName:t,PAServiceType:r},i.modalInstance=S.open("SEARCH SERVICE",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popuervice-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-order-service-PayerAuthentication-popup.html",size:"lg",scope:i});var o;o={PAServiceName:t,PAServiceId:a,PAServiceType:r},T(function(){i.getPayerServices(o)},100)},i.PAService={},i.PA={},i.getPayerServices=function(e){var t=e.PAServiceName,r=e.PAServiceId;if(void 0!==t)var a=t+"%";else a="%%";if(void 0!==r)var o=r+"%";else o="%%";i.advServicename=[],i.advServicenamesList={1:i.advServicename};var n=I.executeQueryURLReset();return i.advServiceList=new Array,I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.advServiceList),I.prepareParamListWithParam("pFacilityId",ye,i.advServiceList),I.prepareParamListWithParam("pServCode",o,i.advServiceList),I.prepareParamListWithParam("pServName",a,i.advServiceList),I.prepareParamListWithParam("pPriServTypeCode",e.PAServiceType,i.advServiceList),I.prepareParamListWithParam("pSecServTypeCode","",i.advServiceList),I.prepareParamListWithParam("pServTypeCode","",i.advServiceList),I.prepareParamListWithParam("pServDesign","",i.advServiceList),I.prepareParamListWithParam("pFlowElement",2,i.advServiceList),I.prepareParamListWithParam("pServStatus",1,i.advServiceList),I.prepareParamListWithParam("pServDefStatus",1,i.advServiceList),I.prepareParamListWithParam("pDepartment","",i.advServiceList),I.prepareParamListWithParam("pIsEmergency",-999,i.advServiceList),I.prepareParamListWithParam("pExcludePri",7,i.advServiceList),I.prepareParamListWithParam("pTariffCode",s.tariffSeqId,i.advServiceList),I.executeQueryInput("SCM_SERVICE_LIST_NEW_OP",i.advServiceList,i.advServicenamesList,!0,!0,n,"popUp",{}).then(function(e){var t=e[1];i.oppayerserviceGrid.data=[];for(var r=0;r<t.length;r++)i.oppayerserviceGrid.data.push({INFL_SEQ_ID:t[r].INFL_SEQ_ID,RCV_SEQ_ID:t[r].RCV_SEQ_ID,SERV_CODE:t[r].SERV_CODE,SERV_NAME:t[r].SERV_NAME,SERV_SEQ_ID:t[r].SERV_SEQ_ID,DESCRIPTION:t[r].DESCRIPTION,CODE:t[r].CODE})})},i.ServiceTypeAhead=function(e,t){var r=e+"%";i.OPVMDoctroSearch=[],i.multipleComboDataForList={1:i.OPVMDoctroSearch};var a=I.executeQueryURLReset();return i.OPVMDoctSearch=new Array,I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,i.OPVMDoctSearch),I.prepareParamListWithParam("pFacilityId",ye,i.OPVMDoctSearch),I.prepareParamListWithParam("pServCode","%%",i.OPVMDoctSearch),I.prepareParamListWithParam("pServName",r,i.OPVMDoctSearch),I.prepareParamListWithParam("pPriServTypeCode",i.PAService.PAServiceType,i.OPVMDoctSearch),I.prepareParamListWithParam("pSecServTypeCode","",i.OPVMDoctSearch),I.prepareParamListWithParam("pServTypeCode","",i.OPVMDoctSearch),I.prepareParamListWithParam("pServDesign","",i.OPVMDoctSearch),I.prepareParamListWithParam("pFlowElement",2,i.OPVMDoctSearch),I.prepareParamListWithParam("pServStatus",1,i.OPVMDoctSearch),I.prepareParamListWithParam("pServDefStatus",1,i.OPVMDoctSearch),I.prepareParamListWithParam("pDepartment","",i.OPVMDoctSearch),I.prepareParamListWithParam("pIsEmergency",-999,i.OPVMDoctSearch),I.prepareParamListWithParam("pExcludePri",7,i.OPVMDoctSearch),I.prepareParamListWithParam("pTariffCode",s.tariffSeqId,i.OPVMDoctSearch),I.executeQueryInput("SCM_SERVICE_LIST_NEW_OP",i.OPVMDoctSearch,i.multipleComboDataForList,!0,!0,a,"popUp",{}).then(function(e){if(0!==e)return $("#no-result-found_service").hide(),(e[1]instanceof Array?e[1]:[e[1]]).map(function(e){return e});i.noResults=!0,$("#no-result-found_service").show()})},i.selectPayerService=function(e,t,r,a,o){i.PA.PAServiceRequest=e.SERV_NAME,i.PA.serCode=e.SERV_CODE,i.PA.serSeqId=e.SERV_SEQ_ID,i.PA.PAServiceType=e.CODE},i.setPayerServiceType=function(e){i.PAService={PAServiceType:e.PAServiceType}},i.getPAServiceData=function(){var e=i.gridoppayerser.selection.getSelectedRows();""!=e&&(E.dismissAll(),i.PA.PAServiceRequest=e[0].SERV_NAME,i.PA.serCode=e[0].SERV_CODE,i.PA.PAServiceType=e[0].CODE,i.PA.serSeqId=e[0].SERV_SEQ_ID,$("#no-result-found_service").hide())},i.oppayerserviceGrid.onRegisterApi=function(e){i.gridoppayerser=e},i.showGridErrors=!1,i.updatePayerAutherisation=function(e,t,r){i.showGridErrors=!0;var a=0,o=0,n=0;if(void 0!==s.tariffSeqId&&(a=s.tariffSeqId),void 0!==e.apprAmnt&&void 0!==e.autherNum){var c;i.showGridErrors=!1,void 0!==e.apprAmnt&&0!=e.apprAmnt.length&&(o=e.apprAmnt),void 0!==e.autherNum&&0!=e.autherNum.length&&(n=e.autherNum),c=null!=angular.element(document.querySelector("#addedImage"+r))[0].value&&""!=angular.element(document.querySelector("#addedImage"+r))[0].value?angular.element(document.querySelector("#addedImage"+r))[0].value.split("base64")[1]:"";var l=0;void 0!==s.patCatSeqId&&(l=s.patCatSeqId);var p={};p.url=N.updateService.URL,p.requestData={operation:"updateNewAuthorization",messageId:"",destination:"com.napier.core.billgeneration.service.external.ApproximateBillService",message:{"@class":"com.napier.core.billgeneration.vo.ApproxBillList",approxBillVos:[{"com.napier.core.billgeneration.vo.ApproxBillVo":[{StrExpectedDays:e.qty,tariffSeqId:a,icdCode:"",regSeqId:s.patientSeqId,patientcategorySeqId:l,approxBillDate:e.reqDateDummy,approvalRefNo:n,approvedAmount:o,payerType:e.payerType,approxBillHdSeqId:e.approxBillHdSeqId,approxBillServiceDtlsVoList:[{"com.napier.core.billgeneration.vo.ApproxBillServiceDtlsVo":[{serviceCode:"asdasd12",approxBillDtSeqId:e.serviceSeqId,serviceName:e.serName,serviceQty:e.qty,serviceTax:0,serviceDiscountAmt:0,expcServDate:e.serDateDummy,gnTranStatus:1,approvedDetails:e.status}]}],napierDocument:{"@class":"com.napier.core.service.vo.uploadfile.NapierDocument",facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,docName:angular.element(document.querySelector("#PA-payer-upload-file"+r))[0].value,uploadDocumnt:c,status:"1",createdBy:JSON.parse(sessionStorage.userContextObj).USER_SEQ_ID,createdDate:e.serDateDummy,context:15,docTypeSeqId:36,docSeqId:e.docSeqId,machineIp:JSON.parse(sessionStorage.userContextObj).WORKSTATION,referenceId:e.approxBillHdSeqId,contextDetailMaster:{"@class":"com.napier.core.service.vo.uploadfile.ContextDetailMaster",code:25}}}]}]}},P.sendRestRequest(p).then(function(t){var r={buttonClose:function(){E.dismissAll(),$("#removeReqStatusNo").removeClass("req-field"),$("#removeReqStatusAmnt").removeClass("req-field"),i.getAddedPreAuths(s.patientSeqId)}};if(void 0!==t.data.HITService.message.errorCode){var a=t.data.HITService.message.errorMessage;v.hisAlertMulti("failure","Failure",a,"","",r)}else if(void 0===t.data.HITService.message.approxBillVos){a=t.data.HITService.message.errorMessage;v.hisAlertMulti("failure","Failure",a,"","",r)}else{a="Request Created Successfully";v.hisAlertMulti("success","Success",a,"","",r),T(function(){E.dismissAll(),$("#removeReqStatusNo").removeClass("req-field"),$("#removeReqStatusAmnt").removeClass("req-field"),i.getAddedPreAuths(s.patientSeqId),i.editedPayRecord="";for(var t=0;t<i.RowsArr.length;t++)i.RowsArr[t][0].servSeqId==e.servSeq&&i.RowsArr[t][0].payerType==e.plan&&1!=i.RowsArr[t][0].billStatus&&(i.editedPayRecord=i.RowsArr[t][0]);""!=i.editedPayRecord&&i.refreshPatientPayerAmount(i.editedPayRecord,e)},600)}}),e.$edit=!1}},i.deleteAuthRequest=function(e){var t={buttonCallBack1:function(){i.deletePreAuthRcrd=!0,i.preAuth.viewPreAuth=!1,i.preAuthBillNav=!0,i.getPreAuthData(e,!0)},buttonCallBack2:function(){}};v.hisAlertMulti("warning","Confirmation","Do you really want to delete the record ?",{buttonText:"YES",buttonText2:"NO"},t,close)},i.storecurrentValues=function(e){e.dummyRefNo=e.autherNum,e.dummyApprAmnt=e.apprAmnt,e.dummyStatus=e.status;var t={};t.url=N.updateService.URL,t.requestData={operation:"getUploadedDocuments",messageId:"",destination:"com.napier.core.billgeneration.service.external.ApproximateBillService",message:{"@class":"com.napier.core.service.vo.uploadfile.NapierDocument",docSeqId:e.docSeqId}},P.sendRestRequest(t).then(function(t){var r=t.data.HITService.message.napierDocumentList[0]["com.napier.core.service.vo.uploadfile.NapierDocument"],a=e.docName;i.dotFormat2=a.split(".")[1];var o=r.uploadDocumnt[0].replace(/ +/g,""),s="data:application/"+i.dotFormat2+";base64,"+o;e.documentData=s})},i.displayPrevData=function(e){e.autherNum=e.dummyRefNo,e.apprAmnt=e.dummyApprAmnt,e.status=e.dummyStatus},i.viewRecordData=function(e,t){i.getPreAuthData(e),i.preAuth.viewPreAuth=!0,i.getEditActive(e,t)},i.openGridFileUpload=function(e,t){var r=e+t;angular.element(document.querySelector("#currentIndex"))[0].value=t,angular.element(document.querySelector("#"+r)).click()},i.captureGridUploadedImage=function(e,t){s.fileobj=e.files[0];var r=t+angular.element(document.querySelector("#currentIndex"))[0].value,a=angular.element(document.querySelector("#currentIndex"))[0].value,o=e.files[0];if(o.size>i.allowedFileSize)v.warning("Warning!","File size can not be more than 5MB",!1,!1,me.time);else{angular.element(document.querySelector("#"+r))[0].defaultValue=s.fileobj.name,angular.element(document.querySelector("#"+r))[0].value=s.fileobj.name;var n=new FileReader;n.readAsDataURL(o),n.onload=function(){n.result&&(angular.element(document.querySelector("#addedImage"+a))[0].value=n.result)}}},i.viewUploadedFile=function(){"png"==i.dotPAFormat2||"JPG"==i.dotPAFormat2||"jpeg"==i.dotPAFormat2||"jpg"==i.dotPAFormat2?i.modalInstance=S.open("View File",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-PreAuthFileShow.html",size:"md",scope:i}):F.open(i.PreauthFileLink,"windowName")},i.setValidationonStatus=function(e){"Approved"==e||"Partially Approved"==e?($("#removeReqStatusNo").addClass("req-field"),$("#removeReqStatusAmnt").addClass("req-field")):(i.statusReq=!1,$("#removeReqStatusNo").removeClass("req-field"),$("#removeReqStatusAmnt").removeClass("req-field"))},i.patientBannerCollapsedAction=function(){i.patientBannerCollapsed=!i.patientBannerCollapsed,i.patientBannerVisible=!1,i.visitDetails=!1,i.disableVisitInfo=!1},i.VisitHistoryGrid.onRegisterApi=function(e){i.gridVHApi=e,i.gridVHApi.expandable.on.rowExpandedStateChanged(i,function(e){e.entity.norecords&&(e.isExpanded=!1),e.isExpanded&&(i.gridVHApi.expandable.collapseAllRows(),e.isExpanded=!0,i.getVisitHistoryDetails(e))})},i.getVisitHistoryDetails=function(e){e.entity.subGridOptions.data=[];var t=I.executeQueryURLReset(),r=new Array,a={1:r},i=new Array;return I.prepareParamListWithParam("pVisit_seq_id",e.entity.VISIT_SEQ_ID,i),I.executeQueryInput("OPVM_SP_VISIT_HISTORY_SUB_GRID",i,a,!0,!0,t,"popUp",{}).then(function(t){var a=25;if(r.length>0){var i=[],o=!1;angular.forEach(r,function(e,t){let r={};if(r=e,e.PACKAGE_NAME&&""!=e.PACKAGE_NAME){if(o!=e.PARENT_SP_SEQ_ID){o=e.PARENT_SP_SEQ_ID;let t={SERV_NAME:e.PACKAGE_NAME,PACKAGE_MAIN:!0};i.push(t)}r.PACKAGE_SUB=!0}else o=!1;i.push(r)}),a=parseInt(e.entity.subGridOptions.rowHeight)*parseInt(i.length),e.entity.subGridOptions.data=angular.copy(i)}e.expandedRowHeight=parseInt(e.entity.subGridOptions.headerRowHeight+e.entity.subGridOptions.gridFooterHeight+a+5)})},i.getVisitHistoryData=function(){i.VisitHistoryGrid.data=[];var e=I.executeQueryURLReset(),t=new Array,r={1:t},a=new Array;return I.prepareParamListWithParam("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,a),I.prepareParamListWithParam("pRegSeqId",sessionStorage.getItem("episodeRegSeqid"),a),I.prepareParamListWithParam("pFacilityId",angular.fromJson(sessionStorage.userContextObj).FACILITY_ID,a),i.visitsearch.fromDate&&I.prepareParamListWithParam("Pfromdate",moment(i.visitsearch.fromDate).format("YYYY-MM-DD"),a),i.visitsearch.toDate&&I.prepareParamListWithParam("Ptodate",moment(i.visitsearch.toDate).format("YYYY-MM-DD"),a),i.visitsearch.speciality&&i.visitsearch.speciality.CODE&&I.prepareParamListWithParam("pSpecCode",i.visitsearch.speciality.CODE,a),i.visitsearch.Doctor&&i.visitsearch.Doctor.DOCTID&&I.prepareParamListWithParam("pDoctorId",i.visitsearch.Doctor.DOCTID,a),I.executeQueryInput("NEW_VISIT_HISTORY_WITH_DOC_DATA",a,r,!0,!0,e,"popUp",{}).then(function(e){t.length>0&&(angular.forEach(t,function(e,t){e.subGridOptions=angular.copy(de),e.CHARGES&&(e.CHARGES=parseFloat(e.CHARGES).toFixed(2)),e.BALANCE&&(e.BALANCE=parseFloat(e.BALANCE).toFixed(2))}),i.VisitHistoryGrid.data=angular.copy(t),T(function(){i.gridVHApi.grid.rows[0].isExpanded=!0,i.getVisitHistoryDetails(i.gridVHApi.grid.rows[0])},200))})},i.setVisitHistoryToDef=function(){i.visitsearch={},i.visitsearch.fromDateOptions={format:i.CD.dateOnly.format,maxDate:moment()},i.visitsearch.toDateOptions={format:i.CD.dateOnly.format,maxDate:moment()},i.getVisitHistoryData()},i.vhSearchCheckDate=function(e){(i.visitsearch.fromDate&&!moment(i.visitsearch.fromDate).isValid()||!i.visitsearch.fromDate)&&(i.visitsearch.fromDate=""),(i.visitsearch.toDate&&!moment(i.visitsearch.toDate).isValid()||!i.visitsearch.toDate)&&(i.visitsearch.toDate=""),i.visitsearch.fromDate&&i.visitsearch.toDate&&moment(i.visitsearch.fromDate).isAfter(moment(i.visitsearch.toDate))&&(1==e&&(i.visitsearch.fromDate=""),2==e&&(i.visitsearch.toDate=""))},i.visitHistory=function(e){i.visitsearch={},i.visitsearch.fromDateOptions={format:i.CD.dateOnly.format,maxDate:moment()},i.visitsearch.toDateOptions={format:i.CD.dateOnly.format,maxDate:moment()},i.modalInstance=S.open("VISIT HISTORY",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups1 his-op-visit-management min-height-modal",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-visitHistoryDetails-modal-popup.html",size:"lg",scope:i}),i.getVisitHistoryData()},i.mlcPopup=function(){i.mlcPopupInstance=S.open("MLC Details",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups1 his-op-visit-management min-height-modal",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-mlcdetails-modal-popup.html",size:"lg",scope:i})},i.saveMlcPopupDetails=function(e,t){if(i.mlcSubmit=!0,e.$valid){i.mlcSubmit=!1;try{i.Mlc.docName=angular.element(document.querySelector("#opvm-mlc-upload-file"))[0].value}catch(e){i.Mlc.docName=""}i.mlcPopupInstance.close()}},i.disableVisitInfo=!1,i.loadVisitFromHistory=function(e){E.dismissAll(),i.searchVisit(e.VISIT_NO),2==e.EN_STATUS||5==e.EN_STATUS?i.disableVisitInfo=!0:i.disableVisitInfo=!1},i.patientPayerData=[],i.patientPayerDataList={1:i.patientPayerData};Re=I.executeQueryURLReset();i.patientPayer=new Array,I.prepareParamListWithParam("pMasterSqId","901",i.patientPayer),I.prepareParamListWithParam("pMasterDesc","",i.patientPayer),I.prepareParamListWithParam("pDetailCode","-999",i.patientPayer),I.prepareParamListWithParam("pDetailDesc","",i.patientPayer),I.executeQueryInput("TRN003",i.patientPayer,i.patientPayerDataList,!0,!0,Re,"popUp"),i.validateMobile=function(e){e.length<10?i.mobileMinLen=!0:i.mobileMinLen=!1},i.fileShow=function(){"png"==i.dotFormat2||"JPG"==i.dotFormat2||"jpeg"==i.dotFormat2||"jpg"==i.dotFormat2?i.modalInstance=S.open("View File",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-mlcFileShow.html",size:"lg",scope:i}):F.open(i.Mlc.docFileLink,"windowName")},i.generatePdfReport=function(){var e={mrNo:null!=s.mrNo?s.mrNo:s.patientGlobalDtlsNew?s.patientGlobalDtlsNew[0].mrNo:"",reportId:"HSC_Patient_Ordering_List",servSeqId:i.checkListServSeqIdInner,visitNo:i.visitNumber,checkListsCountAvailable:i.checkListServSeqIdInner};j.printReportModal("printOrdersCtrlNew","lg","PDF",e)},i.generateOrdersPdfReport=function(){var e={mrNo:null!=s.mrNo?s.mrNo:s.patientGlobalDtlsNew?s.patientGlobalDtlsNew[0].mrNo:"",visitNo:i.visitNumber,reportId:"HSC_Patient_Ordering_List"};j.printReportModal("printOrdersCtrlNew","lg","PDF",e)},i.generatePackageCheckListReport=function(e,t){if(1!=i.checkOrderSaved){try{var r={mrNo:s.mrNo,servSeqId:t[0].servSeqId,checkListsCountAvailable:i.checkListServSeqIdInner,reportId:"HSC_PCKG_CKL_REPORT"}}catch(e){}j.printReportModal("printCheckListsGridCtrlNew","lg","PDF",r)}},i.packageCheckListReprint=function(){if("0"!=i.checkListServSeqIdInner&&null!=i.checkListServSeqIdInner&&""!=i.checkListServSeqIdInner){var e=i.checkListServSeqIdInner;i.checkListServSeqIdInner="0";var t={buttonCallBack1:function(){E.dismissAll(),i.packageServicesArrayObejct=new Array,i.activeFirst=3},buttonCallBack2:function(){var t={mrNo:s.mrNo,reportId:"HSC_PCKG_CKL_SAVE_ORDER_REPORT",servSeqId:e,checkListsCountAvailable:e};j.printReportModal("printCheckListsCtrlNew","lg","PDF",t),i.packageServicesArrayObejct=new Array}};v.hisAlertMulti("information","Information","Do you want to print Checklists?",{buttonText:"No",buttonText2:"Yes"},t,close)}else i.packageServicesArrayObejct=new Array,i.activeFirst=3,T(function(){E.dismissAll(),i.loadBillNumbers(s.mrNo),i.retriveRecords(),i.getPrescptionCount()},3e3)},i.checkRowsArr=function(){if(0!=i.RowsArr.length)return!0},s.myCustomEvent=function(){i.packageServicesArrayObejct=new Array,i.activeFirst=3,T(function(){E.dismissAll(),i.loadBillNumbers(s.mrNo),i.retriveRecords(),i.getPrescptionCount()},3e3)},i.showDoctorsahareDetails=function(){if(i.DAUpdateBtn=!0,i.DCShareOptions=angular.copy(K),i.modalInstance=S.open("TRANSACTION UPDATE",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-DA-Transaction-popup.html",size:"lg",scope:i}),m.transTypeCombSearch("TRN003").then(function(e){i.transTypeObj=e}),void 0!==i.priorityvis.priorityTypeModel&&""!=i.priorityvis.priorityTypeModel&&null!=i.priorityvis.priorityTypeModel)var e=i.priorityvis.priorityTypeModel.DT_CODE;else e=i.orderDetails.visitTypeCode;var t=angular.copy(i.orderDetails);if(t.visitTypeCode=e,i.setCurrentTarrifId(),i.addRowStatus||!i.orderData.docShareData)m.getDACharges(i.orderData,s.tariffSeqId,t).then(function(e){if(i.DCShareOptions.data=[],e.errorCode){e={doctorAmount:0,doctorShare:0,hospitalShare:0,surcharge:0,transType:1}}var t={docAmount:parseFloat(e.doctorAmount).toFixed(2),modAmount:void 0!==e.doctorModifiedAmount?parseFloat(e.doctorModifiedAmount).toFixed(2):"0.00",docShare:parseFloat(e.doctorShare).toFixed(2),hospShare:parseFloat(e.hospitalShare).toFixed(2),techShare:"0.00",surcharge:parseFloat(e.surcharge).toFixed(2),orderObject:e.orderObj,tariffId:e.tarrifSeq,detailObj:e.detailObj,tranType:e.transType,serviceRate:e.orderObj.serviceRate,discount:null!=e.totalDiscountAmount?parseFloat(e.totalDiscountAmount).toFixed(2):"0.00",taxAmt:null!=e.taxAmt?parseFloat(e.taxAmt).toFixed(2):"0.00"};i.DCShareOptions.data.push(t)});else if(i.DCShareOptions.data=[],i.orderData.docShareData)i.DCShareOptions.data.push(i.orderData.docShareData);else{var r={tranType:void 0!==i.orderData.transType?i.orderData.transType:0,docAmount:void 0!==i.orderData.doctorAmount?parseFloat(i.orderData.doctorAmount).toFixed(2):"0.00",modAmount:void 0!==i.orderData.doctorModifiedAmount?parseFloat(i.orderData.doctorModifiedAmount).toFixed(2):"0.00",docShare:void 0!==i.orderData.doctorShare?parseFloat(i.orderData.doctorShare).toFixed(2):"0.00",hospShare:void 0!==i.orderData.hospitalShare?parseFloat(i.orderData.hospitalShare).toFixed(2):"0.00",techShare:"0.00",surcharge:void 0!==i.orderData.surcharge?parseFloat(i.orderData.surcharge).toFixed(2):"0.00",orderObject:i.orderData,tariffId:s.tariffSeqId,detailObj:t,serviceRate:i.orderData.serviceRate,discount:null!=i.orderData.discountAmt?parseFloat(i.orderData.discountAmt).toFixed(2):"0.00",taxAmt:null!=i.orderData.taxAmt?parseFloat(i.orderData.taxAmt).toFixed(2):"0.00"};i.DCShareOptions.data.push(r)}},i.changeRatesByTranType=function(e,t){if(2==e.orderObject.transType&&e.orderObject.servicePostingSeqId&&t)v.warning("Warning","Multiple time negotiable not acceptable.");else{var r=!t;m.getDAChargesByType(e,r).then(function(t){e.docAmount=null!=t.doctorAmount?parseFloat(t.doctorAmount).toFixed(2):"0.00",e.modAmount=void 0!==t.doctorModifiedAmount?parseFloat(t.doctorModifiedAmount).toFixed(2):"0.00",e.docShare=null!=t.doctorShare?parseFloat(t.doctorShare).toFixed(2):"0.00",e.hospShare=null!=t.hospitalShare?parseFloat(t.hospitalShare).toFixed(2):"0.00",e.techShare="0.00",e.surcharge=null!=t.surcharge?parseFloat(t.surcharge).toFixed(2):"0.00",e.serviceRate=null!=t.serviceRate?parseFloat(t.serviceRate).toFixed(2):"0.00",e.discount=null!=t.totalDiscountAmount?parseFloat(t.totalDiscountAmount).toFixed(2):"0.00",e.taxAmt=null!=t.taxAmt?parseFloat(t.taxAmt).toFixed(2):"0.00"})}},i.updateDoctorShares=function(){if(2==i.DCShareOptions.data[0].tranType&&2==i.DCShareOptions.data[0].orderObject.transType&&i.DCShareOptions.data[0].orderObject.servicePostingSeqId)v.warning("Warning","Multiple time negotiable not acceptable.");else{var e=i.DCShareOptions.data;if(null!=e[0].orderObject.maxValue&&1==e[0].orderObject.isRateEditable&&e[0].serviceRate>e[0].orderObject.maxValue)return v.information("information","Rate is not in defined range",!1,!1,me.time),i.DCShareOptions.data[0].modAmount=i.DCShareOptions.data[0].docAmount,i.DCShareOptions.data[0].docShare=i.DCShareOptions.data[0].docAmount,!1;if(null!=e[0].orderObject.minValue&&1==e[0].orderObject.isRateEditable&&e[0].serviceRate<e[0].orderObject.minValue)return v.information("information","Rate is not in defined range",!1,!1,me.time),i.DCShareOptions.data[0].modAmount=i.DCShareOptions.data[0].docAmount,i.DCShareOptions.data[0].docShare=i.DCShareOptions.data[0].docAmount,!1;i.orderData.doctorAmount=e[0].docAmount,i.orderData.doctorShare=e[0].docShare,i.orderData.hospitalShare=e[0].hospShare,i.orderData.hospitalSurcharge=e[0].surcharge,i.orderData.transType=e[0].tranType,i.orderData.doctorModifiedAmount=e[0].modAmount,i.orderData.proposedShare=e[0].docShare,i.orderData.billedShare=e[0].docShare,i.orderData.grpMstCode=e[0].grpMstCode?e[0].grpMstCode:void 0,i.orderData.taxAmt=e[0].taxAmt?e[0].taxAmt:0,i.orderData.docShareData=e[0],e[0].serviceRate&&(i.orderData.serviceRate=e[0].serviceRate,i.changeRatesBasedonPriceEdit(i.orderData.serviceRate,!0)),E.dismissAll()}},i.showDASharesview=function(e,t){i.DAUpdateBtn=!1,i.DCShareOptions=angular.copy(X),i.modalInstance=S.open("TRANSACTION UPDATE VIEW",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-DA-Transaction-popup.html",size:"lg",scope:i}),i.DCShareOptions.data=[];for(var r="",a=0;a<i.transTypeObj.length;a++)i.transTypeObj[a].CODE==t[0].transType&&(r=i.transTypeObj[a].DESCRIPTION);var o={tranType:r,docAmount:void 0!==t[0].doctorAmount?t[0].doctorAmount:0,modAmount:void 0!==t[0].doctorModifiedAmount?t[0].doctorModifiedAmount:0,docShare:void 0!==t[0].doctorShare?t[0].doctorShare:0,hospShare:void 0!==t[0].hospitalShare?t[0].hospitalShare:0,techShare:0,surcharge:void 0!==t[0].surcharge?t[0].surcharge:0,orderObject:"",tariffId:"",detailObj:""};i.DCShareOptions.data.push(o)},i.orderPendingIssues=function(){i.modalInstance=S.open("Pending Drug Orders",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-mgt-pending-issues-popup.html",size:"md",scope:i}),i.pendingOrderIssuesGrid=angular.copy(te),i.pendingOrdersData=[],i.pendingOrderIssuesData={1:i.pendingOrdersData};var e=I.executeQueryURLReset();i.pendingOrdersList=new Array,I.prepareParamListWithParam("pRgSeqId",i.PatientDetailsData.registraiion.rgSeqId,i.pendingOrdersList),I.prepareParamListWithParam("pVisitNo",i.visitNumber,i.pendingOrdersList),I.executeQueryInput("GET_DRUGS_PENDING_STATUS",i.pendingOrdersList,i.pendingOrderIssuesData,!0,!0,e,"popUp",i.gridgbOptions).then(function(e){for(var t=0;t<e[1].length;t++)"ISSUED"!=e[1][t].STATUS&&i.pendingOrderIssuesGrid.data.push(e[1][t])})},i.showCancelReason=function(e,t){i.modalInstance=S.open("Cancel Reason",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagementNew/templates/op-visit-orders-cancel.html",size:"sm",scope:i}),i.cancelOrderRemarks=t[0].servicePostingCacelReason},i.retrieveDetails=function(e){"op"==e?(i.modalInstance=S.open("Out patient History",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/EMR/doctorPatient/template/patient/opbill.ipbill.history.html",size:"lg",scope:i}),i.trustSrc=function(e){var t=JSON.parse(sessionStorage.appConfig).interfaceURL+"outPatients?mrNo="+(null!=s.mrNo?s.mrNo:s.patientGlobalDtlsNew?s.patientGlobalDtlsNew[0].mrNo:"");return ie.trustAsResourceUrl(t)}):"pch"==e?(i.modalInstance=S.open("Past Clinical History",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/EMR/doctorPatient/template/patient/opbill.ipbill.history.html",size:"lg",scope:i}),i.trustSrc=function(e){var t=JSON.parse(sessionStorage.appConfig).interfaceURL+"reports?mrNo="+(null!=s.mrNo?s.mrNo:s.patientGlobalDtlsNew?s.patientGlobalDtlsNew[0].mrNo:"");return ie.trustAsResourceUrl(t)}):(i.modalInstance=S.open("In patient History",{animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",windowClass:"search-service-modals-popups",templateUrl:"app/consumer/his17_1/EMR/doctorPatient/template/patient/opbill.ipbill.history.html",size:"lg",scope:i}),i.trustSrc=function(e){var t=JSON.parse(sessionStorage.appConfig).interfaceURL+"inPatients?mrNo="+(null!=s.mrNo?s.mrNo:s.patientGlobalDtlsNew?s.patientGlobalDtlsNew[0].mrNo:"");return ie.trustAsResourceUrl(t)})},i.cardMonths=[{month:"01",month_id:"01"},{month:"02",month_id:"02"},{month:"03",month_id:"03"},{month:"04",month_id:"04"},{month:"05",month_id:"05"},{month:"06",month_id:"06"},{month:"07",month_id:"07"},{month:"08",month_id:"08"},{month:"09",month_id:"09"},{month:"10",month_id:"10"},{month:"11",month_id:"11"},{month:"12",month_id:"12"}];for(var Ce=(new Date).getFullYear(),be=[],Ee=0;Ee<41;Ee++)be.push({year:Ce+Ee,year_id:parseInt(String(Ce+Ee).slice(2,4))});i.expireYears=be,ee.getDynamicConfig("GET_HIS_CONFIG_VALUE","Site_Ref").then(function(e){"HSC"==e[1][0].VALUE&&(i.activeFirst=58,i.projSpecApplicable=!0)}),null!==A.entityObj&&void 0!==A.entityObj&&(i.searchVisit(A.entityObj),T(function(){i.activeFirst=2},300)),i.preAuth.preAuthHeaderObj={},i.preAuth.preAuthHeaderObj.PREAUTH_BIL_DATE=new Date,i.preAuth.isDedctibleAvl="3",i.preAuth.isCoPayAvl="3",i.preAuth.maxCap="3",i.deletePreAuthService=[],i.showAuthDtls=!0,i.showNewAuth=!1,i.preAuth.filesUploaded=[],i.preAuth.uploadedfileNames=[],i.preAuth.uploadingFile=!1,i.alertData={buttonText:"OK"},i.alertFunction={buttonCallBack1:function(){}},i.closeAlert={buttonClose:function(){}},i.$on("myFile",function(e,t){oe.fileUploadCheck(t,i.preAuth,i)}),i.preAuthfromDateOptions={format:i.CD.dateOnly.format,minDate:moment()},i.preAuthToDateOptions={format:i.CD.dateOnly.format,minDate:moment()},i.preAuth.preAuthFile=function(e){oe.removeUploadedFile(e,i.preAuth)},i.preAuth.isBillOrServiceFlag="2",se.serviceGridData(i.preAuth,"preAuth",!0),se.preAuthViewRecords(i.preAuth,"preAuth",!0),i.preAuth.changePriServ=function(e,t,r,a){ne.getDepartment(i.preAuth,e,t,r,a)},i.preAuth.changeDept=function(e,t,r,a){ne.getSpeciltyData(i.preAuth,e,t,r,a)},i.preAuth.serviceSearch=function(e,t){return ne.getServiceList(t,e)},i.preAuth.changeSpecialty=function(e,t){t.inActiveVal&&(t.service=void 0)},i.preAuth.addRowGrid=function(e){let t={};if(t.priServGroup=e.entity.priServGroup,t.department=e.entity.department,t.specialty=e.entity.specialty,t.service=e.entity.service,t.valueAmt=e.entity.valueAmt,t.isAmtNlPercFlag=e.entity.isAmtNlPercFlag,t.qty=e.entity.qty,t.approvedDetails=e.entity.approvedDetails,t.remarks=e.entity.remarks,t.approvedAmount=e.entity.approvedAmount,t.approvedQty=e.entity.approvedQty,null!=t.priServGroup||null!=t.department||null!=t.specialty||null!=t.service&&""!=t.service){let r=!0;if(3!=t.isAmtNlPercFlag?r=null!=t.valueAmt&&""!==t.valueAmt||null!=t.qty&&""!==t.qty:3==t.isAmtNlPercFlag&&(r=!0),r&&3!=t.isAmtNlPercFlag&&(null!=t.valueAmt&&""!=t.valueAmt&&parseFloat(t.valueAmt)>0||null==t.valueAmt||""===t.valueAmt)&&(null!=t.qty&&""!=t.qty&&parseFloat(t.qty)>0||null==t.qty||""===t.qty)||3==t.isAmtNlPercFlag)if(r&&!e.entity.editable){if(ne.validDuplicate(i.preAuth,t)){i.preAuth.preAuthDetailsGridOtions.data.push(t),i.preAuth.preAuthDetailsGridOtions.data[0]=[],i.preAuth.clearRecordFirst(e),i.preAuth.preAuthValue=ne.calPreAuthAmt(i.preAuth.preAuthDetailsGridOtions.data),i.preAuth.preAuthForServ=angular.copy(i.preAuth.preAuthValue),i.preAuth.preAuthHeaderObj.GROSS_AMT=angular.copy(i.preAuth.preAuthValue);let r=0;r=i.calTempAmt(i.preAuth.preAuthDetailsGridOtions,r),i.preAuth.initialAuthAmount=r,i.preAuth.preAuthCopyServAmt=angular.copy(r)}else v.hisAlertMulti("information","Information","Already Same Record Exist(s), Kindly Update The Value.",i.alertData,i.alertFunction,i.closeAlert)}else if(e.entity.editable){i.preAuth.preAuthDetailsGridOtions.data[e.entity.recordIndex]=t,i.preAuth.preAuthDetailsGridOtions.data[e.entity.recordIndex].deleteDisble=!1,i.toggleText="",i.preAuth.preAuthDetailsGridOtions.data[0]=[],i.preAuth.clearRecordFirst(e),i.preAuth.preAuthValue=ne.calPreAuthAmt(i.preAuth.preAuthDetailsGridOtions.data),i.preAuth.preAuthForServ=angular.copy(i.preAuth.preAuthValue),i.preAuth.preAuthHeaderObj.GROSS_AMT=angular.copy(i.preAuth.preAuthValue);let r=0;r=i.calTempAmt(i.preAuth.preAuthDetailsGridOtions,r),i.preAuth.initialAuthAmount=r,i.preAuth.preAuthCopyServAmt=angular.copy(r)}else v.hisAlertMulti("information","Information","Please Enter Amount or Qty.",i.alertData,i.alertFunction,i.closeAlert);else v.hisAlertMulti("information","Information","Amount or Qty Can't be zero value",i.alertData,i.alertFunction,i.closeAlert)}else v.hisAlertMulti("information","Information","PPlease Select Any Group or Service With Amount or Qty.",i.alertData,i.alertFunction,i.closeAlert)},i.preAuth.editGridData=function(e,t){null!=i.preAuth.prevoisIndex&&i.preAuth.prevoisIndex!=t&&null!=i.preAuth.preAuthDetailsGridOtions.data[i.preAuth.prevoisIndex]&&(i.preAuth.preAuthDetailsGridOtions.data[i.preAuth.prevoisIndex].deleteDisble=!1),e.entity.deleteDisble=!0,i.preAuth.prevoisIndex=t;let r={};r.priServGroup=null!=e.entity.priServGroup&&null!=e.entity.priServGroup.CODE?I.getObjectByAnyValue(i.preAuth.priServGroupList,e.entity.priServGroup.CODE,"CODE"):void 0,r.department=e.entity.department,r.specialty=e.entity.specialty,r.service=e.entity.service,r.valueAmt=e.entity.valueAmt,r.isAmtNlPercFlag=e.entity.isAmtNlPercFlag,r.qty=e.entity.qty,r.approvedDetails=e.entity.approvedDetails,r.remarks=e.entity.remarks,r.approvedAmount=e.entity.approvedAmount,r.approvedQty=e.entity.approvedQty,i.preAuth.preAuthDetailsGridOtions.data[0]=r,i.preAuth.preAuthDetailsGridOtions.data[0].editable=!0,i.preAuth.preAuthDetailsGridOtions.data[0].recordIndex=t,i.toggleText="UPDATE",i.preAuth.changePriServ(e.entity.priServGroup,i.preAuth.preAuthDetailsGridOtions.data[0],e.entity,!0)},i.preAuth.clearRecordFirst=function(e){null!=e&&e.entity.editable&&(i.preAuth.preAuthDetailsGridOtions.data[e.entity.recordIndex].deleteDisble=!1,e.entity.editable=!1,i.toggleText=""),i.preAuth.preAuthDetailsGridOtions.data[0]=[],i.preAuth.preAuthDetailsGridOtions.data[0].isAmtNlPercFlag="1",i.preAuth.preAuthDetailsGridOtions.data[0].valueAmt="",i.preAuth.preAuthDetailsGridOtions.data[0].qty="",i.preAuth.preAuthDetailsGridOtions.data[0].deleteDisble=!1,i.preAuth.speciltyList=[],i.preAuth.deptList=[]},i.preAuth.deleteRecord=function(e,t){let r={buttonCallBack1:function(){},buttonCallBack2:function(){null!=i.preAuth.preAuthDetailsGridOtions.data[t].approxBillDtSeqId&&(i.preAuth.preAuthDetailsGridOtions.data[t].GN_STATUS=2,i.deletePreAuthService.push(i.preAuth.preAuthDetailsGridOtions.data[t])),i.preAuth.preAuthDetailsGridOtions.data.splice(t,1),i.preAuth.preAuthValue=ne.calPreAuthAmt(i.preAuth.preAuthDetailsGridOtions.data),i.preAuth.preAuthForServ=angular.copy(i.preAuth.preAuthValue),i.preAuth.preAuthHeaderObj.GROSS_AMT=angular.copy(i.preAuth.preAuthValue);let e=0;e=i.calTempAmt(i.preAuth.preAuthDetailsGridOtions,e),i.preAuth.initialAuthAmount=e,i.preAuth.preAuthCopyServAmt=angular.copy(e)}};v.hisAlertMulti("information","Information","Do You Want To Delete The Record?",{buttonText:"No",buttonText2:"Yes"},r,{buttonClose:function(){}})},i.preAuth.getPreAuth=function(e){if(2==e){i.preAuth.preAuthValue=ne.calPreAuthAmt(i.preAuth.preAuthDetailsGridOtions.data),i.preAuth.preAuthForServ=angular.copy(i.preAuth.preAuthValue),i.preAuth.preAuthHeaderObj.GROSS_AMT=i.preAuth.preAuthForServ;let e=0;e=i.calTempAmt(i.preAuth.preAuthDetailsGridOtions,e),i.preAuth.initialAuthAmount=e,i.preAuth.preAuthCopyServAmt=angular.copy(e)}else i.preAuth.preAuthForServ=void 0,i.preAuth.preAuthValue=0,i.preAuth.preAuthHeaderObj.GROSS_AMT=i.preAuth.grossAmt,i.preAuth.initialAuthAmount=0},i.preAuth.onSelected=function(e,t){ne.getDropDownBasedService(e,t,i.preAuth)},i.preAuth.downloadFile=function(e){oe.downloadDocument(e)},i.preAuth.isChangedVal=function(e){null!=e&&""!=e&&"."!=e?null!=i.preAuth.preAuthForServ&&parseFloat(e)<parseFloat(i.preAuth.preAuthForServ)&&(i.preAuth.preAuthValue=angular.copy(i.preAuth.preAuthForServ)):i.preAuth.preAuthValue=0},i.preAuth.amountOrPercBlur=function(e){2==e.isAmtNlPercFlag&&null!=e.valueAmt&&null!=e.valueAmt&&""!=e.valueAmt&&parseFloat(e.valueAmt)>parseFloat(100)&&(e.valueAmt=100),"AP"==e.approvedDetails?e.approvedAmount=e.valueAmt:"PA"==e.approvedDetails?(null!=e.valueAmt&&null!=e.valueAmt&&""!=e.valueAmt&&null!=e.approvedAmount&&""!=e.approvedAmount&&(parseFloat(e.approvedAmount),parseFloat(e.valueAmt)),e.approvedAmount=e.valueAmt):"NA"==e.approvedDetails&&null!=e.valueAmt&&null!=e.valueAmt&&""!=e.valueAmt&&(e.approvedAmount=0)},i.valueCheck=function(e){var t;null!=e.entity.approvedDetails&&null!=e.entity.approvedDetails&&(null!=e.entity.valueAmt&&""!=e.entity.valueAmt&&(t=e.entity.valueAmt),"PA"==e.entity.approvedDetails&&(i.disableAmount=!1,e.entity.approvedAmount>t?e.entity.approvedAmount=t-1:e.entity.approvedAmount<=0?e.entity.approvedAmount=null:e.entity.approvedAmount=e.entity.approvedAmount))},i.preAuth.initialAuthAmount=0,i.preAuth.validAppAmt=function(e){2==i.preAuth.isBillOrServiceFlag&&(null!=e&&""!=e&&(parseFloat(e)<parseFloat(i.preAuth.preAuthCopyServAmt)||0==parseFloat(e))?i.preAuth.initialAuthAmount=i.preAuth.preAuthCopyServAmt:null!=e&&""!=e||(i.preAuth.initialAuthAmount=i.preAuth.preAuthCopyServAmt))},i.calTempAmt=function(e,t,r){t=0;for(var a=1;a<e.data.length;a++)null!=e.data[a].approvedAmount&&""!=e.data[a].approvedAmount&&1==e.data[a].isAmtNlPercFlag&&(t+=parseFloat(e.data[a].approvedAmount));return t},i.amountChange=function(e,t,r,a,o){let s=0,n=0;if(null!=e.entity.approvedDetails&&null!=e.entity.approvedDetails){null!=e.entity.valueAmt&&""!=e.entity.valueAmt&&(s=e.entity.valueAmt),null!=e.entity.qty&&""!=e.entity.qty&&(n=e.entity.qty),"AP"==e.entity.approvedDetails?(i.preAuth.pASave=!1,null!=e.entity.valueAmt&&""!=e.entity.valueAmt&&(e.entity.approvedAmount=parseFloat(s)),null!=e.entity.qty&&""!=e.entity.qty&&(e.entity.approvedQty=parseFloat(n)),3==e.entity.isAmtNlPercFlag&&(e.entity.approvedAmount=void 0,e.entity.approvedQty=void 0)):"PA"==e.entity.approvedDetails?(i.preAuth.pASave=!0,i.disableAmount=!1,null!=e.entity.valueAmt&&""!=e.entity.valueAmt&&(e.entity.approvedAmount=0),null!=e.entity.qty&&""!=e.entity.qty&&(e.entity.approvedQty=0)):"NA"==e.entity.approvedDetails&&(i.preAuth.pASave=!1,null!=e.entity.valueAmt&&""!=e.entity.valueAmt&&(e.entity.approvedAmount=0),null!=e.entity.qty&&""!=e.entity.qty&&(e.entity.approvedQty=0),3==e.entity.isAmtNlPercFlag&&(e.entity.approvedAmount=void 0,e.entity.approvedQty=0));let t=0;t=i.calTempAmt(i.preAuth.preAuthDetailsGridOtions,t),i.preAuth.initialAuthAmount=t,i.preAuth.preAuthCopyServAmt=angular.copy(t),i.prevAmt=e.entity.approvedAmount}},i.preAuth.preAuthValue=0,i.getPreAuthValue=function(e){var t=0;i.preAuth.pASave=!1,("PA"!=e.entity.approvedDetails||null==e.entity.valueAmt||""==e.entity.valueAmt||null==e.entity.qty||""==e.entity.qty||null!=e.entity.approvedAmount&&null!=e.entity.approvedAmount&&""!==e.entity.approvedAmount&&0!=parseFloat(e.entity.approvedAmount)&&null!=e.entity.approvedQty&&null!=e.entity.approvedQty&&""!==e.entity.approvedQty&&0!=parseFloat(e.entity.approvedQty))&&("PA"!=e.entity.approvedDetails||null==e.entity.valueAmt||""==e.entity.valueAmt||null!=e.entity.qty&&""!=e.entity.qty||null!=e.entity.approvedAmount&&null!=e.entity.approvedAmount&&""!==e.entity.approvedAmount&&0!=parseFloat(e.entity.approvedAmount))&&("PA"!=e.entity.approvedDetails||null!=e.entity.valueAmt&&""!=e.entity.valueAmt||null==e.entity.qty||""==e.entity.qty||null!=e.entity.approvedQty&&null!=e.entity.approvedQty&&""!=e.entity.approvedQty&&0!=parseFloat(e.entity.approvedQty))&&("PA"!=e.entity.approvedDetails||3!=e.entity.isAmtNlPercFlag||null!=e.entity.approvedQty&&null!=e.entity.approvedQty&&""!=e.entity.approvedQty&&0!=parseFloat(e.entity.approvedQty))?("PA"==e.entity.approvedDetails&&null!=e.entity.valueAmt&&""!=e.entity.valueAmt&&parseFloat(e.entity.approvedAmount)>parseFloat(e.entity.valueAmt)-parseFloat(.1)&&(e.entity.approvedAmount=parseFloat(e.entity.valueAmt)-parseFloat(.1)),"PA"==e.entity.approvedDetails&&null!=e.entity.qty&&""!=e.entity.qty&&parseFloat(e.entity.approvedQty)>parseFloat(e.entity.qty)-1&&(null!=e.entity.valueAmt&&1==e.entity.qty?e.entity.approvedQty=1:e.entity.approvedQty=parseFloat(e.entity.qty)-1),i.preAuth.pASave=!1,t=i.calTempAmt(i.preAuth.preAuthDetailsGridOtions,t,!0),i.preAuth.initialAuthAmount=t,i.preAuth.preAuthCopyServAmt=angular.copy(t)):i.preAuth.pASave=!0},i.preAuth.validCoPay=function(e){null!=e&&""!=e&&parseFloat(e)>parseFloat(100)&&(i.preAuth.coPayVal=100)},i.clearPreAuth=function(){le.opPreAuthClear(i)},i.clearPreAuthColse=function(){le.opPreAuthClear(i),i.preAuth.viewPreAuth=!1,i.showNewAuth=!1,i.showAuthDtls=!0,i.deletePreAuthRcrd=!1},i.preAuthRecord=function(e){i.clearPreAuthColse();var t=[];for(let r=0;r<e.length;r++)1==e[r][0].checkPreAuthRequest&&t.push(e[r]);if(t.length>1)for(let e=0;e<t.length;e++){if(null!=t[e+1]&&t[e][0].payerType!=t[e+1][0].payerType)return v.hisAlertMulti("information","Information","Please Select Same Payer And Plan.",i.alertData,i.alertFunction,i.closeAlert),!1;if("Self"==t[e][0].payerType)return v.hisAlertMulti("information","Information","For Self Authorization not allowed",i.alertData,i.alertFunction,i.closeAlert),!1}for(let e=0;e<t.length;e++)if("Self"==t[e][0].payerType)return v.hisAlertMulti("information","Information","For Self Authorization not allowed",i.alertData,i.alertFunction,i.closeAlert),!1;i.activeFirst=5,i.reqFromOrder=!0,i.showNewAuth=!0,i.showAuthDtls=!1;var r=t[0][0].payerName.split("/");i.OrderPayerName=r[0],i.OrderPlanName=r[1],i.payerCompPlanseqId=t[0][0].payerCompPlanseqId,i.payerCompSeqId=t[0][0].payerCompSeqId,s.orderRowData=t[0],i.getAllPayerDetail(s.patientSeqId),i.getPatAllPayers(s.patientSeqId),i.preAuth.preAuthDetailsGridOtions.data=[],i.preAuth.preAuthDetailsGridOtions.data[0]=[],i.preAuth.preAuthDetailsGridOtions.data[0].isAmtNlPercFlag="1",i.preAuth.preAuthDetailsGridOtions.data[0].valueAmt="",i.preAuth.preAuthDetailsGridOtions.data[0].qty="",i.preAuth.preAuthHeaderObj.PREAUTH_BIL_DATE=new Date;let a=[];for(let e=0;e<t.length;e++)a.push(t[e][0].servSeqId);a=_.toString(a),i.orderService=[];let o={1:i.orderService},n=I.executeQueryURLReset(),c=new Array;I.prepareParamListWithParam("pServSeqId",a,c),I.executeQueryInput("GET_ORDERS_SERVICE_FOR_PRE_AUTH_OP",c,o,!0,!0,n,"popUp",{}).then(function(e){for(let e=0;e<t.length;e++)for(let r=0;r<i.orderService.length;r++)if(t[e][0].servSeqId==i.orderService[r].SERV_SEQ_ID){i.preAuth.preAuthDetailsGridOtions.data.push({isAmtNlPercFlag:"1",valueAmt:null!=t[e][0].newRate&&""!=t[e][0].newRate?parseFloat(t[e][0].newRate):t[e][0].serviceRate,qty:1,priServGroup:{DESCRIPTION:i.orderService[r].PRI_SERV_DESC,CODE:i.orderService[r].PRI_SERV_CODE},department:{DESCRIPTION:i.orderService[r].DEPT_DESC,CODE:i.orderService[r].DEPT_CODE},specialty:{DESCRIPTION:i.orderService[r].SPL_DESC,CODE:i.orderService[r].SPL_CODE},service:{SERV_NAME:i.orderService[r].SERV_NAME,SERV_SEQ_ID:i.orderService[r].SERV_SEQ_ID},approvedDetails:i.orderService[r].APPROVD_DTLS,approvedAmount:i.orderService[r].APPROVED_AMNT,approvedQty:i.orderService[r].APPROVED_QTY,remarks:i.orderService[r].APPROVE_REMARKS});break}}),i.preAuth.preAuthValue=ne.calPreAuthAmt(i.preAuth.preAuthDetailsGridOtions.data),i.preAuth.preAuthForServ=angular.copy(i.preAuth.preAuthValue)},i.getEditActive=function(e,t){i.deletePreAuthRcrd=!1,i.preAuthBillNav=!0,null!=i.prevoisEditIndex&&i.prevoisEditIndex!=t&&1==i.addPayerAuthrList[i.prevoisEditIndex].$edit&&(i.addPayerAuthrList[i.prevoisEditIndex].$edit=!1),i.prevoisEditIndex=t},i.getPreAuthData=function(e,t){i.preAuth.patientDetails={approxBillHdSeqId:e.approxBillHdSeqId},t?(i.showNewAuth=!1,i.showAuthDtls=!0,i.updateFlag=!1):(i.deletePreAuthRcrd=!1,i.showNewAuth=!0,i.showAuthDtls=!1,i.updateFlag=!0),pe.getPreAuthDataHeader(i.preAuth.patientDetails,i.preAuth).then(function(r){if(i.preAuth.preAuthHeaderList.length>0){i.preAuth.isBillOrServiceFlag=_.toString(i.preAuth.preAuthHeaderList[0].IS_BILL_OR_SERVE_LEVEL),i.preAuth.isCoPayAvl=null!=i.preAuth.preAuthHeaderList[0].IS_COPAY_AVAILABLE?_.toString(i.preAuth.preAuthHeaderList[0].IS_COPAY_AVAILABLE):"3",i.preAuth.maxCap=i.preAuth.preAuthHeaderList[0].IS_MAX_COPAY_AVAILABLE?_.toString(i.preAuth.preAuthHeaderList[0].IS_MAX_COPAY_AVAILABLE):"3",i.preAuth.coPayVal=i.preAuth.preAuthHeaderList[0].COPAY_VALUE,i.preAuth.maxCapVal=i.preAuth.preAuthHeaderList[0].MAX_COPAY_VALUE,i.preAuth.isDedctibleAvl=null!=i.preAuth.preAuthHeaderList[0].IS_DEDUCTABLE_AVAILABLE?_.toString(i.preAuth.preAuthHeaderList[0].IS_DEDUCTABLE_AVAILABLE):"3",i.preAuth.deductbleValue=i.preAuth.preAuthHeaderList[0].DEDUCTABLE_VALUE,i.preAuth.initialAuthAmount=i.preAuth.preAuthHeaderList[0].APPROVED_AMNT,i.preAuth.grossAmt=i.preAuth.preAuthHeaderList[0].GROSS_AMT,i.preAuth.preAuthHeaderObj=i.preAuth.preAuthHeaderList[0],i.preAuth.fromDate=null!=e.effectiveFromDummy?new Date(e.effectiveFromDummy):void 0,i.preAuth.toDate=null!=e.effectiveToDummy?new Date(e.effectiveToDummy):void 0,i.preAuth.gnStatus=e.gnStatus,i.reqFromOrder=!0;var a=e.plan.split("/");i.OrderPayerName=a[0],i.OrderPlanName=a[1],i.planSeqIdForUpdate=e.payerType,i.getPatAllPayers(s.patientSeqId)}t?i.preAuthSave():(oe.getDocument(i.preAuth).then(function(e){for(var t=0;t<e.length;t++)i.preAuth.filesUploaded.push({"@class":"com.napier.core.service.vo.uploadfile.NapierDocument",docName:e[t].DOC_NAME,docSeqId:e[t].DOC_SEQ_ID,status:2,machineIp:angular.fromJson(sessionStorage.userContextObj).WORKSTATION,fileSize:e[t].FILE_SIZE,trimFileName:oe.trimFile(e[t].DOC_NAME),fSize:e[t].FILE_SIZE}),i.preAuth.uploadedfileNames.push(e[t].DOC_NAME)}),pe.getPreAuthData(i.preAuth.patientDetails,i.preAuth).then(function(e){if(i.preAuth.preAuthViewDetailsGridOtions.data=[],i.preAuth.preAuthDetailsGridOtions.data=[],i.preAuth.preAuthServiceList.length>0){for(let e=0;e<i.preAuth.preAuthServiceList.length;e++){i.preAuth.viewPreAuth||(i.preAuth.preAuthDetailsGridOtions.data[0]=[],i.preAuth.preAuthDetailsGridOtions.data[0].isAmtNlPercFlag="1",i.preAuth.preAuthDetailsGridOtions.data[0].valueAmt="",i.preAuth.preAuthDetailsGridOtions.data[0].qty="");let t={isAmtNlPercFlag:i.preAuth.preAuthServiceList[e].IS_AMT_PERC_NL_CODE+"",approxBillDtSeqId:i.preAuth.preAuthServiceList[e].PREAUTH_BILL_DT_SEQ_ID,valueAmt:i.preAuth.preAuthServiceList[e].CHARGEABLE_AMT,qty:i.preAuth.preAuthServiceList[e].SERV_QTY,priServGroup:{DESCRIPTION:i.preAuth.preAuthServiceList[e].PRI_SERV_DESC,CODE:i.preAuth.preAuthServiceList[e].PRI_SERV_CODE},department:{DESCRIPTION:i.preAuth.preAuthServiceList[e].DEPT_DESC,CODE:i.preAuth.preAuthServiceList[e].DEPT_CODE},specialty:{DESCRIPTION:i.preAuth.preAuthServiceList[e].SPL_DESC,CODE:i.preAuth.preAuthServiceList[e].SPL_CODE},service:{SERV_NAME:i.preAuth.preAuthServiceList[e].SERV_NAME,SERV_SEQ_ID:i.preAuth.preAuthServiceList[e].SERV_SEQ_ID},approvedDetails:i.preAuth.preAuthServiceList[e].APPROVD_DTLS,approvedAmount:i.preAuth.preAuthServiceList[e].APPROVED_AMNT,approvedQty:i.preAuth.preAuthServiceList[e].APPROVED_QTY,remarks:i.preAuth.preAuthServiceList[e].APPROVE_REMARKS,CONSUMABLE_AMOUNT:i.preAuth.preAuthServiceList[e].CONSUMABLE_AMOUNT,CONSUMABLE_QTY:i.preAuth.preAuthServiceList[e].CONSUMABLE_QTY,GN_STATUS:i.preAuth.preAuthServiceList[e].GN_STATUS,viewPreAuthFlag:i.preAuth.viewPreAuth};i.preAuth.preAuthDetailsGridOtions.data.push(t),i.preAuth.viewPreAuth&&i.preAuth.preAuthViewDetailsGridOtions.data.push(t)}i.preAuth.preAuthValue=ne.calPreAuthAmt(i.preAuth.preAuthDetailsGridOtions.data),i.preAuth.preAuthForServ=angular.copy(i.preAuth.preAuthValue)}}))})},i.preAuthBillOrServiceCal=function(e,t){let r=e?t:null!=t?t:i.orderData;if(2==i.preAuthHdrRcdList.IS_BILL_OR_SERVE_LEVEL){for(let a=0;a<i.preAuthRcdList.length;a++)if("N"==i.preAuthRcdList[a].IS_PRE_AUTH_HEADER)if("Pre Auth"==i.preAuthRcdList[a].TYPE&&(e||(null!=t?(t.patamount=r.serviceRate,t.payeramount=0):(i.orderDetails.patamount=r.serviceRate,i.orderDetails.payeramount=0))),4==i.preAuthRcdList[a].SERVICE_TYPE){if(r.priServTypCode==i.preAuthRcdList[a].SERV_SEQ_ID){null!=t&&null!=t.servicePostingSeqId&&le.opPreAuthCalBeforeOrder(i.preAuthRcdList[a],i,!0,null!=t?t:i.orderData),le.opPreAuthCalBeforeOrder(i.preAuthRcdList[a],i,e,null!=t?t:i.orderData);break}}else if(3==i.preAuthRcdList[a].SERVICE_TYPE){if(r.deptCode==i.preAuthRcdList[a].SERV_SEQ_ID){null!=t&&null!=t.servicePostingSeqId&&le.opPreAuthCalBeforeOrder(i.preAuthRcdList[a],i,!0,null!=t?t:i.orderData),le.opPreAuthCalBeforeOrder(i.preAuthRcdList[a],i,e,null!=t?t:i.orderData);break}}else if(2==i.preAuthRcdList[a].SERVICE_TYPE){if(r.specilityCode==i.preAuthRcdList[a].SERV_SEQ_ID){null!=t&&null!=t.servicePostingSeqId&&le.opPreAuthCalBeforeOrder(i.preAuthRcdList[a],i,!0,null!=t?t:i.orderData),le.opPreAuthCalBeforeOrder(i.preAuthRcdList[a],i,e,null!=t?t:i.orderData);break}}else if(1==i.preAuthRcdList[a].SERVICE_TYPE&&r.servSeqId==i.preAuthRcdList[a].SERV_SEQ_ID){null!=t&&null!=t.servicePostingSeqId&&le.opPreAuthCalBeforeOrder(i.preAuthRcdList[a],i,!0,null!=t?t:i.orderData),le.opPreAuthCalBeforeOrder(i.preAuthRcdList[a],i,e,null!=t?t:i.orderData);break}null!=t?(t.originalPatientAmount=t.patamount,t.originalPayerAmount=t.payeramount):(null!=i.orderData.patamount&&null!=i.orderData.payeramount&&(i.orderDetails.patamount=i.orderData.patamount,i.orderDetails.payeramount=i.orderData.payeramount),i.orderData.originalPatientAmount=i.orderDetails.patamount,i.orderData.originalPayerAmount=i.orderDetails.payeramount,i.orderDetails.patamount=i.orderData.originalPatientAmount,i.orderDetails.payeramount=i.orderData.originalPayerAmount)}else{var a=null!=t?t.newRate:null!=i.orderDetails.price&&""!=i.orderDetails.price?i.orderDetails.price:i.orderData.newRate;"Pre Auth"==i.preAuthHdrRcdList.TYPE&&(null!=t?(t.originalPatientAmount=a,t.originalPayerAmount=0):(i.orderData.originalPatientAmount=a,i.orderData.originalPayerAmount=0)),null!=i.preAuthHdrRcdList.APPROVED_AMNT&&parseFloat(i.preAuthHdrRcdList.APPROVED_AMNT)>0?(null!=i.preAuthHdrRcdList.CONSUMABLE_AMOUNT&&""!==i.preAuthHdrRcdList.CONSUMABLE_AMOUNT||(i.preAuthHdrRcdList.CONSUMABLE_AMOUNT=0),parseFloat(i.preAuthHdrRcdList.APPROVED_AMNT)>=parseFloat(a)?(r.patamount=0,r.payeramount=parseFloat(a),i.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(i.preAuthHdrRcdList.APPROVED_AMNT)-parseFloat(a),i.preAuthHdrRcdList.CONSUMABLE_AMOUNT=parseFloat(i.preAuthHdrRcdList.CONSUMABLE_AMOUNT)+parseFloat(a)):(r.patamount=parseFloat(a)-parseFloat(i.preAuthHdrRcdList.APPROVED_AMNT),r.payeramount=parseFloat(i.preAuthHdrRcdList.APPROVED_AMNT),i.preAuthHdrRcdList.APPROVED_AMNT=0,i.preAuthHdrRcdList.CONSUMABLE_AMOUNT=parseFloat(i.preAuthHdrRcdList.CONSUMABLE_AMOUNT)+r.payeramount)):null!=i.preAuthHdrRcdList.APPROVED_AMNT&&(r.patamount=parseFloat(a),r.payeramount=0),null!=r.patamount&&null!=r.payeramount&&(null!=t?(t.originalPatientAmount=r.patamount,t.originalPayerAmount=r.payeramount):(i.orderData.originalPatientAmount=r.patamount,i.orderData.originalPayerAmount=r.payeramount,i.orderDetails.patamount=i.orderData.originalPatientAmount,i.orderDetails.payeramount=i.orderData.originalPayerAmount))}if(null!=r)if(i.orderData.isComingFromOPPharmacy&&"Pharmacy Retruns"==i.orderData.isPharmacyService){for(let e=0;e<i.RowsArr.length;e++)i.RowsArr[e][0].isComingFromOPPharmacy&&"Pharmacy Issues"==i.RowsArr[e][0].isPharmacyService&&null!=i.orderData.pharamcyIssueServSeqId&&i.orderData.pharamcyIssueServSeqId==i.RowsArr[e][0].refTranSeqID&&(i.issueData=i.RowsArr[e][0]);for(let e=0;e<i.preAuthRcdList.length;e++)if("N"==i.preAuthRcdList[e].IS_PRE_AUTH_HEADER)if(i.preAuthRcdList[e].TYPE="Pre Auth",4==i.preAuthRcdList[e].SERVICE_TYPE){if(i.issueData.priServTypCode==i.preAuthRcdList[e].SERV_SEQ_ID){le.opPharmacyCalP(i,i.orderData,i.preAuthRcdList[e]);break}}else if(3==i.preAuthRcdList[e].SERVICE_TYPE){if(i.issueData.deptCode==i.preAuthRcdList[e].SERV_SEQ_ID){le.opPharmacyCalP(i,i.orderData,i.preAuthRcdList[e]);break}}else if(2==i.preAuthRcdList[e].SERVICE_TYPE){if(i.issueData.specilityCode==i.preAuthRcdList[e].SERV_SEQ_ID){le.opPharmacyCalP(i,i.orderData,i.preAuthRcdList[e]);break}}else if(1==i.preAuthRcdList[e].SERVICE_TYPE&&i.issueData.servSeqId==i.preAuthRcdList[e].SERV_SEQ_ID){le.opPharmacyCalP(i,i.orderData,i.preAuthRcdList[e]);break}}else i.orderData.isComingFromOPPharmacy&&"Pharmacy Issues"==i.orderData.isPharmacyService&&le.opPreAuthGetData(i,i.RowsArr)},i.preAuthSave=function(){i.saveDataInput=[],i.saveDataInput.push({bedClassSeqId:void 0,StrExpectedDays:void 0,regSeqId:s.patientSeqId,approxHdSeqId:void 0,icdCode:void 0,patientcategorySeqId:null==s.patCatSeqId?0:s.patCatSeqId,tariffSeqId:null==s.tariffSeqId?0:s.tariffSeqId,remarks:i.preAuth.preAuthHeaderObj.REMARKS,gnTranStatus:4,approxBillDate:null==i.expectedDate||null==i.expectedDate?b("date")(new Date,"yyyy-MM-dd hh:mm:ss.s"):b("date")(i.expectedDate,"yyyy-MM-dd hh:mm:ss.s"),grossAmt:null!=i.preAuth.preAuthHeaderObj&&null!=i.preAuth.preAuthHeaderObj.GROSS_AMT&&null!=i.preAuth.preAuthHeaderObj.GROSS_AMT&&""!=i.preAuth.preAuthHeaderObj.GROSS_AMT?parseFloat(i.preAuth.preAuthHeaderObj.GROSS_AMT):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId"),isBillOrServeLevel:parseFloat(i.preAuth.isBillOrServiceFlag),isCopayAvailable:parseFloat(i.preAuth.isCoPayAvl),copayValue:null!=i.preAuth.coPayVal&&""!=i.preAuth.coPayVal?parseFloat(i.preAuth.coPayVal):void 0,isMaxCopayAvailable:parseFloat(i.preAuth.maxCap),maxCopayValue:null!=i.preAuth.maxCapVal&&""!=i.preAuth.maxCapVal?parseFloat(i.preAuth.maxCapVal):void 0,isDeductableAvailable:parseFloat(i.preAuth.isDedctibleAvl),deductableValue:null!=i.preAuth.deductbleValue&&""!=i.preAuth.deductbleValue?parseFloat(i.preAuth.deductbleValue):void 0,approvalRefNo:null!=i.preAuth.preAuthHeaderObj&&null!=i.preAuth.preAuthHeaderObj.APPREFNO?i.preAuth.preAuthHeaderObj.APPREFNO:void 0,approvedAmount:parseFloat(i.preAuth.initialAuthAmount),approxBillHdSeqId:null!=i.preAuth.preAuthHeaderObj?i.preAuth.preAuthHeaderObj.PREAUTH_BILL_HD_SEQ_ID:void 0,effectiveFrom:null!=i.preAuth.fromDate?b("date")(i.preAuth.fromDate,"yyyy-MM-dd hh:mm:ss.s"):void 0,effectiveTo:null!=i.preAuth.toDate?b("date")(i.preAuth.toDate,"yyyy-MM-dd hh:mm:ss.s"):void 0,payerType:null!=i.planSeqIdForUpdate?i.planSeqIdForUpdate:null!=i.preAuth.planObj&&null!=i.preAuth.planObj.PINS_SEQ_ID?i.preAuth.planObj.PINS_SEQ_ID:i.payerCompPlanseqId,gnStatus:i.deletePreAuthRcrd?parseInt(2):null!=i.preAuth.gnStatus?i.preAuth.gnStatus:parseInt(1)}),i.saveDetails=[],i.allApprvdNot=void 0,2!=i.preAuth.isBillOrServiceFlag||i.deletePreAuthRcrd?le.preObjForPerAuthService(i,!0):i.allApprvdNot=le.preObjForPerAuthService(i),i.allApprvdNot?v.information("information","Please Approve All Record(s)",!1,!1,me.time):ce.savePreAuthForReg(i.saveDataInput[0],i.saveDetails,[],[],[],[],[]).then(function(e){if(null!=e.data.HITService.message&&null!=e.data.HITService.message.approxBillVos&&null!=e.data.HITService.message.approxBillVos[0]&&null!=e.data.HITService.message.approxBillVos[0]["com.napier.core.billgeneration.vo.ApproxBillVo"]&&null!=e.data.HITService.message.approxBillVos[0]["com.napier.core.billgeneration.vo.ApproxBillVo"].approxBillNo){if(null!=e.data.HITService.message.approxBillVos[0]["com.napier.core.billgeneration.vo.ApproxBillVo"].approxBillHdSeqId&&!i.deletePreAuthRcrd){for(let t=0;t<i.preAuth.filesUploaded.length;t++)i.preAuth.filesUploaded[t].referenceId=e.data.HITService.message.approxBillVos[0]["com.napier.core.billgeneration.vo.ApproxBillVo"].approxBillHdSeqId,i.preAuth.filesUploaded[t].prmryEntityId=e.data.HITService.message.approxBillVos[0]["com.napier.core.billgeneration.vo.ApproxBillVo"].approxBillHdSeqId;oe.saveDocument(i.preAuth)}i.orderSave();let t=i.deletePreAuthRcrd?"Authorization Deleted Successfully":"Authorization Saved Successfully";v.success("Success",t,!1,!1,me.time),i.getPatAllPayers(s.patientSeqId),i.getAddedPreAuths(s.patientSeqId),le.opPreAuthClear(i),i.showNewAuth=!1,i.showAuthDtls=!0,i.reqFromOrder=!1,i.PA={},i.disablePlan=!0,i.showErrors=!1,i.showPlanError=!1,i.statusReq=!1,$("#removeReqStatusNo").removeClass("req-field"),$("#removeReqStatusAmnt").removeClass("req-field"),i.preAuthRcdList=[],i.preAuthHdrRcdList={},le.opPreAuthGetData(i,i.RowsArr),i.preAuthRequested?T(function(){i.activeFirst=3},2e3):i.activeFirst=2}})},i.showOpPharmacyView=function(e,t){var r={1:[]},a=I.executeQueryURLReset(),o=new Array;i.patObj={},i.patObj.RG_SEQ_ID=s.patientSeqId,i.patObj.RETANABLE_QTY="",i.patObj.TYPE=2,i.patObj.STATUS_CODE=4,i.patObj.CRITERIA=1,i.patObj.WHERE_FROM="OPVM",i.patObj.viewIssue=!0,i.patObj.RG_INT_MR_NO=s.patientGlobalDtlsNew[0].mrNo,i.patObj.patientDetails=s.patientGlobalDtlsNew[0],angular.extend(i.patObj.patientDetails,{visitType:2}),"Pharmacy Issues"===t[0].isPharmacyService||"General Issue"===t[0].isPharmacyService?(I.prepareParamListWithParam("pIssueSequenceId",t[0].refTranSeqID,o),I.executeQueryInput("OP_ISSUES_STORE_CODE",o,r,!0,!0,a,"popUp",{}).then(function(e){i.patObj.INDT_HD_SEQ_ID=t[0].refTranSeqID,i.patObj.ENTITY_SEQ_ID=e[1][0].ISS_FROM,i.patObj.ENTITY_NAME=e[1][0].ISS_FROM,i.patObj.ISS_NO=e[1][0].ISS_NO,L.go("index.opPharmcyWorklist.issueView",{storeObj:angular.toJson(i.patObj),patObj:angular.toJson(i.patObj)}),i.$emit("opw.toggleStatus",{message:!0})})):"Pharmacy Retruns"!==t[0].isPharmacyService&&"General Returns"!==t[0].isPharmacyService||(I.prepareParamListWithParam("pReturnSequenceId",t[0].refTranSeqID,o),I.executeQueryInput("OP_RETURNS_STORE_CODE",o,r,!0,!0,a,"popUp").then(function(e){i.patObj.RET_HD_SEQ_ID=t[0].refTranSeqID,i.patObj.ENTITY_SEQ_ID=e[1][0].gQDataCode,i.patObj.ENTITY_NAME=e[1][0].gQDataCode,L.go("index.opPharmcyWorklist.returnsView",{storeObj:angular.toJson(i.patObj),patObj:angular.toJson(i.patObj)}),i.$emit("opw.toggleStatus",{message:!0})}))},i.savaForMLCService=function(e,t,r,a,o,n,c,l,p){var d={url:"HISServices/HISServices"};d.requestData={operation:"postMLCSerivceForOP",messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enSeqId:e.enSeqId}},P.sendRestRequest(d).then(function(e){null!=e.data.HITService.message.errorCode&&11345==e.data.HISServices.message.errorCode?v.information("information","Service Rate Not Defined For MLC Serivce",!1,!1,me.time):(i.getOrderDetails(t,r,a,o,n,c,l,p),i.loadBillNumbers(s.mrNo),i.retriveRecords(),i.getPrescptionCount())})},i.checkOrUncheckRow=function(e){if(Array.isArray(e))for(let t=0;t<e.length;t++)i.setAuthFlags(e[t]);else i.setAuthFlags(e);i.adjustPreAuthFlags()},i.setAuthFlags=function(e){if(e.entity.servicePostingSeqId)for(let t=0;t<i.gridgbOptions.data.length;t++)e.entity.servicePostingSeqId==i.gridgbOptions.data[t].servicePostingSeqId&&e.isSelected?i.gridgbOptions.data[t].checkPreAuthRequest=!0:e.entity.servicePostingSeqId!=i.gridgbOptions.data[t].servicePostingSeqId||e.isSelected||(i.gridgbOptions.data[t].checkPreAuthRequest=!1)},i.adjustPreAuthFlags=function(){i.preAuthBtnShow=0,i.preAuthRequested=!1;for(var e=0;e<i.gridgbOptions.data.length;e++)1==i.gridgbOptions.data[e].checkPreAuthRequest&&(i.preAuthBtnShow=1,i.preAuthRequested=!0)},i.preAuthRecordFromBills=function(){var e=i.gridgbOptions.data;i.clearPreAuthColse();var t=[];for(let r=0;r<e.length;r++)1==e[r].checkPreAuthRequest&&t.push(e[r]);if(t.length>1)for(let e=0;e<t.length;e++){if(null!=t[e+1]&&t[e].payerName!=t[e+1].payerName)return v.hisAlertMulti("information","Information","Please Select Same Payer And Plan.",i.alertData,i.alertFunction,i.closeAlert),!1;if("Self"==t[e].payerName)return v.hisAlertMulti("information","Information","For Self Authorization not allowed",i.alertData,i.alertFunction,i.closeAlert),!1}for(let e=0;e<t.length;e++)if("Self"==t[e].payerName)return v.hisAlertMulti("information","Information","For Self Authorization not allowed",i.alertData,i.alertFunction,i.closeAlert),!1;i.activeFirst=5,i.reqFromOrder=!0,i.showNewAuth=!0,i.showAuthDtls=!1,i.preAuthBillNav=!0;var r=t[0].payerName.split("/");i.OrderPayerName=r[0],i.OrderPlanName=r[1],i.payerCompPlanseqId=t[0].payerCompPlanseqId,i.payerCompSeqId=t[0].payerCompSeqId,s.orderRowData=t[0],i.getAllPayerDetail(s.patientSeqId),i.getPatAllPayers(s.patientSeqId),i.preAuth.preAuthDetailsGridOtions.data=[],i.preAuth.preAuthDetailsGridOtions.data[0]=[],i.preAuth.preAuthDetailsGridOtions.data[0].isAmtNlPercFlag="1",i.preAuth.preAuthDetailsGridOtions.data[0].valueAmt="",i.preAuth.preAuthDetailsGridOtions.data[0].qty="",i.preAuth.preAuthHeaderObj.PREAUTH_BIL_DATE=new Date;let a=[];for(let e=0;e<t.length;e++)a.push(t[e].servSeqId);a=_.toString(a),i.orderService=[];let o={1:i.orderService},n=I.executeQueryURLReset(),c=new Array;I.prepareParamListWithParam("pServSeqId",a,c),I.executeQueryInput("GET_ORDERS_SERVICE_FOR_PRE_AUTH_OP",c,o,!0,!0,n,"popUp",{}).then(function(e){for(let e=0;e<t.length;e++)for(let r=0;r<i.orderService.length;r++)if(t[e].servSeqId==i.orderService[r].SERV_SEQ_ID){i.preAuth.preAuthDetailsGridOtions.data.push({isAmtNlPercFlag:"1",valueAmt:null!=t[e].total&&""!=t[e].total?parseFloat(t[e].total):t[e].total,qty:1,priServGroup:{DESCRIPTION:i.orderService[r].PRI_SERV_DESC,CODE:i.orderService[r].PRI_SERV_CODE},department:{DESCRIPTION:i.orderService[r].DEPT_DESC,CODE:i.orderService[r].DEPT_CODE},specialty:{DESCRIPTION:i.orderService[r].SPL_DESC,CODE:i.orderService[r].SPL_CODE},service:{SERV_NAME:i.orderService[r].SERV_NAME,SERV_SEQ_ID:i.orderService[r].SERV_SEQ_ID},approvedDetails:i.orderService[r].APPROVD_DTLS,approvedAmount:i.orderService[r].APPROVED_AMNT,approvedQty:i.orderService[r].APPROVED_QTY,remarks:i.orderService[r].APPROVE_REMARKS});break}}),i.preAuth.preAuthValue=ne.calPreAuthAmt(i.preAuth.preAuthDetailsGridOtions.data),i.preAuth.preAuthForServ=angular.copy(i.preAuth.preAuthValue)}}function t(e,t,r,a,i,o,s,n,c,l,p,d){o.cancel=function(){e.dismiss("cancel")},o.printParameterList=new Array,r.prepareParamList("pColrequestSeqId",d.pColrequestSeqId,o.printParameterList),o.printObject={},"HSC"==sessionStorage.productCustomization?o.printObject.reportId="DepositTaxInvoiceReportForHSC":o.printObject.reportId="OP_DEPOSIT_RECEIPT_RPT",o.printObject.destination="reportingServiceImpl",o.printObject.reportType={id:"PDF"==t?4:5,desc:t},o.printObject.paramsList=o.printParameterList,a.printReportFunction(o.printObject,o)}function r(e,t,r,a,i,o,s,n,c,l,p,d){o.cancel=function(){e.dismiss("cancel")},o.printParameterList=new Array,r.prepareParamList("pCrNtHdSeqId",d.pCrNtHdSeqId,o.printParameterList),r.prepareParamList("pIsCrNote",d.pIsCrNote,o.printParameterList),o.printObject={},o.printObject.reportId="OP_DEPOSIT_REFUND_RECEIPT_RPT",o.printObject.destination="reportingServiceImpl",o.printObject.reportType={id:"PDF"==t?4:5,desc:t},o.printObject.paramsList=o.printParameterList,a.printReportFunction(o.printObject,o)}function a(e,t,r,a,i,o,s,n,c,l,p,d){o.cancel=function(){e.dismiss("cancel")},o.printParameterList=new Array,r.prepareParamList("pPaymentRefundReceiptId",d.pPaymentRefundReceiptId,o.printParameterList),o.printObject={},"HSC"===sessionStorage.productCustomization?o.printObject.reportId="HSC_Patient_PaymentRefundRequestDetailsReportId":o.printObject.reportId="OutPatient_BillingReports_PaymentRefundRequestDetailsReportId",o.printObject.destination="reportingServiceImpl",o.printObject.reportType={id:"PDF"==t?4:5,desc:t},o.printObject.paramsList=o.printParameterList,a.printReportFunction(o.printObject,o)}function i(e,t,r,a,i,o,s,n,c,l,p,d){o.cancel=function(){e.dismiss("cancel")},o.printParameterList=new Array,o.pageName="CLAIM FORM PRINT",r.prepareParamList("pRgSeqId",d.regSeqId,o.printParameterList),r.prepareParamList("pEnSeqId",d.encSeqId?d.encSeqId:-999,o.printParameterList),r.prepareParamList("serviceListString",d.serviceListString,o.printParameterList),d.pPayerSeqId&&-999!=d.pPayerSeqId&&r.prepareParamList("pPayerSeqId",d.pPayerSeqId,o.printParameterList),o.printObject={},o.printObject.reportId=d.reportId,o.printObject.destination="reportingServiceImpl",o.printObject.reportType={id:4,desc:"PDF"},o.printObject.paramsList=o.printParameterList,a.printReportFunction(o.printObject,o)}function o(e,t,r,a,i,o,s,n,c,l,p,d,m,u,v){n.pageName="Report",n.cancel=function(){if("0"!=e.checkListsCountAvailable&&null!=e.checkListsCountAvailable&&""!=e.checkListsCountAvailable){var r=e.checkListsCountAvailable;e.checkListsCountAvailable="0";var a=m.getTop();m.dismiss(a.key);var i={buttonCallBack1:function(){m.dismissAll(),s.myCustomEvent()},buttonCallBack2:function(){var t={mrNo:e.mrNo,reportId:"HSC_PCKG_CKL_SAVE_ORDER_REPORT",servSeqId:r};v.printReportModal("printCheckListsCtrlNew","lg","PDF",t),m.dismissAll(),n.packageServicesArrayObejct=new Array,n.activeFirst=3}};u.hisAlertMulti("information","Information","Do you want to print Checklists?",{buttonText:"No",buttonText2:"Yes"},i,close)}else m.dismiss("cancel"),t.dismiss("cancel"),s.myCustomEvent()},n.printParameterList=new Array,a.prepareParamList("pFacilityId",angular.fromJson(sessionStorage.userContextObj).FACILITY_ID,n.printParameterList),a.prepareParamList("pPracticeId",angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,n.printParameterList),a.prepareParamList("pPatMrNo",e.mrNo,n.printParameterList),a.prepareParamList("pVisitNumber",e.visitNo,n.printParameterList),n.printObject={},n.printObject.reportId=e.reportId,n.printObject.destination="reportingServiceImpl",n.printObject.reportType={id:4,desc:"PDF"},n.printObject.paramsList=n.printParameterList,i.printReportFunction(n.printObject,n)}function s(e,t,r,a,i,o,s,n,c,l,p,d,m,u,v){n.cancel=function(){t.dismiss("cancel")};var S=e.billno?e.billno:e.pBillSeqId;n.pageName=e.billno?"Bill Print for ":"Tax Invoice - "+S,n.printParameterListForBill=new Array,e.billno?a.prepareParamList("pBillNo",e.billno,n.printParameterListForBill):e.pBillSeqId&&a.prepareParamList("pBillSeqId",e.pBillSeqId,n.printParameterListForBill),n.printObject={},n.printObject.reportId=e.reportId,n.printObject.destination="reportingServiceImpl",n.printObject.reportType={id:4,desc:e.printType},n.printObject.paramsList=n.printParameterListForBill,i.printReportFunction(n.printObject,n)}function n(e,t,r,a,i,o,s,n,c,l,p,d,m,u,v){n.pageName="Report",n.cancel=function(){m.dismissAll(),s.myCustomEvent()},n.printParameterList=new Array,a.prepareParamList("pFacilityId",angular.fromJson(sessionStorage.userContextObj).FACILITY_ID,n.printParameterList),a.prepareParamList("pPracticeId",angular.fromJson(sessionStorage.userContextObj).FACILITY_ID_DESC,n.printParameterList),a.prepareParamList("pPatMrNo",e.mrNo,n.printParameterList),a.prepareParamList("pServiceSeqID",e.servSeqId,n.printParameterList),n.printObject={},n.printObject.reportId=e.reportId,n.printObject.destination="reportingServiceImpl",n.printObject.reportType={id:4,desc:"PDF"},n.printObject.paramsList=n.printParameterList,i.printReportFunction(n.printObject,n)}function c(e,t,r,a,i,o,s,n,c,l,p,d,m,u,v){n.pageName="Report",n.cancel=function(){m.dismissAll()},n.printParameterList=new Array,a.prepareParamList("pFacilityId",angular.fromJson(sessionStorage.userContextObj).FACILITY_ID,n.printParameterList),a.prepareParamList("pPracticeId",angular.fromJson(sessionStorage.userContextObj).FACILITY_ID_DESC,n.printParameterList),a.prepareParamList("pPatMrNo",e.mrNo,n.printParameterList),a.prepareParamList("pServiceSeqID",e.servSeqId,n.printParameterList),n.printObject={},n.printObject.reportId=e.reportId,n.printObject.destination="reportingServiceImpl",n.printObject.reportType={id:4,desc:"PDF"},n.printObject.paramsList=n.printParameterList,i.printReportFunction(n.printObject,n)}e.$inject=["$q","opVisitExternalDoctorSearchGridNew","adtDailyReportComboQueryservice","BILLING_APIS","$scope","$interval","$rootScope","$http","$uibModal","OPVsitVisitHistoryNew","generateBillGridNew","opVisitManagementOpenVisitListGridNew","opVisitMgtServiceNew","opVisitMgtLablesNew","hisAlertService","hisModalService","uiGridConstants","PatientGlobal","PatientBannerGlobal","$stateParams","QueryService","CallManager","opVisitDoctorSearchGridNew","PatientBannerBilling","advancedSearchGridDefinitionNew","$timeout","$log","$filter","$uibModalStack","dropdownServiceEmergency","hisTranslationsService","$state","hisCalDefConstant","OPVISIT_MGMT_APIS","OPOrderAdvServiceGridNew","OPVsithealthCheckUpGridNew","$window","hisTranslationsGlobalLang","generateBillConcessionGridNew","generateBillConcesReqGridNew","generateBillDepositGridNew","generateBillRefundGridNew","generateBillPaymentGridNew","opOrderServiceNew","PrintService","dropdownQueryService","otComService","RoleTaskService","opBillPrintServiceNew","bookAppointmentService","BATransactionGridNew","BATransactionGridViewNew","hisConfigurationService","opVisitManagementPendingOrdersGrid","integrationService","patPermanentRegistrationService","$sce","gridDefApproval","ServiceGet","CommonForServiceData","PreAuthSaveServices","OPPreAuthServicesNew","PreAuthViewServices","OPVsitVisitHistorySubGridNew","hisAlertConstants","HISROUNDOFFNEW"],t.$inject=["$uibModalInstance","selectedPrintType","QueryService","PrintService","$sce","$scope","$rootScope","CallManager","IPINDENTAPIS","APIS","$window","returnObj"],a.$inject=["$uibModalInstance","selectedPrintType","QueryService","PrintService","$sce","$scope","$rootScope","CallManager","IPINDENTAPIS","APIS","$window","returnObj"],i.$inject=["$uibModalInstance","selectedPrintType","QueryService","PrintService","$sce","$scope","$rootScope","CallManager","IPINDENTAPIS","APIS","$window","returnObj"],r.$inject=["$uibModalInstance","selectedPrintType","QueryService","PrintService","$sce","$scope","$rootScope","CallManager","IPINDENTAPIS","APIS","$window","returnObj"],o.$inject=["returnObj","$uibModalInstance","selectedPrintType","QueryService","PrintServiceCustome","$sce","$rootScope","$scope","CallManager","IPINDENTAPIS","APIS","$window","$uibModalStack","hisAlertService","PrintService"],s.$inject=["returnObj","$uibModalInstance","selectedPrintType","QueryService","PrintServiceCustome","$sce","$rootScope","$scope","CallManager","IPINDENTAPIS","APIS","$window","$uibModalStack","hisAlertService","PrintService"],n.$inject=["returnObj","$uibModalInstance","selectedPrintType","QueryService","PrintServiceCustome","$sce","$rootScope","$scope","CallManager","IPINDENTAPIS","APIS","$window","$uibModalStack","hisAlertService","PrintService"],c.$inject=["returnObj","$uibModalInstance","selectedPrintType","QueryService","PrintServiceCustome","$sce","$rootScope","$scope","CallManager","IPINDENTAPIS","APIS","$window","$uibModalStack","hisAlertService","PrintService"],angular.module("napierContainerUi").controller("opVisitMgtCrtlNew",e).controller("depositPrintCtrlNew",t).controller("refundPrintCtrlNew",a).controller("claimFormPrintCtrlNew",i).controller("refundReceiptPrintCtrlNew",r).controller("printOrdersCtrlNew",o).controller("printBillCtrlNew",s).controller("printCheckListsCtrlNew",n).controller("printCheckListsGridCtrlNew",c)}(),function(){"use strict";angular.module("napierContainerUi").constant("advancedPatientSearchGridDefinition",{enableCellEditOnFocus:!0,enableRowSelection:!0,enableFullRowSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableSorting:!1,enableHorizontalScrollbar:1,columnDefs:[{name:"radio_row",displayName:"",width:20,headerCellTemplate:"<div><div>",cellTemplate:'<div class="ngSelectionCell"><input type="radio" name="rdUserList" ng-value="{{grid.renderContainers.body.visibleRowCache.indexOf(row)}}"  ng-model="releaseAction" ng-click="grid.appScope.advSearchRowClick(row)"></div>'},{name:"patientName",displayName:"opvm.PatientName",headerCellFilter:"translate"},{name:"mrNo",displayName:"opvm.uhid",headerCellFilter:"translate"},{name:"age",displayName:"opvm.age",headerCellFilter:"translate"},{name:"gender",displayName:"opvm.Gender",headerCellFilter:"translate"},{name:"dateofbirth",displayName:"opvm.DateofBirth",headerCellFilter:"translate",type:"date",cellFilter:"date:'dd-MM-yyyy'"},{name:"mno",displayName:"opvm.MobileNo",headerCellFilter:"translate"}]})}(),function(){"use strict";angular.module("napierContainerUi").constant("openVisitSubGrid",{enableSorting:!1,enableCellEditOnFocus:!0,enableFiltering:!1,enableFullRowSelection:!1,columnDefs:[{field:"billNo",displayName:"Bill No.",enableSorting:!0,enableCellEdit:!0,width:"*"},{field:"billDate",displayName:"Bill Date",enableSorting:!0,enableCellEdit:!0,width:"*",cellFilter:"date:'dd-MM-yyyy'"},{field:"billAmount",displayName:"Total Amount",enableSorting:!0,enableCellEdit:!0,headerCellClass:"text-right",width:"*",cellTemplate:'<div class="ui-grid-cell-contents" style="position: relative; right: 25%; text-align:right;">{{row.entity.billAmount}}</div>'},{field:"paiedAmount",displayName:"Paid Amount",enableSorting:!0,enableCellEdit:!0,width:"*",cellTemplate:'<div class="ui-grid-cell-contents" style="position: relative; right: 27%; text-align:right;">{{row.entity.paiedAmount}}</div>'},{field:"dueAmount",displayName:"Pending Amount",enableSorting:!0,enableCellEdit:!0,width:"*",cellTemplate:'<div class="ui-grid-cell-contents" style="position: relative; right: 10%; text-align:right;">{{row.entity.dueAmount}}</div>'},{field:"serviceName",displayName:"Service Item",enableSorting:!0,enableCellEdit:!0,pinnedRight:!0,width:162},{field:"serviceRate",displayName:"Amount",enableSorting:!0,enableCellEdit:!0,pinnedRight:!0,width:85,cellTemplate:'<div class="ui-grid-cell-contents" style="position: relative; right: 25%;text-align:right;">{{row.entity.serviceRate}}</div>'},{field:"serviceStatus",displayName:"Status",enableSorting:!0,enableCellEdit:!0,pinnedRight:!0,width:100,cellTemplate:'<div class="ui-grid-cell-contents"><div ng-if="row.entity.serviceStatus==\'Rendered\'"><i style="color: #62c129;" class="fa fa-check"></i>&nbsp;{{row.entity.serviceStatus}}</div><div ng-if="row.entity.serviceStatus==\'Not Rendered\'"><istyle="color: #cccccc;" class="fa fa-times"></i>&nbsp;{{row.entity.serviceStatus}}</div></div>'}]})}(),function(){"use strict";angular.module("napierContainerUi").constant("openVisitDef",{enableSorting:!1,enableCellEditOnFocus:!0,expandableRowTemplate:"app/consumer/his17_1/opVisitManagement/screens/opVisitDirectory/sections/op-open-visit-sub-grid.html",enableFiltering:!1,enableFullRowSelection:!1,columnDefs:[{field:"visitNo",displayName:"Visit No.",enableSorting:!0,enableCellEdit:!0,width:"*"},{field:"visitDate",displayName:"Visit Date",enableSorting:!0,enableCellEdit:!0,width:"*",cellFilter:"date:'dd-MM-yyyy'"},{field:"patName",displayName:"Patient Name",enableSorting:!0,enableCellEdit:!0,width:"*"},{field:"mrNo",displayName:"UHID",enableSorting:!0,enableCellEdit:!0,width:"*"},{field:"Gender",displayName:"Age / Gender",enableSorting:!0,enableCellEdit:!0,width:"*"},{field:"docName",displayName:"Doctor Name",enableSorting:!0,enableCellEdit:!0,width:"*"},{field:"speciality",displayName:"Speciality",enableSorting:!0,enableCellEdit:!0,width:"*"},{field:"enActionStatusDesc",displayName:"Visit Staus",enableSorting:!0,enableCellEdit:!0,cellTemplate:'<div style="margin-top:5px;"><div ng-if="row.entity.enActionStatusDesc != \'Completed\'">Open</div><div ng-if="row.entity.enActionStatusDesc == \'Completed\'">Completed</div></div>',width:"*"},{field:"billStatusDesc",displayName:"Bill Staus",enableSorting:!0,enableCellEdit:!0,cellTemplate:'<div style="margin-top:5px;"><div ng-if="row.entity.billStatusDesc != \'Bill Generated\'">Bill Not Generated</div><div ng-if="row.entity.billStatusDesc == \'Bill Generated\'">Bill Generated</div></div>',width:"*"},{field:"encountSeqId",visible:!1},{field:"subAccSeqId",visible:!1}]})}(),function(){"use strict";function e(e,t,r,a){this.fillopVisistgrid=function(t){var i,o=-999,s=-999;if(""!=t.opvisitDirpatientName&&null!=t.opvisitDirpatientName&&(o=t.opvisitDirpatientName.rgSeqId),""!=t.opvisitDoctor&&null!=t.opvisitDoctor&&(s=t.opvisitDoctor.DOCTID),t.openCompleted1&&(i=t.openCompleted1),1==t.billCompleted1)var n=(t.billCompleted?t.billCompleted+",":"").replace(/,/g,"");else n=t.billCompleted?t.billCompleted+","+t.billCompleted1:t.billCompleted1;var c=e.defer(),l={};return l.url=a.GBCONCESSIONDETAILS.URL,l.requestData={operation:"getOpVisitList",messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",fromDate:moment(t.opvisitDirFromDate).format("YYYY-MM-DD 00:00:00")+".180",toDate:moment(t.opvisitDirToDate).format("YYYY-MM-DD 23:59:59")+".180",rgSeqId:o,DocSeqId:s,status:t.openCompleted?t.openCompleted+(i?","+i:""):i||"",scmBillStatus:n}},r.sendRestRequest(l).then(function(e){var t=e;c.resolve(t)}),c.promise},this.fillopVisistSubgrid=function(t){var i=e.defer(),o={};return o.url=a.GBCONCESSIONDETAILS.URL,o.requestData={operation:"getOpVisitDetailsList",messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",subAccSeqId:t.subAccSeqId,encountSeqId:t.encountSeqId}},r.sendRestRequest(o).then(function(e){var t=e;i.resolve(t)}),i.promise},this.saveOpVisitConsolidatin=function(t){var i=e.defer(),o={};return o.url=a.GBCONCESSIONDETAILS.URL,o.requestData={operation:"completeOrOpenVisit",messageId:"",destination:"eneservice",message:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",encountSeqIdList:t.seqId,status:t.chkstatus}},r.sendRestRequest(o).then(function(e){var t=e;i.resolve(t)}),i.promise}}e.$inject=["$q","openVisitSubGrid","CallManager","OPVISIT_MGMT_APIS"],angular.module("napierContainerUi").service("opVisitDrService",e)}(),function(){"use strict";function e(e,t,r,a,i,o,s,n,c,l){var p=this;p.numOffiles=0,p.deleteFiles=[],p.patAdmFiles=[],p.totalFileSize=0,p.ppao={payAuthTotalAmount:r.payAuthTotalAmount,payAuthPatientAmount:r.payAuthPatientAmount,payAuthPayingAmount:r.payAuthPayingAmount,payAuthDueAmount:r.payAuthDueAmount},c.loadModule("opVisitManagement");var d=l.getLanguageToSet();c.changeLanguage(d),p.ip=r.ip?r.ip:void 0,p.PayAuthPayingAmountFunc=function(e){if("payAmount"==e)if(isNaN(parseFloat(p.ppao.payAuthPayingAmount)))p.ppao.payAuthPayingAmount="",p.ppao.payAuthDueAmount="";else if(parseFloat(p.ppao.payAuthPayingAmount)<=parseFloat(p.ppao.payAuthPatientAmount)){var t=parseFloat(p.ppao.payAuthPatientAmount)-parseFloat(p.ppao.payAuthPayingAmount);p.ppao.payAuthDueAmount=t.toFixed(2)}else p.ppao.payAuthPayingAmount="",p.ppao.payAuthDueAmount="";if("dueAmount"==e)if(isNaN(parseFloat(p.ppao.payAuthDueAmount)))p.ppao.payAuthPayingAmount="",p.ppao.payAuthDueAmount="";else if(parseFloat(p.ppao.payAuthDueAmount)<=parseFloat(p.ppao.payAuthPatientAmount)){var r=parseFloat(p.ppao.payAuthPatientAmount)-parseFloat(p.ppao.payAuthDueAmount);p.ppao.payAuthPayingAmount=r.toFixed(2)}else p.ppao.payAuthPayingAmount="",p.ppao.payAuthDueAmount=""},p.dynamicPopoverForUploadFile={templateUrl:"myPopoverTemplateInOpVisit.html"},p.open=function(e){t.open("UPLOAD FILES",{animation:!0,templateUrl:"app/consumer/his17_2/ADT/screens/patientAdmission/sections/upload.files.modal.html",size:e,controller:"uploadFileController",controllerAs:"upfileCtrl",backdrop:"static",resolve:{addedFiles:function(){return p.patAdmFiles},totalFileSize:function(){return p.totalFileSize},regSeqId:function(){return r.orderregSeqId}}}).result.then(function(e){p.numOffiles=p.numOffiles+e.noffiles,angular.forEach(e.files,function(e){p.patAdmFiles.push(e)}),p.totalFileSize=e.filsTotalSize,angular.forEach(e.seqIds,function(e){p.deleteFiles.push(e)})},function(){})},p.viewPayAuthUploadedFile=function(e){p.adtAdmPatPopOverCls=!1;o.viewUploadedFileFun(e).then(function(e){if(!angular.isUndefined(e.data.HITService.message.napierDocumentList[0]["com.napier.core.service.vo.uploadfile.NapierDocument"])){var t=e.data.HITService.message.napierDocumentList[0]["com.napier.core.service.vo.uploadfile.NapierDocument"].uploadDocumnt[0],r=e.data.HITService.message.napierDocumentList[0]["com.napier.core.service.vo.uploadfile.NapierDocument"].docExtension,a=t.replace("dataimage/jpegbase64","").replace("dataapplication/pdfbase64","").replace("dataapplication/vndopenxmlformatsofficedocumentwordprocessingmldocumentbase6\n4","").replace("dataimage/pngbase64","").replace("\n",""),i=r.toLowerCase();if("pdf"==i||"jpg"==i||"png"==i||"gif"==i||"jpeg"==i||"tif"==i||"tiff"==i||"bmp"==i)m(a,i);else if("xls"==i){var o="data:application/vnd.ms-excel,"+a;window.open(o,"_self")}else if("xlsx"==i){var s="data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"+";base64,"+a;window.open(s,"_self")}else{if("docx"==i||"doc"==i)u("data:application/octet-stream;base64,"+a,"download.docx")}}})};var m=function(e,r){t.open("",{animation:!0,templateUrl:"app/consumer/his17_2/ADT/screens/patientAdmission/sections/upload.image.view.modal.html",size:"lg",controller:"viewUploadsCtrl",controllerAs:"viewCtrl",resolve:{imgUrl:function(){return e},extF:function(){return r}}})},u=function(e,t){var r=document.createElement("a");r.download=t,r.href=e,r.click()};p.deletePayAuthFile=function(e,t){var r=JSON.parse(sessionStorage.getItem("userContextObj")),i=_.findIndex(t,function(t){return t.name==e.name});_.findIndex(p.patAdmFiles,function(t){t.name==e.name&&p.patAdmFiles.splice(i,1)}),o.deleteFileORRetriveFileFun("removeDocumentList",t[i],r).then(function(t){angular.isUndefined(t.data.HITService.message.napierDocumentList[0]["com.napier.core.service.vo.uploadfile.NapierDocument"])||a.success("Success",e.name+" file deleted successfully ")}),p.deleteFiles.splice(i,1),p.numOffiles=p.numOffiles-1},p.PayAuthBillSubmit=function(){if(!p.ppao.payAuthPayingAmount)return a.warning("Warning!","Please Enter Partial Paying Amount"),!1;var e=[];if(p.patAdmFiles.length>0)for(var t=0;t<p.patAdmFiles.length;t++){var o=p.patAdmFiles[t].name.split("."),c={documentName:o[0],documentExtension:o[1],modifiedBy:angular.fromJson(sessionStorage.userContextObj).USER_SEQ_ID,createdBy:angular.fromJson(sessionStorage.userContextObj).USER_SEQ_ID,uploadDocument:p.patAdmFiles[t].size};e.push(c)}var l={"@class":"com.napier.core.service.vo.visitmanagement.PartialPaymentAuthorizationVO",requestStatus:1,requestedBy:angular.fromJson(sessionStorage.userContextObj).USER_SEQ_ID,requestType:7,status:1,requestRemarks:p.ppao.payAuthRemarks?p.ppao.payAuthRemarks:"",totalOrderedAmount:parseFloat(p.ppao.payAuthTotalAmount),patientAmount:parseFloat(p.ppao.payAuthPatientAmount),patientPayingAmount:parseFloat(p.ppao.payAuthPayingAmount),patientDueAmount:parseFloat(p.ppao.payAuthDueAmount),patientType:p.ip?17:1,billNo:"Unbilled"!=r.billNo?r.billNo:void 0,visit:{visitNo:r.ordervisitId?r.ordervisitId:void 0},encounter:{enSeqId:r.orderencounterSeqId},registration:{rgSeqId:r.orderregSeqId},authorizationReqDocumentVOs:[{"com.napier.core.service.vo.visitmanagement.PartialPaymentAuthorizationReqDocumentVO":e}]},d={};d.url=s.updateService.URL,d.requestData={operation:"authorizationRequest",messageId:"",destination:"com.napier.core.visitmanagement.service.external.PartialPaymentAuthorizationService",message:l},n.sendRestRequest(d).then(function(e){e.data.HITService.message.partialPaymentSeqId?(i.close(r.billNo),a.success("SUCCESS","Partial Pay Request Submitted Successfully")):a.failure("FAILED"," Save Failed")},function(e){a.failure("Failed","Save Failed")})}}e.$inject=["$scope","hisModalService","data","hisAlertService","$uibModalInstance","uploadFileService","OPVISIT_MGMT_APIS","CallManager","hisTranslationsService","hisTranslationsGlobalLang"],angular.module("napierContainerUi").controller("opVisitPartialPayAuthCtrl",e)}(),function(){"use strict";angular.module("napierContainerUi").constant("advancedSearchGridDefinition",{enableCellEditOnFocus:!0,enableRowSelection:!0,enableFullRowSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableSorting:!1,enableHorizontalScrollbar:1,columnDefs:[{name:"radio_row",displayName:"",width:20,headerCellTemplate:"<div><div>",cellTemplate:'<div class="ngSelectionCell"><input ng-init="releaseAction=0" type="radio" name="rdUserList" ng-value="{{grid.renderContainers.body.visibleRowCache.indexOf(row)}}"  ng-model="releaseAction" ng-click="grid.appScope.advSearchRowClick(row)"></div>'},{name:"patientName",displayName:"opvm.PatientName",headerCellFilter:"translate"},{name:"mrNo",displayName:"opvm.MRNo",headerCellFilter:"translate"},{name:"age",displayName:"opvm.age",headerCellFilter:"translate"},{name:"gender",displayName:"opvm.Gender",headerCellFilter:"translate"},{name:"dateofbirth",displayName:"opvm.DateofBirth",headerCellFilter:"translate",type:"date",cellFilter:"date:'dd-MM-yyyy'"},{name:"mno",displayName:"opvm.MobileNo",headerCellFilter:"translate"}]})}(),function(){"use strict";angular.module("napierContainerUi").constant("generateBillGrid",{enableCellEditOnFocus:!0,enableRowSelection:!0,enableFullRowSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,multiSelect:!0,enableFiltering:!1,enableSorting:!1,enableHorizontalScrollbar:1,columnDefs:[{name:"ItemCode",displayName:"Service Code",headerCellFilter:"translate",pinnedLeft:!0,width:120,cellTemplate:'<div ng-class="(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? \'canceledbill\' : \'\'"><span ng-if="row.entity.renderType == 2" class="sericeRendergrid"></span><span ng-if="row.entity.renderType == 1" class="notRendergrid"></span><span  ng-if="!row.entity.editService">{{row.entity.ItemCode}} </span><span  ng-if="row.entity.editService" style="margin:5px;"><select ng-model="row.entity.ItemCodeNew" ng-options="item as item.PAYER_ALIAS_CODE for item in row.entity.serviceCodesList" style="width: 55px;"></select></span><span class="pull-right" style="margin-right:5px" ng-if="row.entity.payerAmt > 0"><i class="fa fa-pencil" ng-if="!row.entity.editService && grid.appScope.permissionList.T_OP_VISIT_EPAC" ng-click="row.entity.editService=true;grid.appScope.loadServiceAliasCodes(row,rowRenderIndex)"></i> &nbsp; <i class="fa fa-check green" ng-if="row.entity.editService" ng-click="grid.appScope.updateServiceAliasCodes(row,rowRenderIndex)"></i> &nbsp; <i style="border:0px !important;" class="fa fa-ban red" ng-if="row.entity.editService"ng-click="row.entity.editService=false;"></i></span> &nbsp;<span><i class="fa fa-money" ng-if="!row.entity.isPostBillApplicable" style="color:#b5223d" title="Pre Bill On"></i></span></div>'},{name:"ItemName",displayName:"Service Name",headerCellFilter:"translate",pinnedLeft:!0,width:180,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.ItemName}}</div>"},{name:"payerName",displayName:"Payer",headerCellFilter:"translate",width:220,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.payerName}}</div>"},{name:"baseRate",displayName:"opvm.generatebill_rate",headerCellFilter:"translate",width:80,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.baseRate.toFixed(2)}}</div>"},{name:"quantity",displayName:"opvm.generatebill_qty",headerCellFilter:"translate",width:60,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.quantity}}</div>"},{name:"baseRateTotal",displayName:"Total",headerCellFilter:"translate",width:80,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.baseRateTotal.toFixed(2)}}</div>"},{name:"discountAmt",displayName:"opvm.generatebill_discount",headerCellFilter:"translate",width:80,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.discountAmt.toFixed(2)}}</div>"},{name:"taxAmount",displayName:"opvm.generatebill_tax",headerCellFilter:"translate",width:80,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.taxAmount.toFixed(2)}}</div>"},{name:"total",displayName:"Net Total",headerCellFilter:"translate",width:80,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.total.toFixed(2)}}</div>"},{name:"payerAmt",displayName:"opvm.generatebill_payeramount",headerCellFilter:"translate",width:80,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.payerAmt.toFixed(2)}}</div>"},{name:"PatAmt",displayName:"opvm.generatebill_patamount",headerCellFilter:"translate",width:80,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.PatAmt.toFixed(2)}}</div>"},{name:"ItemDate",displayName:"opvm.generatebill_date",headerCellFilter:"translate",type:"date",cellFilter:"date:'dd-MM-yyyy'",width:80,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.ItemDate}}</div>"}]}).constant("generateBillConcessionGrid",{enableSorting:!1,enableCellEditOnFocus:!1,enableFiltering:!1,enableFullRowSelection:!1,columnDefs:[{displayName:"Service Name",headerCellFilter:"translate",name:"servName",enableSorting:!0,enableCellEdit:!1,pinnedLeft:!1,width:150},{displayName:"Conc. Per.",headerCellFilter:"translate",name:"concReqPer",enableSorting:!0,enableCellEdit:!1,width:102,cellTemplate:'<div><input class="form-control" style="margin-top:0px" ng-disabled="grid.appScope.concessionViewMode" ng-model="row.entity.concReqPer" ng-blur="grid.appScope.concServComp(row.entity,1)" limit-with-lowercase="10" ng-pattern="/^[0-9.]+$/"/></div>'},{displayName:"Conc. Amt.",headerCellFilter:"translate",name:"concReqAmt",enableSorting:!0,enableCellEdit:!1,width:102,cellTemplate:'<div><input class="form-control" style="margin-top:0px"  ng-disabled="grid.appScope.concessionViewMode" ng-model="row.entity.concReqAmt" ng-blur="grid.appScope.concServComp(row.entity,2)" limit-with-lowercase="10" ng-pattern="/^[0-9.]+$/"/></div>'}]}).constant("generateBillDepositGrid",{enableSorting:!1,enableCellEditOnFocus:!1,enableFiltering:!1,enableFullRowSelection:!1,columnDefs:[{displayName:"opvm.generateDate",headerCellFilter:"translate",name:"deptranDate",enableSorting:!0,enableCellEdit:!1,pinnedLeft:!1,width:100},{displayName:"opvm.generateref_no",headerCellFilter:"translate",name:"refSeqId",enableSorting:!0,enableCellEdit:!1,width:100},{displayName:"opvm.generateDepAmount",headerCellFilter:"translate",name:"depositAmount",enableSorting:!0,enableCellEdit:!1,width:70},{displayName:"opvm.generateAppliedAmt",headerCellFilter:"translate",name:"appliedAmount",enableSorting:!0,enableCellEdit:!1,width:70,visible:!1},{displayName:"opvm.generateBalance",headerCellFilter:"translate",name:"availableDefAmount",enableSorting:!0,enableCellEdit:!1,width:70}]}).constant("generateBillRefundGrid",{enableSorting:!1,enableCellEditOnFocus:!1,enableFiltering:!1,enableFullRowSelection:!1,columnDefs:[{displayName:"Date",headerCellFilter:"translate",name:"date",cellFilter:"date:'dd-MM-yyyy'",width:80},{displayName:"opvm.generatePayMode",headerCellFilter:"translate",name:"PayMode",width:80},{displayName:"opvm.generateAmtPaid",headerCellFilter:"translate",name:"amtPaid",width:90},{displayName:"opvm.generateref_no",headerCellFilter:"translate",name:"refNo",width:90,visible:!1},{displayName:"opvm.paidTo",headerCellFilter:"translate",name:"receivedfrom",width:100},{displayName:"opvm.generateaction",headerCellFilter:"translate",name:"action",width:60,cellTemplate:'<i class="fa fa-trash" ng-click="grid.appScope.removeFromRefundGrid(row,rowRenderIndex)"></i>'}]}).constant("generateBillPaymentGrid",{enableSorting:!1,enableCellEditOnFocus:!1,enableFiltering:!1,enableFullRowSelection:!1,columnDefs:[{displayName:"opvm.generatePayMode",headerCellFilter:"translate",name:"PayMode",width:80},{displayName:"opvm.generateAmtPaid",headerCellFilter:"translate",name:"amtPaid",width:80},{displayName:"opvm.generateref_no",headerCellFilter:"translate",name:"refNo",width:90},{displayName:"opvm.generateReceivedFrom",headerCellFilter:"translate",name:"Receivedfrom",width:100},{displayName:"opvm.generateaction",headerCellFilter:"translate",name:"action",width:60,cellTemplate:'<i class="fa fa-trash" ng-click="grid.appScope.removeFromPaymentGrid(row,rowRenderIndex)"></i>'}]}).constant("generateBillConcesReqGrid",{enableSorting:!1,enableCellEditOnFocus:!1,enableFiltering:!1,enableFullRowSelection:!1,columnDefs:[{displayName:"Concession",headerCellFilter:"translate",name:"cTypeDesc",enableSorting:!0,enableCellEdit:!1,pinnedLeft:!1,width:150},{displayName:"Conc. Per.",headerCellFilter:"translate",name:"billReqPer",enableSorting:!0,enableCellEdit:!1,width:80},{displayName:"Conc. Amt.",headerCellFilter:"translate",name:"billReqAmt",enableSorting:!0,enableCellEdit:!1,width:80,cellTemplate:'<div style="padding:5px;">{{(row.entity.dTotalServAmt)? row.entity.dTotalServAmt : row.entity.billReqAmt}}</div>'},{displayName:"Action",headerCellFilter:"translate",name:"actions",enableSorting:!0,enableCellEdit:!1,width:70,cellTemplate:'<div style="padding:5px;"><i class="fa fa-trash" ng-if="!row.entity.concessionSeqId" ng-click="grid.appScope.removeFromConcGrid(row,rowRenderIndex)"></i> <i ng-if="row.entity.concessionSeqId" class="fa fa-eye" title="View" ng-click="grid.appScope.ViewBillConcesDetails(row)"></i> &nbsp; &nbsp; &nbsp;<i ng-if="row.entity.concessionSeqId" class="fa fa-trash" title="Delete Concession" ng-click="grid.appScope.removeConcesData(row)"></i></div>'}]})}(),function(){"use strict";function e(e,t,r,a){this.getOrderDetails=function(t,i,o,s,n,c,l,p,d,m){var u=e.defer(),v={"@class":"com.napier.core.service.vo.visitmanagement.VisitConfigurationDetails",doctorSeqId:t,tariffSeqId:s,regSeqId:i,enSeqId:o,payerId:c,quantity:l,specialityCode:p||void 0,serviceSeqId:d&&!m?d:void 0,servicePostingSeqId:m||void 0},S={};return S.url=r.updateService.URL,S.requestData={operation:"getServiceRateByDoctorSpecialitywise",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:v},a.sendRestRequest(S).then(function(e){var t=e.data.HITService.message.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"],r=!1;t.multiEmployeeShareList&&t.multiEmployeeShareList.employeeShareList&&(r=!0);var a={accSeqId:t.accSeqId,actualRate:t.actualRate,discountAmt:t.discountAmt,doctorAmount:t.doctorAmount,doctorShare:t.doctorShare,doctorSurcharge:t.doctorSurcharge,facilityId:t.facilityId,gnFlow:t.gnFlow,hospitalShare:t.hospitalShare,hospitalSurcharge:t.hospitalSurcharge,isDeleteBill:t.isDeleteBill,isDepositRequired:t.isDepositRequired,isEmergencyAllowedCheck:t.isEmergencyAllowedCheck,isMLCFlag:t.isMLCFlag,isRateEditable:t.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,fromTariffRate:t.visitConfigOrRateCard,newRate:t.newRate,patientAmount:t.patientAmount,payerAmount:t.payerAmount,originalPatientAmount:null==t.companyPayingAmt?t.newRate:parseFloat(t.companyPayingAmt)>t.newRate?parseFloat(0):null!=t.actualRate&&parseFloat(t.companyPayingAmt)>=t.actualRate?parseFloat(0):parseFloat((t.newRate-parseFloat(t.companyPayingAmt)).toFixed(2)),originalPayerAmount:null==t.companyPayingAmt?parseFloat(0):parseFloat(t.companyPayingAmt)>t.newRate?t.newRate:null!=t.actualRate&&parseFloat(t.companyPayingAmt)>=t.actualRate?t.newRate:parseFloat(t.companyPayingAmt),practiceId:t.practiceId,proposedShareAfterDiscount:t.proposedShareAfterDiscount,requestedByEmpName:t.requestedByEmpName,requestedByEmpSeqID:t.requestedByEmpSeqID,requestedByEmpType:t.requestedByEmpType,servicePostingType:t.servicePostingType,quantity:t.quantity,isPostBillApplicable:t.isPostBillApplicable?t.isPostBillApplicable:0,serviceRate:t.serviceRate,serviceRateStatus:t.serviceRateStatus,serviceType:t.serviceType,serviceTypeCode:t.primaryServiceCode,standardDoctorShare:t.standardDoctorShare,subAccSeqId:t.subAccSeqId,technicianAmount:t.technicianAmount,transType:t.transType,servCode:t.serviceVo.servCode,servDesign:t.serviceVo.servDesign,servName:t.serviceVo.servName,servSeqId:t.serviceVo.servSeqId,visistType:t.serviceRateVo.visistType,baseRate:t.serviceRateVo.baseRate,gnServDesign:1,servicePayerAuthorization:t.servicePayerAuthorization,payerCompSeqId:t.payerCompSeqId,payerCompPlanseqId:t.payerCompPlanseqId,rcvSeqId:t.serviceRateVo.rcvSeqId,inflSeqId:t.serviceRateVo.inflSeqId,proposedShare:r?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare:0,billedShare:r?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare:0,grpMstCode:r?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0};u.resolve(a)}),u.promise},this.getAppoinmentConsDetails=function(t,i,o,s,n){for(var c=e.defer(),l=[],p=[],d=new Date,m=moment(d).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z",u=0;u<t.length;u++){if(1==t[u].appointmentType){var v={doctorSeqId:t[u].doctorId,tariffSeqId:s,regSeqId:i,enSeqId:o,payerId:n,specialityCode:t[u].specalityId,opApmntSeqId:t[u].opApmntSeqId};l.push(v)}if(2==t[u].appointmentType){var S={bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":[{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId"),opApmntSeqId:t[u].opApmntSeqId,servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:t[u].servSeqId,gnServDesign:1,servCode:t[u].servCode,servName:t[u].serviceName,secServTypeCode:t[u].priServTypCode,priServTypCode:t[u].secServTypeCode},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:t[u].servSeqId,tariffSeqId:s,datedOn:m,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:1,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:t[u].doctorId,payerId:n,fromOPVisit:"Y",priority:1}]}]};p.push(S)}}var y={};return y.url=r.updateService.URL,y.requestData={operation:"getMultipleServiceRateByDoctorSpecialitywise",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.service.vo.visitmanagement.AppointmentProcedureDetailsVo",visitConfigurationDetailsList:[{"com.napier.core.service.vo.visitmanagement.VisitConfigurationDetails":l}],servicePostingVoList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingVo":p}]}},a.sendRestRequest(y).then(function(e){try{var t=e.data.HITService.message[0]["com.napier.core.scm.serviceposting.vo.ServicePostingVo"];t=t instanceof Array?t:[t];for(var r=[],a=0;a<t.length;a++){var i,o=t[a].servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"],s=!1;o.multiEmployeeShareList&&o.multiEmployeeShareList.employeeShareList&&(s=!0),o.priority?i="Routine":32==o.serviceRateVo.visistType?i="New":33==o.serviceRateVo.visistType?i="Free Follow Up":37==o.serviceRateVo.visistType&&(i="Follow Up");var n=[{accSeqId:o.accSeqId,actualRate:o.actualRate,discountAmt:o.discountAmt,doctorAmount:o.doctorAmount,doctorShare:o.doctorShare,doctorSurcharge:o.doctorSurcharge,facilityId:o.facilityId,gnFlow:o.gnFlow,hospitalShare:o.hospitalShare,hospitalSurcharge:o.hospitalSurcharge,isDeleteBill:o.isDeleteBill,isDepositRequired:o.isDepositRequired,isEmergencyAllowedCheck:o.isEmergencyAllowedCheck,isMLCFlag:o.isMLCFlag,isRateEditable:o.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,fromTariffRate:o.visitConfigOrRateCard,newRate:o.newRate,patientAmount:o.patientAmount,payerAmount:o.payerAmount,originalPatientAmount:o.originalPatientAmount,originalPayerAmount:o.originalPayerAmount,practiceId:o.practiceId,proposedShareAfterDiscount:o.proposedShareAfterDiscount,requestedByEmpName:o.requestedByEmpName,requestedByEmpSeqID:o.requestedByEmpSeqID,requestedByEmpType:o.requestedByEmpType,servicePostingType:o.servicePostingType,quantity:o.quantity,isPostBillApplicable:o.isPostBillApplicable?o.isPostBillApplicable:0,priority:o.priority?o.priority:0,serviceRate:o.serviceRate,serviceRateStatus:o.serviceRateStatus,serviceType:o.primaryService,serviceTypeCode:o.primaryServiceCode,standardDoctorShare:o.standardDoctorShare,subAccSeqId:o.subAccSeqId,technicianAmount:o.technicianAmount,transType:o.transType,servCode:o.serviceVo.servCode,servDesign:o.serviceVo.servDesign,servName:o.serviceVo.servName,servSeqId:o.serviceVo.servSeqId,visistType:i,baseRate:o.serviceRateVo.baseRate,gnServDesign:1,servicePayerAuthorization:o.servicePayerAuthorization,payerCompSeqId:o.payerCompSeqId,payerCompPlanseqId:o.payerCompPlanseqId,rcvSeqId:o.serviceRateVo.rcvSeqId,inflSeqId:o.serviceRateVo.inflSeqId,proposedShare:s?o.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare:0,billedShare:s?o.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare:0,grpMstCode:s?o.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,opApmntSeqId:o.opApmntSeqId,billStatus:0,doctorModifiedAmount:0,rowIndex:a}];r.push(n)}c.resolve(r)}catch(e){return c.reject("")}}),c.promise}}e.$inject=["$q","BILLING_APIS","OPVISIT_MGMT_APIS","CallManager"],angular.module("napierContainerUi").service("opOrderService",e)}(),function(){"use strict";angular.module("napierContainerUi").service("OPPreAuthServices",["CallManager","$filter","$http","IPINDENTAPIS","$rootScope","$q","hisAlertService","QueryService","OPVISIT_MGMT_APIS",function(e,t,r,a,i,o,s,n,c){this.opPreAuthClear=function(e){e.preAuth.preAuthDetailsGridOtions.data=[],e.preAuth.preAuthViewDetailsGridOtions.data=[],e.preAuth.clearRecordFirst(),e.prevAmt="",e.preAuth.initialAuthAmount="",e.preAuth.preAuthCopyServAmt="",e.preAuth.isBillOrServiceFlag="2",e.reqFromOrder=!1,e.OrderPayerName=void 0,e.OrderPlanName=void 0,e.payerCompPlanseqId=void 0,e.payerCompSeqId=void 0,e.preAuth.isCoPayAvl="3",e.preAuth.coPayVal="",e.preAuth.isDedctibleAvl="3",e.preAuth.deductbleValue="",e.preAuth.preAuthHeaderObj={},e.preAuth.preAuthHeaderObj.PREAUTH_BIL_DATE=new Date,e.preAuth.preAuthHeaderObj.APPREFNO="",e.planSeqIdForUpdate=void 0,e.preAuth.fromDate=void 0,e.preAuth.toDate=void 0,e.preAuth.filesUploaded=[],e.preAuth.uploadedfileNames=[],e.preAuth.uploadingFile=!1,e.updateFlag=!1,e.preAuth.planObj="",e.preAuthBillNav=!1,e.PA.PAPayer=void 0,null!=e.prevoisEditIndex&&null!=e.addPayerAuthrList&&null!=e.addPayerAuthrList[e.prevoisEditIndex]&&null!=e.addPayerAuthrList[e.prevoisEditIndex].$edit&&(e.addPayerAuthrList[e.prevoisEditIndex].$edit=!1)},this.preObjForPerAuthService=function(e,t){for(let r=1;r<e.preAuth.preAuthDetailsGridOtions.data.length;r++){if(!(null!=e.preAuth.preAuthDetailsGridOtions.data[r].approvedDetails&&""!=e.preAuth.preAuthDetailsGridOtions.data[r].approvedDetails||t))return!0;if(e.saveDetails.push({serviceCode:null!=e.preAuth.preAuthDetailsGridOtions.data[r].service?e.preAuth.preAuthDetailsGridOtions.data[r].service.SERV_CODE:void 0,serviceSeqId:null!=e.preAuth.preAuthDetailsGridOtions.data[r].service&&null!=e.preAuth.preAuthDetailsGridOtions.data[r].service.SERV_SEQ_ID?e.preAuth.preAuthDetailsGridOtions.data[r].service.SERV_SEQ_ID:void 0,serviceName:null!=e.preAuth.preAuthDetailsGridOtions.data[r].service?e.preAuth.preAuthDetailsGridOtions.data[r].service.SERV_NAME:void 0,serviceRate:void 0,serviceQty:null!=e.preAuth.preAuthDetailsGridOtions.data[r].qty&&""!=e.preAuth.preAuthDetailsGridOtions.data[r].qty?parseFloat(e.preAuth.preAuthDetailsGridOtions.data[r].qty):void 0,serviceTax:void 0,serviceDiscountAmt:void 0,chargeableAmt:null!=e.preAuth.preAuthDetailsGridOtions.data[r].valueAmt&&""!=e.preAuth.preAuthDetailsGridOtions.data[r].valueAmt&&3!=e.preAuth.preAuthDetailsGridOtions.data[r].isAmtNlPercFlag?parseFloat(e.preAuth.preAuthDetailsGridOtions.data[r].valueAmt):void 0,expcServDate:"9999-03-05 00:00:00.000",gnTranStatus:2,serviceType:null!=e.preAuth.preAuthDetailsGridOtions.data[r].service&&null!=e.preAuth.preAuthDetailsGridOtions.data[r].service.SERV_SEQ_ID?parseFloat(1):null!=e.preAuth.preAuthDetailsGridOtions.data[r].specialty&&null!=e.preAuth.preAuthDetailsGridOtions.data[r].specialty.CODE?parseFloat(2):null!=e.preAuth.preAuthDetailsGridOtions.data[r].department&&null!=e.preAuth.preAuthDetailsGridOtions.data[r].department.CODE?parseFloat(3):null!=e.preAuth.preAuthDetailsGridOtions.data[r].priServGroup&&null!=e.preAuth.preAuthDetailsGridOtions.data[r].priServGroup.CODE?parseFloat(4):void 0,isAmtPercNl:null!=e.preAuth.preAuthDetailsGridOtions.data[r].isAmtNlPercFlag&&""!=e.preAuth.preAuthDetailsGridOtions.data[r].isAmtNlPercFlag?parseFloat(e.preAuth.preAuthDetailsGridOtions.data[r].isAmtNlPercFlag):void 0,primaryServCode:null!=e.preAuth.preAuthDetailsGridOtions.data[r].priServGroup&&null!=e.preAuth.preAuthDetailsGridOtions.data[r].priServGroup.CODE?e.preAuth.preAuthDetailsGridOtions.data[r].priServGroup.CODE:void 0,deptCode:null!=e.preAuth.preAuthDetailsGridOtions.data[r].department&&null!=e.preAuth.preAuthDetailsGridOtions.data[r].department.CODE?e.preAuth.preAuthDetailsGridOtions.data[r].department.CODE:void 0,specilityCode:null!=e.preAuth.preAuthDetailsGridOtions.data[r].specialty&&null!=e.preAuth.preAuthDetailsGridOtions.data[r].specialty.CODE?e.preAuth.preAuthDetailsGridOtions.data[r].specialty.CODE:void 0,gnStatus:t?parseInt(2):null!=e.preAuth.preAuthDetailsGridOtions.data[r].GN_STATUS?e.preAuth.preAuthDetailsGridOtions.data[r].GN_STATUS:parseInt(1),remarks:e.preAuth.preAuthDetailsGridOtions.data[r].remarks,approvedAmount:null!=e.preAuth.preAuthDetailsGridOtions.data[r].approvedAmount&&""!=e.preAuth.preAuthDetailsGridOtions.data[r].approvedAmount?parseFloat(e.preAuth.preAuthDetailsGridOtions.data[r].approvedAmount):void 0,approvedDetails:e.preAuth.preAuthDetailsGridOtions.data[r].approvedDetails,approvedQty:null!=e.preAuth.preAuthDetailsGridOtions.data[r].approvedQty&&""!=e.preAuth.preAuthDetailsGridOtions.data[r].approvedQty?parseFloat(e.preAuth.preAuthDetailsGridOtions.data[r].approvedQty):void 0,approxBillDtSeqId:e.preAuth.preAuthDetailsGridOtions.data[r].approxBillDtSeqId}),r==e.preAuth.preAuthDetailsGridOtions.data.length-1)return!1}for(let t=0;t<e.deletePreAuthService.length;t++)e.saveDetails.push({serviceCode:null!=e.deletePreAuthService[t].service?e.deletePreAuthService[t].service.SERV_CODE:void 0,serviceSeqId:null!=e.deletePreAuthService[t].service&&null!=e.deletePreAuthService[t].service.SERV_SEQ_ID?e.deletePreAuthService[t].service.SERV_SEQ_ID:void 0,serviceName:null!=e.deletePreAuthService[t].service?e.deletePreAuthService[t].service.SERV_NAME:void 0,serviceRate:void 0,serviceQty:null!=e.deletePreAuthService[t].qty&&""!=e.deletePreAuthService[t].qty?parseFloat(e.deletePreAuthService[t].qty):void 0,serviceTax:void 0,serviceDiscountAmt:void 0,chargeableAmt:null!=e.deletePreAuthService[t].valueAmt&&""!=e.deletePreAuthService[t].valueAmt&&3!=e.deletePreAuthService[t].isAmtNlPercFlag?parseFloat(e.deletePreAuthService[t].valueAmt):void 0,expcServDate:"9999-03-05 00:00:00.000",gnTranStatus:2,serviceType:null!=e.deletePreAuthService[t].service&&null!=e.deletePreAuthService[t].service.SERV_SEQ_ID?parseFloat(1):null!=e.deletePreAuthService[t].specialty&&null!=e.deletePreAuthService[t].specialty.CODE?parseFloat(2):null!=e.deletePreAuthService[t].department&&null!=e.deletePreAuthService[t].department.CODE?parseFloat(3):null!=e.deletePreAuthService[t].priServGroup&&null!=e.deletePreAuthService[t].priServGroup.CODE?parseFloat(4):void 0,isAmtPercNl:null!=e.deletePreAuthService[t].isAmtNlPercFlag&&""!=e.deletePreAuthService[t].isAmtNlPercFlag?parseFloat(e.deletePreAuthService[t].isAmtNlPercFlag):void 0,primaryServCode:null!=e.deletePreAuthService[t].priServGroup&&null!=e.deletePreAuthService[t].priServGroup.CODE?e.deletePreAuthService[t].priServGroup.CODE:void 0,deptCode:null!=e.deletePreAuthService[t].department&&null!=e.deletePreAuthService[t].department.CODE?e.deletePreAuthService[t].department.CODE:void 0,specilityCode:null!=e.deletePreAuthService[t].specialty&&null!=e.deletePreAuthService[t].specialty.CODE?e.deletePreAuthService[t].specialty.CODE:void 0,gnStatus:null!=e.deletePreAuthService[t].GN_STATUS?e.deletePreAuthService[t].GN_STATUS:parseInt(2),remarks:e.deletePreAuthService[t].remarks,approvedAmount:null!=e.deletePreAuthService[t].approvedAmount&&""!=e.deletePreAuthService[t].approvedAmount?parseFloat(e.deletePreAuthService[t].approvedAmount):void 0,approvedDetails:e.deletePreAuthService[t].approvedDetails,approvedQty:null!=e.deletePreAuthService[t].approvedQty&&""!=e.deletePreAuthService[t].approvedQty?parseFloat(e.deletePreAuthService[t].approvedQty):void 0,approxBillDtSeqId:e.deletePreAuthService[t].approxBillDtSeqId})};var l=function(e,t,r){var a=parseFloat((e.issueData.originalPayerAmount/e.issueData.serviceRate*100).toFixed(2));e.issueData.originalPatientAmount>0&&e.issueData.originalPayerAmount>0?(t.originalPayerAmount=parseFloat((t.serviceRate*a/100).toFixed(2)),t.originalPatientAmount=parseFloat((t.serviceRate-t.originalPayerAmount).toFixed(2))):e.issueData.originalPayerAmount>0&&(t.originalPayerAmount=t.serviceRate,t.originalPatientAmount=0),1==r.IS_AMT_PERC_NL_CODE?(r.APPROVED_AMNT=r.APPROVED_AMNT+e.issueData.originalPayerAmount,r.CONSUMABLE_AMOUNT=r.CONSUMABLE_AMOUNT-e.issueData.originalPayerAmount):3==r.IS_AMT_PERC_NL_CODE&&(e.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(e.preAuthHdrRcdList.APPROVED_AMNT)+parseFloat(e.issueData.originalPayerAmount)),r.CONSUMABLE_QTY>0&&(r.APPROVED_QTY=e.preAuthRcdList[j].APPROVED_QTY+1,r.CONSUMABLE_QTY=e.preAuthRcdList[j].CONSUMABLE_QTY-1)};this.opPharmacyCalP=function(e,t,r){l(e,t,r)},this.opPreAuthGetData=function(e,t){e.preAuthData=[],e.preAuthDataListObj={1:e.preAuthData};var r=n.executeQueryURLReset();e.preAuthDataList=new Array,n.prepareParamList(1,null!=e.orderData.subAccSeqId?e.orderData.subAccSeqId:parseFloat(sessionStorage.getItem("subaccountseqId")),e.preAuthDataList),n.prepareParamList(2,e.payerTypeModel.PayerType.PINS_SEQ_ID,e.preAuthDataList),n.executeQueryInput("GET_PREAUTH_POSTING_SERVICE_DETAILS",e.preAuthDataList,e.preAuthDataListObj,!0,!0,r,"popUp",{}).then(function(r){for(let t=0;t<e.preAuthData.length;t++)if("N"==e.preAuthData[t].IS_PRE_AUTH_HEADER){for(let r=0;r<e.preAuthRcdList.length&&e.preAuthData[t].PREAUTH_BILL_HD_SEQ_ID!=e.preAuthRcdList[r].PREAUTH_BILL_HD_SEQ_ID;r++)r==e.preAuthRcdList.length-1&&e.preAuthRcdList.push(e.preAuthData[t]);0==e.preAuthRcdList.length&&e.preAuthRcdList.push(e.preAuthData[t])}else"Y"==e.preAuthData[t].IS_PRE_AUTH_HEADER&&(null!=e.preAuthHdrRcdList.PREAUTH_BILL_HD_SEQ_ID&&e.preAuthHdrRcdList.PREAUTH_BILL_HD_SEQ_ID.toString().indexOf(e.preAuthData[t].PREAUTH_BILL_HD_SEQ_ID)<0?(e.preAuthHdrRcdList.APPROVED_AMNT=e.preAuthHdrRcdList.APPROVED_AMNT+parseFloat(e.preAuthData[t].SERV_SEQ_ID),e.preAuthHdrRcdList.PREAUTH_BILL_HD_SEQ_ID=", "+e.preAuthData[t].PREAUTH_BILL_HD_SEQ_ID):null==e.preAuthHdrRcdList.PREAUTH_BILL_HD_SEQ_ID&&(e.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(e.preAuthData[t].SERV_SEQ_ID),e.preAuthHdrRcdList.PREAUTH_BILL_HD_SEQ_ID=e.preAuthData[t].PREAUTH_BILL_HD_SEQ_ID.toString()),1==e.preAuthData[t].RW&&(e.preAuthHdrRcdList.IS_BILL_OR_SERVE_LEVEL=e.preAuthData[t].IS_BILL_OR_SERVE_LEVEL,e.preAuthHdrRcdList.RW=e.preAuthData[t].RW,e.preAuthHdrRcdList.HEAD_AMT=parseFloat(e.preAuthData[t].SERV_SEQ_ID),e.preAuthHdrRcdList.TYPE=e.preAuthData[t].TYPE));if(null!=t&&t.length>0)for(let r=0;r<t.length;r++)if(null!=t[r][0]&&"Self"!=t[r][0].payerType)if(t[r][0].isComingFromOPPharmacy&&"Pharmacy Retruns"==t[r][0].isPharmacyService){for(let a=0;a<t.length;a++)t[a][0].isComingFromOPPharmacy&&"Pharmacy Issues"==t[a][0].isPharmacyService&&null!=t[r][0].pharamcyIssueServSeqId&&t[r][0].pharamcyIssueServSeqId==t[a][0].refTranSeqID&&(e.issueData=t[a][0]);for(let a=0;a<e.preAuthRcdList.length;a++)if("N"==e.preAuthRcdList[a].IS_PRE_AUTH_HEADER)if(e.preAuthRcdList[a].TYPE,4==e.preAuthRcdList[a].SERVICE_TYPE){if(e.issueData.priServTypCode==e.preAuthRcdList[a].SERV_SEQ_ID){l(e,t[r][0],e.preAuthRcdList[a]);break}}else if(3==e.preAuthRcdList[a].SERVICE_TYPE){if(e.issueData.deptCode==e.preAuthRcdList[a].SERV_SEQ_ID){l(e,t[r][0],e.preAuthRcdList[a]);break}}else if(2==e.preAuthRcdList[a].SERVICE_TYPE){if(e.issueData.specilityCode==e.preAuthRcdList[a].SERV_SEQ_ID){l(e,t[r][0],e.preAuthRcdList[a]);break}}else if(1==e.preAuthRcdList[a].SERVICE_TYPE&&e.issueData.servSeqId==e.preAuthRcdList[a].SERV_SEQ_ID){l(e,t[r][0],e.preAuthRcdList[a]);break}}else e.preAuthBillOrServiceCal(!1,t[r][0]);else null==t[r][0]&&"Self"!=t[r].payerType&&e.preAuthBillOrServiceCal(!1,t[r]);else e.preAuthBillOrServiceCal();null!=t&&1==e.preAuthBillNav&&e.orderSave(!0)})},this.opPreAuthCalBeforeOrder=function(e,t,r,a){if(r)null!=a.originalPayerAmount&&parseFloat(a.originalPayerAmount)>0&&(1==e.IS_AMT_PERC_NL_CODE?parseFloat(e.CONSUMABLE_AMOUNT)>0&&parseFloat(e.CONSUMABLE_QTY)>0?(e.APPROVED_AMNT=e.APPROVED_AMNT+parseFloat(a.originalPayerAmount),e.CONSUMABLE_AMOUNT=parseFloat(e.CONSUMABLE_AMOUNT)-parseFloat(a.originalPayerAmount),e.APPROVED_QTY=e.APPROVED_QTY+1,e.CONSUMABLE_QTY=parseFloat(e.CONSUMABLE_QTY)-1,t.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)+parseFloat(a.originalPayerAmount)):parseFloat(e.CONSUMABLE_AMOUNT)>0&&0==parseFloat(e.CONSUMABLE_QTY)?(e.APPROVED_AMNT=e.APPROVED_AMNT+parseFloat(a.originalPayerAmount),e.CONSUMABLE_AMOUNT=parseFloat(e.CONSUMABLE_AMOUNT)-parseFloat(a.originalPayerAmount),t.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)+parseFloat(a.originalPayerAmount)):0==parseFloat(e.CONSUMABLE_AMOUNT)&&parseFloat(e.CONSUMABLE_QTY)>0&&(e.APPROVED_QTY=e.APPROVED_QTY+1,e.CONSUMABLE_QTY=parseFloat(e.CONSUMABLE_QTY)-1):2==e.IS_AMT_PERC_NL_CODE?parseFloat(e.CONSUMABLE_QTY)>0&&(e.APPROVED_QTY=e.APPROVED_QTY+1,e.CONSUMABLE_QTY=parseFloat(e.CONSUMABLE_QTY)-1):3==e.IS_AMT_PERC_NL_CODE&&("PA"==e.APPROVD_DTLS&&parseFloat(e.CONSUMABLE_QTY)>0?(e.APPROVED_QTY=e.APPROVED_QTY+1,e.CONSUMABLE_QTY=parseFloat(e.CONSUMABLE_QTY)-1,t.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)+parseFloat(a.originalPayerAmount)):"AP"==e.APPROVD_DTLS&&(t.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)+parseFloat(a.originalPayerAmount))));else{if(null==a.actualRate?a.actualRate=a.price:null!=a.price&&a.price>a.actualRate&&(a.actualRate=a.price),1==e.IS_AMT_PERC_NL_CODE)!(null!=e.APPROVED_AMNT&&e.APPROVED_AMNT>0)||null!=e.APPROVED_QTY&&0!=parseFloat(e.APPROVED_QTY)||null!=e.CONSUMABLE_QTY&&0!=parseFloat(e.CONSUMABLE_QTY)?null!=e.APPROVED_QTY&&null!=e.APPROVED_AMNT&&e.APPROVED_QTY>0&&e.APPROVED_AMNT>0?(e.APPROVED_QTY=e.APPROVED_QTY-1,e.CONSUMABLE_QTY=parseFloat(e.CONSUMABLE_QTY)+1,e.APPROVED_AMNT>=parseFloat(a.actualRate)?(a.patamount=0,a.payeramount=parseFloat(a.actualRate),e.APPROVED_AMNT=e.APPROVED_AMNT-parseFloat(a.actualRate),parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)>=parseFloat(a.actualRate)&&(t.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)-parseFloat(a.actualRate)),e.CONSUMABLE_AMOUNT=parseFloat(e.CONSUMABLE_AMOUNT)+parseFloat(a.actualRate)):(a.patamount=parseFloat(a.actualRate)-e.APPROVED_AMNT,parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)>=parseFloat(e.APPROVED_AMNT)&&(t.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)-parseFloat(e.APPROVED_AMNT)),a.payeramount=e.APPROVED_AMNT,e.APPROVED_AMNT=0,e.CONSUMABLE_AMOUNT=parseFloat(e.CONSUMABLE_AMOUNT)+parseFloat(a.payeramount))):null!=e.APPROVED_QTY&&e.APPROVED_QTY>0&&(null==e.APPROVED_AMNT||0==e.APPROVED_AMNT)&&0==parseFloat(e.CONSUMABLE_AMOUNT)?(e.APPROVED_QTY=e.APPROVED_QTY-1,e.CONSUMABLE_QTY=parseFloat(e.CONSUMABLE_QTY)+1,a.patamount=0,a.payeramount=parseFloat(a.actualRate)):(a.patamount=parseFloat(a.actualRate),a.payeramount=0):e.APPROVED_AMNT>=parseFloat(a.actualRate)?(a.patamount=0,a.payeramount=parseFloat(a.actualRate),e.APPROVED_AMNT=e.APPROVED_AMNT-parseFloat(a.actualRate),parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)>=parseFloat(a.actualRate)&&(t.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)-parseFloat(a.actualRate)),e.CONSUMABLE_AMOUNT=parseFloat(e.CONSUMABLE_AMOUNT)+parseFloat(a.actualRate)):(a.patamount=parseFloat(a.actualRate)-e.APPROVED_AMNT,parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)>=parseFloat(e.APPROVED_AMNT)&&(t.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)-parseFloat(e.APPROVED_AMNT)),a.payeramount=e.APPROVED_AMNT,e.APPROVED_AMNT=0,e.CONSUMABLE_AMOUNT=parseFloat(e.CONSUMABLE_AMOUNT)+parseFloat(a.payeramount));else if(2==e.IS_AMT_PERC_NL_CODE)if(!(null!=e.APPROVED_AMNT&&e.APPROVED_AMNT>0)||null!=e.APPROVED_QTY&&0!=parseFloat(e.APPROVED_QTY)||null!=e.CONSUMABLE_QTY&&0!=parseFloat(e.CONSUMABLE_QTY))if(null!=e.APPROVED_AMNT&&null!=e.APPROVED_QTY&&e.APPROVED_QTY>0&&e.APPROVED_AMNT>0){let t=parseFloat((parseFloat(a.actualRate)*parseFloat(e.APPROVED_AMNT)/100).toFixed(2));a.patamount=parseFloat(a.actualRate)-t,a.payeramount=t,e.APPROVED_QTY=e.APPROVED_QTY-1,e.CONSUMABLE_QTY=parseFloat(e.CONSUMABLE_QTY)+1}else null!=e.APPROVED_QTY&&e.APPROVED_QTY>0&&(null==e.APPROVED_AMNT||0==e.APPROVED_AMNT)&&0==parseFloat(e.CONSUMABLE_AMOUNT)?(e.APPROVED_QTY=e.APPROVED_QTY-1,e.CONSUMABLE_QTY=parseFloat(e.CONSUMABLE_QTY)+1,a.patamount=0,a.payeramount=parseFloat(a.actualRate)):(a.patamount=parseFloat(a.actualRate),a.payeramount=0);else{let t=parseFloat((parseFloat(a.actualRate)*parseFloat(e.APPROVED_AMNT)/100).toFixed(2));a.patamount=parseFloat(a.actualRate)-t,a.payeramount=t}else 3==e.IS_AMT_PERC_NL_CODE&&parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)>parseFloat(e.CONSUMABLE_AMOUNT)&&("AP"==e.APPROVD_DTLS&&parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)>0?parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)>=parseFloat(a.actualRate)?(a.patamount=0,a.payeramount=parseFloat(a.actualRate),t.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)-parseFloat(a.actualRate)):(a.patamount=parseFloat(a.actualRate)-parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT),a.payeramount=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT),t.preAuthHdrRcdList.APPROVED_AMNT=0):"PA"==e.APPROVD_DTLS&&null!=e.APPROVED_QTY&&e.APPROVED_QTY>0&&parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)>0&&(parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)>=parseFloat(a.actualRate)?(a.patamount=0,a.payeramount=parseFloat(a.actualRate),t.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)-parseFloat(a.actualRate),e.APPROVED_QTY=e.APPROVED_QTY-1,e.CONSUMABLE_QTY=parseFloat(e.CONSUMABLE_QTY)+1):(a.patamount=parseFloat(a.actualRate)-parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT),a.payeramount=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT),t.preAuthHdrRcdList.APPROVED_AMNT=0,e.APPROVED_QTY=e.APPROVED_QTY-1,e.CONSUMABLE_QTY=parseFloat(e.CONSUMABLE_QTY)+1)));a.preAuthDone=1}},this.updatePrintInClaimForm=function(t){var r=o.defer(),a={"@class":"com.napier.core.service.vo.billing.Insurance",insuranceSeqId:t.PINS_SEQ_ID,printInClaimForm:t.CLAIM_YN},i={};return i.url=c.GBBILLREPORTGENERATION.URL,i.requestData={operation:"updateClaimFoamPrint",messageId:"",destination:"com.napier.core.billing.service.external.PayerDetailsService",message:a},e.sendRestRequest(i).then(function(e){r.resolve(e)}),r.promise}}])}(),function(){"use strict";angular.module("napierContainerUi").service("opBillPrintService",function(){this.getPrintData=function(e,t,r,a,i){var o=parseInt(e),s="OUTPATIENT_BILL_ITEMIZED_REPORT ";r=r.DT_CODE,a=a.desc,2==r?s=2==o?i?"OUTPATIENT_BILL_ITEMIZED_CASH_PAYER_REPORT":"OUTPATIENT_BILL_ITEMIZED_REPORT":"OUTPATIENT_BILL_ITEMIZED_PAYER_REPORT":3==r?s=2==o?i?"OUTPATIENT_BILL_MMACODE_CASH_PAYER_REPORT":"OUTPATIENT_BILL_MMACODE_REPORT":"OUTPATIENT_BILL_MMACODE_PAYER_REPORT":1==r?s=2==o?i?"OUTPATIENT_BILL_SUMMERIZED_CASH_PAYER_REPORT":"OUTPATIENT_BILL_SUMMERIZED_REPORT":"OUTPATIENT_BILL_SUMMERIZED_PAYER_REPORT":4==r&&(s=2==o?i?"PARTIALIZED_BILL_CASH_PAYER_REPORT":"PARTIALIZED_BILL_REPORT":"PARTIALIZED_BILL_PAYER_REPORT");var n={billno:t,reportId:s,printType:a};return n}})}(),function(){"use strict";angular.module("napierContainerUi").constant("opVisitMgtLables",[{visitInfo:{headings:{VisitMangement:"OP Visit Management",addPatientDetails:"Add Patient Details",registerPatient:"Register Patient",addnewVisit:"Add New Visit",visitHistory:"Visit History",visitinfo:"Visit Info",order:"Orders",generateBills:"Generate Bills",payment:"Payment",paryerAuthourazion:"Payer Authourazion",payerDetailsTitle:"Payer Details",previousVisitNote:"Previous Visit Note"},visitMgt:{searchByPatients:"Search by Patient :",searchByVisit:"Search by Visit :",or:"(or)"},visitDetils:{episodeNo:"Episode No. :",episodeDescription:"Episode Description :",visitType:"Visit Type :",selectDoctor:"Select Doctor :",selectReferal:"Select Referal :",referedBy:"Refered By :"},mlcDetails:{mlcDetails:"MLC Details",mlcType:"MLC Type: ",mlcNo:"MLC No.: ",accidentReportNo:"Accident Report No. :",informedPolice:"Informed Police Station :",policePersonnelName:"Police Personnel Name :",uploadFile:"Upload File",remark:"Remarks"},previousVisitNote:{VisitNumber:"Visit Number",DateAndTime:"Date & Time",Author:"Author",VisitNote:"Visit Note"},addPatientDetail:{captureimage:"Capture Image",nationalId:"National ID",gender:"Gender",title:"Title",firstName:"First Name",mobileNumber:"Mobile No.",middleName:"Middle Name",emailId:"Email ID",lastName:"Last Name",service:"Service",dob:"Date of Birth",age:"Age",save:"Save"},patientBannerDetails:{name:"Mr. Paul Lee",userIdFormat:"jho 123456789",encounterID:"Encounter Id",userEncounterIDFormat:"ip 123456789",dob:"Date of Birth",userdateOfBirthFormat:"14 February 1988",bloodGroup:"Blood Group",userBloodGroupFormat:"O+",patientCategory:"Patient Category",userPatientCategory:"Insurance",insuranceCompany:"Insurance Company",userInsuranceComapany:"Bharati AXA Life","planType/Name":"Plan Type/Name",userPlanType:"Yearly Plan/Life MAX Plan",planEffectiveFrom:"Plan Effective From",userPlanEffectiveFormFormat:"15/03/2017",planEffectiveTo:"Plan Effective To",userPlanEffectiveFormTo:"14/03/2016",dignosis:"Dignosis",userDignosis:"2-h Plasma glucose (2-h PG)",allergies:"Allergies",userAllargies:"Codeine (nausea), Imitrex, Pencilin",triage:"Triage",userTriage:"Emergency"},mlcpreviousVisitNote:{visitNo:"Visit No. :",patientID:"",date:"Date:",dateformat:"",doctorName:"",followUp:""}}}])}(),function(){"use strict";function e(e,t,r,a){function i(e){var t;return(t=e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"])instanceof Array?t:null!=e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"]?t=e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"].columnList[0]["com.napier.core.service.vo.query.Column"]:""}function o(e,t){var r=e*(t/100);return null==r||!angular.isNumber(r)||isNaN(r)?"":r.toFixed(2)}this.comboBoxFetch=function(r,o){var s=e.defer(),n={},c=r;"MLC_TYPES"==c&&(n={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:c,idxList:[{"com.napier.core.service.vo.query.Index":[{ident:"1",value:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID}]}]}]}]}),"MQ0002"==c&&(n={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:c,idxList:[{"com.napier.core.service.vo.query.Index":[{ident:"1",value:"A"},{ident:"2",value:"A"},{ident:"3",value:"A"}]}]}]}]}),"SPECIALITY_LIST"==c&&(n={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:c,idxList:[{"com.napier.core.service.vo.query.Index":[]}]}]}]}),"TRN003"==c&&(n={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:c,idxList:[{"com.napier.core.service.vo.query.Index":[{paramName:"pMasterSqId",value:"6"}]}]}]}]}),"GET_COPMANY_ACC_DTLS"==c&&(n={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:c,idxList:[{"com.napier.core.service.vo.query.Index":[{paramName:"pPracticeId",value:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID}]}]}]}]});var l={};return l.url=t.HISCOMBOFILLING.URL,l.requestData={operation:"ExecuteQuery",destination:"QueryService",message:n},a.sendRestRequest(l).then(function(e){if("SPECIALITY_LIST"==c){var t=[],r=i(e);angular.forEach(r,function(e,r){var a=e.columnList[0]["com.napier.core.service.vo.query.Column"],i={CODE:a[0].data,DESCRIPTION:a[1].data};t.push(i)}),s.resolve(t)}if("MLC_TYPES"==c){var a=[],o=i(e);angular.forEach(o,function(e,t){var r=e.columnList[0]["com.napier.core.service.vo.query.Column"],i={CODE:r[0].data,DESCRIPTION:r[1].data};a.push(i)}),s.resolve(a)}if("MQ0002"==c){var n=[],l=i(e);angular.forEach(l,function(e,t){var r=e.columnList[0]["com.napier.core.service.vo.query.Column"],a={CODE:r[0].data,DESCRIPTION:r[1].data};n.push(a)}),s.resolve(n)}if("TRN003"==c){var p=[],d=i(e);angular.forEach(d,function(e,t){var r=e.columnList[0]["com.napier.core.service.vo.query.Column"],a={DT_CODE:r[0].data,DETAIL_DESC:r[1].data};p.push(a)}),s.resolve(p)}if("GET_COPMANY_ACC_DTLS"==c){var m=[],u=i(e);angular.forEach(u,function(e,t){var r=e.columnList[0]["com.napier.core.service.vo.query.Column"],a={INS_COMP_CODE:r[0].data,INS_COMP_NAME:r[1].data};m.push(a)}),s.resolve(m)}},function(e){}),s.promise},this.searchServices=function(r,o){var s,n=e.defer();s={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"ADV_REG_PAT_SER_PID_01",idxList:[{"com.napier.core.service.vo.query.Index":[{paramName:"pFirstName",value:r.patientName?r.patientName:""},{paramName:"pMRNo",value:r.MrNo?r.MrNo:""},{paramName:"pGender",value:r.gender?r.gender:""},{paramName:"pDOB",value:r.dateofbirth?r.dateofbirth:""},{paramName:"pMobileNo",value:r.mno?r.mno:""},{paramName:"pRegType",value:r.regType?r.regType:""},{paramName:"pRegPayerType",value:r.payer?r.payer:""}]}]}]}]};var c={};return c.url=t.HISCOMBOFILLING.URL,c.requestData={operation:"ExecuteQuery",destination:"QueryService",message:s},a.sendRestRequest(c).then(function(e){$(".btn-group").show();var t=e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"],r=Array.isArray(t),a=i(e),s=[];Array.isArray(a);if(""!=t&&null!=t&&1==r&&(6==o.columnDefs.length&&o.columnDefs.unshift({cellTemplate:'<div class="btn-group" ng-init="releaseAction=0"><input type="radio" name="radio_chk" id="radio_chk" ng-value="{{grid.renderContainers.body.visibleRowCache.indexOf(row)}}"  ng-model="releaseAction" /></div>',name:"radio_row",displayName:"",width:20}),angular.forEach(a,function(e,t){if(null==e.name){var r=e.columnList[0]["com.napier.core.service.vo.query.Column"],a=[];angular.forEach(r,function(e,t){a.push(e.data)});var i={patientId:a[0],patientName:a[1]+" "+a[2]+" "+a[3],mrNo:a[4],gender:a[6],dateofbirth:a[5],mno:a[7],age:a[10]};s.push(i)}})),""!=t&&null!=t&&0==r){6==o.columnDefs.length&&o.columnDefs.unshift({cellTemplate:'<div class="btn-group" ng-init="releaseAction=0"><input type="radio" name="radio_chk" id="radio_chk" ng-value="{{grid.renderContainers.body.visibleRowCache.indexOf(row)}}"  ng-model="releaseAction" /></div>',name:"radio_row",displayName:"",width:20});var c={patientId:a[0].data,patientName:a[1].data+" "+a[2].data+" "+a[3].data,mrNo:a[4].data,gender:a[6].data,dateofbirth:a[5].data,mno:a[7].data,age:a[10].data};s.push(c)}if(null==t&&0==r){7==o.columnDefs.length&&o.columnDefs.shift();c={patientName:"No Records Found"};s.push(c)}n.resolve(s)}),n.promise},this.loadGBDepositeGrid=function(r){var i=e.defer(),o={"@class":"com.napier.core.service.vo.deposits.DepositsVo",accSeqId:r},s={};return s.url=t.HISCOMBOFILLING.URL,s.requestData={operation:"getDepositsByAccountId",messageId:"",destination:"com.napier.core.deposits.service.external.DepositsService",message:o},a.sendRestRequest(s).then(function(e){var t=[];if(null==e.data.HITService.message||null==e.data.HITService.message.deposits||null==e.data.HITService.message.deposits[0]["com.napier.core.service.vo.deposits.DepositsVo"])i.resolve(t);else{var r=e.data.HITService.message.deposits[0]["com.napier.core.service.vo.deposits.DepositsVo"];r=r instanceof Array?r:[r],angular.forEach(r,function(e,r){var a={accSeqId:e.accSeqId,refSeqId:e.depositNo,depositSeqId:e.depositSeqId,deptranDate:null!=e.deptranDate.$?moment(e.deptranDate.$).format("DD/MM/YYYY"):"",depositAmount:e.depositAmount,appliedAmount:void 0!==e.adjustamtTotal?parseFloat(e.adjustamtTotal).toFixed(2):0,availableDefAmount:void 0!==e.availableAmount?parseFloat(e.availableAmount).toFixed(2):0,availableAmount:void 0!==e.availableAmount?parseFloat(e.availableAmount).toFixed(2):0,adjustamtTotal:void 0!==e.adjustamtTotal?parseFloat(e.adjustamtTotal).toFixed(2):0,depositTypeCode:e.depositTypeCode,depositTypeDesc:e.depositTypeDesc,deprefSeqId:e.refSeqId,depositNo:e.depositNo,gnTranStatus:e.gnTranStatus,isDeposit:!0};t.push(a),a={}}),i.resolve(t)}}),i.promise},this.loadGBDepositeGridBillCancelRefund=function(r){var i=e.defer(),o={"@class":"com.napier.core.service.vo.deposits.DepositsVo",accSeqId:r},s={};return s.url=t.HISCOMBOFILLING.URL,s.requestData={operation:"getCreditNoteDetails",messageId:"",destination:"com.napier.core.deposits.service.external.DepositsService",message:o},a.sendRestRequest(s).then(function(e){var t=[];if(null==e.data.HITService.message||null==e.data.HITService.message[0]||null==e.data.HITService.message[0]["com.napier.core.service.vo.deposits.DepositsVo"])i.resolve(t);else{var r=e.data.HITService.message[0]["com.napier.core.service.vo.deposits.DepositsVo"];r=r instanceof Array?r:[r],angular.forEach(r,function(e,r){var a={accSeqId:e.accSeqId,refSeqId:e.depositNo,depositSeqId:e.depositSeqId,deptranDate:null!=e.deptranDate.$?moment(e.deptranDate.$).format("DD/MM/YYYY"):"",depositAmount:e.depositAmount,appliedAmount:void 0!==e.adjustamtTotal?e.adjustamtTotal:0,availableDefAmount:void 0!==e.availableAmount?parseFloat(e.availableAmount).toFixed(2):0,availableAmount:e.availableAmount,adjustamtTotal:e.adjustamtTotal,depositTypeCode:e.depositTypeCode,collectionReqseqId:e.collectionReqseqId,isDeposit:!1};t.push(a),a={}}),i.resolve(t)}}),i.promise},this.loadPaymentReciepts=function(r){var i=e.defer(),o={"@class":"com.napier.core.collections.vo.ReceiptHeader",colReqSeqId:r},s={};return s.url=t.HISDEPOSITSERVICEEDIT.URL,s.requestData={operation:"getReceptDetails",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:o},a.sendRestRequest(s).then(function(e){var t=e.data.HITService.message.receiptDetailsList[0]["com.napier.core.collections.vo.ReceiptDetails"];i.resolve(t)}),i.promise},this.loadRefundReciepts=function(r){var i=e.defer(),o={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"OP_REFUND_LIST",idxList:[{"com.napier.core.service.vo.query.Index":[{ident:1,value:r}]}]}]}]},s={};return s.url=t.HISCOMBOFILLING.URL,s.requestData={operation:"ExecuteQuery",destination:"QueryService",message:o},a.sendRestRequest(s).then(function(e){var t=e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"].columnList[0]["com.napier.core.service.vo.query.Column"];i.resolve(t)}),i.promise},this.saveDepositeData=function(t,i,o){var s=e.defer(),n=[],c=0,l=t[0].Receivedfrom;angular.forEach(t,function(e,t){var r;""!=e.chequeDDDate&&e.chequeDDDate&&(r=moment(e.chequeDDDate).format("YYYY-MM-DD")+"T"+moment(e.chequeDDDate).format("HH:mm:ss.SSS")+"Z");var a={"@class":"com.napier.core.collections.vo.ReceiptDetails",amount:e.amtPaid,gnTranStatus:1,payMode:e.PayModeCode,cardBank:null!=e.bank?e.bank:void 0,cardNo:null!=e.cardNumber?e.cardNumber:void 0,cardTranNo:null!=e.cardTranId?e.cardTranId:void 0,chequeDDNo:null!=e.chequeDDno?e.chequeDDno:void 0,chequeqDDDate:r,bankAccSeqId:null!=e.chequeDDno?e.chequeDDno:void 0,chequeType:null!=e.chequeType?e.chequeType:void 0,ecsTranType:null!=e.paymentTranType?e.paymentTranType:void 0,cardExpiryDate:e.cardExpiryDate,cardType:e.cardType};n.push(a),c=parseFloat(c)+parseFloat(e.amtPaid)});var p={"@class":"com.napier.core.collections.vo.ReceiptHeader",counterCode:"2",gnTranStatus:1,receiptAmount:c,receiptDetailsList:[{"com.napier.core.collections.vo.ReceiptDetails":n}],depositVo:[{"com.napier.core.service.vo.deposits.DepositsVo":[]}],bill:[{"com.napier.core.billgeneration.vo.Bill":[]}],depositListVo:{"@class":"com.napier.core.service.vo.deposits.DepositsVo",accSeqId:i,subAccSeqId:o,depositAmount:c,depositTypeCode:644950312,gnTranStatus:1,gnDepositStatus:7,depositAgainst:3,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID},receiptTranType:1,receivedFrom:l,recpSingleOrMultiple:t.length,remarks:"",requestAmount:c,scrollAdmin:166,shiftCode:"",totalAmt:c},d={};return d.url=r.GBDEPOSITSAVE.URL,d.requestData={operation:"generateDeposit",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:p},a.sendRestRequest(d).then(function(e){if(""==e.data.HITService.message||null==e.data.HITService.message.depositListVo)return s.reject("Save Falied");s.resolve(e.data.HITService.message.depositListVo)}),s.promise},this.savePaymentData=function(t,i,o,s,n,c){var l=e.defer(),p=[],d=0,m=0,u="";null!=t&&t.length>0&&(u=t[0].Receivedfrom,angular.forEach(t,function(e,t){var r;""!=e.chequeDDDate&&e.chequeDDDate&&(r=moment(e.chequeDDDate).format("YYYY-MM-DD")+"T"+moment(e.chequeDDDate).format("HH:mm:ss.SSS")+"Z"),e.roundOff&&0!=parseFloat(e.roundOff)&&(m=parseFloat(m)+parseFloat(e.roundOff),e.amtPaid=parseFloat(e.amtPaid)-parseFloat(e.roundOff));var a={"@class":"com.napier.core.collections.vo.ReceiptDetails",amount:e.amtPaid,gnTranStatus:1,payMode:e.PayModeCode,cardBank:null!=e.bank?e.bank:void 0,cardNo:null!=e.cardNumber?e.cardNumber:void 0,cardTranNo:null!=e.cardTranId?e.cardTranId:void 0,chequeDDNo:null!=e.chequeDDno?e.chequeDDno:void 0,chequeqDDDate:r,bankAccSeqId:null!=e.bank?e.bank:void 0,chequeType:null!=e.chequeType?e.chequeType:void 0,payMobileNo:null!=e.mobileNumber?e.mobileNumber:void 0,ecsTranType:null!=e.paymentTranType?e.paymentTranType:void 0,cardExpiryDate:e.cardExpiryDate,cardType:e.cardType,roundOffAmt:null!=e.roundOff?e.roundOff:0};p.push(a),d=parseFloat(d)+parseFloat(e.amtPaid)}));var v=[],S=[],y=0;null!=n&&n.length>0&&angular.forEach(n,function(e,t){if(e.appliedAmount>0)if(33!=e.depositTypeCode){y=parseFloat(y)+parseFloat(e.appliedAmount);var r={"@class":"com.napier.core.service.vo.deposits.DepositsVo",depositSeqId:e.depositSeqId,adjustAmount:e.appliedAmount,billSeqId:c};v.push(r)}else{r={"@class":"com.napier.core.billgeneration.vo.CreditNoteAdjustVo",creditNoteHdSeqId:e.depositSeqId,crNoteAdjAmt:e.appliedAmount,billSeqId:c};S.push(r)}});var D={"@class":"com.napier.core.collections.vo.ReceiptHeader",colReqSeqId:o,counterCode:"2",gnTranStatus:1,receiptAmount:d,billSeqId:c,depAdjAmt:y,receiptDetailsList:[{"com.napier.core.collections.vo.ReceiptDetails":p}],depositVo:[{"com.napier.core.service.vo.deposits.DepositsVo":v}],creditNoteAdjList:[{"com.napier.core.billgeneration.vo.CreditNoteAdjustVo":S}],receiptTranType:1,receivedFrom:u,recpSingleOrMultiple:t.length,remarks:"",requestAmount:s,scrollAdmin:166,shiftCode:"",isOPVisitBill:!0,totalAmt:d},g={};return g.url=r.GBDEPOSITSAVE.URL,g.requestData={operation:"savePaymentRefund",messageId:"savePaymentRefund",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:D},a.sendRestRequest(g).then(function(e){if(""==e.data.HITService.message||null==e.data.HITService.message[0]["com.napier.core.collections.vo.ReceiptHeader"])return l.reject("Save Falied");l.resolve(e.data.HITService.message[0]["com.napier.core.collections.vo.ReceiptHeader"])}),l.promise},this.loadGBPaymentGridData=function(t,i){var o=e.defer();if(null!=t.BILL_NO&&"Unbilled"!=t.BILL_NO)var s=t.BILL_NO;var n={"@class":"com.napier.core.collections.vo.ReceiptHeader",subAccSeqId:t.SUB_ACC_SEQ_ID,enSeqId:i,billNo:s,billStatus:"Unbilled"==t.BILL_NO?0:t.BILL_STATUS},c={};return c.url=r.GBDEPOSITSAVE.URL,c.requestData={operation:"getGridDetails",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:n},a.sendRestRequest(c).then(function(e){if(null==e.data.HITService.message||null==e.data.HITService.message[0]||null==e.data.HITService.message[0]["com.napier.core.collections.vo.ReceiptHeader"])return o.reject("No Data");var t=e.data.HITService.message[0]["com.napier.core.collections.vo.ReceiptHeader"];t=t instanceof Array?t:[t];var r=[];Array.isArray(t)&&angular.forEach(t,function(t,a){var i=null!=t.servName?t.servName:"",o=null!=t.servCode?t.servCode:"",s=null!=t.spDate.$?moment(t.spDate.$).format("DD/MM/YYYY"):"",n=null!=t.billStatus?t.billStatus:"",c=null!=t.baseRate?t.baseRate:"",l=null!=t.qty?t.qty:0,p=null!=t.taxAmount?t.taxAmount:0,d=null!=t.discountAmt?t.discountAmt:0,m=null!=t.payerAmt?t.payerAmt:0,u=null!=t.patientAmt?t.patientAmt:0,v=null!=t.paidAmt?t.paidAmt:0,S=null!=t.dueAmt?t.dueAmt:0,y=null!=t.depAdjAmt?t.depAdjAmt:0,D=0,g=0,A=null!=t.primaryServiceDescription?t.primaryServiceDescription:"",I=null!=t.patientPaidAmnt?t.patientPaidAmnt:0,P=null!=t.payerPaidAmnt?t.payerPaidAmnt:0,h=null!=t.crNoteAmount?t.crNoteAmount:0;if(y>0&&v>0&&v>=y&&(v=parseFloat(v)-parseFloat(y)),t.colReqSeqIds&&t.payerType){var R=angular.copy(t.colReqSeqIds),f=angular.copy(t.payerType);if(angular.isString(R)&&R.indexOf(","))var T=R.split(","),C=(angular.isString(f)&&f.split(","),T[0]),b=T[1];else if(4==f)C=R;else b=R}""!=c&&l>0&&(D=parseFloat(c)*parseFloat(l),g=parseFloat(c)*parseFloat(l),""!=d&&(D-=parseFloat(d)),D=parseFloat(D)+parseFloat(p));var E={ItemName:i,ItemCode:o,ItemDate:s,billStatus:n,baseRate:c,quantity:l,total:D,baseRateTotal:g,taxAmount:p,defdiscountAmt:d,discountAmt:d,payerAmt:m,PatAmt:u,PaidAmt:v,dueAmt:S,depAdjAmt:y,servicePostingSeqId:t.spSeqId,accSeqId:t.accSeqId,subAccSeqId:t.subAccSeqId,renderType:null!=t.renderType?t.renderType:"",spDate:t.spDate.$,patColSeqId:null!=C?C:void 0,payerColSeqId:null!=b?b:void 0,depositSeqId:null!=t.depositSeqId?t.depositSeqId:void 0,visitNo:null!=t.visitNo?t.visitNo:void 0,accPayerSeqId:null!=t.accPayerSeqId?t.accPayerSeqId:void 0,billSeqId:null!=t.billSeqId?t.billSeqId:void 0,refundFlag:null!=e.data.HITService.context.contextList[0]["com.napier.core.context.ContextElement"][11]?e.data.HITService.context.contextList[0]["com.napier.core.context.ContextElement"][11]:void 0,payerType:null!=t.payerType?t.payerType:"",isComingFromOPPharmacy:t.isComingFromOPPharmacy,primaryServiceDescription:A,servSeqId:t.servSeqId,refTranSeqID:t.refTranSeqID?t.refTranSeqID:void 0,copayAmt:t.copayAmt,detableAmount:t.detableAmount,patientPaidAmnt:I,payerPaidAmnt:P,gnTranStatus:null!=t.gnTranStatus?t.gnTranStatus:1,aliasName:null!=t.aliasName?t.aliasName:"",aliasCode:null!=t.aliasCode?t.aliasCode:"",crNoteAmount:h,payerName:null!=t.payerName?t.payerName:"",planSeqId:null!=t.planSeqId?t.planSeqId:"",concessionAmt:null!=t.concessionAmt?t.concessionAmt:0,payerCompPlanseqId:t.payerCompPlanseqId?t.payerCompPlanseqId:void 0,isPostBillApplicable:null!=t.isPostBillApplicable?t.isPostBillApplicable:0};t.partialStatusCode&&(E.partialStatusCode=t.partialStatusCode),t.partialStatusDescription&&(E.partialStatusDescription=t.partialStatusDescription),t.partialDueAmount&&(E.partialDueAmount=t.partialDueAmount),t.partialRequestSeqId&&(E.partialRequestSeqId=t.partialRequestSeqId),r.push(E),E={}}),o.resolve(r)}),o.promise},this.loadBillNumbers=function(r,i){var o=e.defer(),s={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"OP_BILLED_LIST",idxList:[{"com.napier.core.service.vo.query.Index":[{ident:1,value:r},{ident:2,value:i}]}]}]}]},n={};return n.url=t.HISCOMBOFILLING.URL,n.requestData={operation:"ExecuteQuery",messageId:"",destination:"QueryService",message:s},a.sendRestRequest(n).then(function(e){if(null==e.data.HITService.message||null==e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList||null==e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"])return o.reject("No Data");var t=e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"],r=[];if(Array.isArray(t))angular.forEach(t,function(e,t){var a=e.columnList[0]["com.napier.core.service.vo.query.Column"],i={};angular.forEach(a,function(e,t){var r=e.name;1==r.includes(".",0)&&(i[e.name.substring(r.indexOf(".")+1)]=e.data)}),r.push(i)});else{var a=t.columnList[0]["com.napier.core.service.vo.query.Column"],i={};angular.forEach(a,function(e,t){var r=e.name;1==r.includes(".",0)&&(i[e.name.substring(r.indexOf(".")+1)]=e.data)}),r.push(i)}o.resolve(r)}),o.promise},this.getServiceConcessionDetails=function(t,i,s,n){var c=e.defer();if(null==t||null==i||null==s)return c.reject("No Details");var l={"@class":"com.napier.core.collections.vo.ReceiptHeader",conSeqId:t,subAccSeqId:i,billSeqId:s,spSeqIdList:n},p={};return p.url=r.GBCONCESSIONDETAILS.URL,p.requestData={operation:"getServConcessions",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:l},a.sendRestRequest(p).then(function(e){if(null==e.data.HITService.message||null==e.data.HITService.message[0]||null==e.data.HITService.message[0]["com.napier.core.collections.vo.ReceiptHeader"])return c.reject("No Data");var t=e.data.HITService.message[0]["com.napier.core.collections.vo.ReceiptHeader"];t=t instanceof Array?t:[t];var r=[];angular.forEach(t,function(e,t){var a=e,i=null!=e.baseRate?e.baseRate:"",s=null!=e.patientAmt?e.patientAmt:0,n=null!=e.spQty?e.spQty:"",c=(null!=e.taxPercent&&e.taxPercent,null!=e.discountAmt&&e.discountAmt,null!=e.taxAmount&&e.taxAmount,0);""!=i&&""!=n&&""!=s&&(c=parseFloat(s)),a.total=c,a.concReqPer=0,a.concReqAmt=0,c>0&&(2==e.gnAmtType?(a.concReqPer=function(e,t){if(t>=e)var r=100;else var r=t/e*100;return r.toFixed(2)}(c,e.conAmount),a.concReqAmt=o(c,e.concReqPer),a.concReqAmt>e.conAmount&&(a.concReqPer=parseFloat(a.concReqPer)-.01,a.concReqAmt=o(c,e.concReqPer)),a.concReqAmt<e.conAmount&&(a.concReqAmt=e.conAmount)):1==e.gnAmtType&&(a.concReqPer=e.conAmount,a.concReqAmt=o(c,e.conAmount))),a.concLimitAmt=a.concReqAmt,a.concLimitPer=a.concReqPer,r.push(a),a={}}),c.resolve(r)}),c.promise},this.generateBillForUnbilled=function(t,i,o,s,n,c,l,p){var d=e.defer(),m=[],u=s.Due_Amt,v=s.Concession_Amt,S=(s.Total_Bill,s.Deposite_Adj),y=[],D=0,g=0,A="",I=0;null!=n&&n.length>0&&(I=n.length,A=n[0].Receivedfrom,angular.forEach(n,function(e,t){var r;""!=e.chequeDDDate&&e.chequeDDDate&&(r=moment(e.chequeDDDate).format("YYYY-MM-DD")+"T"+moment(e.chequeDDDate).format("HH:mm:ss.SSS")+"Z"),e.roundOff&&0!=parseFloat(e.roundOff)&&(g=parseFloat(g)+parseFloat(e.roundOff),e.amtPaid=parseFloat(e.amtPaid)-parseFloat(e.roundOff));var a={"@class":"com.napier.core.collections.vo.ReceiptDetails",amount:e.amtPaid,gnTranStatus:1,payMode:e.PayModeCode,cardBank:null!=e.bank?e.bank:void 0,cardNo:null!=e.cardNumber?e.cardNumber:void 0,cardTranNo:null!=e.cardTranId?e.cardTranId:void 0,chequeDDNo:null!=e.chequeDDno?e.chequeDDno:void 0,chequeqDDDate:r,bankAccSeqId:null!=e.bank?e.bank:void 0,chequeType:null!=e.chequeType?e.chequeType:void 0,ecsTranType:null!=e.paymentTranType?e.paymentTranType:void 0,cardExpiryDate:e.cardExpiryDate,cardType:e.cardType,roundOffAmt:null!=e.roundOff?e.roundOff:0};y.push(a),D=parseFloat(D)+parseFloat(e.amtPaid)}));var P=[],h=[],R=0;null!=c&&c.length>0&&angular.forEach(c,function(e,t){if(e.appliedAmount>0)if(R=parseFloat(R)+parseFloat(e.appliedAmount),u=parseFloat(u)+parseFloat(e.appliedAmount),33!=e.depositTypeCode){var r={"@class":"com.napier.core.billgeneration.vo.BillDepositDetails",depositSeqId:e.depositSeqId,depAdjAmount:e.appliedAmount,gnStatus:1,availableAmount:e.depositAmount};P.push(r)}else{r={"@class":"com.napier.core.billgeneration.vo.CreditNoteAdjustVo",creditNoteHdSeqId:e.depositSeqId,crNoteAdjAmt:e.appliedAmount};h.push(r)}});var f=[];null!=l&&l.length>0&&angular.forEach(l,function(e,t){if(null!=e.cType){var r=[];if(e.serviceConcList&&e.serviceConcList.length>0){for(var a=e.serviceConcList,i=0;i<a.length;i++)if(a[i].concReqPer>0||a[i].concReqAmt>0){var o={"@class":"com.napier.core.service.vo.corebillingconcession.ConcessionRequestDetails",amountType:a[i].gnAmtType,concessionStatus:1,reqConession:1==a[i].gnAmtType?a[i].concReqPer:a[i].concReqAmt,tranStatus:1,servicePostSeqID:a[i].spSeqId,servSeqId:a[i].servSeqId};r.push(o),o={}}}else if(e.billReqPer>0||e.billReqConcAmt>0){o={"@class":"com.napier.core.service.vo.corebillingconcession.ConcessionRequestDetails",amountType:e.billConcType,concessionStatus:1,reqConession:1==e.billConcType?e.billReqPer:e.billReqConcAmt,tranStatus:1};r.push(o),o={}}var s={"@class":"com.napier.core.service.vo.corebillingconcession.ConcessionRequest",concessionSeqId:e.cType,reasonForConcession:e.remarks,concessionType:e.billService,concessionStatus:1,concessionRequestDetailsList:[{"com.napier.core.service.vo.corebillingconcession.ConcessionRequestDetails":r}],remarks:e.remarks,tranStatus:1,concessionReqDate:moment().format("YYYY-MM-DD")+"T"+moment().format("HH:mm:ss.SSS")+"Z"};f.push(s),r={}}});var T=[],C=[],b=[],E=0,q=0,O=0,L=0,V=0,N=0,_=0,w=0,M=0,F=!1,B=[];angular.forEach(t,function(e,t){4==e.payerType?(O=parseFloat(O)+parseFloat(e.PatAmt),L=parseFloat(L)+parseFloat(e.taxAmount),N=parseFloat(N)+parseFloat(e.discountAmt),C.push({"@class":"com.napier.core.billgeneration.vo.BillDetails",servicePostSeqId:e.servicePostingSeqId,spDate:e.spDate,isPostBillApplicable:e.isPostBillApplicable?e.isPostBillApplicable:0})):(E=parseFloat(E)+parseFloat(e.payerAmt)+parseFloat(e.PatAmt),q=parseFloat(q)+parseFloat(e.PatAmt),V=parseFloat(V)+parseFloat(e.taxAmount),_=parseFloat(_)+parseFloat(e.discountAmt),T.push({"@class":"com.napier.core.billgeneration.vo.BillDetails",servicePostSeqId:e.servicePostingSeqId,spDate:e.spDate,isPostBillApplicable:e.isPostBillApplicable?e.isPostBillApplicable:0})),B.push({serviceSeqId:e.servSeqId,refTranSeqID:e.refTranSeqID})});var x=O;v>0&&(x=parseFloat(x)-parseFloat(v)),parseFloat(S)<=parseFloat(x)?(w=S,M=0):(w=x,M=parseFloat(S)-parseFloat(x)),0==w&&M>0&&(F=!0);for(var G=function(e){for(var t=e.concat(),r=0;r<t.length;r++){if(angular.isString(t[r].payerType)&&t[r].payerType.indexOf(","))var a=t[r].payerType.split(",")[1];else a=t[r].payerType;for(var i=0,o=r+1;o<t.length;o++){if(angular.isString(t[o].payerType)&&t[o].payerType.indexOf(","))var s=t[o].payerType.split(",")[1];else s=t[o].payerType;a==s&&(i+=o,t.splice(o--,1))}t[r].total=i}return t}(t),U=0;U<G.length;U++){m=[];var Q,k,H,j,Y=0,W=0,$=0;if(D&&D>0&&(D>parseFloat(O)-parseFloat(w)?(W=parseFloat(O)-parseFloat(w),$=parseFloat(D)-parseFloat(W)):W=D),4==G[U].payerType){Y=O;var z=3,J=W;Q=C,k=L,H=N,j=w,m.push({"@class":"com.napier.core.billgeneration.vo.BillPayerDetails",accPayerSeqId:i,payerAmount:parseFloat(Y),blPayerAdjAmt:parseFloat(Y),payerType:G[U].payerType,payStatus:2,gnStatus:1})}else{Y=E;z=2,J=$;if(Q=T,angular.isString(G[U].payerType)&&G[U].payerType.indexOf(","))var Z=G[U].payerType.split(",")[1];else Z=G[U].payerType;k=V,H=_,j=M,0==q&&U==G.length-1&&(parseFloat(s.deductibleAmount)>0||parseFloat(s.coPay)>0)&&(q=parseFloat(q)+parseFloat(s.deductibleAmount)+parseFloat(s.coPay)),m.push({"@class":"com.napier.core.billgeneration.vo.BillPayerDetails",accPayerSeqId:null==G[U].accPayerSeqId?i:G[U].accPayerSeqId,payerAmount:parseFloat(Y)-parseFloat(q),blPayerAdjAmt:parseFloat(Y)-parseFloat(q),payerType:Z,payStatus:2,gnStatus:1}),q>0&&m.push({"@class":"com.napier.core.billgeneration.vo.BillPayerDetails",accPayerSeqId:i,payerAmount:parseFloat(q),blPayerAdjAmt:parseFloat(q),payerType:4,payStatus:2,gnStatus:1})}var K={"@class":"com.napier.core.billgeneration.vo.Bill",billDate:moment().format("YYYY-MM-DD")+"T"+moment().format("HH:mm:ss.SSS")+"Z",billStatus:{"@class":"com.napier.core.service.vo.masters.GeneralMaster",code:1},taxAmount:k,consStatus:z,consessionAmt:3==z?v:0,billAmount:Y,discountAmount:H,adjAmount:j,settledAmt:J,billPayStatus:2,billType:2,isCashAllowed:2,tobePaidAmount:Y,accSeqId:i,subAccSeqId:o,deductableAmt:parseFloat(s.deductibleAmount),copayAmt:s.coPay?parseFloat(s.coPay):0,roundOfAmt:g,billDetailsList:[{"com.napier.core.billgeneration.vo.BillDetails":Q}],highValueBillsDiscountVoList:[{"com.napier.core.billgeneration.vo.HighValueBillsDiscountVo":B}],billPayerDtList:[{"com.napier.core.billgeneration.vo.BillPayerDetails":m}],billDepositDetailsList:[{"com.napier.core.billgeneration.vo.BillDepositDetails":3==z||F?P:void 0}],isPrimaryBill:!1,isBillClearedCheck:!0,isDoctorResponsible:!1};4==K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][0].payerType?(K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][0].payerAmount=parseFloat(Y),K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][0].blPayerAdjAmt=parseFloat(Y),K.deductableAmt=0,K.copayAmt=0):null!=K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][1]&&4==K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][1].payerType&&(K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][1].payerAmount=parseFloat(K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][1].payerAmount)+parseFloat(s.deductibleAmount),K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][0].payerAmount=parseFloat(K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][0].payerAmount)-parseFloat(s.deductibleAmount),K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][1].blPayerAdjAmt=parseFloat(K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][1].payerAmount),K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][0].blPayerAdjAmt=parseFloat(K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][0].payerAmount),K.billAmount=Y,K.deductableAmt=s.deductibleAmount,K.copayAmt=s.coPay),b.push(K)}var X={"@class":"com.napier.core.collections.vo.ReceiptHeader",gnTranStatus:1,receiptAmount:D,counterCode:"2",concessionRequest:[{"com.napier.core.service.vo.corebillingconcession.ConcessionRequest":f}],receiptDetailsList:[{"com.napier.core.collections.vo.ReceiptDetails":y}],depositVo:[{"com.napier.core.service.vo.deposits.DepositsVo":[]}],creditNoteAdjustVo:[{"com.napier.core.billgeneration.vo.CreditNoteAdjustVo":h}],bill:[{"com.napier.core.billgeneration.vo.Bill":b}],receiptTranType:1,receivedFrom:A,recpSingleOrMultiple:I,remarks:"payment",requestAmount:parseFloat(u),scrollAdmin:JSON.parse(sessionStorage.userContextObj).USER_SEQ_ID,shiftCode:"",totalAmt:D};p&&(X.partialRequestSeqId=p);var ee={};return ee.url=r.GBBILLGENERATION.URL,ee.requestData={operation:"generateBill",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:X},a.sendRestRequest(ee).then(function(e){if(""==e.data.HITService.message||null==e.data.HITService.message.bill||null==e.data.HITService.message.bill[0]["com.napier.core.billgeneration.vo.Bill"])return d.reject("Save Falied");d.resolve(e)}),d.promise},this.generatePaymentReport=function(t,i,o,s){var n=e.defer();if(null!=s&&"OPCS"==s)var c="OutPatient_CashBillGeneratedReports_ReportId";else if(null!=s&&"OPCR"==s)c="OutPatient_CreditBillGeneratedReports_ReportId";else c="OutPatientPaymentReceiptGenerationReport";"HSC"===sessionStorage.productCustomization&&(c="HSC_PATIENT_PAYMENT_RECEIPT_GENERATION_REPORT");var l={"@class":"com.napier.report.vo.ReportRequest",reportId:c,filterParams:[{"com.napier.report.model.ReportIndex":[{ident:"pBillSeqId",value:t},{ident:"pReceptSeqId",value:i},{ident:"pReceptDtSeqId",value:o}]}],reportType:{id:4,desc:"PDF"}},p={};return p.url=r.GBPAYMENTREPORTGENERATION.URL,p.requestData={operation:"processReport",messageId:"",destination:"reportingServiceImpl",message:l},a.sendRestRequest(p).then(function(e){if(null==e.data.HITService.message||null==e.data.HITService.message.reportName)return n.reject("Print Failed");n.resolve(e)}),n.promise},this.generateBillReport=function(t,i,o,s){var n,c=e.defer();switch(s){case 1:n="OutPatient_CashBillGeneratedReports_ReportId";break;case 2:n="OutPatient_CreditBillGeneratedReports_ReportId";break;default:n="OutPatientConsultationBillReport"}var l={"@class":"com.napier.report.vo.ReportRequest",reportId:n,filterParams:[{"com.napier.report.model.ReportIndex":[{ident:"pBillSeqId",value:t},{ident:"pReceptSeqId",value:i},{ident:"pReceptDtSeqId",value:o}]}],reportType:{id:4,desc:"PDF"}},p={};return p.url=r.GBBILLREPORTGENERATION.URL,p.requestData={operation:"processReport",messageId:"",destination:"reportingServiceImpl",message:l},a.sendRestRequest(p).then(function(e){c.resolve(e)}),c.promise},this.cancelBillData=function(t){var i=[],o=[],s=0;angular.forEach(t,function(e,t){7!=e.gnTranStatus&&(i.push({servicePostSeqId:e.servicePostingSeqId,isPostBillApplicable:e.isPostBillApplicable}),e.total&&e.total>0&&(s=parseFloat(s)+parseFloat(e.total)),o.push({serviceSequenceId:e.servSeqId}))});var n=e.defer(),c={"@class":"com.napier.core.billgeneration.vo.BillCanceHdlDetails",billCancDtList:[{"com.napier.core.billgeneration.vo.BillCancelDtDetails":i}],servSeqIds:[{"com.napier.core.billgeneration.vo.ServiceIdentityVO":o}],billSeqId:t[0].billSeqId,cancelBy:JSON.parse(sessionStorage.userContextObj).USER_SEQ_ID,cancelbillDate:moment().format("YYYY-MM-DD")+"T"+moment().format("HH:mm:ss.SSS")+"Z",cancelNo:"",cancelReasonCode:101,cancelReason:"Cancelled",approvedAmt:s,gnTranStatus:"1",lastUpdatedOn:moment().format("YYYY-MM-DD")+"T"+moment().format("HH:mm:ss.SSS")+"Z",cancelBill:!1,insurancePlanSeqId:0,isOPVisitBill:!0,isCsOrCR:4!=t[0].payerType,subAccSeqId:t[0].subAccSeqId,cancelStatus:{code:"4"}},l={};return l.url=r.GBBILLREPORTGENERATION.URL,l.requestData={operation:"updateBillGenerationNew",messageId:"",destination:"com.napier.core.billgeneration.service.external.BillGenerationService",message:c},a.sendRestRequest(l).then(function(e){if(null==e.data.HITService.message)return n.reject("No Data");n.resolve(e.data.HITService)}),n.promise},this.loadAppliedConc=function(t){var i=e.defer(),o={"@class":"com.napier.core.collections.vo.ReceiptHeader",billSeqId:t.BILL_SEQ_ID},s={};return s.url=r.GBBILLREPORTGENERATION.URL,s.requestData={operation:"getConcessionsServices",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:o},a.sendRestRequest(s).then(function(e){if(null==e.data.HITService.message||null==e.data.HITService.message.concessionRequest[0]["com.napier.core.service.vo.corebillingconcession.ConcessionRequest"])return i.reject("No Data");var t=e.data.HITService.message.concessionRequest[0]["com.napier.core.service.vo.corebillingconcession.ConcessionRequest"];t=t instanceof Array?t:[t];var r=[];angular.forEach(t,function(e,t){var a=e;a.cTypeDesc=e.concessionName,a.cType=e.concessionSeqId,a.billReqAmt=e.reqConcessionAmount,r.push(a),a={}}),i.resolve(r)}),i.promise},this.ViewBillConcesDetails=function(t){var i=e.defer(),o={"@class":"com.napier.core.service.vo.corebillingconcession.ConcessionRequest",concessionReqSeqId:t},s={};return s.url=r.GBBILLREPORTGENERATION.URL,s.requestData={operation:"viewConcessionRequest",messageId:"",destination:"com.napier.core.corebillingconcession.service.external.CoreBillingConcessionService",message:o},a.sendRestRequest(s).then(function(e){if(null==e.data.HITService.message||null==e.data.HITService.message.concessionRequestDetailsList)return i.reject("No Data");var t=e.data.HITService.message;i.resolve(t)}),i.promise},this.removeConcesData=function(t,i){var o=e.defer(),s={"@class":"com.napier.core.collections.vo.ReceiptHeader",concessionRequest:[{"com.napier.core.service.vo.corebillingconcession.ConcessionRequest":[{"@class":"com.napier.core.service.vo.corebillingconcession.ConcessionRequest",concessionReqSeqId:t,concessionType:i}]}]},n={};return n.url=r.GBBILLREPORTGENERATION.URL,n.requestData={operation:"cancleConcessions",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:s},a.sendRestRequest(n).then(function(e){if(null==e.data.HITService.message||""==e.data.HITService.message)return o.reject("No Data");o.resolve(e.data.HITService.message)}),o.promise},this.saveBillConcession=function(t,i){var o=e.defer(),s=[];null!=t&&t.length>0&&angular.forEach(t,function(e,t){if(null!=e.cType){var r=[];if(e.serviceConcList&&e.serviceConcList.length>0){for(var a=e.serviceConcList,o=0;o<a.length;o++)if(a[o].concReqPer>0||a[o].concReqAmt>0){var n={"@class":"com.napier.core.service.vo.corebillingconcession.ConcessionRequestDetails",amountType:a[o].gnAmtType,concessionStatus:1,reqConession:1==a[o].gnAmtType?a[o].concReqPer:a[o].concReqAmt,tranStatus:1,servicePostSeqID:a[o].spSeqId,servSeqId:a[o].servSeqId};r.push(n),n={}}}else if(e.billReqPer>0||e.billReqConcAmt>0){n={"@class":"com.napier.core.service.vo.corebillingconcession.ConcessionRequestDetails",amountType:e.billConcType,concessionStatus:1,reqConession:1==e.billConcType?e.billReqPer:e.billReqConcAmt,tranStatus:1};r.push(n),n={}}var c={"@class":"com.napier.core.service.vo.corebillingconcession.ConcessionRequest",billSeqId:i,concessionSeqId:e.cType,reasonForConcession:e.remarks,concessionType:e.billService,concessionStatus:1,concessionRequestDetailsList:[{"com.napier.core.service.vo.corebillingconcession.ConcessionRequestDetails":r}],remarks:e.remarks,tranStatus:1,concessionReqDate:moment().format("YYYY-MM-DD")+"T"+moment().format("HH:mm:ss.SSS")+"Z"};s.push(c),r={}}});var n={"@class":"com.napier.core.collections.vo.ReceiptHeader",concessionRequest:[{"com.napier.core.service.vo.corebillingconcession.ConcessionRequest":s}]},c={};return c.url=r.GBBILLREPORTGENERATION.URL,c.requestData={operation:"generateConcession",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:n},a.sendRestRequest(c).then(function(e){if(null==e.data.HITService.message||""==e.data.HITService.message)return o.reject("No Data");o.resolve(e.data.HITService.message)}),o.promise},this.depositBillAdjustment=function(t,i){var o=e.defer(),s=[],n=[];null!=t&&t.length>0&&angular.forEach(t,function(e,t){if(e.appliedAmount>0)if(33!=e.depositTypeCode){var r={"@class":"com.napier.core.billgeneration.vo.BillDepositDetails",depositSeqId:e.depositSeqId,depAdjAmount:e.appliedAmount,gnStatus:1,availableAmount:e.depositAmount};s.push(r)}else{r={"@class":"com.napier.core.billgeneration.vo.CreditNoteAdjustVo",creditNoteHdSeqId:e.depositSeqId,crNoteAdjAmt:e.appliedAmount,billSeqId:i.BILL_SEQ_ID};n.push(r)}});var c={"@class":"com.napier.core.collections.vo.ReceiptHeader",bill:[{"com.napier.core.billgeneration.vo.Bill":[{"@class":"com.napier.core.billgeneration.vo.Bill",billSeqId:i.BILL_SEQ_ID,billDepositDetailsList:[{"com.napier.core.billgeneration.vo.BillDepositDetails":s}]}]}],creditNoteAdjustVo:[{"com.napier.core.billgeneration.vo.CreditNoteAdjustVo":n}]},l={};return l.url=r.GBBILLDEPOSITADJUST.URL,l.requestData={operation:"ceateDeposit",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:c},a.sendRestRequest(l).then(function(e){if(null==e.data.HITService.message||""==e.data.HITService.message)return o.reject("No Data");o.resolve(e.data.HITService.message)}),o.promise},this.transTypeCombSearch=function(r){var o,s=e.defer();o={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:r,idxList:[{"com.napier.core.service.vo.query.Index":[{paramName:"pMasterSqId",value:"1610"}]}]}]}]};var n={};return n.url=t.HISCOMBOFILLING.URL,n.requestData={operation:"ExecuteQuery",destination:"QueryService",message:o},a.sendRestRequest(n).then(function(e){var t=[],r=i(e);angular.forEach(r,function(e,r){var a=e.columnList[0]["com.napier.core.service.vo.query.Column"],i={CODE:a[0].data,DESCRIPTION:a[1].data};t.push(i)}),s.resolve(t)}),s.promise},this.getDACharges=function(t,i,o){var s=e.defer(),n=o.visitTypeCode,c={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:t.accSeqId,subAccSeqId:t.subAccSeqId,servicePostingType:2,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:t.servSeqId},quantity:o.quantity,priority:n,serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:t.servSeqId,rcvSeqId:t.rcvSeqId,inflSeqId:t.inflSeqId,tariffSeqId:i,datedOn:moment(new Date).format("YYYY-MM-DD HH:mm:ss.000")},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},patientCategoryCode:"2  ",transType:1,facilityId:t.facilityId,practiceId:t.practiceId,gnFlow:t.gnFlow,surcharge:0,serviceRate:t.serviceRate,actualRate:t.actualRate,doctorAmount:t.doctorAmount,proposedShareAfterDiscount:t.proposedShareAfterDiscount,standardDoctorShare:t.standardDoctorShare,doctorModifiedAmount:110,discountAmt:t.discountAmt,bedClassCode:1,chargeableAmt:t.baseRate,isRateEditable:t.isRateEditable,isServiceRateEditable:t.isRateEditable,isEmergency:2,previousQty:t.quantity,renderedByEmployee:{"@class":"com.napier.core.service.vo.masters.Employee",empSeqId:t.requestedByEmpSeqID},renderedByEmpSeqID:t.requestedByEmpSeqID,renderedByEmpType:t.requestedByEmpType},l={};return l.url=r.GBBILLREPORTGENERATION.URL,l.requestData={operation:"recalculateServiceRateForStandard",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:c},a.sendRestRequest(l).then(function(e){if(null==e.data.HITService.message)return s.reject("No Data");var r=e.data.HITService.message;r.orderObj=t,r.tarrifSeq=i,r.detailObj=o,s.resolve(r)}),s.promise},this.getDAChargesByType=function(t,i){var o=e.defer(),s="",n="";1==t.tranType?(s="recalculateServiceRateForStandard",n=1):3==t.tranType?(s="recalculateServiceRateForNocharge",n=3):2==t.tranType&&(s="recalculateServiceRateForNegotiable",n=2);var c=t.detailObj.visitTypeCode,l={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:t.orderObject.accSeqId,subAccSeqId:t.orderObject.subAccSeqId,servicePostingType:2,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:t.orderObject.servSeqId},quantity:t.detailObj.quantity,priority:c,serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:t.orderObject.servSeqId,rcvSeqId:t.orderObject.rcvSeqId,inflSeqId:t.orderObject.inflSeqId,tariffSeqId:t.tariffId,datedOn:moment(new Date).format("YYYY-MM-DD HH:mm:ss.000")},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},patientCategoryCode:"2  ",transType:n,facilityId:t.orderObject.facilityId,practiceId:t.orderObject.practiceId,gnFlow:t.orderObject.gnFlow,surcharge:t.orderObject.surcharge,serviceRate:t.orderObject.originalBaseRate,actualRate:t.orderObject.actualRate,doctorAmount:3==n?0:t.orderObject.doctorAmount,proposedShareAfterDiscount:3==n?0:t.orderObject.proposedShareAfterDiscount,standardDoctorShare:3==n?0:parseFloat(0!=t.docAmount)?t.docAmount:t.orderObject.standardDoctorShare,doctorModifiedAmount:2==t.tranType?0!=t.modAmount&&"0.00"!=t.modAmount?t.modAmount:t.docAmount:0,discountAmt:t.orderObject.discountAmt,bedClassCode:1,chargeableAmt:t.orderObject.baseRate,isRateEditable:t.orderObject.isRateEditable,isServiceRateEditable:t.orderObject.isRateEditable,isEmergency:2,previousQty:t.orderObject.quantity,renderedByEmployee:{"@class":"com.napier.core.service.vo.masters.Employee",empSeqId:t.orderObject.requestedByEmpSeqID},renderedByEmpSeqID:t.orderObject.requestedByEmpSeqID,renderedByEmpType:t.orderObject.requestedByEmpType},p={};return p.url=r.GBBILLREPORTGENERATION.URL,p.requestData={operation:s,messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:l},a.sendRestRequest(p).then(function(e){if(null==e.data.HITService.message)return o.reject("No Data");var t=e.data.HITService.message;o.resolve(t)}),o.promise},this.checkVisitClosedorNot=function(r){var o,s=e.defer();o={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"GET_OP_VISITS_EN_ACTION_STATUS_NEW_001",idxList:[{"com.napier.core.service.vo.query.Index":[{paramName:"pEnseqId",value:r}]}]}]}]};var n={};return n.url=t.HISCOMBOFILLING.URL,n.requestData={operation:"ExecuteQuery",destination:"QueryService",message:o},a.sendRestRequest(n).then(function(e){var t=i(e);s.resolve(t)}),s.promise},this.updateServiceAliasCodes=function(r){var i=e.defer(),o={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",servicePostingSeqId:r.servicePostingSeqId,philHealthCode:r.ItemCodeNew.PAYER_ALIAS_CODE,philHealthName:r.ItemCodeNew.PAYER_ALIAS_NAME},s={};return s.url=t.HISCOMBOFILLING.URL,s.requestData={operation:"updatePhilHealthCode",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:o},a.sendRestRequest(s).then(function(e){i.resolve(e)}),i.promise},this.refundCreditNote=function(r,i){var o=e.defer(),s=angular.fromJson(sessionStorage.userContextObj),n="";r.roundOff&&0!=parseFloat(r.roundOff)?r.amtPaid=parseFloat(r.amtPaid)-parseFloat(r.roundOff):r.roundOff=0;var c,l=[];""!=r.chequeDDDate&&r.chequeDDDate&&(c=moment(r.chequeDDDate).format("YYYY-MM-DD")+"T"+moment(r.chequeDDDate).format("HH:mm:ss.SSS")+"Z");var p={"@class":"com.napier.core.collections.vo.ReceiptDetails",amount:r.amtPaid,gnTranStatus:1,payMode:r.PayModeCode,cardBank:null!=r.bank?r.bank:void 0,cardNo:null!=r.cardNumber?r.cardNumber:void 0,cardTranNo:null!=r.cardTranId?r.cardTranId:void 0,chequeDDNo:null!=r.chequeDDno?r.chequeDDno:void 0,chequeqDDDate:c,bankAccSeqId:null!=r.chequeDDno?r.chequeDDno:void 0,chequeType:null!=r.chequeType?r.chequeType:void 0,ecsTranType:null!=r.paymentTranType?r.paymentTranType:void 0,cardExpiryDate:r.cardExpiryDate,cardType:r.cardType};l.push(p),n=i.isDeposit?{"@class":"com.napier.core.collections.vo.ReceiptHeader",roundOffAmt:r.roundOff,receivedFrom:r.receivedfrom,receiptDetailsList:[{"com.napier.core.collections.vo.ReceiptDetails":l}],depositVo:[{"com.napier.core.service.vo.deposits.DepositsVo":[{depositSeqId:i.depositSeqId,accSeqId:i.accSeqId,depositAmount:i.depositAmount,depositNo:i.depositNo,depositTypeCode:i.depositTypeCode,depositTypeDesc:i.depositTypeDesc,gnTranStatus:i.gnTranStatus,subAccSeqId:i.subAccSeqId,availableAmount:i.availableAmount,refSeqId:i.deprefSeqId,isBillDepositAdj:!1,totalDepositAmount:0,depositRefundList:[{"com.napier.core.service.vo.deposits.DepositRefundVo":[{depRefundAmount:r.amtPaid}]}]}]}]}:{"@class":"com.napier.core.collections.vo.ReceiptHeader",colReqSeqId:i.collectionReqseqId,counterCode:"2",gnTranStatus:1,receiptAmount:r.amtPaid,receiptDetailsList:[{"com.napier.core.collections.vo.ReceiptDetails":l}],depositVo:[{"com.napier.core.service.vo.deposits.DepositsVo":[]}],receiptTranType:r.TRAN_REQ_TYPE,receivedFrom:r.receivedfrom,recpSingleOrMultiple:0,remarks:"",requestAmount:r.amtPaid,scrollAdmin:s.USER_SEQ_ID,shiftCode:"3001",totalAmt:r.amtPaid};var d={};return d.url=t.HISDEPOSITSERVICEEDIT.URL,d.requestData={operation:"refundDepositOrCreditnote",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:n},a.sendRestRequest(d).then(function(e){if(null==e.data.HITService.message||e.data.HITService.message.errorCode)return o.reject("Refund Falied");o.resolve(e.data.HITService.message)}),o.promise},this.postRoomChargesforEmgPat=function(t){var i=e.defer(),o={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",subAccSeqId:t},s={};return s.url=r.GBBILLREPORTGENERATION.URL,s.requestData={operation:"emergencyRoomChargesPosting",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:o},a.sendRestRequest(s).then(function(e){i.resolve(e)}),i.promise}}e.$inject=["$q","BILLING_APIS","OPVISIT_MGMT_APIS","CallManager"],angular.module("napierContainerUi").service("opVisitMgtService",e)}(),function(){"use strict";function e(e,t,r,a,i,o,s,n,c,l){var p=this;p.numOffiles=0,p.deleteFiles=[],p.patAdmFiles=[],p.totalFileSize=0,p.ppao={payAuthTotalAmount:r.payAuthTotalAmount,payAuthPatientAmount:r.payAuthPatientAmount,payAuthPayingAmount:r.payAuthPayingAmount,payAuthDueAmount:r.payAuthDueAmount},c.loadModule("opVisitManagement");var d=l.getLanguageToSet();c.changeLanguage(d),p.ip=r.ip?r.ip:void 0,p.PayAuthPayingAmountFunc=function(e){if("payAmount"==e)if(isNaN(parseFloat(p.ppao.payAuthPayingAmount)))p.ppao.payAuthPayingAmount="",p.ppao.payAuthDueAmount="";else if(parseFloat(p.ppao.payAuthPayingAmount)<=parseFloat(p.ppao.payAuthPatientAmount)){var t=parseFloat(p.ppao.payAuthPatientAmount)-parseFloat(p.ppao.payAuthPayingAmount);p.ppao.payAuthDueAmount=t.toFixed(2)}else p.ppao.payAuthPayingAmount="",p.ppao.payAuthDueAmount="";if("dueAmount"==e)if(isNaN(parseFloat(p.ppao.payAuthDueAmount)))p.ppao.payAuthPayingAmount="",p.ppao.payAuthDueAmount="";else if(parseFloat(p.ppao.payAuthDueAmount)<=parseFloat(p.ppao.payAuthPatientAmount)){var r=parseFloat(p.ppao.payAuthPatientAmount)-parseFloat(p.ppao.payAuthDueAmount);p.ppao.payAuthPayingAmount=r.toFixed(2)}else p.ppao.payAuthPayingAmount="",p.ppao.payAuthDueAmount=""},p.dynamicPopoverForUploadFile={templateUrl:"myPopoverTemplateInOpVisit.html"},p.open=function(e){t.open("UPLOAD FILES",{animation:!0,templateUrl:"app/consumer/his17_2/ADT/screens/patientAdmission/sections/upload.files.modal.html",size:e,controller:"uploadFileController",controllerAs:"upfileCtrl",backdrop:"static",resolve:{addedFiles:function(){return p.patAdmFiles},totalFileSize:function(){return p.totalFileSize},regSeqId:function(){return r.orderregSeqId}}}).result.then(function(e){p.numOffiles=p.numOffiles+e.noffiles,angular.forEach(e.files,function(e){p.patAdmFiles.push(e)}),p.totalFileSize=e.filsTotalSize,angular.forEach(e.seqIds,function(e){p.deleteFiles.push(e)})},function(){})},p.viewPayAuthUploadedFile=function(e){p.adtAdmPatPopOverCls=!1;o.viewUploadedFileFun(e).then(function(e){if(!angular.isUndefined(e.data.HITService.message.napierDocumentList[0]["com.napier.core.service.vo.uploadfile.NapierDocument"])){var t=e.data.HITService.message.napierDocumentList[0]["com.napier.core.service.vo.uploadfile.NapierDocument"].uploadDocumnt[0],r=e.data.HITService.message.napierDocumentList[0]["com.napier.core.service.vo.uploadfile.NapierDocument"].docExtension,a=t.replace("dataimage/jpegbase64","").replace("dataapplication/pdfbase64","").replace("dataapplication/vndopenxmlformatsofficedocumentwordprocessingmldocumentbase6\n4","").replace("dataimage/pngbase64","").replace("\n",""),i=r.toLowerCase();if("pdf"==i||"jpg"==i||"png"==i||"gif"==i||"jpeg"==i||"tif"==i||"tiff"==i||"bmp"==i)m(a,i);else if("xls"==i){var o="data:application/vnd.ms-excel,"+a;window.open(o,"_self")}else if("xlsx"==i){var s="data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"+";base64,"+a;window.open(s,"_self")}else{if("docx"==i||"doc"==i)u("data:application/octet-stream;base64,"+a,"download.docx")}}})};var m=function(e,r){t.open("",{animation:!0,templateUrl:"app/consumer/his17_2/ADT/screens/patientAdmission/sections/upload.image.view.modal.html",size:"lg",controller:"viewUploadsCtrl",controllerAs:"viewCtrl",resolve:{imgUrl:function(){return e},extF:function(){return r}}})},u=function(e,t){var r=document.createElement("a");r.download=t,r.href=e,r.click()};p.deletePayAuthFile=function(e,t){var r=JSON.parse(sessionStorage.getItem("userContextObj")),i=_.findIndex(t,function(t){return t.name==e.name});_.findIndex(p.patAdmFiles,function(t){t.name==e.name&&p.patAdmFiles.splice(i,1)}),o.deleteFileORRetriveFileFun("removeDocumentList",t[i],r).then(function(t){angular.isUndefined(t.data.HITService.message.napierDocumentList[0]["com.napier.core.service.vo.uploadfile.NapierDocument"])||a.success("Success",e.name+" file deleted successfully ")}),p.deleteFiles.splice(i,1),p.numOffiles=p.numOffiles-1},p.PayAuthBillSubmit=function(){if(!p.ppao.payAuthPayingAmount)return a.warning("Warning!","Please Enter Partial Paying Amount"),!1;var e=[];if(p.patAdmFiles.length>0)for(var t=0;t<p.patAdmFiles.length;t++){var o=p.patAdmFiles[t].name.split("."),c={documentName:o[0],documentExtension:o[1],modifiedBy:angular.fromJson(sessionStorage.userContextObj).USER_SEQ_ID,createdBy:angular.fromJson(sessionStorage.userContextObj).USER_SEQ_ID,uploadDocument:p.patAdmFiles[t].size};e.push(c)}var l={"@class":"com.napier.core.service.vo.visitmanagement.PartialPaymentAuthorizationVO",requestStatus:1,requestedBy:angular.fromJson(sessionStorage.userContextObj).USER_SEQ_ID,requestType:7,status:1,requestRemarks:p.ppao.payAuthRemarks?p.ppao.payAuthRemarks:"",totalOrderedAmount:parseFloat(p.ppao.payAuthTotalAmount),patientAmount:parseFloat(p.ppao.payAuthPatientAmount),patientPayingAmount:parseFloat(p.ppao.payAuthPayingAmount),patientDueAmount:parseFloat(p.ppao.payAuthDueAmount),patientType:p.ip?17:1,billNo:"Unbilled"!=r.billNo?r.billNo:void 0,visit:{visitNo:r.ordervisitId?r.ordervisitId:void 0},encounter:{enSeqId:r.orderencounterSeqId},registration:{rgSeqId:r.orderregSeqId},authorizationReqDocumentVOs:[{"com.napier.core.service.vo.visitmanagement.PartialPaymentAuthorizationReqDocumentVO":e}]},d={};d.url=s.updateService.URL,d.requestData={operation:"authorizationRequest",messageId:"",destination:"com.napier.core.visitmanagement.service.external.PartialPaymentAuthorizationService",message:l},n.sendRestRequest(d).then(function(e){e.data.HITService.message.partialPaymentSeqId?(i.close(r.billNo),a.success("SUCCESS","Partial Pay Request Submitted Successfully")):a.failure("FAILED"," Save Failed")},function(e){a.failure("Failed","Save Failed")})}}e.$inject=["$scope","hisModalService","data","hisAlertService","$uibModalInstance","uploadFileService","OPVISIT_MGMT_APIS","CallManager","hisTranslationsService","hisTranslationsGlobalLang"],angular.module("napierContainerUi").controller("opVisitPartialPayAuthCtrlNew",e)}(),function(){"use strict";angular.module("napierContainerUi").constant("advancedSearchGridDefinitionNew",{enableCellEditOnFocus:!0,enableRowSelection:!0,enableFullRowSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableSorting:!1,enableHorizontalScrollbar:1,columnDefs:[{name:"radio_row",displayName:"",width:20,headerCellTemplate:"<div><div>",cellTemplate:'<div class="ngSelectionCell"><input ng-init="releaseAction=0" type="radio" name="rdUserList" ng-value="{{grid.renderContainers.body.visibleRowCache.indexOf(row)}}"  ng-model="releaseAction" ng-click="grid.appScope.advSearchRowClick(row)"></div>'},{name:"patientName",displayName:"opvm.PatientName",headerCellFilter:"translate"},{name:"mrNo",displayName:"opvm.MRNo",headerCellFilter:"translate"},{name:"age",displayName:"opvm.age",headerCellFilter:"translate"},{name:"gender",displayName:"opvm.Gender",headerCellFilter:"translate"},{name:"dateofbirth",displayName:"opvm.DateofBirth",headerCellFilter:"translate",type:"date",cellFilter:"date:'dd-MM-yyyy'"},{name:"mno",displayName:"opvm.MobileNo",headerCellFilter:"translate"}]})}(),function(){"use strict";angular.module("napierContainerUi").constant("generateBillGridNew",{enableCellEditOnFocus:!0,enableRowSelection:!0,enableFullRowSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,multiSelect:!0,enableFiltering:!1,enableSorting:!1,enableHorizontalScrollbar:1,columnDefs:[{name:"ItemCode",displayName:"Service Code",headerCellFilter:"translate",pinnedLeft:!0,width:120,cellTemplate:'<div ng-class="(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? \'canceledbill\' : \'\'"><span ng-if="row.entity.renderType == 2" class="sericeRendergrid"></span><span ng-if="row.entity.renderType == 1" class="notRendergrid"></span><span  ng-if="!row.entity.editService">{{row.entity.ItemCode}} </span><span  ng-if="row.entity.editService" style="margin:5px;"><select ng-model="row.entity.ItemCodeNew" ng-options="item as item.PAYER_ALIAS_CODE for item in row.entity.serviceCodesList" style="width: 55px;"></select></span><span class="pull-right" style="margin-right:5px" ng-if="row.entity.payerAmt > 0"><i class="fa fa-pencil" ng-if="!row.entity.editService && grid.appScope.permissionList.T_OP_VISIT_EPAC" ng-click="row.entity.editService=true;grid.appScope.loadServiceAliasCodes(row,rowRenderIndex)"></i> &nbsp; <i class="fa fa-check green" ng-if="row.entity.editService" ng-click="grid.appScope.updateServiceAliasCodes(row,rowRenderIndex)"></i> &nbsp; <i style="border:0px !important;" class="fa fa-ban red" ng-if="row.entity.editService"ng-click="row.entity.editService=false;"></i></span> &nbsp;<span><i class="fa fa-money" ng-if="!row.entity.isPostBillApplicable" style="color:#b5223d" title="Pre Bill On"></i></span></div>'},{name:"ItemName",displayName:"Service Name",headerCellFilter:"translate",pinnedLeft:!0,width:180,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.ItemName}}</div>"},{name:"payerName",displayName:"Payer",headerCellFilter:"translate",width:220,cellTemplate:"<div class=\"his-ellipsis\" title={{row.entity.payerName}} ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.payerName}}</div>"},{name:"baseRate",displayName:"opvm.generatebill_rate",headerCellFilter:"translate",width:80,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.baseRate.toFixed(2)}}</div>"},{name:"quantity",displayName:"opvm.generatebill_qty",headerCellFilter:"translate",width:60,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.quantity}}</div>"},{name:"baseRateTotal",displayName:"Total",headerCellFilter:"translate",width:80,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.baseRateTotal.toFixed(2)}}</div>"},{name:"discountAmt",displayName:"opvm.generatebill_discount",headerCellFilter:"translate",width:80,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.discountAmt.toFixed(2)}}</div>"},{name:"taxAmount",displayName:"opvm.generatebill_tax",headerCellFilter:"translate",width:80,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.taxAmount.toFixed(2)}}</div>"},{name:"total",displayName:"Net Total",headerCellFilter:"translate",width:80,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.total.toFixed(2)}}</div>"},{name:"payerAmt",displayName:"opvm.generatebill_payeramount",headerCellFilter:"translate",width:80,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.payerAmt.toFixed(2)}}</div>"},{name:"PatAmt",displayName:"opvm.generatebill_patamount",headerCellFilter:"translate",width:80,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.PatAmt.toFixed(2)}}</div>"},{name:"ItemDate",displayName:"opvm.generatebill_date",headerCellFilter:"translate",type:"date",cellFilter:"date:'dd-MM-yyyy'",width:80,cellTemplate:"<div ng-class=\"(row.entity.billStatus == 7 || row.entity.gnTranStatus  == 7)? 'canceledbill' : ''\">{{row.entity.ItemDate}}</div>"}]}).constant("generateBillConcessionGridNew",{enableSorting:!1,enableCellEditOnFocus:!1,enableFiltering:!1,enableFullRowSelection:!1,columnDefs:[{displayName:"Service Name",headerCellFilter:"translate",name:"servName",enableSorting:!0,enableCellEdit:!1,pinnedLeft:!1,width:150},{displayName:"Conc. Per.",headerCellFilter:"translate",name:"concReqPer",enableSorting:!0,enableCellEdit:!1,width:102,cellTemplate:'<div><input class="form-control" style="margin-top:0px" ng-disabled="grid.appScope.concessionViewMode" ng-model="row.entity.concReqPer" ng-blur="grid.appScope.concServComp(row.entity,1)" limit-with-lowercase="10" ng-pattern="/^[0-9.]+$/"/></div>'},{displayName:"Conc. Amt.",headerCellFilter:"translate",name:"concReqAmt",enableSorting:!0,enableCellEdit:!1,width:102,cellTemplate:'<div><input class="form-control" style="margin-top:0px"  ng-disabled="grid.appScope.concessionViewMode" ng-model="row.entity.concReqAmt" ng-blur="grid.appScope.concServComp(row.entity,2)" limit-with-lowercase="10" ng-pattern="/^[0-9.]+$/"/></div>'}]}).constant("generateBillDepositGridNew",{enableSorting:!1,enableCellEditOnFocus:!1,enableFiltering:!1,enableFullRowSelection:!1,columnDefs:[{displayName:"opvm.generateDate",headerCellFilter:"translate",name:"deptranDate",enableSorting:!0,enableCellEdit:!1,pinnedLeft:!1,width:100},{displayName:"opvm.generateref_no",headerCellFilter:"translate",name:"refSeqId",enableSorting:!0,enableCellEdit:!1,width:100},{displayName:"opvm.generateDepAmount",headerCellFilter:"translate",name:"depositAmount",enableSorting:!0,enableCellEdit:!1,width:70},{displayName:"opvm.generateAppliedAmt",headerCellFilter:"translate",name:"appliedAmount",enableSorting:!0,enableCellEdit:!1,width:70,visible:!1},{displayName:"opvm.generateBalance",headerCellFilter:"translate",name:"availableDefAmount",enableSorting:!0,enableCellEdit:!1,width:70}]}).constant("generateBillRefundGridNew",{enableSorting:!1,enableCellEditOnFocus:!1,enableFiltering:!1,enableFullRowSelection:!1,columnDefs:[{displayName:"Date",headerCellFilter:"translate",name:"date",cellFilter:"date:'dd-MM-yyyy'",width:80},{displayName:"opvm.generatePayMode",headerCellFilter:"translate",name:"PayMode",width:80},{displayName:"opvm.generateAmtPaid",headerCellFilter:"translate",name:"amtPaid",width:90},{displayName:"opvm.generateref_no",headerCellFilter:"translate",name:"refNo",width:90,visible:!1},{displayName:"opvm.paidTo",headerCellFilter:"translate",name:"receivedfrom",width:100},{displayName:"opvm.generateaction",headerCellFilter:"translate",name:"action",width:60,cellTemplate:'<i class="fa fa-trash" ng-click="grid.appScope.removeFromRefundGrid(row,rowRenderIndex)"></i>'}]}).constant("generateBillPaymentGridNew",{enableSorting:!1,enableCellEditOnFocus:!1,enableFiltering:!1,enableFullRowSelection:!1,columnDefs:[{displayName:"opvm.generatePayMode",headerCellFilter:"translate",name:"PayMode",width:80},{displayName:"opvm.generateAmtPaid",headerCellFilter:"translate",name:"amtPaid",width:80},{displayName:"opvm.generateref_no",headerCellFilter:"translate",name:"refNo",width:90},{displayName:"opvm.generateReceivedFrom",headerCellFilter:"translate",name:"Receivedfrom",width:100},{displayName:"opvm.generateaction",headerCellFilter:"translate",name:"action",width:60,cellTemplate:'<i class="fa fa-trash" ng-click="grid.appScope.removeFromPaymentGrid(row,rowRenderIndex)"></i>'}]}).constant("generateBillConcesReqGridNew",{enableSorting:!1,enableCellEditOnFocus:!1,enableFiltering:!1,enableFullRowSelection:!1,columnDefs:[{displayName:"Concession",headerCellFilter:"translate",name:"cTypeDesc",enableSorting:!0,enableCellEdit:!1,pinnedLeft:!1,width:150},{displayName:"Conc. Per.",headerCellFilter:"translate",name:"billReqPer",enableSorting:!0,enableCellEdit:!1,width:80},{displayName:"Conc. Amt.",headerCellFilter:"translate",name:"billReqAmt",enableSorting:!0,enableCellEdit:!1,width:80,cellTemplate:'<div style="padding:5px;">{{(row.entity.dTotalServAmt)? row.entity.dTotalServAmt : row.entity.billReqAmt}}</div>'},{displayName:"Action",headerCellFilter:"translate",name:"actions",enableSorting:!0,enableCellEdit:!1,width:70,cellTemplate:'<div style="padding:5px;"><i class="fa fa-trash" ng-if="!row.entity.concessionSeqId" ng-click="grid.appScope.removeFromConcGrid(row,rowRenderIndex)"></i> <i ng-if="row.entity.concessionSeqId" class="fa fa-eye" title="View" ng-click="grid.appScope.ViewBillConcesDetails(row)"></i> &nbsp; &nbsp; &nbsp;<i ng-if="row.entity.concessionSeqId" class="fa fa-trash" title="Delete Concession" ng-click="grid.appScope.removeConcesData(row)"></i></div>'}]})}(),function(){"use strict";function e(e,t,r,a){this.getOrderDetails=function(t,i,o,s,n,c,l,p,d,m){var u=e.defer(),v={"@class":"com.napier.core.service.vo.visitmanagement.VisitConfigurationDetails",doctorSeqId:t,tariffSeqId:s,regSeqId:i,enSeqId:o||void 0,payerId:c,quantity:l,specialityCode:p||void 0,serviceSeqId:d&&!m?d:void 0,servicePostingSeqId:m||void 0},S={};return S.url=r.updateService.URL,S.requestData={operation:"getServiceRateByDoctorSpecialitywise",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:v},a.sendRestRequest(S).then(function(e){var t=e.data.HITService.message.servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"],r=!1;t.multiEmployeeShareList&&t.multiEmployeeShareList.employeeShareList&&(r=!0);var a={accSeqId:t.accSeqId,actualRate:t.actualRate,discountAmt:t.discountAmt,doctorAmount:t.doctorAmount,doctorShare:t.doctorShare,doctorSurcharge:t.doctorSurcharge,facilityId:t.facilityId,gnFlow:t.gnFlow,hospitalShare:t.hospitalShare,hospitalSurcharge:t.hospitalSurcharge,isDeleteBill:t.isDeleteBill,isDepositRequired:t.isDepositRequired,isEmergencyAllowedCheck:t.isEmergencyAllowedCheck,isMLCFlag:t.isMLCFlag,isRateEditable:t.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,fromTariffRate:t.visitConfigOrRateCard,newRate:t.newRate,patientAmount:t.patientAmount,payerAmount:t.payerAmount,originalPatientAmount:null==t.companyPayingAmt?t.newRate:parseFloat(t.companyPayingAmt)>t.newRate?parseFloat(0):null!=t.actualRate&&parseFloat(t.companyPayingAmt)>=t.actualRate?parseFloat(0):parseFloat((t.newRate-parseFloat(t.companyPayingAmt)).toFixed(2)),originalPayerAmount:null==t.companyPayingAmt?parseFloat(0):parseFloat(t.companyPayingAmt)>t.newRate?t.newRate:null!=t.actualRate&&parseFloat(t.companyPayingAmt)>=t.actualRate?t.newRate:parseFloat(t.companyPayingAmt),practiceId:t.practiceId,proposedShareAfterDiscount:t.proposedShareAfterDiscount,requestedByEmpName:t.requestedByEmpName,requestedByEmpSeqID:t.requestedByEmpSeqID,requestedByEmpType:t.requestedByEmpType,servicePostingType:t.servicePostingType,quantity:t.quantity,isPostBillApplicable:t.isPostBillApplicable?t.isPostBillApplicable:0,serviceRate:t.serviceRate,serviceRateStatus:t.serviceRateStatus,serviceType:t.serviceType,serviceTypeCode:t.primaryServiceCode,standardDoctorShare:t.standardDoctorShare,subAccSeqId:t.subAccSeqId,technicianAmount:t.technicianAmount,transType:t.transType,servCode:t.serviceVo.servCode,servDesign:t.serviceVo.servDesign,servName:t.serviceVo.servName,servSeqId:t.serviceVo.servSeqId,visistType:t.serviceRateVo.visistType,baseRate:t.serviceRateVo.baseRate,gnServDesign:1,servicePayerAuthorization:t.servicePayerAuthorization,payerCompSeqId:t.payerCompSeqId,payerCompPlanseqId:t.payerCompPlanseqId,rcvSeqId:t.serviceRateVo.rcvSeqId,inflSeqId:t.serviceRateVo.inflSeqId,specSeqId:t.serviceRateVo.specSeqId?t.serviceRateVo.specSeqId:void 0,proposedShare:r?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare:0,billedShare:r?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare:0,grpMstCode:r?t.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,originalBaseRate:t.serviceRateVo.originalBaseRate?t.serviceRateVo.originalBaseRate:t.serviceRateVo.baseRate};u.resolve(a)}),u.promise},this.getAppoinmentConsDetails=function(t,i,o,s,n){for(var c=e.defer(),l=[],p=[],d=new Date,m=moment(d).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z",u=0;u<t.length;u++){if(1==t[u].appointmentType){var v={doctorSeqId:t[u].doctorId,tariffSeqId:s,regSeqId:i,enSeqId:o||void 0,payerId:n,specialityCode:t[u].specalityId,opApmntSeqId:t[u].opApmntSeqId};l.push(v)}if(2==t[u].appointmentType){var S={bill:{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0},servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":[{accSeqId:sessionStorage.getItem("accountseqId"),subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0,opApmntSeqId:t[u].opApmntSeqId,servicePostingType:1,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:t[u].servSeqId,gnServDesign:1,servCode:t[u].servCode,servName:t[u].serviceName,secServTypeCode:t[u].priServTypCode,priServTypCode:t[u].secServTypeCode},serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:t[u].servSeqId,tariffSeqId:s,datedOn:m,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},transType:1,quantity:1,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnFlow:2,requestedByEmpType:4,requestedByEmpSeqID:t[u].doctorId,payerId:n,fromOPVisit:"Y",priority:1}]}]};p.push(S)}}var y={};return y.url=r.updateService.URL,y.requestData={operation:"getMultipleServiceRateByDoctorSpecialitywise",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:{"@class":"com.napier.core.service.vo.visitmanagement.AppointmentProcedureDetailsVo",visitConfigurationDetailsList:[{"com.napier.core.service.vo.visitmanagement.VisitConfigurationDetails":l}],servicePostingVoList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingVo":p}]}},a.sendRestRequest(y).then(function(e){try{var t=e.data.HITService.message[0]["com.napier.core.scm.serviceposting.vo.ServicePostingVo"];t=t instanceof Array?t:[t];for(var r=[],a=0;a<t.length;a++){var i,o=t[a].servicePostingDetailsList[0]["com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo"],s=!1;o.multiEmployeeShareList&&o.multiEmployeeShareList.employeeShareList&&(s=!0),o.priority?i="Routine":32==o.serviceRateVo.visistType?i="New":33==o.serviceRateVo.visistType?i="Free Follow Up":37==o.serviceRateVo.visistType&&(i="Follow Up");var n=[{accSeqId:o.accSeqId,actualRate:o.actualRate,discountAmt:o.discountAmt,doctorAmount:o.doctorAmount,doctorShare:o.doctorShare,doctorSurcharge:o.doctorSurcharge,facilityId:o.facilityId,gnFlow:o.gnFlow,hospitalShare:o.hospitalShare,hospitalSurcharge:o.hospitalSurcharge,isDeleteBill:o.isDeleteBill,isDepositRequired:o.isDepositRequired,isEmergencyAllowedCheck:o.isEmergencyAllowedCheck,isMLCFlag:o.isMLCFlag,isRateEditable:o.serviceVo.scmMasterServBillingAttrVo.faIsRateEditable,fromTariffRate:o.visitConfigOrRateCard,newRate:o.newRate,patientAmount:o.patientAmount,payerAmount:o.payerAmount,originalPatientAmount:o.originalPatientAmount,originalPayerAmount:o.originalPayerAmount,practiceId:o.practiceId,proposedShareAfterDiscount:o.proposedShareAfterDiscount,requestedByEmpName:o.requestedByEmpName,requestedByEmpSeqID:o.requestedByEmpSeqID,requestedByEmpType:o.requestedByEmpType,servicePostingType:o.servicePostingType,quantity:o.quantity,isPostBillApplicable:o.isPostBillApplicable?o.isPostBillApplicable:0,priority:o.priority?o.priority:0,serviceRate:o.serviceRate,serviceRateStatus:o.serviceRateStatus,serviceType:o.primaryService,serviceTypeCode:o.primaryServiceCode,standardDoctorShare:o.standardDoctorShare,subAccSeqId:o.subAccSeqId,technicianAmount:o.technicianAmount,transType:o.transType,servCode:o.serviceVo.servCode,servDesign:o.serviceVo.servDesign,servName:o.serviceVo.servName,servSeqId:o.serviceVo.servSeqId,visistType:i,baseRate:o.serviceRateVo.baseRate,gnServDesign:1,servicePayerAuthorization:o.servicePayerAuthorization,payerCompSeqId:o.payerCompSeqId,payerCompPlanseqId:o.payerCompPlanseqId,rcvSeqId:o.serviceRateVo.rcvSeqId,inflSeqId:o.serviceRateVo.inflSeqId,proposedShare:s?o.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].proposedShare:0,billedShare:s?o.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].billedShare:0,grpMstCode:s?o.multiEmployeeShareList.employeeShareList[0]["com.napier.core.scm.serviceposting.vo.EmployeeShareVo"].grpMstCode:void 0,opApmntSeqId:o.opApmntSeqId,appointReason:null!=o.appointReason?o.appointReason:void 0,billStatus:0,doctorModifiedAmount:0,rowIndex:a}];r.push(n)}c.resolve(r)}catch(e){return c.reject("")}}),c.promise}}e.$inject=["$q","BILLING_APIS","OPVISIT_MGMT_APIS","CallManager"],angular.module("napierContainerUi").service("opOrderServiceNew",e)}(),function(){"use strict";angular.module("napierContainerUi").service("OPPreAuthServicesNew",["CallManager","$filter","$http","IPINDENTAPIS","$rootScope","$q","hisAlertService","QueryService","OPVISIT_MGMT_APIS",function(e,t,r,a,i,o,s,n,c){this.opPreAuthClear=function(e){e.preAuth.preAuthDetailsGridOtions.data=[],e.preAuth.preAuthViewDetailsGridOtions.data=[],e.preAuth.clearRecordFirst(),e.prevAmt="",e.preAuth.initialAuthAmount="",e.preAuth.preAuthCopyServAmt="",e.preAuth.isBillOrServiceFlag="2",e.reqFromOrder=!1,e.OrderPayerName=void 0,e.OrderPlanName=void 0,e.payerCompPlanseqId=void 0,e.payerCompSeqId=void 0,e.preAuth.isCoPayAvl="3",e.preAuth.coPayVal="",e.preAuth.isDedctibleAvl="3",e.preAuth.deductbleValue="",e.preAuth.preAuthHeaderObj={},e.preAuth.preAuthHeaderObj.PREAUTH_BIL_DATE=new Date,e.preAuth.preAuthHeaderObj.APPREFNO="",e.planSeqIdForUpdate=void 0,e.preAuth.fromDate=void 0,e.preAuth.toDate=void 0,e.preAuth.filesUploaded=[],e.preAuth.uploadedfileNames=[],e.preAuth.uploadingFile=!1,e.updateFlag=!1,e.preAuth.planObj="",e.preAuthBillNav=!1,e.PA.PAPayer=void 0,null!=e.prevoisEditIndex&&null!=e.addPayerAuthrList&&null!=e.addPayerAuthrList[e.prevoisEditIndex]&&null!=e.addPayerAuthrList[e.prevoisEditIndex].$edit&&(e.addPayerAuthrList[e.prevoisEditIndex].$edit=!1)},this.preObjForPerAuthService=function(e,t){for(let r=1;r<e.preAuth.preAuthDetailsGridOtions.data.length;r++){if(!(null!=e.preAuth.preAuthDetailsGridOtions.data[r].approvedDetails&&""!=e.preAuth.preAuthDetailsGridOtions.data[r].approvedDetails||t))return!0;if(e.saveDetails.push({serviceCode:null!=e.preAuth.preAuthDetailsGridOtions.data[r].service?e.preAuth.preAuthDetailsGridOtions.data[r].service.SERV_CODE:void 0,serviceSeqId:null!=e.preAuth.preAuthDetailsGridOtions.data[r].service&&null!=e.preAuth.preAuthDetailsGridOtions.data[r].service.SERV_SEQ_ID?e.preAuth.preAuthDetailsGridOtions.data[r].service.SERV_SEQ_ID:void 0,serviceName:null!=e.preAuth.preAuthDetailsGridOtions.data[r].service?e.preAuth.preAuthDetailsGridOtions.data[r].service.SERV_NAME:void 0,serviceRate:void 0,serviceQty:null!=e.preAuth.preAuthDetailsGridOtions.data[r].qty&&""!=e.preAuth.preAuthDetailsGridOtions.data[r].qty?parseFloat(e.preAuth.preAuthDetailsGridOtions.data[r].qty):void 0,serviceTax:void 0,serviceDiscountAmt:void 0,chargeableAmt:null!=e.preAuth.preAuthDetailsGridOtions.data[r].valueAmt&&""!=e.preAuth.preAuthDetailsGridOtions.data[r].valueAmt&&3!=e.preAuth.preAuthDetailsGridOtions.data[r].isAmtNlPercFlag?parseFloat(e.preAuth.preAuthDetailsGridOtions.data[r].valueAmt):void 0,expcServDate:"9999-03-05 00:00:00.000",gnTranStatus:1,serviceType:null!=e.preAuth.preAuthDetailsGridOtions.data[r].service&&null!=e.preAuth.preAuthDetailsGridOtions.data[r].service.SERV_SEQ_ID?parseFloat(1):null!=e.preAuth.preAuthDetailsGridOtions.data[r].specialty&&null!=e.preAuth.preAuthDetailsGridOtions.data[r].specialty.CODE?parseFloat(2):null!=e.preAuth.preAuthDetailsGridOtions.data[r].department&&null!=e.preAuth.preAuthDetailsGridOtions.data[r].department.CODE?parseFloat(3):null!=e.preAuth.preAuthDetailsGridOtions.data[r].priServGroup&&null!=e.preAuth.preAuthDetailsGridOtions.data[r].priServGroup.CODE?parseFloat(4):void 0,isAmtPercNl:null!=e.preAuth.preAuthDetailsGridOtions.data[r].isAmtNlPercFlag&&""!=e.preAuth.preAuthDetailsGridOtions.data[r].isAmtNlPercFlag?parseFloat(e.preAuth.preAuthDetailsGridOtions.data[r].isAmtNlPercFlag):void 0,primaryServCode:null!=e.preAuth.preAuthDetailsGridOtions.data[r].priServGroup&&null!=e.preAuth.preAuthDetailsGridOtions.data[r].priServGroup.CODE?e.preAuth.preAuthDetailsGridOtions.data[r].priServGroup.CODE:void 0,deptCode:null!=e.preAuth.preAuthDetailsGridOtions.data[r].department&&null!=e.preAuth.preAuthDetailsGridOtions.data[r].department.CODE?e.preAuth.preAuthDetailsGridOtions.data[r].department.CODE:void 0,specilityCode:null!=e.preAuth.preAuthDetailsGridOtions.data[r].specialty&&null!=e.preAuth.preAuthDetailsGridOtions.data[r].specialty.CODE?e.preAuth.preAuthDetailsGridOtions.data[r].specialty.CODE:void 0,gnStatus:t?parseInt(2):null!=e.preAuth.preAuthDetailsGridOtions.data[r].GN_STATUS?e.preAuth.preAuthDetailsGridOtions.data[r].GN_STATUS:parseInt(1),remarks:e.preAuth.preAuthDetailsGridOtions.data[r].remarks,approvedAmount:null!=e.preAuth.preAuthDetailsGridOtions.data[r].approvedAmount&&""!=e.preAuth.preAuthDetailsGridOtions.data[r].approvedAmount?parseFloat(e.preAuth.preAuthDetailsGridOtions.data[r].approvedAmount):void 0,approvedDetails:e.preAuth.preAuthDetailsGridOtions.data[r].approvedDetails,approvedQty:null!=e.preAuth.preAuthDetailsGridOtions.data[r].approvedQty&&""!=e.preAuth.preAuthDetailsGridOtions.data[r].approvedQty?parseFloat(e.preAuth.preAuthDetailsGridOtions.data[r].approvedQty):void 0,approxBillDtSeqId:e.preAuth.preAuthDetailsGridOtions.data[r].approxBillDtSeqId}),r==e.preAuth.preAuthDetailsGridOtions.data.length-1)return!1}for(let t=0;t<e.deletePreAuthService.length;t++)e.saveDetails.push({serviceCode:null!=e.deletePreAuthService[t].service?e.deletePreAuthService[t].service.SERV_CODE:void 0,serviceSeqId:null!=e.deletePreAuthService[t].service&&null!=e.deletePreAuthService[t].service.SERV_SEQ_ID?e.deletePreAuthService[t].service.SERV_SEQ_ID:void 0,serviceName:null!=e.deletePreAuthService[t].service?e.deletePreAuthService[t].service.SERV_NAME:void 0,serviceRate:void 0,serviceQty:null!=e.deletePreAuthService[t].qty&&""!=e.deletePreAuthService[t].qty?parseFloat(e.deletePreAuthService[t].qty):void 0,serviceTax:void 0,serviceDiscountAmt:void 0,chargeableAmt:null!=e.deletePreAuthService[t].valueAmt&&""!=e.deletePreAuthService[t].valueAmt&&3!=e.deletePreAuthService[t].isAmtNlPercFlag?parseFloat(e.deletePreAuthService[t].valueAmt):void 0,expcServDate:"9999-03-05 00:00:00.000",gnTranStatus:2,serviceType:null!=e.deletePreAuthService[t].service&&null!=e.deletePreAuthService[t].service.SERV_SEQ_ID?parseFloat(1):null!=e.deletePreAuthService[t].specialty&&null!=e.deletePreAuthService[t].specialty.CODE?parseFloat(2):null!=e.deletePreAuthService[t].department&&null!=e.deletePreAuthService[t].department.CODE?parseFloat(3):null!=e.deletePreAuthService[t].priServGroup&&null!=e.deletePreAuthService[t].priServGroup.CODE?parseFloat(4):void 0,isAmtPercNl:null!=e.deletePreAuthService[t].isAmtNlPercFlag&&""!=e.deletePreAuthService[t].isAmtNlPercFlag?parseFloat(e.deletePreAuthService[t].isAmtNlPercFlag):void 0,primaryServCode:null!=e.deletePreAuthService[t].priServGroup&&null!=e.deletePreAuthService[t].priServGroup.CODE?e.deletePreAuthService[t].priServGroup.CODE:void 0,deptCode:null!=e.deletePreAuthService[t].department&&null!=e.deletePreAuthService[t].department.CODE?e.deletePreAuthService[t].department.CODE:void 0,specilityCode:null!=e.deletePreAuthService[t].specialty&&null!=e.deletePreAuthService[t].specialty.CODE?e.deletePreAuthService[t].specialty.CODE:void 0,gnStatus:null!=e.deletePreAuthService[t].GN_STATUS?e.deletePreAuthService[t].GN_STATUS:parseInt(2),remarks:e.deletePreAuthService[t].remarks,approvedAmount:null!=e.deletePreAuthService[t].approvedAmount&&""!=e.deletePreAuthService[t].approvedAmount?parseFloat(e.deletePreAuthService[t].approvedAmount):void 0,approvedDetails:e.deletePreAuthService[t].approvedDetails,approvedQty:null!=e.deletePreAuthService[t].approvedQty&&""!=e.deletePreAuthService[t].approvedQty?parseFloat(e.deletePreAuthService[t].approvedQty):void 0,approxBillDtSeqId:e.deletePreAuthService[t].approxBillDtSeqId})};var l=function(e,t,r){var a=parseFloat((e.issueData.originalPayerAmount/e.issueData.serviceRate*100).toFixed(2));e.issueData.originalPatientAmount>0&&e.issueData.originalPayerAmount>0?(t.originalPayerAmount=parseFloat((t.serviceRate*a/100).toFixed(2)),t.originalPatientAmount=parseFloat((t.serviceRate-t.originalPayerAmount).toFixed(2))):e.issueData.originalPayerAmount>0&&(t.originalPayerAmount=t.serviceRate,t.originalPatientAmount=0),1==r.IS_AMT_PERC_NL_CODE?(r.APPROVED_AMNT=r.APPROVED_AMNT+e.issueData.originalPayerAmount,r.CONSUMABLE_AMOUNT=r.CONSUMABLE_AMOUNT-e.issueData.originalPayerAmount):3==r.IS_AMT_PERC_NL_CODE&&(e.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(e.preAuthHdrRcdList.APPROVED_AMNT)+parseFloat(e.issueData.originalPayerAmount)),r.CONSUMABLE_QTY>0&&(r.APPROVED_QTY=e.preAuthRcdList[j].APPROVED_QTY+1,r.CONSUMABLE_QTY=e.preAuthRcdList[j].CONSUMABLE_QTY-1)};this.opPharmacyCalP=function(e,t,r){l(e,t,r)},this.opPreAuthGetData=function(e,t){e.preAuthData=[],e.preAuthDataListObj={1:e.preAuthData};var r=n.executeQueryURLReset();e.preAuthDataList=new Array,n.prepareParamList(1,null!=e.orderData.subAccSeqId?e.orderData.subAccSeqId:parseFloat(sessionStorage.getItem("subaccountseqId")),e.preAuthDataList),n.prepareParamList(2,e.payerTypeModel.PayerType.PINS_SEQ_ID,e.preAuthDataList),n.executeQueryInput("GET_PREAUTH_POSTING_SERVICE_DETAILS",e.preAuthDataList,e.preAuthDataListObj,!0,!0,r,"popUp",{}).then(function(r){for(let t=0;t<e.preAuthData.length;t++)if("N"==e.preAuthData[t].IS_PRE_AUTH_HEADER){for(let r=0;r<e.preAuthRcdList.length&&e.preAuthData[t].PREAUTH_BILL_HD_SEQ_ID!=e.preAuthRcdList[r].PREAUTH_BILL_HD_SEQ_ID;r++)r==e.preAuthRcdList.length-1&&e.preAuthRcdList.push(e.preAuthData[t]);0==e.preAuthRcdList.length&&e.preAuthRcdList.push(e.preAuthData[t])}else"Y"==e.preAuthData[t].IS_PRE_AUTH_HEADER&&(null!=e.preAuthHdrRcdList.PREAUTH_BILL_HD_SEQ_ID&&e.preAuthHdrRcdList.PREAUTH_BILL_HD_SEQ_ID.toString().indexOf(e.preAuthData[t].PREAUTH_BILL_HD_SEQ_ID)<0?(e.preAuthHdrRcdList.APPROVED_AMNT=e.preAuthHdrRcdList.APPROVED_AMNT+parseFloat(e.preAuthData[t].SERV_SEQ_ID),e.preAuthHdrRcdList.PREAUTH_BILL_HD_SEQ_ID=", "+e.preAuthData[t].PREAUTH_BILL_HD_SEQ_ID):null==e.preAuthHdrRcdList.PREAUTH_BILL_HD_SEQ_ID&&(e.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(e.preAuthData[t].SERV_SEQ_ID),e.preAuthHdrRcdList.PREAUTH_BILL_HD_SEQ_ID=e.preAuthData[t].PREAUTH_BILL_HD_SEQ_ID.toString()),1==e.preAuthData[t].RW&&(e.preAuthHdrRcdList.IS_BILL_OR_SERVE_LEVEL=e.preAuthData[t].IS_BILL_OR_SERVE_LEVEL,e.preAuthHdrRcdList.RW=e.preAuthData[t].RW,e.preAuthHdrRcdList.HEAD_AMT=parseFloat(e.preAuthData[t].SERV_SEQ_ID),e.preAuthHdrRcdList.TYPE=e.preAuthData[t].TYPE));if(null!=t&&t.length>0)for(let r=0;r<t.length;r++)if(null!=t[r][0]&&"Self"!=t[r][0].payerType)if(t[r][0].isComingFromOPPharmacy&&"Pharmacy Retruns"==t[r][0].isPharmacyService){for(let a=0;a<t.length;a++)t[a][0].isComingFromOPPharmacy&&"Pharmacy Issues"==t[a][0].isPharmacyService&&null!=t[r][0].pharamcyIssueServSeqId&&t[r][0].pharamcyIssueServSeqId==t[a][0].refTranSeqID&&(e.issueData=t[a][0]);for(let a=0;a<e.preAuthRcdList.length;a++)if("N"==e.preAuthRcdList[a].IS_PRE_AUTH_HEADER)if(e.preAuthRcdList[a].TYPE,4==e.preAuthRcdList[a].SERVICE_TYPE){if(e.issueData.priServTypCode==e.preAuthRcdList[a].SERV_SEQ_ID){l(e,t[r][0],e.preAuthRcdList[a]);break}}else if(3==e.preAuthRcdList[a].SERVICE_TYPE){if(e.issueData.deptCode==e.preAuthRcdList[a].SERV_SEQ_ID){l(e,t[r][0],e.preAuthRcdList[a]);break}}else if(2==e.preAuthRcdList[a].SERVICE_TYPE){if(e.issueData.specilityCode==e.preAuthRcdList[a].SERV_SEQ_ID){l(e,t[r][0],e.preAuthRcdList[a]);break}}else if(1==e.preAuthRcdList[a].SERVICE_TYPE&&e.issueData.servSeqId==e.preAuthRcdList[a].SERV_SEQ_ID){l(e,t[r][0],e.preAuthRcdList[a]);break}}else e.preAuthBillOrServiceCal(!1,t[r][0]);else null==t[r][0]&&"Self"!=t[r].payerType&&e.preAuthBillOrServiceCal(!1,t[r]);else e.preAuthBillOrServiceCal();null!=t&&1==e.preAuthBillNav&&e.orderSave(!0)})},this.opPreAuthCalBeforeOrder=function(e,t,r,a){if(r)null!=a.originalPayerAmount&&parseFloat(a.originalPayerAmount)>0&&(1==e.IS_AMT_PERC_NL_CODE?parseFloat(e.CONSUMABLE_AMOUNT)>0&&parseFloat(e.CONSUMABLE_QTY)>0?(e.APPROVED_AMNT=e.APPROVED_AMNT+parseFloat(a.originalPayerAmount),e.CONSUMABLE_AMOUNT=parseFloat(e.CONSUMABLE_AMOUNT)-parseFloat(a.originalPayerAmount),e.APPROVED_QTY=e.APPROVED_QTY+1,e.CONSUMABLE_QTY=parseFloat(e.CONSUMABLE_QTY)-1,t.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)+parseFloat(a.originalPayerAmount)):parseFloat(e.CONSUMABLE_AMOUNT)>0&&0==parseFloat(e.CONSUMABLE_QTY)?(e.APPROVED_AMNT=e.APPROVED_AMNT+parseFloat(a.originalPayerAmount),e.CONSUMABLE_AMOUNT=parseFloat(e.CONSUMABLE_AMOUNT)-parseFloat(a.originalPayerAmount),t.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)+parseFloat(a.originalPayerAmount)):0==parseFloat(e.CONSUMABLE_AMOUNT)&&parseFloat(e.CONSUMABLE_QTY)>0&&(e.APPROVED_QTY=e.APPROVED_QTY+1,e.CONSUMABLE_QTY=parseFloat(e.CONSUMABLE_QTY)-1):2==e.IS_AMT_PERC_NL_CODE?parseFloat(e.CONSUMABLE_QTY)>0&&(e.APPROVED_QTY=e.APPROVED_QTY+1,e.CONSUMABLE_QTY=parseFloat(e.CONSUMABLE_QTY)-1):3==e.IS_AMT_PERC_NL_CODE&&("PA"==e.APPROVD_DTLS&&parseFloat(e.CONSUMABLE_QTY)>0?(e.APPROVED_QTY=e.APPROVED_QTY+1,e.CONSUMABLE_QTY=parseFloat(e.CONSUMABLE_QTY)-1,t.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)+parseFloat(a.originalPayerAmount)):"AP"==e.APPROVD_DTLS&&(t.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)+parseFloat(a.originalPayerAmount))));else{if(null==a.actualRate?a.actualRate=a.price:null!=a.price&&a.price>a.actualRate&&(a.actualRate=a.price),1==e.IS_AMT_PERC_NL_CODE)!(null!=e.APPROVED_AMNT&&e.APPROVED_AMNT>0)||null!=e.APPROVED_QTY&&0!=parseFloat(e.APPROVED_QTY)||null!=e.CONSUMABLE_QTY&&0!=parseFloat(e.CONSUMABLE_QTY)?null!=e.APPROVED_QTY&&null!=e.APPROVED_AMNT&&e.APPROVED_QTY>0&&e.APPROVED_AMNT>0?(e.APPROVED_QTY=e.APPROVED_QTY-1,e.CONSUMABLE_QTY=parseFloat(e.CONSUMABLE_QTY)+1,e.APPROVED_AMNT>=parseFloat(a.actualRate)?(a.patamount=0,a.payeramount=parseFloat(a.actualRate),e.APPROVED_AMNT=e.APPROVED_AMNT-parseFloat(a.actualRate),parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)>=parseFloat(a.actualRate)&&(t.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)-parseFloat(a.actualRate)),e.CONSUMABLE_AMOUNT=parseFloat(e.CONSUMABLE_AMOUNT)+parseFloat(a.actualRate)):(a.patamount=parseFloat(a.actualRate)-e.APPROVED_AMNT,parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)>=parseFloat(e.APPROVED_AMNT)&&(t.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)-parseFloat(e.APPROVED_AMNT)),a.payeramount=e.APPROVED_AMNT,e.APPROVED_AMNT=0,e.CONSUMABLE_AMOUNT=parseFloat(e.CONSUMABLE_AMOUNT)+parseFloat(a.payeramount))):null!=e.APPROVED_QTY&&e.APPROVED_QTY>0&&(null==e.APPROVED_AMNT||0==e.APPROVED_AMNT)&&0==parseFloat(e.CONSUMABLE_AMOUNT)?(e.APPROVED_QTY=e.APPROVED_QTY-1,e.CONSUMABLE_QTY=parseFloat(e.CONSUMABLE_QTY)+1,a.patamount=0,a.payeramount=parseFloat(a.actualRate)):(a.patamount=parseFloat(a.actualRate),a.payeramount=0):e.APPROVED_AMNT>=parseFloat(a.actualRate)?(a.patamount=0,a.payeramount=parseFloat(a.actualRate),e.APPROVED_AMNT=e.APPROVED_AMNT-parseFloat(a.actualRate),parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)>=parseFloat(a.actualRate)&&(t.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)-parseFloat(a.actualRate)),e.CONSUMABLE_AMOUNT=parseFloat(e.CONSUMABLE_AMOUNT)+parseFloat(a.actualRate)):(a.patamount=parseFloat(a.actualRate)-e.APPROVED_AMNT,parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)>=parseFloat(e.APPROVED_AMNT)&&(t.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)-parseFloat(e.APPROVED_AMNT)),a.payeramount=e.APPROVED_AMNT,e.APPROVED_AMNT=0,e.CONSUMABLE_AMOUNT=parseFloat(e.CONSUMABLE_AMOUNT)+parseFloat(a.payeramount));else if(2==e.IS_AMT_PERC_NL_CODE)if(!(null!=e.APPROVED_AMNT&&e.APPROVED_AMNT>0)||null!=e.APPROVED_QTY&&0!=parseFloat(e.APPROVED_QTY)||null!=e.CONSUMABLE_QTY&&0!=parseFloat(e.CONSUMABLE_QTY))if(null!=e.APPROVED_AMNT&&null!=e.APPROVED_QTY&&e.APPROVED_QTY>0&&e.APPROVED_AMNT>0){let t=parseFloat((parseFloat(a.actualRate)*parseFloat(e.APPROVED_AMNT)/100).toFixed(2));a.patamount=parseFloat(a.actualRate)-t,a.payeramount=t,e.APPROVED_QTY=e.APPROVED_QTY-1,e.CONSUMABLE_QTY=parseFloat(e.CONSUMABLE_QTY)+1}else null!=e.APPROVED_QTY&&e.APPROVED_QTY>0&&(null==e.APPROVED_AMNT||0==e.APPROVED_AMNT)&&0==parseFloat(e.CONSUMABLE_AMOUNT)?(e.APPROVED_QTY=e.APPROVED_QTY-1,e.CONSUMABLE_QTY=parseFloat(e.CONSUMABLE_QTY)+1,a.patamount=0,a.payeramount=parseFloat(a.actualRate)):(a.patamount=parseFloat(a.actualRate),a.payeramount=0);else{let t=parseFloat((parseFloat(a.actualRate)*parseFloat(e.APPROVED_AMNT)/100).toFixed(2));a.patamount=parseFloat(a.actualRate)-t,a.payeramount=t}else 3==e.IS_AMT_PERC_NL_CODE&&parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)>parseFloat(e.CONSUMABLE_AMOUNT)&&("AP"==e.APPROVD_DTLS&&parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)>0?parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)>=parseFloat(a.actualRate)?(a.patamount=0,a.payeramount=parseFloat(a.actualRate),t.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)-parseFloat(a.actualRate)):(a.patamount=parseFloat(a.actualRate)-parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT),a.payeramount=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT),t.preAuthHdrRcdList.APPROVED_AMNT=0):"PA"==e.APPROVD_DTLS&&null!=e.APPROVED_QTY&&e.APPROVED_QTY>0&&parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)>0&&(parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)>=parseFloat(a.actualRate)?(a.patamount=0,a.payeramount=parseFloat(a.actualRate),t.preAuthHdrRcdList.APPROVED_AMNT=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT)-parseFloat(a.actualRate),e.APPROVED_QTY=e.APPROVED_QTY-1,e.CONSUMABLE_QTY=parseFloat(e.CONSUMABLE_QTY)+1):(a.patamount=parseFloat(a.actualRate)-parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT),a.payeramount=parseFloat(t.preAuthHdrRcdList.APPROVED_AMNT),t.preAuthHdrRcdList.APPROVED_AMNT=0,e.APPROVED_QTY=e.APPROVED_QTY-1,e.CONSUMABLE_QTY=parseFloat(e.CONSUMABLE_QTY)+1)));a.preAuthDone=1}},this.updatePrintInClaimForm=function(t){var r=o.defer(),a={"@class":"com.napier.core.service.vo.billing.Insurance",insuranceSeqId:t.PINS_SEQ_ID,printInClaimForm:t.CLAIM_YN},i={};return i.url=c.GBBILLREPORTGENERATION.URL,i.requestData={operation:"updateClaimFoamPrint",messageId:"",destination:"com.napier.core.billing.service.external.PayerDetailsService",message:a},e.sendRestRequest(i).then(function(e){r.resolve(e)}),r.promise}}])}(),function(){"use strict";angular.module("napierContainerUi").service("opBillPrintServiceNew",function(){this.getPrintData=function(e,t,r,a,i){var o=parseInt(e),s="OUTPATIENT_BILL_ITEMIZED_REPORT ";r=r.DT_CODE,a=a.desc,2==r?s=2==o?i?"OUTPATIENT_BILL_ITEMIZED_CASH_PAYER_REPORT":"OUTPATIENT_BILL_ITEMIZED_REPORT":"OUTPATIENT_BILL_ITEMIZED_PAYER_REPORT":3==r?s=2==o?i?"OUTPATIENT_BILL_MMACODE_CASH_PAYER_REPORT":"OUTPATIENT_BILL_MMACODE_REPORT":"OUTPATIENT_BILL_MMACODE_PAYER_REPORT":1==r?s=2==o?i?"OUTPATIENT_BILL_SUMMERIZED_CASH_PAYER_REPORT":"OUTPATIENT_BILL_SUMMERIZED_REPORT":"OUTPATIENT_BILL_SUMMERIZED_PAYER_REPORT":4==r&&(s=2==o?i?"PARTIALIZED_BILL_CASH_PAYER_REPORT":"PARTIALIZED_BILL_REPORT":"PARTIALIZED_BILL_PAYER_REPORT");var n={billno:t,reportId:s,printType:a};return n}})}(),function(){"use strict";angular.module("napierContainerUi").constant("opVisitMgtLablesNew",[{visitInfo:{headings:{VisitMangement:"OP Visit Management",addPatientDetails:"Add Patient Details",registerPatient:"Register Patient",addnewVisit:"Add New Visit",visitHistory:"Visit History",visitinfo:"Visit Info",order:"Orders",generateBills:"Generate Bills",payment:"Payment",paryerAuthourazion:"Payer Authourazion",payerDetailsTitle:"Payer Details",previousVisitNote:"Previous Visit Note"},visitMgt:{searchByPatients:"Search by Patient :",searchByVisit:"Search by Visit :",or:"(or)"},visitDetils:{episodeNo:"Episode No. :",episodeDescription:"Episode Description :",visitType:"Visit Type :",selectDoctor:"Select Doctor :",selectReferal:"Select Referal :",referedBy:"Refered By :"},mlcDetails:{mlcDetails:"MLC Details",mlcType:"MLC Type: ",mlcNo:"MLC No.: ",accidentReportNo:"Accident Report No. :",informedPolice:"Informed Police Station :",policePersonnelName:"Police Personnel Name :",uploadFile:"Upload File",remark:"Remarks"},previousVisitNote:{VisitNumber:"Visit Number",DateAndTime:"Date & Time",Author:"Author",VisitNote:"Visit Note"},addPatientDetail:{captureimage:"Capture Image",nationalId:"National ID",gender:"Gender",title:"Title",firstName:"First Name",mobileNumber:"Mobile No.",middleName:"Middle Name",emailId:"Email ID",lastName:"Last Name",service:"Service",dob:"Date of Birth",age:"Age",save:"Save"},patientBannerDetails:{name:"Mr. Paul Lee",userIdFormat:"jho 123456789",encounterID:"Encounter Id",userEncounterIDFormat:"ip 123456789",dob:"Date of Birth",userdateOfBirthFormat:"14 February 1988",bloodGroup:"Blood Group",userBloodGroupFormat:"O+",patientCategory:"Patient Category",userPatientCategory:"Insurance",insuranceCompany:"Insurance Company",userInsuranceComapany:"Bharati AXA Life","planType/Name":"Plan Type/Name",userPlanType:"Yearly Plan/Life MAX Plan",planEffectiveFrom:"Plan Effective From",userPlanEffectiveFormFormat:"15/03/2017",planEffectiveTo:"Plan Effective To",userPlanEffectiveFormTo:"14/03/2016",dignosis:"Dignosis",userDignosis:"2-h Plasma glucose (2-h PG)",allergies:"Allergies",userAllargies:"Codeine (nausea), Imitrex, Pencilin",triage:"Triage",userTriage:"Emergency"},mlcpreviousVisitNote:{visitNo:"Visit No. :",patientID:"",date:"Date:",dateformat:"",doctorName:"",followUp:""}}}])}(),function(){"use strict";function e(e,t,r,a){function i(e){var t;return(t=e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"])instanceof Array?t:null!=e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"]?t=e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"].columnList[0]["com.napier.core.service.vo.query.Column"]:""}function o(e,t){var r=e*(t/100);return null==r||!angular.isNumber(r)||isNaN(r)?"":r.toFixed(2)}this.comboBoxFetch=function(r,o){var s=e.defer(),n={},c=r;"MLC_TYPES"==c&&(n={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:c,idxList:[{"com.napier.core.service.vo.query.Index":[{ident:"1",value:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID}]}]}]}]}),"MQ0002"==c&&(n={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:c,idxList:[{"com.napier.core.service.vo.query.Index":[{ident:"1",value:"A"},{ident:"2",value:"A"},{ident:"3",value:"A"}]}]}]}]}),"SPECIALITY_LIST"==c&&(n={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:c,idxList:[{"com.napier.core.service.vo.query.Index":[]}]}]}]}),"TRN003"==c&&(n={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:c,idxList:[{"com.napier.core.service.vo.query.Index":[{paramName:"pMasterSqId",value:"6"}]}]}]}]}),"GET_COPMANY_ACC_DTLS"==c&&(n={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:c,idxList:[{"com.napier.core.service.vo.query.Index":[{paramName:"pPracticeId",value:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID}]}]}]}]});var l={};return l.url=t.HISCOMBOFILLING.URL,l.requestData={operation:"ExecuteQuery",destination:"QueryService",message:n},a.sendRestRequest(l).then(function(e){if("SPECIALITY_LIST"==c){var t=[],r=i(e);angular.forEach(r,function(e,r){var a=e.columnList[0]["com.napier.core.service.vo.query.Column"],i={CODE:a[0].data,DESCRIPTION:a[1].data};t.push(i)}),s.resolve(t)}if("MLC_TYPES"==c){var a=[],o=i(e);angular.forEach(o,function(e,t){var r=e.columnList[0]["com.napier.core.service.vo.query.Column"],i={CODE:r[0].data,DESCRIPTION:r[1].data};a.push(i)}),s.resolve(a)}if("MQ0002"==c){var n=[],l=i(e);angular.forEach(l,function(e,t){var r=e.columnList[0]["com.napier.core.service.vo.query.Column"],a={CODE:r[0].data,DESCRIPTION:r[1].data};n.push(a)}),s.resolve(n)}if("TRN003"==c){var p=[],d=i(e);angular.forEach(d,function(e,t){var r=e.columnList[0]["com.napier.core.service.vo.query.Column"],a={DT_CODE:r[0].data,DETAIL_DESC:r[1].data};p.push(a)}),s.resolve(p)}if("GET_COPMANY_ACC_DTLS"==c){var m=[],u=i(e);angular.forEach(u,function(e,t){var r=e.columnList[0]["com.napier.core.service.vo.query.Column"],a={INS_COMP_CODE:r[0].data,INS_COMP_NAME:r[1].data};m.push(a)}),s.resolve(m)}},function(e){}),s.promise},this.searchServices=function(r,o){var s,n=e.defer();s={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"ADV_REG_PAT_SER_PID_01",idxList:[{"com.napier.core.service.vo.query.Index":[{paramName:"pFirstName",value:r.patientName?r.patientName:""},{paramName:"pMRNo",value:r.MrNo?r.MrNo:""},{paramName:"pGender",value:r.gender?r.gender:""},{paramName:"pDOB",value:r.dateofbirth?r.dateofbirth:""},{paramName:"pMobileNo",value:r.mno?r.mno:""},{paramName:"pRegType",value:r.regType?r.regType:""},{paramName:"pRegPayerType",value:r.payer?r.payer:""}]}]}]}]};var c={};return c.url=t.HISCOMBOFILLING.URL,c.requestData={operation:"ExecuteQuery",destination:"QueryService",message:s},a.sendRestRequest(c).then(function(e){$(".btn-group").show();var t=e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"],r=Array.isArray(t),a=i(e),s=[];Array.isArray(a);if(""!=t&&null!=t&&1==r&&(6==o.columnDefs.length&&o.columnDefs.unshift({cellTemplate:'<div class="btn-group" ng-init="releaseAction=0"><input type="radio" name="radio_chk" id="radio_chk" ng-value="{{grid.renderContainers.body.visibleRowCache.indexOf(row)}}"  ng-model="releaseAction" /></div>',name:"radio_row",displayName:"",width:20}),angular.forEach(a,function(e,t){if(null==e.name){var r=e.columnList[0]["com.napier.core.service.vo.query.Column"],a=[];angular.forEach(r,function(e,t){a.push(e.data)});var i={patientId:a[0],patientName:a[1]+" "+a[2]+" "+a[3],mrNo:a[4],gender:a[6],dateofbirth:a[5],mno:a[7],age:a[10]};s.push(i)}})),""!=t&&null!=t&&0==r){6==o.columnDefs.length&&o.columnDefs.unshift({cellTemplate:'<div class="btn-group" ng-init="releaseAction=0"><input type="radio" name="radio_chk" id="radio_chk" ng-value="{{grid.renderContainers.body.visibleRowCache.indexOf(row)}}"  ng-model="releaseAction" /></div>',name:"radio_row",displayName:"",width:20});var c={patientId:a[0].data,patientName:a[1].data+" "+a[2].data+" "+a[3].data,mrNo:a[4].data,gender:a[6].data,dateofbirth:a[5].data,mno:a[7].data,age:a[10].data};s.push(c)}if(null==t&&0==r){7==o.columnDefs.length&&o.columnDefs.shift();c={patientName:"No Records Found"};s.push(c)}n.resolve(s)}),n.promise},this.loadGBDepositeGrid=function(r){var i=e.defer(),o={"@class":"com.napier.core.service.vo.deposits.DepositsVo",accSeqId:r},s={};return s.url=t.HISCOMBOFILLING.URL,s.requestData={operation:"getDepositsByAccountId",messageId:"",destination:"com.napier.core.deposits.service.external.DepositsService",message:o},a.sendRestRequest(s).then(function(e){var t=[];if(null==e.data.HITService.message||null==e.data.HITService.message.deposits||null==e.data.HITService.message.deposits[0]["com.napier.core.service.vo.deposits.DepositsVo"])i.resolve(t);else{var r=e.data.HITService.message.deposits[0]["com.napier.core.service.vo.deposits.DepositsVo"];r=r instanceof Array?r:[r],angular.forEach(r,function(e,r){var a={accSeqId:e.accSeqId,refSeqId:e.depositNo,depositSeqId:e.depositSeqId,deptranDate:null!=e.deptranDate.$?moment(e.deptranDate.$).format("DD/MM/YYYY"):"",depositAmount:e.depositAmount,appliedAmount:void 0!==e.adjustamtTotal?parseFloat(e.adjustamtTotal).toFixed(2):0,availableDefAmount:void 0!==e.availableAmount?parseFloat(e.availableAmount).toFixed(2):0,availableAmount:void 0!==e.availableAmount?parseFloat(e.availableAmount).toFixed(2):0,adjustamtTotal:void 0!==e.adjustamtTotal?parseFloat(e.adjustamtTotal).toFixed(2):0,depositTypeCode:e.depositTypeCode,depositTypeDesc:e.depositTypeDesc,deprefSeqId:e.refSeqId,depositNo:e.depositNo,gnTranStatus:e.gnTranStatus,isDeposit:!0,version:e.version?e.version:void 0};t.push(a),a={}}),i.resolve(t)}}),i.promise},this.loadGBDepositeGridBillCancelRefund=function(r){var i=e.defer(),o={"@class":"com.napier.core.service.vo.deposits.DepositsVo",accSeqId:r},s={};return s.url=t.HISCOMBOFILLING.URL,s.requestData={operation:"getCreditNoteDetails",messageId:"",destination:"com.napier.core.deposits.service.external.DepositsService",message:o},a.sendRestRequest(s).then(function(e){var t=[];if(null==e.data.HITService.message||null==e.data.HITService.message[0]||null==e.data.HITService.message[0]["com.napier.core.service.vo.deposits.DepositsVo"])i.resolve(t);else{var r=e.data.HITService.message[0]["com.napier.core.service.vo.deposits.DepositsVo"];r=r instanceof Array?r:[r],angular.forEach(r,function(e,r){var a={accSeqId:e.accSeqId,refSeqId:e.depositNo,depositSeqId:e.depositSeqId,deptranDate:null!=e.deptranDate.$?moment(e.deptranDate.$).format("DD/MM/YYYY"):"",depositAmount:e.depositAmount,appliedAmount:void 0!==e.adjustamtTotal?e.adjustamtTotal:0,availableDefAmount:void 0!==e.availableAmount?parseFloat(e.availableAmount).toFixed(2):0,availableAmount:e.availableAmount,adjustamtTotal:e.adjustamtTotal,depositTypeCode:e.depositTypeCode,collectionReqseqId:e.collectionReqseqId,isDeposit:!1};t.push(a),a={}}),i.resolve(t)}}),i.promise},this.loadPaymentReciepts=function(r){var i=e.defer(),o={"@class":"com.napier.core.collections.vo.ReceiptHeader",colReqSeqId:r},s={};return s.url=t.HISDEPOSITSERVICEEDIT.URL,s.requestData={operation:"getReceptDetails",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:o},a.sendRestRequest(s).then(function(e){var t=e.data.HITService.message.receiptDetailsList[0]["com.napier.core.collections.vo.ReceiptDetails"];i.resolve(t)}),i.promise},this.loadRefundReciepts=function(r){var i=e.defer(),o={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"OP_REFUND_LIST",idxList:[{"com.napier.core.service.vo.query.Index":[{ident:1,value:r}]}]}]}]},s={};return s.url=t.HISCOMBOFILLING.URL,s.requestData={operation:"ExecuteQuery",destination:"QueryService",message:o},a.sendRestRequest(s).then(function(e){var t=e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"].columnList[0]["com.napier.core.service.vo.query.Column"];i.resolve(t)}),i.promise},this.saveDepositeData=function(t,i,o){var s=e.defer(),n=[],c=0,l=t[0].Receivedfrom;angular.forEach(t,function(e,t){var r;""!=e.chequeDDDate&&e.chequeDDDate&&(r=moment(e.chequeDDDate).format("YYYY-MM-DD")+"T"+moment(e.chequeDDDate).format("HH:mm:ss.SSS")+"Z");var a={"@class":"com.napier.core.collections.vo.ReceiptDetails",amount:e.amtPaid,gnTranStatus:1,payMode:e.PayModeCode,cardBank:null!=e.bank?e.bank:void 0,cardNo:null!=e.cardNumber?e.cardNumber:void 0,cardTranNo:null!=e.cardTranId?e.cardTranId:void 0,chequeDDNo:null!=e.chequeDDno?e.chequeDDno:void 0,chequeqDDDate:r,bankAccSeqId:null!=e.chequeDDno?e.chequeDDno:void 0,chequeType:null!=e.chequeType?e.chequeType:void 0,ecsTranType:null!=e.paymentTranType?e.paymentTranType:void 0,cardExpiryDate:e.cardExpiryDate,cardType:e.cardType};n.push(a),c=parseFloat(c)+parseFloat(e.amtPaid)});var p={"@class":"com.napier.core.collections.vo.ReceiptHeader",counterCode:"2",gnTranStatus:1,receiptAmount:c,receiptDetailsList:[{"com.napier.core.collections.vo.ReceiptDetails":n}],depositVo:[{"com.napier.core.service.vo.deposits.DepositsVo":[]}],bill:[{"com.napier.core.billgeneration.vo.Bill":[]}],depositListVo:{"@class":"com.napier.core.service.vo.deposits.DepositsVo",accSeqId:i,subAccSeqId:o,depositAmount:c,depositTypeCode:644950312,gnTranStatus:1,gnDepositStatus:7,depositAgainst:3,facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID},receiptTranType:1,receivedFrom:l,recpSingleOrMultiple:t.length,remarks:"",requestAmount:c,scrollAdmin:166,shiftCode:"",totalAmt:c},d={};return d.url=r.GBDEPOSITSAVE.URL,d.requestData={operation:"generateDeposit",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:p},a.sendRestRequest(d).then(function(e){if(""==e.data.HITService.message||null==e.data.HITService.message.depositListVo)return s.reject("Save Falied");s.resolve(e.data.HITService.message.depositListVo)}),s.promise},this.savePaymentData=function(t,i,o,s,n,c){var l=e.defer(),p=[],d=0,m=0,u="";null!=t&&t.length>0&&(u=t[0].Receivedfrom,angular.forEach(t,function(e,t){var r;""!=e.chequeDDDate&&e.chequeDDDate&&(r=moment(e.chequeDDDate).format("YYYY-MM-DD")+"T"+moment(e.chequeDDDate).format("HH:mm:ss.SSS")+"Z"),e.roundOff&&0!=parseFloat(e.roundOff)&&(m=parseFloat(m)+parseFloat(e.roundOff),e.amtPaid=parseFloat(e.amtPaid)-parseFloat(e.roundOff));var a={"@class":"com.napier.core.collections.vo.ReceiptDetails",amount:e.amtPaid,gnTranStatus:1,payMode:e.PayModeCode,cardBank:null!=e.bank?e.bank:void 0,cardNo:null!=e.cardNumber?e.cardNumber:void 0,cardTranNo:null!=e.cardTranId?e.cardTranId:void 0,chequeDDNo:null!=e.chequeDDno?e.chequeDDno:void 0,chequeqDDDate:r,bankAccSeqId:null!=e.bank?e.bank:void 0,chequeType:null!=e.chequeType?e.chequeType:void 0,payMobileNo:null!=e.mobileNumber?e.mobileNumber:void 0,ecsTranType:null!=e.paymentTranType?e.paymentTranType:void 0,cardExpiryDate:e.cardExpiryDate,cardType:e.cardType,roundOffAmt:null!=e.roundOff?e.roundOff:0};p.push(a),d=parseFloat(d)+parseFloat(e.amtPaid)}));var v=[],S=[],y=0;null!=n&&n.length>0&&angular.forEach(n,function(e,t){if(e.appliedAmount>0)if(33!=e.depositTypeCode){y=parseFloat(y)+parseFloat(e.appliedAmount);var r={"@class":"com.napier.core.service.vo.deposits.DepositsVo",depositSeqId:e.depositSeqId,adjustAmount:e.appliedAmount,billSeqId:c};v.push(r)}else{r={"@class":"com.napier.core.billgeneration.vo.CreditNoteAdjustVo",creditNoteHdSeqId:e.depositSeqId,crNoteAdjAmt:e.appliedAmount,billSeqId:c};S.push(r)}});var D={"@class":"com.napier.core.collections.vo.ReceiptHeader",colReqSeqId:o,counterCode:"2",gnTranStatus:1,receiptAmount:d,billSeqId:c,depAdjAmt:y,receiptDetailsList:[{"com.napier.core.collections.vo.ReceiptDetails":p}],depositVo:[{"com.napier.core.service.vo.deposits.DepositsVo":v}],creditNoteAdjList:[{"com.napier.core.billgeneration.vo.CreditNoteAdjustVo":S}],receiptTranType:1,receivedFrom:u,recpSingleOrMultiple:t.length,remarks:"",requestAmount:s,scrollAdmin:166,shiftCode:"",isOPVisitBill:!0,totalAmt:d},g={};return g.url=r.GBDEPOSITSAVE.URL,g.requestData={operation:"savePaymentRefund",messageId:"savePaymentRefund",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:D},a.sendRestRequest(g).then(function(e){if(""==e.data.HITService.message||null==e.data.HITService.message[0]["com.napier.core.collections.vo.ReceiptHeader"])return l.reject("Save Falied");l.resolve(e.data.HITService.message[0]["com.napier.core.collections.vo.ReceiptHeader"])}),l.promise},this.loadGBPaymentGridData=function(t,i){var o=e.defer();if(null!=t.BILL_NO&&"Unbilled"!=t.BILL_NO)var s=t.BILL_NO;var n={"@class":"com.napier.core.collections.vo.ReceiptHeader",subAccSeqId:t.SUB_ACC_SEQ_ID,enSeqId:i,billNo:s,billStatus:"Unbilled"==t.BILL_NO?0:t.BILL_STATUS},c={};return c.url=r.GBDEPOSITSAVE.URL,c.requestData={operation:"getGridDetails",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:n},a.sendRestRequest(c).then(function(e){if(null==e.data.HITService.message||null==e.data.HITService.message[0]||null==e.data.HITService.message[0]["com.napier.core.collections.vo.ReceiptHeader"])return o.reject("No Data");var t=e.data.HITService.message[0]["com.napier.core.collections.vo.ReceiptHeader"];t=t instanceof Array?t:[t];var r=[];Array.isArray(t)&&angular.forEach(t,function(t,a){var i=null!=t.servName?t.servName:"",o=null!=t.servCode?t.servCode:"",s=null!=t.spDate.$?moment(t.spDate.$).format("DD/MM/YYYY"):"",n=null!=t.billStatus?t.billStatus:"",c=null!=t.baseRate?t.baseRate:"",l=null!=t.qty?t.qty:0,p=null!=t.taxAmount?t.taxAmount:0,d=null!=t.discountAmt?t.discountAmt:0,m=null!=t.payerAmt?t.payerAmt:0,u=null!=t.patientAmt?t.patientAmt:0,v=null!=t.paidAmt?t.paidAmt:0,S=null!=t.dueAmt?t.dueAmt:0,y=null!=t.depAdjAmt?t.depAdjAmt:0,D=0,g=0,A=null!=t.primaryServiceDescription?t.primaryServiceDescription:"",I=null!=t.patientPaidAmnt?t.patientPaidAmnt:0,P=null!=t.payerPaidAmnt?t.payerPaidAmnt:0,h=null!=t.crNoteAmount?t.crNoteAmount:0;if(y>0&&v>0&&v>=y&&(v=parseFloat(v)-parseFloat(y)),t.colReqSeqIds&&t.payerType){var R=angular.copy(t.colReqSeqIds),f=angular.copy(t.payerType);if(angular.isString(R)&&R.indexOf(","))var T=R.split(","),C=(angular.isString(f)&&f.split(","),T[0]),b=T[1];else if(4==f)C=R;else b=R}""!=c&&l>0&&(D=parseFloat(c)*parseFloat(l),g=parseFloat(c)*parseFloat(l),""!=d&&(D-=parseFloat(d)),D=parseFloat(D)+parseFloat(p));var E={ItemName:i,ItemCode:o,ItemDate:s,billStatus:n,baseRate:c,quantity:l,total:D,baseRateTotal:g,taxAmount:p,defdiscountAmt:d,discountAmt:d,payerAmt:m,PatAmt:u,PaidAmt:v,dueAmt:S,depAdjAmt:y,servicePostingSeqId:t.spSeqId,accSeqId:t.accSeqId,subAccSeqId:t.subAccSeqId,renderType:null!=t.renderType?t.renderType:"",spDate:t.spDate.$,patColSeqId:null!=C?C:void 0,payerColSeqId:null!=b?b:void 0,depositSeqId:null!=t.depositSeqId?t.depositSeqId:void 0,visitNo:null!=t.visitNo?t.visitNo:void 0,accPayerSeqId:null!=t.accPayerSeqId?t.accPayerSeqId:void 0,billSeqId:null!=t.billSeqId?t.billSeqId:void 0,refundFlag:null!=e.data.HITService.context.contextList[0]["com.napier.core.context.ContextElement"][11]?e.data.HITService.context.contextList[0]["com.napier.core.context.ContextElement"][11]:void 0,payerType:null!=t.payerType?t.payerType:"",isComingFromOPPharmacy:t.isComingFromOPPharmacy,primaryServiceDescription:A,servSeqId:t.servSeqId,refTranSeqID:t.refTranSeqID?t.refTranSeqID:void 0,copayAmt:t.copayAmt,detableAmount:t.detableAmount,patientPaidAmnt:I,payerPaidAmnt:P,gnTranStatus:null!=t.gnTranStatus?t.gnTranStatus:1,aliasName:null!=t.aliasName?t.aliasName:"",aliasCode:null!=t.aliasCode?t.aliasCode:"",crNoteAmount:h,payerName:null!=t.payerName?t.payerName:"",planSeqId:null!=t.planSeqId?t.planSeqId:"",concessionAmt:null!=t.concessionAmt?t.concessionAmt:0,payerCompPlanseqId:t.payerCompPlanseqId?t.payerCompPlanseqId:void 0,isPostBillApplicable:null!=t.isPostBillApplicable?t.isPostBillApplicable:0};t.partialStatusCode&&(E.partialStatusCode=t.partialStatusCode),t.partialStatusDescription&&(E.partialStatusDescription=t.partialStatusDescription),t.partialDueAmount&&(E.partialDueAmount=t.partialDueAmount),t.partialRequestSeqId&&(E.partialRequestSeqId=t.partialRequestSeqId),r.push(E),E={}}),o.resolve(r)}),o.promise},this.loadBillNumbers=function(r,i){var o=e.defer(),s={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"OP_BILLED_LIST",idxList:[{"com.napier.core.service.vo.query.Index":[{ident:1,value:r},{ident:2,value:i}]}]}]}]},n={};return n.url=t.HISCOMBOFILLING.URL,n.requestData={operation:"ExecuteQuery",messageId:"",destination:"QueryService",message:s},a.sendRestRequest(n).then(function(e){if(null==e.data.HITService.message||null==e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList||null==e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"])return o.reject("No Data");var t=e.data.HITService.message.queryList[0]["com.napier.core.service.vo.query.Query"].rowList[0]["com.napier.core.service.vo.query.Row"],r=[];if(Array.isArray(t))angular.forEach(t,function(e,t){var a=e.columnList[0]["com.napier.core.service.vo.query.Column"],i={};angular.forEach(a,function(e,t){var r=e.name;1==r.includes(".",0)&&(i[e.name.substring(r.indexOf(".")+1)]=e.data)}),r.push(i)});else{var a=t.columnList[0]["com.napier.core.service.vo.query.Column"],i={};angular.forEach(a,function(e,t){var r=e.name;1==r.includes(".",0)&&(i[e.name.substring(r.indexOf(".")+1)]=e.data)}),r.push(i)}o.resolve(r)}),o.promise},this.getServiceConcessionDetails=function(t,i,s,n){var c=e.defer();if(null==t||null==i||null==s)return c.reject("No Details");var l={"@class":"com.napier.core.collections.vo.ReceiptHeader",conSeqId:t,subAccSeqId:i,billSeqId:s,spSeqIdList:n},p={};return p.url=r.GBCONCESSIONDETAILS.URL,p.requestData={operation:"getServConcessions",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:l},a.sendRestRequest(p).then(function(e){if(null==e.data.HITService.message||null==e.data.HITService.message[0]||null==e.data.HITService.message[0]["com.napier.core.collections.vo.ReceiptHeader"])return c.reject("No Data");var t=e.data.HITService.message[0]["com.napier.core.collections.vo.ReceiptHeader"];t=t instanceof Array?t:[t];var r=[];angular.forEach(t,function(e,t){var a=e,i=null!=e.baseRate?e.baseRate:"",s=null!=e.patientAmt?e.patientAmt:0,n=null!=e.spQty?e.spQty:"",c=(null!=e.taxPercent&&e.taxPercent,null!=e.discountAmt&&e.discountAmt,null!=e.taxAmount&&e.taxAmount,0);""!=i&&""!=n&&""!=s&&(c=parseFloat(s)),a.total=c,a.concReqPer=0,a.concReqAmt=0,c>0&&(2==e.gnAmtType?(a.concReqPer=function(e,t){if(t>=e)var r=100;else var r=t/e*100;return r.toFixed(2)}(c,e.conAmount),a.concReqAmt=o(c,e.concReqPer),a.concReqAmt>e.conAmount&&(a.concReqPer=parseFloat(a.concReqPer)-.01,a.concReqAmt=o(c,e.concReqPer)),a.concReqAmt<e.conAmount&&(a.conAmount=e.concReqAmt)):1==e.gnAmtType&&(a.concReqPer=e.conAmount,a.concReqAmt=o(c,e.conAmount))),a.concLimitAmt=a.concReqAmt,a.concLimitPer=a.concReqPer,r.push(a),a={}}),c.resolve(r)}),c.promise},this.generateBillForUnbilled=function(t,i,o,s,n,c,l,p){var d=e.defer(),m=[],u=s.Due_Amt,v=s.Concession_Amt,S=(s.Total_Bill,s.Deposite_Adj),y=[],D=0,g=0,A="",I=0;null!=n&&n.length>0&&(I=n.length,A=n[0].Receivedfrom,angular.forEach(n,function(e,t){var r;""!=e.chequeDDDate&&e.chequeDDDate&&(r=moment(e.chequeDDDate).format("YYYY-MM-DD")+"T"+moment(e.chequeDDDate).format("HH:mm:ss.SSS")+"Z"),e.roundOff&&0!=parseFloat(e.roundOff)&&(g=parseFloat(g)+parseFloat(e.roundOff),e.amtPaid=parseFloat(e.amtPaid)-parseFloat(e.roundOff));var a={"@class":"com.napier.core.collections.vo.ReceiptDetails",amount:e.amtPaid,gnTranStatus:1,payMode:e.PayModeCode,cardBank:null!=e.bank?e.bank:void 0,cardNo:null!=e.cardNumber?e.cardNumber:void 0,cardTranNo:null!=e.cardTranId?e.cardTranId:void 0,chequeDDNo:null!=e.chequeDDno?e.chequeDDno:void 0,chequeqDDDate:r,bankAccSeqId:null!=e.bank?e.bank:void 0,chequeType:null!=e.chequeType?e.chequeType:void 0,ecsTranType:null!=e.paymentTranType?e.paymentTranType:void 0,cardExpiryDate:e.cardExpiryDate,cardType:e.cardType,roundOffAmt:null!=e.roundOff?e.roundOff:0};y.push(a),D=parseFloat(D)+parseFloat(e.amtPaid)}));var P=[],h=[],R=0;null!=c&&c.length>0&&angular.forEach(c,function(e,t){if(e.appliedAmount>0)if(R=parseFloat(R)+parseFloat(e.appliedAmount),u=parseFloat(u)+parseFloat(e.appliedAmount),33!=e.depositTypeCode){var r={"@class":"com.napier.core.billgeneration.vo.BillDepositDetails",depositSeqId:e.depositSeqId,depAdjAmount:e.appliedAmount,gnStatus:1,availableAmount:e.depositAmount,version:e.version?e.version:void 0};P.push(r)}else{r={"@class":"com.napier.core.billgeneration.vo.CreditNoteAdjustVo",creditNoteHdSeqId:e.depositSeqId,crNoteAdjAmt:e.appliedAmount};h.push(r)}});var f=[];null!=l&&l.length>0&&angular.forEach(l,function(e,t){if(null!=e.cType){var r=[];if(e.serviceConcList&&e.serviceConcList.length>0){for(var a=e.serviceConcList,i=0;i<a.length;i++)if(a[i].concReqPer>0||a[i].concReqAmt>0){var o={"@class":"com.napier.core.service.vo.corebillingconcession.ConcessionRequestDetails",amountType:a[i].gnAmtType,concessionStatus:1,reqConession:1==a[i].gnAmtType?a[i].concReqPer:a[i].concReqAmt,tranStatus:1,servicePostSeqID:a[i].spSeqId,servSeqId:a[i].servSeqId};r.push(o),o={}}}else if(e.billReqPer>0||e.billReqConcAmt>0){o={"@class":"com.napier.core.service.vo.corebillingconcession.ConcessionRequestDetails",amountType:e.billConcType,concessionStatus:1,reqConession:1==e.billConcType?e.billReqPer:e.billReqConcAmt,tranStatus:1};r.push(o),o={}}var s={"@class":"com.napier.core.service.vo.corebillingconcession.ConcessionRequest",concessionSeqId:e.cType,reasonForConcession:e.remarks,concessionType:e.billService,concessionStatus:1,concessionRequestDetailsList:[{"com.napier.core.service.vo.corebillingconcession.ConcessionRequestDetails":r}],remarks:e.remarks,tranStatus:1,concessionReqDate:moment().format("YYYY-MM-DD")+"T"+moment().format("HH:mm:ss.SSS")+"Z"};f.push(s),r={}}});var T=[],C=[],b=[],E=0,q=0,O=0,L=0,V=0,N=0,_=0,w=0,M=0,F=!1,B=[];angular.forEach(t,function(e,t){4==e.payerType?(O=parseFloat(O)+parseFloat(e.PatAmt),L=parseFloat(L)+parseFloat(e.taxAmount),N=parseFloat(N)+parseFloat(e.discountAmt),C.push({"@class":"com.napier.core.billgeneration.vo.BillDetails",servicePostSeqId:e.servicePostingSeqId,spDate:e.spDate,isPostBillApplicable:e.isPostBillApplicable?e.isPostBillApplicable:0})):(E=parseFloat(E)+parseFloat(e.payerAmt)+parseFloat(e.PatAmt),q=parseFloat(q)+parseFloat(e.PatAmt),V=parseFloat(V)+parseFloat(e.taxAmount),_=parseFloat(_)+parseFloat(e.discountAmt),T.push({"@class":"com.napier.core.billgeneration.vo.BillDetails",servicePostSeqId:e.servicePostingSeqId,spDate:e.spDate,isPostBillApplicable:e.isPostBillApplicable?e.isPostBillApplicable:0})),B.push({serviceSeqId:e.servSeqId,refTranSeqID:e.refTranSeqID})});var x=O;v>0&&(x=parseFloat(x)-parseFloat(v)),parseFloat(S)<=parseFloat(x)?(w=S,M=0):(w=x,M=parseFloat(S)-parseFloat(x)),0==w&&M>0&&(F=!0);for(var G=function(e){for(var t=e.concat(),r=0;r<t.length;r++){if(angular.isString(t[r].payerType)&&t[r].payerType.indexOf(","))var a=t[r].payerType.split(",")[1];else a=t[r].payerType;for(var i=0,o=r+1;o<t.length;o++){if(angular.isString(t[o].payerType)&&t[o].payerType.indexOf(","))var s=t[o].payerType.split(",")[1];else s=t[o].payerType;a==s&&(i+=o,t.splice(o--,1))}t[r].total=i}return t}(t),U=0;U<G.length;U++){m=[];var Q,k,H,j,Y=0,W=0,$=0;if(D&&D>0&&(D>parseFloat(O)-parseFloat(w)?(W=parseFloat(O)-parseFloat(w),$=parseFloat(D)-parseFloat(W)):W=D),4==G[U].payerType){Y=O;var z=3,J=W;Q=C,k=L,H=N,j=w,m.push({"@class":"com.napier.core.billgeneration.vo.BillPayerDetails",accPayerSeqId:i,payerAmount:parseFloat(Y),blPayerAdjAmt:parseFloat(Y),payerType:G[U].payerType,payStatus:2,gnStatus:1})}else{Y=E;z=2,J=$;if(Q=T,angular.isString(G[U].payerType)&&G[U].payerType.indexOf(","))var Z=G[U].payerType.split(",")[1];else Z=G[U].payerType;k=V,H=_,j=M,0==q&&U==G.length-1&&(parseFloat(s.deductibleAmount)>0||parseFloat(s.coPay)>0)&&(q=parseFloat(q)+parseFloat(s.deductibleAmount)+parseFloat(s.coPay)),m.push({"@class":"com.napier.core.billgeneration.vo.BillPayerDetails",accPayerSeqId:null==G[U].accPayerSeqId?i:G[U].accPayerSeqId,payerAmount:parseFloat(Y)-parseFloat(q),blPayerAdjAmt:parseFloat(Y)-parseFloat(q),payerType:Z,payStatus:2,gnStatus:1}),q>0&&m.push({"@class":"com.napier.core.billgeneration.vo.BillPayerDetails",accPayerSeqId:i,payerAmount:parseFloat(q),blPayerAdjAmt:parseFloat(q),payerType:4,payStatus:2,gnStatus:1})}var K={"@class":"com.napier.core.billgeneration.vo.Bill",billDate:moment().format("YYYY-MM-DD")+"T"+moment().format("HH:mm:ss.SSS")+"Z",billStatus:{"@class":"com.napier.core.service.vo.masters.GeneralMaster",code:1},taxAmount:k,consStatus:z,consessionAmt:3==z?v:0,billAmount:Y,discountAmount:H,adjAmount:j,settledAmt:J,billPayStatus:2,billType:2,isCashAllowed:2,tobePaidAmount:Y,accSeqId:i,subAccSeqId:o,deductableAmt:parseFloat(s.deductibleAmount),copayAmt:s.coPay?parseFloat(s.coPay):0,roundOfAmt:g,billDetailsList:[{"com.napier.core.billgeneration.vo.BillDetails":Q}],highValueBillsDiscountVoList:[{"com.napier.core.billgeneration.vo.HighValueBillsDiscountVo":B}],billPayerDtList:[{"com.napier.core.billgeneration.vo.BillPayerDetails":m}],billDepositDetailsList:[{"com.napier.core.billgeneration.vo.BillDepositDetails":3==z||F?P:void 0}],isPrimaryBill:!1,isBillClearedCheck:!0,isDoctorResponsible:!1};4==K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][0].payerType?(K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][0].payerAmount=parseFloat(Y),K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][0].blPayerAdjAmt=parseFloat(Y),K.deductableAmt=0,K.copayAmt=0):null!=K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][1]&&4==K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][1].payerType&&(K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][1].payerAmount=parseFloat(K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][1].payerAmount)+parseFloat(s.deductibleAmount),K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][0].payerAmount=parseFloat(K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][0].payerAmount)-parseFloat(s.deductibleAmount),K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][1].blPayerAdjAmt=parseFloat(K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][1].payerAmount),K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][0].blPayerAdjAmt=parseFloat(K.billPayerDtList[0]["com.napier.core.billgeneration.vo.BillPayerDetails"][0].payerAmount),K.billAmount=Y,K.deductableAmt=s.deductibleAmount,K.copayAmt=s.coPay),b.push(K)}var X={"@class":"com.napier.core.collections.vo.ReceiptHeader",gnTranStatus:1,receiptAmount:D,counterCode:"2",concessionRequest:[{"com.napier.core.service.vo.corebillingconcession.ConcessionRequest":f}],receiptDetailsList:[{"com.napier.core.collections.vo.ReceiptDetails":y}],depositVo:[{"com.napier.core.service.vo.deposits.DepositsVo":[]}],creditNoteAdjustVo:[{"com.napier.core.billgeneration.vo.CreditNoteAdjustVo":h}],bill:[{"com.napier.core.billgeneration.vo.Bill":b}],receiptTranType:1,receivedFrom:A,recpSingleOrMultiple:I,remarks:"payment",requestAmount:parseFloat(u),scrollAdmin:JSON.parse(sessionStorage.userContextObj).USER_SEQ_ID,shiftCode:"",totalAmt:D};p&&(X.partialRequestSeqId=p);var ee={};return ee.url=r.GBBILLGENERATION.URL,ee.requestData={operation:"generateBill",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:X},a.sendRestRequest(ee).then(function(e){if(null==e.data.HITService.message||e.data.HITService.message.errorCode){var t="Save Failed";return"DEPOST00001"==e.data.HITService.message.errorCode&&(t="Requested Deposit is Already Adjusted/ Refunded"),d.reject(t)}if(""==e.data.HITService.message||null==e.data.HITService.message.bill||null==e.data.HITService.message.bill[0]["com.napier.core.billgeneration.vo.Bill"])return d.reject("Save Falied");d.resolve(e)}),d.promise},this.generatePaymentReport=function(t,i,o,s){var n=e.defer();if(null!=s&&"OPCS"==s)var c="OutPatient_CashBillGeneratedReports_ReportId";else if(null!=s&&"OPCR"==s)c="OutPatient_CreditBillGeneratedReports_ReportId";else c="OutPatientPaymentReceiptGenerationReport";"HSC"===sessionStorage.productCustomization&&(c="HSC_PATIENT_PAYMENT_RECEIPT_GENERATION_REPORT");var l={"@class":"com.napier.report.vo.ReportRequest",reportId:c,filterParams:[{"com.napier.report.model.ReportIndex":[{ident:"pBillSeqId",value:t},{ident:"pReceptSeqId",value:i},{ident:"pReceptDtSeqId",value:o}]}],reportType:{id:4,desc:"PDF"}},p={};return p.url=r.GBPAYMENTREPORTGENERATION.URL,p.requestData={operation:"processReport",messageId:"",destination:"reportingServiceImpl",message:l},a.sendRestRequest(p).then(function(e){if(null==e.data.HITService.message||null==e.data.HITService.message.reportName)return n.reject("Print Failed");n.resolve(e)}),n.promise},this.generateBillReport=function(t,i,o,s){var n,c=e.defer();switch(s){case 1:n="OutPatient_CashBillGeneratedReports_ReportId";break;case 2:n="OutPatient_CreditBillGeneratedReports_ReportId";break;default:n="OutPatientConsultationBillReport"}var l={"@class":"com.napier.report.vo.ReportRequest",reportId:n,filterParams:[{"com.napier.report.model.ReportIndex":[{ident:"pBillSeqId",value:t},{ident:"pReceptSeqId",value:i},{ident:"pReceptDtSeqId",value:o}]}],reportType:{id:4,desc:"PDF"}},p={};return p.url=r.GBBILLREPORTGENERATION.URL,p.requestData={operation:"processReport",messageId:"",destination:"reportingServiceImpl",message:l},a.sendRestRequest(p).then(function(e){c.resolve(e)}),c.promise},this.cancelBillData=function(t){var i=[],o=[],s=0;angular.forEach(t,function(e,t){7!=e.gnTranStatus&&(i.push({servicePostSeqId:e.servicePostingSeqId,isPostBillApplicable:e.isPostBillApplicable}),e.total&&e.total>0&&(s=parseFloat(s)+parseFloat(e.total)),o.push({serviceSequenceId:e.servSeqId}))});var n=e.defer(),c={"@class":"com.napier.core.billgeneration.vo.BillCanceHdlDetails",billCancDtList:[{"com.napier.core.billgeneration.vo.BillCancelDtDetails":i}],servSeqIds:[{"com.napier.core.billgeneration.vo.ServiceIdentityVO":o}],billSeqId:t[0].billSeqId,cancelBy:JSON.parse(sessionStorage.userContextObj).USER_SEQ_ID,cancelbillDate:moment().format("YYYY-MM-DD")+"T"+moment().format("HH:mm:ss.SSS")+"Z",cancelNo:"",cancelReasonCode:101,cancelReason:"Cancelled",approvedAmt:s,gnTranStatus:"1",lastUpdatedOn:moment().format("YYYY-MM-DD")+"T"+moment().format("HH:mm:ss.SSS")+"Z",cancelBill:!1,insurancePlanSeqId:0,isOPVisitBill:!0,isCsOrCR:4!=t[0].payerType,subAccSeqId:t[0].subAccSeqId,cancelStatus:{code:"4"}},l={};return l.url=r.GBBILLREPORTGENERATION.URL,l.requestData={operation:"updateBillGenerationNew",messageId:"",destination:"com.napier.core.billgeneration.service.external.BillGenerationService",message:c},a.sendRestRequest(l).then(function(e){if(null==e.data.HITService.message)return n.reject("No Data");n.resolve(e.data.HITService)}),n.promise},this.loadAppliedConc=function(t){var i=e.defer(),o={"@class":"com.napier.core.collections.vo.ReceiptHeader",billSeqId:t.BILL_SEQ_ID},s={};return s.url=r.GBBILLREPORTGENERATION.URL,s.requestData={operation:"getConcessionsServices",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:o},a.sendRestRequest(s).then(function(e){if(null==e.data.HITService.message||null==e.data.HITService.message.concessionRequest[0]["com.napier.core.service.vo.corebillingconcession.ConcessionRequest"])return i.reject("No Data");var t=e.data.HITService.message.concessionRequest[0]["com.napier.core.service.vo.corebillingconcession.ConcessionRequest"];t=t instanceof Array?t:[t];var r=[];angular.forEach(t,function(e,t){var a=e;a.cTypeDesc=e.concessionName,a.cType=e.concessionSeqId,a.billReqAmt=e.reqConcessionAmount,r.push(a),a={}}),i.resolve(r)}),i.promise},this.ViewBillConcesDetails=function(t){var i=e.defer(),o={"@class":"com.napier.core.service.vo.corebillingconcession.ConcessionRequest",concessionReqSeqId:t},s={};return s.url=r.GBBILLREPORTGENERATION.URL,s.requestData={operation:"viewConcessionRequest",messageId:"",destination:"com.napier.core.corebillingconcession.service.external.CoreBillingConcessionService",message:o},a.sendRestRequest(s).then(function(e){if(null==e.data.HITService.message||null==e.data.HITService.message.concessionRequestDetailsList)return i.reject("No Data");var t=e.data.HITService.message;i.resolve(t)}),i.promise},this.removeConcesData=function(t,i){var o=e.defer(),s={"@class":"com.napier.core.collections.vo.ReceiptHeader",concessionRequest:[{"com.napier.core.service.vo.corebillingconcession.ConcessionRequest":[{"@class":"com.napier.core.service.vo.corebillingconcession.ConcessionRequest",concessionReqSeqId:t,concessionType:i}]}]},n={};return n.url=r.GBBILLREPORTGENERATION.URL,n.requestData={operation:"cancleConcessions",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:s},a.sendRestRequest(n).then(function(e){if(null==e.data.HITService.message||""==e.data.HITService.message)return o.reject("No Data");o.resolve(e.data.HITService.message)}),o.promise},this.saveBillConcession=function(t,i){var o=e.defer(),s=[];null!=t&&t.length>0&&angular.forEach(t,function(e,t){if(null!=e.cType){var r=[];if(e.serviceConcList&&e.serviceConcList.length>0){for(var a=e.serviceConcList,o=0;o<a.length;o++)if(a[o].concReqPer>0||a[o].concReqAmt>0){var n={"@class":"com.napier.core.service.vo.corebillingconcession.ConcessionRequestDetails",amountType:a[o].gnAmtType,concessionStatus:1,reqConession:1==a[o].gnAmtType?a[o].concReqPer:a[o].concReqAmt,tranStatus:1,servicePostSeqID:a[o].spSeqId,servSeqId:a[o].servSeqId};r.push(n),n={}}}else if(e.billReqPer>0||e.billReqConcAmt>0){n={"@class":"com.napier.core.service.vo.corebillingconcession.ConcessionRequestDetails",amountType:e.billConcType,concessionStatus:1,reqConession:1==e.billConcType?e.billReqPer:e.billReqConcAmt,tranStatus:1};r.push(n),n={}}var c={"@class":"com.napier.core.service.vo.corebillingconcession.ConcessionRequest",billSeqId:i,concessionSeqId:e.cType,reasonForConcession:e.remarks,concessionType:e.billService,concessionStatus:1,concessionRequestDetailsList:[{"com.napier.core.service.vo.corebillingconcession.ConcessionRequestDetails":r}],remarks:e.remarks,tranStatus:1,concessionReqDate:moment().format("YYYY-MM-DD")+"T"+moment().format("HH:mm:ss.SSS")+"Z"};s.push(c),r={}}});var n={"@class":"com.napier.core.collections.vo.ReceiptHeader",concessionRequest:[{"com.napier.core.service.vo.corebillingconcession.ConcessionRequest":s}]},c={};return c.url=r.GBBILLREPORTGENERATION.URL,c.requestData={operation:"generateConcession",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:n},a.sendRestRequest(c).then(function(e){if(null==e.data.HITService.message||""==e.data.HITService.message)return o.reject("No Data");o.resolve(e.data.HITService.message)}),o.promise},this.depositBillAdjustment=function(t,i){var o=e.defer(),s=[],n=[];null!=t&&t.length>0&&angular.forEach(t,function(e,t){if(e.appliedAmount>0)if(33!=e.depositTypeCode){var r={"@class":"com.napier.core.billgeneration.vo.BillDepositDetails",depositSeqId:e.depositSeqId,depAdjAmount:e.appliedAmount,gnStatus:1,availableAmount:e.depositAmount,version:e.version?e.version:void 0};s.push(r)}else{r={"@class":"com.napier.core.billgeneration.vo.CreditNoteAdjustVo",creditNoteHdSeqId:e.depositSeqId,crNoteAdjAmt:e.appliedAmount,billSeqId:i.BILL_SEQ_ID};n.push(r)}});var c={"@class":"com.napier.core.collections.vo.ReceiptHeader",bill:[{"com.napier.core.billgeneration.vo.Bill":[{"@class":"com.napier.core.billgeneration.vo.Bill",billSeqId:i.BILL_SEQ_ID,billDepositDetailsList:[{"com.napier.core.billgeneration.vo.BillDepositDetails":s}]}]}],creditNoteAdjustVo:[{"com.napier.core.billgeneration.vo.CreditNoteAdjustVo":n}]},l={};return l.url=r.GBBILLDEPOSITADJUST.URL,l.requestData={operation:"ceateDeposit",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:c},a.sendRestRequest(l).then(function(e){if(null==e.data.HITService.message||""==e.data.HITService.message)return o.reject("No Data");o.resolve(e.data.HITService.message)}),o.promise},this.transTypeCombSearch=function(r){var o,s=e.defer();o={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:r,idxList:[{"com.napier.core.service.vo.query.Index":[{paramName:"pMasterSqId",value:"1610"}]}]}]}]};var n={};return n.url=t.HISCOMBOFILLING.URL,n.requestData={operation:"ExecuteQuery",destination:"QueryService",message:o},a.sendRestRequest(n).then(function(e){var t=[],r=i(e);angular.forEach(r,function(e,r){var a=e.columnList[0]["com.napier.core.service.vo.query.Column"],i={CODE:a[0].data,DESCRIPTION:a[1].data};t.push(i)}),s.resolve(t)}),s.promise},this.getDACharges=function(t,i,o){var s=e.defer(),n=o.visitTypeCode,c={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:t.accSeqId,subAccSeqId:t.subAccSeqId,servicePostingType:2,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:t.servSeqId},quantity:o.quantity,priority:n,serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:t.servSeqId,rcvSeqId:t.rcvSeqId,inflSeqId:t.inflSeqId,tariffSeqId:i,datedOn:moment(new Date).format("YYYY-MM-DD HH:mm:ss.000")},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},patientCategoryCode:"2  ",transType:1,facilityId:t.facilityId,practiceId:t.practiceId,gnFlow:t.gnFlow,surcharge:0,serviceRate:t.serviceRate,actualRate:t.actualRate,doctorAmount:t.doctorAmount,proposedShareAfterDiscount:t.proposedShareAfterDiscount,standardDoctorShare:t.standardDoctorShare,doctorModifiedAmount:110,discountAmt:t.discountAmt,bedClassCode:1,chargeableAmt:t.baseRate,isRateEditable:t.isRateEditable,isServiceRateEditable:t.isRateEditable,isEmergency:2,previousQty:t.quantity,renderedByEmployee:{"@class":"com.napier.core.service.vo.masters.Employee",empSeqId:t.requestedByEmpSeqID},renderedByEmpSeqID:t.requestedByEmpSeqID,renderedByEmpType:t.requestedByEmpType},l={};return l.url=r.GBBILLREPORTGENERATION.URL,l.requestData={operation:"recalculateServiceRateForStandard",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:c},a.sendRestRequest(l).then(function(e){if(null==e.data.HITService.message)return s.reject("No Data");var r=e.data.HITService.message;r.orderObj=t,r.tarrifSeq=i,r.detailObj=o,s.resolve(r)}),s.promise},this.getDAChargesByType=function(t,i){var o=e.defer(),s="",n="";1==t.tranType?(s="recalculateServiceRateForStandard",n=1):3==t.tranType?(s="recalculateServiceRateForNocharge",n=3):2==t.tranType&&(s="recalculateServiceRateForNegotiable",n=2);var c=t.detailObj.visitTypeCode,l={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",accSeqId:t.orderObject.accSeqId,subAccSeqId:t.orderObject.subAccSeqId,servicePostingType:2,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:t.orderObject.servSeqId},quantity:t.detailObj.quantity,priority:c,serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:t.orderObject.servSeqId,rcvSeqId:t.orderObject.rcvSeqId,inflSeqId:t.orderObject.inflSeqId,tariffSeqId:t.tariffId,datedOn:moment(new Date).format("YYYY-MM-DD HH:mm:ss.000")},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},patientCategoryCode:"2  ",transType:n,facilityId:t.orderObject.facilityId,practiceId:t.orderObject.practiceId,gnFlow:t.orderObject.gnFlow,surcharge:t.orderObject.surcharge,serviceRate:t.orderObject.originalBaseRate?t.orderObject.originalBaseRate:t.orderObject.baseRate,actualRate:t.orderObject.actualRate,doctorAmount:3==n?0:t.orderObject.doctorAmount,proposedShareAfterDiscount:3==n?0:t.orderObject.proposedShareAfterDiscount,standardDoctorShare:3==n?0:parseFloat(0!=t.docAmount)?t.docAmount:t.orderObject.standardDoctorShare,doctorModifiedAmount:2==t.tranType?0!=t.modAmount&&"0.00"!=t.modAmount?t.modAmount:t.docAmount:0,discountAmt:t.orderObject.discountAmt,bedClassCode:1,chargeableAmt:t.orderObject.baseRate,isRateEditable:t.orderObject.isRateEditable,isServiceRateEditable:t.orderObject.isRateEditable,isEmergency:2,previousQty:t.orderObject.quantity,renderedByEmployee:{"@class":"com.napier.core.service.vo.masters.Employee",empSeqId:t.orderObject.requestedByEmpSeqID},renderedByEmpSeqID:t.orderObject.requestedByEmpSeqID,renderedByEmpType:t.orderObject.requestedByEmpType},p={};return p.url=r.GBBILLREPORTGENERATION.URL,p.requestData={operation:s,messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:l},a.sendRestRequest(p).then(function(e){if(null==e.data.HITService.message)return o.reject("No Data");var t=e.data.HITService.message;o.resolve(t)}),o.promise},this.checkVisitClosedorNot=function(r){var o,s=e.defer();o={"@class":"com.napier.core.service.vo.query.QueryData",queryList:[{"com.napier.core.service.vo.query.Query":[{identifier:"GET_OP_VISITS_EN_ACTION_STATUS_NEW_001",idxList:[{"com.napier.core.service.vo.query.Index":[{paramName:"pEnseqId",value:r}]}]}]}]};var n={};return n.url=t.HISCOMBOFILLING.URL,n.requestData={operation:"ExecuteQuery",destination:"QueryService",message:o},a.sendRestRequest(n).then(function(e){var t=i(e);s.resolve(t)}),s.promise},this.updateServiceAliasCodes=function(r){var i=e.defer(),o={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",servicePostingSeqId:r.servicePostingSeqId,philHealthCode:r.ItemCodeNew.PAYER_ALIAS_CODE,philHealthName:r.ItemCodeNew.PAYER_ALIAS_NAME},s={};return s.url=t.HISCOMBOFILLING.URL,s.requestData={operation:"updatePhilHealthCode",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:o},a.sendRestRequest(s).then(function(e){i.resolve(e)}),i.promise},this.refundCreditNote=function(r,i){var o=e.defer(),s=angular.fromJson(sessionStorage.userContextObj),n="";r.roundOff&&0!=parseFloat(r.roundOff)?r.amtPaid=parseFloat(r.amtPaid)-parseFloat(r.roundOff):r.roundOff=0;var c,l=[];""!=r.chequeDDDate&&r.chequeDDDate&&(c=moment(r.chequeDDDate).format("YYYY-MM-DD")+"T"+moment(r.chequeDDDate).format("HH:mm:ss.SSS")+"Z");var p={"@class":"com.napier.core.collections.vo.ReceiptDetails",amount:r.amtPaid,gnTranStatus:1,payMode:r.PayModeCode,cardBank:null!=r.bank?r.bank:void 0,cardNo:null!=r.cardNumber?r.cardNumber:void 0,cardTranNo:null!=r.cardTranId?r.cardTranId:void 0,chequeDDNo:null!=r.chequeDDno?r.chequeDDno:void 0,chequeqDDDate:c,bankAccSeqId:null!=r.chequeDDno?r.chequeDDno:void 0,chequeType:null!=r.chequeType?r.chequeType:void 0,ecsTranType:null!=r.paymentTranType?r.paymentTranType:void 0,cardExpiryDate:r.cardExpiryDate,cardType:r.cardType};l.push(p),n=i.isDeposit?{"@class":"com.napier.core.collections.vo.ReceiptHeader",roundOffAmt:r.roundOff,receivedFrom:r.receivedfrom,receiptDetailsList:[{"com.napier.core.collections.vo.ReceiptDetails":l}],depositVo:[{"com.napier.core.service.vo.deposits.DepositsVo":[{depositSeqId:i.depositSeqId,accSeqId:i.accSeqId,depositAmount:i.depositAmount,depositNo:i.depositNo,depositTypeCode:i.depositTypeCode,depositTypeDesc:i.depositTypeDesc,gnTranStatus:i.gnTranStatus,subAccSeqId:i.subAccSeqId,availableAmount:i.availableAmount,refSeqId:i.deprefSeqId,isBillDepositAdj:!1,version:i.version?i.version:void 0,totalDepositAmount:0,depositRefundList:[{"com.napier.core.service.vo.deposits.DepositRefundVo":[{depRefundAmount:r.amtPaid}]}]}]}]}:{"@class":"com.napier.core.collections.vo.ReceiptHeader",colReqSeqId:i.collectionReqseqId,counterCode:"2",gnTranStatus:1,receiptAmount:r.amtPaid,receiptDetailsList:[{"com.napier.core.collections.vo.ReceiptDetails":l}],depositVo:[{"com.napier.core.service.vo.deposits.DepositsVo":[]}],receiptTranType:r.TRAN_REQ_TYPE,receivedFrom:r.receivedfrom,recpSingleOrMultiple:0,remarks:"",requestAmount:r.amtPaid,scrollAdmin:s.USER_SEQ_ID,shiftCode:"3001",totalAmt:r.amtPaid};var d={};return d.url=t.HISDEPOSITSERVICEEDIT.URL,d.requestData={operation:"refundDepositOrCreditnote",messageId:"",destination:"com.napier.core.collections.service.external.PaymentRefundService",message:n},a.sendRestRequest(d).then(function(e){if(null==e.data.HITService.message||e.data.HITService.message.errorCode){var t="Refund Failed";return"DEPOST00001"==e.data.HITService.message.errorCode&&(t="Requested Deposit is Already Adjusted/ Refunded"),o.reject(t)}o.resolve(e.data.HITService.message)}),o.promise},this.postRoomChargesforEmgPat=function(t){var i=e.defer(),o={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",subAccSeqId:t},s={};return s.url=r.GBBILLREPORTGENERATION.URL,s.requestData={operation:"emergencyRoomChargesPosting",messageId:"",destination:"com.napier.core.scm.serviceposting.service.external.ServicePostingService",message:o},a.sendRestRequest(s).then(function(e){i.resolve(e)}),i.promise},this.createVisitAndOrders=function(t,i,o,s,n,c,l,p){var d,m,u,v,S,y=e.defer(),D=moment().format("YYYY-MM-DD")+"T"+moment().format("HH:mm:ss.SSS")+"Z";if(n.opSearch&&2==n.opSearch.type){var g=n.tempPatForm;S="createTmpRegistrationVisitAndOrders";var A=moment(g.new.dob).format("YYYY-MM-DD")+"T"+moment(g.new.dob).format("HH:mm:ss.SSS")+"Z";if(g.OPVMaddPatientDetailsAge)var I=g.OPVMaddPatientDetailsAge.split(" ");var P=g.new.age;if(-1!==I[0].indexOf("y")&&(P=I[0].split("y").join("")+" yrs"),P){var h=P.split("y");h=h[0].trim()}var R={"@class":"com.napier.core.service.vo.registration.Registration",patient:{"@class":"com.napier.core.service.vo.registration.Patient",status:{"@class":"com.napier.core.service.vo.masters.GeneralMaster",type:"GN_STATUS",code:1,description:"Active"},title:{"@class":"com.napier.core.service.vo.masters.SalutationMaster",code:g.title},firstName:g.firstName,middleName:"",lastName:g.lastName,age:h,mobileNo:g.mobileNumber,emailId:g.emailId,date:moment().format("YYYY-MM-DD")+"T"+moment().format("HH:mm:ss.SSS")+"Z",dateOfBirth:A,sex:{"@class":"com.napier.core.service.vo.masters.GenderMaster",code:g.gender},facilityId:{"@class":"com.napier.core.service.vo.masters.FacilityMaster",code:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,description:JSON.parse(sessionStorage.userContextObj).FACILITY},typeOfReg:{"@class":"com.napier.core.service.vo.masters.GeneralMaster",type:"Registration Type",code:2,description:"Temporary Registration"}}}}else S=n.updateCont?"updateVisitAndOrders":"createVisitAndOrders";if(i.vistPayer&&i.vistPayer.PINS_SEQ_ID)var f=i.vistPayer.PINS_SEQ_ID;var T,C={},b=[];if(n.opSearch&&2==n.opSearch.type);else for(var E=s.map(function(e){return e.payPrioritySeqId?e.payPrioritySeqId:e.payerNameId}).indexOf(parseInt(f)),q=1,O=0;O<s.length;O++)O!=E&&(q+=1),C={"@class":"com.napier.core.service.vo.visitmanagement.PayerDetailsVo",payPrioritySeqId:s[O].payPrioritySeqId?parseInt(s[O].payPrioritySeqId):void 0,payerNameId:parseInt(s[O].payerNameId),payPriority:O==E?1:q},b.push(C);if(!i.OPVMreferedBy||""!=i.OPVMreferedBy1&&void 0!==i.OPVMreferedBy1?i.OPVMreferedBy1&&i.OPVMreferedBy1:(m=i.OPVMreferedBy.gQDataCode,u=i.OPVMreferedBy.gQDataName),n.RowsArr&&n.RowsArr.length>0){var L,V,N,_,w,M,F,B,x,G,U,Q,k,H,j,Y,W,$,z,J,Z,K=[],X=new Date,ee=moment(X).format("YYYY-MM-DD HH:mm:ss.SSS").split("+")[0]+"Z",te={},re=(sessionStorage.getItem("orderEncounterNo"),sessionStorage.getItem("orderregSeqId"),3),ae=!1,ie="",oe=1,se=0,ne=0,ce=0,le=!!n.projSpecApplicable&&n.projSpecApplicable,pe=void 0,de=void 0,me=void 0;if(n.regTypeData&&n.regTypeData.encounterType&&3==n.regTypeData.encounterType)var ue=3;else ue=2;n.packageServicesArrayObejct=[];for(var ve=0;ve<n.RowsArr.length;ve++){var Se=2,ye="",De=n.RowsArr[ve][0].serviceTypeCODE;z=n.RowsArr[ve][0].fromTariffRate,Z=void 0;var ge=null==n.RowsArr[ve][0].isPharmacyService||"Pharmacy Issues"!=n.RowsArr[ve][0].isPharmacyService&&"Pharmacy Retruns"!=n.RowsArr[ve][0].isPharmacyService?"N":"Y";1==De?(2==n.RowsArr[ve][0].gnServDesign&&(Se=1,re=3,ae=!0,ye=n.RowsArr[ve][0].isPrintToBill,n.RowsArr[ve][0].packageServicesList&&(n.packageServicesArrayObejct=n.packageServicesArrayObejct.concat(n.RowsArr[ve][0].packageServicesList))),N=n.RowsArr[ve][0].servicePostingSeqId,_=n.RowsArr[ve][0].servSeqId,w=n.RowsArr[ve][0].requestedByEmpSeqID,M=n.RowsArr[ve][0].requestedByEmpName,F=n.RowsArr[ve][0].requestedByEmpType,B=n.RowsArr[ve][0].quantity,x="Y"!=ge||null!=n.RowsArr[ve][0].baseRate&&0!=n.RowsArr[ve][0].baseRate?n.RowsArr[ve][0].baseRate:n.RowsArr[ve][0].serviceRate,n.RowsArr[ve][0].gnFlow,G=n.RowsArr[ve][0].facilityId,U=n.RowsArr[ve][0].serviceRate,Q="Y"!=ge||null!=n.RowsArr[ve][0].actualRate&&0!=n.RowsArr[ve][0].actualRate?n.RowsArr[ve][0].actualRate:n.RowsArr[ve][0].serviceRate,W=n.RowsArr[ve][0].technicianAmount,k=n.RowsArr[ve][0].doctorAmount,H=n.RowsArr[ve][0].proposedShareAfterDiscount,null!=n.RowsArr[ve][0].preAuthDone?n.RowsArr[ve][0].patientAmount:null!=n.RowsArr[ve][0].originalPayerAmount?parseFloat(n.RowsArr[ve][0].originalPayerAmount)>n.RowsArr[ve][0].actualRate?parseFloat(0):n.RowsArr[ve][0].actualRate-parseFloat(n.RowsArr[ve][0].originalPayerAmount):n.RowsArr[ve][0].patientAmount,null!=n.RowsArr[ve][0].preAuthDone?n.RowsArr[ve][0].originalPayerAmount:null!=n.RowsArr[ve][0].originalPayerAmount?parseFloat(n.RowsArr[ve][0].originalPayerAmount)>n.RowsArr[ve][0].actualRate?n.RowsArr[ve][0].actualRate:n.RowsArr[ve][0].originalPayerAmount:n.RowsArr[ve][0].payerAmount,j=n.RowsArr[ve][0].discountAmt,Y=n.RowsArr[ve][0].doctorShare,W=n.RowsArr[ve][0].technicianAmount,$=n.RowsArr[ve][0].payerTypeCode,ie=n.RowsArr[ve][0].appointReason,oe=n.RowsArr[ve][0].transType,se=n.RowsArr[ve][0].proposedShare,ne=n.RowsArr[ve][0].billedShare,ce=n.RowsArr[ve][0].employeeShareSeqId,J=n.RowsArr[ve][0].grpMstCode?n.RowsArr[ve][0].grpMstCode:void 0,pe=n.RowsArr[ve][0].priServTypCode,de=n.RowsArr[ve][0].deptCode,me=n.RowsArr[ve][0].specilityCode,Z=n.RowsArr[ve][0].preAuthDone,L=n.RowsArr[ve][0].updateServiceFlag,V=n.RowsArr[ve][0].doctorModifiedAmount):null!=n.serviceTypeModel.serviceType&&108==n.serviceTypeModel.serviceType.CODE||(2==n.RowsArr[ve][0].gnServDesign&&(Se=1,re=3,ae=!0,ye=n.RowsArr[ve][0].isPrintToBill,n.RowsArr[ve][0].packageServicesList&&(n.packageServicesArrayObejct=n.packageServicesArrayObejct.concat(n.RowsArr[ve][0].packageServicesList))),N=n.RowsArr[ve][0].servicePostingSeqId,_=n.RowsArr[ve][0].servSeqId,w=n.RowsArr[ve][0].requestedByEmpSeqID,M=n.RowsArr[ve][0].requestedByEmpName,F=n.RowsArr[ve][0].requestedByEmpType,B=n.RowsArr[ve][0].quantity,x="Y"!=ge||null!=n.RowsArr[ve][0].baseRate&&0!=n.RowsArr[ve][0].baseRate?n.RowsArr[ve][0].baseRate:n.RowsArr[ve][0].serviceRate,n.RowsArr[ve][0].gnFlow,G=n.RowsArr[ve][0].facilityId,U=n.RowsArr[ve][0].serviceRate,Q=null==n.RowsArr[ve][0].actualRate?n.RowsArr[ve][0].serviceRate:"Y"!=ge||null!=n.RowsArr[ve][0].actualRate&&0!=n.RowsArr[ve][0].actualRate?n.RowsArr[ve][0].actualRate:n.RowsArr[ve][0].serviceRate,W=n.RowsArr[ve][0].technicianAmount,k=n.RowsArr[ve][0].doctorAmount,H=n.RowsArr[ve][0].proposedShareAfterDiscount,null!=n.RowsArr[ve][0].preAuthDone?parseFloat(n.RowsArr[ve][0].originalPayerAmount)>Q?parseFloat(0):Q-parseFloat(n.RowsArr[ve][0].originalPayerAmount):n.RowsArr[ve][0].patientAmount,null!=n.RowsArr[ve][0].preAuthDone?parseFloat(n.RowsArr[ve][0].originalPayerAmount)>Q?Q:n.RowsArr[ve][0].originalPayerAmount:n.RowsArr[ve][0].payerAmount,j=n.RowsArr[ve][0].discountAmt,Y=n.RowsArr[ve][0].doctorShare,W=n.RowsArr[ve][0].technicianAmount,$=n.RowsArr[ve][0].payerTypeCode,ie=n.RowsArr[ve][0].appointReason,oe=n.RowsArr[ve][0].transType,se=n.RowsArr[ve][0].proposedShare,ne=n.RowsArr[ve][0].billedShare,ce=n.RowsArr[ve][0].employeeShareSeqId,J=n.RowsArr[ve][0].grpMstCode?n.RowsArr[ve][0].grpMstCode:void 0,pe=n.RowsArr[ve][0].priServTypCode,de=n.RowsArr[ve][0].deptCode,me=n.RowsArr[ve][0].specilityCode,Z=n.RowsArr[ve][0].preAuthDone,L=n.RowsArr[ve][0].updateServiceFlag,V=n.RowsArr[ve][0].doctorModifiedAmount);var Ae=n.RowsArr[ve][0].servicePostingType?n.RowsArr[ve][0].servicePostingType:1;if(null!=N){var Ie={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",updateServicePostingFlag:!L&&void 0,servicePostingSeqId:N,isPharmacyService:ge,accSeqId:sessionStorage.getItem("accountseqId")?sessionStorage.getItem("accountseqId"):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0,servicePostingType:Ae,isPackage:Se,packApplyType:re,specific:le,parentServSeqId:1==Se?_:void 0,lbSeqId:n.RowsArr[ve][0].lbSeqId?n.RowsArr[ve][0].lbSeqId:void 0,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:_},requestedByEmpSeqID:w,requestedByEmpName:M,requestedByEmpType:F,requestedDateTime:ee,quantity:B,isPostBillApplicable:n.RowsArr[ve][0].isPostBillApplicable?n.RowsArr[ve][0].isPostBillApplicable:0,primaryServiceCode:pe,specilityCode:me,deptCode:de,serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:_,baseRate:x,tariffSeqId:n.RowsArr[ve][0].payerTarrifId?n.RowsArr[ve][0].payerTarrifId:p.tariffSeqId?p.tariffSeqId:void 0,datedOn:ee,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},enNo:sessionStorage.getItem("ordervisitId")?sessionStorage.getItem("ordervisitId"):void 0,enSeqId:sessionStorage.getItem("orderencounterSeqId")?sessionStorage.getItem("orderencounterSeqId"):void 0,patientCategoryCode:sessionStorage.getItem("patcatg"),facilityId:G,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnTranStatus:3==Ae?2:1,gnFlow:ue,surcharge:0,serviceRate:U,baseRate:x,actualRate:Q,currentChargableAmt:parseFloat(parseFloat(Q/B).toFixed(2)),technicianAmount:W,doctorAmount:k,proposedShareAfterDiscount:H,doctorModifiedAmount:V||0,chargeableAmt:parseFloat(parseFloat(Q/B).toFixed(2)),nonChargableAmt:void 0,companyNonPayingAmt:N?Z?n.RowsArr[ve][0].originalPatientAmount:n.RowsArr[ve][0].patientAmount:void 0,companyPayingAmt:N?Z?n.RowsArr[ve][0].originalPayerAmount:n.RowsArr[ve][0].payerAmount:void 0,discountAmt:j,doctorShare:Y,isEmergency:2,renderFlagcheck:!0,payerId:$,insurancePlanSeqId:null!=n.RowsArr[ve][0].insurancePlanSeqId&&null!=n.RowsArr[ve][0].insurancePlanSeqId?n.RowsArr[ve][0].insurancePlanSeqId:void 0,refTranSeqID:n.RowsArr[ve][0].lbSeqId?n.RowsArr[ve][0].lbSeqId:n.RowsArr[ve][0].refTranSeqID,fromOPVisit:"Y",priority:n.RowsArr[ve][0].visitTypeCode,isPrintToBill:ye,visitConfigOrRateCard:z,opApmntSeqId:n.RowsArr[ve][0].opApmntSeqId?n.RowsArr[ve][0].opApmntSeqId:void 0,appointReason:ie,transType:oe,multiEmployeeShareList:{"@class":"com.napier.core.scm.serviceposting.vo.EmployeeShareListVo",employeeShareList:[{"com.napier.core.scm.serviceposting.vo.EmployeeShareVo":[{"@class":"com.napier.core.scm.serviceposting.vo.EmployeeShareVo",employee:{category:"001",code:M,empSeqId:w,facilityId:angular.fromJson(sessionStorage.userContextObj).FACILITY_ID,gnStatus:1},entityType:2,employeeShareSeqId:ce,billedShare:ne,proposedShare:se,gnTranStatus:1,grpMstCode:J||void 0}]}]}};K.push(Ie)}else{Ie={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",updateServicePostingFlag:!1,servicePostingSeqId:N,isPharmacyService:ge,accSeqId:sessionStorage.getItem("accountseqId")?sessionStorage.getItem("accountseqId"):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0,servicePostingType:1,isPackage:Se,packApplyType:re,specific:le,parentServSeqId:1==Se?_:void 0,lbSeqId:n.RowsArr[ve][0].lbSeqId?n.RowsArr[ve][0].lbSeqId:void 0,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:_},requestedByEmpSeqID:w,requestedByEmpName:M,requestedByEmpType:F,requestedDateTime:ee,quantity:B,isPostBillApplicable:n.RowsArr[ve][0].isPostBillApplicable?n.RowsArr[ve][0].isPostBillApplicable:0,primaryServiceCode:pe,specilityCode:me,deptCode:de,serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:_,baseRate:x,tariffSeqId:n.RowsArr[ve][0].payerTarrifId?n.RowsArr[ve][0].payerTarrifId:p.tariffSeqId?p.tariffSeqId:void 0,datedOn:ee,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},enNo:sessionStorage.getItem("ordervisitId")?sessionStorage.getItem("ordervisitId"):void 0,enSeqId:sessionStorage.getItem("orderencounterSeqId")?sessionStorage.getItem("orderencounterSeqId"):void 0,patientCategoryCode:sessionStorage.getItem("patcatg"),facilityId:G,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnTranStatus:1,gnFlow:ue,surcharge:0,serviceRate:U,baseRate:x,actualRate:Q,currentChargableAmt:parseFloat(parseFloat(Q/B).toFixed(2)),technicianAmount:W,doctorAmount:k,proposedShareAfterDiscount:H,doctorModifiedAmount:V||0,chargeableAmt:parseFloat(parseFloat(Q/B).toFixed(2)),companyNonPayingAmt:N?Z?n.RowsArr[ve][0].originalPatientAmount:n.RowsArr[ve][0].patientAmount:void 0,companyPayingAmt:N?Z?n.RowsArr[ve][0].originalPayerAmount:n.RowsArr[ve][0].payerAmount:void 0,nonChargableAmt:void 0,discountAmt:j,doctorShare:Y,isEmergency:2,renderFlagcheck:!0,payerId:$,insurancePlanSeqId:null!=n.RowsArr[ve][0].insurancePlanSeqId&&null!=n.RowsArr[ve][0].insurancePlanSeqId?n.RowsArr[ve][0].insurancePlanSeqId:void 0,refTranSeqID:n.RowsArr[ve][0].lbSeqId?n.RowsArr[ve][0].lbSeqId:n.RowsArr[ve][0].refTranSeqID,fromOPVisit:"Y",priority:n.RowsArr[ve][0].visitTypeCode,isPrintToBill:ye,visitConfigOrRateCard:z,opApmntSeqId:n.RowsArr[ve][0].opApmntSeqId?n.RowsArr[ve][0].opApmntSeqId:void 0,appointReason:ie,transType:oe,multiEmployeeShareList:{"@class":"com.napier.core.scm.serviceposting.vo.EmployeeShareListVo",employeeShareList:[{"com.napier.core.scm.serviceposting.vo.EmployeeShareVo":[{"@class":"com.napier.core.scm.serviceposting.vo.EmployeeShareVo",employee:{category:"001",code:M,empSeqId:w,facilityId:angular.fromJson(sessionStorage.userContextObj).FACILITY_ID,gnStatus:1},entityType:2,billedShare:ne,proposedShare:se,gnTranStatus:1,grpMstCode:J||void 0}]}]}};K.push(Ie)}}if(ae){for(var Pe=0;Pe<n.packageServicesArrayObejct.length;Pe++){Ie={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",updateServicePostingFlag:!1,servicePostingSeqId:n.packageServicesArrayObejct[Pe].servicePostingSeqId,isPharmacyService:ge,accSeqId:sessionStorage.getItem("accountseqId")?sessionStorage.getItem("accountseqId"):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0,servicePostingType:n.packageServicesArrayObejct[Pe].servicePostingType?n.packageServicesArrayObejct[Pe].servicePostingType:1,specific:le,isPackage:n.packageServicesArrayObejct[Pe].isPackage,packApplyType:n.packageServicesArrayObejct[Pe].packApplyType,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:n.packageServicesArrayObejct[Pe].servSeqId},requestedByEmpSeqID:n.packageServicesArrayObejct[Pe].requestedByEmpSeqID,requestedByEmpName:n.packageServicesArrayObejct[Pe].requestedByEmpName,requestedByEmpType:n.packageServicesArrayObejct[Pe].requestedByEmpType,requestedDateTime:ee,quantity:B,isPostBillApplicable:n.packageServicesArrayObejct[Pe].isPostBillApplicable?n.packageServicesArrayObejct[Pe].isPostBillApplicable:0,primaryServiceCode:pe,specilityCode:me,deptCode:de,serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:n.packageServicesArrayObejct[Pe].servSeqId,baseRate:n.packageServicesArrayObejct[Pe].baseRate,tariffSeqId:n.packageServicesArrayObejct[Pe].tariffSeqId?n.packageServicesArrayObejct[Pe].tariffSeqId:p.tariffSeqId?p.tariffSeqId:void 0,datedOn:ee,fromOPVisit:"Y",doctSeqId:n.packageServicesArrayObejct[Pe].requestedByEmpSeqID,specSeqId:n.packageServicesArrayObejct[Pe].specilityCode?n.packageServicesArrayObejct[Pe].specilityCode:void 0},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},enNo:sessionStorage.getItem("ordervisitId")?sessionStorage.getItem("ordervisitId"):void 0,enSeqId:sessionStorage.getItem("orderencounterSeqId")?sessionStorage.getItem("orderencounterSeqId"):void 0,patientCategoryCode:sessionStorage.getItem("patcatg"),facilityId:n.packageServicesArrayObejct[Pe].facilityId,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnTranStatus:1,gnFlow:ue,surcharge:0,serviceRate:n.packageServicesArrayObejct[Pe].serviceRate,baseRate:n.packageServicesArrayObejct[Pe].baseRate,actualRate:n.packageServicesArrayObejct[Pe].actualRate,currentChargableAmt:parseFloat(parseFloat(n.packageServicesArrayObejct[Pe].actualRate/B).toFixed(2)),technicianAmount:n.packageServicesArrayObejct[Pe].technicianAmount,doctorAmount:n.packageServicesArrayObejct[Pe].doctorAmount,proposedShareAfterDiscount:n.packageServicesArrayObejct[Pe].proposedShareAfterDiscount,doctorModifiedAmount:V||0,chargeableAmt:n.packageServicesArrayObejct[Pe].patientAmount,nonChargableAmt:n.packageServicesArrayObejct[Pe].payerAmount,discountAmt:n.packageServicesArrayObejct[Pe].discountAmt,doctorShare:n.packageServicesArrayObejct[Pe].doctorShare,isEmergency:2,renderFlagcheck:!0,payerId:n.packageServicesArrayObejct[Pe].payerTypeCode,insurancePlanSeqId:null!=n.packageServicesArrayObejct[Pe].insurancePlanSeqId&&null!=n.packageServicesArrayObejct[Pe].insurancePlanSeqId?n.packageServicesArrayObejct[Pe].insurancePlanSeqId:void 0,fromOPVisit:"Y",priority:n.packageServicesArrayObejct[Pe].visitTypeCode,isPrintToBill:"",visitConfigOrRateCard:z,appointReason:n.packageServicesArrayObejct[Pe].appointReason,transType:n.packageServicesArrayObejct[Pe].transType,parentServSeqId:n.packageServicesArrayObejct[Pe].parentServSeqId,multiEmployeeShareList:{"@class":"com.napier.core.scm.serviceposting.vo.EmployeeShareListVo",employeeShareList:[{"com.napier.core.scm.serviceposting.vo.EmployeeShareVo":[{"@class":"com.napier.core.scm.serviceposting.vo.EmployeeShareVo",employee:{category:"001",empSeqId:n.packageServicesArrayObejct[Pe].docempSeqId?n.packageServicesArrayObejct[Pe].docempSeqId:n.packageServicesArrayObejct[Pe].requestedByEmpSeqID},entityType:2,billedShare:n.packageServicesArrayObejct[Pe].billedShare,proposedShare:n.packageServicesArrayObejct[Pe].proposedShare,gnTranStatus:1,grpMstCode:n.packageServicesArrayObejct[Pe].grpMstCode?n.packageServicesArrayObejct[Pe].grpMstCode:void 0}]}]}};K.push(Ie)}for(var he=0;he<n.retrivePackageDeletedServObj.length;he++){Ie={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo",updateServicePostingFlag:!1,servicePostingSeqId:n.retrivePackageDeletedServObj[he].servicePostingSeqId,isPharmacyService:ge,accSeqId:sessionStorage.getItem("accountseqId")?sessionStorage.getItem("accountseqId"):void 0,subAccSeqId:sessionStorage.getItem("subaccountseqId")?sessionStorage.getItem("subaccountseqId"):void 0,servicePostingType:n.retrivePackageDeletedServObj[0].servicePostingType?n.retrivePackageDeletedServObj[0].servicePostingType:1,specific:le,isPackage:n.packageServicesArrayObejct[0].isPackage,packApplyType:n.packageServicesArrayObejct[0].packApplyType,serviceVo:{"@class":"com.napier.core.scm.master.vo.ServiceVo",servSeqId:n.retrivePackageDeletedServObj[he].INCL_SERV_SEQ_ID},requestedByEmpSeqID:n.retrivePackageDeletedServObj[he].serviceDoc,requestedByEmpType:4,requestedDateTime:ee,quantity:B,isPostBillApplicable:n.retrivePackageDeletedServObj[he].isPostBillApplicable?n.retrivePackageDeletedServObj[he].isPostBillApplicable:0,primaryServiceCode:pe,specilityCode:me,deptCode:de,serviceRateVo:{"@class":"com.napier.core.service.vo.ratecard.ServiceRateVo",servSeqId:n.retrivePackageDeletedServObj[he].INCL_SERV_SEQ_ID,baseRate:n.retrivePackageDeletedServObj[he].INCL_AMOUNT,tariffSeqId:p.tariffSeqId?p.tariffSeqId:void 0,datedOn:ee,fromOPVisit:"Y"},encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",enAmbultryStatus:0,enProvider:0,enSpeciality:0,isAddendum:!1},enNo:sessionStorage.getItem("ordervisitId")?sessionStorage.getItem("ordervisitId"):void 0,enSeqId:sessionStorage.getItem("orderencounterSeqId")?sessionStorage.getItem("orderencounterSeqId"):void 0,patientCategoryCode:sessionStorage.getItem("patcatg"),facilityId:n.retrivePackageDeletedServObj[he].facilityId,practiceId:angular.fromJson(sessionStorage.userContextObj).CLIENT_REF_ID,gnTranStatus:2,gnFlow:ue,surcharge:0,serviceRate:n.retrivePackageDeletedServObj[he].INCL_AMOUNT,baseRate:n.retrivePackageDeletedServObj[he].INCL_AMOUNT,actualRate:n.retrivePackageDeletedServObj[he].INCL_AMOUNT,chargeableAmt:n.retrivePackageDeletedServObj[he].INCL_AMOUNT,currentChargableAmt:parseFloat(parseFloat(n.retrivePackageDeletedServObj[he].INCL_AMOUNT).toFixed(2)),isEmergency:2,renderFlagcheck:!0,payerId:n.packageServicesArrayObejct[0].payerTypeCode,fromOPVisit:"Y",priority:n.packageServicesArrayObejct[0].visitTypeCode,isPrintToBill:"",visitConfigOrRateCard:z,parentServSeqId:n.retrivePackageDeletedServObj[he].parentSeqId};K.push(Ie)}}K.length>0&&(T={"@class":"com.napier.core.scm.serviceposting.vo.ServicePostingVo",servicePostingDetailsList:[{"com.napier.core.scm.serviceposting.vo.ServicePostingDetailsVo":K}]})}if(l)var Re={"@class":"com.napier.core.service.vo.registration.Registration",rgSeqId:l};if(n.patCatCode)var fe={"@class":"com.napier.core.service.vo.masters.PatientCategory",code:n.patCatCode,patCatSeqId:n.patCatSeqId};0==t.OPVMmlcDetails||void 0===t.OPVMmlcDetails?d="n":(d="y",v={"@class":"com.napier.core.service.vo.visitmanagement.MLCDetailsVo",mlcDetailsId:n.mlcDetailsId?n.mlcDetailsId:void 0,mlcNo:t.OPVMmlcNo,accidentReportNo:t.OPVMaccidentReportNo,policeStationName:t.OPVMinformedPoliceStation,policeName:t.OPVMpolicePersonnelName,remarks:t.OPCMremark,mlcTypeId:t.OPVMmlcType});var Te={"@class":"com.napier.core.service.vo.visitmanagement.OPVisitmanagementVo",registration:R||void 0,encounter:{"@class":"com.napier.core.service.vo.visitmanagement.Encounter",hscSpec:sessionStorage.getItem("productCustomization")?sessionStorage.getItem("productCustomization"):void 0,enSeqId:n.enSeqId,enSpeciality:o.OPVMselectDoctor.SPECIALITY_CODE,createdDate:D,refAgentSeqId:n.agent&&n.agent.hscAgent?n.agent.hscAgent.REFERRAL_AGENT_SEQ_ID:void 0,strReasonForVisit:i.OPVMvisitType,enIsInternalExternalDoc:i.internalorext,doctorMaster:{"@class":"com.napier.core.service.vo.masters.DoctorMaster",doctSeqId:o.OPVMselectDoctor.DOCTID,doctName:o.OPVMselectDoctor.DOCTNAME},refDoctorMaster:{"@class":"com.napier.core.service.vo.masters.DoctorMaster",doctSeqId:m,doctName:u},encounterGnStatusMaster:{"@class":"com.napier.core.service.vo.masters.GeneralMaster",code:1},machineIp:JSON.parse(sessionStorage.userContextObj).WORKSTATION,facilityMaster:{"@class":"com.napier.core.service.vo.masters.FacilityMaster",code:"1"},enIsMlc:d,mlcDetailsVo:v,napierDocument:{"@class":"com.napier.core.service.vo.uploadfile.NapierDocument",facilityId:JSON.parse(sessionStorage.userContextObj).FACILITY_ID,docName:c&&t.docName?t.docName:void 0,uploadDocumnt:c,status:"1",createdBy:JSON.parse(sessionStorage.userContextObj).USER_SEQ_ID,createdDate:D,context:15,docTypeSeqId:36,machineIp:JSON.parse(sessionStorage.userContextObj).WORKSTATION,referenceId:n.enSeqId,contextDetailMaster:{"@class":"com.napier.core.service.vo.uploadfile.ContextDetailMaster",code:24}},registraiion:Re||void 0,patientCategory:fe||void 0,enNo:i.OPVMepisodeNo,encounterTypeMaster:{"@class":"com.napier.core.service.vo.masters.GeneralMaster",code:1},episode:{"@class":"com.napier.core.service.vo.visitmanagement.Episode",epSeqId:i.epSeqId?i.epSeqId:void 0,epDescription:i.OPVMepisodeDescription},payerDetailsVoLst:[{"com.napier.core.service.vo.visitmanagement.PayerDetailsVo":b}]},servicePostingVo:T};return(te={}).url=r.GBBILLGENERATION.URL,te.requestData={operation:S,messageId:"",destination:"eneservice",message:Te},a.sendRestRequest(te).then(function(e){y.resolve(e)}),y.promise}}e.$inject=["$q","BILLING_APIS","OPVISIT_MGMT_APIS","CallManager"],angular.module("napierContainerUi").service("opVisitMgtServiceNew",e)}(),function(){"use strict";angular.module("napierContainerUi").constant("BATransactionGrid",{enableCellEditOnFocus:!0,enableRowSelection:!1,enableFullRowSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableSorting:!1,enableHorizontalScrollbar:1,columnDefs:[{name:"tranType",displayName:"Transaction Type",headerCellFilter:"translate",width:120,cellTemplate:'<div><select class="form-control" name="tranType" ng-model="row.entity.tranType" ng-options="int.CODE as int.DESCRIPTION for int in grid.appScope.transTypeObj" ng-change="grid.appScope.changeRatesByTranType(row.entity);"><option value="">Select</option></select></div>'},{name:"serviceRate",displayName:"Service Rate",headerCellFilter:"translate",width:"*",cellTemplate:'<div style="padding:5px;text-align:right;">{{row.entity.serviceRate}}</div>'},{name:"discount",displayName:"Discount",headerCellFilter:"translate",width:80,cellTemplate:'<div style="padding:5px;text-align:right;">{{row.entity.discount}}</div>'},{name:"taxAmt",displayName:"Tax",headerCellFilter:"translate",width:50,cellTemplate:'<div style="padding:5px;text-align:right;">{{row.entity.taxAmt}}</div>'},{name:"docAmount",displayName:"Doc Amt",headerCellFilter:"translate",width:"*",cellTemplate:'<div style="padding:5px;text-align:right;">{{row.entity.docAmount}}</div>'},{name:"modAmount",displayName:"Doc Modified Amt",headerCellFilter:"translate",width:140,cellTemplate:'<div><input type="text" class="form-control" name="modAmount" ng-model="row.entity.modAmount" style="border: 1px solid #ccccc !important; margin:0px;text-align:right;" onkeypress="return event.charCode > 47 && event.charCode < 58" ng-disabled="row.entity.tranType!=2" ng-blur="grid.appScope.changeRatesByTranType(row.entity,true);"></div>'},{name:"docShare",displayName:"Doc Share",headerCellFilter:"translate",width:"*",cellTemplate:'<div style="padding:5px;text-align:right;">{{row.entity.docShare}}</div>'},{name:"hospShare",displayName:"Hospital Share",headerCellFilter:"translate",width:120,cellTemplate:'<div style="padding:5px;text-align:right;">{{row.entity.hospShare}}</div>'},{name:"surcharge",displayName:"Surcharge",headerCellFilter:"translate",width:"*",cellTemplate:'<div style="padding:5px;text-align:right;">{{row.entity.surcharge}}</div>'}]}),angular.module("napierContainerUi").constant("BATransactionGridView",{enableCellEditOnFocus:!0,enableRowSelection:!1,enableFullRowSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableSorting:!1,enableHorizontalScrollbar:1,columnDefs:[{name:"tranType",displayName:"Transaction Type",headerCellFilter:"translate",width:180},{name:"docAmount",displayName:"Doctor Amt",headerCellFilter:"translate",width:"*"},{name:"modAmount",displayName:"Doctor Modified Amt",headerCellFilter:"translate",width:150},{name:"docShare",displayName:"Doctor Share",headerCellFilter:"translate",width:"*"},{name:"hospShare",displayName:"Hospital Share",headerCellFilter:"translate",width:120},{name:"techShare",displayName:"Technician Share",headerCellFilter:"translate",width:120},{name:"surcharge",displayName:"Surcharge",headerCellFilter:"translate",width:"*"}]})}(),function(){"use strict";angular.module("napierContainerUi").constant("opVisitMgtGridFooterDef",{columnDefs:[{name:"Service Type",enableSorting:!0,enableCellEdit:!1,width:100},{name:"Service",enableSorting:!0,enableCellEdit:!1,width:150},{name:"Visit Type Priority",enableSorting:!0,enableCellEdit:!1,width:150},{name:"Doctor",enableSorting:!0,enableCellEdit:!1,width:100},{name:"Payer",enableSorting:!0,enableCellEdit:!1,width:50},{name:"Amount",enableSorting:!0,enableCellEdit:!1,width:100},{name:"Price",enableSorting:!0,enableCellEdit:!1,width:150},{name:"Quantity",enableSorting:!1,enableCellEdit:!1,enableFiltering:!1,cellTemplate:'<div class="actionRow" ><i class="fa fa-pencil"></i> <i class="fa fa-trash"></i></div>',width:150},{name:"Patient Amt",enableSorting:!1,enableCellEdit:!1,enableFiltering:!1,cellTemplate:'<div class="actionRow" ><i class="fa fa-pencil"></i> <i class="fa fa-trash"></i></div>',width:150},{name:"Contractual Adj",enableSorting:!1,enableCellEdit:!1,enableFiltering:!1,cellTemplate:'<div class="actionRow" ><i class="fa fa-pencil"></i> <i class="fa fa-trash"></i></div>',width:150},{name:"Payer Amt",enableSorting:!1,enableCellEdit:!1,enableFiltering:!1,cellTemplate:'<div class="actionRow" ><i class="fa fa-pencil"></i> <i class="fa fa-trash"></i></div>',width:150}]})}(),function(){"use strict";angular.module("napierContainerUi").constant("opVisitDoctorSearchGrid",{enableCellEditOnFocus:!0,enableRowSelection:!0,enableFullRowSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableSorting:!1,enableHorizontalScrollbar:1,columnDefs:[{name:"radio_row",displayName:"",width:20,headerCellTemplate:"<div><div>",cellTemplate:'<div class="ngSelectionCell selector-group"><label class="radio-inline"><input ng-init="releaseAction=0" type="radio" name="rdUserList" ng-value="true"  ng-model="releaseAction" ng-click="grid.appScope.advSearchRowClickDoc(row)"></label></div>'},{displayName:"opvm.DoctorName",headerCellFilter:"translate",field:"Doctorname",minWidth:150},{displayName:"opvm.DoctorID",headerCellFilter:"translate",field:"DoctorID",minWidth:150},{displayName:"opvm.Speciality",headerCellFilter:"translate",field:"Speciality",minWidth:150}]})}(),function(){"use strict";angular.module("napierContainerUi").constant("opVisitExternalDoctorSearchGrid",{enableCellEditOnFocus:!0,enableRowSelection:!0,enableFullRowSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableSorting:!1,enableHorizontalScrollbar:1,columnDefs:[{name:"radio_row",displayName:"",width:20,headerCellTemplate:"<div><div>",cellTemplate:'<div class="ngSelectionCell"><input ng-init="releaseAction=0" type="radio" name="rdUserList" ng-value="true"  ng-model="releaseAction" ng-click="grid.appScope.advSearchRowClickExtDoc(row)"></div>'},{displayName:"opvm.specialityCentreName",headerCellFilter:"translate",field:"refFacDesc",minWidth:100},{displayName:"opvm.department",headerCellFilter:"translate",field:"deptDesc",minWidth:100},{displayName:"opvm.subDepartment",headerCellFilter:"translate",field:"subDeptDesc",minWidth:100},{displayName:"opvm.employeeName",headerCellFilter:"translate",field:"empName",minWidth:100}]})}(),function(){"use strict";angular.module("napierContainerUi").constant("OPVsithealthCheckUpGrid",{enableCellEditOnFocus:!0,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableRowHeaderSelection:!1,columnDefs:[{displayName:"Item Name",field:"Item_Name"},{displayName:"Quantity",field:"Quantity"}]})}(),function(){"use strict";angular.module("napierContainerUi").constant("opVisitManagementOpenVisitListGrid",{enableCellEditOnFocus:!0,enableRowSelection:!1,enableFullRowSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableSorting:!1,enableHorizontalScrollbar:0,columnDefs:[{name:"radio_row",displayName:"",width:20,cellTemplate:'<div class="ngSelectionCell" ng-init="releaseAction=0"><input type="radio" name="radio_continue" class="radio_continue" id="radio_continue" ng-value="{{grid.renderContainers.body.visibleRowCache.indexOf(row)}}"  ng-model="releaseAction" /></div>'},{displayName:"opvm.episodeNotab",headerCellFilter:"translate",field:"EP_NO"},{displayName:"opvm.VisitNotab",headerCellFilter:"translate",field:"VISIT_NO"},{displayName:"opvm.Doctor",headerCellFilter:"translate",field:"DOCTDESC"},{displayName:"opvm.mlcservices",headerCellFilter:"translate",field:"SERVDESC"}]}).constant("opVisitManagementPendingOrdersGrid",{enableCellEditOnFocus:!0,enableRowSelection:!1,enableFullRowSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableSorting:!1,enableHorizontalScrollbar:0,columnDefs:[{displayName:"opvm.drugOrders",headerCellFilter:"translate",field:"DRUG_NAME",minWidth:200,cellTooltip:function(e,t){return e.entity.DRUG_NAME}},{displayName:"opvm.drugQty",headerCellFilter:"translate",field:"ORDER_QTY"},{displayName:"opvm.issuedQtty",headerCellFilter:"translate",field:"ISSUED_QTY"},{displayName:"opvm.drugStatus",headerCellFilter:"translate",field:"STATUS"}]})}(),function(){"use strict";angular.module("napierContainerUi").constant("OPOrderAdvServiceGrid",{enableCellEditOnFocus:!0,enableRowSelection:!1,enableFullRowSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!0,enableFiltering:!1,enableSorting:!0,enableHorizontalScrollbar:1,columnDefs:[{displayName:"Service Seq Id",field:"SERV_SEQ_ID",visible:!1},{displayName:"Service Type",field:"DESCRIPTION"},{displayName:"Service Name",field:"SERV_NAME"},{displayName:"Service Code",field:"SERV_CODE"},{displayName:"Rate",field:"VALUE"},{displayName:"EFFECTIVE_FROM",field:"EFFECTIVE_FROM",visible:!1},{displayName:"EFFECTIVE_TO",field:"EFFECTIVE_TO",visible:!1},{displayName:"FA_IS_BILLABLE",field:"FA_IS_BILLABLE",visible:!1},{displayName:"Primary Service Type CODE",field:"CODE",visible:!1},{displayName:"Secondary Service Type CODE",field:"SSTCODE",visible:!1},{displayName:"Service Type",field:"SSTDESC",visible:!1}]})}(),function(){"use strict";angular.module("napierContainerUi").constant("OPVsitVisitHistory",{enableExpandableRowHeader:!1,enableCellEditOnFocus:!0,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableRowHeaderSelection:!1,expandableRowTemplate:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-visitHistoryDetails-subGrid.html",columnDefs:[{displayName:" ",field:"VISIT_NO",width:25,cellTemplate:"<div style=\"text-align: right; padding: 3px;\">&nbsp;<span ng-click='grid.api.expandable.toggleRowExpansion(row.entity)'><i class='fa fa-angle-down grid-expandarrow' ng-if=\"!row.isExpanded\"></i><i class='fa fa-angle-up grid-expandarrow' ng-if=\"row.isExpanded\"></i></span></div>"},{displayName:"opvm.VisitNo1",headerCellFilter:"translate",field:"VISIT_NO",cellTemplate:'<div class="form-group padding-5"> &nbsp; <a style="cursor: pointer;" ng-click="grid.appScope.visithistoryvistino(row)"> {{row.entity.VISIT_NO}}</a></div>'},{displayName:"opvm.VisitDate",headerCellFilter:"translate",field:"VISIT_DATE",cellTemplate:'<div class="form-group padding-5">{{row.entity.VISIT_DATE | date:"dd/MM/yyyy"}}</div>'},{displayName:"Doctor",headerCellFilter:"translate",field:"VISIT_TYPE",width:180,cellTemplate:'<div class="form-group padding-5">{{row.entity.DOCTOR_NAME}}, {{row.entity.SPECIALITY}}</div>'},{displayName:"opvm.Charges",headerCellFilter:"translate",field:"CHARGES",cellTemplate:'<div class="form-group padding-5">{{row.entity.CHARGES}}</div>'},{displayName:"opvm.Balance",headerCellFilter:"translate",field:"BALANCE",cellTemplate:'<div class="form-group padding-5">{{row.entity.BALANCE}}</div>'},{displayName:"Visit Status",headerCellFilter:"translate",field:"DESCRIPTION",cellTemplate:'<div class="form-group padding-5"><div ng-if="row.entity.DESCRIPTION != \'Completed\'">Open</div><div ng-if="row.entity.DESCRIPTION == \'Completed\'">Completed</div></div>'}]}).constant("OPVsitVisitHistorySubGrid",{enableCellEditOnFocus:!0,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableRowHeaderSelection:!1,columnDefs:[{displayName:"Service",field:"SERV_NAME",width:250,cellTemplate:"<div class=\"form-group padding-5\" ng-style=\" {'margin-left': row.entity.PACKAGE_SUB ? '10px' : '0PX', 'font-weight': row.entity.PACKAGE_MAIN ? '600' : ''} \">{{row.entity.SERV_CODE? row.entity.SERV_CODE + '-' : ''}}  {{row.entity.SERV_NAME}}</div>"},{displayName:"Order No.",headerCellFilter:"translate",field:"ORDERNO",cellTemplate:"<div class=\"form-group padding-5\" ng-style=\" {'font-weight': row.entity.PACKAGE_MAIN ? '600' : ''} \">{{row.entity.ORDERNO ? row.entity.ORDERNO : \"--\"}}</div>"},{displayName:"Order Date",headerCellFilter:"translate",field:"ORDERDATE",cellTemplate:'<div class="form-group padding-5" ng-style=" {\'font-weight\': row.entity.PACKAGE_MAIN ? \'600\' : \'\'} ">{{row.entity.ORDERDATE | date:"dd/MM/yyyy hh:mm a"}} {{row.entity.ORDERDATE ? "" : "--"}}</div>'},{displayName:"Service Status",headerCellFilter:"translate",field:"TESTSTATUS",cellTemplate:"<div class=\"form-group padding-5\" ng-style=\" {'font-weight': row.entity.PACKAGE_MAIN ? '600' : ''} \">{{row.entity.TESTSTATUS ? row.entity.TESTSTATUS : \"--\"}}</div>"}]})}(),function(){"use strict";angular.module("napierContainerUi").constant("BATransactionGridNew",{enableCellEditOnFocus:!0,enableRowSelection:!1,enableFullRowSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableSorting:!1,enableHorizontalScrollbar:1,columnDefs:[{name:"tranType",displayName:"Transaction Type",headerCellFilter:"translate",width:120,cellTemplate:'<div><select class="form-control" name="tranType" ng-model="row.entity.tranType" ng-options="int.CODE as int.DESCRIPTION for int in grid.appScope.transTypeObj" ng-change="grid.appScope.changeRatesByTranType(row.entity);"><option value="">Select</option></select></div>'},{name:"serviceRate",displayName:"Service Rate",headerCellFilter:"translate",width:"*",cellTemplate:'<div style="padding:5px;text-align:right;">{{row.entity.serviceRate}}</div>'},{name:"discount",displayName:"Discount",headerCellFilter:"translate",width:80,cellTemplate:'<div style="padding:5px;text-align:right;">{{row.entity.discount}}</div>'},{name:"taxAmt",displayName:"Tax",headerCellFilter:"translate",width:50,cellTemplate:'<div style="padding:5px;text-align:right;">{{row.entity.taxAmt}}</div>'},{name:"docAmount",displayName:"Doc Amt",headerCellFilter:"translate",width:"*",cellTemplate:'<div style="padding:5px;text-align:right;">{{row.entity.docAmount}}</div>'},{name:"modAmount",displayName:"Doc Modified Amt",headerCellFilter:"translate",width:140,cellTemplate:'<div><input type="text" class="form-control" name="modAmount" ng-model="row.entity.modAmount" style="border: 1px solid #ccccc !important; margin:0px;text-align:right;" onkeypress="return event.charCode > 47 && event.charCode < 58" ng-disabled="row.entity.tranType!=2" ng-blur="grid.appScope.changeRatesByTranType(row.entity,true);"></div>'},{name:"docShare",displayName:"Doc Share",headerCellFilter:"translate",width:"*",cellTemplate:'<div style="padding:5px;text-align:right;">{{row.entity.docShare}}</div>'},{name:"hospShare",displayName:"Hospital Share",headerCellFilter:"translate",width:120,cellTemplate:'<div style="padding:5px;text-align:right;">{{row.entity.hospShare}}</div>'},{name:"surcharge",displayName:"Surcharge",headerCellFilter:"translate",width:"*",cellTemplate:'<div style="padding:5px;text-align:right;">{{row.entity.surcharge}}</div>'}]}),angular.module("napierContainerUi").constant("BATransactionGridViewNew",{enableCellEditOnFocus:!0,enableRowSelection:!1,enableFullRowSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableSorting:!1,enableHorizontalScrollbar:1,columnDefs:[{name:"tranType",displayName:"Transaction Type",headerCellFilter:"translate",width:180},{name:"docAmount",displayName:"Doctor Amt",headerCellFilter:"translate",width:"*"},{name:"modAmount",displayName:"Doctor Modified Amt",headerCellFilter:"translate",width:150},{name:"docShare",displayName:"Doctor Share",headerCellFilter:"translate",width:"*"},{name:"hospShare",displayName:"Hospital Share",headerCellFilter:"translate",width:120},{name:"techShare",displayName:"Technician Share",headerCellFilter:"translate",width:120},{name:"surcharge",displayName:"Surcharge",headerCellFilter:"translate",width:"*"}]})}(),function(){"use strict";angular.module("napierContainerUi").constant("opVisitMgtGridFooterDefNew",{columnDefs:[{name:"Service Type",enableSorting:!0,enableCellEdit:!1,width:100},{name:"Service",enableSorting:!0,enableCellEdit:!1,width:150},{name:"Visit Type Priority",enableSorting:!0,enableCellEdit:!1,width:150},{name:"Doctor",enableSorting:!0,enableCellEdit:!1,width:100},{name:"Payer",enableSorting:!0,enableCellEdit:!1,width:50},{name:"Amount",enableSorting:!0,enableCellEdit:!1,width:100},{name:"Price",enableSorting:!0,enableCellEdit:!1,width:150},{name:"Quantity",enableSorting:!1,enableCellEdit:!1,enableFiltering:!1,cellTemplate:'<div class="actionRow" ><i class="fa fa-pencil"></i> <i class="fa fa-trash"></i></div>',width:150},{name:"Patient Amt",enableSorting:!1,enableCellEdit:!1,enableFiltering:!1,cellTemplate:'<div class="actionRow" ><i class="fa fa-pencil"></i> <i class="fa fa-trash"></i></div>',width:150},{name:"Contractual Adj",enableSorting:!1,enableCellEdit:!1,enableFiltering:!1,cellTemplate:'<div class="actionRow" ><i class="fa fa-pencil"></i> <i class="fa fa-trash"></i></div>',width:150},{name:"Payer Amt",enableSorting:!1,enableCellEdit:!1,enableFiltering:!1,cellTemplate:'<div class="actionRow" ><i class="fa fa-pencil"></i> <i class="fa fa-trash"></i></div>',width:150}]})}(),function(){"use strict";angular.module("napierContainerUi").constant("opVisitDoctorSearchGridNew",{enableCellEditOnFocus:!0,enableRowSelection:!0,enableFullRowSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableSorting:!1,enableHorizontalScrollbar:1,columnDefs:[{name:"radio_row",displayName:"",width:20,headerCellTemplate:"<div><div>",cellTemplate:'<div class="ngSelectionCell selector-group"><label class="radio-inline"><input ng-init="releaseAction=0" type="radio" name="rdUserList" ng-value="true"  ng-model="releaseAction" ng-click="grid.appScope.advSearchRowClickDoc(row)"></label></div>'},{displayName:"opvm.DoctorName",headerCellFilter:"translate",field:"Doctorname",minWidth:150},{displayName:"opvm.DoctorID",headerCellFilter:"translate",field:"DoctorCode",minWidth:150},{displayName:"opvm.Speciality",headerCellFilter:"translate",field:"Speciality",minWidth:150}]})}(),function(){"use strict";angular.module("napierContainerUi").constant("opVisitExternalDoctorSearchGridNew",{enableCellEditOnFocus:!0,enableRowSelection:!0,enableFullRowSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableSorting:!1,enableHorizontalScrollbar:1,columnDefs:[{name:"radio_row",displayName:"",width:20,headerCellTemplate:"<div><div>",cellTemplate:'<div class="ngSelectionCell"><input ng-init="releaseAction=0" type="radio" name="rdUserList" ng-value="true"  ng-model="releaseAction" ng-click="grid.appScope.advSearchRowClickExtDoc(row)"></div>'},{displayName:"opvm.specialityCentreName",headerCellFilter:"translate",field:"refFacDesc",minWidth:100},{displayName:"opvm.department",headerCellFilter:"translate",field:"deptDesc",minWidth:100},{displayName:"opvm.subDepartment",headerCellFilter:"translate",field:"subDeptDesc",minWidth:100},{displayName:"opvm.employeeName",headerCellFilter:"translate",field:"empName",minWidth:100}]})}(),function(){"use strict";angular.module("napierContainerUi").constant("OPVsithealthCheckUpGridNew",{enableCellEditOnFocus:!0,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableRowHeaderSelection:!1,columnDefs:[{displayName:"Item Name",field:"Item_Name"},{displayName:"Quantity",field:"Quantity"}]})}(),function(){"use strict";angular.module("napierContainerUi").constant("opVisitManagementOpenVisitListGridNew",{enableCellEditOnFocus:!0,enableRowSelection:!1,enableFullRowSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableSorting:!1,enableHorizontalScrollbar:0,columnDefs:[{name:"radio_row",displayName:"",width:20,cellTemplate:'<div class="ngSelectionCell" ng-init="releaseAction=0"><input type="radio" name="radio_continue" class="radio_continue" id="radio_continue" ng-value="{{grid.renderContainers.body.visibleRowCache.indexOf(row)}}"  ng-model="releaseAction" /></div>'},{displayName:"opvm.episodeNotab",headerCellFilter:"translate",field:"EP_NO"},{displayName:"opvm.VisitNotab",headerCellFilter:"translate",field:"VISIT_NO"},{displayName:"opvm.Doctor",headerCellFilter:"translate",field:"DOCTDESC"},{displayName:"opvm.mlcservices",headerCellFilter:"translate",field:"SERVDESC"}]}).constant("opVisitManagementPendingOrdersGrid",{enableCellEditOnFocus:!0,enableRowSelection:!1,enableFullRowSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableSorting:!1,enableHorizontalScrollbar:0,columnDefs:[{displayName:"opvm.drugOrders",headerCellFilter:"translate",field:"DRUG_NAME",minWidth:200,cellTooltip:function(e,t){return e.entity.DRUG_NAME}},{displayName:"opvm.drugQty",headerCellFilter:"translate",field:"ORDER_QTY"},{displayName:"opvm.issuedQtty",headerCellFilter:"translate",field:"ISSUED_QTY"},{displayName:"opvm.drugStatus",headerCellFilter:"translate",field:"STATUS"}]})}(),function(){"use strict";angular.module("napierContainerUi").constant("OPOrderAdvServiceGridNew",{enableCellEditOnFocus:!0,enableRowSelection:!1,enableFullRowSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!0,enableFiltering:!1,enableSorting:!0,enableHorizontalScrollbar:1,columnDefs:[{displayName:"Service Seq Id",field:"SERV_SEQ_ID",visible:!1},{displayName:"Service Type",field:"DESCRIPTION"},{displayName:"Service Name",field:"SERV_NAME"},{displayName:"Service Code",field:"SERV_CODE"},{displayName:"Rate",field:"VALUE"},{displayName:"EFFECTIVE_FROM",field:"EFFECTIVE_FROM",visible:!1},{displayName:"EFFECTIVE_TO",field:"EFFECTIVE_TO",visible:!1},{displayName:"FA_IS_BILLABLE",field:"FA_IS_BILLABLE",visible:!1},{displayName:"Primary Service Type CODE",field:"CODE",visible:!1},{displayName:"Secondary Service Type CODE",field:"SSTCODE",visible:!1},{displayName:"Service Type",field:"SSTDESC",visible:!1}]})}(),function(){"use strict";angular.module("napierContainerUi").constant("OPVsitVisitHistoryNew",{enableExpandableRowHeader:!1,enableCellEditOnFocus:!0,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableRowHeaderSelection:!1,expandableRowTemplate:"app/consumer/his17_1/opVisitManagement/screens/opVisitManagement/templates/op-visit-mgt-visitHistoryDetails-subGrid.html",columnDefs:[{displayName:" ",field:"VISIT_NO",width:25,cellTemplate:"<div style=\"text-align: right; padding: 3px;\">&nbsp;<span ng-click='grid.api.expandable.toggleRowExpansion(row.entity)'><i class='fa fa-angle-down grid-expandarrow' ng-if=\"!row.isExpanded\"></i><i class='fa fa-angle-up grid-expandarrow' ng-if=\"row.isExpanded\"></i></span></div>"},{displayName:"opvm.VisitNo1",headerCellFilter:"translate",field:"VISIT_NO",cellTemplate:'<div class="form-group padding-5"> &nbsp; <a style="cursor: pointer;" ng-click="grid.appScope.visithistoryvistino(row)"> {{row.entity.VISIT_NO}}</a></div>'},{displayName:"opvm.VisitDate",headerCellFilter:"translate",field:"VISIT_DATE",cellTemplate:'<div class="form-group padding-5">{{row.entity.VISIT_DATE | date:"dd/MM/yyyy"}}</div>'},{displayName:"Doctor",headerCellFilter:"translate",field:"VISIT_TYPE",width:180,cellTemplate:'<div class="form-group padding-5">{{row.entity.DOCTOR_NAME}}, {{row.entity.SPECIALITY}}</div>'},{displayName:"opvm.Charges",headerCellFilter:"translate",field:"CHARGES",cellTemplate:'<div class="form-group padding-5">{{row.entity.CHARGES}}</div>'},{displayName:"opvm.Balance",headerCellFilter:"translate",field:"BALANCE",cellTemplate:'<div class="form-group padding-5">{{row.entity.BALANCE}}</div>'},{displayName:"Visit Status",headerCellFilter:"translate",field:"DESCRIPTION",cellTemplate:'<div class="form-group padding-5"><div ng-if="row.entity.DESCRIPTION != \'Completed\'">Open</div><div ng-if="row.entity.DESCRIPTION == \'Completed\'">Completed</div></div>'}]}).constant("OPVsitVisitHistorySubGridNew",{enableCellEditOnFocus:!0,enableGridMenu:!1,enableColumnMenus:!1,enableSelectionBatchEvent:!1,multiSelect:!1,enableFiltering:!1,enableRowHeaderSelection:!1,columnDefs:[{displayName:"Service",field:"SERV_NAME",width:250,cellTemplate:"<div class=\"form-group padding-5\" ng-style=\" {'margin-left': row.entity.PACKAGE_SUB ? '10px' : '0PX', 'font-weight': row.entity.PACKAGE_MAIN ? '600' : ''} \">{{row.entity.SERV_CODE? row.entity.SERV_CODE + '-' : ''}}  {{row.entity.SERV_NAME}}</div>"},{displayName:"Order No.",headerCellFilter:"translate",field:"ORDERNO",cellTemplate:"<div class=\"form-group padding-5\" ng-style=\" {'font-weight': row.entity.PACKAGE_MAIN ? '600' : ''} \">{{row.entity.ORDERNO ? row.entity.ORDERNO : \"--\"}}</div>"},{displayName:"Order Date",headerCellFilter:"translate",field:"ORDERDATE",cellTemplate:'<div class="form-group padding-5" ng-style=" {\'font-weight\': row.entity.PACKAGE_MAIN ? \'600\' : \'\'} ">{{row.entity.ORDERDATE | date:"dd/MM/yyyy hh:mm a"}} {{row.entity.ORDERDATE ? "" : "--"}}</div>'},{displayName:"Service Status",headerCellFilter:"translate",field:"TESTSTATUS",cellTemplate:"<div class=\"form-group padding-5\" ng-style=\" {'font-weight': row.entity.PACKAGE_MAIN ? '600' : ''} \">{{row.entity.TESTSTATUS ? row.entity.TESTSTATUS : \"--\"}}</div>"}]})}();